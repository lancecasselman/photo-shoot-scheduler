<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Print - Gallery</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #333;
        }

        /* Layout */
        .container {
            display: flex;
            height: 100vh;
        }

        /* Photo Preview Area */
        .preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: #f5f5f5;
        }

        .photo-wrapper {
            background: white;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border-radius: 4px;
            max-width: 80%;
            max-height: 80vh;
        }

        #previewCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background: white;
            box-shadow: -2px 0 20px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 15px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #333;
        }

        .back-link svg {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .sidebar-content {
            flex: 1;
            padding: 30px;
        }

        /* Dropdown Styles */
        .dropdown-select {
            width: 100%;
            padding: 14px 16px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .dropdown-select:hover {
            border-color: #999;
        }

        .dropdown-select:focus {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }

        /* Section Headers */
        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            margin-bottom: 15px;
        }



        /* Quantity */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            border-color: #999;
        }

        .quantity-btn:active {
            background: #f5f5f5;
        }

        .quantity-value {
            font-size: 16px;
            font-weight: 500;
            min-width: 30px;
            text-align: center;
        }

        /* Price Display */
        .price-section {
            padding: 20px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .price-row.total {
            padding-top: 10px;
            border-top: 1px solid #e5e5e5;
            font-size: 16px;
            font-weight: 600;
        }

        /* Buttons */
        .action-buttons {
            padding: 20px 30px 30px;
            border-top: 1px solid #eee;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #333;
            color: white;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background: #f8f8f8;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .preview-area {
                height: 40vh;
                padding: 20px;
            }

            .sidebar {
                width: 100%;
                flex: 1;
            }

        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Photo Preview -->
        <div class="preview-area">
            <div class="photo-wrapper">
                <canvas id="previewCanvas" width="800" height="600"></canvas>
            </div>
        </div>

        <!-- Order Sidebar -->
        <div class="sidebar">
            <!-- Header -->
            <div class="sidebar-header">
                <a href="#" class="back-link" onclick="backToGallery(); return false;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back to Gallery
                </a>
                <h1 style="font-size: 24px; font-weight: 600;">Create Your Print</h1>
            </div>

            <!-- Product Options -->
            <div class="sidebar-content">
                <!-- Product Type -->
                <div class="section">
                    <div class="section-title">Product Type</div>
                    <select class="dropdown-select" id="productSelect">
                        <option value="prints">Photo Prints</option>
                        <option value="canvas">Canvas Prints</option>
                        <option value="metal">Metal Prints</option>
                        <option value="albums">Photo Albums</option>
                    </select>
                </div>

                <!-- Size Selection -->
                <div class="section">
                    <div class="section-title">Size</div>
                    <select class="dropdown-select" id="sizeSelect">
                        <option value="4x6">4×6 inches</option>
                        <option value="5x7">5×7 inches</option>
                        <option value="8x10" selected>8×10 inches</option>
                        <option value="11x14">11×14 inches</option>
                        <option value="16x20">16×20 inches</option>
                        <option value="20x30">20×30 inches</option>
                        <option value="24x36">24×36 inches</option>
                        <option value="30x40">30×40 inches</option>
                        <option value="custom">Custom Size</option>
                    </select>
                </div>

                <!-- Paper Type (for prints) -->
                <div class="section" id="paperSection">
                    <div class="section-title">Paper Type</div>
                    <select class="dropdown-select" id="paperSelect">
                        <option value="lustre">Lustre - Professional finish with minimal glare</option>
                        <option value="glossy">Glossy - Vibrant colors with high shine</option>
                        <option value="matte">Matte - No glare, perfect for framing</option>
                    </select>
                </div>

                <!-- Quantity -->
                <div class="section">
                    <div class="section-title">Quantity</div>
                    <div class="quantity-selector">
                        <button class="quantity-btn" onclick="changeQuantity(-1)">−</button>
                        <span class="quantity-value" id="quantity">1</span>
                        <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                    </div>
                </div>

                <!-- Price Summary -->
                <div class="price-section">
                    <div class="price-row">
                        <span>8×10" Print</span>
                        <span id="itemPrice">$9.99</span>
                    </div>
                    <div class="price-row">
                        <span>Quantity</span>
                        <span id="quantityDisplay">1</span>
                    </div>
                    <div class="price-row total">
                        <span>Total</span>
                        <span id="totalPrice">$9.99</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addToCart()">Add to Cart</button>
                <button class="btn btn-secondary" onclick="viewCart()">View Cart</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // State Management
        let currentSettings = {
            product: 'prints',
            size: '8x10',
            paper: 'lustre',
            quantity: 1,
            price: 9.99
        };

        let photoUrl = '';
        let whccProducts = [];

        // Pricing Map
        const basePrices = {
            prints: {
                '4x6': 4.99,
                '5x7': 6.99,
                '8x10': 9.99,
                '11x14': 14.99,
                '16x20': 29.99,
                '20x30': 59.99,
                '24x36': 89.99,
                '30x40': 129.99,
                'custom': 149.99
            },
            canvas: {
                '8x10': 39.99,
                '11x14': 59.99,
                '16x20': 89.99,
                '20x30': 129.99,
                '24x36': 179.99,
                '30x40': 249.99
            },
            metal: {
                '8x10': 59.99,
                '11x14': 89.99,
                '16x20': 129.99,
                '20x30': 179.99,
                '24x36': 249.99,
                '30x40': 379.99
            },
            albums: {
                '8x8': 149.99,
                '10x10': 199.99,
                '12x12': 299.99
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', async () => {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            photoUrl = urlParams.get('photo') || '';

            // Load photo preview
            if (photoUrl) {
                await loadPhotoPreview();
            }

            // Load WHCC products
            await loadWHCCProducts();

            // Setup event listeners
            setupEventListeners();
            
            // Update display
            updateDisplay();
        });

        async function loadPhotoPreview() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            return new Promise((resolve) => {
                img.onload = function() {
                    // Calculate aspect ratio
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve();
                };
                
                img.onerror = function() {
                    console.error('Failed to load image');
                    resolve();
                };
                
                img.src = photoUrl;
            });
        }

        async function loadWHCCProducts() {
            try {
                const response = await fetch('/api/print/products');
                if (response.ok) {
                    const data = await response.json();
                    whccProducts = data.products || [];
                    console.log('Loaded WHCC products:', whccProducts.length);
                }
            } catch (error) {
                console.error('Failed to load WHCC products:', error);
            }
        }

        function setupEventListeners() {
            // Product dropdown
            document.getElementById('productSelect').addEventListener('change', function() {
                currentSettings.product = this.value;
                updateAvailableSizes();
                updateDisplay();
            });

            // Size dropdown
            document.getElementById('sizeSelect').addEventListener('change', function() {
                currentSettings.size = this.value;
                updateDisplay();
            });

            // Paper dropdown
            document.getElementById('paperSelect').addEventListener('change', function() {
                currentSettings.paper = this.value;
                updateDisplay();
            });
        }

        function updateAvailableSizes() {
            const product = currentSettings.product;
            const availableSizes = Object.keys(basePrices[product] || basePrices.prints);
            const sizeSelect = document.getElementById('sizeSelect');
            
            // Store current selection
            const currentSelection = sizeSelect.value;
            
            // Clear and rebuild options
            sizeSelect.innerHTML = '';
            
            // Size display names
            const sizeNames = {
                '4x6': '4×6 inches',
                '5x7': '5×7 inches',
                '8x10': '8×10 inches',
                '8x8': '8×8 inches',
                '10x10': '10×10 inches',
                '11x14': '11×14 inches',
                '12x12': '12×12 inches',
                '16x20': '16×20 inches',
                '20x30': '20×30 inches',
                '24x36': '24×36 inches',
                '30x40': '30×40 inches',
                'custom': 'Custom Size'
            };
            
            // Add available sizes
            availableSizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = sizeNames[size] || size;
                sizeSelect.appendChild(option);
            });
            
            // Try to restore previous selection or select first
            if (availableSizes.includes(currentSelection)) {
                sizeSelect.value = currentSelection;
                currentSettings.size = currentSelection;
            } else {
                sizeSelect.value = availableSizes[0];
                currentSettings.size = availableSizes[0];
            }

            // Show/hide paper section for non-print products
            const paperSection = document.getElementById('paperSection');
            if (product === 'prints') {
                paperSection.style.display = 'block';
            } else {
                paperSection.style.display = 'none';
            }
        }

        function updateDisplay() {
            // Update price
            const prices = basePrices[currentSettings.product] || basePrices.prints;
            currentSettings.price = prices[currentSettings.size] || 9.99;
            
            const itemPrice = currentSettings.price;
            const total = itemPrice * currentSettings.quantity;
            
            document.getElementById('itemPrice').textContent = `$${itemPrice.toFixed(2)}`;
            document.getElementById('quantityDisplay').textContent = currentSettings.quantity;
            document.getElementById('totalPrice').textContent = `$${total.toFixed(2)}`;
        }

        function changeQuantity(delta) {
            const newQuantity = currentSettings.quantity + delta;
            if (newQuantity >= 1 && newQuantity <= 99) {
                currentSettings.quantity = newQuantity;
                document.getElementById('quantity').textContent = newQuantity;
                updateDisplay();
            }
        }

        async function addToCart() {
            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            
            // Get filename from URL
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('filename') || 'photo.jpg';
            
            const cartItem = {
                photo: photoUrl,
                filename: filename,
                product: currentSettings.product,
                size: currentSettings.size,
                paper: currentSettings.paper,
                quantity: currentSettings.quantity,
                price: currentSettings.price * currentSettings.quantity
            };

            try {
                // Get existing cart
                let cart = JSON.parse(localStorage.getItem('printCart') || '[]');
                cart.push(cartItem);
                localStorage.setItem('printCart', JSON.stringify(cart));
                
                // Show success
                alert(`Added ${currentSettings.quantity} ${currentSettings.size} ${currentSettings.product} to cart!`);
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Failed to add to cart');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function viewCart() {
            // Navigate to cart page
            window.location.href = '/cart.html';
        }

        function backToGallery() {
            // Get gallery URL from referrer or use default
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                window.location.href = `/client-gallery.html?token=${token}`;
            } else if (document.referrer) {
                window.location.href = document.referrer;
            } else {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>