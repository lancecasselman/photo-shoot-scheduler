<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="description" content="Professional photography business management platform with session scheduling, client galleries, and invoicing.">
    <meta name="keywords" content="photography, business management, client portal, photo gallery, session scheduling, invoicing">
    <title>Photography Management System - Professional Photography Business Platform</title>
    
    <script>
        // 🔄 TOGGLEABLE AUTH GUARD SYSTEM
        const DEV_MODE = false; // 👉 Authentication enabled - production mode
        
        // Dev mode banner handled in main DOM ready event
    </script>
    
    <!-- Google Fonts - Photography Management System Theme -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    

    
    <!-- Confetti Animation Styles -->
    <style>
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #d4af37;
            animation: confetti-fall 3s linear forwards;
        }
        
        .confetti-piece:nth-child(odd) {
            background: #f4e4bc;
            border-radius: 50%;
        }
        
        .confetti-piece:nth-child(3n) {
            background: #b8941f;
            width: 8px;
            height: 8px;
        }
        
        .confetti-piece:nth-child(4n) {
            background: #efd971;
            border-radius: 2px;
        }
        
        .confetti-piece:nth-child(5n) {
            background: #c4962d;
            width: 12px;
            height: 6px;
            border-radius: 6px;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .milestone-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 10000;
            animation: milestone-pop 2s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes milestone-pop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
    
    <!-- WHCC Brand Color Reference Guide -->
    <meta name="brand-primary-color" content="#d4af37">
    <meta name="brand-secondary-color" content="#8b7355">
    <meta name="brand-accent-color" content="#f4e4bc">
    <meta name="brand-background-color" content="#1a1a1a">
    <meta name="brand-text-color" content="#ffffff">
    <meta name="brand-business-name" content="The Legacy Photography">
    <meta name="brand-font-family" content="Playfair Display">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Photography Management System Design System */
        :root {
            /* WHCC Brand Color Reference - Primary Palette */
            --brand-primary-gold: #d4af37;
            --brand-secondary-bronze: #8b7355;
            --brand-accent-cream: #f4e4bc;
            --brand-dark-bg: #1a1a1a;
            --brand-text-light: #ffffff;
            
            /* Color Palette */
            --bg-primary: #FAFAF8;
            --bg-secondary: #FFFFFF;
            --accent-beige: #EADBC8;
            --accent-sage: #D9E1D8;
            --gold-muted: #C1A35E;
            --rose-dusty: #E8C1B4;
            --text-primary: #1F1F1F;
            --text-secondary: #555555;
            --text-light: #888888;
            
            /* Typography */
            --font-heading: 'Cormorant Garamond', serif;
            --font-body: 'Quicksand', sans-serif;
            
            /* Spacing */
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
            
            /* Shadows */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            font-weight: 400;
            font-size: 16px;
            overflow-x: visible !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md);
            overflow: visible !important;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }
        }
        
        /* Header with Hamburger Menu */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            position: relative;
        }
        
        .logo {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--gold-muted);
            margin: 0;
        }
        
        /* Removed old conflicting navigation styles */
        
        /* Removed more old navigation styles */

        /* Hamburger Menu Styles */
        .hamburger-menu {
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-xs);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            position: relative;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .hamburger-menu:hover {
            background: var(--accent-beige);
        }

        .hamburger-line {
            display: block;
            width: 25px;
            height: 3px;
            background: var(--text-primary);
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        /* Make hamburger menu fully visible and opaque */
        .hamburger-menu {
            background: #2a2a2a !important;
            border: 2px solid #d4af37 !important;
            opacity: 1 !important;
        }

        .hamburger-line {
            background: #d4af37 !important;
            opacity: 1 !important;
        }

        .hamburger-menu:hover {
            background: #3a3a3a !important;
            border-color: #ffd700 !important;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Mobile Menu Dropdown - positioned relative to header */
        .mobile-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1003;
            animation: slideDown 0.3s ease;
            margin: 0;
        }

        .mobile-menu.show {
            display: block;
        }

        /* Ensure container has relative positioning for dropdown */
        .container {
            position: relative;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mobile-menu .nav-menu ul {
            list-style: none;
            padding: var(--spacing-sm);
            margin: 0;
        }

        .mobile-menu .nav-item {
            margin-bottom: var(--spacing-xs);
        }

        .mobile-menu .nav-link {
            display: block;
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .mobile-menu .nav-link:hover {
            background: var(--accent-beige);
            color: var(--text-primary);
        }

        .mobile-menu .nav-link.active {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }

        .mobile-menu .logout-btn {
            width: 100%;
            margin-top: var(--spacing-xs);
            text-align: center;
        }
        
        /* Main Content Area */
        .main-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            padding: var(--spacing-xl);
            min-height: calc(100vh - var(--spacing-xl));
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            position: relative;
            z-index: 1001;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .content-header {
            margin-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--accent-beige);
            padding-bottom: var(--spacing-md);
        }
        
        .header h1 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .user-info {
            background: var(--accent-beige);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.95rem;
            box-shadow: var(--shadow-soft);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }
        
        /* Removed user avatar styling */
        
        .logout-btn {
            background: var(--rose-dusty);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background: #d8a593;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .session-form {
            background: var(--bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            border: 2px solid var(--accent-beige);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: var(--font-body);
        }
        
        input, textarea, select {
            padding: var(--spacing-sm);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }

        /* Photography Management System datetime input styling */
        input[type="datetime-local"] {
            position: relative;
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            cursor: pointer;
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: var(--gold-muted);
            border-radius: var(--border-radius-sm);
            padding: 4px;
            cursor: pointer;
            opacity: 0.8;
        }

        input[type="datetime-local"]::-webkit-datetime-edit {
            color: var(--text-primary);
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-light);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--gold-muted);
            box-shadow: 0 0 0 3px rgba(193, 163, 94, 0.2);
            transform: translateY(-1px);
        }
        
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: var(--spacing-xs);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: #a68d4a;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn-secondary {
            background: var(--rose-dusty);
            color: var(--text-primary);
            border: 2px solid var(--accent-beige);
        }
        
        .btn-secondary:hover {
            background: #d8a593;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn-danger {
            background: rgba(0, 0, 0, 0.7);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.4);
        }
        
        .btn-danger:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);
        }
        
        /* ALL session action buttons - gold background with dark text and bold font like Email Client */
        .btn-edit, .btn-calendar, .btn-call, 
        .btn-text, .btn-warning, .btn-contract, .btn-success,
        .btn-invoice, .btn-email, .btn-secondary {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            border: 1px solid rgba(212, 175, 55, 0.4);
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .btn-edit:hover, .btn-calendar:hover, 
        .btn-call:hover, .btn-text:hover,
        .btn-warning:hover, .btn-contract:hover, .btn-success:hover,
        .btn-invoice:hover, .btn-email:hover, .btn-secondary:hover {
            background: linear-gradient(135deg, #f4e4bc 0%, #d4af37 100%);
            color: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            border-color: rgba(212, 175, 55, 0.6);
        }
        
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            overflow: visible !important;
            z-index: auto;
        }
        
        /* Photography Management System Session List View Styles */
        .session-list-item {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .session-list-item:hover {
            border-color: var(--gold-muted);
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .session-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--accent-beige);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--cream-warm) 100%);
        }

        .session-info {
            flex: 1;
        }

        .client-name {
            font-size: 1.4em;
            color: var(--gold-muted);
            margin: 0 0 var(--spacing-xs) 0;
            font-weight: 600;
            font-family: var(--font-heading);
        }

        .session-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.9em;
            color: var(--text-secondary);
            flex-wrap: wrap;
            font-family: var(--font-body);
        }

        .session-meta span {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .session-deposit, .session-remaining {
            font-size: 0.85rem !important;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .session-deposit {
            background: rgba(40, 167, 69, 0.1) !important;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .session-remaining {
            background: rgba(212, 175, 55, 0.1) !important;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .session-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-location {
            color: var(--accent-sage);
        }

        .session-price {
            color: var(--gold-muted);
            font-weight: 600;
            font-size: 1.1em;
        }

        .expand-icon {
            font-size: 1.2em;
            color: var(--gold-muted);
            transition: transform 0.3s ease;
            min-width: 30px;
            text-align: center;
        }

        .session-details {
            padding: var(--spacing-lg);
            border-top: 2px solid var(--accent-beige);
            background: linear-gradient(135deg, var(--cream-warm) 0%, var(--bg-primary) 100%);
            margin-top: var(--spacing-md);
            border-radius: var(--border-radius-sm);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .detail-section h4 {
            color: var(--gold-muted);
            font-family: var(--font-heading);
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--accent-sage);
            padding-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        .detail-item {
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
            color: var(--text-primary);
        }

        .detail-item strong {
            color: var(--gold-muted);
            margin-right: var(--spacing-xs);
            font-weight: 600;
        }

        .quick-action-btn {
            background: var(--gold-muted);
            color: var(--bg-primary);
            border: 1px solid var(--accent-beige);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-full);
            margin-left: var(--spacing-sm);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--cream-warm);
            color: var(--gold-muted);
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .action-btn.premium {
            background: linear-gradient(135deg, #d4af37, #f4e4bc);
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            border: 2px solid #d4af37;
        }

        .action-btn.premium:hover {
            background: linear-gradient(135deg, #f4e4bc, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .action-btn.premium:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.delete-btn {
            background: linear-gradient(135deg, #dc3545, #ff6b7a);
            color: white;
        }

        .action-btn.delete-btn:hover {
            background: linear-gradient(135deg, #c82333, #ff5161);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .session-meta {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .session-list-header {
                padding: 15px 20px;
            }

            .session-details {
                padding: 20px;
            }
        }
        
        .session-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--gold-muted);
        }
        
        .session-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .session-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--gold-muted);
            letter-spacing: -0.01em;
            font-family: var(--font-heading);
        }
        
        .session-type {
            background: linear-gradient(135deg, var(--gold-muted) 0%, var(--cream-warm) 100%);
            color: var(--text-primary);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--border-radius-full);
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: 1px solid var(--accent-beige);
        }
        
        .session-details {
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .detail-label {
            font-weight: 600;
            width: 90px;
            color: var(--gold-muted);
            font-size: 0.9em;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-weight: 400;
        }
        
        .session-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .session-actions {
                grid-template-columns: 1fr;
            }
        }
        

        








        

        
        .photo-count {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #f5f5f5;
        }
        

        

        
        .admin-checkboxes {
            background: var(--cream-warm);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            box-shadow: var(--shadow-soft);
        }
        
        .admin-checkboxes h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--gold-muted);
            font-size: 1.1em;
            font-weight: 600;
            font-family: var(--font-heading);
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
        }
        
        .checkbox-group:hover {
            background: var(--accent-beige);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--gold-muted);
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .upload-limits-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #234e52;
        }
        
        .upload-limits-info h4 {
            margin: 0 0 8px 0;
            color: #065f46;
        }
        
        .upload-limits-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .batch-upload-info {
            background: #fef7e0;
            border: 1px solid #f6cc73;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #744210;
            font-size: 0.9rem;
        }
        
        /* Invoice Modal Styles */
        .session-payment-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .session-payment-summary h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .payment-row:last-child {
            border-bottom: none;
        }
        
        .invoice-options {
            margin-top: 25px;
        }
        
        .invoice-options h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .radio-option:hover {
            border-color: #d4af37;
            background: #fefdfb;
        }
        
        .radio-option input[type="radio"] {
            margin-top: 2px;
            accent-color: #d4af37;
        }
        
        .radio-option input[type="radio"]:checked + .radio-text {
            color: #1a1a1a;
            font-weight: 600;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            border-color: #d4af37;
            background: #fefdfb;
            box-shadow: 0 0 0 1px #d4af37;
        }
        
        .radio-text {
            flex: 1;
            color: #4a5568;
        }
        
        .radio-text strong {
            display: block;
            margin-bottom: 4px;
            color: #2d3748;
        }
        
        .radio-text small {
            color: #718096;
            font-size: 0.9rem;
        }
        
        #depositAmountSection {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        #depositAmountSection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        #depositAmountSection input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        #depositAmountSection input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        /* Invoice Card Overlay Styles */
        .invoice-card-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .invoice-card-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 2px solid #d4af37;
            overflow: hidden;
            animation: invoiceModalSlide 0.4s ease-out;
            max-width: 500px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes invoiceModalSlide {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .invoice-card-modal .modal-header {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 20px;
            border-bottom: none;
            position: relative;
        }

        .invoice-card-modal .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .invoice-card-modal .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(26, 26, 26, 0.1);
            color: #1a1a1a;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .invoice-card-modal .modal-close:hover {
            background: rgba(26, 26, 26, 0.2);
            transform: scale(1.1);
        }

        .invoice-card-modal .modal-content {
            padding: 25px;
        }

        .invoice-card-modal .modal-footer {
            background: #f8fafc;
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .invoice-card-modal .modal-footer .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .invoice-card-modal .modal-footer .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            border: none;
        }

        .invoice-card-modal .modal-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .invoice-card-modal .modal-footer .btn-secondary {
            background: white;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .invoice-card-modal .modal-footer .btn-secondary:hover {
            border-color: #d4af37;
            background: #fefdfb;
        }

        /* Payment Plan Styles */
        .payment-plan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .payment-plan-modal.active {
            display: flex;
        }
        
        .payment-plan-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .payment-plan-form {
            display: grid;
            gap: 20px;
        }
        
        .payment-plan-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .payment-plan-summary {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .payment-plan-summary h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }
        
        .payment-schedule {
            margin: 15px 0;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .payment-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .payment-status.pending {
            background: #fef7e0;
            color: #744210;
        }
        
        .payment-status.paid {
            background: #dcfce7;
            color: #166534;
        }
        
        .payment-status.overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .payment-plan-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #234e52;
        }
        
        .payment-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 10px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1);
            gap: 6px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: #f5f5f5;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.01em;
        }

        .nav-tab:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            font-weight: 600;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        /* Tab Content Areas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }


        }

            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            flex-wrap: wrap;
        }

            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .component-category {
            margin-bottom: 25px;
        }

        .component-category h4 {
            color: #d4af37;
            font-size: 0.9rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .component-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            color: #f5f5f5;
        }

        .component-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
            transform: translateX(5px);
            color: #d4af37;
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .component-item span {
            font-weight: 500;
            color: #2d3748;
        }

        /* Center Canvas */
        .builder-canvas {
            background: white;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .canvas-header h3 {
            color: #2d3748;
            margin: 0;
        }

        .canvas-controls {
            display: flex;
            gap: 8px;
        }

        .canvas-control {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .canvas-control:hover,
        .canvas-control.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .canvas-viewport {
            flex: 1;
            padding: 20px;
            background: #e2e8f0;
            overflow: auto;
        }

            max-width: 1200px;
        }

            align-items: center;
            justify-content: center;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            margin: 20px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .drop-zone-message {
            text-align: center;
            color: #666;
        }

        .drop-zone-message h3 {
            margin-bottom: 12px;
            color: #2d3748;
        }

        .drop-zone-message p {
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .quick-start-templates {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .template-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .template-btn.legacy-style {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            border: 2px solid #d4af37;
        }

        .template-btn.modern-style {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .template-btn.elegant-style {
            background: linear-gradient(135deg, #2c1810 0%, #8b4513 100%);
            border: 2px solid #ddd6c1;
        }

        /* Right Sidebar - Properties */
        .builder-properties {
            background: white;
            padding: 20px;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .builder-properties h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .no-selection {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

            font-size: 2rem;
        }

        .website-info h4 {
            margin: 0 0 8px 0;
            color: #2d3748;
        }

        .website-info p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .website-actions {
            display: flex;
            gap: 10px;
        }

        .website-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        /* Component Wrapper Styles */
        .component-wrapper {
            position: relative;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .component-wrapper:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Gallery hover effects */
        .component-wrapper:hover [style*="aspect-ratio"] > [style*="position: absolute"] {
            transform: translateY(0) !important;
        }

        .component-wrapper:hover [style*="aspect-ratio"]:hover {
            transform: scale(1.05);
        }

        .component-wrapper:hover [style*="opacity: 0"]:hover {
            opacity: 1 !important;
        }

        /* Properties Panel Styles */
        .property-section {
            padding: 15px 0;
        }

        .property-section h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .property-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
        }

        .property-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            cursor: pointer;
        }

        .property-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .property-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .property-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .property-actions .btn {
            width: 100%;
            justify-content: center;
        }

            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .builder-sidebar {
                order: 1;
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                padding: 15px;
            }
            
            .builder-canvas {
                order: 2;
                padding: 10px;
                min-height: 400px;
            }
            
            .builder-properties {
                order: 3;
                background: #f8fafc;
                border-top: 1px solid #e2e8f0;
                padding: 15px;
            }
            
                gap: 10px;
            }

            .template-btn {
                width: 200px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .component-library h4,
            .builder-properties h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .component-category {
                margin-bottom: 20px;
            }
            
            .component-item {
                padding: 12px;
                font-size: 0.9rem;
            }
            
                max-width: 768px;
                margin: 0 auto;
            }
            
            .drop-zone {
                min-height: 300px;
            }
            
            .drop-zone-message h3 {
                font-size: 1.5rem;
            }
            
            .drop-zone-message p {
                font-size: 1rem;
            }
            
            /* Mobile-friendly component editing */
            .component-wrapper {
                outline: none !important;
                border: 2px solid transparent;
                margin-bottom: 1px;
                position: relative;
            }
            
            .component-wrapper.selected {
                border-color: #667eea !important;
                background: rgba(102, 126, 234, 0.05);
            }
            
            .component-wrapper::after {
                content: '✎ Tap to Edit';
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(102, 126, 234, 0.9);
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.7rem;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }
            
            .component-wrapper:hover::after,
            .component-wrapper.selected::after {
                opacity: 1;
            }
        }
        
        @media (max-width: 480px) {
            .builder-sidebar,
            .builder-properties {
                max-height: 200px;
            }
            

            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .builder-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .builder-mode-switch {
            display: flex;
            gap: 5px;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 10px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .builder-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: #667eea;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

            height: 250px;
            position: relative;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .legacy-preview {
            background: linear-gradient(135deg, #1a1a1a 0%, #8b7355 100%);
            color: #d4af37;
        }

        .modern-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .elegant-preview {
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);
            color: #FDF5E6;
        }

        .legacy-elite-preview {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2c1810 100%);
            color: #d4af37;
            position: relative;
            overflow: hidden;
        }

        .legacy-elite-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .legacy-elite-preview .preview-tagline {
            font-size: 0.9rem;
            font-style: italic;
            color: rgba(212, 175, 55, 0.8);
            text-align: center;
            margin: 10px 0;
        }

        .legacy-photo-1 {
            background: linear-gradient(45deg, #8b7355, #d4af37);
            position: relative;
        }

        .legacy-photo-2 {
            background: linear-gradient(45deg, #2c1810, #8b7355);
        }

        .legacy-photo-3 {
            background: linear-gradient(45deg, #d4af37, #f4e4bc);
        }

        .legacy-elite-btn {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%) !important;
            color: #1a1a1a !important;
            font-weight: 700 !important;
            text-shadow: none !important;
        }

        .legacy-elite-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 28px rgba(212, 175, 55, 0.4) !important;
        }

        .preview-header {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }

        .preview-hero {
            font-size: 2rem;
            font-weight: 300;
            text-align: center;
            margin: 20px 0;
        }

        .preview-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: auto;
        }

        .preview-photo {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .template-info {
            padding: 25px;
        }

        .template-info h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .template-info p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .template-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .feature-tag {
            background: #f1f3f4;
            color: #5f6368;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .use-template-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .use-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }


        .branding-control {
            margin-bottom: 15px;
        }

        .branding-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .logo-upload, .brand-input, .font-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .logo-preview {
            margin-top: 8px;
            text-align: center;
            min-height: 40px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-input-group {
            text-align: center;
        }

        .color-input-group label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .color-input {
            width: 100%;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .component-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .component-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .component-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .builder-canvas {
            display: flex;
            flex-direction: column;
            background: #f8fafc;
        }

        .canvas-controls {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .device-controls {
            display: flex;
            gap: 8px;
        }

        .device-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .device-btn.active {
            background: #667eea;
            color: white;
        }

            min-height: 100%;
            position: relative;
        }

        .canvas-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            text-align: center;
        }

        .canvas-placeholder h2 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .smart-guides {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .builder-properties {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #e2e8f0;
        }

        .builder-properties h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .property-panel .no-selection {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            color: #8b5a3c;
        }
        
        .bold-mockup {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #ffffff;
        }
        
        .mockup-header {
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            border-bottom: 1px solid currentColor;
            padding-bottom: 5px;
        }
        
        .mockup-hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .mockup-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            height: 40px;
        }
        
        .mockup-photo {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .template-card h4 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }
        
        .template-card p {
            color: #4a5568;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }
        
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input[type="color"] {
            height: 45px;
            padding: 5px;
            cursor: pointer;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .photo-upload-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
        }
        
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-preview-item {
            aspect-ratio: 1;
            background: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Live Preview */
        .website-preview {
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h4 {
            margin: 0;
            color: #2d3748;
        }
        
        .preview-controls {
            display: flex;
            gap: 8px;
        }
        
        .preview-control {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .preview-control:hover {
            background: #f7fafc;
        }
        
        .preview-control.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .website-preview-frame {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #f8fafc;
        }
        
        .website-preview-frame.desktop {
            padding: 20px;
        }
        
        .website-preview-frame.tablet {
            padding: 20px 60px;
        }
        
        .website-preview-frame.mobile {
            padding: 20px 100px;
        }
        
        /* RAW Folder Modal Styles */
        .gallery-modal-content {
            max-width: 90%;
            max-height: 90%;
            width: 800px;
        }

        .gallery-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
        }

        .raw-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .file-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .file-info p {
            margin: 2px 0;
            color: #666;
            font-size: 0.9em;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .empty-state, .error-state, .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-state {
            color: #d32f2f;
        }

        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item input[type="checkbox"] {
            margin: 0;
        }
        
        .status-item label {
            color: #000000 !important;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
        }
            padding: 15px;
            margin: 15px 0;
        }



        /* Dropdown Menu Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
            z-index: 2147483646 !important;
            isolation: isolate;
        }

        .dropdown-toggle {
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #1a1a1a;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .dropdown-toggle:hover {
            background: linear-gradient(135deg, #ffd700, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .dropdown-menu {
            position: absolute !important;
            top: calc(100% + 5px) !important;
            left: 0 !important;
            right: auto !important;
            background: #2a2a2a !important;
            border: 2px solid #d4af37 !important;
            border-radius: 8px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
            z-index: 2147483647 !important;
            display: none !important;
            overflow: visible !important;
            min-width: 200px !important;
            min-height: 50px !important;
            width: auto !important;
        }

        .dropdown-menu.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: #f5f5f5;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* Location Search Styles */
        .location-results {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 10000;
        }

        /* Dropdown Container */
        .dropdown-container {
            position: relative;
            display: inline-block;
            z-index: 10;
        }

        .location-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            color: #f5f5f5;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .location-result-item:last-child {
            border-bottom: none;
        }

        .location-result-item:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
        }

        .location-result-item .location-name {
            font-weight: bold;
        }

        .location-result-item .location-details {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }



        @media (max-width: 768px) {
            .container { padding: 10px; }
            .sessions-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .session-actions { flex-direction: column; }
            .btn { width: 100%; margin: 2px 0; }
            .checkbox-grid { grid-template-columns: 1fr; }
            

            
            .status-checkboxes {
                grid-template-columns: 1fr;
            }
        }

        /* Dropdown Menu Styles */
        .tools-dropdown {
            position: relative;
            margin: 20px 0;
            text-align: center;
        }

        #toolsToggle {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            padding: 12px 20px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-size: 1em;
            transition: all 0.2s ease;
        }

        #toolsToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        #toolsMenu {
            position: absolute;
            background-color: #2a2a2a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            top: 50px;
            width: 100%;
            left: 0;
            z-index: 99;
            border: 1px solid #444;
        }

        #toolsMenu a {
            display: block;
            padding: 12px 15px;
            color: #f5f5f5;
            text-decoration: none;
            border-bottom: 1px solid #444;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        #toolsMenu a:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #toolsMenu a:hover {
            background-color: #444;
            color: #d4af37;
            transform: translateX(5px);
        }

        .hidden {
            display: none;
        }




            border-radius: 12px;
            margin: 20px 0;
        }

        }

        .builder-settings-panel {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #444;
        }

        .builder-settings-panel h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .builder-preview-panel {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #444;
            position: sticky;
            top: 20px;
        }

        .builder-preview-panel h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .preview-container {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .website-preview {
            width: 100%;
            min-height: 400px;
            position: relative;
        }

        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            text-align: center;
            font-style: italic;
        }

        .builder-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 30px;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #666, #888);
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .image-preview-container {
            text-align: center;
        }

        /* Theme Previews */
        .theme-clean {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #343a40;
        }

        .theme-gallery {
            background: linear-gradient(135deg, #212529, #343a40);
            color: #f8f9fa;
        }

        .theme-banner {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: #f8f9fa;
        }

        .theme-legacy {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            color: #f4e4bc;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .builder-main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .builder-preview-panel {
                position: static;
            }
        }

        /* Enhanced Client Dashboard Styles */
        .client-dashboard-controls {
            background: var(--bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-xl);
            border: 2px solid var(--accent-beige);
            box-shadow: var(--shadow-soft);
        }

        .search-and-filters {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .search-section {
            width: 100%;
        }

        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: var(--gold-muted);
            font-weight: 600;
            font-size: 0.9em;
            font-family: var(--font-heading);
        }

        .checkbox-filters {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .checkbox-filters label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            font-family: var(--font-body);
        }

        .checkbox-filters input[type="checkbox"] {
            accent-color: var(--gold-muted);
        }

        .filter-group select,
        .filter-group input[type="date"] {
            padding: var(--spacing-sm) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--accent-beige);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input[type="date"]:focus {
            border-color: var(--gold-muted);
            box-shadow: 0 0 0 3px rgba(193, 163, 94, 0.2);
        }

        .archive-and-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 2px solid var(--accent-beige);
        }

        .archive-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
            cursor: pointer;
            font-family: var(--font-body);
        }

        .archive-toggle input[type="checkbox"] {
            accent-color: var(--gold-muted);
        }

        .btn-secondary, .btn-primary {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #666, #888);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #1a1a1a;
        }



        .session-card.hidden-by-filter {
            display: none !important;
        }

        /* Global Storage Overview Styles */
        .global-storage-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            border: 2px solid var(--accent-beige);
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--accent-beige);
        }

        .storage-header h2 {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .storage-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .storage-stat-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--cream-warm) 100%);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-soft);
        }

        .storage-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            border-color: var(--gold-muted);
        }

        .storage-stat-card.highlight {
            background: linear-gradient(135deg, var(--gold-muted) 0%, #f4e4bc 100%);
            border-color: var(--gold-muted);
            color: var(--bg-secondary);
        }

        .storage-stat-number {
            font-size: 2rem;
            font-weight: 700;
            font-family: var(--font-heading);
            margin-bottom: var(--spacing-xs);
            color: inherit;
        }

        .storage-stat-card.highlight .storage-stat-number {
            color: var(--bg-secondary);
        }

        .storage-stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: inherit;
        }

        .storage-stat-card.highlight .storage-stat-label {
            color: var(--bg-secondary);
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .storage-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .storage-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .storage-stat-number {
                font-size: 1.5rem;
            }
        }

        /* Simplified File Action Styles */
        .session-file-actions {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--gold-muted);
        }

        .session-file-actions h4 {
            margin: 0 0 15px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .file-action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-action-buttons .btn {
            flex: 1;
            min-width: 120px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .file-action-buttons {
                flex-direction: column;
            }
            
            .file-action-buttons .btn {
                flex: none;
                width: 100%;
            }
        }

        .file-folders {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .file-folder {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
        }

        .folder-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .folder-header h4 {
            margin: 0;
            color: #8b7355;
            font-size: 1.1rem;
        }

        .file-count {
            color: #666;
            font-size: 0.9rem;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .storage-amount {
            color: #8b7355;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f8f6f1;
            padding: 3px 6px;
            border-radius: 10px;
            margin-top: 4px;
            border: 1px solid #e6ddc4;
        }

        .folder-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .folder-actions .btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
        }

        .file-list {
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            background: #fafafa;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 0.8rem;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .loading-files {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        /* File thumbnail styles for main session view */
        .file-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .file-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .file-thumbnail img:hover {
            transform: scale(1.1);
        }

        /* Desktop layout - Raw Storage below Gallery folder */
        @media (min-width: 769px) {
            .file-management-section {
                width: 100%;
                max-width: none;
                overflow: visible;
            }
            
            .file-folders {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                grid-gap: 20px;
                align-items: start;
                width: 100%;
                max-width: 100%;
            }
            
            .file-folder {
                height: auto;
                min-height: 250px;
                width: 100%;
                min-width: 0;
            }
            
            .file-folder:nth-child(1) {
                order: 1; /* Gallery first */
                grid-row: 1;
            }
            
            .file-folder:nth-child(2) {
                order: 2; /* Raw Storage below Gallery */
                grid-row: 2;
            }
        }

        @media (max-width: 768px) {
            .file-folders {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                gap: 15px;
            }
            
            .folder-actions {
                justify-content: center;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .file-actions {
                width: 100%;
                justify-content: center;
            }
            
            .file-folder:nth-child(1) {
                order: 1; /* Gallery first on mobile */
                grid-row: 1;
            }
            
            .file-folder:nth-child(2) {
                order: 2; /* Raw Storage below Gallery on mobile */
                grid-row: 2;
            }
        }
        
        /* Payment Plan Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999 !important;
        }
        
        .payment-plan-modal {
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            border: 2px solid #d4af37;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.3);
            position: relative;
            z-index: 100000 !important;
        }
        
        .payment-plan-modal .modal-header {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 20px;
            border-radius: 14px 14px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .payment-plan-modal .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .payment-plan-modal .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #1a1a1a;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .payment-plan-modal .close-btn:hover {
            background: rgba(26, 26, 26, 0.1);
            transform: rotate(90deg);
        }
        
        .payment-plan-modal .modal-body {
            padding: 30px;
            color: #f5f5f5;
        }
        
        .payment-plan-modal .client-info {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid #d4af37;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .payment-plan-modal .client-info h4 {
            color: #d4af37;
            margin: 0 0 10px 0;
            font-size: 1.4rem;
        }
        
        .payment-plan-modal .client-info p {
            margin: 0;
            color: #f5f5f5;
            opacity: 0.8;
        }
        
        .payment-plan-modal .form-group {
            margin-bottom: 20px;
        }
        
        .payment-plan-modal .form-group label {
            display: block;
            color: #d4af37;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .payment-plan-modal .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #f5f5f5;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .payment-plan-modal .form-control:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(26, 26, 26, 0.9);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }
        
        .payment-plan-modal .form-control option {
            background: #1a1a1a;
            color: #f5f5f5;
        }
        
        .payment-preview {
            background: rgba(212, 175, 55, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .payment-preview h5 {
            color: #d4af37;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
        }
        
        .payment-summary {
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #d4af37;
        }
        
        .payment-summary strong {
            color: #d4af37;
            font-size: 1.1rem;
        }
        
        .payment-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(26, 26, 26, 0.6);
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .payment-item:last-child {
            margin-bottom: 0;
        }
        
        .payment-plan-modal .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .payment-plan-modal .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .payment-plan-modal .btn-secondary {
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border: 2px solid #667eea;
        }
        
        .payment-plan-modal .btn-secondary:hover {
            background: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .payment-plan-modal .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            border: 2px solid #d4af37;
        }
        
        .payment-plan-modal .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
        }

        .session-notes {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #d4af37;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .session-notes h4 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 600;
        }

        .notes-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .notes-checklist label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #000000;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
        }

        .notes-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #d4af37;
            background: #ffffff;
            color: #000000;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        
        .notes-textarea:focus {
            outline: none;
            border-color: #b8860b;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }: #1a1a1a;
            color: #f5f5f5;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .archive-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        /* Mobile Responsive for Dashboard Controls */
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .checkbox-filters {
                flex-direction: column;
                gap: 8px;
            }
            
            .archive-and-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .archive-and-actions > * {
                text-align: center;
            }
        }
        
        /* Message Container Styles */
        .message {
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            font-weight: 500;
            animation: slideInRight 0.3s ease-out;
        }
        
        .message-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-left: 4px solid #047857;
        }
        
        .message-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left: 4px solid #b91c1c;
        }
        
        .message-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-left: 4px solid #1d4ed8;
        }
        
        .message-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left: 4px solid #b45309;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Enhanced responsive design and loading states */
        @media (max-width: 768px) {
            .action-buttons {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: space-between;
            }
            
            .action-buttons .btn {
                font-size: 12px;
                padding: 6px 10px;
                flex: 1;
                min-width: 70px;
                max-width: calc(50% - 2.5px);
            }
            
            .session-meta {
                flex-direction: column;
                gap: 5px;
                font-size: 13px;
            }
            
            .modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 5vh auto;
            }
        }
        
        /* Loading states for buttons */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading-spinner::after {
            content: '...';
            animation: loading-dots 1.5s steps(3, end) infinite;
        }
        
        @keyframes loading-dots {
            0% { content: ''; }
            33% { content: '.'; }
            66% { content: '..'; }
            100% { content: '...'; }
        }

        /* Golden Hour Times Styles */
        .golden-hour-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .location-selector, .date-selector {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .location-selector h3, .date-selector h3 {
            color: var(--gold-muted);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-heading);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .golden-hour-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: white;
            border: none;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: var(--spacing-lg);
            font-family: var(--font-heading);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .golden-hour-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #e6c547 0%, #c8941c 100%);
        }

        .golden-hour-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .golden-hour-results {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
            border: 2px solid var(--gold-muted);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .time-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .time-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .sunrise-card {
            border-color: #ff7b00;
            background: linear-gradient(135deg, rgba(255, 123, 0, 0.1) 0%, var(--bg-primary) 100%);
        }

        .sunset-card {
            border-color: #ff4757;
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1) 0%, var(--bg-primary) 100%);
        }

        .blue-hour-card {
            border-color: #3742fa;
            background: linear-gradient(135deg, rgba(55, 66, 250, 0.1) 0%, var(--bg-primary) 100%);
        }

        .time-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .time-card h4 {
            color: var(--gold-muted);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-heading);
        }

        .time-display {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-heading);
        }

        .golden-hour-period {
            background: rgba(212, 175, 55, 0.1);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .golden-hour-period span {
            display: block;
            font-size: 0.9rem;
            color: var(--gold-muted);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .location-info {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--accent-beige);
        }

        .location-info h4 {
            color: var(--gold-muted);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-heading);
        }

        .photography-tips {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            border: 1px solid var(--accent-beige);
        }

        .photography-tips h4 {
            color: var(--gold-muted);
            margin-bottom: var(--spacing-md);
            font-family: var(--font-heading);
        }

        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
        }

        .tip-card {
            background: rgba(212, 175, 55, 0.05);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md);
            border-left: 4px solid var(--gold-muted);
        }

        .tip-card strong {
            color: var(--gold-muted);
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        .loading-message, .error-message {
            text-align: center;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-top: var(--spacing-lg);
            font-size: 1.1rem;
        }

        .loading-message {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold-muted);
            border: 2px solid var(--gold-muted);
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .input-group input[type="text"] {
                width: 100% !important;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .tips-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Business Management Styles */
        .business-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--accent-beige);
            padding-bottom: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .business-nav-btn {
            background: none;
            border: 2px solid var(--gold-muted);
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: var(--font-body);
        }

        .business-nav-btn.active,
        .business-nav-btn:hover {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }

        .business-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .business-section.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .date-range-selector select {
            padding: var(--spacing-sm);
            border: 2px solid var(--gold-muted);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
        }

        .financial-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        @media (min-width: 768px) {
            .financial-overview {
                grid-template-columns: repeat(4, 1fr);
                gap: var(--spacing-lg);
            }
        }

        .financial-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border-left: 4px solid;
        }

        .financial-card.earnings {
            border-left-color: #28a745;
        }

        .financial-card.expenses {
            border-left-color: #dc3545;
        }

        .financial-card.profit {
            border-left-color: var(--gold-muted);
        }

        .financial-card.mileage {
            border-left-color: #6f42c1;
        }

        .card-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .card-content h3 {
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .card-content .amount {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .card-content .period {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-lg);
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .chart-container h3 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        /* AI Assistant Styles */
        .ai-header {
            margin-bottom: var(--spacing-lg);
        }

        .ai-tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--accent-beige);
            flex-wrap: wrap;
        }

        .ai-tab-btn {
            background: none;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-family: var(--font-body);
        }

        .ai-tab-btn.active,
        .ai-tab-btn:hover {
            color: var(--gold-muted);
            border-bottom-color: var(--gold-muted);
            font-weight: 600;
        }

        .ai-tab-content {
            display: none;
        }

        .ai-tab-content.active {
            display: block;
        }

        .ai-input-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .ai-input-section label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
        }

        .ai-input-section textarea,
        .ai-input-section input[type="text"],
        .ai-input-section select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--gold-muted);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
            margin-bottom: var(--spacing-sm);
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, var(--gold-muted) 0%, #b8941f 100%);
            color: var(--bg-secondary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: var(--font-body);
        }

        .ai-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .ai-output-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .rich-text-editor {
            min-height: 300px;
            padding: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
            line-height: 1.6;
            margin-bottom: var(--spacing-md);
        }

        .social-output {
            min-height: 150px;
            padding: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
            line-height: 1.6;
            margin-bottom: var(--spacing-md);
            white-space: pre-wrap;
        }

        .ideas-list {
            padding: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            margin-bottom: var(--spacing-md);
        }

        .idea-item {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--gold-muted);
            transition: all 0.3s ease;
        }

        .idea-item:hover {
            border-left-color: var(--gold-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .idea-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gold-muted);
            margin-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--accent-beige);
            padding-bottom: var(--spacing-xs);
        }

        .idea-description {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .output-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .output-actions button {
            background: var(--accent-beige);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .output-actions button:hover {
            background: var(--gold-muted);
            color: var(--bg-secondary);
        }

        /* Expense and Mileage Tracker Styles */
        .expenses-header,
        .mileage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .add-btn {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .expense-form,
        .trip-form {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--gold-muted);
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
        }

        .form-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        .calculate-btn {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        /* Table Styles */
        .business-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .business-table th,
        .business-table td {
            padding: var(--spacing-sm);
            text-align: left;
            border-bottom: 1px solid var(--accent-beige);
        }

        .business-table th {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }

        .business-table tr:hover {
            background: var(--accent-beige);
        }

        .table-actions {
            margin-bottom: var(--spacing-md);
        }

        .export-btn {
            background: var(--accent-sage);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        /* Reports Styles */
        .reports-header {
            margin-bottom: var(--spacing-lg);
        }

        .report-date-range {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .generate-btn {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        .report-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-soft);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm);
            background: var(--accent-beige);
            border-radius: var(--border-radius-sm);
        }

        .summary-item label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-item span {
            font-weight: 600;
            color: var(--gold-muted);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .business-nav {
                flex-direction: column;
            }

            .business-nav-btn {
                text-align: center;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }

            .financial-overview {
                grid-template-columns: 1fr;
            }

            .dashboard-charts {
                grid-template-columns: 1fr;
            }

            .ai-tabs {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .report-date-range {
                flex-direction: column;
                align-items: stretch;
            }

            .business-table {
                font-size: 0.9rem;
            }

            .business-table th,
            .business-table td {
                padding: var(--spacing-xs);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Hamburger Menu -->
        <div class="header">
            <div class="header-left">
                <button class="hamburger-menu" onclick="toggleMobileMenu()">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="logo">Photography Management System</div>
            </div>
            
            <div class="header-right">

                <div id="userInfo" class="user-info" style="display: block;">
                    <span id="userName">lance@thelegacyphotography.com</span>
                    <button onclick="firebaseLogout()" class="logout-btn">Sign Out</button>
                </div>
            </div>
            
            <!-- Mobile Dropdown Menu - inside header for proper positioning -->
        <div class="mobile-menu" id="mobileMenu">
            <nav class="nav-menu">
                <ul>
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="switchTab('clients'); closeMobileMenu();">
                            Sessions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('goldenHour'); closeMobileMenu();">
                            🌅 Golden Hour Times
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('businessManagement'); closeMobileMenu();">
                            💼 Business Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('websiteBuilder'); closeMobileMenu();">
                            🌐 Website Builder
                        </a>
                    </li>





                    <li class="nav-item">
                        <a href="/storage-dashboard.html" target="_blank" class="nav-link">
                            💾 Storage Manager
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/onboarding" target="_blank" class="nav-link">
                            Business Setup
                        </a>
                    </li>

                </ul>
            </nav>
        </div>

        </div>
        
        <!-- Message Container for User Notifications -->
        <div id="messageContainer" style="
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
            font-family: var(--font-body);
        "></div>
        
        <!-- Main Content Area -->
        <div class="main-content">

        <!-- Client Management Tab Content -->
        <div id="clientsTab" class="tab-content active">
            <div class="content-header">
                <h1>Session Management</h1>
                <p>Manage your photography sessions and client bookings</p>
            </div>
        
        <!-- ENHANCED CLIENT DASHBOARD CONTROLS -->
        <div class="client-dashboard-controls">
            <div class="search-and-filters">
                <!-- Real-time Search Bar -->
                <div class="search-section">
                    <input type="text" id="clientSearch" placeholder="Search clients by name, location, or email..." 
                           oninput="filterSessions()" style="width: 100%; padding: 12px; border-radius: var(--border-radius); border: 2px solid var(--gold-muted); background: var(--bg-primary); color: var(--text-primary); font-size: 16px; font-family: var(--font-body);">
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status Filters:</label>
                            <div class="checkbox-filters">
                                <label><input type="checkbox" id="filterContractSigned" onchange="filterSessions()"> Contract Signed</label>
                                <label><input type="checkbox" id="filterPaid" onchange="filterSessions()"> Paid</label>
                                <label><input type="checkbox" id="filterDelivered" onchange="filterSessions()"> Delivered</label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label for="sessionTypeFilter">Session Type:</label>
                            <select id="sessionTypeFilter" onchange="filterSessions()">
                                <option value="">All Types</option>
                                <option value="Wedding">Wedding</option>
                                <option value="Family">Family</option>
                                <option value="Senior">Senior</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Event">Event</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <input type="date" id="dateFromFilter" onchange="filterSessions()" placeholder="From">
                            <span>to</span>
                            <input type="date" id="dateToFilter" onchange="filterSessions()" placeholder="To">
                        </div>
                        
                        <div class="filter-group">
                            <label for="sortOptions">Sort By:</label>
                            <select id="sortOptions" onchange="sortSessions()">
                                <option value="calendar-upcoming" selected>Calendar (Upcoming First)</option>
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="calendar-past">Calendar (Most Recent Past)</option>
                                <option value="name-asc">Client Name (A-Z)</option>
                                <option value="name-desc">Client Name (Z-A)</option>
                                <option value="unpaid-first">Unpaid First</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Archive Toggle & Actions -->
                <div class="archive-and-actions">
                    <label class="archive-toggle">
                        <input type="checkbox" id="showArchivedToggle" onchange="toggleArchivedSessions()">
                        Show Archived Sessions
                    </label>
                    <button onclick="clearAllFilters()" class="btn-secondary">Clear Filters</button>
                    <button onclick="exportAllSessions()" class="btn-primary"> Export All Sessions</button>
                </div>
            </div>
        </div>
        
        <!-- Session Form -->
        <div class="session-form">
            <h2>Add New Session</h2>
            <form id="sessionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <input type="text" id="sessionType" name="sessionType" required placeholder="Wedding, Portrait, etc.">
                    </div>
                    <div class="form-group">
                        <label for="dateTime">Date & Time</label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required placeholder="Session location">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" required placeholder="60">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" placeholder="Session notes..."></textarea>
                    </div>
                </div>
                
                <!-- Admin Workflow Checkboxes -->
                <div class="admin-checkboxes">
                    <h3>Admin Workflow Status</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contractSigned" name="contractSigned">
                            <label for="contractSigned">Contract Signed</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="paid" name="paid">
                            <label for="paid">Paid</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edited" name="edited">
                            <label for="edited">Edited</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="delivered" name="delivered">
                            <label for="delivered">Delivered</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="reminderEnabled" name="reminderEnabled">
                            <label for="reminderEnabled">Send Reminder</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sendReminder" name="sendReminder">
                            <label for="sendReminder">Send session reminder 24 hours before</label>
                        </div>
                        <div class="checkbox-group">

                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Session</button>

            </form>
        </div>

        <!-- Global Storage Overview -->
        <div id="globalStorageOverview" class="global-storage-section">
            <div class="storage-header">
                <h2>📊 Platform Storage Overview</h2>
                <button class="btn btn-secondary" onclick="refreshGlobalStorage()">🔄 Refresh</button>
            </div>
            <div class="storage-stats-grid">
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalSessions">-</div>
                    <div class="storage-stat-label">Total Sessions</div>
                </div>
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalGalleryStorage">-</div>
                    <div class="storage-stat-label">Gallery Storage</div>
                </div>
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalRawStorage">-</div>
                    <div class="storage-stat-label">Raw Storage</div>
                </div>
                <div class="storage-stat-card highlight">
                    <div class="storage-stat-number" id="totalCombinedStorage">-</div>
                    <div class="storage-stat-label">Total Storage Used</div>
                </div>
            </div>
        </div>

        <!-- Sessions Display -->
        <div id="sessionsContainer" class="sessions-grid">
            <div class="empty-state">
                <h3>No sessions yet</h3>
                <p>Add your first photography session above!</p>
            </div>
        </div>
    </div>





    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3>Create Payment Plan</h3>
            
            <div class="payment-plan-form">
                <div class="payment-plan-grid">
                    <div class="form-group">
                        <label for="planTotalAmount">Total Amount ($)</label>
                        <input type="number" id="planTotalAmount" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="planStartDate">Start Date</label>
                        <input type="date" id="planStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="planEndDate">End Date</label>
                        <input type="date" id="planEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="planReminderDays">Reminder Days Before</label>
                        <select id="planReminderDays">
                            <option value="1">1 day</option>
                            <option value="3" selected>3 days</option>
                            <option value="7">1 week</option>
                        </select>
                    </div>
                </div>
                
                <div class="payment-plan-summary" id="paymentPlanSummary" style="display: none;">
                    <h4>📋 Payment Plan Summary</h4>
                    <div id="paymentSummaryDetails"></div>
                    <div class="payment-schedule" id="paymentSchedulePreview"></div>
                </div>
                
                <div class="payment-plan-info">
                    <h4>ℹ️ How Payment Plans Work</h4>
                    <ul>
                        <li>Automatically calculates equal monthly payments</li>
                        <li>Sends Stripe invoices each month via email</li>
                        <li>Tracks payments and sends reminders</li>
                        <li>Updates session status when fully paid</li>
                    </ul>
                </div>
                
                <div class="payment-actions">
                    <button class="btn btn-primary" id="createPaymentPlanBtn" onclick="createPaymentPlan()">Create Payment Plan</button>
                    <button class="btn btn-secondary" onclick="calculatePaymentPreview()">Preview Payments</button>
                    <button class="btn btn-secondary" onclick="closePaymentPlanModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Plan View Modal -->
    <div id="paymentPlanViewModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3 id="paymentPlanViewTitle">Payment Plan Details</h3>
            
            <div id="paymentPlanViewContent">
                <!-- Payment plan details will be loaded here -->
            </div>
            
            <div class="payment-actions">
                <button class="btn btn-primary" onclick="processAutomatedPayments()">Process All Due Payments</button>
                <button class="btn btn-secondary" onclick="closePaymentPlanViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Define contract functions early to prevent reference errors
        window.sendContractToClient = async function(contractId) {
            try {
                console.log('sendContractToClient called with contractId:', contractId);
                
                showMessage('Preparing contract for sending...', 'info');

                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to prepare contract for sending');
                }

                // Fix the result structure to match what modal expects
                const contractData = {
                    contract: result.contract || result,
                    signingUrl: result.signingUrl || result.url || '',
                    emailData: result.emailData || {}
                };

                showContractSendingModal(contractId, contractData);

            } catch (error) {
                console.error('Error preparing contract:', error);
                showMessage(`Error: ${error.message || 'Unknown error occurred'}`, 'error');
            }
        }

        function showContractSendingModal(contractId, contractData) {
            const isResend = contractData.contract?.status === 'sent' || contractData.contract?.status === 'signed';
            const modalTitle = isResend ? 'Resend Contract' : 'Send Contract';
            
            const modalHTML = `
                <div id="contractSendModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">${modalTitle}</h2>
                            <button onclick="closeContractSendModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        ${isResend ? `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <p style="margin: 0; color: #856404;"><strong>Note:</strong> This contract has already been sent. Use the options below to resend it with any updates.</p>
                            </div>
                        ` : ''}
                        
                        <div class="contract-send-info" style="margin-bottom: 25px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #8b7355; margin: 0 0 15px 0;">Contract Details</h4>
                                <p><strong>Title:</strong> ${contractData.contract?.contract_title || 'Contract'}</p>
                                <p><strong>Client:</strong> ${contractData.contract?.client_name || 'Client'}</p>
                                <p><strong>Email:</strong> ${contractData.contract?.client_email || 'No email'}</p>
                                <p><strong>Phone:</strong> ${contractData.contract?.client_phone || 'No phone'}</p>
                            </div>
                            
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                                <h5 style="color: #28a745; margin: 0 0 10px 0;">Contract Signing URL</h5>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="signingUrlCopy" value="${contractData.signingUrl || ''}" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <button onclick="copySigningUrl()" class="btn btn-secondary">Copy URL</button>
                                </div>
                            </div>
                        </div>

                        <div class="send-options">
                            <button onclick="sendViaEmail('${contractId}', '${contractData.contract?.client_email}', '${contractData.signingUrl}', event)" 
                                    class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;">
                                📧 Open Email Client
                            </button>
                            
                            <button onclick="sendViaText('${contractId}', '${contractData.signingUrl}', '${contractData.contract?.client_name}', '${contractData.contract?.client_phone}', event)" 
                                    class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;">
                                💬 Send via Text Message
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeContractSendModal() {
            const modal = document.getElementById('contractSendModal');
            if (modal) modal.remove();
        }

        function copySigningUrl() {
            const urlInput = document.getElementById('signingUrlCopy');
            if (urlInput) {
                urlInput.select();
                document.execCommand('copy');
                showMessage('Contract URL copied to clipboard!', 'success');
            }
        }

        async function sendViaEmail(contractId, clientEmail, signingUrl, event) {
            // Declare button variables at function scope
            const emailBtn = event ? event.target : document.querySelector('button[onclick*="sendViaEmail"]');
            const originalText = emailBtn ? emailBtn.innerHTML : '📧 Send via Email';
            
            try {
                // Show loading state
                if (emailBtn) {
                    emailBtn.innerHTML = '📧 Opening Email...';
                    emailBtn.disabled = true;
                }
                
                // Get client name from contract data
                const clientName = document.querySelector('.contract-send-info p:nth-of-type(2)')?.textContent?.replace('Client: ', '') || 'Client';
                
                // Create email subject and body
                const subject = encodeURIComponent(`Photography Contract - Ready for Signing`);
                const body = encodeURIComponent(`Hi ${clientName},

Your photography contract is ready for review and signing. Please click the link below to access your contract:

${signingUrl}

If you have any questions, please don't hesitate to reach out.

Best regards,
Lance
The Legacy Photography`);
                
                // Create mailto link
                const mailtoLink = `mailto:${clientEmail}?subject=${subject}&body=${body}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                // Show success message and close modal
                showMessage(`Email client opened with contract details for ${clientEmail}`, 'success');
                closeContractSendModal();
                
            } catch (error) {
                console.error('Error opening email client:', error);
                showMessage(`Failed to open email client: ${error.message}`, 'error');
                
                // Restore button state
                if (emailBtn) {
                    emailBtn.innerHTML = originalText;
                    emailBtn.disabled = false;
                }
            }
        }

        // View signed copy of contract
        window.viewSignedCopy = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch signed contract');
                }
                
                const contract = await response.json();
                showSignedContractModal(contract);
                
            } catch (error) {
                console.error('Error fetching signed contract:', error);
                showMessage('Failed to load signed contract: ' + error.message, 'error');
            }
        }

        // Show signed contract modal
        function showSignedContractModal(contract) {
            const signedDate = contract.signed_date ? new Date(contract.signed_date).toLocaleDateString() : 'Not available';
            
            // Create signature display
            let signatureDisplay = '';
            if (contract.client_signature) {
                // Check if it's a base64 data URL
                if (contract.client_signature.startsWith('data:image/')) {
                    signatureDisplay = `<img src="${contract.client_signature}" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px; background: white;" alt="Client Signature">`;
                } else {
                    signatureDisplay = `<div style="padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-style: italic;">Signature: ${contract.client_signature}</div>`;
                }
            } else {
                signatureDisplay = '<div style="padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-style: italic;">Digital signature on file</div>';
            }
            
            const modalHTML = `
                <div id="signedContractModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 900px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">📄 Signed Contract - ${contract.contract_title}</h2>
                            <button onclick="closeModal('signedContractModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="signature-info" style="background: #e8f5e8; border: 1px solid #c3e6c3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #28a745; margin: 0 0 15px 0;">✅ Contract Signed</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div><strong>Client:</strong> ${contract.client_name}</div>
                                <div><strong>Email:</strong> ${contract.client_email}</div>
                                <div><strong>Signed Date:</strong> ${signedDate}</div>
                                <div><strong>Contract Type:</strong> ${contract.contract_title}</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>Client Signature:</strong>
                                <div style="margin-top: 8px;">
                                    ${signatureDisplay}
                                </div>
                            </div>
                        </div>
                        
                        <div class="contract-content" style="background: white; border: 2px solid #d4af37; border-radius: 6px; padding: 30px; margin-bottom: 20px; font-family: 'Times New Roman', serif; line-height: 1.6; white-space: pre-wrap; max-height: 500px; overflow-y: auto;">
${contract.contract_content}
                        </div>
                        
                        <div style="text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p style="margin: 0 0 15px 0; color: #666; font-style: italic;">This is a digitally signed copy stored for your records</p>
                            <button onclick="downloadSignedContractPDF('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                📄 Download PDF Copy
                            </button>
                            <button onclick="printSignedContract('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                🖨️ Print Contract
                            </button>
                            <button onclick="closeModal('signedContractModal')" class="btn btn-secondary">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Print signed contract
        window.printSignedContract = function(contractId) {
            const contractContent = document.querySelector('#signedContractModal .contract-content');
            const signatureInfo = document.querySelector('#signedContractModal .signature-info');
            
            if (contractContent) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Signed Contract</title>
                            <style>
                                body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 40px; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                                .signature-section { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: #f9f9f9; }
                                .content { white-space: pre-wrap; margin-bottom: 30px; }
                                img { max-width: 200px; max-height: 80px; }
                                @media print { .no-print { display: none; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>SIGNED CONTRACT</h1>
                                <p>Document printed on: ${new Date().toLocaleDateString()}</p>
                            </div>
                            <div class="content">${contractContent.innerHTML}</div>
                            <div class="signature-section">
                                <h3>Digital Signature Information</h3>
                                ${signatureInfo ? signatureInfo.innerHTML : 'Signature information not available'}
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        async function sendViaText(contractId, signingUrl, clientName, clientPhone, event) {
            // Declare button variables at function scope
            const smsBtn = event ? event.target : document.querySelector('button[onclick*="sendViaText"]');
            const originalText = smsBtn ? smsBtn.innerHTML : '💬 Send via Text Message';
            
            try {
                // Show loading state
                if (smsBtn) {
                    smsBtn.innerHTML = '💬 Sending SMS...';
                    smsBtn.disabled = true;
                }
                
                const response = await fetch('/api/contracts/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        contractId,
                        clientPhone,
                        clientName,
                        signingUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`Contract SMS sent successfully to ${result.sentTo}!`, 'success');
                    closeContractSendModal();
                } else {
                    throw new Error(result.error || 'Failed to send SMS');
                }
                
            } catch (error) {
                console.error('Error sending SMS:', error);
                
                // Check if it's an SMS configuration error
                if (error.message.includes('SMS service not configured')) {
                    showMessage('SMS service not configured. Opening default messaging app instead...', 'warning');
                    
                    // Fallback to opening default messaging app
                    const cleanPhone = clientPhone ? clientPhone.replace(/[^\d]/g, '') : '';
                    const message = encodeURIComponent(`Hi ${clientName}! Your photography contract is ready for signing: ${signingUrl} - Lance, The Legacy Photography`);
                    const smsLink = cleanPhone ? `sms:+1${cleanPhone}?body=${message}` : `sms:?body=${message}`;
                    window.location.href = smsLink;
                    closeContractSendModal();
                } else {
                    showMessage(`Failed to send SMS: ${error.message}`, 'error');
                }
                
                // Restore button state
                if (smsBtn) {
                    smsBtn.innerHTML = originalText;
                    smsBtn.disabled = false;
                }
            }
        }

        let sessions = [];

        let currentPaymentPlanSessionId = null;
        
        // Early payment plan function definition to ensure accessibility
        window.openPaymentPlanModal = function(sessionIdOrSession) {
            // Handle both sessionId string and session object
            let session;
            if (typeof sessionIdOrSession === 'string') {
                session = sessions.find(s => s.id === sessionIdOrSession);
                if (!session) {
                    console.error('Session not found:', sessionIdOrSession);
                    showMessage('Session not found', 'error');
                    return;
                }
            } else {
                session = sessionIdOrSession;
            }
            
            console.log('Opening payment plan modal for session:', session);
            
            // Remove test modal code since it works
            
            // Check if showMessage function exists
            if (typeof showMessage !== 'function') {
                console.log('showMessage function not found, defining it');
                window.showMessage = function(message, type) {
                    console.log(`${type}: ${message}`);
                    alert(message);
                };
            }
            
            // Create a working payment plan modal using the same approach as test modal
            const modalDiv = document.createElement('div');
            modalDiv.id = 'paymentPlanModal';
            modalDiv.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:2147483647;';
            
            modalDiv.innerHTML = `
                <div style="background:#1a1a1a;border:2px solid #d4af37;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;color:#f5f5f5;">
                    <div style="background:linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);color:#1a1a1a;padding:20px;border-radius:14px 14px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:1.5rem;">💳 Payment Plan Setup</h3>
                        <button onclick="document.getElementById('paymentPlanModal').remove()" style="background:none;border:none;font-size:2rem;color:#1a1a1a;cursor:pointer;">&times;</button>
                    </div>
                    <div style="padding:30px;">
                        <div style="background:rgba(212,175,55,0.1);border:1px solid #d4af37;border-radius:12px;padding:20px;margin-bottom:25px;text-align:center;">
                            <h4 style="color:#d4af37;margin:0 0 10px 0;">${session.clientName}</h4>
                            <p style="margin:0;opacity:0.8;">${session.sessionType} - ${new Date(session.dateTime).toLocaleDateString()}</p>
                            <p style="margin:0;opacity:0.8;">📧 ${session.email} | 📞 ${session.phoneNumber}</p>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Total Amount</label>
                            <input type="number" value="${session.price}" readonly style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Payment Frequency</label>
                            <select id="paymentFrequency" onchange="calculatePayments()" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Start Date</label>
                            <input type="date" id="startDate" onchange="calculatePayments()" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">End Date</label>
                            <input type="date" id="endDate" onchange="calculatePayments()" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div id="paymentCalculation" style="background:rgba(212,175,55,0.1);border:1px solid #d4af37;border-radius:12px;padding:20px;margin:20px 0;text-align:center;display:none;">
                            <h5 style="color:#d4af37;margin:0 0 15px 0;">💰 Payment Breakdown</h5>
                            <div id="calculationResults"></div>
                        </div>
                        
                        <div style="background:rgba(212,175,55,0.1);padding:20px;border-radius:12px;margin:20px 0;text-align:center;">
                            <p style="margin:0;color:#d4af37;">🚀 Payment Plan Feature Coming Soon!</p>
                            <p style="margin:10px 0 0 0;opacity:0.8;">Full Stripe integration with automated scheduling will be available soon.</p>
                        </div>
                        
                        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:30px;">
                            <button onclick="document.getElementById('paymentPlanModal').remove()" style="padding:12px 24px;background:rgba(102,126,234,0.8);color:white;border:2px solid #667eea;border-radius:8px;cursor:pointer;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Use direct DOM manipulation instead of insertAdjacentHTML
            
            // Remove existing modal if present
            const existingModal = document.getElementById('paymentPlanModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal directly to body
            document.body.appendChild(modalDiv);
            console.log('Payment plan modal added to document using DOM appendChild');
            
            // Modal should now be visible since we used the same approach as the working test modal
            console.log('Payment plan modal should now be visible');
            
            // Set default dates after modal is added
            setTimeout(() => {
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() + 7); // Default to next week
                const startDateInput = document.getElementById('startDate');
                if (startDateInput) {
                    startDateInput.value = startDate.toISOString().split('T')[0];
                }
                
                const endDate = new Date(today);
                endDate.setMonth(today.getMonth() + 6); // Default to 6 months
                const endDateInput = document.getElementById('endDate');
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                // Calculate initial payment breakdown
                calculatePayments();
                
                console.log('Payment plan modal setup complete');
            }, 100);
        };

        // Payment calculation function
        window.calculatePayments = function() {
            const totalAmount = 200; // Will be dynamic from session data
            const depositAmount = 12; // Will be dynamic from session data
            const remainingAmount = totalAmount - depositAmount;
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const frequencySelect = document.getElementById('paymentFrequency');
            const calculationDiv = document.getElementById('paymentCalculation');
            const resultsDiv = document.getElementById('calculationResults');
            
            if (!startDateInput || !endDateInput || !frequencySelect || !calculationDiv || !resultsDiv) {
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const frequency = frequencySelect.value;
            
            if (!startDateInput.value || !endDateInput.value) {
                calculationDiv.style.display = 'none';
                return;
            }
            
            if (endDate <= startDate) {
                resultsDiv.innerHTML = '<p style="color:#ff4444;margin:0;">End date must be after start date</p>';
                calculationDiv.style.display = 'block';
                return;
            }
            
            // Calculate number of payments based on frequency
            let daysBetween = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            let numberOfPayments;
            
            switch(frequency) {
                case 'weekly':
                    numberOfPayments = Math.ceil(daysBetween / 7);
                    break;
                case 'biweekly':
                    numberOfPayments = Math.ceil(daysBetween / 14);
                    break;
                case 'monthly':
                    numberOfPayments = Math.ceil(daysBetween / 30);
                    break;
                default:
                    numberOfPayments = 1;
            }
            
            const paymentAmount = Math.ceil((remainingAmount / numberOfPayments) * 100) / 100;
            const lastPaymentAmount = remainingAmount - (paymentAmount * (numberOfPayments - 1));
            
            resultsDiv.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;text-align:left;">
                    <div><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</div>
                    <div><strong>Deposit Paid:</strong> $${depositAmount.toFixed(2)}</div>
                    <div><strong>Remaining Balance:</strong> $${remainingAmount.toFixed(2)}</div>
                    <div><strong>Payment Frequency:</strong> ${frequency.charAt(0).toUpperCase() + frequency.slice(1)}</div>
                </div>
                <div style="background:rgba(26,26,26,0.6);padding:15px;border-radius:8px;margin-top:15px;">
                    <div style="color:#d4af37;font-size:1.2rem;margin-bottom:10px;"><strong>${numberOfPayments} payments of $${paymentAmount.toFixed(2)}</strong></div>
                    ${lastPaymentAmount !== paymentAmount ? `<div style="opacity:0.8;font-size:0.9rem;">Final payment: $${lastPaymentAmount.toFixed(2)}</div>` : ''}
                    <div style="opacity:0.8;font-size:0.9rem;margin-top:8px;">
                        From ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}
                    </div>
                </div>
            `;
            
            calculationDiv.style.display = 'block';
        };
        
        // Payment plan helper functions
        window.closePaymentPlanModal = function() {
            const modal = document.getElementById('paymentPlanModal');
            if (modal) {
                modal.remove();
            }
        };
        
        window.calculatePaymentPreview = function() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const frequency = document.getElementById('paymentFrequency').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (endDate <= startDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate payment schedule
            const paymentDates = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                paymentDates.push(new Date(currentDate));
                
                switch (frequency) {
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'bi-weekly':
                        currentDate.setDate(currentDate.getDate() + 14);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                }
            }
            
            const totalPayments = paymentDates.length;
            const paymentAmount = (totalAmount / totalPayments).toFixed(2);
            
            // Display preview
            let previewHtml = `
                <div class="payment-summary">
                    <strong>${totalPayments} payments of $${paymentAmount} each</strong>
                </div>
                <div class="payment-list">
            `;
            
            paymentDates.forEach((date, index) => {
                previewHtml += `
                    <div class="payment-item">
                        <span>Payment ${index + 1}</span>
                        <span>${date.toLocaleDateString()} - $${paymentAmount}</span>
                    </div>
                `;
            });
            
            previewHtml += `</div>`;
            
            document.getElementById('previewContent').innerHTML = previewHtml;
            document.getElementById('paymentPreview').style.display = 'block';
        };
        
        window.createPaymentPlan = async function() {
            const sessionId = document.getElementById('sessionId').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const frequency = document.getElementById('paymentFrequency').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reminderDays = parseInt(document.getElementById('reminderDays').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                showMessage('Creating payment plan...', 'info');
                
                const response = await fetch('/api/payment-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId,
                        totalAmount,
                        frequency,
                        startDate,
                        endDate,
                        reminderDays
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage(`Payment plan created successfully! ${result.plan.totalPayments} ${frequency} payments of $${result.plan.monthlyPayment} each.`, 'success');
                    closePaymentPlanModal();
                    loadSessions(); // Refresh sessions
                } else {
                    throw new Error(result.error || 'Failed to create payment plan');
                }
                
            } catch (error) {
                console.error('Error creating payment plan:', error);
                showMessage('Error creating payment plan: ' + error.message, 'error');
            }
        };

        // Allow both past and future dates for historical session entries
        window.setMinDateTime = function() {
            // Remove any date restrictions to allow past dates for historical entries
            const dateTimeInput = document.getElementById('dateTime');
            if (dateTimeInput) {
                dateTimeInput.removeAttribute('min');
                dateTimeInput.removeAttribute('max');
                
                // Ensure the datetime picker is clickable and functional
                dateTimeInput.style.cursor = 'pointer';
                
                // Remove showPicker() calls due to cross-origin security restrictions
                // The native datetime-local input will show picker automatically when clicked
                dateTimeInput.addEventListener('click', function() {
                    this.focus();
                });
                
                // Add manual focus trigger for better compatibility
                dateTimeInput.addEventListener('focus', function() {
                    // Let the browser handle the native datetime picker
                });
            }
        }

        // UNIFIED APP INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            console.log('Initializing page...');
            
            // Dev mode banner
            if (DEV_MODE) {
                const banner = document.createElement("div");
                banner.textContent = "Warning DEV MODE ENABLED - NO AUTH CHECK";
                banner.style = "position:fixed;top:0;width:100%;background:#ffc;padding:5px;text-align:center;z-index:10000;font-weight:bold;color:#333;";
                document.body.appendChild(banner);
                document.body.style.marginTop = "30px";
            }
            
            // Initialize hamburger menu
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.remove('show');
            }
            
            // Main app initialization
            loadSessions();
            setupEventListeners();
            setMinDateTime();
            
            // Hide contract modal
            const contractModal = document.getElementById('contractModal');
            if (contractModal) {
                contractModal.style.display = 'none';
            }
            
            console.log('Photography management system loaded');
            showMessage('Welcome to your photography management platform!', 'success');
        });

        window.setupEventListeners = function() {
            document.getElementById('sessionForm').addEventListener('submit', addSession);
            
            // Add form reset button functionality
            const resetBtn = document.querySelector('button[type="reset"]');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        setMinDateTime(); // Keep dates unrestricted for historical entries

                        const submitBtn = document.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Add Session';
                    }, 10);
                });
            }
        }

        window.addSession = async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on',
                sendReminder: formData.get('sendReminder') === 'on',

                photos: []
            };

            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    const newSession = await response.json();
                    sessions.unshift(newSession);
                    window.renderSessions();
                    resetForm(e.target);
                    showMessage('Session added successfully!', 'success');
                } else {
                    showMessage('Failed to add session', 'error');
                }
            } catch (error) {
                console.error('Error processing session:', error);
                showMessage('Error processing session', 'error');
            }
        }

        function resetForm(form) {
            form.reset();
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Session';
            
            // Keep date unrestricted to allow historical entries
            setMinDateTime();
        }

        window.loadSessions = async function() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const rawData = await response.json();
                    console.log('Data type:', typeof rawData, 'Array:', Array.isArray(rawData));
                    console.log('Raw API response:', rawData);
                    
                    // Debug deposit amount for Testing dammit session
                    const testingSession = rawData.find(s => s.clientName === 'Testing dammit');
                    console.log('Testing session deposit_amount from API:', testingSession?.depositAmount || 'NOT FOUND');
                    
                    // Transform and ensure deposit amounts are properly included
                    sessions = rawData.map(session => ({
                        ...session,
                        depositAmount: session.depositAmount || session.deposit_amount || 0,
                        reminderEnabled: session.sendReminder || false,
                        reminderSent: session.reminderSent || false
                    }));
                    
                    console.log('Transformed sessions:', sessions);
                    console.log(`Successfully loaded ${sessions.length} sessions`);
                    
                    // FORCE RENDER THE FUCKING SESSIONS DIRECTLY
                    console.log('About to render sessions...');
                    if (typeof window.renderSessions === 'function') {
                        window.renderSessions();
                        console.log('renderSessions called successfully');
                    } else {
                        console.error('renderSessions function not found in window scope');
                    }
                    
                    // Apply sort after initial render - force execution
                    console.log('About to call sortSessions...');
                    setTimeout(() => {
                        sortSessions();
                        console.log('sortSessions completed');
                    }, 100);
                    
                    // Remove any existing storage display elements from session cards
                    setTimeout(() => {
                        document.querySelectorAll('.session-total-storage').forEach(element => {
                            element.remove();
                        });
                    }, 150);
                    
                    // Load global storage statistics after sessions are loaded
                    console.log('Loading global storage statistics...');
                    setTimeout(() => {
                        loadGlobalStorageStats();
                    }, 200);
                } else if (response.status === 403) {
                    const data = await response.json();
                    if (data.requiresSubscription) {
                        showSubscriptionModal(data.message);
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        window.renderSessions = function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Add your first photography session above!</p>
                    </div>
                `;
                return;
            }

            // Filter visible sessions first, then render
            const visibleSessions = sessions.filter(session => isSessionVisible(session));
            
            const sessionElements = [];
            
            for (const session of visibleSessions) {
                const sessionId = session.id;
                const sessionHTML = `
                <div class="session-list-item" data-session-id="${sessionId}" onclick="toggleSessionDetails('${sessionId}')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">${session.clientName}</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar ${formatDateTime(session.dateTime)}</span>
                                <span class="session-location"> ${session.location}</span>
                                <span class="session-duration">⏱️ ${formatDuration(session.duration)}</span>
                                <span class="session-price">Money $${session.price}</span>
                                ${(session.depositAmount && session.depositAmount > 0) ? 
                                    `<span class="session-deposit" style="color: #28a745; font-weight: 600;">Deposit: $${session.depositAmount.toFixed(2)}</span>` : 
                                    ''}
                                ${(session.depositAmount && session.depositAmount > 0) ? 
                                    `<span class="session-remaining" style="color: #d4af37; font-weight: 600;">Remaining: $${(session.price - session.depositAmount).toFixed(2)}</span>` : 
                                    ''
                                }
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-${sessionId}">▼</div>
                    </div>
                    
                    <div class="session-details" id="details-${sessionId}" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:${session.email}" style="color: #d4af37;">${session.email}</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">${session.phoneNumber}</span>
                                    <button onclick="callClient('${session.phoneNumber}'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('${session.phoneNumber}', '${session.clientName}', '${sessionId}'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> ${session.sessionType}
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> ${formatDuration(session.duration)}
                                </div>
                                <div class="detail-item">

                                </div>
                                ${session.notes ? `
                                    <div class="detail-item">
                                        <strong>Notes:</strong> ${session.notes}
                                    </div>
                                ` : ''}
                                ${session.hasPaymentPlan ? `
                                    <div class="detail-item">
                                        <strong>Payment Plan:</strong> $${session.monthlyPayment}/month (${session.paymentsRemaining || 0} remaining)
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_${sessionId}" ${session.contractSigned ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_${sessionId}">Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_${sessionId}" ${session.paid ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_${sessionId}">Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_${sessionId}" ${session.edited ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_${sessionId}">Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_${sessionId}" ${session.delivered ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_${sessionId}">Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_${sessionId}" ${session.sendReminder ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_${sessionId}">Send Reminder</label>
                                </div>

                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="openUpdateSessionModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Update Session</button>
                                <button onclick="addToCalendar('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Calendar</button>
                                <button onclick="openEmailClient('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Email</button>
                                <button onclick="viewSessionContracts('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Contracts</button>

                                ${session.hasPaymentPlan ? `
                                    <button onclick="viewPaymentPlan('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                ` : `
                                    <button onclick="openInvoiceModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Send Invoice</button>
                                    <button onclick="openPaymentPlanModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                `}
                                <button onclick="exportSessionPDF('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Export PDF</button>

                                <button onclick="deleteSession('${sessionId}'); event.stopPropagation();" class="btn btn-danger">Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Session Notes & Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" ${session.printsOrdered ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" ${session.specialEdits ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" ${session.clientFeedback ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" ${session.socialMediaApproval ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" ${session.retouchingNeeded ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" ${session.backupCompleted ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." 
                                     onchange="updateSessionNotes('${sessionId}', 'sessionNotes', this.value); event.stopPropagation();"
                                     onclick="event.stopPropagation();">${session.sessionNotes || ''}</textarea>
                        </div>

                        <!-- Simplified Gallery and Storage Actions -->
                        <div class="session-file-actions">
                            <h4>Files & Storage</h4>
                            <div class="file-action-buttons">
                                <button onclick="openGalleryWindow('${sessionId}'); event.stopPropagation();" class="btn btn-primary">📸 Open Gallery</button>
                                <button onclick="openRawStorageWindow('${sessionId}'); event.stopPropagation();" class="btn btn-primary">📁 Open Raw Storage</button>
                                <button onclick="sendGalleryToClient('${sessionId}'); event.stopPropagation();" class="btn btn-success">✉️ Send to Client</button>
                            </div>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        ${session.delivered ? `
                            <div class="tip-panel" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h4 style="margin-top: 0; color: #28a745;">💡 Session Delivered</h4>
                                <p style="margin-bottom: 10px;">This session has been marked as delivered. Consider:</p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li>Following up for feedback</li>
                                    <li>Requesting testimonials or reviews</li>
                                    <li>Sharing social media posts (with permission)</li>
                                    <li>Scheduling future sessions</li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
                `;
                sessionElements.push(sessionHTML);
            }
            
            container.innerHTML = sessionElements.join('');
            
            // No longer loading files for all sessions - simplified interface

        }

        window.toggleSessionDetails = function(sessionId) {
            const details = document.getElementById(`details-${sessionId}`);
            const expandIcon = document.getElementById(`expand-${sessionId}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                expandIcon.textContent = '▲';
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                expandIcon.textContent = '▼';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // File Management Functions
        window.loadSessionFiles = async function(sessionId, folderType) {
            const container = document.getElementById(`${folderType}-files-${sessionId}`);
            const countElement = document.getElementById(`${folderType}-count-${sessionId}`);
            
            if (!container) return;

            try {
                const authToken = await getAuthToken();
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                if (!response.ok) {
                    throw new Error('Failed to load files');
                }

                const data = await response.json();
                const files = data.files || [];

                // Update file count
                if (countElement) {
                    countElement.textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
                }

                // Render file list
                if (files.length === 0) {
                    container.innerHTML = '<div class="loading-files">No files uploaded yet</div>';
                } else {
                    container.innerHTML = files.map(file => {
                        const isImage = file.contentType && file.contentType.startsWith('image/');
                        return `
                        <div class="file-item">
                            ${isImage ? `
                                <div class="file-thumbnail">
                                    <img src="/api/sessions/${sessionId}/files/${folderType}/thumbnail/${file.name}" 
                                         alt="${file.name}"
                                         onclick="window.open('${file.downloadUrl}', '_blank'); event.stopPropagation();"
                                         onerror="this.style.display='none';"
                                         loading="lazy">
                                </div>
                            ` : ''}
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta">${formatFileSize(file.size)} • ${formatDate(file.timeCreated)}</div>
                            </div>
                            <div class="file-actions">
                                <button onclick="downloadFile('${sessionId}', '${folderType}', '${file.name}'); event.stopPropagation();" 
                                        class="btn btn-secondary">Download</button>
                                <button onclick="deleteFile('${sessionId}', '${folderType}', '${file.name}'); event.stopPropagation();" 
                                        class="btn btn-danger">Delete</button>
                            </div>
                        </div>
                    `;}).join('');
                }
            } catch (error) {
                console.error('Error loading files:', error);
                container.innerHTML = '<div class="loading-files">Error loading files</div>';
                if (countElement) {
                    countElement.textContent = 'Error';
                }
            }
        }

        // Storage display functionality removed per user request

        window.openFileUploader = function(sessionId, folderType) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fileUploadModal';
            modal.innerHTML = `
                <div class="payment-plan-modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Upload Files - ${folderType === 'gallery' ? '📸 Gallery' : '📁 Raw Storage'}</h3>
                        <button class="close-btn" onclick="closeFileUploadModal()">&times;</button>
                    </div>
                    <div style="padding: 20px; color: white;">
                        <div class="upload-area" style="border: 2px dashed #d4af37; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px; background: rgba(212, 175, 55, 0.1);">
                            <input type="file" id="fileInput" multiple style="display: none;" accept="*/*">
                            <div style="color: #d4af37; font-size: 48px; margin-bottom: 15px;">📁</div>
                            <p style="margin: 0 0 15px 0; color: #d4af37;">Drop files here or click to select</p>
                            <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">Choose Files</button>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div style="background: #333; border-radius: 8px; overflow: hidden; margin-bottom: 10px;">
                                <div id="progressBar" style="height: 20px; background: linear-gradient(45deg, #d4af37, #f4e4bc); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="uploadStatus" style="text-align: center; color: #d4af37;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="startUpload('${sessionId}', '${folderType}')" class="btn btn-success" style="margin-right: 10px;">Upload Files</button>
                            <button onclick="closeFileUploadModal()" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle drag and drop
            const uploadArea = modal.querySelector('.upload-area');
            const fileInput = modal.querySelector('#fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#f4e4bc';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.2)';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d4af37';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.1)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d4af37';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.1)';
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay();
            });
            
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', updateFileDisplay);
            
            function updateFileDisplay() {
                const files = Array.from(fileInput.files);
                if (files.length > 0) {
                    uploadArea.querySelector('p').textContent = `${files.length} file(s) selected`;
                }
            }
        }

        window.closeFileUploadModal = function() {
            const modal = document.getElementById('fileUploadModal');
            if (modal) {
                modal.remove();
            }
        }

        window.startUpload = async function(sessionId, folderType) {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                showMessage('Please select files to upload', 'error');
                return;
            }

            // QUOTA VALIDATION: Check if user can upload all selected files
            try {
                const quotaValidation = await window.storageQuotaChecker.validateUpload(files);
                
                if (!quotaValidation.canUpload) {
                    // Show quota exceeded modal
                    window.storageQuotaChecker.showQuotaExceededModal(quotaValidation);
                    return;
                }
                
                if (quotaValidation.warning) {
                    // Show storage warning
                    window.storageQuotaChecker.showStorageWarning(quotaValidation);
                    // Continue with upload after warning
                }
            } catch (quotaError) {
                console.error('Quota check failed, proceeding with upload:', quotaError);
                // Continue with upload (fail-safe)
            }
            
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            
            uploadProgress.style.display = 'block';
            
            try {
                let uploadedCount = 0;
                const totalFiles = files.length;
                
                // Process files in batches of 2
                for (let i = 0; i < files.length; i += 2) {
                    const batch = files.slice(i, i + 2);
                    
                    await Promise.all(batch.map(async (file) => {
                        try {
                            // Get upload URL with file size for quota enforcement
                            const authToken = await getAuthToken();
                            const uploadResponse = await fetch(`/api/sessions/${sessionId}/files/upload`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                                },
                                body: JSON.stringify({ 
                                    folderType, 
                                    fileName: file.name,
                                    fileSize: file.size 
                                })
                            });
                            
                            if (!uploadResponse.ok) {
                                if (uploadResponse.status === 413) {
                                    // Handle quota exceeded error
                                    const errorData = await uploadResponse.json();
                                    window.storageQuotaChecker.showQuotaExceededModal(errorData);
                                    throw new Error('Storage quota exceeded');
                                }
                                throw new Error('Failed to get upload URL');
                            }
                            
                            const { uploadURL } = await uploadResponse.json();
                            
                            // Upload file to signed URL
                            const putResponse = await fetch(uploadURL, {
                                method: 'PUT',
                                body: file,
                                headers: {
                                    'Content-Type': file.type || 'application/octet-stream'
                                }
                            });
                            
                            if (!putResponse.ok) {
                                throw new Error('Failed to upload file');
                            }
                            
                            uploadedCount++;
                            const progress = (uploadedCount / totalFiles) * 100;
                            progressBar.style.width = `${progress}%`;
                            uploadStatus.textContent = `Uploaded ${uploadedCount} of ${totalFiles} files`;
                            
                        } catch (error) {
                            console.error('Error uploading file:', file.name, error);
                            showMessage(`Failed to upload ${file.name}`, 'error');
                        }
                    }));
                }
                
                showMessage(`Successfully uploaded ${uploadedCount} files to ${folderType}!`, 'success');
                closeFileUploadModal();
                
                // Reload files for this session
                loadSessionFiles(sessionId, folderType);
                
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Upload failed: ' + error.message, 'error');
            }
        }

        window.downloadFile = function(sessionId, folderType, fileName) {
            const url = `/api/sessions/${sessionId}/files/${folderType}/download/${fileName}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
        }

        window.downloadAllFiles = function(sessionId, folderType) {
            const url = `/api/sessions/${sessionId}/files/${folderType}/download-zip`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sessionId}-${folderType}.zip`;
            a.click();
            showMessage(`Downloading all ${folderType} files...`, 'success');
        }

        window.deleteFile = async function(sessionId, folderType, fileName) {
            // UPDATED: Now uses unified deletion system for consistent storage tracking
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }
            
            try {
                // Import and use PhotoDeletion class if not already available
                if (typeof PhotoDeletion === 'undefined') {
                    console.log('Loading PhotoDeletion class...');
                    await import('/static/js/photo-deletion.js');
                }
                
                const photoDeletion = new PhotoDeletion();
                await photoDeletion.deletePhoto(sessionId, folderType, fileName);
                
                // Refresh the session files view
                loadSessionFiles(sessionId, folderType);
                
            } catch (error) {
                console.error('Error deleting file:', error);
                showMessage('Failed to delete file: ' + error.message, 'error');
            }
        }

        // Open Gallery folder in new window
        window.openGalleryWindow = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const url = `/gallery-manager.html?sessionId=${sessionId}&folderType=gallery&clientName=${encodeURIComponent(session.clientName)}`;
            const windowName = `gallery_${sessionId}`;
            const windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no';
            
            window.open(url, windowName, windowFeatures);
        };

        // Open Raw Storage folder in new window
        window.openRawStorageWindow = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const url = `/gallery-manager.html?sessionId=${sessionId}&folderType=raw&clientName=${encodeURIComponent(session.clientName)}`;
            const windowName = `raw_${sessionId}`;
            const windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no';
            
            window.open(url, windowName, windowFeatures);
        };

        window.sendGalleryToClient = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const clientGalleryUrl = `${window.location.origin}/client-gallery.html?session=${sessionId}`;
            const subject = `Your Photography Gallery - ${session.sessionType} Session`;
            const body = `Hi ${session.clientName},

Your photography gallery is ready for viewing and download!

📸 View Your Gallery: ${clientGalleryUrl}

You can:
• View all your photos in high resolution
• Download individual photos
• Download selected photos as a ZIP file
• Download your entire gallery

The gallery will remain available for download. If you have any questions or need assistance, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
            
            showMessage('Email client opened with gallery link!', 'success');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }






















        // Search ENHANCED CLIENT MANAGEMENT FUNCTIONS

        // Filter and Search Functionality
        function filterSessions() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const contractFilter = document.getElementById('filterContractSigned').checked;
            const paidFilter = document.getElementById('filterPaid').checked;
            const deliveredFilter = document.getElementById('filterDelivered').checked;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            sessions.forEach(session => {
                const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
                if (!sessionCard) return;

                let isVisible = true;

                // Search filter
                if (searchTerm) {
                    const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        isVisible = false;
                    }
                }

                // Status filters
                if (contractFilter && !session.contractSigned) isVisible = false;
                if (paidFilter && !session.paid) isVisible = false;
                if (deliveredFilter && !session.delivered) isVisible = false;

                // Session type filter
                if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) isVisible = false;

                // Date range filter
                if (dateFromFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate < dateFromFilter) isVisible = false;
                }
                if (dateToFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate > dateToFilter) isVisible = false;
                }



                sessionCard.classList.toggle('hidden-by-filter', !isVisible);
            });
        }

        window.isSessionVisible = function(session) {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const contractFilter = document.getElementById('filterContractSigned')?.checked || false;
            const paidFilter = document.getElementById('filterPaid')?.checked || false;
            const deliveredFilter = document.getElementById('filterDelivered')?.checked || false;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter')?.value || '';
            const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
            const dateToFilter = document.getElementById('dateToFilter')?.value || '';


            // Search filter
            if (searchTerm) {
                const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }

            // Status filters
            if (contractFilter && !session.contractSigned) return false;
            if (paidFilter && !session.paid) return false;
            if (deliveredFilter && !session.delivered) return false;

            // Session type filter
            if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) return false;

            // Date range filter
            if (dateFromFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate < dateFromFilter) return false;
            }
            if (dateToFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate > dateToFilter) return false;
            }



            return true;
        }

        // Sort Functionality
        function sortSessions() {
            const sortOption = document.getElementById('sortOptions')?.value || 'calendar-upcoming';
            
            sessions.sort((a, b) => {
                const now = new Date();
                
                // Enhanced date parsing with validation
                let dateA = new Date(a.dateTime);
                let dateB = new Date(b.dateTime);
                
                // Validate dates and provide fallback
                if (isNaN(dateA.getTime())) {
                    console.warn('Invalid date for session A:', a.clientName, a.dateTime);
                    dateA = new Date(0); // Use epoch as fallback
                }
                if (isNaN(dateB.getTime())) {
                    console.warn('Invalid date for session B:', b.clientName, b.dateTime);
                    dateB = new Date(0); // Use epoch as fallback
                }
                
                switch (sortOption) {
                    case 'date-desc':
                        // Parse dates properly to ensure accurate sorting
                        return dateB.getTime() - dateA.getTime(); // Newest first
                    case 'date-asc':
                        return dateA.getTime() - dateB.getTime(); // Oldest first
                    case 'calendar-upcoming':
                        // Show upcoming sessions first (with same-day priority), then past sessions
                        const aIsFuture = dateA > now;
                        const bIsFuture = dateB > now;
                        
                        // Check if sessions are on the same day as today
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        const aIsToday = dateA >= today && dateA < tomorrow;
                        const bIsToday = dateB >= today && dateB < tomorrow;
                        
                        // Same-day sessions always come first
                        if (aIsToday && !bIsToday) return -1;
                        if (!aIsToday && bIsToday) return 1;
                        
                        // Both are today - sort by time
                        if (aIsToday && bIsToday) {
                            return dateA.getTime() - dateB.getTime();
                        }
                        
                        // Standard future/past logic for non-today sessions
                        if (aIsFuture && bIsFuture) {
                            return dateA.getTime() - dateB.getTime(); // Earliest upcoming first
                        } else if (aIsFuture && !bIsFuture) {
                            return -1; // Future before past
                        } else if (!aIsFuture && bIsFuture) {
                            return 1; // Past after future
                        } else {
                            return dateB.getTime() - dateA.getTime(); // Most recent past first
                        }
                    case 'calendar-past':
                        // Show most recent past sessions first, then upcoming
                        const aIsPast = dateA <= now;
                        const bIsPast = dateB <= now;
                        
                        if (aIsPast && bIsPast) {
                            return dateB.getTime() - dateA.getTime(); // Most recent past first
                        } else if (aIsPast && !bIsPast) {
                            return -1; // Past before future
                        } else if (!aIsPast && bIsPast) {
                            return 1; // Future after past
                        } else {
                            return dateA.getTime() - dateB.getTime(); // Earliest upcoming first
                        }
                    case 'name-asc':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'unpaid-first':
                        if (a.paid === b.paid) {
                            // If payment status is same, sort by date (newest first)
                            return dateB.getTime() - dateA.getTime();
                        }
                        return a.paid ? 1 : -1;
                    default:
                        return dateB.getTime() - dateA.getTime();
                }
            });
            
            // Enhanced logging with date validation
            const sessionDebug = sessions.map(s => ({
                name: s.clientName,
                date: s.dateTime,
                parsedDate: new Date(s.dateTime),
                isValidDate: !isNaN(new Date(s.dateTime).getTime()),
                isFuture: new Date(s.dateTime) > new Date()
            }));
            console.log(`Sessions sorted by ${sortOption}:`, sessionDebug);
            
            // Show clearer chronological order for calendar-upcoming
            if (sortOption === 'calendar-upcoming') {
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const todayList = sessions.filter(s => {
                    const sessionDate = new Date(s.dateTime);
                    return sessionDate >= today && sessionDate < tomorrow;
                });
                const futureList = sessions.filter(s => new Date(s.dateTime) >= tomorrow);
                const pastList = sessions.filter(s => new Date(s.dateTime) < today);
                
                console.log('=== CHRONOLOGICAL ORDER (calendar-upcoming) ===');
                
                if (todayList.length > 0) {
                    console.log('🎯 TODAY\'S SESSIONS (priority):');
                    todayList.forEach((s, i) => {
                        const sessionDate = new Date(s.dateTime);
                        console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleTimeString()} today`);
                    });
                }
                
                console.log('📅 UPCOMING SESSIONS (closest first):');
                futureList.forEach((s, i) => {
                    const sessionDate = new Date(s.dateTime);
                    const daysUntil = Math.ceil((sessionDate - now) / (1000 * 60 * 60 * 24));
                    console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleDateString()} (in ${daysUntil} days)`);
                });
                
                console.log('📅 PAST SESSIONS (most recent first):');
                pastList.forEach((s, i) => {
                    const sessionDate = new Date(s.dateTime);
                    const daysAgo = Math.ceil((now - sessionDate) / (1000 * 60 * 60 * 24));
                    console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleDateString()} (${daysAgo} days ago)`);
                });
            }
            
            window.renderSessions();
        }



        // Enhanced Notes Functionality
        window.updateSessionNotes = async function(sessionId, field, value) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session[field] = value;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (!response.ok) {
                    showMessage('Error saving notes', 'error');
                }
            } catch (error) {
                console.error('Error updating session notes:', error);
                showMessage('Error saving notes', 'error');
            }
        }

        // PDF Export Functionality
        window.exportSessionPDF = async function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            try {
                // Create PDF content
                const pdfContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px;">
                        <h1 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 10px;">
                            Photography Session Summary
                        </h1>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                            <div>
                                <h2 style="color: #333;">Client Information</h2>
                                <p><strong>Name:</strong> ${session.clientName}</p>
                                <p><strong>Email:</strong> ${session.email}</p>
                                <p><strong>Phone:</strong> ${session.phoneNumber}</p>
                                <p><strong>Location:</strong> ${session.location}</p>
                            </div>
                            <div>
                                <h2 style="color: #333;">Session Details</h2>
                                <p><strong>Type:</strong> ${session.sessionType}</p>
                                <p><strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}</p>
                                <p><strong>Duration:</strong> ${session.duration} hours</p>
                                <p><strong>Price:</strong> $${session.price}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Workflow Status</h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <p>Document Contract Signed: ${session.contractSigned ? 'Success Yes' : 'Error No'}</p>
                                <p>Money Paid: ${session.paid ? 'Success Yes' : 'Error No'}</p>
                                <p> Edited: ${session.edited ? 'Success Yes' : 'Error No'}</p>
                                <p>Package Delivered: ${session.delivered ? 'Success Yes' : 'Error No'}</p>
                                <p> Send Reminder: ${session.sendReminder ? 'Success Yes' : 'Error No'}</p>

                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Additional Checklist</h2>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <p>🖨️ Prints Ordered: ${session.printsOrdered ? 'Success Yes' : 'Error No'}</p>
                                <p>Star Special Edits: ${session.specialEdits ? 'Success Yes' : 'Error No'}</p>
                                <p>Message Client Feedback: ${session.clientFeedback ? 'Success Yes' : 'Error No'}</p>
                                <p>Mobile Social Media OK: ${session.socialMediaApproval ? 'Success Yes' : 'Error No'}</p>
                                <p>🎨 Retouching Needed: ${session.retouchingNeeded ? 'Success Yes' : 'Error No'}</p>
                                <p>💾 Backup Completed: ${session.backupCompleted ? 'Success Yes' : 'Error No'}</p>
                            </div>
                        </div>
                        
                        ${session.sessionNotes ? `
                            <div style="margin: 30px 0;">
                                <h2 style="color: #333;">Session Notes</h2>
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #d4af37;">
                                    ${session.sessionNotes.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 50px; text-align: center; color: #666; font-size: 12px;">
                            <p>Generated on ${new Date().toLocaleDateString()} | Photography Management System</p>
                        </div>
                    </div>
                `;

                // Create new window for PDF generation
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Session Summary - ${session.clientName}</title>
                        <style>
                            body { margin: 0; font-family: Arial, sans-serif; }
                            @media print { 
                                body { margin: 1in; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="no-print" style="text-align: center; padding: 20px;">
                            <button onclick="window.print()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                 Print/Save as PDF
                            </button>
                        </div>
                        ${pdfContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                showMessage('PDF export opened in new window', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF export', 'error');
            }
        }

        // Export All Sessions
        function exportAllSessions() {
            const visibleSessions = sessions.filter(isSessionVisible);
            
            if (visibleSessions.length === 0) {
                showMessage('No sessions to export', 'error');
                return;
            }

            try {
                const csvContent = generateCSVExport(visibleSessions);
                downloadCSV(csvContent, `sessions-export-${new Date().toISOString().split('T')[0]}.csv`);
                showMessage(`Exported ${visibleSessions.length} sessions to CSV`, 'success');
            } catch (error) {
                console.error('Error exporting sessions:', error);
                showMessage('Error exporting sessions', 'error');
            }
        }

        function generateCSVExport(sessionsToExport) {
            const headers = [
                'Client Name', 'Email', 'Phone', 'Session Type', 'Date & Time', 'Location', 
                'Duration', 'Price', 'Contract Signed', 'Paid', 'Edited', 'Delivered',
                'Prints Ordered', 'Special Edits', 'Client Feedback', 'Social Media OK',
                'Retouching Needed', 'Backup Completed', 'Session Notes', 'Archived'
            ];

            const csvRows = [headers.join(',')];

            sessionsToExport.forEach(session => {
                const row = [
                    `"${session.clientName}"`,
                    `"${session.email}"`,
                    `"${session.phoneNumber}"`,
                    `"${session.sessionType}"`,
                    `"${formatDateTime(session.dateTime)}"`,
                    `"${session.location}"`,
                    session.duration,
                    session.price,
                    session.contractSigned ? 'Yes' : 'No',
                    session.paid ? 'Yes' : 'No',
                    session.edited ? 'Yes' : 'No',
                    session.delivered ? 'Yes' : 'No',
                    session.printsOrdered ? 'Yes' : 'No',
                    session.specialEdits ? 'Yes' : 'No',
                    session.clientFeedback ? 'Yes' : 'No',
                    session.socialMediaApproval ? 'Yes' : 'No',
                    session.retouchingNeeded ? 'Yes' : 'No',
                    session.backupCompleted ? 'Yes' : 'No',
                    `"${(session.sessionNotes || '').replace(/"/g, '""')}"`,
                    'No'
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('filterContractSigned').checked = false;
            document.getElementById('filterPaid').checked = false;
            document.getElementById('filterDelivered').checked = false;
            document.getElementById('sessionTypeFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('sortOptions').value = 'calendar-upcoming';
            
            filterSessions();
            sortSessions();
        }

        // 💛 TIP FUNCTIONALITY FOR DELIVERED SESSIONS
        window.generateTipPanel = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || !session.delivered) return '';

            return `
                <div class="tip-panel" style="background: linear-gradient(135deg, #fff9e6, #f4e4bc); padding: 20px; margin-top: 30px; border-radius: 12px; border: 2px solid #d4af37; text-align: center;">
                    <h3 style="color: #8b7355; margin-bottom: 15px; font-size: 1.2em;">💛 Love your photos?</h3>
                    <p style="color: #8b7355; margin-bottom: 20px; font-size: 0.95em;">
                        If you're thrilled with your photos, you can leave a tip to show your appreciation<br>
                        <em>(totally optional and not expected!)</em>
                    </p>
                    <div class="tip-buttons" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="processTip('${sessionId}', 10)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$10</button>
                        <button onclick="processTip('${sessionId}', 25)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$25</button>
                        <button onclick="processTip('${sessionId}', 50)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$50</button>
                        <button onclick="customTipAmount('${sessionId}')" class="tip-btn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">Custom</button>
                    </div>
                    ${session.tipReceived ? `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; color: #28a745;">
                            <span style="font-size: 1.1em;">Celebration Thank you for your generous tip of $${session.tipAmount}!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function processTip(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                // For demo purposes, simulate Stripe checkout success
                // In production, this would integrate with actual Stripe checkout
                const confirmTip = confirm(`Process tip of $${amount}?\n\nThis will open Stripe checkout to process the payment.`);
                
                if (confirmTip) {
                    // Simulate successful tip processing
                    await updateTipStatus(sessionId, amount);
                    showMessage(`Thank you for your generous $${amount} tip! Celebration`, 'success');
                    // Tip received successfully
                    
                    // In production, this would be:
                    // window.location.href = await createStripeCheckoutSession(sessionId, amount);
                }
            } catch (error) {
                console.error('Error processing tip:', error);
                showMessage('Error processing tip', 'error');
            }
        }

        async function customTipAmount(sessionId) {
            const amount = prompt('Enter custom tip amount (numbers only):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                await processTip(sessionId, parseFloat(amount));
            } else if (amount !== null) {
                showMessage('Please enter a valid amount', 'error');
            }
        }

        async function updateTipStatus(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.tipReceived = true;
                session.tipAmount = amount;
                session.tipDate = new Date().toISOString();
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    window.renderSessions();
                } else {
                    showMessage('Error updating tip status', 'error');
                }
            } catch (error) {
                console.error('Error updating tip status:', error);
                showMessage('Error updating tip status', 'error');
            }
        }







        function viewPhoto(url) {
            window.open(url, '_blank');
        }
        window.formatDateTime = function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        window.formatDuration = function formatDuration(durationMinutes) {
            if (!durationMinutes || durationMinutes === 0) return 'Not specified';
            
            const minutes = parseInt(durationMinutes);
            
            if (minutes < 60) {
                return `${minutes} minutes`;
            } else if (minutes === 60) {
                return '1 hour';
            } else if (minutes % 60 === 0) {
                const hours = Math.floor(minutes / 60);
                return `${hours} hours`;
            } else {
                // Handle mixed hours and minutes (e.g., 90 minutes = 1h 30m)
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return `${hours}h ${remainingMinutes}m`;
            }
        }

        window.showMessage = function(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Admin-only button functions

        // Enhanced contract handling with error checking
        window.openContractModal = async function(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    showMessage('Session not found', 'error');
                    return;
                }
                
                showMessage('Loading contract templates...', 'info');
                
                // Check for contract templates - include auth token
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/api/contracts/templates', { headers });
                if (!response.ok) {
                    throw new Error('Contract templates not available');
                }
                
                const templates = await response.json();
                if (!templates || templates.length === 0) {
                    throw new Error('No contract templates found');
                }
                
                // Show contract modal with templates
                showMessage('Contract templates loaded', 'success');
                showContractSelectionModal(sessionId, session, templates);
                
            } catch (error) {
                console.error('Error loading contract:', error);
                showMessage('Contract templates not available: ' + error.message, 'error');
            }
        }

        // Contract Selection Modal
        function showContractSelectionModal(sessionId, session, templates) {
            const modalHTML = `
                <div id="contractSelectionModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0; font-size: 24px;">📄 Select Contract Template</h2>
                            <button onclick="closeModal('contractSelectionModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #d4af37;">
                            <p style="margin: 0; color: #8b7355; font-weight: 600;">Session: ${session.clientName}</p>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${session.sessionType} • ${formatDateTime(session.dateTime)}</p>
                        </div>
                        
                        <div class="contract-templates">
                            ${templates.map(template => `
                                <div class="template-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease;" onclick="selectContractTemplate('${sessionId}', '${template.type}', '${template.title}')">
                                    <h3 style="margin: 0 0 8px 0; color: #8b7355; font-size: 18px;">${template.title}</h3>
                                    <p style="margin: 0; color: #666; font-size: 14px; line-height: 1.4;">${template.description}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center;">
                            <button onclick="closeModal('contractSelectionModal')" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <style>
                    .template-option:hover {
                        border-color: #d4af37 !important;
                        background: #fdfcf8 !important;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Select and create contract
        window.selectContractTemplate = async function(sessionId, contractType, contractTitle) {
            try {
                showMessage(`Creating ${contractTitle}...`, 'info');
                closeModal('contractSelectionModal');
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ contractType })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Contract creation failed:', response.status, errorData);
                    throw new Error(`Failed to create contract: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                showMessage(`${contractTitle} created successfully!`, 'success');
                
                // Optionally refresh session data or show contract management
                console.log('Contract created:', result);
                
            } catch (error) {
                console.error('Error creating contract:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    sessionId: sessionId,
                    contractType: contractType
                });
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        // Generic modal close function
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // View session contracts
        window.viewSessionContracts = async function(sessionId) {
            try {
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to fetch contracts: ${response.status} - ${errorData}`);
                }
                
                const contracts = await response.json();
                displayContractsModal(sessionId, contracts);
                
            } catch (error) {
                console.error('Error fetching contracts:', error);
                showMessage('Failed to fetch contracts: ' + error.message, 'error');
            }
        }

        // Display contracts modal
        function displayContractsModal(sessionId, contracts) {
            const session = sessions.find(s => s.id === sessionId);
            const clientName = session ? session.clientName : 'Unknown Client';
            
            let contractsHTML = '';
            if (contracts.length === 0) {
                contractsHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No contracts found</h3>
                        <p>Create a new contract to get started.</p>
                    </div>
                `;
            } else {
                contractsHTML = contracts.map((contract, index) => `
                    <div class="contract-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #8b7355;">${contract.contract_title}</h4>
                            <span class="status-badge status-${contract.status}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                                ${contract.status}
                            </span>
                        </div>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">
                            Created: ${new Date(contract.created_at).toLocaleDateString()}
                        </p>
                        ${contract.signed_date ? `
                            <p style="margin: 5px 0; color: #28a745; font-size: 14px;">
                                <strong>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</strong>
                            </p>
                        ` : ''}
                        <div style="margin-top: 15px;">
                            <button onclick="viewContractDetails('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                View Details
                            </button>
                            <button onclick="editContract('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                Edit
                            </button>
                            ${contract.status === 'pending' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-secondary">
                                    Send to Client
                                </button>
                            ` : ''}
                            ${contract.status === 'sent' || contract.status === 'signed' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-success" style="margin-left: 10px;">
                                    📧 Resend Contract
                                </button>
                            ` : ''}
                            ${contract.status === 'signed' ? `
                                <button onclick="viewSignedCopy('${contract.id}')" class="btn btn-info" style="margin-left: 10px;">
                                    📄 View Signed Copy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const modalHTML = `
                <div id="contractsViewModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Contracts for ${clientName}</h2>
                            <button onclick="closeModal('contractsViewModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="contracts-list">
                            ${contractsHTML}
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
                            <button onclick="openContractModal('${sessionId}'); closeModal('contractsViewModal');" class="btn btn-primary">
                                Create New Contract
                            </button>
                            <button onclick="openCustomContractModal('${sessionId}'); closeModal('contractsViewModal');" class="btn btn-secondary" style="margin-left: 10px;">
                                Create Custom Contract
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    .status-pending { background: #ffc107; color: #000; }
                    .status-signed { background: #28a745; color: white; }
                    .status-sent { background: #17a2b8; color: white; }
                    .status-expired { background: #dc3545; color: white; }
                    
                    /* Home Base Setup Styles */
                    .mileage-header-actions {
                        display: flex;
                        gap: 10px;
                        align-items: center;
                    }

                    .setup-btn {
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }

                    .setup-btn:hover {
                        background: #5a6268;
                        transform: translateY(-1px);
                    }

                    .home-base-setup {
                        margin: 20px 0;
                        padding: 0;
                    }

                    .setup-card {
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 20px;
                    }

                    .setup-card h3 {
                        color: #495057;
                        margin-bottom: 10px;
                        font-size: 18px;
                    }

                    .setup-card p {
                        color: #6c757d;
                        margin-bottom: 20px;
                    }

                    /* Round Trip Toggle Styles */
                    .form-group label {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-weight: 500;
                        color: #495057;
                        margin-bottom: 10px;
                    }
                    
                    .form-group input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        accent-color: #d4af37;
                        cursor: pointer;
                    }
                    
                    .calculate-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.2s;
                        margin-left: 10px;
                    }
                    
                    .calculate-btn:hover {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    /* Report Breakdown Styles */
                    .report-breakdown {
                        margin-top: 30px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 20px;
                    }

                    .report-breakdown h4 {
                        color: #495057;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #d4af37;
                        padding-bottom: 10px;
                    }

                    .breakdown-section {
                        margin-bottom: 25px;
                    }

                    .breakdown-section h5 {
                        color: #6c757d;
                        margin-bottom: 15px;
                        font-size: 16px;
                    }

                    .breakdown-item {
                        display: grid;
                        grid-template-columns: 1fr 2fr 1fr;
                        gap: 15px;
                        padding: 10px;
                        background: white;
                        border-radius: 5px;
                        margin-bottom: 8px;
                        border-left: 3px solid #d4af37;
                    }

                    .breakdown-item .amount {
                        text-align: right;
                        font-weight: 600;
                        color: #28a745;
                    }

                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 20px;
                    }

                    .summary-item {
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        border-left: 4px solid #d4af37;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .summary-item label {
                        font-weight: 600;
                        color: #495057;
                        display: block;
                        margin-bottom: 5px;
                    }

                    .summary-item span {
                        font-size: 18px;
                        font-weight: 700;
                        color: #28a745;
                    }

                    /* Dashboard Export Controls */
                    .dashboard-controls {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 15px;
                    }

                    .dashboard-export-buttons {
                        display: flex;
                        gap: 10px;
                    }

                    .export-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.2s;
                    }

                    .export-btn:hover {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    @media (max-width: 768px) {
                        .dashboard-controls {
                            flex-direction: column;
                            align-items: stretch;
                        }
                        
                        .dashboard-export-buttons {
                            justify-content: center;
                        }
                    }

                    .location-setup {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }

                    .location-actions {
                        display: flex;
                        gap: 10px;
                        flex-wrap: wrap;
                    }

                    .location-btn {
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }

                    .location-btn:hover {
                        background: #138496;
                        transform: translateY(-1px);
                    }

                    .status-card {
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        border-radius: 5px;
                        padding: 15px;
                        margin-top: 15px;
                    }

                    .status-card h4 {
                        color: #155724;
                        margin-bottom: 8px;
                        font-size: 16px;
                    }

                    .status-card p {
                        color: #155724;
                        margin-bottom: 10px;
                        font-weight: 500;
                    }

                    .edit-btn {
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 500;
                    }

                    .edit-btn:hover {
                        background: #e0a800;
                    }

                    .location-input-group {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    }

                    .location-input-group input {
                        flex: 1;
                    }

                    .home-base-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        white-space: nowrap;
                        transition: all 0.2s;
                    }

                    .home-base-btn:hover:not(:disabled) {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    .home-base-btn:disabled {
                        background: #6c757d;
                        cursor: not-allowed;
                        opacity: 0.6;
                    }

                    /* Address Autocomplete Styles */
                    .autocomplete-container {
                        position: relative;
                        flex: 1;
                    }

                    .address-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        border: 1px solid #ddd;
                        border-top: none;
                        border-radius: 0 0 5px 5px;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    }

                    .address-suggestion {
                        padding: 10px 15px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                        transition: background-color 0.2s;
                    }

                    .address-suggestion:hover {
                        background-color: #f8f9fa;
                    }

                    .address-suggestion:last-child {
                        border-bottom: none;
                    }

                    .address-suggestion.selected {
                        background-color: #e3f2fd;
                    }

                    .suggestion-main {
                        font-weight: 500;
                        color: #333;
                    }

                    .suggestion-detail {
                        font-size: 12px;
                        color: #666;
                        margin-top: 2px;
                    }

                    @media (max-width: 768px) {
                        .mileage-header-actions {
                            flex-direction: column;
                            gap: 8px;
                        }

                        .location-actions {
                            flex-direction: column;
                        }

                        .location-input-group {
                            flex-direction: column;
                            align-items: stretch;
                        }

                        .location-input-group input {
                            margin-bottom: 8px;
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // View contract details
        window.viewContractDetails = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch contract details');
                }
                
                const contract = await response.json();
                showContractDetailsModal(contract);
                
            } catch (error) {
                console.error('Error fetching contract details:', error);
                showMessage('Failed to fetch contract details: ' + error.message, 'error');
            }
        }

        // Show contract details modal
        function showContractDetailsModal(contract) {
            const modalHTML = `
                <div id="contractDetailsModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 900px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">${contract.contract_title}</h2>
                            <button onclick="closeModal('contractDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="contract-info" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div><strong>Status:</strong> <span class="status-badge status-${contract.status}">${contract.status.toUpperCase()}</span></div>
                                <div><strong>Created:</strong> ${new Date(contract.created_at).toLocaleDateString()}</div>
                                <div><strong>Client:</strong> ${contract.client_name}</div>
                                <div><strong>Email:</strong> ${contract.client_email}</div>
                                ${contract.signed_date ? `<div><strong>Signed:</strong> ${new Date(contract.signed_date).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="contract-content" style="background: white; border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin-bottom: 20px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${contract.contract_content}
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="editContract('${contract.id}'); closeModal('contractDetailsModal');" class="btn btn-primary" style="margin-right: 10px;">
                                Edit Contract
                            </button>
                            <button onclick="downloadContractPDF('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                Download PDF
                            </button>
                            ${contract.status === 'pending' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-secondary">
                                    Send to Client
                                </button>
                            ` : ''}
                            ${contract.status === 'sent' || contract.status === 'signed' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-success">
                                    📧 Resend Contract
                                </button>
                            ` : ''}
                            ${contract.status === 'signed' ? `
                                <button onclick="viewSignedCopy('${contract.id}')" class="btn btn-info" style="margin-left: 10px;">
                                    📄 View Signed Copy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Edit contract
        window.editContract = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch contract for editing');
                }
                
                const contract = await response.json();
                showContractEditModal(contract);
                
            } catch (error) {
                console.error('Error fetching contract for editing:', error);
                showMessage('Failed to load contract for editing: ' + error.message, 'error');
            }
        }

        // Show contract edit modal
        function showContractEditModal(contract) {
            const modalHTML = `
                <div id="contractEditModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 1000px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Edit Contract: ${contract.contract_title}</h2>
                            <button onclick="closeModal('contractEditModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="contractEditForm">
                            <div style="margin-bottom: 20px;">
                                <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Title:</label>
                                <input type="text" id="contractTitle" name="title" value="${contract.contract_title}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Content:</label>
                                <textarea id="contractContent" name="content" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace;">${contract.contract_content}</textarea>
                            </div>
                            
                            <div style="text-align: center;">
                                <button type="button" onclick="saveContractChanges('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                    Save Changes
                                </button>
                                <button type="button" onclick="closeModal('contractEditModal')" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Save contract changes
        window.saveContractChanges = async function(contractId) {
            try {
                const title = document.getElementById('contractTitle').value;
                const content = document.getElementById('contractContent').value;
                
                if (!title.trim() || !content.trim()) {
                    showMessage('Please fill in both title and content', 'error');
                    return;
                }
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to save contract: ${response.status} - ${errorData}`);
                }
                
                showMessage('Contract updated successfully!', 'success');
                closeModal('contractEditModal');
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save contract: ' + error.message, 'error');
            }
        }

        // Open custom contract modal
        window.openCustomContractModal = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showMessage('Session not found', 'error');
                return;
            }
            
            const modalHTML = `
                <div id="customContractModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 1000px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Create Custom Contract for ${session.clientName}</h2>
                            <button onclick="closeModal('customContractModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="customContractForm">
                            <div style="margin-bottom: 20px;">
                                <label for="customContractTitle" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Title:</label>
                                <input type="text" id="customContractTitle" name="title" placeholder="e.g., Custom Photography Agreement" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="customContractContent" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Content:</label>
                                <div style="margin-bottom: 10px; color: #666; font-size: 14px;">
                                    <strong>Available variables:</strong> {{client_name}}, {{client_email}}, {{photographer_name}}, {{photographer_email}}, {{session_type}}, {{session_date}}, {{location}}, {{price}}, {{duration}}
                                </div>
                                <textarea id="customContractContent" name="content" rows="20" placeholder="Enter your custom contract content here..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace;"></textarea>
                            </div>
                            
                            <div style="text-align: center;">
                                <button type="button" onclick="createCustomContract('${sessionId}')" class="btn btn-primary" style="margin-right: 10px;">
                                    Create Contract
                                </button>
                                <button type="button" onclick="closeModal('customContractModal')" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Create custom contract
        window.createCustomContract = async function(sessionId) {
            try {
                const title = document.getElementById('customContractTitle').value;
                const content = document.getElementById('customContractContent').value;
                
                if (!title.trim() || !content.trim()) {
                    showMessage('Please fill in both title and content', 'error');
                    return;
                }
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts/custom`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to create custom contract: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                showMessage('Custom contract created successfully!', 'success');
                closeModal('customContractModal');
                
            } catch (error) {
                console.error('Error creating custom contract:', error);
                showMessage('Failed to create custom contract: ' + error.message, 'error');
            }
        }

        // Clean new update session functionality
        window.openUpdateSessionModal = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showMessage('Session not found', 'error');
                return;
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="updateSessionModal" class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Update Session</h2>
                            <button onclick="closeUpdateSessionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="updateSessionForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label for="updateClientName">Client Name</label>
                                    <input type="text" id="updateClientName" name="clientName" value="${session.clientName || ''}" required>
                                </div>
                                <div>
                                    <label for="updateSessionType">Session Type</label>
                                    <input type="text" id="updateSessionType" name="sessionType" value="${session.sessionType || ''}" required>
                                </div>
                                <div>
                                    <label for="updateDateTime">Date & Time</label>
                                    <input type="datetime-local" id="updateDateTime" name="dateTime" value="${session.dateTime ? new Date(session.dateTime).toISOString().slice(0, 16) : ''}" required>
                                </div>
                                <div>
                                    <label for="updateLocation">Location</label>
                                    <input type="text" id="updateLocation" name="location" value="${session.location || ''}" required>
                                </div>
                                <div>
                                    <label for="updatePhoneNumber">Phone</label>
                                    <input type="tel" id="updatePhoneNumber" name="phoneNumber" value="${session.phoneNumber || ''}" required>
                                </div>
                                <div>
                                    <label for="updateEmail">Email</label>
                                    <input type="email" id="updateEmail" name="email" value="${session.email || ''}" required>
                                </div>
                                <div>
                                    <label for="updatePrice">Price</label>
                                    <input type="number" id="updatePrice" name="price" step="0.01" value="${session.price || ''}" required>
                                </div>
                                <div>
                                    <label for="updateDuration">Duration (minutes)</label>
                                    <input type="number" id="updateDuration" name="duration" value="${session.duration || ''}" required>
                                </div>
                            </div>
                            
                            <div>
                                <label for="updateNotes">Notes</label>
                                <textarea id="updateNotes" name="notes" style="width: 100%; height: 80px; margin-bottom: 15px;">${session.notes || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <label><input type="checkbox" name="contractSigned" ${session.contractSigned ? 'checked' : ''}> Contract Signed</label>
                                <label><input type="checkbox" name="paid" ${session.paid ? 'checked' : ''}> Paid</label>
                                <label><input type="checkbox" name="edited" ${session.edited ? 'checked' : ''}> Edited</label>
                                <label><input type="checkbox" name="delivered" ${session.delivered ? 'checked' : ''}> Delivered</label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeUpdateSessionModal()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Update Session</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add form submit handler
            document.getElementById('updateSessionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateSession(sessionId, this);
            });
        }
        
        window.closeUpdateSessionModal = function() {
            const modal = document.getElementById('updateSessionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        window.updateSession = async function(sessionId, form) {
            const formData = new FormData(form);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                notes: formData.get('notes'),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on'
            };
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    const updatedSession = await response.json();
                    const sessionIndex = sessions.findIndex(s => s.id === sessionId);
                    if (sessionIndex !== -1) {
                        sessions[sessionIndex] = updatedSession;
                    }
                    window.renderSessions();
                    closeUpdateSessionModal();
                    showMessage('Session updated successfully!', 'success');
                } else {
                    showMessage('Failed to update session', 'error');
                }
            } catch (error) {
                console.error('Error updating session:', error);
                showMessage('Error updating session', 'error');
            }
        }





        // Open email client with session details  
        window.openEmailClient = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const subject = `Photography Session - ${session.sessionType} with ${session.clientName}`;
            const body = `Hi ${session.clientName},

I hope this email finds you well! I'm writing regarding your upcoming ${session.sessionType} photography session.

Session Details:
Date: ${new Date(session.dateTime).toLocaleDateString()}
Time: ${new Date(session.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
Location: ${session.location}
Investment: $${session.price}
Contact: ${session.phoneNumber}

I'm excited to capture these special moments for you! If you have any questions or need to make any changes, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }

        window.addToCalendar = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // For iPhone, use the server endpoint
            if (/iPhone|iPad/.test(navigator.userAgent)) {
                window.location.href = `/api/sessions/${sessionId}/calendar.ics`;
                showMessage('Opening iPhone Calendar...', 'success');
                return;
            }
            
            const startDate = new Date(session.dateTime);
            const endDate = new Date(startDate.getTime() + (session.duration * 60000));
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Photography Scheduler//EN
BEGIN:VEVENT
UID:${session.id}@photographyschedule.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Photography Session - ${session.clientName}
DESCRIPTION:Session Type: ${session.sessionType}\\nLocation: ${session.location}\\nClient: ${session.clientName}\\nPhone: ${session.phoneNumber}\\nEmail: ${session.email}\\nPrice: $${session.price}
LOCATION:${session.location}
END:VEVENT
END:VCALENDAR`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${session.clientName.replace(/\s+/g, '_')}_photography_session.ics`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Calendar event downloaded!', 'success');
        }

        // Invoice modal functionality
        window.openInvoiceModal = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showMessage('Session not found', 'error');
                return;
            }

            const existingDeposit = session.depositAmount || 0;
            const remainingBalance = session.price - existingDeposit;
            
            console.log('DEBUG FRONTEND CALCULATION:', {
                sessionPrice: session.price,
                sessionDepositAmount: session.depositAmount,
                existingDeposit: existingDeposit,
                calculatedRemainingBalance: remainingBalance
            });
            
            // Create modal HTML with centered overlay design
            const modalHTML = `
                <div class="invoice-card-overlay" id="invoiceModal" onclick="closeInvoiceModal()">
                    <div class="invoice-card-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Send Invoice - ${session.clientName}</h3>
                            <span class="modal-close" onclick="closeInvoiceModal()">&times;</span>
                        </div>
                        <div class="modal-content">
                            <div class="session-payment-summary">
                                <h4>Payment Summary</h4>
                                <div class="payment-row">
                                    <span>Session Total:</span>
                                    <span style="font-weight: 600;">$${session.price.toFixed(2)}</span>
                                </div>
                                ${existingDeposit > 0 ? `
                                    <div class="payment-row" style="color: #28a745;">
                                        <span>Deposit Paid:</span>
                                        <span style="font-weight: 600;">-$${existingDeposit.toFixed(2)}</span>
                                    </div>
                                    <hr style="margin: 10px 0;">
                                    <div class="payment-row" style="font-size: 1.1em; font-weight: 600; color: #d4af37;">
                                        <span>Remaining Balance:</span>
                                        <span>$${remainingBalance.toFixed(2)}</span>
                                    </div>
                                ` : `
                                    <div class="payment-row" style="font-size: 1.1em; font-weight: 600; color: #d4af37;">
                                        <span>Invoice Amount:</span>
                                        <span>$${session.price.toFixed(2)}</span>
                                    </div>
                                `}
                            </div>
                            
                            <div class="invoice-options">
                                <h4>Invoice Type</h4>
                                <div class="radio-group">
                                    ${remainingBalance > 0 ? `
                                        <label class="radio-option">
                                            <input type="radio" name="invoiceType" value="remaining" checked>
                                            <span class="radio-text">
                                                <strong>Final Payment</strong><br>
                                                <small>Invoice for remaining balance: $${remainingBalance.toFixed(2)}</small>
                                            </span>
                                        </label>
                                    ` : ''}
                                    <label class="radio-option">
                                        <input type="radio" name="invoiceType" value="deposit" ${remainingBalance <= 0 ? 'checked' : ''}>
                                        <span class="radio-text">
                                            <strong>Deposit Invoice</strong><br>
                                            <small>Custom deposit amount</small>
                                        </span>
                                    </label>
                                </div>
                                
                                <div id="depositAmountSection" style="margin-top: 15px; display: none;">
                                    <label for="depositAmount">Deposit Amount:</label>
                                    <input type="number" id="depositAmount" min="1" max="${session.price}" step="0.01" 
                                           placeholder="Enter deposit amount" style="width: 100%; margin-top: 5px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmSendInvoice('${sessionId}')">Send Invoice</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const radioButtons = document.querySelectorAll('input[name="invoiceType"]');
            const depositSection = document.getElementById('depositAmountSection');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    depositSection.style.display = this.value === 'deposit' ? 'block' : 'none';
                });
            });
        }

        window.closeInvoiceModal = function() {
            const modal = document.getElementById('invoiceModal');
            if (modal) {
                modal.remove();
            }
        }

        window.confirmSendInvoice = async function(sessionId) {
            const invoiceType = document.querySelector('input[name="invoiceType"]:checked').value;
            const session = sessions.find(s => s.id === sessionId);
            
            let requestData = {};
            let confirmMessage = '';
            
            if (invoiceType === 'deposit') {
                const depositAmountInput = document.getElementById('depositAmount');
                const depositAmount = parseFloat(depositAmountInput.value);
                
                if (!depositAmount || depositAmount <= 0) {
                    showMessage('Please enter a valid deposit amount', 'error');
                    return;
                }
                
                requestData = {
                    isDeposit: true,
                    depositAmount: depositAmount
                };
                confirmMessage = `Send deposit invoice for $${depositAmount.toFixed(2)} to ${session.clientName}?`;
            } else {
                const existingDeposit = session.depositAmount || 0;
                const finalAmount = session.price - existingDeposit;
                confirmMessage = `Send final payment invoice for $${finalAmount.toFixed(2)} to ${session.clientName}?`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                closeInvoiceModal();
                showMessage('Sending invoice...', 'info');
                
                const response = await fetch(`/api/sessions/${sessionId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to send invoice');
                }
                
                const result = await response.json();
                
                if (result.fallbackMode) {
                    showMessage('Invoice simulation completed', 'info');
                    alert(`Invoice Simulation\\n\\nClient: ${result.clientName}\\nAmount: $${result.amount}\\n\\n${result.details}`);
                } else {
                    showMessage('Invoice sent successfully!', 'success');
                    
                    // Show success confirmation with payment details
                    const invoiceAmount = result.invoice.amount;
                    const depositInfo = result.depositInfo;
                    let confirmationMessage = `Invoice sent to ${session.clientName}!\\n\\nAmount: $${invoiceAmount}`;
                    
                    if (depositInfo) {
                        confirmationMessage += `\\nDeposit: $${depositInfo.depositAmount}\\nRemaining: $${depositInfo.remainingBalance}`;
                    }
                    
                    confirmationMessage += '\\n\\nClick OK to view the invoice on Stripe.';
                    
                    if (confirm(confirmationMessage) && result.invoice.hostedInvoiceUrl) {
                        window.open(result.invoice.hostedInvoiceUrl, '_blank');
                    }
                    
                    // Refresh sessions to show updated deposit amounts
                    await loadSessions();
                }
                
            } catch (error) {
                console.error('Error sending invoice:', error);
                showMessage(`Failed to send invoice: ${error.message}`, 'error');
            }
        }

        function callClient(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function textClient(phoneNumber, clientName, sessionId) {
            const message = `Hi ${clientName}, thanks for booking your photography session! We'll be in touch soon with details.`;
            window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
        }


    </script>

    <!-- Confetti Container for Milestone Celebrations -->
    <div id="confettiContainer" class="confetti-container"></div>

    <script>
        // Confetti Animation System for Milestone Celebrations
        function createConfetti(x, y, count = 50) {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                
                // Random positioning and styling
                const startX = x || Math.random() * window.innerWidth;
                const startY = y || -20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 8 + 6;
                const duration = Math.random() * 2 + 2;
                
                confetti.style.left = startX + 'px';
                confetti.style.top = startY + 'px';
                confetti.style.backgroundColor = color;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                confetti.style.animationDuration = duration + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                
                container.appendChild(confetti);
                
                // Clean up after animation
                setTimeout(() => {
                    if (confetti && confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, (duration + 0.5) * 1000);
            }
        }
        
        function showMilestoneToast(message, emoji = 'Celebration') {
            const toast = document.createElement('div');
            toast.className = 'milestone-toast';
            toast.innerHTML = `${emoji} ${message}`;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }
        
        // Milestone celebration system removed per user request














        
















        window.openPhotoLightbox = function(filename, sessionId = null) {
            // Create lightbox overlay
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                text-align: center;
            `;
            content.onclick = (e) => e.stopPropagation();
            
            const img = document.createElement('img');
            // Use R2 preview if sessionId provided, otherwise legacy uploads
            img.src = sessionId ? `/api/r2/preview/${sessionId}/${filename}` : `/uploads/${filename}`;
            img.style.cssText = `
                max-width: 100%;
                max-height: 85vh;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            `;
            
            const filenameDiv = document.createElement('div');
            filenameDiv.textContent = filename;
            filenameDiv.style.cssText = `
                color: white;
                margin-top: 20px;
                font-size: 16px;
                opacity: 0.9;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 15px;
                background: #d4af37;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            `;
            closeBtn.onclick = () => document.body.removeChild(lightbox);
            
            content.appendChild(img);
            content.appendChild(filenameDiv);
            content.appendChild(closeBtn);
            lightbox.appendChild(content);
            document.body.appendChild(lightbox);
            
            // Close on click outside
            lightbox.addEventListener('click', () => {
                document.body.removeChild(lightbox);
            });
            
            // Close on escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(lightbox);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Payment Plan Functions - Updated to work with session object
        
        function closePaymentPlanModal() {
            document.getElementById('paymentPlanModal').classList.remove('active');
            document.getElementById('paymentPlanSummary').style.display = 'none';
            currentPaymentPlanSessionId = null;
        }
        
        function calculatePaymentPreview() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = new Date(document.getElementById('planEndDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate months between dates
            const monthsDiff = Math.max(1, (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()));
            const monthlyPayment = (totalAmount / monthsDiff).toFixed(2);
            
            // Show summary
            const summaryElement = document.getElementById('paymentPlanSummary');
            const detailsElement = document.getElementById('paymentSummaryDetails');
            const scheduleElement = document.getElementById('paymentSchedulePreview');
            
            detailsElement.innerHTML = `
                <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                <p><strong>Number of Payments:</strong> ${monthsDiff}</p>
                <p><strong>Monthly Payment:</strong> $${monthlyPayment}</p>
                <p><strong>Period:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
            `;
            
            // Generate payment schedule preview
            let scheduleHTML = '<h5>Payment Schedule:</h5>';
            for (let i = 0; i < Math.min(monthsDiff, 6); i++) { // Show first 6 payments
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);
                
                scheduleHTML += `
                    <div class="payment-item">
                        <div>
                            <strong>Payment ${i + 1}</strong><br>
                            <small>${paymentDate.toLocaleDateString()}</small>
                        </div>
                        <div>$${monthlyPayment}</div>
                        <div class="payment-status pending">Pending</div>
                    </div>
                `;
            }
            
            if (monthsDiff > 6) {
                scheduleHTML += `<p><small>... and ${monthsDiff - 6} more payments</small></p>`;
            }
            
            scheduleElement.innerHTML = scheduleHTML;
            summaryElement.style.display = 'block';
        }
        
        // Duplicate function removed - using window.createPaymentPlan definition above
        
        window.viewPaymentPlan = async function(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/payment-plan`);
                
                if (!response.ok) {
                    throw new Error('Payment plan not found');
                }
                
                const paymentPlan = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                // Update modal title
                document.getElementById('paymentPlanViewTitle').textContent = `Payment Plan - ${session?.clientName || 'Client'}`;
                
                // Generate payment plan view
                let contentHTML = `
                    <div class="payment-plan-summary">
                        <h4>📋 Plan Overview</h4>
                        <p><strong>Total Amount:</strong> $${parseFloat(paymentPlan.totalAmount).toFixed(2)}</p>
                        <p><strong>Monthly Payment:</strong> $${parseFloat(paymentPlan.monthlyPayment).toFixed(2)}</p>
                        <p><strong>Payments Completed:</strong> ${paymentPlan.paymentsCompleted} of ${paymentPlan.totalPayments}</p>
                        <p><strong>Amount Paid:</strong> $${parseFloat(paymentPlan.amountPaid).toFixed(2)}</p>
                        <p><strong>Remaining Balance:</strong> $${parseFloat(paymentPlan.remainingBalance).toFixed(2)}</p>
                        <p><strong>Status:</strong> <span class="payment-status ${paymentPlan.status}">${paymentPlan.status.toUpperCase()}</span></p>
                    </div>
                    
                    <div class="payment-schedule">
                        <h4>Payment Schedule</h4>
                `;
                
                for (const payment of paymentPlan.payments) {
                    const dueDate = new Date(payment.dueDate);
                    const isOverdue = dueDate < new Date() && payment.status === 'pending';
                    const statusClass = isOverdue ? 'overdue' : payment.status;
                    
                    contentHTML += `
                        <div class="payment-item">
                            <div>
                                <strong>Payment ${payment.paymentNumber}</strong><br>
                                <small>Due: ${dueDate.toLocaleDateString()}</small>
                                ${payment.paidDate ? `<br><small>Paid: ${new Date(payment.paidDate).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div>$${parseFloat(payment.amount).toFixed(2)}</div>
                            <div>
                                <div class="payment-status ${statusClass}">${payment.status.toUpperCase()}</div>
                                ${payment.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markPaymentPaid('${payment.id}')" style="margin-top: 5px;">Mark Paid</button>
                                    <button class="btn btn-sm" onclick="sendPaymentInvoice('${payment.id}')" style="margin-top: 5px;">Send Invoice</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += '</div>';
                
                document.getElementById('paymentPlanViewContent').innerHTML = contentHTML;
                document.getElementById('paymentPlanViewModal').classList.add('active');
                
            } catch (error) {
                console.error('Error viewing payment plan:', error);
                showMessage('Failed to load payment plan: ' + error.message, 'error');
            }
        }
        
        function closePaymentPlanViewModal() {
            document.getElementById('paymentPlanViewModal').classList.remove('active');
        }
        
        async function markPaymentPaid(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentMethod: 'manual',
                        notes: 'Marked as paid by admin'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to mark payment as paid');
                }
                
                showMessage('Payment marked as paid!', 'success');
                loadSessions(); // Refresh session data
                // Re-open the payment plan view to show updated status
                setTimeout(() => {
                    if (currentPaymentPlanSessionId) {
                        viewPaymentPlan(currentPaymentPlanSessionId);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error marking payment paid:', error);
                showMessage('Failed to mark payment as paid: ' + error.message, 'error');
            }
        }
        
        async function sendPaymentInvoice(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send invoice');
                }
                
                showMessage('Payment invoice sent successfully!', 'success');
                // Invoice sent successfully
                
            } catch (error) {
                console.error('Error sending payment invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }
        
        async function processAutomatedPayments() {
            try {
                const response = await fetch('/api/payments/process-automated', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process payments');
                }
                
                const result = await response.json();
                
                showMessage(`Processing complete! ${result.results.invoicesSent} invoices sent, ${result.results.remindersSent} reminders sent`, 'success');
                
                // Refresh data
                loadSessions();
                
            } catch (error) {
                console.error('Error processing automated payments:', error);
                showMessage('Failed to process payments: ' + error.message, 'error');
            }
        }

        // Contract functions moved to top of script to prevent reference errors

        // Show modal with email/messaging options
        function showContractSendOptions(contractData) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.id = 'contractSendModal';

            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Contract</h5>
                            <button type="button" class="close" onclick="closeContractSendModal()">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="contract-send-info">
                                <p><strong>Contract:</strong> ${contractData.contract.contract_title}</p>
                                <p><strong>Client:</strong> ${contractData.contract.client_name}</p>
                                <p><strong>Email:</strong> ${contractData.contract.client_email}</p>
                                <p><strong>Signing URL:</strong></p>
                                <div class="signing-url-container">
                                    <input type="text" id="signingUrlCopy" value="${contractData.signingUrl}" readonly class="form-control" style="font-size: 12px;">
                                    <button class="btn btn-sm btn-secondary mt-2" onclick="copySigningUrl()">Copy URL</button>
                                </div>
                            </div>

                            <div class="send-options mt-4">
                                <h6>Choose how to send:</h6>
                                
                                <button class="btn btn-primary btn-block mb-3" onclick="openEmailClient('${contractData.contract.client_email}', '${encodeURIComponent(contractData.emailData.subject)}', '${encodeURIComponent(contractData.emailData.body)}')">
                                    📧 Open Email App
                                </button>
                                
                                <button class="btn btn-success btn-block mb-3" onclick="openMessagingApp('${contractData.signingUrl}', '${contractData.contract.client_name}')">
                                    💬 Open Messaging App
                                </button>

                                <div class="manual-options mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                    <h6>Or copy and send manually:</h6>
                                    <div class="form-group">
                                        <label>Email Subject:</label>
                                        <input type="text" value="${contractData.emailData.subject}" readonly class="form-control form-control-sm">
                                    </div>
                                    <div class="form-group">
                                        <label>Email Message:</label>
                                        <textarea readonly class="form-control form-control-sm" rows="8">${contractData.emailData.body}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeContractSendModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            showMessage('Contract prepared successfully! Choose your preferred sending method.', 'success');
        }

        // Open default email client
        function openEmailClient(email, subject, body) {
            const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
            closeContractSendModal();
            showMessage('Opening your email app...', 'info');
        }

        // Open messaging app (SMS)
        function openMessagingApp(signingUrl, clientName) {
            const message = `Hi ${clientName}! Your photography contract is ready for signature. Please review and sign here: ${signingUrl}`;
            const smsLink = `sms:?body=${encodeURIComponent(message)}`;
            window.location.href = smsLink;
            closeContractSendModal();
            showMessage('Opening your messaging app...', 'info');
        }

        // Copy signing URL to clipboard
        function copySigningUrl() {
            const urlInput = document.getElementById('signingUrlCopy');
            urlInput.select();
            document.execCommand('copy');
            showMessage('Signing URL copied to clipboard!', 'success');
        }

        // Close contract send modal
        function closeContractSendModal() {
            const modal = document.getElementById('contractSendModal');
            if (modal) {
                modal.remove();
            }
        }

        // Helper function to close modal by ID
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Save contract changes
        window.saveContractChanges = async function(contractId) {
            try {
                const title = document.getElementById('contractTitle').value;
                const content = document.getElementById('contractContent').value;
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }
                
                showMessage('Saving changes...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to update contract');
                }
                
                showMessage('Contract updated successfully!', 'success');
                closeModal('contractEditModal');
                
                // Refresh the contracts view if it's open
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract changes:', error);
                showMessage(`Failed to save changes: ${error.message}`, 'error');
            }
        }

        // Download contract PDF (placeholder for now)
        function downloadContractPDF(contractId) {
            showMessage('PDF download feature coming soon!', 'info');
        }

        // Contract Management Functions
        let currentContractSessionId = null;







        // Helper function to format file sizes (duplicate removed)







        window.openContractModal = async function(sessionId) {
            currentContractSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Load existing contracts for this session
            await loadExistingContracts(sessionId);
            
            const modal = document.getElementById('contractModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            currentContractSessionId = null;
        }

        async function loadExistingContracts(sessionId) {
            // Validate sessionId before making API call
            if (!sessionId) {
                console.warn('loadExistingContracts called without valid sessionId');
                return;
            }
            
            try {
                const authToken = await getAuthToken();
                const headers = {};
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, { headers });
                if (!response.ok) {
                    throw new Error('Failed to load contracts');
                }

                const contracts = await response.json();
                const existingContractsDiv = document.getElementById('existingContractsList');
                
                if (!existingContractsDiv) {
                    console.warn('existingContractsList element not found in DOM');
                    return;
                }
                
                if (contracts.length === 0) {
                    existingContractsDiv.innerHTML = '';
                    return;
                }

                existingContractsDiv.innerHTML = `
                    <h4>Existing Contracts:</h4>
                    <div class="existing-contracts-list">
                        ${contracts.map(contract => `
                            <div class="contract-item ${contract.status}">
                                <div class="contract-item-info">
                                    <h5>${contract.contract_title}</h5>
                                    <p>Status: ${contract.status.charAt(0).toUpperCase() + contract.status.slice(1)}</p>
                                    <p>Created: ${new Date(contract.created_at).toLocaleDateString()}</p>
                                    ${contract.signed_date ? `<p>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="contract-item-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editContract('${contract.id}')">
                                         Edit
                                    </button>
                                    ${contract.status === 'pending' ? `
                                        <button class="btn btn-primary btn-sm" onclick="sendContract('${contract.id}')">
                                            Send Contract
                                        </button>
                                    ` : contract.status === 'sent' ? `
                                        <span class="contract-status-badge sent">Sent</span>
                                    ` : contract.status === 'signed' ? `
                                        <span class="contract-status-badge signed">Signed</span>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading contracts:', error);
                showMessage('Failed to load existing contracts', 'error');
            }
        }

        async function createContract(sessionId, contractType) {
            try {
                showMessage('Creating contract...', 'info');
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractType: contractType
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create contract');
                }

                const result = await response.json();
                
                showMessage('Contract created successfully!', 'success');
                
                // Reload the existing contracts to show the new one
                await loadExistingContracts(sessionId);
                
                // Trigger milestone celebration
                // Contract signed successfully
                
            } catch (error) {
                console.error('Error creating contract:', error);
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        async function sendContract(contractId) {
            try {
                showMessage('Preparing contract email...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to prepare contract email');
                }

                const result = await response.json();
                
                // Get email data from server response
                const emailData = result.emailData;
                if (!emailData) {
                    throw new Error('Email template not available');
                }
                
                // Create mailto link with pre-filled email
                const mailtoLink = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                showMessage('Email client opened! Review and send the contract email.', 'success');
                
                // Show the signing URL for reference
                alert(`Email client opened with contract details!\n\nSigning URL: ${result.signingUrl}\n\nPlease review the email and send it to your client.`);
                
                // Reload existing contracts to update status (only if we have a valid session ID)
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error preparing contract email:', error);
                showMessage('Failed to prepare contract email: ' + error.message, 'error');
            }
        }

        // Contract Edit Functions
        let currentEditContractId = null;

        async function editContract(contractId) {
            try {
                currentEditContractId = contractId;
                
                // Fetch contract details
                const response = await fetch(`/api/contracts/${contractId}`, {
                    headers: {
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load contract details');
                }

                const contract = await response.json();
                
                // Populate edit form
                document.getElementById('contractTitle').value = contract.contract_title;
                document.getElementById('contractContent').value = contract.contract_content;
                
                // Show edit modal
                const editModal = document.getElementById('contractEditModal');
                editModal.style.display = 'flex';
                editModal.style.alignItems = 'center';
                editModal.style.justifyContent = 'center';
                
            } catch (error) {
                console.error('Error loading contract for edit:', error);
                showMessage('Failed to load contract: ' + error.message, 'error');
            }
        }

        function closeContractEditModal() {
            document.getElementById('contractEditModal').style.display = 'none';
            currentEditContractId = null;
        }

        async function saveContractChanges(event) {
            event.preventDefault();
            
            if (!currentEditContractId) {
                showMessage('No contract selected for editing', 'error');
                return;
            }

            try {
                showMessage('Saving contract changes...', 'info');
                
                const title = document.getElementById('contractTitle').value.trim();
                const content = document.getElementById('contractContent').value.trim();
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }

                const response = await fetch(`/api/contracts/${currentEditContractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save contract changes');
                }

                showMessage('Contract updated successfully!', 'success');
                closeContractEditModal();
                
                // Reload existing contracts to show the updated version
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save changes: ' + error.message, 'error');
            }
        }



        // Get authentication token helper function
        async function getAuthToken() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    return 'authenticated'; // Simplified token for authenticated requests
                }
                return null;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }

        // Tab switching functionality
        window.switchTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Close mobile menu when a tab is selected
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Activated tab:', tabName + 'Tab');
            } else {
                console.error('Tab not found:', tabName + 'Tab');
            }
            
            // Set active nav link
            const activeLink = document.querySelector(`.nav-link[onclick*="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                console.log('Set active nav link for:', tabName);
            }
            
            // Initialize specific tabs when switching
            if (tabName === 'goldenHour') {
                // Set default date to today if not already set
                const dateInput = document.getElementById('dateInput');
                if (dateInput && !dateInput.value) {
                    const today = new Date();
                    dateInput.value = today.toISOString().split('T')[0];
                }
            } else if (tabName === 'businessManagement') {
                // Initialize Business Management when tab is first opened
                initializeBusinessManagement();
            }
        }

        // Business Management Functions
        function initializeBusinessManagement() {
            updateDashboard();
            loadExpensesTable();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('expenseDate')) document.getElementById('expenseDate').value = today;
            if (document.getElementById('tripDate')) document.getElementById('tripDate').value = today;
            if (document.getElementById('reportStartDate')) document.getElementById('reportStartDate').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            if (document.getElementById('reportEndDate')) document.getElementById('reportEndDate').value = today;
            
            // Initialize address autocomplete
            initializeAddressAutocomplete();
        }

        // Business Section Navigation
        function showBusinessSection(sectionName) {
            // Hide all business sections
            const sections = document.querySelectorAll('.business-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active class from all nav buttons
            const navButtons = document.querySelectorAll('.business-nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected section
            const selectedSection = document.getElementById(sectionName + 'Section');
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Initialize section-specific data
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'expenses') {
                // Load expenses table when switching to expense section
                setTimeout(() => {
                    if (typeof loadExpensesTable === 'function') {
                        loadExpensesTable();
                    }
                }, 100);
            } else if (sectionName === 'mileage') {
                loadMileageTrips();
            } else if (sectionName === 'aiAssistant') {
                loadAIHistory();
            }
        }

        // AI Assistant Functions
        function showAITab(tabName) {
            // Hide all AI tab contents
            const aiTabs = document.querySelectorAll('.ai-tab-content');
            aiTabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all AI tab buttons
            const aiButtons = document.querySelectorAll('.ai-tab-btn');
            aiButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected AI tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // AI Content Generation Functions
        async function generateBlogPost() {
            const prompt = document.getElementById('blogPrompt').value.trim();
            if (!prompt) {
                showMessage('Please enter a blog topic or prompt', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-blog', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate blog post');
                }

                document.getElementById('blogOutput').innerHTML = data.content;
                
                // Save to history
                saveAIPrompt('blog', prompt, data.content);
                showMessage('Blog post generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating blog post:', error);
                showMessage('Failed to generate blog post. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function generateSocialPost() {
            const platform = document.getElementById('socialPlatform').value;
            const prompt = document.getElementById('socialPrompt').value.trim();
            const includeHashtags = document.getElementById('includeHashtags').checked;

            if (!prompt) {
                showMessage('Please enter a post topic or prompt', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-social', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ platform, prompt, includeHashtags })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate social post');
                }

                document.getElementById('socialOutput').textContent = data.content;
                
                // Save to history
                saveAIPrompt('social', `${platform}: ${prompt}`, data.content);
                showMessage('Social media post generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating social post:', error);
                showMessage('Failed to generate social post. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function generateQuickIdeas() {
            const prompt = document.getElementById('ideaPrompt').value.trim();
            if (!prompt) {
                showMessage('Please enter what you need ideas for', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate ideas');
                }

                const ideasContainer = document.getElementById('ideasOutput');
                ideasContainer.innerHTML = '';
                
                data.ideas.forEach(idea => {
                    const ideaDiv = document.createElement('div');
                    ideaDiv.className = 'idea-item';
                    
                    if (typeof idea === 'object' && idea.title && idea.description) {
                        // Structured format with title and description
                        ideaDiv.innerHTML = `
                            <div class="idea-title">${idea.title}</div>
                            <div class="idea-description">${idea.description}</div>
                        `;
                    } else if (typeof idea === 'object') {
                        // Object but different structure - try to extract meaningful content
                        ideaDiv.textContent = idea.idea || idea.text || idea.content || JSON.stringify(idea);
                    } else {
                        // Simple string format
                        ideaDiv.textContent = idea;
                    }
                    
                    ideasContainer.appendChild(ideaDiv);
                });
                
                // Save to history
                saveAIPrompt('ideas', prompt, data.ideas.join('\n'));
                showMessage('Ideas generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating ideas:', error);
                showMessage('Failed to generate ideas. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function saveAIPrompt(type, prompt, response) {
            const history = JSON.parse(localStorage.getItem('aiHistory') || '[]');
            history.unshift({
                id: Date.now(),
                type,
                prompt,
                response,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 entries
            if (history.length > 50) {
                history.splice(50);
            }
            
            localStorage.setItem('aiHistory', JSON.stringify(history));
            loadAIHistory();
        }

        function loadAIHistory() {
            const history = JSON.parse(localStorage.getItem('aiHistory') || '[]');
            const historyContainer = document.getElementById('aiHistoryList');
            
            if (!historyContainer) return;
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>No AI prompts in history yet.</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(item => `
                <div class="history-item" style="padding: var(--spacing-md); border: 1px solid var(--accent-beige); border-radius: var(--border-radius); margin-bottom: var(--spacing-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <span style="font-weight: 600; color: var(--gold-muted);">${item.type.toUpperCase()}</span>
                        <span style="font-size: 0.85rem; color: var(--text-light);">${new Date(item.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div style="margin-bottom: var(--spacing-xs); font-weight: 500;">Prompt: ${item.prompt}</div>
                    <div style="color: var(--text-secondary); max-height: 100px; overflow-y: auto;">${item.response.substring(0, 200)}${item.response.length > 200 ? '...' : ''}</div>
                </div>
            `).join('');
        }

        // Utility Functions
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const text = element.textContent || element.innerHTML;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('Copied to clipboard!', 'success');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('Copied to clipboard!', 'success');
            }
        }

        function clearOutput(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.innerHTML = '';
        }

        // Dashboard Functions
        async function updateDashboard() {
            const dateRange = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
            const customRange = document.getElementById('customDateRange');
            
            if (customRange) {
                if (dateRange === 'custom') {
                    customRange.style.display = 'block';
                } else {
                    customRange.style.display = 'none';
                }
            }

            try {
                // Calculate date range
                const { startDate, endDate } = getDateRange(dateRange);
                
                // Load financial data
                const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
                
                // For now, we'll use dummy earnings data since we don't have a booking system
                // In a real implementation, this would come from the session booking system
                const earnings = calculateEarnings(startDate, endDate);
                const totalExpenses = calculateExpenses(expenses, startDate, endDate);
                const netProfit = earnings - totalExpenses;
                
                // Update dashboard cards
                if (document.getElementById('totalEarnings')) document.getElementById('totalEarnings').textContent = `$${earnings.toFixed(2)}`;
                if (document.getElementById('totalExpenses')) document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
                if (document.getElementById('netProfit')) document.getElementById('netProfit').textContent = `$${netProfit.toFixed(2)}`;
                
                const periodText = getPeriodText(dateRange);
                if (document.getElementById('earningsPeriod')) document.getElementById('earningsPeriod').textContent = periodText;
                if (document.getElementById('expensesPeriod')) document.getElementById('expensesPeriod').textContent = periodText;
                if (document.getElementById('profitPeriod')) document.getElementById('profitPeriod').textContent = periodText;
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showMessage('Failed to update dashboard', 'error');
            }
        }

        function getDateRange(range) {
            const now = new Date();
            let startDate, endDate;
            
            switch (range) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'thisWeek':
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    startDate = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate());
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'thisYear':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate');
                    const endInput = document.getElementById('endDate');
                    startDate = startInput ? new Date(startInput.value) : new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = endInput ? new Date(endInput.value) : new Date();
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            }
            
            return { startDate, endDate };
        }

        function calculateEarnings(startDate, endDate) {
            // This would integrate with the session booking system
            // For now, returning a placeholder calculation
            const months = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 30));
            return months * 2500; // $2500 average per month
        }

        function calculateExpenses(expenses, startDate, endDate) {
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            }).reduce((total, expense) => total + expense.amount, 0);
        }

        function getPeriodText(range) {
            switch (range) {
                case 'today': return 'Today';
                case 'thisWeek': return 'This Week';
                case 'thisMonth': return 'This Month';
                case 'thisYear': return 'This Year';
                case 'custom': return 'Custom Range';
                default: return 'This Month';
            }
        }

        // Expense Tracker Functions
        function showAddExpenseForm() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }

        function cancelExpenseForm() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = 'none';
                // Clear form
                if (document.getElementById('expenseDate')) document.getElementById('expenseDate').value = '';
                if (document.getElementById('expenseCategory')) document.getElementById('expenseCategory').value = 'software';
                if (document.getElementById('expenseAmount')) document.getElementById('expenseAmount').value = '';
                if (document.getElementById('expenseDescription')) document.getElementById('expenseDescription').value = '';
                if (document.getElementById('expenseRecurring')) document.getElementById('expenseRecurring').checked = false;
            }
        }

        function saveExpense() {
            const date = document.getElementById('expenseDate')?.value;
            const category = document.getElementById('expenseCategory')?.value;
            const amount = parseFloat(document.getElementById('expenseAmount')?.value || '0');
            const description = document.getElementById('expenseDescription')?.value;
            const recurring = document.getElementById('expenseRecurring')?.checked;

            if (!date || !amount || !description) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            const expense = {
                id: Date.now(),
                date,
                category,
                amount,
                description,
                recurring,
                timestamp: new Date().toISOString()
            };

            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.unshift(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));

            cancelExpenseForm();
            loadExpenses();
            updateDashboard();
            showMessage('Expense added successfully!', 'success');
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const tbody = document.getElementById('expensesTableBody');
            
            if (!tbody) return;
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No expenses recorded yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td>${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}</td>
                    <td>${expense.description}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>${expense.recurring ? 'Yes' : 'No'}</td>
                    <td>
                        <button onclick="deleteExpense(${expense.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteExpense(id) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const filteredExpenses = expenses.filter(expense => expense.id !== id);
            localStorage.setItem('expenses', JSON.stringify(filteredExpenses));
            
            loadExpenses();
            updateDashboard();
            showMessage('Expense deleted successfully!', 'success');
        }

        function exportExpensesToCSV() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            if (expenses.length === 0) {
                showMessage('No expenses to export', 'error');
                return;
            }

            const csvContent = [
                ['Date', 'Category', 'Description', 'Amount', 'Recurring'],
                ...expenses.map(expense => [
                    expense.date,
                    expense.category,
                    expense.description,
                    expense.amount,
                    expense.recurring ? 'Yes' : 'No'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('Expenses exported to CSV!', 'success');
        }

        // Mileage Tracker Functions
        function showAddTripForm() {
            const form = document.getElementById('addTripForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                // Check if home base is set and enable/disable button
                updateHomeBaseButton();
            }
        }

        // Home Base Functions
        function showHomeBaseSetup() {
            const setup = document.getElementById('homeBaseSetup');
            const currentBase = document.getElementById('currentHomeBase');
            const homeBase = localStorage.getItem('homeBaseLocation');
            
            if (setup) {
                setup.style.display = setup.style.display === 'none' ? 'block' : 'none';
                
                if (homeBase) {
                    // Show current home base
                    document.getElementById('homeBaseAddress').textContent = homeBase;
                    currentBase.style.display = 'block';
                    document.getElementById('homeAddress').value = homeBase;
                } else {
                    currentBase.style.display = 'none';
                    document.getElementById('homeAddress').value = '';
                }
                
                // Re-initialize autocomplete when showing the setup
                setTimeout(() => initializeAddressAutocomplete(), 100);
            }
        }

        function cancelHomeBaseSetup() {
            const setup = document.getElementById('homeBaseSetup');
            if (setup) {
                setup.style.display = 'none';
            }
        }

        function editHomeBase() {
            const currentBase = document.getElementById('currentHomeBase');
            if (currentBase) {
                currentBase.style.display = 'none';
            }
        }

        async function useCurrentLocation() {
            if ("geolocation" in navigator) {
                showMessage('Getting your current location...', 'info');
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        });
                    });
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Use reverse geocoding to get address
                    const address = await reverseGeocode(lat, lng);
                    document.getElementById('homeAddress').value = address;
                    showMessage('Current location detected!', 'success');
                    
                } catch (error) {
                    console.error('Error getting location:', error);
                    showMessage('Could not get your location. Please enter address manually.', 'error');
                }
            } else {
                showMessage('Location services not available in your browser', 'error');
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                // Using a free geocoding service (you might want to use a better one)
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data.locality && data.principalSubdivision) {
                    return `${data.locality}, ${data.principalSubdivision}, ${data.countryCode}`;
                } else {
                    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function saveHomeBase() {
            const address = document.getElementById('homeAddress').value.trim();
            
            if (!address) {
                showMessage('Please enter an address for your home base', 'error');
                return;
            }
            
            localStorage.setItem('homeBaseLocation', address);
            showMessage('Home base location saved!', 'success');
            
            // Update the display
            document.getElementById('homeBaseAddress').textContent = address;
            document.getElementById('currentHomeBase').style.display = 'block';
            
            // Enable the use home base button in trip form
            updateHomeBaseButton();
        }

        function updateHomeBaseButton() {
            const homeBase = localStorage.getItem('homeBaseLocation');
            const button = document.getElementById('useHomeBaseBtn');
            
            if (button) {
                if (homeBase) {
                    button.disabled = false;
                    button.textContent = `🏠 Use Home Base`;
                    button.title = `Click to use: ${homeBase}`;
                } else {
                    button.disabled = true;
                    button.textContent = `🏠 No Home Base Set`;
                    button.title = 'Set up your home base first';
                }
            }
        }

        function useHomeBaseForTrip() {
            const homeBase = localStorage.getItem('homeBaseLocation');
            const startLocationInput = document.getElementById('startLocation');
            
            if (homeBase && startLocationInput) {
                startLocationInput.value = homeBase;
                showMessage('Home base location added!', 'success');
            } else {
                showMessage('No home base set. Please configure it first.', 'error');
            }
        }

        // Address Autocomplete System
        let debounceTimers = {};
        let currentFocus = -1;

        function initializeAddressAutocomplete() {
            // Initialize autocomplete for all address inputs
            const addressInputs = [
                { input: 'homeAddress', suggestions: 'homeAddressSuggestions' },
                { input: 'startLocation', suggestions: 'startLocationSuggestions' },
                { input: 'endLocation', suggestions: 'endLocationSuggestions' }
            ];

            addressInputs.forEach(config => {
                const input = document.getElementById(config.input);
                const suggestions = document.getElementById(config.suggestions);
                
                if (input && suggestions) {
                    setupAddressInput(input, suggestions);
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAllSuggestions();
                }
            });
        }

        function setupAddressInput(input, suggestionsContainer) {
            input.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                // Debounce the API calls
                clearTimeout(debounceTimers[input.id]);
                debounceTimers[input.id] = setTimeout(() => {
                    searchAddresses(query, suggestionsContainer, input);
                }, 300);
            });

            input.addEventListener('keydown', function(e) {
                handleKeyboardNavigation(e, suggestionsContainer, input);
            });

            input.addEventListener('blur', function(e) {
                // Delay hiding to allow for click events on suggestions
                setTimeout(() => {
                    if (!e.target.closest('.autocomplete-container').querySelector(':hover')) {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 150);
            });
        }

        async function searchAddresses(query, suggestionsContainer, input) {
            try {
                // Primary search with Google Maps Geocoding API
                let addresses = await searchWithGoogleMaps(query);
                
                // If no results or API unavailable, fallback to OpenStreetMap
                if (addresses.length === 0) {
                    addresses = await searchWithNominatim(query);
                    
                    // If still no results, try broader search
                    if (addresses.length === 0) {
                        addresses = await searchWithBroadQuery(query);
                    }
                }
                
                displayAddressSuggestions(addresses, suggestionsContainer, input);
                
            } catch (error) {
                console.error('Address search error:', error);
                // Fallback: show a message that we couldn't fetch suggestions
                suggestionsContainer.innerHTML = `
                    <div class="address-suggestion">
                        <div class="suggestion-main">Search temporarily unavailable</div>
                        <div class="suggestion-detail">Please type the complete address</div>
                    </div>
                `;
                suggestionsContainer.style.display = 'block';
            }
        }

        async function searchWithGoogleMaps(query) {
            try {
                // Use enhanced backend geocoding with Places Autocomplete + Geocoding fallback
                const response = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: query })
                });
                
                if (!response.ok) {
                    throw new Error('Google Maps API not available');
                }
                
                const data = await response.json();
                
                // Handle enhanced Google geocoding responses
                if (data.status === 'OK' && data.results) {
                    return data.results.map(result => ({
                        display_name: result.display_name || result.formatted_address,
                        address: result.address || {
                            road: result.address?.road || '',
                            city: result.address?.city || '',
                            state: result.address?.state || ''
                        },
                        lat: result.geometry?.location?.lat,
                        lon: result.geometry?.location?.lng,
                        confidence: result.confidence || 1,
                        source: data.source || 'google_maps'
                    }));
                }
                
                return [];
                
            } catch (error) {
                console.log('Google Maps API fallback to OpenStreetMap');
                return [];
            }
        }

        async function searchWithNominatim(query, restrictCountries = true) {
            const countryParams = restrictCountries ? '&countrycodes=us,ca,gb,au,nz' : '';
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}${countryParams}`
            );
            
            if (!response.ok) {
                throw new Error('Nominatim API error');
            }
            
            return await response.json();
        }

        async function searchWithBroadQuery(query) {
            // Try multiple search strategies for rural addresses
            const searches = [
                // Original query with US restriction
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(query)}&countrycodes=us&dedupe=1`,
                
                // Try with explicit rural/county formatting
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(query + ' South Carolina')}&countrycodes=us`,
                
                // Try searching just the city/state portion if it exists
                ...(() => {
                    const parts = query.split(',').map(p => p.trim());
                    if (parts.length >= 2) {
                        const cityState = parts.slice(-2).join(', ');
                        return [`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(cityState)}&countrycodes=us`];
                    }
                    return [];
                })()
            ];
            
            // Try each search strategy
            for (const searchUrl of searches) {
                try {
                    const response = await fetch(searchUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.length > 0) {
                            // Filter and rank results for better relevance
                            const filtered = data.filter(address => {
                                const displayName = address.display_name.toLowerCase();
                                const queryLower = query.toLowerCase();
                                const queryParts = queryLower.split(/[\s,]+/).filter(part => part.length > 0);
                                
                                // Check if the result contains at least some query terms
                                const matchCount = queryParts.filter(part => displayName.includes(part)).length;
                                return matchCount >= Math.max(1, Math.floor(queryParts.length * 0.4));
                            });
                            
                            if (filtered.length > 0) {
                                return filtered.slice(0, 5);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Search attempt failed:', error);
                    continue;
                }
            }
            
            return [];
        }

        function displayAddressSuggestions(addresses, suggestionsContainer, input) {
            if (addresses.length === 0) {
                // For specific addresses that might not be found, provide helpful suggestions
                const inputValue = input.value.toLowerCase();
                let helpText = "Try a different search term";
                
                if (inputValue.includes("county line") || inputValue.includes("rural") || /^\d+\s+\w+\s+(road|rd|street|st|lane|ln|drive|dr)/i.test(inputValue)) {
                    helpText = "Some rural addresses may not be in databases. Try adding city/state or use the manual option below.";
                } else if (inputValue.length > 10) {
                    helpText = "Address not found in database. You can still use it with the manual option below.";
                }
                
                suggestionsContainer.innerHTML = `
                    <div class="address-suggestion">
                        <div class="suggestion-main">No exact matches found</div>
                        <div class="suggestion-detail">${helpText}</div>
                    </div>
                    <div class="address-suggestion manual-input" data-address="${escapeHtml(input.value)}" style="border-top: 1px solid #e2e8f0; background-color: #f8fafc;">
                        <div class="suggestion-main">✓ Use address as typed</div>
                        <div class="suggestion-detail">Continue with: "${escapeHtml(input.value)}"</div>
                    </div>
                `;
                suggestionsContainer.style.display = 'block';
                return;
            }

            const suggestionsHTML = addresses.map((address, index) => {
                // Better address formatting for rural/county addresses
                let mainAddress, fullAddress;
                
                if (address.address) {
                    // Use structured address data if available
                    const parts = [];
                    if (address.address.house_number) parts.push(address.address.house_number);
                    if (address.address.road) parts.push(address.address.road);
                    else if (address.address.street) parts.push(address.address.street);
                    
                    mainAddress = parts.join(' ') || address.display_name.split(',')[0];
                    fullAddress = address.display_name;
                } else {
                    // Fallback to display name parsing
                    const addressParts = address.display_name.split(',');
                    mainAddress = addressParts.slice(0, 2).join(',').trim();
                    fullAddress = address.display_name;
                }
                
                return `
                    <div class="address-suggestion" data-address="${escapeHtml(fullAddress)}" data-index="${index}">
                        <div class="suggestion-main">${escapeHtml(mainAddress)}</div>
                        <div class="suggestion-detail">${escapeHtml(fullAddress)}</div>
                    </div>
                `;
            }).join('');

            suggestionsContainer.innerHTML = suggestionsHTML;
            suggestionsContainer.style.display = 'block';
            currentFocus = -1;

            // Add click listeners to suggestions
            suggestionsContainer.querySelectorAll('.address-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const selectedAddress = this.getAttribute('data-address');
                    input.value = selectedAddress;
                    suggestionsContainer.style.display = 'none';
                    
                    // Trigger any change events
                    const changeEvent = new Event('change', { bubbles: true });
                    input.dispatchEvent(changeEvent);
                });
            });
        }

        function handleKeyboardNavigation(e, suggestionsContainer, input) {
            const suggestions = suggestionsContainer.querySelectorAll('.address-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentFocus++;
                if (currentFocus >= suggestions.length) currentFocus = 0;
                updateSuggestionFocus(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentFocus--;
                if (currentFocus < 0) currentFocus = suggestions.length - 1;
                updateSuggestionFocus(suggestions);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1 && suggestions[currentFocus]) {
                    const selectedAddress = suggestions[currentFocus].getAttribute('data-address');
                    input.value = selectedAddress;
                    suggestionsContainer.style.display = 'none';
                    
                    const changeEvent = new Event('change', { bubbles: true });
                    input.dispatchEvent(changeEvent);
                }
            } else if (e.key === 'Escape') {
                suggestionsContainer.style.display = 'none';
                currentFocus = -1;
            }
        }

        function updateSuggestionFocus(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === currentFocus);
            });
        }

        function hideAllSuggestions() {
            document.querySelectorAll('.address-suggestions').forEach(container => {
                container.style.display = 'none';
            });
            currentFocus = -1;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function cancelTripForm() {
            const form = document.getElementById('addTripForm');
            if (form) {
                form.style.display = 'none';
                // Clear form
                if (document.getElementById('tripDate')) document.getElementById('tripDate').value = '';
                if (document.getElementById('tripPurpose')) document.getElementById('tripPurpose').value = 'client_work';
                if (document.getElementById('startLocation')) document.getElementById('startLocation').value = '';
                if (document.getElementById('endLocation')) document.getElementById('endLocation').value = '';
                if (document.getElementById('milesDriven')) document.getElementById('milesDriven').value = '';
                if (document.getElementById('roundTrip')) document.getElementById('roundTrip').checked = false;
                
                // Reset calculate button text
                updateCalculateButton();
            }
        }

        async function calculateMiles() {
            const startLocation = document.getElementById('startLocation')?.value.trim();
            const endLocation = document.getElementById('endLocation')?.value.trim();
            const isRoundTrip = document.getElementById('roundTrip')?.checked;

            if (!startLocation || !endLocation) {
                showMessage('Please enter both start and end locations', 'error');
                return;
            }

            const tripType = isRoundTrip ? 'round trip' : 'one way';
            showMessage(`Calculating ${tripType} driving distance...`, 'info');

            try {
                if (isRoundTrip) {
                    // Calculate round trip: Start → End → Start
                    const outboundResponse = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [startLocation],
                            destinations: [endLocation]
                        })
                    });

                    const returnResponse = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [endLocation],
                            destinations: [startLocation]
                        })
                    });

                    if (!outboundResponse.ok || !returnResponse.ok) {
                        throw new Error('Distance API not available');
                    }

                    const outboundData = await outboundResponse.json();
                    const returnData = await returnResponse.json();

                    if (outboundData.status === 'OK' && returnData.status === 'OK' &&
                        outboundData.rows[0]?.elements[0]?.status === 'OK' &&
                        returnData.rows[0]?.elements[0]?.status === 'OK') {
                        
                        const outboundElement = outboundData.rows[0].elements[0];
                        const returnElement = returnData.rows[0].elements[0];
                        
                        const outboundMeters = outboundElement.distance.value;
                        const returnMeters = returnElement.distance.value;
                        const totalMeters = outboundMeters + returnMeters;
                        
                        const totalMiles = (totalMeters * 0.000621371).toFixed(1);
                        const outboundDuration = outboundElement.duration.text;
                        const returnDuration = returnElement.duration.text;
                        
                        const milesInput = document.getElementById('milesDriven');
                        if (milesInput) {
                            milesInput.value = totalMiles;
                        }
                        
                        showMessage(`Round trip: ${totalMiles} miles (${outboundDuration} + ${returnDuration})`, 'success');
                    } else {
                        await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
                    }
                } else {
                    // Calculate one-way trip
                    const response = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [startLocation],
                            destinations: [endLocation]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Distance API not available');
                    }

                    const data = await response.json();

                    if (data.status === 'OK' && data.rows[0]?.elements[0]?.status === 'OK') {
                        const element = data.rows[0].elements[0];
                        const distanceInMeters = element.distance.value;
                        const miles = (distanceInMeters * 0.000621371).toFixed(1);
                        const duration = element.duration.text;
                        
                        const milesInput = document.getElementById('milesDriven');
                        if (milesInput) {
                            milesInput.value = miles;
                        }
                        
                        showMessage(`Driving distance: ${miles} miles (${duration})`, 'success');
                    } else {
                        await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
                    }
                }

            } catch (error) {
                console.error('Error with Google Distance Matrix, using fallback:', error);
                await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
            }
        }

        async function calculateMilesWithFallback(startLocation, endLocation, isRoundTrip = false) {
            try {
                showMessage('Using estimated distance calculation...', 'info');
                
                // Use our enhanced geocoding API for coordinates
                const [startResponse, endResponse] = await Promise.all([
                    fetch('/api/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: startLocation })
                    }),
                    fetch('/api/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: endLocation })
                    })
                ]);

                const [startData, endData] = await Promise.all([
                    startResponse.json(),
                    endResponse.json()
                ]);

                if (!startData.results?.[0] || !endData.results?.[0]) {
                    throw new Error('Could not find one or both locations');
                }

                // Extract coordinates from enhanced geocoding response
                const startResult = startData.results[0];
                const endResult = endData.results[0];
                
                let startLat, startLon, endLat, endLon;

                if (startResult.lat && startResult.lon) {
                    startLat = startResult.lat;
                    startLon = startResult.lon;
                } else if (startResult.geometry?.location) {
                    startLat = startResult.geometry.location.lat;
                    startLon = startResult.geometry.location.lng;
                } else {
                    throw new Error('Could not get coordinates for start location');
                }

                if (endResult.lat && endResult.lon) {
                    endLat = endResult.lat;
                    endLon = endResult.lon;
                } else if (endResult.geometry?.location) {
                    endLat = endResult.geometry.location.lat;
                    endLon = endResult.geometry.location.lng;
                } else {
                    throw new Error('Could not get coordinates for end location');
                }

                // Calculate straight-line distance using Haversine formula
                let miles = calculateHaversineDistance(startLat, startLon, endLat, endLon);
                
                // Double the distance for round trips
                if (isRoundTrip) {
                    miles = miles * 2;
                }
                
                const milesInput = document.getElementById('milesDriven');
                if (milesInput) {
                    milesInput.value = miles.toFixed(1);
                }
                
                const tripType = isRoundTrip ? 'round trip' : 'one way';
                showMessage(`Estimated ${tripType}: ${miles.toFixed(1)} miles (straight-line)`, 'success');

            } catch (error) {
                console.error('Fallback distance calculation failed:', error);
                showMessage('Could not calculate distance. Please enter miles manually.', 'error');
            }
        }

        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateCalculateButton() {
            const isRoundTrip = document.getElementById('roundTrip')?.checked;
            const button = document.getElementById('calculateBtn');
            
            if (button) {
                if (isRoundTrip) {
                    button.textContent = '🔄 Calculate Round Trip';
                    button.title = 'Calculate total distance: Start → End → Start';
                } else {
                    button.textContent = '🗺️ Calculate Miles';
                    button.title = 'Calculate one-way distance';
                }
            }
        }

        function saveTrip() {
            const date = document.getElementById('tripDate')?.value;
            const purpose = document.getElementById('tripPurpose')?.value;
            const startLocation = document.getElementById('startLocation')?.value;
            const endLocation = document.getElementById('endLocation')?.value;
            const miles = parseFloat(document.getElementById('milesDriven')?.value || '0');
            const isRoundTrip = document.getElementById('roundTrip')?.checked || false;

            if (!date || !startLocation || !endLocation || !miles) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            const trip = {
                id: Date.now(),
                date,
                purpose,
                startLocation,
                endLocation,
                miles,
                roundTrip: isRoundTrip,
                timestamp: new Date().toISOString()
            };

            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            trips.unshift(trip);
            localStorage.setItem('mileageTrips', JSON.stringify(trips));

            cancelTripForm();
            loadMileageTrips();
            
            const tripType = isRoundTrip ? 'round trip' : 'one-way trip';
            showMessage(`${tripType} added successfully!`, 'success');
        }

        function loadMileageTrips() {
            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            const tbody = document.getElementById('mileageTableBody');
            
            if (!tbody) return;
            
            // Update home base button status
            updateHomeBaseButton();
            
            // Initialize address autocomplete
            initializeAddressAutocomplete();
            
            if (trips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No trips recorded yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = trips.map(trip => `
                <tr>
                    <td>${new Date(trip.date).toLocaleDateString()}</td>
                    <td>${trip.startLocation}</td>
                    <td>${trip.endLocation}</td>
                    <td>${trip.miles.toFixed(1)}</td>
                    <td>${trip.roundTrip ? '🔄 Round Trip' : '➡️ One Way'}</td>
                    <td>${trip.purpose.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td>
                        <button onclick="deleteTrip(${trip.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteTrip(id) {
            if (!confirm('Are you sure you want to delete this trip?')) return;
            
            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            const filteredTrips = trips.filter(trip => trip.id !== id);
            localStorage.setItem('mileageTrips', JSON.stringify(filteredTrips));
            
            loadMileageTrips();
            showMessage('Trip deleted successfully!', 'success');
        }

        // Reports Functions
        async function generateReport() {
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;

            if (!startDate || !endDate) {
                showMessage('Please select start and end dates', 'error');
                return;
            }

            showMessage('Generating report...', 'info');

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Get expenses from database (same as dashboard)
                const expensesResponse = await fetch('/api/business/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    expenses = await expensesResponse.json();
                }

                // Get mileage trips from localStorage (local storage)
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                // Filter data by date range
                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= start && tripDate <= end;
                });

                // Calculate totals using same logic as dashboard
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + trip.miles, 0);
                const mileageDeduction = totalMiles * 0.655; // 2024 IRS standard mileage rate
                const totalEarnings = await calculateEarningsForPeriod(start, end);
                const netProfit = totalEarnings - totalExpenses;

                // Update report display
                if (document.getElementById('reportEarnings')) document.getElementById('reportEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
                if (document.getElementById('reportExpenses')) document.getElementById('reportExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
                if (document.getElementById('reportMiles')) document.getElementById('reportMiles').textContent = totalMiles.toFixed(1);
                if (document.getElementById('reportMileageDeduction')) document.getElementById('reportMileageDeduction').textContent = `$${mileageDeduction.toFixed(2)}`;
                if (document.getElementById('reportNetProfit')) document.getElementById('reportNetProfit').textContent = `$${netProfit.toFixed(2)}`;

                // Show detailed breakdown
                updateReportBreakdown(filteredExpenses, filteredTrips, start, end);

                showMessage('Report generated successfully!', 'success');

            } catch (error) {
                console.error('Error generating report:', error);
                showMessage('Error generating report. Please try again.', 'error');
            }
        }

        async function calculateEarningsForPeriod(startDate, endDate) {
            try {
                // Get sessions from the same source as dashboard
                if (typeof sessions !== 'undefined' && sessions.length > 0) {
                    const filteredSessions = sessions.filter(session => {
                        const sessionDate = new Date(session.dateTime);
                        return sessionDate >= startDate && sessionDate <= endDate;
                    });
                    return filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                } else {
                    // Fallback to API call if sessions not available
                    const response = await fetch('/api/sessions');
                    if (response.ok) {
                        const apiSessions = await response.json();
                        const filteredSessions = apiSessions.filter(session => {
                            const sessionDate = new Date(session.dateTime);
                            return sessionDate >= startDate && sessionDate <= endDate;
                        });
                        return filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                    }
                }
            } catch (error) {
                console.error('Error calculating earnings:', error);
            }
            return 0;
        }

        function updateReportBreakdown(expenses, trips, startDate, endDate) {
            // Create detailed breakdown section
            let breakdownHTML = `
                <div class="report-breakdown">
                    <h4>Report Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</h4>
                    
                    <div class="breakdown-section">
                        <h5>📊 Expenses Breakdown (${expenses.length} items)</h5>
                        ${expenses.length > 0 ? `
                            <div class="expense-details">
                                ${expenses.map(expense => `
                                    <div class="breakdown-item">
                                        <span>${new Date(expense.date).toLocaleDateString()}</span>
                                        <span>${expense.description}</span>
                                        <span class="amount">$${parseFloat(expense.amount).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>No expenses in this period</p>'}
                    </div>
                    
                    <div class="breakdown-section">
                        <h5>🚗 Mileage Breakdown (${trips.length} trips)</h5>
                        ${trips.length > 0 ? `
                            <div class="trip-details">
                                ${trips.map(trip => `
                                    <div class="breakdown-item">
                                        <span>${new Date(trip.date).toLocaleDateString()}</span>
                                        <span>${trip.startLocation} → ${trip.endLocation} ${trip.roundTrip ? '(Round Trip)' : ''}</span>
                                        <span class="amount">${trip.miles.toFixed(1)} mi</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>No trips in this period</p>'}
                    </div>
                </div>
            `;

            const breakdownElement = document.getElementById('reportBreakdown');
            if (breakdownElement) {
                breakdownElement.innerHTML = breakdownHTML;
            }
        }

        async function exportReportCSV() {
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;

            if (!startDate || !endDate) {
                showMessage('Please generate a report first', 'error');
                return;
            }

            showMessage('Exporting report data...', 'info');

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Get expenses from database (same as dashboard)
                const expensesResponse = await fetch('/api/business/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    expenses = await expensesResponse.json();
                }

                // Get mileage trips from localStorage
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= start && tripDate <= end;
                });

                // Calculate totals for CSV summary
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + trip.miles, 0);
                const mileageDeduction = totalMiles * 0.655;

                const csvContent = [
                    ['BUSINESS REPORT'],
                    [`Period: ${startDate} to ${endDate}`],
                    [''],
                    ['SUMMARY'],
                    ['Total Expenses', `$${totalExpenses.toFixed(2)}`],
                    ['Total Miles', `${totalMiles.toFixed(1)}`],
                    ['Mileage Deduction (@ $0.655/mi)', `$${mileageDeduction.toFixed(2)}`],
                    [''],
                    ['EXPENSES DETAIL'],
                    ['Date', 'Category', 'Description', 'Amount', 'Tax Deductible'],
                    ...filteredExpenses.map(expense => [
                        new Date(expense.date).toLocaleDateString(),
                        expense.category,
                        expense.description,
                        `$${parseFloat(expense.amount).toFixed(2)}`,
                        expense.tax_deductible ? 'Yes' : 'No'
                    ]),
                    [''],
                    ['MILEAGE DETAIL'],
                    ['Date', 'Start Location', 'End Location', 'Miles', 'Type', 'Purpose', 'Deduction'],
                    ...filteredTrips.map(trip => [
                        new Date(trip.date).toLocaleDateString(),
                        trip.startLocation,
                        trip.endLocation,
                        trip.miles.toFixed(1),
                        trip.roundTrip ? 'Round Trip' : 'One Way',
                        trip.purpose.replace('_', ' '),
                        `$${(trip.miles * 0.655).toFixed(2)}`
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_report_${startDate}_to_${endDate}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('Report exported to CSV successfully!', 'success');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                showMessage('Error exporting CSV. Please try again.', 'error');
            }
        }

        function exportReportPDF() {
            showMessage('PDF export feature coming soon!', 'info');
        }

        // Dashboard Export Functions
        async function exportDashboardCSV() {
            const period = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
            const periodText = document.getElementById('dashboardDateRange')?.selectedOptions[0].text || 'This Month';
            
            showMessage('Exporting dashboard data...', 'info');

            try {
                // Get current dashboard data using existing functions
                const { startDate, endDate } = getDateRange(period);
                
                // Get expenses from database
                const expensesResponse = await fetch('/api/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    const data = await expensesResponse.json();
                    expenses = data.success ? data.expenses : [];
                }

                // Get mileage trips from localStorage
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                // Filter data by current dashboard period
                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= startDate && tripDate <= endDate;
                });

                // Get sessions using existing global sessions array
                let filteredSessions = [];
                if (typeof sessions !== 'undefined' && sessions.length > 0) {
                    filteredSessions = sessions.filter(session => {
                        const sessionDate = new Date(session.dateTime);
                        return sessionDate >= startDate && sessionDate <= endDate;
                    });
                }
                
                // Calculate totals
                const totalEarnings = filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + (trip.miles || 0), 0);
                const mileageDeduction = totalMiles * 0.655;
                const netProfit = totalEarnings - totalExpenses;

                // Create CSV content
                const csvContent = [
                    ['BUSINESS DASHBOARD EXPORT'],
                    [`Period: ${periodText} (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`],
                    [`Generated: ${new Date().toLocaleDateString()}`],
                    [''],
                    ['FINANCIAL SUMMARY'],
                    ['Metric', 'Amount'],
                    ['Total Earnings', `$${totalEarnings.toFixed(2)}`],
                    ['Total Expenses', `$${totalExpenses.toFixed(2)}`],
                    ['Net Profit', `$${netProfit.toFixed(2)}`],
                    ['Total Miles Driven', `${totalMiles.toFixed(1)}`],
                    ['Mileage Tax Deduction', `$${mileageDeduction.toFixed(2)}`],
                    [''],
                    ['SESSION BREAKDOWN'],
                    ['Date', 'Client', 'Session Type', 'Price', 'Status'],
                    ...filteredSessions.map(session => [
                        new Date(session.dateTime).toLocaleDateString(),
                        `"${(session.clientName || '').replace(/"/g, '""')}"`,
                        `"${(session.sessionType || '').replace(/"/g, '""')}"`,
                        `$${(session.price || 0).toFixed(2)}`,
                        session.paid ? 'Paid' : 'Unpaid'
                    ]),
                    [''],
                    ['EXPENSE BREAKDOWN'],
                    ['Date', 'Category', 'Description', 'Amount', 'Tax Deductible'],
                    ...filteredExpenses.map(expense => [
                        new Date(expense.date).toLocaleDateString(),
                        `"${(expense.category || '').replace(/"/g, '""')}"`,
                        `"${(expense.description || '').replace(/"/g, '""')}"`,
                        `$${parseFloat(expense.amount).toFixed(2)}`,
                        expense.tax_deductible ? 'Yes' : 'No'
                    ]),
                    [''],
                    ['MILEAGE BREAKDOWN'],
                    ['Date', 'Start', 'End', 'Miles', 'Type', 'Purpose'],
                    ...filteredTrips.map(trip => [
                        new Date(trip.date).toLocaleDateString(),
                        `"${(trip.startLocation || '').replace(/"/g, '""')}"`,
                        `"${(trip.endLocation || '').replace(/"/g, '""')}"`,
                        (trip.miles || 0).toFixed(1),
                        trip.roundTrip ? 'Round Trip' : 'One Way',
                        `"${((trip.purpose || '').replace('_', ' ')).replace(/"/g, '""')}"`
                    ])
                ].map(row => row.map(cell => {
                    // Escape CSV fields that contain commas, quotes, or newlines
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return cellStr.startsWith('"') ? cellStr : `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',')).join('\n');

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard_export_${periodText.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('Dashboard exported to CSV successfully!', 'success');

            } catch (error) {
                console.error('Error exporting dashboard:', error);
                showMessage('Error exporting dashboard. Please try again.', 'error');
            }
        }

        function exportDashboardPDF() {
            showMessage('PDF export feature coming soon!', 'info');
        }

    </script>

    <!-- Contract Modal -->
    <div id="contractModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">Document Contract Management</h3>
                <button class="contract-close-btn" onclick="closeContractModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <div class="contract-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
                    <button class="contract-tab active" onclick="switchContractTab('create')" style="flex: 1; padding: 10px; background: #d4af37; color: white; border: none; border-radius: 5px 0 0 0; cursor: pointer;">Create New</button>
                    <button class="contract-tab" onclick="switchContractTab('existing')" style="flex: 1; padding: 10px; background: #f8f9fa; color: #333; border: none; border-radius: 0 5px 0 0; cursor: pointer;">View Existing</button>
                </div>
                
                <div id="createContractTab" class="contract-tab-content">
                    <h4 style="color: #000000;">Create New Contract</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractTitleInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitleInput" placeholder="Photography Services Agreement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #000000;" />
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractContentInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContentInput" rows="15" placeholder="Enter your contract terms and conditions here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <button onclick="createContract()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Create Contract</button>
                </div>
                
                <div id="existingContractTab" class="contract-tab-content" style="display: none;">
                    <h4 style="color: #000000;">Existing Contracts</h4>
                    <div id="existingContractsList" class="existing-contracts-list" style="color: #000000;">
                        <!-- Contracts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Edit Modal -->
    <div id="contractEditModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractEditModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;"> Edit Contract</h3>
                <button class="contract-close-btn" onclick="closeContractEditModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <form id="contractEditForm" onsubmit="saveContractChanges(event)">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color: #000000;" />
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContent" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeContractEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

























        // Image optimization function for large files
        async function optimizeImage(file, maxWidth = 1920, maxHeight = 2560, quality = 0.85) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions while maintaining aspect ratio
                    let { width, height } = img;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const optimizedFile = new File([blob], file.name, {
                            type: file.type,
                            lastModified: Date.now(),
                        });
                        resolve(optimizedFile);
                    }, file.type, quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }







        // Photography Management System Navigation System
        function setActiveNavLink(targetTab) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current link
            const activeLink = document.querySelector(`.nav-link[onclick*="${targetTab}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Override switchTab function to work with new navigation
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            // Close mobile menu when switching tabs
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
            setActiveNavLink(tab);
            if (originalSwitchTab) {
                originalSwitchTab(tab);
            }
        };

        // Hamburger Menu Toggle Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                if (mobileMenu.classList.contains('show')) {
                    closeMobileMenu();
                } else {
                    openMobileMenu();
                }
            }
        }

        function openMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.add('show');
                hamburgerBtn.classList.add('active');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && mobileMenu.classList.contains('show')) {
                if (!mobileMenu.contains(event.target) && !hamburgerBtn.contains(event.target)) {
                    closeMobileMenu();
                }
            }
        });

        // Hamburger menu initialization handled in main DOM ready event



        // Subscription Modal Functions
        function showSubscriptionModal(message) {
            const modal = document.createElement('div');
            modal.className = 'subscription-modal';
            modal.innerHTML = `
                <div class="subscription-backdrop" onclick="closeSubscriptionModal()"></div>
                <div class="subscription-content">
                    <button class="close-btn" onclick="closeSubscriptionModal()">×</button>
                    <h2> Subscription Required</h2>
                    <p style="margin: 1rem 0; color: #666;">${message}</p>
                    
                    <h3 style="margin: 2rem 0 1rem 0; color: #d4af37;">Choose Your Plan</h3>
                    
                    <div class="pricing-grid">
                        <div class="pricing-card" onclick="selectPlan('monthly')">
                            <h4>Monthly</h4>
                            <div class="price">$25<span>/month</span></div>
                            <ul>
                                <li>✓ Full platform access</li>
                                <li>✓ Unlimited sessions</li>
                                <li>✓ Client galleries</li>
                                <li>✓ Professional tools</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card featured" onclick="selectPlan('sixmonth')">
                            <div class="badge">BEST VALUE</div>
                            <h4>6 Months</h4>
                            <div class="price">$125<span>/6 months</span></div>
                            <div class="savings">Save $25 (1 month free!)</div>
                            <ul>
                                <li>✓ Everything in Monthly</li>
                                <li>✓ Priority support</li>
                                <li>✓ Advanced features</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card" onclick="selectPlan('yearly')">
                            <h4>Annual</h4>
                            <div class="price">$200<span>/year</span></div>
                            <div class="savings">Save $100 (2 months free!)</div>
                            <ul>
                                <li>✓ Everything in 6 Months</li>
                                <li>✓ Custom branding</li>
                                <li>✓ Premium features</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="paymentForm" style="display: none; margin-top: 2rem;">
                        <div id="card-element"></div>
                        <button id="submitPayment" class="submit-btn">Complete Subscription</button>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .subscription-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 10000;
                }
                
                .subscription-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                }
                
                .subscription-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .close-btn {
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: none;
                    border: none;
                    font-size: 2rem;
                    cursor: pointer;
                    color: #666;
                }
                
                .pricing-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1.5rem;
                    margin: 2rem 0;
                }
                
                .pricing-card {
                    border: 2px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 2rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                }
                
                .pricing-card:hover {
                    border-color: #d4af37;
                    transform: translateY(-5px);
                    box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
                }
                
                .pricing-card.featured {
                    border-color: #d4af37;
                    background: linear-gradient(to bottom, #fafaf8, #f5f5f0);
                }
                
                .badge {
                    position: absolute;
                    top: -12px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #d4af37;
                    color: white;
                    padding: 4px 16px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }
                
                .price {
                    font-size: 2.5rem;
                    color: #d4af37;
                    margin: 1rem 0;
                    font-weight: 700;
                }
                
                .price span {
                    font-size: 1rem;
                    color: #666;
                    font-weight: 400;
                }
                
                .savings {
                    color: #34a853;
                    font-size: 0.9rem;
                    margin-bottom: 1rem;
                }
                
                .pricing-card ul {
                    list-style: none;
                    padding: 0;
                    margin: 1rem 0 0 0;
                    text-align: left;
                }
                
                .pricing-card li {
                    padding: 0.5rem 0;
                    color: #666;
                }
                
                .submit-btn {
                    background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
                    color: #000;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 1rem;
                }
                
                #card-element {
                    border: 1px solid #ddd;
                    padding: 1rem;
                    border-radius: 8px;
                    background: #f9f9f9;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        function closeSubscriptionModal() {
            const modal = document.querySelector('.subscription-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function selectPlan(plan) {
            const paymentForm = document.getElementById('paymentForm');
            paymentForm.style.display = 'block';
            
            // Load Stripe
            if (!window.stripe) {
                const stripeScript = document.createElement('script');
                stripeScript.src = 'https://js.stripe.com/v3/';
                await new Promise((resolve) => {
                    stripeScript.onload = resolve;
                    document.head.appendChild(stripeScript);
                });
            }
            
            // Get Stripe public key
            const keyResponse = await fetch('/api/stripe-public-key');
            const { publicKey } = await keyResponse.json();
            
            if (!publicKey) {
                showMessage('Stripe is not configured. Please contact support.', 'error');
                return;
            }
            
            // Initialize Stripe payment
            const stripe = Stripe(publicKey);
            const elements = stripe.elements();
            const cardElement = elements.create('card');
            cardElement.mount('#card-element');
            
            document.getElementById('submitPayment').onclick = async () => {
                try {
                    showMessage('Processing subscription...', 'info');
                    
                    // Create subscription checkout session
                    const response = await fetch('/api/create-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ plan })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to create subscription');
                    }
                    
                    const { checkoutUrl } = await response.json();
                    
                    // Redirect to Stripe Checkout
                    window.location.href = checkoutUrl;
                } catch (err) {
                    showMessage('Subscription failed: ' + err.message, 'error');
                }
            };
        }
        
        // Check subscription status on load
        async function checkSubscriptionStatus() {
            try {
                const response = await fetch('/api/subscription-status');
                const data = await response.json();
                
                if (!data.hasSubscription) {
                    // User needs subscription
                    console.log('No active subscription found');
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
        }

        // Subscription check handled in main DOM ready event

        // Firebase logout function
        async function firebaseLogout() {
            try {
                console.log('Starting logout process...');
                
                // First, clear server session
                const logoutResponse = await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Server logout response:', logoutResponse.status);
                
                // Then clear Firebase auth using existing Firebase instance
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    await firebase.auth().signOut();
                    console.log('Firebase logout successful');
                }
                
                // Clear any local user data
                if (typeof currentUser !== 'undefined') {
                    currentUser = null;
                }
                
                // Set a flag to prevent auth checks during logout
                sessionStorage.setItem('loggingOut', 'true');
                
                // Force redirect to auth page
                console.log('Redirecting to auth page...');
                window.location.replace('/auth.html');
                
            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect even on error
                window.location.replace('/auth.html');
            }
        }



    </script>

        <!-- Golden Hour Times Tab Content -->
        <div id="goldenHourTab" class="tab-content">
            <div class="content-header">
                <h1>🌅 Golden Hour Times</h1>
                <p>Find perfect lighting times for your photography sessions</p>
            </div>
            
            <div class="golden-hour-container">
                <div class="location-selector">
                    <h3>📍 Location</h3>
                    <div class="input-group">
                        <input type="text" id="locationInput" placeholder="Enter location (e.g., Myrtle Beach, SC)" 
                               list="popularLocations" onkeypress="handleLocationEnter(event)" 
                               style="width: 60%; padding: 12px; border: 2px solid var(--gold-muted); 
                               border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); 
                               font-family: var(--font-body);">
                        <datalist id="popularLocations">
                            <option value="Myrtle Beach, SC">
                            <option value="Charleston, SC">
                            <option value="Savannah, GA">
                            <option value="Wilmington, NC">
                            <option value="Virginia Beach, VA">
                            <option value="Ocean City, MD">
                            <option value="Outer Banks, NC">
                            <option value="Hilton Head, SC">
                            <option value="Kiawah Island, SC">
                            <option value="Tybee Island, GA">
                        </datalist>
                        <button onclick="selectLocation()" style="padding: 12px 16px; background: var(--cream-warm); 
                                color: var(--text-primary); border: 2px solid var(--gold-muted); 
                                border-radius: var(--border-radius); margin-left: 8px; cursor: pointer; 
                                font-weight: 600;">📍 Enter</button>
                        <button id="getCurrentLocation" onclick="getCurrentLocation()" style="padding: 12px 20px; 
                                background: var(--gold-muted); color: var(--bg-primary); border: none; 
                                border-radius: var(--border-radius); margin-left: 8px; cursor: pointer; 
                                font-weight: 600;">📍 Use My Location</button>
                    </div>
                </div>
                
                <div class="date-selector">
                    <h3>📅 Date</h3>
                    <input type="date" id="dateInput" style="padding: 12px; border: 2px solid var(--gold-muted); 
                           border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); 
                           font-family: var(--font-body); font-size: 16px;">
                </div>
                
                <button onclick="calculateGoldenHour()" id="calculateBtn" class="golden-hour-btn">
                    ✨ Get Times
                </button>
                
                <div id="goldenHourResults" class="golden-hour-results" style="display: none;">
                    <div class="results-grid">
                        <div class="time-card sunrise-card">
                            <div class="time-icon">🌅</div>
                            <h4>Sunrise</h4>
                            <div class="time-display" id="sunriseTime">--:--</div>
                            <div class="golden-hour-period">
                                <span>Golden Hour</span>
                                <div id="morningGoldenHour">--:-- to --:--</div>
                            </div>
                        </div>
                        
                        <div class="time-card sunset-card">
                            <div class="time-icon">🌇</div>
                            <h4>Sunset</h4>
                            <div class="time-display" id="sunsetTime">--:--</div>
                            <div class="golden-hour-period">
                                <span>Golden Hour</span>
                                <div id="eveningGoldenHour">--:-- to --:--</div>
                            </div>
                        </div>
                        
                        <div class="time-card blue-hour-card">
                            <div class="time-icon">🌌</div>
                            <h4>Blue Hour</h4>
                            <div class="time-display">Perfect for dramatic shots</div>
                            <div class="golden-hour-period">
                                <span>Morning</span>
                                <div id="morningBlueHour">--:-- to --:--</div>
                            </div>
                            <div class="golden-hour-period">
                                <span>Evening</span>
                                <div id="eveningBlueHour">--:-- to --:--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-info" id="locationInfo">
                        <h4>📍 Location Details</h4>
                        <div id="locationDetails">--</div>
                    </div>
                    
                    <div class="photography-tips">
                        <h4>📸 Photography Tips</h4>
                        <div class="tips-grid">
                            <div class="tip-card">
                                <strong>🌅 Golden Hour</strong>
                                <p>Soft, warm light perfect for portraits and landscapes. Best for: couple sessions, family photos, romantic portraits.</p>
                            </div>
                            <div class="tip-card">
                                <strong>🌌 Blue Hour</strong>
                                <p>Deep blue sky creates dramatic contrast. Best for: architectural photos, cityscapes, creative portraits with artificial lighting.</p>
                            </div>
                            <div class="tip-card">
                                <strong>⏰ Planning Tip</strong>
                                <p>Arrive 30 minutes before golden hour starts to set up and catch the light transition.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingSpinner" class="loading-message" style="display: none;">
                    🌅 Calculating lighting times...
                </div>
                
                <div id="errorMessage" class="error-message" style="display: none;">
                    ❌ Could not calculate times. Please check your location and try again.
                </div>
            </div>
        </div>

        <!-- Business Management Tab Content -->
        <div id="businessManagementTab" class="tab-content">
            <div class="content-header">
                <h1>💼 Business Management</h1>
                <p>Comprehensive business analytics, AI assistance, and financial tracking</p>
            </div>
            
            <!-- Business Management Navigation -->
            <div class="business-nav">
                <button class="business-nav-btn active" onclick="showBusinessSection('dashboard')">📊 Dashboard</button>
                <button class="business-nav-btn" onclick="showBusinessSection('aiAssistant')">🤖 AI Assistant</button>
                <button class="business-nav-btn" onclick="showBusinessSection('expenses')">💰 Expense Tracker</button>
                <button class="business-nav-btn" onclick="showBusinessSection('mileage')">🚗 Mileage Tracker</button>
                <button class="business-nav-btn" onclick="showBusinessSection('reports')">📋 Reports</button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="business-section active">
                <div class="dashboard-header">
                    <h2>📊 Business Dashboard</h2>
                    <div class="dashboard-controls">
                        <div class="date-range-selector">
                            <select id="dashboardDateRange" onchange="updateDashboard()">
                                <option value="today">Today</option>
                                <option value="thisWeek">This Week</option>
                                <option value="thisMonth" selected>This Month</option>
                                <option value="thisYear">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="customDateRange" style="display: none;">
                                <input type="date" id="startDate">
                                <input type="date" id="endDate">
                                <button onclick="applyCustomDateRange()">Apply</button>
                            </div>
                        </div>
                        <div class="dashboard-export-buttons">
                            <button onclick="exportDashboardCSV()" class="export-btn">📊 Export CSV</button>
                            <button onclick="exportDashboardPDF()" class="export-btn">📄 Export PDF</button>
                        </div>
                    </div>
                </div>
                
                <div class="financial-overview">
                    <div class="financial-card earnings">
                        <div class="card-icon">💵</div>
                        <div class="card-content">
                            <h3>Total Earnings</h3>
                            <div class="amount" id="totalEarnings">$0.00</div>
                            <div class="period" id="earningsPeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card expenses">
                        <div class="card-icon">💸</div>
                        <div class="card-content">
                            <h3>Total Expenses</h3>
                            <div class="amount" id="totalExpenses">$0.00</div>
                            <div class="period" id="expensesPeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card mileage">
                        <div class="card-icon">🚗</div>
                        <div class="card-content">
                            <h3>Mileage Deduction</h3>
                            <div class="amount" id="totalMileage">$0.00</div>
                            <div class="period" id="mileagePeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card profit">
                        <div class="card-icon">📈</div>
                        <div class="card-content">
                            <h3>Net Profit</h3>
                            <div class="amount" id="netProfit">$0.00</div>
                            <div class="period" id="profitPeriod">This Month</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart sections removed as requested -->
            </div>

            <!-- AI Assistant Section -->
            <div id="aiAssistantSection" class="business-section">
                <div class="ai-header">
                    <h2>🤖 AI Assistant</h2>
                    <p>Generate content for your photography business</p>
                </div>
                
                <div class="ai-tabs">
                    <button class="ai-tab-btn active" onclick="showAITab('blogWriter')">📝 Blog Writer</button>
                    <button class="ai-tab-btn" onclick="showAITab('socialMedia')">📱 Social Media</button>
                    <button class="ai-tab-btn" onclick="showAITab('quickIdeas')">💡 Quick Ideas</button>
                    <button class="ai-tab-btn" onclick="showAITab('history')">📚 History</button>
                </div>
                
                <!-- Blog Writer Tab -->
                <div id="blogWriterTab" class="ai-tab-content active">
                    <h3>📝 Blog Post Generator</h3>
                    <div class="ai-input-section">
                        <label for="blogPrompt">Blog Topic/Prompt:</label>
                        <textarea id="blogPrompt" placeholder="Enter your blog topic or prompt (e.g., 'Tips for outdoor family photography sessions')" rows="3"></textarea>
                        <button onclick="generateBlogPost()" class="ai-generate-btn">Generate Blog Post</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Content:</label>
                        <div id="blogOutput" class="rich-text-editor" contenteditable="true" placeholder="Generated blog post will appear here..."></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('blogOutput')">📋 Copy</button>
                            <button onclick="clearOutput('blogOutput')">🗑️ Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Social Media Tab -->
                <div id="socialMediaTab" class="ai-tab-content">
                    <h3>📱 Social Media Post Builder</h3>
                    <div class="ai-input-section">
                        <div class="social-platform">
                            <label for="socialPlatform">Platform:</label>
                            <select id="socialPlatform">
                                <option value="instagram">Instagram</option>
                                <option value="facebook">Facebook</option>
                                <option value="twitter">Twitter</option>
                                <option value="tiktok">TikTok</option>
                            </select>
                        </div>
                        <label for="socialPrompt">Topic/Prompt:</label>
                        <textarea id="socialPrompt" placeholder="Enter your post topic (e.g., 'Promoting spring mini sessions')" rows="2"></textarea>
                        <div class="social-options">
                            <label>
                                <input type="checkbox" id="includeHashtags" checked>
                                Include Hashtags
                            </label>
                        </div>
                        <button onclick="generateSocialPost()" class="ai-generate-btn">Generate Post</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Post:</label>
                        <div id="socialOutput" class="social-output" placeholder="Generated social media post will appear here..."></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('socialOutput')">📋 Copy</button>
                            <button onclick="clearOutput('socialOutput')">🗑️ Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Ideas Tab -->
                <div id="quickIdeasTab" class="ai-tab-content">
                    <h3>💡 Quick Ideas Generator</h3>
                    <div class="ai-input-section">
                        <label for="ideaPrompt">What do you need ideas for?</label>
                        <input type="text" id="ideaPrompt" placeholder="e.g., 'Christmas photo session promotions'">
                        <button onclick="generateQuickIdeas()" class="ai-generate-btn">Generate Ideas</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Ideas:</label>
                        <div id="ideasOutput" class="ideas-list"></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('ideasOutput')">📋 Copy All</button>
                            <button onclick="clearOutput('ideasOutput')">🗑️ Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="ai-tab-content">
                    <h3>📚 AI Prompt History</h3>
                    <div id="aiHistoryList" class="history-list"></div>
                </div>
            </div>

            <!-- Expense Tracker Section -->
            <div id="expensesSection" class="business-section">
                <div class="expenses-header">
                    <h2>💰 Expense Tracker</h2>
                    <button onclick="showAddExpenseForm()" class="add-btn">+ New Expense</button>
                </div>
                
                <div id="addExpenseForm" class="expense-form" style="display: none;">
                    <h3>Add New Expense</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">Date:</label>
                            <input type="date" id="expenseDate">
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Category:</label>
                            <select id="expenseCategory">
                                <option value="software">Software</option>
                                <option value="equipment">Equipment</option>
                                <option value="travel">Travel</option>
                                <option value="marketing">Marketing</option>
                                <option value="misc">Miscellaneous</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Amount ($):</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="expenseDescription">Description:</label>
                            <input type="text" id="expenseDescription" placeholder="Brief description of the expense">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="expenseRecurring">
                                Recurring Monthly Expense
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveExpense()" class="save-btn">Save Expense</button>
                        <button onclick="cancelExpenseForm()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
                
                <div class="expenses-table-container">
                    <div class="table-actions">
                        <button onclick="exportExpensesToCSV()" class="export-btn">📊 Export to CSV</button>
                    </div>
                    <table id="expensesTable" class="business-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Recurring</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Expenses will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mileage Tracker Section -->
            <div id="mileageSection" class="business-section">
                <div class="mileage-header">
                    <h2>🚗 Mileage Tracker</h2>
                    <div class="mileage-header-actions">
                        <button onclick="showHomeBaseSetup()" class="setup-btn">🏠 Setup Home Base</button>
                        <button onclick="showAddTripForm()" class="add-btn">+ Add Trip</button>
                    </div>
                </div>
                
                <!-- Home Base Setup Section -->
                <div id="homeBaseSetup" class="home-base-setup" style="display: none;">
                    <div class="setup-card">
                        <h3>🏠 Set Your Home Base Location</h3>
                        <p>Configure your default start location to save time when adding trips.</p>
                        
                        <div class="location-setup">
                            <div class="form-group">
                                <label for="homeAddress">Home/Office Address:</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="homeAddress" placeholder="Enter your business address" value="" autocomplete="off">
                                    <div id="homeAddressSuggestions" class="address-suggestions" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="location-actions">
                                <button onclick="useCurrentLocation()" class="location-btn">📍 Use Current Location</button>
                                <button onclick="saveHomeBase()" class="save-btn">💾 Save Home Base</button>
                                <button onclick="cancelHomeBaseSetup()" class="cancel-btn">Cancel</button>
                            </div>
                        </div>
                        
                        <div class="current-home-base" id="currentHomeBase" style="display: none;">
                            <div class="status-card">
                                <h4>✅ Current Home Base:</h4>
                                <p id="homeBaseAddress">Not set</p>
                                <button onclick="editHomeBase()" class="edit-btn">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="addTripForm" class="trip-form" style="display: none;">
                    <h3>Add New Trip</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tripDate">Date:</label>
                            <input type="date" id="tripDate">
                        </div>
                        <div class="form-group">
                            <label for="tripPurpose">Purpose:</label>
                            <select id="tripPurpose">
                                <option value="client_work">Client Work</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startLocation">Start Location:</label>
                            <div class="location-input-group">
                                <div class="autocomplete-container">
                                    <input type="text" id="startLocation" placeholder="Starting address" autocomplete="off">
                                    <div id="startLocationSuggestions" class="address-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" onclick="useHomeBaseForTrip()" class="home-base-btn" id="useHomeBaseBtn" disabled>🏠 Use Home Base</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="endLocation">End Location:</label>
                            <div class="autocomplete-container">
                                <input type="text" id="endLocation" placeholder="Destination address" autocomplete="off">
                                <div id="endLocationSuggestions" class="address-suggestions" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="milesDriven">Miles Driven:</label>
                            <input type="number" id="milesDriven" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="roundTrip" onchange="updateCalculateButton()">
                                Round Trip (Start → End → Start)
                            </label>
                            <button onclick="calculateMiles()" class="calculate-btn" id="calculateBtn">🗺️ Calculate Miles</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveTrip()" class="save-btn">Save Trip</button>
                        <button onclick="cancelTripForm()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
                
                <div class="mileage-table-container">
                    <table id="mileageTable" class="business-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Start Location</th>
                                <th>End Location</th>
                                <th>Miles</th>
                                <th>Type</th>
                                <th>Purpose</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mileageTableBody">
                            <!-- Trips will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="business-section">
                <div class="reports-header">
                    <h2>📋 Business Reports</h2>
                    <div class="report-date-range">
                        <label>Report Period:</label>
                        <input type="date" id="reportStartDate">
                        <span>to</span>
                        <input type="date" id="reportEndDate">
                        <button onclick="generateReport()" class="generate-btn">Generate Report</button>
                    </div>
                </div>
                
                <div id="reportContent" class="report-content">
                    <div class="report-summary">
                        <h3>📊 Financial Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <label>Total Earnings:</label>
                                <span id="reportEarnings">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Total Expenses:</label>
                                <span id="reportExpenses">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Total Miles:</label>
                                <span id="reportMiles">0</span>
                            </div>
                            <div class="summary-item">
                                <label>Mileage Deduction:</label>
                                <span id="reportMileageDeduction">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Net Profit:</label>
                                <span id="reportNetProfit">$0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Breakdown Section -->
                    <div id="reportBreakdown" class="report-breakdown">
                        <!-- Breakdown content will be populated by JavaScript -->
                    </div>
                    
                    <div class="report-actions">
                        <button onclick="exportReportCSV()" class="export-btn">📊 Export CSV</button>
                        <button onclick="exportReportPDF()" class="export-btn">📄 Export PDF</button>
                    </div>
                </div>
            </div>
        </div>

        </div> <!-- Close main-content -->
    </div> <!-- Close container -->
    
    <!-- Firebase SDK for consistent loading across all pages -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase storage removed - using R2 cloud storage exclusively -->
    <script src="/firebase-config.js"></script>
    
    <!-- Storage Quota Checker -->
    <script src="/static/js/storage-quota-checker.js"></script>
    
    <!-- Include main script file -->
    <script src="script.js?v=1754320300"></script>
    
    <!-- Subscription onboarding removed - file was missing and causing 404 errors -->
    <script>
        // Check if user just completed subscription
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('onboarding') === 'true') {
            // Trigger onboarding flow
            setTimeout(() => {
                if (typeof OnboardingFlow !== 'undefined') {
                    OnboardingFlow.showOnboardingModal();
                }
            }, 1000);
        }



        // Enhanced showSettings function
        window.showSettings = function() {
            hideAllSections();
            let section = document.getElementById('settings');
            if (!section) {
                const settingsHTML = `
                    <div id="settings" class="section" style="display: none;">
                        <h2>Settings & Billing</h2>
                        <div class="loading-spinner">Loading account settings</div>
                    </div>
                `;
                document.querySelector('.container').insertAdjacentHTML('beforeend', settingsHTML);
                section = document.getElementById('settings');
            }
            section.style.display = 'block';
            loadSettings();
        }

        // Load settings content
        async function loadSettings() {
            const section = document.getElementById('settings');
            try {
                showMessage('Loading account settings...', 'info');
                
                section.innerHTML = `
                    <h2>Settings & Billing</h2>
                    <div class="settings-content" style="display: grid; gap: 20px; margin-top: 20px;">
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                            <h3 style="margin-top: 0;">Account Information</h3>
                            <p style="color: #666;">Manage your account settings and preferences.</p>
                            <button onclick="showMessage('Account settings feature coming soon!', 'info')" class="btn btn-secondary">
                                Edit Profile
                            </button>
                        </div>
                        
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h3 style="margin-top: 0;">Subscription & Billing</h3>
                            <p style="color: #666;">View your current plan and billing information.</p>
                            <button onclick="showMessage('Billing management feature coming soon!', 'info')" class="btn btn-secondary">
                                Manage Subscription
                            </button>
                        </div>
                        
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h3 style="margin-top: 0;">Storage Usage</h3>
                            <div id="storageUsage">Loading storage information...</div>
                        </div>
                        
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                            <h3 style="margin-top: 0;">App Preferences</h3>
                            <p style="color: #666;">Customize your app experience.</p>
                            <button onclick="showMessage('Preference settings feature coming soon!', 'info')" class="btn btn-secondary">
                                Customize Settings
                            </button>
                        </div>
                    </div>
                `;
                

                showMessage('Settings loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading settings:', error);
                section.innerHTML = `
                    <h2>Settings & Billing</h2>
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Unable to load settings at this time.</p>
                        <button onclick="loadSettings()" class="btn btn-secondary">Try Again</button>
                    </div>
                `;
                showMessage('Failed to load settings', 'error');
            }
        }

        // Enhanced loading states for buttons
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // Enhanced error handling for API calls
        async function makeApiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}: ${response.statusText}`);
                }
                return response;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Add confirmation dialogs for destructive actions
        function confirmAction(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }

        // Global Storage Functions
        window.loadGlobalStorageStats = async function() {
            try {
                console.log('Loading global storage statistics...');
                
                // Show loading state
                document.getElementById('totalSessions').textContent = '...';
                document.getElementById('totalGalleryStorage').textContent = '...';
                document.getElementById('totalRawStorage').textContent = '...';
                document.getElementById('totalCombinedStorage').textContent = '...';
                
                const response = await fetch('/api/global-storage-stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch global storage stats');
                }
                
                const stats = await response.json();
                console.log('Global storage stats received:', stats);
                
                // Update the display
                document.getElementById('totalSessions').textContent = stats.totalSessions.toString();
                document.getElementById('totalGalleryStorage').textContent = stats.gallery.totalSizeFormatted;
                document.getElementById('totalRawStorage').textContent = stats.raw.totalSizeFormatted;
                document.getElementById('totalCombinedStorage').textContent = stats.combined.totalSizeFormatted;
                
                console.log('Global storage stats updated successfully');
                
            } catch (error) {
                console.error('Error loading global storage stats:', error);
                
                // Show error state
                document.getElementById('totalSessions').textContent = 'Error';
                document.getElementById('totalGalleryStorage').textContent = 'Error';
                document.getElementById('totalRawStorage').textContent = 'Error';
                document.getElementById('totalCombinedStorage').textContent = 'Error';
                
                showMessage('Failed to load storage statistics', 'error');
            }
        }
        
        window.refreshGlobalStorage = async function() {
            console.log('Refreshing global storage stats...');
            await window.loadGlobalStorageStats();
            showMessage('Storage statistics refreshed!', 'success');
        }

        // Golden Hour Times Functionality
        window.calculateGoldenHour = async function() {
            const locationInput = document.getElementById('locationInput');
            const dateInput = document.getElementById('dateInput');
            const calculateBtn = document.getElementById('calculateBtn');
            const resultsDiv = document.getElementById('goldenHourResults');
            const loadingDiv = document.getElementById('loadingSpinner');
            const errorDiv = document.getElementById('errorMessage');

            // Hide previous results/messages
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // Validate inputs
            if (!locationInput.value.trim()) {
                errorDiv.textContent = '❌ Please enter a location';
                errorDiv.style.display = 'block';
                return;
            }

            if (!dateInput.value) {
                errorDiv.textContent = '❌ Please select a date';
                errorDiv.style.display = 'block';
                return;
            }

            // Show loading
            loadingDiv.style.display = 'block';
            calculateBtn.disabled = true;
            calculateBtn.textContent = '⏳ Calculating...';

            try {
                // First get coordinates for the location using free Nominatim API
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput.value)}&limit=1&addressdetails=1`;
                console.log('Geocoding URL:', geocodeUrl);
                
                const geocodeResponse = await fetch(geocodeUrl);
                console.log('Geocoding response status:', geocodeResponse.status);
                
                const geocodeData = await geocodeResponse.json();
                console.log('Geocoding response data:', geocodeData);

                if (!geocodeResponse.ok) {
                    throw new Error('Failed to get location data from geocoding service');
                }

                if (!geocodeData || geocodeData.length === 0) {
                    throw new Error('Location not found. Please try a different location or be more specific (e.g., "Myrtle Beach, SC" or "Charleston, South Carolina")');
                }

                const locationData = geocodeData[0];
                const lat = parseFloat(locationData.lat);
                const lon = parseFloat(locationData.lon);
                
                // Extract location details from the response
                const address = locationData.address || {};
                const name = address.city || address.town || address.village || address.hamlet || locationData.display_name.split(',')[0];
                const state = address.state;
                const country = address.country;
                console.log('Found location:', { lat, lon, name, state, country });

                // Get sunrise/sunset data
                const sunResponse = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${dateInput.value}&formatted=0`);
                const sunData = await sunResponse.json();

                if (sunData.status !== 'OK') {
                    throw new Error('Failed to get sunrise/sunset data');
                }

                // Parse times and convert to local timezone
                const sunrise = new Date(sunData.results.sunrise);
                const sunset = new Date(sunData.results.sunset);

                // Calculate golden hour periods (approximately 1 hour after sunrise and 1 hour before sunset)
                const morningGoldenStart = new Date(sunrise.getTime());
                const morningGoldenEnd = new Date(sunrise.getTime() + 60 * 60 * 1000); // 1 hour after sunrise

                const eveningGoldenStart = new Date(sunset.getTime() - 60 * 60 * 1000); // 1 hour before sunset
                const eveningGoldenEnd = new Date(sunset.getTime());

                // Calculate blue hour periods (approximately 30 minutes before sunrise and after sunset)
                const morningBlueStart = new Date(sunrise.getTime() - 30 * 60 * 1000); // 30 min before sunrise
                const morningBlueEnd = new Date(sunrise.getTime() + 15 * 60 * 1000); // 15 min after sunrise

                const eveningBlueStart = new Date(sunset.getTime() - 15 * 60 * 1000); // 15 min before sunset
                const eveningBlueEnd = new Date(sunset.getTime() + 30 * 60 * 1000); // 30 min after sunset

                // Format times for display
                const formatTime = (date) => date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                // Update display
                document.getElementById('sunriseTime').textContent = formatTime(sunrise);
                document.getElementById('sunsetTime').textContent = formatTime(sunset);
                document.getElementById('morningGoldenHour').textContent = `${formatTime(morningGoldenStart)} to ${formatTime(morningGoldenEnd)}`;
                document.getElementById('eveningGoldenHour').textContent = `${formatTime(eveningGoldenStart)} to ${formatTime(eveningGoldenEnd)}`;
                document.getElementById('morningBlueHour').textContent = `${formatTime(morningBlueStart)} to ${formatTime(morningBlueEnd)}`;
                document.getElementById('eveningBlueHour').textContent = `${formatTime(eveningBlueStart)} to ${formatTime(eveningBlueEnd)}`;

                // Update location details
                const locationDetails = `${name}${state ? `, ${state}` : ''}, ${country}<br>
                                       Coordinates: ${lat.toFixed(4)}°, ${lon.toFixed(4)}°<br>
                                       Date: ${new Date(dateInput.value).toLocaleDateString('en-US', { 
                                           weekday: 'long', 
                                           year: 'numeric', 
                                           month: 'long', 
                                           day: 'numeric' 
                                       })}`;
                document.getElementById('locationDetails').innerHTML = locationDetails;

                // Show results
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

                showMessage('Golden hour times calculated successfully!', 'success');

            } catch (error) {
                console.error('Error calculating golden hour:', error);
                loadingDiv.style.display = 'none';
                errorDiv.textContent = `❌ ${error.message}. Please check your location and try again.`;
                errorDiv.style.display = 'block';
                showMessage('Failed to calculate golden hour times', 'error');
            } finally {
                calculateBtn.disabled = false;
                calculateBtn.textContent = '✨ Get Times';
            }
        };

        window.getCurrentLocation = function() {
            const locationInput = document.getElementById('locationInput');
            const getCurrentBtn = document.getElementById('getCurrentLocation');
            
            if (!navigator.geolocation) {
                showMessage('Geolocation is not supported by this browser', 'error');
                return;
            }

            getCurrentBtn.textContent = '📍 Getting location...';
            getCurrentBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Reverse geocode to get location name using free API
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
                        const data = await response.json();

                        if (data && data.address) {
                            const address = data.address;
                            const name = address.city || address.town || address.village || address.hamlet || 'Unknown Location';
                            const state = address.state;
                            const country = address.country;
                            locationInput.value = `${name}${state ? `, ${state}` : ''}, ${country}`;
                            showMessage('Location detected successfully!', 'success');
                        } else {
                            locationInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            showMessage('Location coordinates retrieved', 'success');
                        }
                    } catch (error) {
                        console.error('Error reverse geocoding:', error);
                        locationInput.value = `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        showMessage('Location coordinates retrieved', 'success');
                    } finally {
                        getCurrentBtn.textContent = '📍 Use My Location';
                        getCurrentBtn.disabled = false;
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let errorMessage = 'Failed to get location';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out';
                            break;
                    }
                    
                    showMessage(errorMessage, 'error');
                    getCurrentBtn.textContent = '📍 Use My Location';
                    getCurrentBtn.disabled = false;
                }
            );
        };

        // Location selection and enter key handling
        window.selectLocation = function() {
            const locationInput = document.getElementById('locationInput');
            if (locationInput.value.trim()) {
                showMessage('Location selected: ' + locationInput.value, 'success');
                // Auto-focus the date input after selecting location
                const dateInput = document.getElementById('dateInput');
                if (dateInput) {
                    dateInput.focus();
                }
            } else {
                showMessage('Please enter a location first', 'error');
                locationInput.focus();
            }
        };

        window.handleLocationEnter = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                selectLocation();
            }
        };

        // Initialize date input to today on page load
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput) {
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
            }
        });

        // Business Management Dashboard Functions
        window.updateDashboard = async function() {
            const dateRange = document.getElementById('dashboardDateRange').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (dateRange === 'custom') {
                customDateRange.style.display = 'block';
                return; // Wait for user to apply custom range
            } else {
                customDateRange.style.display = 'none';
            }
            
            await calculateFinancialStats(dateRange);
        };

        // Apply custom date range
        window.applyCustomDateRange = async function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showMessage('Please select both start and end dates', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showMessage('Start date must be before end date', 'error');
                return;
            }
            
            await calculateFinancialStats('custom', startDate, endDate);
        };

        async function calculateFinancialStats(dateRange, startDate = null, endDate = null) {
            if (!window.sessions || !Array.isArray(window.sessions)) {
                console.log('Sessions not loaded yet, using empty array');
                window.sessions = [];
            }

            // Calculate date range boundaries
            const now = new Date();
            let filterStart, filterEnd;
            
            switch (dateRange) {
                case 'today':
                    filterStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filterEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'thisWeek':
                    const startOfWeek = now.getDate() - now.getDay();
                    filterStart = new Date(now.getFullYear(), now.getMonth(), startOfWeek);
                    filterEnd = new Date(now.getFullYear(), now.getMonth(), startOfWeek + 7);
                    break;
                case 'thisMonth':
                    filterStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    filterEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'thisYear':
                    filterStart = new Date(now.getFullYear(), 0, 1);
                    filterEnd = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    if (startDate && endDate) {
                        filterStart = new Date(startDate);
                        filterEnd = new Date(endDate);
                        filterEnd.setDate(filterEnd.getDate() + 1); // Include end date
                    } else {
                        return; // Invalid custom range
                    }
                    break;
                default:
                    filterStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    filterEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            }

            // Filter sessions by date range
            const filteredSessions = window.sessions.filter(session => {
                const sessionDate = new Date(session.dateTime);
                return sessionDate >= filterStart && sessionDate < filterEnd;
            });

            console.log(`Found ${filteredSessions.length} sessions in ${dateRange} period`);

            // Calculate total earnings from session prices
            const totalEarnings = filteredSessions.reduce((total, session) => {
                const price = parseFloat(session.price) || 0;
                return total + price;
            }, 0);

            // Calculate total expenses for the same period (await the async function)
            const totalExpenses = await calculateExpensesForPeriod(filterStart, filterEnd);
            
            // Calculate mileage deduction for the same period
            const totalMileageDeduction = calculateMileageForPeriod(filterStart, filterEnd);
            
            // Calculate net profit
            const netProfit = totalEarnings - totalExpenses;

            // Update UI elements
            const totalEarningsElement = document.getElementById('totalEarnings');
            const earningsPeriodElement = document.getElementById('earningsPeriod');
            const totalExpensesElement = document.getElementById('totalExpenses');
            const expensesPeriodElement = document.getElementById('expensesPeriod');
            const totalMileageElement = document.getElementById('totalMileage');
            const mileagePeriodElement = document.getElementById('mileagePeriod');
            const netProfitElement = document.getElementById('netProfit');
            const profitPeriodElement = document.getElementById('profitPeriod');
            
            const periodText = dateRange === 'custom' 
                ? `${startDate} to ${endDate}`
                : dateRange.charAt(0).toUpperCase() + dateRange.slice(1).replace(/([A-Z])/g, ' $1');
            
            if (totalEarningsElement) {
                totalEarningsElement.textContent = `$${totalEarnings.toFixed(2)}`;
            }
            
            if (earningsPeriodElement) {
                earningsPeriodElement.textContent = periodText;
            }

            if (totalExpensesElement) {
                totalExpensesElement.textContent = `$${totalExpenses.toFixed(2)}`;
            }
            
            if (expensesPeriodElement) {
                expensesPeriodElement.textContent = periodText;
            }

            if (totalMileageElement) {
                totalMileageElement.textContent = `$${totalMileageDeduction.toFixed(2)}`;
            }
            
            if (mileagePeriodElement) {
                mileagePeriodElement.textContent = periodText;
            }

            if (netProfitElement) {
                netProfitElement.textContent = `$${netProfit.toFixed(2)}`;
                // Color coding for profit/loss
                if (netProfit >= 0) {
                    netProfitElement.style.color = '#28a745'; // Green for profit
                } else {
                    netProfitElement.style.color = '#dc3545'; // Red for loss
                }
            }
            
            if (profitPeriodElement) {
                profitPeriodElement.textContent = periodText;
            }

            // Log for debugging
            console.log(`Financial stats for ${dateRange}:`, {
                earnings: totalEarnings,
                expenses: totalExpenses,
                mileageDeduction: totalMileageDeduction,
                profit: netProfit,
                sessions: filteredSessions.length
            });
            
            return {
                totalEarnings,
                totalExpenses,
                totalMileageDeduction,
                netProfit,
                sessionCount: filteredSessions.length,
                sessions: filteredSessions
            };
        }

        // Expense calculation function
        async function calculateExpensesForPeriod(filterStart, filterEnd) {
            try {
                // Fetch expenses from database
                const response = await fetch('/api/expenses', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch expenses:', response.status);
                    return 0;
                }

                const data = await response.json();
                if (!data.success || !Array.isArray(data.expenses)) {
                    console.error('Invalid expenses response:', data);
                    return 0;
                }

                // Filter expenses by date range
                const filteredExpenses = data.expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= filterStart && expenseDate < filterEnd;
                });

                // Calculate total amount
                const totalExpenses = filteredExpenses.reduce((total, expense) => {
                    const amount = parseFloat(expense.amount) || 0;
                    return total + amount;
                }, 0);

                console.log(`Found ${filteredExpenses.length} expenses totaling $${totalExpenses.toFixed(2)} in period`);
                return totalExpenses;
            } catch (error) {
                console.error('Error calculating expenses:', error);
                return 0;
            }
        }

        // Load expenses from localStorage
        function loadExpensesFromStorage() {
            try {
                const stored = localStorage.getItem('businessExpenses');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (error) {
                console.error('Error loading expenses from storage:', error);
            }
            return [];
        }

        // Save expenses to localStorage
        function saveExpensesToStorage(expenses) {
            try {
                localStorage.setItem('businessExpenses', JSON.stringify(expenses));
                return true;
            } catch (error) {
                console.error('Error saving expenses to storage:', error);
                return false;
            }
        }

        // Mileage calculation function
        function calculateMileageForPeriod(filterStart, filterEnd) {
            try {
                // Get mileage trips from localStorage
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
                
                // Filter trips by date range
                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= filterStart && tripDate < filterEnd;
                });

                // Calculate total mileage deduction (IRS rate: $0.655 per mile for 2023)
                const totalMiles = filteredTrips.reduce((total, trip) => {
                    return total + (trip.miles || 0);
                }, 0);

                const mileageDeduction = totalMiles * 0.655;
                
                console.log(`Found ${filteredTrips.length} trips totaling ${totalMiles.toFixed(1)} miles ($${mileageDeduction.toFixed(2)} deduction) in period`);
                return mileageDeduction;
            } catch (error) {
                console.error('Error calculating mileage:', error);
                return 0;
            }
        }

        // Expense management functions
        window.showAddExpenseForm = function() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = 'block';
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('expenseDate');
                if (dateInput) dateInput.value = today;
            }
        };

        window.cancelExpenseForm = function() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = 'none';
                // Clear form
                document.getElementById('expenseDate').value = '';
                document.getElementById('expenseCategory').value = 'software';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expenseRecurring').checked = false;
            }
        };

        window.saveExpense = async function() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;
            const recurring = document.getElementById('expenseRecurring').checked;

            if (!date || !amount || amount <= 0) {
                showMessage('Please fill in all required fields with valid amounts', 'error');
                return;
            }

            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: date,
                        category: category,
                        description: description || '',
                        amount: amount,
                        recurring: recurring,
                        taxDeductible: true
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to save expense');
                }

                // Update dashboard if we're currently viewing it
                const currentRange = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
                await calculateFinancialStats(currentRange);
                
                // Close form and show success
                window.cancelExpenseForm();
                showMessage('Expense added successfully!', 'success');
                
                // Refresh expenses table if visible
                if (typeof loadExpensesTable === 'function') {
                    await loadExpensesTable();
                }
            } catch (error) {
                console.error('Error saving expense:', error);
                showMessage('Failed to save expense: ' + error.message, 'error');
            }
        };

        // Initialize dashboard when sessions are loaded
        window.initializeDashboard = async function() {
            // Wait for sessions to be loaded, then calculate stats
            if (window.sessions && Array.isArray(window.sessions)) {
                console.log('Initializing dashboard with', window.sessions.length, 'sessions');
                await calculateFinancialStats('thisMonth');
            } else {
                console.log('Sessions not ready yet, retrying dashboard initialization...');
                // Retry after a short delay
                setTimeout(window.initializeDashboard, 500);
            }
        }

        // Load and display expenses in the table
        window.loadExpensesTable = async function() {
            console.log('Loading expenses table...');
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody) {
                console.error('ERROR: Expenses table body not found! Available elements:', document.querySelectorAll('tbody'));
                return;
            }
            console.log('Found table body:', tbody);

            try {
                const response = await fetch('/api/expenses');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load expenses');
                }

                const expenses = data.expenses || [];
                console.log('Loaded expenses:', expenses);
                
                if (expenses.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                No expenses recorded yet. Click "+ New Expense" to add your first expense.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = expenses.map(expense => {
                    const date = new Date(expense.date).toLocaleDateString();
                    const amount = parseFloat(expense.amount).toFixed(2);
                    const recurring = expense.recurring ? '✓' : '';
                    
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${expense.category}</td>
                            <td>${expense.description}</td>
                            <td>$${amount}</td>
                            <td>${recurring}</td>
                            <td>
                                <button onclick="deleteExpense('${expense.id}')" class="btn btn-danger btn-sm">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log('Expenses table populated successfully');
                
            } catch (error) {
                console.error('Error loading expenses:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                            Error loading expenses: ${error.message}
                        </td>
                    </tr>
                `;
            }
        };

        // Delete expense function
        window.deleteExpense = async function(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            try {
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to delete expense');
                }

                showMessage('Expense deleted successfully!', 'success');
                
                // Refresh expenses table
                await loadExpensesTable();
                
                // Update dashboard
                const currentRange = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
                await calculateFinancialStats(currentRange);
                
            } catch (error) {
                console.error('Error deleting expense:', error);
                showMessage('Failed to delete expense: ' + error.message, 'error');
            }
        };

        // Enhanced page initialization is handled by the main DOMContentLoaded event above

    </script>

    <!-- Website Builder Tab -->
    <div id="websiteBuilderTab" class="tab-content" style="display: none;">
        <div id="website-builder-container">
            <!-- Website Builder will be dynamically loaded here -->
        </div>
    </div>

    <!-- Website Builder Styles -->
    <style id="website-builder-styles">
        /* Website Builder Specific Styles */
        #website-builder-container {
            width: 100%;
            height: calc(100vh - 150px);
            background: #0a0a0a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .wb-header {
            height: 60px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .wb-logo {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .wb-device-selector {
            display: flex;
            gap: 10px;
        }

        .wb-device-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wb-device-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .wb-actions {
            display: flex;
            gap: 10px;
        }

        .wb-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .wb-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .wb-main {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .wb-sidebar {
            width: 280px;
            background: #1a1a1a;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px;
        }

        .wb-sidebar h3 {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .wb-template-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 30px;
        }

        .wb-template-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #fff;
        }

        .wb-template-item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .wb-elements-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
        }

        .wb-element-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .wb-element-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .wb-canvas-container {
            flex: 1;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
        }

        .wb-canvas {
            background: white;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .wb-canvas.desktop {
            width: 1400px;
            min-height: 800px;
        }

        .wb-canvas.tablet {
            width: 768px;
            min-height: 1024px;
        }

        .wb-canvas.mobile {
            width: 375px;
            min-height: 667px;
        }

        .wb-edit-panel {
            width: 400px;
            background: #1a1a1a;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }

        .wb-edit-panel.active {
            transform: translateX(0);
        }

        .wb-edit-panel h3 {
            color: #fff;
            margin-bottom: 20px;
        }

        .wb-edit-group {
            margin-bottom: 20px;
        }

        .wb-edit-group label {
            display: block;
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .wb-edit-group input,
        .wb-edit-group select,
        .wb-edit-group textarea {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .wb-edit-group input[type="range"] {
            padding: 0;
        }

        .wb-editable {
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .wb-editable:hover {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .wb-editable.selected {
            outline: 2px solid #764ba2;
            outline-offset: 2px;
        }

        .wb-drag-handle {
            position: absolute;
            top: -30px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: move;
            display: none;
            z-index: 1000;
        }

        .wb-editable:hover .wb-drag-handle {
            display: block;
        }

        .wb-delete-btn {
            position: absolute;
            top: -30px;
            right: 0;
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            z-index: 1000;
        }

        .wb-editable:hover .wb-delete-btn {
            display: block;
        }

        .wb-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .wb-page-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .wb-page-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .wb-page-item.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .wb-page-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .wb-page-delete {
            color: #e53e3e;
            cursor: pointer;
            padding: 2px 6px;
        }

        .wb-drop-indicator {
            height: 2px;
            background: #667eea;
            margin: 10px 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .wb-drop-indicator.active {
            opacity: 1;
        }
    </style>

    <!-- Website Builder JavaScript -->
    <script id="website-builder-script">
        // Website Builder Module
        const WebsiteBuilder = {
            currentElement: null,
            currentDevice: 'desktop',
            pages: {
                home: { name: 'Home', content: null, active: true }
            },
            currentPage: 'home',
            templates: {
                minimal: {
                    name: 'Minimal Portfolio',
                    colors: { primary: '#000', secondary: '#fff', accent: '#667eea' },
                    fonts: { heading: 'Playfair Display', body: 'Raleway' }
                },
                wedding: {
                    name: 'Wedding Photography',
                    colors: { primary: '#2c1810', secondary: '#f8f4f0', accent: '#d4af37' },
                    fonts: { heading: 'Cormorant Garamond', body: 'Montserrat' }
                },
                fashion: {
                    name: 'Fashion Portfolio',
                    colors: { primary: '#1a1a1a', secondary: '#f0f0f0', accent: '#ff0066' },
                    fonts: { heading: 'Bebas Neue', body: 'Lato' }
                },
                nature: {
                    name: 'Nature & Landscape',
                    colors: { primary: '#1a3a2e', secondary: '#f5f5dc', accent: '#5a8c6e' },
                    fonts: { heading: 'Merriweather', body: 'Open Sans' }
                }
            },

            init() {
                if (document.getElementById('websiteBuilderTab')) {
                    this.setupBuilder();
                    this.loadGoogleFonts();
                    this.initializeAutoSave();
                }
            },

            setupBuilder() {
                const container = document.getElementById('website-builder-container');
                if (!container) return;

                container.innerHTML = `
                    <div class="wb-header">
                        <div class="wb-logo">PhotoSite Builder</div>
                        <div class="wb-device-selector">
                            <button class="wb-device-btn active" onclick="WebsiteBuilder.switchDevice('desktop')">Desktop</button>
                            <button class="wb-device-btn" onclick="WebsiteBuilder.switchDevice('tablet')">Tablet</button>
                            <button class="wb-device-btn" onclick="WebsiteBuilder.switchDevice('mobile')">Mobile</button>
                        </div>
                        <div class="wb-actions">
                            <button class="wb-btn" onclick="WebsiteBuilder.preview()">Preview</button>
                            <button class="wb-btn" onclick="WebsiteBuilder.publish()">Publish</button>
                        </div>
                    </div>
                    <div class="wb-main">
                        <div class="wb-sidebar">
                            <h3>Templates</h3>
                            <div class="wb-template-grid">
                                <div class="wb-template-item" onclick="WebsiteBuilder.selectTemplate('minimal')">Minimal Portfolio</div>
                                <div class="wb-template-item" onclick="WebsiteBuilder.selectTemplate('wedding')">Wedding Photography</div>
                                <div class="wb-template-item" onclick="WebsiteBuilder.selectTemplate('fashion')">Fashion Portfolio</div>
                                <div class="wb-template-item" onclick="WebsiteBuilder.selectTemplate('nature')">Nature & Landscape</div>
                            </div>
                            
                            <h3>Add Elements</h3>
                            <div class="wb-elements-list">
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('text')">+ Text Block</button>
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('image')">+ Image</button>
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('gallery')">+ Gallery</button>
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('button')">+ Button</button>
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('contact')">+ Contact Form</button>
                                <button class="wb-element-btn" onclick="WebsiteBuilder.addElement('social')">+ Social Links</button>
                            </div>
                            
                            <h3>Pages</h3>
                            <div class="wb-page-list" id="wb-page-list">
                                <div class="wb-page-item active" onclick="WebsiteBuilder.switchPage('home', event)">
                                    Home
                                </div>
                            </div>
                            <button class="wb-element-btn" onclick="WebsiteBuilder.showAddPageMenu()">+ Add Page</button>
                        </div>
                        
                        <div class="wb-canvas-container">
                            <div class="wb-canvas desktop" id="wb-canvas">
                                <div style="padding: 40px;">
                                    <h1 class="wb-editable" style="text-align: center; margin-bottom: 20px;">Welcome to Your Photography Portfolio</h1>
                                    <p class="wb-editable" style="text-align: center; color: #666;">Click any element to edit or add new elements from the sidebar</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wb-edit-panel" id="wb-edit-panel">
                            <h3>Edit Element</h3>
                            <div class="wb-edit-group">
                                <label>Content</label>
                                <textarea id="wb-edit-content" rows="4" onchange="WebsiteBuilder.updateElement()"></textarea>
                            </div>
                            <div class="wb-edit-group">
                                <label>Font Family</label>
                                <select id="wb-edit-font" onchange="WebsiteBuilder.updateElement()">
                                    <option value="Playfair Display">Playfair Display</option>
                                    <option value="Montserrat">Montserrat</option>
                                    <option value="Raleway">Raleway</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Lato">Lato</option>
                                    <option value="Merriweather">Merriweather</option>
                                    <option value="Bebas Neue">Bebas Neue</option>
                                    <option value="Cormorant Garamond">Cormorant Garamond</option>
                                    <option value="Poppins">Poppins</option>
                                    <option value="Oswald">Oswald</option>
                                    <option value="Dancing Script">Dancing Script</option>
                                </select>
                            </div>
                            <div class="wb-edit-group">
                                <label>Font Size</label>
                                <input type="range" id="wb-edit-size" min="12" max="120" value="16" onchange="WebsiteBuilder.updateElement()">
                                <span id="wb-size-value">16px</span>
                            </div>
                            <div class="wb-edit-group">
                                <label>Font Weight</label>
                                <select id="wb-edit-weight" onchange="WebsiteBuilder.updateElement()">
                                    <option value="300">Light (300)</option>
                                    <option value="400">Regular (400)</option>
                                    <option value="500">Medium (500)</option>
                                    <option value="600">Semi-Bold (600)</option>
                                    <option value="700">Bold (700)</option>
                                    <option value="800">Extra Bold (800)</option>
                                    <option value="900">Black (900)</option>
                                </select>
                            </div>
                            <div class="wb-edit-group">
                                <label>Text Align</label>
                                <select id="wb-edit-align" onchange="WebsiteBuilder.updateElement()">
                                    <option value="left">Left</option>
                                    <option value="center">Center</option>
                                    <option value="right">Right</option>
                                    <option value="justify">Justify</option>
                                </select>
                            </div>
                            <div class="wb-edit-group">
                                <label>Text Color</label>
                                <input type="color" id="wb-edit-color" onchange="WebsiteBuilder.updateElement()">
                            </div>
                            <div class="wb-edit-group">
                                <label>Background Color</label>
                                <input type="color" id="wb-edit-bg" onchange="WebsiteBuilder.updateElement()">
                            </div>
                            <div class="wb-edit-group">
                                <label>Padding (px)</label>
                                <input type="number" id="wb-edit-padding" value="10" onchange="WebsiteBuilder.updateElement()">
                            </div>
                            <div class="wb-edit-group">
                                <label>Margin (px)</label>
                                <input type="number" id="wb-edit-margin" value="10" onchange="WebsiteBuilder.updateElement()">
                            </div>
                            <div class="wb-edit-group">
                                <label>Border Radius (px)</label>
                                <input type="number" id="wb-edit-radius" value="0" onchange="WebsiteBuilder.updateElement()">
                            </div>
                            <div class="wb-edit-group" id="wb-image-group" style="display: none;">
                                <label>Image URL</label>
                                <input type="text" id="wb-edit-image-url" placeholder="Enter image URL">
                                <label>Or Upload Image</label>
                                <input type="file" id="wb-edit-image-upload" accept="image/*" onchange="WebsiteBuilder.handleImageUpload(event)">
                            </div>
                            <button class="wb-btn" style="background: #e53e3e; margin-top: 20px;" onclick="WebsiteBuilder.deleteElement()">Delete Element</button>
                        </div>
                    </div>
                `;

                this.setupEditableElements();
                this.initializeDragAndDrop();
            },

            loadGoogleFonts() {
                const fonts = [
                    'Playfair+Display:400,700,900',
                    'Montserrat:300,400,500,600,700',
                    'Raleway:300,400,500,600,700',
                    'Roboto:300,400,500,700',
                    'Open+Sans:300,400,600,700',
                    'Lato:300,400,700,900',
                    'Merriweather:300,400,700,900',
                    'Bebas+Neue',
                    'Cormorant+Garamond:300,400,600,700',
                    'Poppins:300,400,500,600,700',
                    'Oswald:300,400,500,600,700',
                    'Dancing+Script:400,700'
                ];

                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `https://fonts.googleapis.com/css2?family=${fonts.join('&family=')}&display=swap`;
                document.head.appendChild(link);
            },

            setupEditableElements() {
                const canvas = document.getElementById('wb-canvas');
                if (!canvas) return;

                canvas.addEventListener('click', (e) => {
                    if (e.target.classList.contains('wb-editable')) {
                        this.editElement(e.target, e);
                    }
                });
            },

            editElement(element, event) {
                event.stopPropagation();
                
                // Remove previous selection
                document.querySelectorAll('.wb-editable').forEach(el => {
                    el.classList.remove('selected');
                });
                
                element.classList.add('selected');
                this.currentElement = element;
                
                // Show edit panel
                const panel = document.getElementById('wb-edit-panel');
                panel.classList.add('active');
                
                // Load current values
                document.getElementById('wb-edit-content').value = element.textContent || '';
                document.getElementById('wb-edit-font').value = element.style.fontFamily || 'Roboto';
                document.getElementById('wb-edit-size').value = parseInt(element.style.fontSize) || 16;
                document.getElementById('wb-size-value').textContent = (parseInt(element.style.fontSize) || 16) + 'px';
                document.getElementById('wb-edit-weight').value = element.style.fontWeight || '400';
                document.getElementById('wb-edit-align').value = element.style.textAlign || 'left';
                document.getElementById('wb-edit-color').value = this.rgbToHex(element.style.color || '#000000');
                document.getElementById('wb-edit-bg').value = this.rgbToHex(element.style.backgroundColor || '#ffffff');
                document.getElementById('wb-edit-padding').value = parseInt(element.style.padding) || 10;
                document.getElementById('wb-edit-margin').value = parseInt(element.style.margin) || 10;
                document.getElementById('wb-edit-radius').value = parseInt(element.style.borderRadius) || 0;
                
                // Show image options if it's an image
                const imageGroup = document.getElementById('wb-image-group');
                if (element.tagName === 'IMG') {
                    imageGroup.style.display = 'block';
                    document.getElementById('wb-edit-image-url').value = element.src || '';
                } else {
                    imageGroup.style.display = 'none';
                }
            },

            updateElement() {
                if (!this.currentElement) return;
                
                const content = document.getElementById('wb-edit-content').value;
                const font = document.getElementById('wb-edit-font').value;
                const size = document.getElementById('wb-edit-size').value;
                const weight = document.getElementById('wb-edit-weight').value;
                const align = document.getElementById('wb-edit-align').value;
                const color = document.getElementById('wb-edit-color').value;
                const bg = document.getElementById('wb-edit-bg').value;
                const padding = document.getElementById('wb-edit-padding').value;
                const margin = document.getElementById('wb-edit-margin').value;
                const radius = document.getElementById('wb-edit-radius').value;
                
                if (this.currentElement.tagName !== 'IMG') {
                    this.currentElement.textContent = content;
                }
                
                this.currentElement.style.fontFamily = font;
                this.currentElement.style.fontSize = size + 'px';
                this.currentElement.style.fontWeight = weight;
                this.currentElement.style.textAlign = align;
                this.currentElement.style.color = color;
                this.currentElement.style.backgroundColor = bg;
                this.currentElement.style.padding = padding + 'px';
                this.currentElement.style.margin = margin + 'px';
                this.currentElement.style.borderRadius = radius + 'px';
                
                document.getElementById('wb-size-value').textContent = size + 'px';
                
                // Update image if needed
                if (this.currentElement.tagName === 'IMG') {
                    const imageUrl = document.getElementById('wb-edit-image-url').value;
                    if (imageUrl) {
                        this.currentElement.src = imageUrl;
                    }
                }
                
                this.savePage();
            },

            addElement(type) {
                const canvas = document.getElementById('wb-canvas');
                if (!canvas) return;
                
                let element;
                
                switch(type) {
                    case 'text':
                        element = document.createElement('p');
                        element.textContent = 'New text block. Click to edit.';
                        element.className = 'wb-editable';
                        element.style.padding = '10px';
                        break;
                        
                    case 'image':
                        element = document.createElement('img');
                        element.src = 'https://via.placeholder.com/400x300';
                        element.className = 'wb-editable';
                        element.style.maxWidth = '100%';
                        element.style.height = 'auto';
                        break;
                        
                    case 'gallery':
                        element = document.createElement('div');
                        element.className = 'wb-editable wb-gallery';
                        element.style.display = 'grid';
                        element.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        element.style.gap = '10px';
                        element.style.padding = '20px';
                        
                        for (let i = 0; i < 6; i++) {
                            const img = document.createElement('img');
                            img.src = `https://via.placeholder.com/200x200?text=Image+${i+1}`;
                            img.style.width = '100%';
                            img.style.height = 'auto';
                            img.style.borderRadius = '8px';
                            element.appendChild(img);
                        }
                        break;
                        
                    case 'button':
                        element = document.createElement('button');
                        element.textContent = 'Click Me';
                        element.className = 'wb-editable';
                        element.style.padding = '12px 24px';
                        element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        element.style.color = 'white';
                        element.style.border = 'none';
                        element.style.borderRadius = '6px';
                        element.style.cursor = 'pointer';
                        element.style.fontSize = '16px';
                        element.style.fontWeight = '500';
                        break;
                        
                    case 'contact':
                        element = document.createElement('form');
                        element.className = 'wb-editable';
                        element.style.padding = '20px';
                        element.style.background = '#f5f5f5';
                        element.style.borderRadius = '8px';
                        element.innerHTML = `
                            <h3 style="margin-bottom: 20px;">Contact Us</h3>
                            <input type="text" placeholder="Your Name" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="email" placeholder="Your Email" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <textarea placeholder="Your Message" rows="4" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Message</button>
                        `;
                        break;
                        
                    case 'social':
                        element = document.createElement('div');
                        element.className = 'wb-editable';
                        element.style.display = 'flex';
                        element.style.gap = '15px';
                        element.style.justifyContent = 'center';
                        element.style.padding = '20px';
                        element.innerHTML = `
                            <a href="#" style="color: #667eea; font-size: 24px;">📘</a>
                            <a href="#" style="color: #667eea; font-size: 24px;">📷</a>
                            <a href="#" style="color: #667eea; font-size: 24px;">🐦</a>
                            <a href="#" style="color: #667eea; font-size: 24px;">💼</a>
                        `;
                        break;
                }
                
                if (element) {
                    // Add drag handle and delete button
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.appendChild(element);
                    
                    const dragHandle = document.createElement('span');
                    dragHandle.className = 'wb-drag-handle';
                    dragHandle.textContent = '⋮⋮';
                    wrapper.appendChild(dragHandle);
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'wb-delete-btn';
                    deleteBtn.textContent = '×';
                    deleteBtn.onclick = () => this.deleteElement(element);
                    wrapper.appendChild(deleteBtn);
                    
                    canvas.appendChild(wrapper);
                    this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} element added`);
                    this.savePage();
                }
            },

            deleteElement(element) {
                if (!element && !this.currentElement) return;
                
                const targetElement = element || this.currentElement;
                const parent = targetElement.parentElement;
                
                if (parent) {
                    parent.remove();
                    this.showToast('Element deleted');
                    
                    // Close edit panel
                    document.getElementById('wb-edit-panel').classList.remove('active');
                    this.currentElement = null;
                    this.savePage();
                }
            },

            selectTemplate(templateName) {
                const template = this.templates[templateName];
                if (!template) return;
                
                const canvas = document.getElementById('wb-canvas');
                canvas.innerHTML = this.getTemplateHTML(templateName);
                
                this.showToast(`${template.name} template applied`);
                this.setupEditableElements();
                this.savePage();
            },

            getTemplateHTML(templateName) {
                const templates = {
                    minimal: `
                        <nav style="padding: 20px; background: #f8f8f8; display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="wb-editable" style="margin: 0; font-family: 'Playfair Display';">Photography Studio</h2>
                            <div style="display: flex; gap: 20px;">
                                <a href="#" class="wb-editable" style="color: #333; text-decoration: none;">Portfolio</a>
                                <a href="#" class="wb-editable" style="color: #333; text-decoration: none;">About</a>
                                <a href="#" class="wb-editable" style="color: #333; text-decoration: none;">Contact</a>
                            </div>
                        </nav>
                        <div style="padding: 60px 20px; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                            <h1 class="wb-editable" style="font-size: 48px; margin-bottom: 20px; font-family: 'Playfair Display';">Capturing Life's Beautiful Moments</h1>
                            <p class="wb-editable" style="font-size: 18px; opacity: 0.9;">Professional photography services for all occasions</p>
                        </div>
                    `,
                    wedding: `
                        <nav style="padding: 20px; background: #f8f4f0; display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="wb-editable" style="margin: 0; font-family: 'Cormorant Garamond'; color: #2c1810;">Wedding Photography</h2>
                            <div style="display: flex; gap: 20px;">
                                <a href="#" class="wb-editable" style="color: #2c1810; text-decoration: none;">Gallery</a>
                                <a href="#" class="wb-editable" style="color: #2c1810; text-decoration: none;">Packages</a>
                                <a href="#" class="wb-editable" style="color: #2c1810; text-decoration: none;">Contact</a>
                            </div>
                        </nav>
                        <div style="padding: 80px 20px; text-align: center; background: #f8f4f0;">
                            <h1 class="wb-editable" style="font-size: 56px; margin-bottom: 20px; font-family: 'Cormorant Garamond'; color: #2c1810;">Your Love Story, Beautifully Told</h1>
                            <p class="wb-editable" style="font-size: 18px; color: #666; font-family: 'Montserrat';">Timeless wedding photography that captures every precious moment</p>
                        </div>
                    `,
                    fashion: `
                        <nav style="padding: 20px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="wb-editable" style="margin: 0; font-family: 'Bebas Neue'; color: #ff0066; font-size: 28px;">FASHION LENS</h2>
                            <div style="display: flex; gap: 20px;">
                                <a href="#" class="wb-editable" style="color: #f0f0f0; text-decoration: none; text-transform: uppercase;">Work</a>
                                <a href="#" class="wb-editable" style="color: #f0f0f0; text-decoration: none; text-transform: uppercase;">Studio</a>
                                <a href="#" class="wb-editable" style="color: #f0f0f0; text-decoration: none; text-transform: uppercase;">Connect</a>
                            </div>
                        </nav>
                        <div style="padding: 100px 20px; text-align: center; background: #1a1a1a;">
                            <h1 class="wb-editable" style="font-size: 72px; margin-bottom: 20px; font-family: 'Bebas Neue'; color: #ff0066;">BOLD. DYNAMIC. FASHION.</h1>
                            <p class="wb-editable" style="font-size: 16px; color: #999; font-family: 'Lato'; letter-spacing: 2px;">HIGH-END FASHION PHOTOGRAPHY</p>
                        </div>
                    `,
                    nature: `
                        <nav style="padding: 20px; background: #f5f5dc; display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="wb-editable" style="margin: 0; font-family: 'Merriweather'; color: #1a3a2e;">Nature's Canvas</h2>
                            <div style="display: flex; gap: 20px;">
                                <a href="#" class="wb-editable" style="color: #1a3a2e; text-decoration: none;">Landscapes</a>
                                <a href="#" class="wb-editable" style="color: #1a3a2e; text-decoration: none;">Wildlife</a>
                                <a href="#" class="wb-editable" style="color: #1a3a2e; text-decoration: none;">About</a>
                            </div>
                        </nav>
                        <div style="padding: 80px 20px; text-align: center; background: linear-gradient(to bottom, #87CEEB, #98FB98);">
                            <h1 class="wb-editable" style="font-size: 52px; margin-bottom: 20px; font-family: 'Merriweather'; color: #1a3a2e;">Discover Nature Through My Lens</h1>
                            <p class="wb-editable" style="font-size: 18px; color: #2d5a3d; font-family: 'Open Sans';">Capturing the beauty of our natural world</p>
                        </div>
                    `
                };
                
                return templates[templateName] || '';
            },

            switchDevice(device) {
                this.currentDevice = device;
                const canvas = document.getElementById('wb-canvas');
                
                // Update button states
                document.querySelectorAll('.wb-device-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Update canvas size
                canvas.className = `wb-canvas ${device}`;
                
                this.showToast(`Switched to ${device} view`);
            },

            addPage(pageType) {
                const pageKey = pageType.toLowerCase();
                if (this.pages[pageKey]) {
                    this.showToast('Page already exists');
                    return;
                }
                
                this.pages[pageKey] = {
                    name: pageType,
                    content: this.getDefaultPageContent(pageType),
                    active: false
                };
                
                this.updatePageList();
                this.showToast(`${pageType} page added`);
            },

            getDefaultPageContent(pageType) {
                const contents = {
                    'Portfolio': '<h1 class="wb-editable">Portfolio</h1><p class="wb-editable">Showcase your best work here</p>',
                    'About': '<h1 class="wb-editable">About Me</h1><p class="wb-editable">Tell your story</p>',
                    'Contact': '<h1 class="wb-editable">Contact</h1><p class="wb-editable">Get in touch</p>',
                    'Blog': '<h1 class="wb-editable">Blog</h1><p class="wb-editable">Share your thoughts and experiences</p>'
                };
                
                return contents[pageType] || `<h1 class="wb-editable">${pageType}</h1>`;
            },

            switchPage(pageKey, event) {
                if (event) {
                    event.stopPropagation();
                }
                
                // Save current page content
                this.savePage();
                
                // Switch to new page
                Object.keys(this.pages).forEach(key => {
                    this.pages[key].active = false;
                });
                this.pages[pageKey].active = true;
                this.currentPage = pageKey;
                
                // Load new page content
                const canvas = document.getElementById('wb-canvas');
                if (this.pages[pageKey].content) {
                    canvas.innerHTML = this.pages[pageKey].content;
                } else {
                    canvas.innerHTML = this.getDefaultPageContent(this.pages[pageKey].name);
                }
                
                this.updatePageList();
                this.setupEditableElements();
                this.showToast(`Switched to ${this.pages[pageKey].name} page`);
            },

            deletePage(pageKey) {
                if (pageKey === 'home') {
                    this.showToast('Cannot delete Home page');
                    return;
                }
                
                delete this.pages[pageKey];
                
                if (this.currentPage === pageKey) {
                    this.switchPage('home');
                }
                
                this.updatePageList();
                this.showToast('Page deleted');
            },

            updatePageList() {
                const pageList = document.getElementById('wb-page-list');
                if (!pageList) return;
                
                pageList.innerHTML = Object.keys(this.pages).map(key => `
                    <div class="wb-page-item ${this.pages[key].active ? 'active' : ''}" onclick="WebsiteBuilder.switchPage('${key}', event)">
                        ${this.pages[key].name}
                        ${key !== 'home' ? `<span class="wb-page-delete" onclick="WebsiteBuilder.deletePage('${key}'); event.stopPropagation();">×</span>` : ''}
                    </div>
                `).join('');
            },

            savePage() {
                const canvas = document.getElementById('wb-canvas');
                if (this.currentPage && canvas) {
                    this.pages[this.currentPage].content = canvas.innerHTML;
                    
                    // Save to localStorage
                    localStorage.setItem('wb_pages', JSON.stringify(this.pages));
                    localStorage.setItem('wb_current_page', this.currentPage);
                }
            },

            loadSavedData() {
                const savedPages = localStorage.getItem('wb_pages');
                const savedCurrentPage = localStorage.getItem('wb_current_page');
                
                if (savedPages) {
                    this.pages = JSON.parse(savedPages);
                }
                
                if (savedCurrentPage) {
                    this.currentPage = savedCurrentPage;
                }
                
                this.updatePageList();
                
                if (this.pages[this.currentPage] && this.pages[this.currentPage].content) {
                    const canvas = document.getElementById('wb-canvas');
                    if (canvas) {
                        canvas.innerHTML = this.pages[this.currentPage].content;
                        this.setupEditableElements();
                    }
                }
            },

            initializeAutoSave() {
                setInterval(() => {
                    this.savePage();
                }, 30000); // Auto-save every 30 seconds
            },

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (this.currentElement && this.currentElement.tagName === 'IMG') {
                        this.currentElement.src = e.target.result;
                        document.getElementById('wb-edit-image-url').value = e.target.result;
                        this.savePage();
                        this.showToast('Image uploaded successfully');
                    }
                };
                reader.readAsDataURL(file);
            },

            initializeDragAndDrop() {
                // Implement drag and drop functionality
                let draggedElement = null;
                
                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('wb-editable')) {
                        draggedElement = e.target;
                        e.target.style.opacity = '0.5';
                    }
                });
                
                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('wb-editable')) {
                        e.target.style.opacity = '';
                    }
                });
                
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && e.target.classList.contains('wb-canvas')) {
                        e.target.appendChild(draggedElement);
                        this.savePage();
                    }
                });
            },

            showAddPageMenu() {
                const pageTypes = ['Portfolio', 'About', 'Contact', 'Blog'];
                const menu = document.createElement('div');
                menu.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 20px; border-radius: 8px; z-index: 10000;';
                menu.innerHTML = `
                    <h3 style="color: white; margin-bottom: 15px;">Select Page Type</h3>
                    ${pageTypes.map(type => `
                        <button class="wb-element-btn" onclick="WebsiteBuilder.addPage('${type}'); this.parentElement.remove();" style="margin: 5px; width: 200px;">${type}</button>
                    `).join('')}
                    <button class="wb-btn" onclick="this.parentElement.remove();" style="background: #666; margin-top: 10px;">Cancel</button>
                `;
                document.body.appendChild(menu);
            },

            preview() {
                const canvas = document.getElementById('wb-canvas');
                const content = canvas.innerHTML;
                
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Website Preview</title>
                        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:400,700,900&family=Montserrat:300,400,500,600,700&family=Raleway:300,400,500,600,700&family=Roboto:300,400,500,700&family=Open+Sans:300,400,600,700&family=Lato:300,400,700,900&family=Merriweather:300,400,700,900&family=Bebas+Neue&family=Cormorant+Garamond:300,400,600,700&family=Poppins:300,400,500,600,700&family=Oswald:300,400,500,600,700&family=Dancing+Script:400,700&display=swap" rel="stylesheet">
                        <style>
                            body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
                            .wb-editable { outline: none; }
                            .wb-drag-handle, .wb-delete-btn { display: none !important; }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `);
                
                this.showToast('Preview opened in new window');
            },

            publish() {
                this.savePage();
                const allContent = Object.keys(this.pages).map(key => this.pages[key].content).join('');
                
                const publishedHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>My Photography Portfolio</title>
                        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:400,700,900&family=Montserrat:300,400,500,600,700&family=Raleway:300,400,500,600,700&family=Roboto:300,400,500,700&family=Open+Sans:300,400,600,700&family=Lato:300,400,700,900&family=Merriweather:300,400,700,900&family=Bebas+Neue&family=Cormorant+Garamond:300,400,600,700&family=Poppins:300,400,500,600,700&family=Oswald:300,400,500,600,700&family=Dancing+Script:400,700&display=swap" rel="stylesheet">
                        <style>
                            body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
                            .wb-editable { outline: none; }
                            .wb-drag-handle, .wb-delete-btn { display: none !important; }
                        </style>
                    </head>
                    <body>
                        ${allContent}
                    </body>
                    </html>
                `;
                
                // Create download link
                const blob = new Blob([publishedHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'my-photography-website.html';
                a.click();
                
                this.showToast('Website published and downloaded!');
            },

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'wb-toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            rgbToHex(rgb) {
                if (rgb.startsWith('#')) return rgb;
                
                const result = rgb.match(/\d+/g);
                if (!result) return '#000000';
                
                const hex = result.map(x => {
                    const hexValue = parseInt(x).toString(16);
                    return hexValue.length === 1 ? '0' + hexValue : hexValue;
                });
                
                return '#' + hex.join('');
            }
        };

        // Initialize Website Builder when tab is activated
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Website Builder tab exists and initialize
            const websiteBuilderTab = document.getElementById('websiteBuilderTab');
            if (websiteBuilderTab) {
                // Initialize when tab becomes visible
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (websiteBuilderTab.style.display !== 'none' && !WebsiteBuilder.initialized) {
                                WebsiteBuilder.init();
                                WebsiteBuilder.loadSavedData();
                                WebsiteBuilder.initialized = true;
                            }
                        }
                    });
                });
                
                observer.observe(websiteBuilderTab, { attributes: true });
            }
        });

        // Update the switchTab function to handle Website Builder
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab(tabName);
            
            if (tabName === 'websiteBuilder' && !WebsiteBuilder.initialized) {
                WebsiteBuilder.init();
                WebsiteBuilder.loadSavedData();
                WebsiteBuilder.initialized = true;
            }
        };
    </script>

</body>
</html>