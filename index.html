<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRESH Photo Session Scheduler - July 20 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .session-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, textarea, select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-edit {
            background: #805ad5;
            color: white;
        }
        
        .btn-edit:hover {
            background: #6b46c1;
        }
        
        .btn-calendar {
            background: #38a169;
            color: white;
        }
        
        .btn-calendar:hover {
            background: #2f855a;
        }
        
        .btn-gallery-ready {
            background: #ed8936;
            color: white;
        }
        
        .btn-gallery-ready:hover {
            background: #dd6b20;
        }
        
        .btn-invoice {
            background: #00b5d8;
            color: white;
        }
        
        .btn-invoice:hover {
            background: #0987a0;
        }
        
        .btn-call {
            background: #38b2ac;
            color: white;
        }
        
        .btn-call:hover {
            background: #319795;
        }
        
        .btn-text {
            background: #d69e2e;
            color: white;
        }
        
        .btn-text:hover {
            background: #b7791f;
        }
        
        .btn-gallery {
            background: #9f7aea;
            color: white;
        }
        
        .btn-gallery:hover {
            background: #805ad5;
        }
        
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .session-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .session-card:hover {
            transform: translateY(-5px);
        }
        
        .session-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .session-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
        }
        
        .session-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .session-details {
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .detail-label {
            font-weight: 600;
            width: 80px;
            color: #4a5568;
        }
        
        .detail-value {
            color: #2d3748;
        }
        
        .session-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .session-actions {
                grid-template-columns: 1fr;
            }
        }
        
        .photo-gallery {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .photo-item:hover {
            transform: scale(1.05);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .upload-modal.active {
            display: flex;
        }
        
        .upload-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .photo-count {
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #718096;
        }
        
        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .upload-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .file-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .file-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }
        
        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .file-progress-name {
            flex: 1;
            font-size: 0.9em;
            color: #4a5568;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-progress-bar {
            background: #e2e8f0;
            border-radius: 6px;
            height: 6px;
            width: 100px;
            overflow: hidden;
        }
        
        .file-progress-fill {
            background: #48bb78;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-progress-status {
            font-size: 0.8em;
            color: #48bb78;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }
        
        .admin-checkboxes {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .admin-checkboxes h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
        }
        
        .upload-limits-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #234e52;
        }
        
        .upload-limits-info h4 {
            margin: 0 0 8px 0;
            color: #065f46;
        }
        
        .upload-limits-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .batch-upload-info {
            background: #fef7e0;
            border: 1px solid #f6cc73;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #744210;
            font-size: 0.9rem;
        }
            font-size: 0.95em;
            color: #4a5568;
            margin: 0;
            user-select: none;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .sessions-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .session-actions { flex-direction: column; }
            .btn { width: 100%; margin: 2px 0; }
            .checkbox-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📸 Photo Session Scheduler</h1>
            <p>Manage photography sessions with photo galleries</p>
        </div>

        <!-- Session Form -->
        <div class="session-form">
            <h2>Add New Session</h2>
            <form id="sessionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <input type="text" id="sessionType" name="sessionType" required placeholder="Wedding, Portrait, etc.">
                    </div>
                    <div class="form-group">
                        <label for="dateTime">Date & Time</label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required min="2025-01-01T00:00">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required placeholder="Session location">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" required placeholder="60">
                    </div>
                </div>
                
                <!-- Admin Workflow Checkboxes -->
                <div class="admin-checkboxes">
                    <h3>Admin Workflow Status</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contractSigned" name="contractSigned">
                            <label for="contractSigned">📝 Contract Signed</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="paid" name="paid">
                            <label for="paid">💵 Paid</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edited" name="edited">
                            <label for="edited">✂️ Edited</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="delivered" name="delivered">
                            <label for="delivered">📦 Delivered</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sendReminder" name="sendReminder">
                            <label for="sendReminder">🔔 Send session reminder 24 hours before</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyGalleryReady" name="notifyGalleryReady">
                            <label for="notifyGalleryReady">🖼️ Notify when gallery is ready</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Session</button>
            </form>
        </div>

        <!-- Sessions Display -->
        <div id="sessionsContainer" class="sessions-grid">
            <div class="empty-state">
                <h3>No sessions yet</h3>
                <p>Add your first photography session above!</p>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-content">
            <h3>Upload Photos</h3>
            
            <div class="upload-limits-info">
                <h4>📈 Enhanced Upload Capacity</h4>
                <ul>
                    <li><strong>Unlimited file size</strong> - Upload RAW photos, high-res images</li>
                    <li><strong>Unlimited quantity</strong> - Upload entire photo shoots at once</li>
                    <li><strong>Batch processing</strong> - Large uploads handled automatically</li>
                    <li><strong>Progress tracking</strong> - Monitor individual file uploads</li>
                </ul>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <p>📸 Click here or drag photos to upload</p>
                <p style="font-size: 0.9em; color: #718096; margin-top: 10px;">Supports unlimited photos of any size - JPG, PNG, RAW files welcome!</p>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
            <div id="uploadProgress" style="margin: 20px 0;">
                <div id="filePreview" style="margin-bottom: 15px;"></div>
                <div id="uploadStatus" style="display: none;">
                    <div class="upload-status-header">
                        <span id="uploadStatusText">Preparing upload...</span>
                        <span id="uploadCounter">0/0</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="overallProgress"></div>
                    </div>
                    <div id="fileProgressList" style="margin-top: 15px;"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="uploadBtn" onclick="startUpload()" style="display: none;">Upload Selected Photos</button>
                <button class="btn btn-secondary" onclick="closeUploadModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let sessions = [];
        let currentUploadSessionId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('sessionForm').addEventListener('submit', addSession);
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        async function addSession(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on',
                sendReminder: formData.get('sendReminder') === 'on',
                notifyGalleryReady: formData.get('notifyGalleryReady') === 'on',
                photos: []
            };

            try {
                if (editingSessionId) {
                    // Update existing session
                    const response = await fetch(`/api/sessions/${editingSessionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const updatedSession = await response.json();
                        const sessionIndex = sessions.findIndex(s => s.id === editingSessionId);
                        if (sessionIndex !== -1) {
                            sessions[sessionIndex] = updatedSession;
                        }
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session updated successfully!', 'success');
                    } else {
                        showMessage('Failed to update session', 'error');
                    }
                } else {
                    // Create new session
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const newSession = await response.json();
                        sessions.unshift(newSession);
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session added successfully!', 'success');
                    } else {
                        showMessage('Failed to add session', 'error');
                    }
                }
            } catch (error) {
                console.error('Error processing session:', error);
                showMessage('Error processing session', 'error');
            }
        }

        function resetForm(form) {
            form.reset();
            editingSessionId = null;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Session';
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Add your first photography session above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session-card">
                    <div class="session-header">
                        <div class="session-title">${session.clientName}</div>
                        <div class="session-type">${session.sessionType}</div>
                    </div>
                    
                    <div class="session-details">
                        <div class="detail-row">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value">${formatDateTime(session.dateTime)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Location:</span>
                            <span class="detail-value">${session.location}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${session.phoneNumber}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Price:</span>
                            <span class="detail-value">$${session.price}</span>
                        </div>
                    </div>

                    <div class="session-actions">
                        <button class="btn btn-secondary" onclick="openUploadModal('${session.id}')">
                            📸 Upload Photos${session.photos && session.photos.length ? ` (${session.photos.length})` : ''}
                        </button>
                        <button class="btn btn-edit" onclick="editSession('${session.id}')">
                            📝 Edit
                        </button>
                        <button class="btn btn-calendar" onclick="addToCalendar('${session.id}')">
                            📅 Add to Calendar
                        </button>
                        <button class="btn btn-gallery-ready" onclick="sendGalleryReady('${session.id}')" ${(!session.photos || session.photos.length === 0) ? 'disabled title="Upload photos first"' : ''}>
                            📩 ${session.galleryAccessToken ? 'Resend Gallery' : 'Send Gallery Ready'}
                        </button>
                        <button class="btn btn-invoice" onclick="sendInvoice('${session.id}')">
                            💵 Send Invoice
                        </button>
                        <button class="btn btn-call" onclick="callClient('${session.phoneNumber}')">
                            📞 Call Client
                        </button>
                        <button class="btn btn-text" onclick="textClient('${session.phoneNumber}', '${session.clientName}', '${session.id}')">
                            💬 Text Client
                        </button>
                        <button class="btn btn-gallery" onclick="viewGallery('${session.id}')">
                            🖼️ ${session.galleryAccessToken ? 'View Gallery' : 'Create Gallery'}${session.photos && session.photos.length ? ` (${session.photos.length})` : ''}
                        </button>
                        <button class="btn btn-danger" onclick="deleteSession('${session.id}')">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openUploadModal(sessionId) {
            currentUploadSessionId = sessionId;
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            currentUploadSessionId = null;
            selectedFiles = [];
            
            // Reset all upload interface elements
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('uploadStatus').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            // Clear any existing progress intervals
            if (window.uploadProgressIntervals) {
                window.uploadProgressIntervals.forEach(interval => clearInterval(interval));
                window.uploadProgressIntervals = [];
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
                document.getElementById('fileInput').files = e.dataTransfer.files;
            }
        }

        let selectedFiles = [];

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
            }
        }

        function showFilePreview(files) {
            const filePreview = document.getElementById('filePreview');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (files.length === 0) {
                filePreview.innerHTML = '';
                uploadBtn.style.display = 'none';
                return;
            }

            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
            
            filePreview.innerHTML = `
                <h4>Selected Photos (${files.length}) - ${totalSizeMB}MB Total</h4>
                <div class="file-preview-grid">
                    ${files.map((file, index) => {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                        return `
                            <div class="file-preview-item">
                                <img src="${URL.createObjectURL(file)}" alt="Preview">
                                <button class="file-preview-remove" onclick="removeFile(${index})">&times;</button>
                                <div style="font-size: 0.7em; color: #666; margin-top: 2px;">${fileSizeMB}MB</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${files.length > 20 ? '<div class="batch-upload-info">Large batch detected - will process in optimized chunks</div>' : ''}
            `;
            
            uploadBtn.style.display = 'inline-block';
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            showFilePreview(selectedFiles);
        }

        function startUpload() {
            if (selectedFiles.length === 0) {
                showMessage('No files selected for upload', 'error');
                return;
            }
            uploadFiles(selectedFiles);
        }

        async function uploadFiles(files) {
            if (!currentUploadSessionId) {
                showMessage('No session selected for upload', 'error');
                return;
            }

            try {
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('photos', file);
                });

                const response = await fetch(`/api/sessions/${currentUploadSessionId}/upload-photos`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`Successfully uploaded ${result.uploaded} photos!`, 'success');
                    closeUploadModal();
                    loadSessions(); // Refresh to show new photos
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Upload failed: ' + error.message, 'error');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;

            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    sessions = sessions.filter(s => s.id !== sessionId);
                    renderSessions();
                    showMessage('Session deleted successfully!', 'success');
                } else {
                    showMessage('Failed to delete session', 'error');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showMessage('Error deleting session', 'error');
            }
        }

        function viewPhoto(url) {
            window.open(url, '_blank');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Admin-only button functions
        let editingSessionId = null;

        function editSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            editingSessionId = sessionId;
            
            // Populate the form with existing data for editing
            document.getElementById('clientName').value = session.clientName;
            document.getElementById('sessionType').value = session.sessionType;
            document.getElementById('dateTime').value = session.dateTime;
            document.getElementById('location').value = session.location;
            document.getElementById('phoneNumber').value = session.phoneNumber;
            document.getElementById('email').value = session.email;
            document.getElementById('price').value = session.price;
            document.getElementById('duration').value = session.duration;
            
            // Set checkbox states
            document.getElementById('contractSigned').checked = session.contractSigned || false;
            document.getElementById('paid').checked = session.paid || false;
            document.getElementById('edited').checked = session.edited || false;
            document.getElementById('delivered').checked = session.delivered || false;
            document.getElementById('sendReminder').checked = session.sendReminder || false;
            document.getElementById('notifyGalleryReady').checked = session.notifyGalleryReady || false;
            
            // Update form UI for editing
            const form = document.getElementById('sessionForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Session';
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
            
            showMessage('Form populated for editing. Update and save changes.', 'success');
        }

        function addToCalendar(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const startDate = new Date(session.dateTime);
            const endDate = new Date(startDate.getTime() + (session.duration * 60000));
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Photography Scheduler//EN
BEGIN:VEVENT
UID:${session.id}@photographyschedule.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Photography Session - ${session.clientName}
DESCRIPTION:Session Type: ${session.sessionType}\\nLocation: ${session.location}\\nClient: ${session.clientName}\\nPhone: ${session.phoneNumber}\\nEmail: ${session.email}\\nPrice: $${session.price}
LOCATION:${session.location}
END:VEVENT
END:VCALENDAR`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${session.clientName.replace(/\s+/g, '_')}_photography_session.ics`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Calendar event downloaded!', 'success');
        }

        async function sendGalleryReady(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                // First, generate gallery access token
                const generateResponse = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!generateResponse.ok) {
                    throw new Error('Failed to generate gallery access');
                }
                
                const galleryData = await generateResponse.json();
                
                // Then send notification
                const notifyResponse = await fetch(`/api/sessions/${sessionId}/send-gallery-notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!notifyResponse.ok) {
                    throw new Error('Failed to send gallery notification');
                }
                
                const notifyData = await notifyResponse.json();
                
                // Show success message with gallery URL
                showMessage(`Gallery ready! Secure link sent to ${session.clientName}`, 'success');
                
                // Optional: Show the gallery URL in a popup for copying
                const showUrlConfirm = confirm(`Gallery notification sent to ${session.clientName}!\n\nGallery URL (for your reference):\n${galleryData.galleryUrl}\n\nClick OK to copy link to clipboard.`);
                
                if (showUrlConfirm) {
                    navigator.clipboard.writeText(galleryData.galleryUrl).then(() => {
                        showMessage('Gallery URL copied to clipboard!', 'success');
                    }).catch(() => {
                        // Fallback for browsers that don't support clipboard API
                        prompt('Copy this gallery URL:', galleryData.galleryUrl);
                    });
                }
                
            } catch (error) {
                console.error('Error sending gallery ready notification:', error);
                showMessage('Failed to send gallery notification: ' + error.message, 'error');
            }
        }

        async function sendInvoice(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to send invoice');
                }
                
                const result = await response.json();
                
                showMessage(`Invoice sent to ${session.clientName} for $${session.price}!`, 'success');
                
                // Optional: Show invoice URL
                const showUrlConfirm = confirm(`Invoice sent successfully to ${session.clientName}!\n\nInvoice Amount: $${session.price}\nStatus: ${result.invoice.status}\n\nClick OK to view the invoice.`);
                
                if (showUrlConfirm && result.invoice.hostedInvoiceUrl) {
                    window.open(result.invoice.hostedInvoiceUrl, '_blank');
                }
                
            } catch (error) {
                console.error('Error sending invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }

        function callClient(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function textClient(phoneNumber, clientName, sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session && session.galleryAccessToken) {
                const galleryUrl = `${window.location.origin}/gallery/${sessionId}?access=${session.galleryAccessToken}`;
                const message = `📸 ${clientName}, your ${session.sessionType} photos are ready! View gallery: ${galleryUrl}`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            } else {
                const message = `Hi ${clientName}, your photos will be ready soon! We'll send you the gallery link when they're available.`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            }
        }

        async function viewGallery(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Check if gallery access exists
            if (session.galleryAccessToken) {
                // Open existing gallery
                window.open(`/gallery/${sessionId}?access=${session.galleryAccessToken}`, '_blank');
            } else {
                // Generate gallery access first
                try {
                    const response = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate gallery access');
                    }
                    
                    const galleryData = await response.json();
                    
                    // Update local session data
                    session.galleryAccessToken = galleryData.accessToken;
                    
                    // Open gallery
                    window.open(galleryData.galleryUrl, '_blank');
                    
                } catch (error) {
                    console.error('Error generating gallery access:', error);
                    showMessage('Failed to generate gallery access: ' + error.message, 'error');
                }
            }
        }
    </script>
</body>
</html>