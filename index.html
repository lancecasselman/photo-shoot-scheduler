<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="description" content="Professional photography business management platform with session scheduling, client galleries, invoicing, and premium website builder.">
    <meta name="keywords" content="photography, business management, client portal, photo gallery, session scheduling, invoicing">
    <title>Photography Management System - Professional Photography Business Platform</title>
    
    <script>
        // ðŸ”„ TOGGLEABLE AUTH GUARD SYSTEM
        const DEV_MODE = false; // ðŸ‘‰ Set to false to re-enable login protection
        
        // Optional: Add visual flag to your header/footer
        document.addEventListener('DOMContentLoaded', function() {
            if (DEV_MODE) {
                const banner = document.createElement("div");
                banner.textContent = "Warning DEV MODE ENABLED - NO AUTH CHECK";
                banner.style = "position:fixed;top:0;width:100%;background:#ffc;padding:5px;text-align:center;z-index:10000;font-weight:bold;color:#333;";
                document.body.appendChild(banner);
                
                // Add margin to body to prevent overlap
                document.body.style.marginTop = "30px";
            }
        });
    </script>
    
    <!-- Google Fonts - Photography Management System Theme -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    

    
    <!-- Confetti Animation Styles -->
    <style>
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #d4af37;
            animation: confetti-fall 3s linear forwards;
        }
        
        .confetti-piece:nth-child(odd) {
            background: #f4e4bc;
            border-radius: 50%;
        }
        
        .confetti-piece:nth-child(3n) {
            background: #b8941f;
            width: 8px;
            height: 8px;
        }
        
        .confetti-piece:nth-child(4n) {
            background: #efd971;
            border-radius: 2px;
        }
        
        .confetti-piece:nth-child(5n) {
            background: #c4962d;
            width: 12px;
            height: 6px;
            border-radius: 6px;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .milestone-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 10000;
            animation: milestone-pop 2s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes milestone-pop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    </style>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Photography Management System Design System */
        :root {
            /* Color Palette */
            --bg-primary: #FAFAF8;
            --bg-secondary: #FFFFFF;
            --accent-beige: #EADBC8;
            --accent-sage: #D9E1D8;
            --gold-muted: #C1A35E;
            --rose-dusty: #E8C1B4;
            --text-primary: #1F1F1F;
            --text-secondary: #555555;
            --text-light: #888888;
            
            /* Typography */
            --font-heading: 'Cormorant Garamond', serif;
            --font-body: 'Quicksand', sans-serif;
            
            /* Spacing */
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
            
            /* Shadows */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            font-weight: 400;
            font-size: 16px;
            overflow-x: visible !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md);
            overflow: visible !important;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }
        }
        
        /* Header with Hamburger Menu */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            position: relative;
        }
        
        .logo {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--gold-muted);
            margin: 0;
        }
        
        /* Removed old conflicting navigation styles */
        
        /* Removed more old navigation styles */

        /* Hamburger Menu Styles */
        .hamburger-menu {
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-xs);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            position: relative;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .hamburger-menu:hover {
            background: var(--accent-beige);
        }

        .hamburger-line {
            display: block;
            width: 25px;
            height: 3px;
            background: var(--text-primary);
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        /* Make hamburger menu fully visible and opaque */
        .hamburger-menu {
            background: #2a2a2a !important;
            border: 2px solid #d4af37 !important;
            opacity: 1 !important;
        }

        .hamburger-line {
            background: #d4af37 !important;
            opacity: 1 !important;
        }

        .hamburger-menu:hover {
            background: #3a3a3a !important;
            border-color: #ffd700 !important;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Mobile Menu Dropdown - positioned relative to header */
        .mobile-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1003;
            animation: slideDown 0.3s ease;
            margin: 0;
        }

        .mobile-menu.show {
            display: block;
        }

        /* Ensure container has relative positioning for dropdown */
        .container {
            position: relative;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mobile-menu .nav-menu ul {
            list-style: none;
            padding: var(--spacing-sm);
            margin: 0;
        }

        .mobile-menu .nav-item {
            margin-bottom: var(--spacing-xs);
        }

        .mobile-menu .nav-link {
            display: block;
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .mobile-menu .nav-link:hover {
            background: var(--accent-beige);
            color: var(--text-primary);
        }

        .mobile-menu .nav-link.active {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }

        .mobile-menu .logout-btn {
            width: 100%;
            margin-top: var(--spacing-xs);
            text-align: center;
        }
        
        /* Main Content Area */
        .main-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            padding: var(--spacing-xl);
            min-height: calc(100vh - var(--spacing-xl));
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            position: relative;
            z-index: 1001;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .content-header {
            margin-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--accent-beige);
            padding-bottom: var(--spacing-md);
        }
        
        .header h1 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .user-info {
            background: var(--accent-beige);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.95rem;
            box-shadow: var(--shadow-soft);
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }
        
        /* Removed user avatar styling */
        
        .logout-btn {
            background: var(--rose-dusty);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background: #d8a593;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .session-form {
            background: var(--bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--spacing-lg);
            border: 2px solid var(--accent-beige);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: var(--font-body);
        }
        
        input, textarea, select {
            padding: var(--spacing-sm);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }

        /* Photography Management System datetime input styling */
        input[type="datetime-local"] {
            position: relative;
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            cursor: pointer;
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: var(--gold-muted);
            border-radius: var(--border-radius-sm);
            padding: 4px;
            cursor: pointer;
            opacity: 0.8;
        }

        input[type="datetime-local"]::-webkit-datetime-edit {
            color: var(--text-primary);
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-light);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--gold-muted);
            box-shadow: 0 0 0 3px rgba(193, 163, 94, 0.2);
            transform: translateY(-1px);
        }
        
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: var(--spacing-xs);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--gold-muted);
            color: var(--bg-secondary);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: #a68d4a;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn-secondary {
            background: var(--rose-dusty);
            color: var(--text-primary);
            border: 2px solid var(--accent-beige);
        }
        
        .btn-secondary:hover {
            background: #d8a593;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn-danger {
            background: rgba(0, 0, 0, 0.7);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.4);
        }
        
        .btn-danger:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);
        }
        
        /* ALL session action buttons - gold background with dark text and bold font like Email Client */
        .btn-edit, .btn-calendar, .btn-gallery-ready, .btn-call, 
        .btn-text, .btn-gallery, .btn-warning, .btn-contract, .btn-success,
        .btn-invoice, .btn-email, .btn-secondary {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            border: 1px solid rgba(212, 175, 55, 0.4);
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .btn-edit:hover, .btn-calendar:hover, .btn-gallery-ready:hover, 
        .btn-call:hover, .btn-text:hover, .btn-gallery:hover,
        .btn-warning:hover, .btn-contract:hover, .btn-success:hover,
        .btn-invoice:hover, .btn-email:hover, .btn-secondary:hover {
            background: linear-gradient(135deg, #f4e4bc 0%, #d4af37 100%);
            color: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            border-color: rgba(212, 175, 55, 0.6);
        }
        
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            overflow: visible !important;
            z-index: auto;
        }
        
        /* Photography Management System Session List View Styles */
        .session-list-item {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .session-list-item:hover {
            border-color: var(--gold-muted);
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .session-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--accent-beige);
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--cream-warm) 100%);
        }

        .session-info {
            flex: 1;
        }

        .client-name {
            font-size: 1.4em;
            color: var(--gold-muted);
            margin: 0 0 var(--spacing-xs) 0;
            font-weight: 600;
            font-family: var(--font-heading);
        }

        .session-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.9em;
            color: var(--text-secondary);
            flex-wrap: wrap;
            font-family: var(--font-body);
        }

        .session-meta span {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .session-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-location {
            color: var(--accent-sage);
        }

        .session-price {
            color: var(--gold-muted);
            font-weight: 600;
            font-size: 1.1em;
        }

        .expand-icon {
            font-size: 1.2em;
            color: var(--gold-muted);
            transition: transform 0.3s ease;
            min-width: 30px;
            text-align: center;
        }

        .session-details {
            padding: var(--spacing-lg);
            border-top: 2px solid var(--accent-beige);
            background: linear-gradient(135deg, var(--cream-warm) 0%, var(--bg-primary) 100%);
            margin-top: var(--spacing-md);
            border-radius: var(--border-radius-sm);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .detail-section h4 {
            color: var(--gold-muted);
            font-family: var(--font-heading);
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--accent-sage);
            padding-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        .detail-item {
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
            color: var(--text-primary);
        }

        .detail-item strong {
            color: var(--gold-muted);
            margin-right: var(--spacing-xs);
            font-weight: 600;
        }

        .quick-action-btn {
            background: var(--gold-muted);
            color: var(--bg-primary);
            border: 1px solid var(--accent-beige);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-full);
            margin-left: var(--spacing-sm);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--cream-warm);
            color: var(--gold-muted);
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .action-btn.premium {
            background: linear-gradient(135deg, #d4af37, #f4e4bc);
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            border: 2px solid #d4af37;
        }

        .action-btn.premium:hover {
            background: linear-gradient(135deg, #f4e4bc, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .action-btn.premium:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.delete-btn {
            background: linear-gradient(135deg, #dc3545, #ff6b7a);
            color: white;
        }

        .action-btn.delete-btn:hover {
            background: linear-gradient(135deg, #c82333, #ff5161);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .session-meta {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .session-list-header {
                padding: 15px 20px;
            }

            .session-details {
                padding: 20px;
            }
        }
        
        .session-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--gold-muted);
        }
        
        .session-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .session-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--gold-muted);
            letter-spacing: -0.01em;
            font-family: var(--font-heading);
        }
        
        .session-type {
            background: linear-gradient(135deg, var(--gold-muted) 0%, var(--cream-warm) 100%);
            color: var(--text-primary);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--border-radius-full);
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: 1px solid var(--accent-beige);
        }
        
        .session-details {
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .detail-label {
            font-weight: 600;
            width: 90px;
            color: var(--gold-muted);
            font-size: 0.9em;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-weight: 400;
        }
        
        .session-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .session-actions {
                grid-template-columns: 1fr;
            }
        }
        

        


        /* Clean Gallery Grid - No Conflicts */
        #galleryGrid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 20px 0;
            width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #galleryGrid > div {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #f5f5f5;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        #galleryGrid > div:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        #galleryGrid img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            display: block;
        }



        /* Mobile responsive gallery adjustments */
        @media (max-width: 768px) {
            #galleryGrid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            #galleryGrid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        /* Gallery button styles */
        #galleryGrid .photo-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        #galleryGrid > div:hover .photo-delete-btn {
            opacity: 1;
        }

        #galleryGrid .photo-delete-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        #galleryGrid .photo-filename {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.8em;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        #galleryGrid > div:hover .photo-filename {
            opacity: 1;
        }
        
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .upload-modal.active {
            display: flex;
        }
        
        .upload-content {
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #f5f5f5;
        }
        
        .upload-area {
            border: 3px dashed rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0, 0, 0, 0.6);
            color: #f5f5f5;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .photo-count {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #f5f5f5;
        }
        
        .progress-bar-container {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #d4af37, #f4e4bc);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .upload-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .file-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .file-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }
        
        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .file-progress-name {
            flex: 1;
            font-size: 0.9em;
            color: #4a5568;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-progress-bar {
            background: #e2e8f0;
            border-radius: 6px;
            height: 6px;
            width: 100px;
            overflow: hidden;
        }
        
        .file-progress-fill {
            background: #48bb78;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .file-progress-status {
            font-size: 0.8em;
            color: #48bb78;
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }
        
        .admin-checkboxes {
            background: var(--cream-warm);
            border: 2px solid var(--accent-beige);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            box-shadow: var(--shadow-soft);
        }
        
        .admin-checkboxes h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--gold-muted);
            font-size: 1.1em;
            font-weight: 600;
            font-family: var(--font-heading);
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
        }
        
        .checkbox-group:hover {
            background: var(--accent-beige);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--gold-muted);
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .upload-limits-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #234e52;
        }
        
        .upload-limits-info h4 {
            margin: 0 0 8px 0;
            color: #065f46;
        }
        
        .upload-limits-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .batch-upload-info {
            background: #fef7e0;
            border: 1px solid #f6cc73;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #744210;
            font-size: 0.9rem;
        }
        
        /* Payment Plan Styles */
        .payment-plan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .payment-plan-modal.active {
            display: flex;
        }
        
        .payment-plan-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .payment-plan-form {
            display: grid;
            gap: 20px;
        }
        
        .payment-plan-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .payment-plan-summary {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .payment-plan-summary h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }
        
        .payment-schedule {
            margin: 15px 0;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .payment-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .payment-status.pending {
            background: #fef7e0;
            color: #744210;
        }
        
        .payment-status.paid {
            background: #dcfce7;
            color: #166534;
        }
        
        .payment-status.overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .payment-plan-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #234e52;
        }
        
        .payment-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 10px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1);
            gap: 6px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: #f5f5f5;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.01em;
        }

        .nav-tab:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
            color: #1a1a1a;
            font-weight: 600;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        /* Tab Content Areas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Website Builder Styles */
        .website-builder-container {
            max-width: 100%;
            margin: 0;
        }

        .builder-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .builder-header h2 {
            color: #d4af37;
            margin-bottom: 8px;
        }

        .builder-header p {
            color: #f5f5f5;
            font-size: 1.1rem;
        }

        .website-toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
            flex-wrap: wrap;
        }

        .builder-interface {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            min-height: 800px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.1);
        }

        /* Left Sidebar - Components */
        .builder-sidebar {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-right: 1px solid rgba(212, 175, 55, 0.2);
            overflow-y: auto;
        }

        .builder-sidebar h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .component-category {
            margin-bottom: 25px;
        }

        .component-category h4 {
            color: #d4af37;
            font-size: 0.9rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .component-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            color: #f5f5f5;
        }

        .component-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
            transform: translateX(5px);
            color: #d4af37;
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .component-item span {
            font-weight: 500;
            color: #2d3748;
        }

        /* Center Canvas */
        .builder-canvas {
            background: white;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .canvas-header h3 {
            color: #2d3748;
            margin: 0;
        }

        .canvas-controls {
            display: flex;
            gap: 8px;
        }

        .canvas-control {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .canvas-control:hover,
        .canvas-control.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .canvas-viewport {
            flex: 1;
            padding: 20px;
            background: #e2e8f0;
            overflow: auto;
        }

        .website-canvas {
            background: white;
            min-height: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .website-canvas.desktop {
            max-width: 1200px;
        }

        .website-canvas.tablet {
            max-width: 768px;
        }

        .website-canvas.mobile {
            max-width: 375px;
        }

        .drop-zone {
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            margin: 20px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .drop-zone-message {
            text-align: center;
            color: #666;
        }

        .drop-zone-message h3 {
            margin-bottom: 12px;
            color: #2d3748;
        }

        .drop-zone-message p {
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .quick-start-templates {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .template-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .template-btn.legacy-style {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            border: 2px solid #d4af37;
        }

        .template-btn.modern-style {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .template-btn.elegant-style {
            background: linear-gradient(135deg, #2c1810 0%, #8b4513 100%);
            border: 2px solid #ddd6c1;
        }

        /* Right Sidebar - Properties */
        .builder-properties {
            background: white;
            padding: 20px;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .builder-properties h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .no-selection {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        /* Website List */
        .websites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .website-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .website-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .website-preview {
            width: 100%;
            height: 200px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 2rem;
        }

        .website-info h4 {
            margin: 0 0 8px 0;
            color: #2d3748;
        }

        .website-info p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .website-actions {
            display: flex;
            gap: 10px;
        }

        .website-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        /* Component Wrapper Styles */
        .component-wrapper {
            position: relative;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .component-wrapper:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Gallery hover effects */
        .component-wrapper:hover [style*="aspect-ratio"] > [style*="position: absolute"] {
            transform: translateY(0) !important;
        }

        .component-wrapper:hover [style*="aspect-ratio"]:hover {
            transform: scale(1.05);
        }

        .component-wrapper:hover [style*="opacity: 0"]:hover {
            opacity: 1 !important;
        }

        /* Properties Panel Styles */
        .property-section {
            padding: 15px 0;
        }

        .property-section h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .property-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
        }

        .property-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            cursor: pointer;
        }

        .property-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .property-group input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .property-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .property-actions .btn {
            width: 100%;
            justify-content: center;
        }

        /* Template Loading Animation */
        .template-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        .template-loading h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .builder-interface {
                grid-template-columns: 200px 1fr 250px;
            }
        }

        @media (max-width: 768px) {
            .builder-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                height: auto;
                min-height: 100vh;
            }
            
            .builder-sidebar,
            .builder-properties {
                max-height: 250px;
                overflow-y: auto;
                position: relative;
                z-index: 10;
            }
            
            .builder-sidebar {
                order: 1;
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                padding: 15px;
            }
            
            .builder-canvas {
                order: 2;
                padding: 10px;
                min-height: 400px;
            }
            
            .builder-properties {
                order: 3;
                background: #f8fafc;
                border-top: 1px solid #e2e8f0;
                padding: 15px;
            }
            
            .website-toolbar {
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px;
            }
            
            .canvas-controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .canvas-control {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .quick-start-templates {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .template-btn {
                width: 200px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .component-library h4,
            .builder-properties h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .component-category {
                margin-bottom: 20px;
            }
            
            .component-item {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .website-canvas {
                min-height: 300px;
                border-radius: 8px;
            }
            
            .website-canvas.mobile {
                max-width: 375px;
                margin: 0 auto;
            }
            
            .website-canvas.tablet {
                max-width: 768px;
                margin: 0 auto;
            }
            
            .drop-zone {
                min-height: 300px;
            }
            
            .drop-zone-message h3 {
                font-size: 1.5rem;
            }
            
            .drop-zone-message p {
                font-size: 1rem;
            }
            
            /* Mobile-friendly component editing */
            .component-wrapper {
                outline: none !important;
                border: 2px solid transparent;
                margin-bottom: 1px;
                position: relative;
            }
            
            .component-wrapper.selected {
                border-color: #667eea !important;
                background: rgba(102, 126, 234, 0.05);
            }
            
            .component-wrapper::after {
                content: 'âœŽ Tap to Edit';
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(102, 126, 234, 0.9);
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.7rem;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }
            
            .component-wrapper:hover::after,
            .component-wrapper.selected::after {
                opacity: 1;
            }
        }
        
        @media (max-width: 480px) {
            .builder-sidebar,
            .builder-properties {
                max-height: 200px;
            }
            
            .website-toolbar {
                padding: 8px;
            }
            
            .canvas-control {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .template-btn {
                width: 180px;
                padding: 10px 15px;
                font-size: 0.8rem;
            }
            
            .component-item {
                padding: 10px;
                font-size: 0.8rem;
            }
        }

        /* Revolutionary Website Builder Styles */
        .revolutionary-website-builder {
            padding: 0;
            width: 100%;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .builder-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .builder-mode-switch {
            display: flex;
            gap: 5px;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 10px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .builder-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: #667eea;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Template Gallery Mode */
        .template-gallery-mode {
            display: none;
            padding: 40px 20px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .template-gallery-mode.active {
            display: block;
        }

        .template-hero {
            text-align: center;
            margin-bottom: 40px;
        }

        .template-hero h2 {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .template-hero p {
            font-size: 1.2rem;
            color: #666;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .template-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .template-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .template-preview {
            height: 250px;
            position: relative;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .legacy-preview {
            background: linear-gradient(135deg, #1a1a1a 0%, #8b7355 100%);
            color: #d4af37;
        }

        .modern-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .elegant-preview {
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);
            color: #FDF5E6;
        }

        .legacy-elite-preview {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2c1810 100%);
            color: #d4af37;
            position: relative;
            overflow: hidden;
        }

        .legacy-elite-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .legacy-elite-preview .preview-tagline {
            font-size: 0.9rem;
            font-style: italic;
            color: rgba(212, 175, 55, 0.8);
            text-align: center;
            margin: 10px 0;
        }

        .legacy-photo-1 {
            background: linear-gradient(45deg, #8b7355, #d4af37);
            position: relative;
        }

        .legacy-photo-2 {
            background: linear-gradient(45deg, #2c1810, #8b7355);
        }

        .legacy-photo-3 {
            background: linear-gradient(45deg, #d4af37, #f4e4bc);
        }

        .legacy-elite-btn {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%) !important;
            color: #1a1a1a !important;
            font-weight: 700 !important;
            text-shadow: none !important;
        }

        .legacy-elite-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 28px rgba(212, 175, 55, 0.4) !important;
        }

        .preview-header {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }

        .preview-hero {
            font-size: 2rem;
            font-weight: 300;
            text-align: center;
            margin: 20px 0;
        }

        .preview-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: auto;
        }

        .preview-photo {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .template-info {
            padding: 25px;
        }

        .template-info h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .template-info p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .template-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .feature-tag {
            background: #f1f3f4;
            color: #5f6368;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .use-template-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .use-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* Custom Builder Mode */
        .custom-builder-mode {
            display: none;
            height: calc(100vh - 200px);
        }

        .custom-builder-mode.active {
            display: block;
        }

        .builder-interface {
            display: grid;
            grid-template-columns: 300px 1fr 280px;
            height: 100%;
            background: #f8fafc;
        }

        .builder-sidebar {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
        }

        .ai-section, .branding-section, .component-section {
            margin-bottom: 30px;
        }

        .ai-section h3, .branding-section h3, .component-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .ai-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .ai-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .branding-control {
            margin-bottom: 15px;
        }

        .branding-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .logo-upload, .brand-input, .font-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .logo-preview {
            margin-top: 8px;
            text-align: center;
            min-height: 40px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-input-group {
            text-align: center;
        }

        .color-input-group label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .color-input {
            width: 100%;
            height: 35px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .component-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .component-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .component-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .builder-canvas {
            display: flex;
            flex-direction: column;
            background: #f8fafc;
        }

        .canvas-controls {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .device-controls {
            display: flex;
            gap: 8px;
        }

        .device-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .device-btn.active {
            background: #667eea;
            color: white;
        }

        .website-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .website-content {
            min-height: 100%;
            position: relative;
        }

        .canvas-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            text-align: center;
        }

        .canvas-placeholder h2 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .smart-guides {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .builder-properties {
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #e2e8f0;
        }

        .builder-properties h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .property-panel .no-selection {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .builder-interface {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        @media (max-width: 768px) {
            .builder-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .builder-sidebar,
            .builder-properties {
                max-height: 200px;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .builder-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .builder-header h2 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }
        
        .builder-header p {
            color: #4a5568;
            font-size: 1.2rem;
        }
        
        /* Template Selection Styles */
        .template-selection {
            margin-bottom: 40px;
        }
        
        .template-selection h3 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        .photography-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .template-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .template-preview {
            margin-bottom: 20px;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .template-mockup {
            height: 100%;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        /* Template Mockup Styles */
        .legacy-mockup {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #D4AF37;
        }
        
        .modern-mockup {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        
        .romantic-mockup {
            background: linear-gradient(135deg, #fdf7f0 0%, #f7e6d7 100%);
            color: #8b5a3c;
        }
        
        .bold-mockup {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #ffffff;
        }
        
        .mockup-header {
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            border-bottom: 1px solid currentColor;
            padding-bottom: 5px;
        }
        
        .mockup-hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .mockup-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            height: 40px;
        }
        
        .mockup-photo {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .template-card h4 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }
        
        .template-card p {
            color: #4a5568;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }
        
        /* Website Customization Interface */
        .website-customization {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        .customization-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .customization-header h3 {
            color: #2d3748;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .website-actions {
            display: flex;
            gap: 10px;
        }
        
        .customization-interface {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 600px;
        }
        
        /* Customization Panel */
        .customization-panel {
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }
        
        .customization-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .customization-tab {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s;
        }
        
        .customization-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .customization-tab:hover:not(.active) {
            background: #f1f5f9;
        }
        
        .customization-section {
            padding: 20px;
            display: none;
            overflow-y: auto;
            flex: 1;
        }
        
        .customization-section.active {
            display: block;
        }
        
        .customization-section h4 {
            margin: 0 0 20px 0;
            color: #2d3748;
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input[type="color"] {
            height: 45px;
            padding: 5px;
            cursor: pointer;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .photo-upload-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
        }
        
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-preview-item {
            aspect-ratio: 1;
            background: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Live Preview */
        .website-preview {
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h4 {
            margin: 0;
            color: #2d3748;
        }
        
        .preview-controls {
            display: flex;
            gap: 8px;
        }
        
        .preview-control {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .preview-control:hover {
            background: #f7fafc;
        }
        
        .preview-control.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .website-preview-frame {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #f8fafc;
        }
        
        .website-preview-frame.desktop {
            padding: 20px;
        }
        
        .website-preview-frame.tablet {
            padding: 20px 60px;
        }
        
        .website-preview-frame.mobile {
            padding: 20px 100px;
        }
        
        /* Mobile Responsive for Photography Builder */
        @media (max-width: 768px) {
            .photography-templates {
                grid-template-columns: 1fr;
            }
            
            .customization-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .customization-panel {
                order: 1;
            }
            
            .website-preview {
                order: 2;
                min-height: 400px;
            }
            
            .customization-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .website-actions {
                justify-content: center;
            }
            
            .website-preview-frame.tablet,
            .website-preview-frame.mobile {
                padding: 20px;
            }
        }
        
        /* Workflow Status Styles */
        .workflow-status {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .workflow-status h4 {
            color: #d4af37;
            font-size: 1em;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .status-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #d4af37;
            cursor: pointer;
        }

        .status-item label {
            color: #f5f5f5;
            font-size: 0.9em;
            cursor: pointer;
            user-select: none;
        }

        .status-item input[type="checkbox"]:checked + label {
            color: #d4af37;
            font-weight: bold;
        }

        /* Dropdown Menu Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
            z-index: 2147483646 !important;
            isolation: isolate;
        }

        .dropdown-toggle {
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #1a1a1a;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .dropdown-toggle:hover {
            background: linear-gradient(135deg, #ffd700, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .dropdown-menu {
            position: absolute !important;
            top: calc(100% + 5px) !important;
            left: 0 !important;
            right: auto !important;
            background: #2a2a2a !important;
            border: 2px solid #d4af37 !important;
            border-radius: 8px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
            z-index: 2147483647 !important;
            display: none !important;
            overflow: visible !important;
            min-width: 200px !important;
            min-height: 50px !important;
            width: auto !important;
        }

        .dropdown-menu.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: #f5f5f5;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* Location Search Styles */
        .location-results {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 10000;
        }

        /* Dropdown Container */
        .dropdown-container {
            position: relative;
            display: inline-block;
            z-index: 10;
        }

        .location-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            color: #f5f5f5;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .location-result-item:last-child {
            border-bottom: none;
        }

        .location-result-item:hover {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
        }

        .location-result-item .location-name {
            font-weight: bold;
        }

        .location-result-item .location-details {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        /* Sunrise/Sunset Calendar Styles */
        .sunrise-calendar-container {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .sunrise-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .sunrise-header h2 {
            color: #d4af37;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .sunrise-controls {
            display: flex;
            gap: 20px;
            align-items: end;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .sunrise-results {
            margin-top: 30px;
        }

        .sunrise-card {
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.2);
        }

        .sunrise-times-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .time-card {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid #d4af37;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .time-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        .time-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .time-label {
            color: #d4af37;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .time-value {
            color: #f5f5f5;
            font-size: 1.4em;
            font-weight: bold;
        }

        .photography-tips {
            background: rgba(212, 175, 55, 0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .photography-tips h4 {
            color: #d4af37;
            margin-bottom: 15px;
        }

        .photography-tips p {
            margin-bottom: 8px;
            color: #f5f5f5;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .sessions-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .session-actions { flex-direction: column; }
            .btn { width: 100%; margin: 2px 0; }
            .checkbox-grid { grid-template-columns: 1fr; }
            
            .sunrise-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .sunrise-times-grid {
                grid-template-columns: 1fr;
            }
            
            .status-checkboxes {
                grid-template-columns: 1fr;
            }
        }

        /* Dropdown Menu Styles */
        .tools-dropdown {
            position: relative;
            margin: 20px 0;
            text-align: center;
        }

        #toolsToggle {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            padding: 12px 20px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-size: 1em;
            transition: all 0.2s ease;
        }

        #toolsToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        #toolsMenu {
            position: absolute;
            background-color: #2a2a2a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            top: 50px;
            width: 100%;
            left: 0;
            z-index: 99;
            border: 1px solid #444;
        }

        #toolsMenu a {
            display: block;
            padding: 12px 15px;
            color: #f5f5f5;
            text-decoration: none;
            border-bottom: 1px solid #444;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        #toolsMenu a:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #toolsMenu a:hover {
            background-color: #444;
            color: #d4af37;
            transform: translateX(5px);
        }

        .hidden {
            display: none;
        }

        /* Marketing Suite Styles */
        .marketing-suite-container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
        }

        .marketing-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .marketing-header h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .marketing-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .marketing-tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .marketing-tool-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .marketing-tool-card:hover {
            border-color: #d4af37;
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .marketing-tool-card .tool-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .marketing-tool-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .marketing-tool-card p {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Website Builder Styles */
        .website-builder-container {
            padding: 20px;
            background: #1a1a1a;
            border-radius: 12px;
            margin: 20px 0;
        }

        .builder-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .builder-header h2 {
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .builder-header p {
            color: #f5f5f5;
            font-size: 1.1em;
        }

        .builder-main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .builder-settings-panel {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #444;
        }

        .builder-settings-panel h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .builder-preview-panel {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #444;
            position: sticky;
            top: 20px;
        }

        .builder-preview-panel h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .preview-container {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .website-preview {
            width: 100%;
            min-height: 400px;
            position: relative;
        }

        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            text-align: center;
            font-style: italic;
        }

        .builder-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 30px;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #666, #888);
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .image-preview-container {
            text-align: center;
        }

        /* Theme Previews */
        .theme-clean {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #343a40;
        }

        .theme-gallery {
            background: linear-gradient(135deg, #212529, #343a40);
            color: #f8f9fa;
        }

        .theme-banner {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: #f8f9fa;
        }

        .theme-legacy {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            color: #f4e4bc;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .builder-main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .builder-preview-panel {
                position: static;
            }
        }

        /* Enhanced Client Dashboard Styles */
        .client-dashboard-controls {
            background: var(--bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-xl);
            border: 2px solid var(--accent-beige);
            box-shadow: var(--shadow-soft);
        }

        .search-and-filters {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .search-section {
            width: 100%;
        }

        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: var(--gold-muted);
            font-weight: 600;
            font-size: 0.9em;
            font-family: var(--font-heading);
        }

        .checkbox-filters {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .checkbox-filters label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            font-family: var(--font-body);
        }

        .checkbox-filters input[type="checkbox"] {
            accent-color: var(--gold-muted);
        }

        .filter-group select,
        .filter-group input[type="date"] {
            padding: var(--spacing-sm) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--accent-beige);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input[type="date"]:focus {
            border-color: var(--gold-muted);
            box-shadow: 0 0 0 3px rgba(193, 163, 94, 0.2);
        }

        .archive-and-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 2px solid var(--accent-beige);
        }

        .archive-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
            cursor: pointer;
            font-family: var(--font-body);
        }

        .archive-toggle input[type="checkbox"] {
            accent-color: var(--gold-muted);
        }

        .btn-secondary, .btn-primary {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #666, #888);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #1a1a1a;
        }

        /* Enhanced Session Card Styles */
        .session-card.archived {
            opacity: 0.6;
            border-left: 4px solid #999;
        }

        .session-card.hidden-by-filter {
            display: none !important;
        }

        .session-notes {
            background: var(--cream-warm);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin-top: var(--spacing-md);
            border: 2px solid var(--accent-beige);
            box-shadow: var(--shadow-soft);
        }

        .session-notes h4 {
            color: var(--gold-muted);
            margin-bottom: var(--spacing-sm);
            font-size: 1em;
            font-family: var(--font-heading);
        }

        .notes-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .notes-checklist label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
            font-size: 0.9em;
            cursor: pointer;
            font-family: var(--font-body);
        }

        .notes-textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #d4af37;
            background: #1a1a1a;
            color: #f5f5f5;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .archive-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        /* Mobile Responsive for Dashboard Controls */
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .checkbox-filters {
                flex-direction: column;
                gap: 8px;
            }
            
            .archive-and-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .archive-and-actions > * {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Hamburger Menu -->
        <div class="header">
            <div class="header-left">
                <button class="hamburger-menu" onclick="toggleMobileMenu()">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="logo">Photography Management System</div>
            </div>
            
            <div class="header-right">
                <div id="userInfo" class="user-info" style="display: block;">
                    <span id="userName">lance@thelegacyphotography.com</span>
                    <button onclick="firebaseLogout()" class="logout-btn">Sign Out</button>
                </div>
            </div>
            
            <!-- Mobile Dropdown Menu - inside header for proper positioning -->
        <div class="mobile-menu" id="mobileMenu">
            <nav class="nav-menu">
                <ul>
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="switchTab('clients'); closeMobileMenu();">
                            Sessions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('poses'); closeMobileMenu();">
                            Poses Gallery
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('marketing'); closeMobileMenu();">
                            Marketing Suite
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="switchTab('sunrise'); closeMobileMenu();">
                            Sunrise/Sunset
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/onboarding" target="_blank" class="nav-link">
                            Business Setup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="openStorefront(); closeMobileMenu();">
                            ðŸª Storefront Builder
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">

        <!-- Client Management Tab Content -->
        <div id="clientsTab" class="tab-content active">
            <div class="content-header">
                <h1>Session Management</h1>
                <p>Manage your photography sessions and client bookings</p>
            </div>
        
        <!-- ENHANCED CLIENT DASHBOARD CONTROLS -->
        <div class="client-dashboard-controls">
            <div class="search-and-filters">
                <!-- Real-time Search Bar -->
                <div class="search-section">
                    <input type="text" id="clientSearch" placeholder="Search clients by name, location, or email..." 
                           oninput="filterSessions()" style="width: 100%; padding: 12px; border-radius: var(--border-radius); border: 2px solid var(--gold-muted); background: var(--bg-primary); color: var(--text-primary); font-size: 16px; font-family: var(--font-body);">
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status Filters:</label>
                            <div class="checkbox-filters">
                                <label><input type="checkbox" id="filterContractSigned" onchange="filterSessions()"> Contract Signed</label>
                                <label><input type="checkbox" id="filterPaid" onchange="filterSessions()"> Paid</label>
                                <label><input type="checkbox" id="filterDelivered" onchange="filterSessions()"> Delivered</label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label for="sessionTypeFilter">Session Type:</label>
                            <select id="sessionTypeFilter" onchange="filterSessions()">
                                <option value="">All Types</option>
                                <option value="Wedding">Wedding</option>
                                <option value="Family">Family</option>
                                <option value="Senior">Senior</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Event">Event</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <input type="date" id="dateFromFilter" onchange="filterSessions()" placeholder="From">
                            <span>to</span>
                            <input type="date" id="dateToFilter" onchange="filterSessions()" placeholder="To">
                        </div>
                        
                        <div class="filter-group">
                            <label for="sortOptions">Sort By:</label>
                            <select id="sortOptions" onchange="sortSessions()">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="name-asc">Client Name (A-Z)</option>
                                <option value="name-desc">Client Name (Z-A)</option>
                                <option value="unpaid-first">Unpaid First</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Archive Toggle & Actions -->
                <div class="archive-and-actions">
                    <label class="archive-toggle">
                        <input type="checkbox" id="showArchivedToggle" onchange="toggleArchivedSessions()">
                        Show Archived Sessions
                    </label>
                    <button onclick="clearAllFilters()" class="btn-secondary">Clear Filters</button>
                    <button onclick="exportAllSessions()" class="btn-primary">ðŸ“„ Export All Sessions</button>
                </div>
            </div>
        </div>
        
        <!-- Session Form -->
        <div class="session-form">
            <h2>Add New Session</h2>
            <form id="sessionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <input type="text" id="sessionType" name="sessionType" required placeholder="Wedding, Portrait, etc.">
                    </div>
                    <div class="form-group">
                        <label for="dateTime">Date & Time</label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required placeholder="Session location">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" required placeholder="60">
                    </div>
                </div>
                
                <!-- Admin Workflow Checkboxes -->
                <div class="admin-checkboxes">
                    <h3>Admin Workflow Status</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contractSigned" name="contractSigned">
                            <label for="contractSigned">Contract Signed</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="paid" name="paid">
                            <label for="paid">Paid</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edited" name="edited">
                            <label for="edited">Edited</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="delivered" name="delivered">
                            <label for="delivered">Delivered</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sendReminder" name="sendReminder">
                            <label for="sendReminder">Send session reminder 24 hours before</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyGalleryReady" name="notifyGalleryReady">
                            <label for="notifyGalleryReady">Notify when gallery is ready</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Session</button>

            </form>
        </div>

        <!-- Sessions Display -->
        <div id="sessionsContainer" class="sessions-grid">
            <div class="empty-state">
                <h3>No sessions yet</h3>
                <p>Add your first photography session above!</p>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-content">
            <h3>Upload Photos</h3>
            
            <div class="upload-limits-info">
                <h4>ðŸ“ˆ Enhanced Upload Capacity</h4>
                <ul>
                    <li><strong>Unlimited file size</strong> - Upload RAW photos, high-res images</li>
                    <li><strong>Unlimited quantity</strong> - Upload entire photo shoots at once</li>
                    <li><strong>Batch processing</strong> - Large uploads handled automatically</li>
                    <li><strong>Progress tracking</strong> - Monitor individual file uploads</li>
                </ul>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <p>Click here or drag photos to upload</p>
                <p style="font-size: 0.9em; color: #718096; margin-top: 10px;">Supports unlimited photos of any size - JPG, PNG, RAW files welcome!</p>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
            <div id="uploadProgress" style="margin: 20px 0;">
                <div id="filePreview" style="margin-bottom: 15px;"></div>
                
                <!-- Enhanced Upload Progress Bar with Percentage Display -->
                <div id="uploadProgressContainer" style="display: none; margin-top: 20px; padding: 20px; background: rgba(212, 175, 55, 0.1); border-radius: 12px; border: 2px solid #d4af37; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);">
                    <div style="margin-bottom: 15px; color: #d4af37; font-weight: bold; text-align: center; font-size: 16px;" id="progressText">Starting Upload...</div>
                    
                    <!-- Progress Bar with Percentage -->
                    <div style="background: #2d2d2d; border-radius: 12px; padding: 4px; margin-bottom: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);">
                        <div id="progressBar" style="
                            background: linear-gradient(135deg, #d4af37 0%, #ffd700 50%, #d4af37 100%); 
                            height: 32px; 
                            border-radius: 8px; 
                            width: 0%; 
                            transition: width 0.3s ease; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            color: #1a1a1a; 
                            font-weight: bold; 
                            font-size: 16px;
                            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
                            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
                        ">0%</div>
                    </div>
                    
                    <div id="progressDetails" style="color: #d4af37; font-size: 14px; text-align: center; margin-bottom: 5px;">Preparing files...</div>
                    <div style="color: #999; font-size: 12px; text-align: center;" id="progressSubDetails">Please wait while we process your upload</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="uploadBtn" onclick="startUpload()" style="display: none;">Upload Selected Photos</button>
                <button class="btn btn-secondary" onclick="closeUploadModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="upload-modal">
        <div class="upload-content" style="max-width: 1200px;">
            <h3 id="galleryTitle">ðŸ“· Session Gallery</h3>
            
            <div class="gallery-content" style="width: 100%; overflow: hidden; box-sizing: border-box;">
                <div id="galleryGrid" class="photo-gallery-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 100%; box-sizing: border-box;"></div>
                <div id="galleryEmpty" class="empty-gallery" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <h4>No Photos Yet</h4>
                    <p>Upload photos to this session to see them here.</p>
                </div>
            </div>
            
            <!-- Enhanced Gallery Tip Panel -->
            <div id="galleryTipPanel" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeGalleryModal()">Close Gallery</button>
            </div>
        </div>
    </div>

    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3>Create Payment Plan</h3>
            
            <div class="payment-plan-form">
                <div class="payment-plan-grid">
                    <div class="form-group">
                        <label for="planTotalAmount">Total Amount ($)</label>
                        <input type="number" id="planTotalAmount" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="planStartDate">Start Date</label>
                        <input type="date" id="planStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="planEndDate">End Date</label>
                        <input type="date" id="planEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="planReminderDays">Reminder Days Before</label>
                        <select id="planReminderDays">
                            <option value="1">1 day</option>
                            <option value="3" selected>3 days</option>
                            <option value="7">1 week</option>
                        </select>
                    </div>
                </div>
                
                <div class="payment-plan-summary" id="paymentPlanSummary" style="display: none;">
                    <h4>ðŸ“‹ Payment Plan Summary</h4>
                    <div id="paymentSummaryDetails"></div>
                    <div class="payment-schedule" id="paymentSchedulePreview"></div>
                </div>
                
                <div class="payment-plan-info">
                    <h4>â„¹ï¸ How Payment Plans Work</h4>
                    <ul>
                        <li>Automatically calculates equal monthly payments</li>
                        <li>Sends Stripe invoices each month via email</li>
                        <li>Tracks payments and sends reminders</li>
                        <li>Updates session status when fully paid</li>
                    </ul>
                </div>
                
                <div class="payment-actions">
                    <button class="btn btn-primary" id="createPaymentPlanBtn" onclick="createPaymentPlan()">Create Payment Plan</button>
                    <button class="btn btn-secondary" onclick="calculatePaymentPreview()">Preview Payments</button>
                    <button class="btn btn-secondary" onclick="closePaymentPlanModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Plan View Modal -->
    <div id="paymentPlanViewModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3 id="paymentPlanViewTitle">Payment Plan Details</h3>
            
            <div id="paymentPlanViewContent">
                <!-- Payment plan details will be loaded here -->
            </div>
            
            <div class="payment-actions">
                <button class="btn btn-primary" onclick="processAutomatedPayments()">Process All Due Payments</button>
                <button class="btn btn-secondary" onclick="closePaymentPlanViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let sessions = [];
        let currentUploadSessionId = null;
        let currentPaymentPlanSessionId = null;

        // Allow both past and future dates for historical session entries
        function setMinDateTime() {
            // Remove any date restrictions to allow past dates for historical entries
            const dateTimeInput = document.getElementById('dateTime');
            if (dateTimeInput) {
                dateTimeInput.removeAttribute('min');
                dateTimeInput.removeAttribute('max');
                
                // Ensure the datetime picker is clickable and functional
                dateTimeInput.style.cursor = 'pointer';
                
                // Remove showPicker() calls due to cross-origin security restrictions
                // The native datetime-local input will show picker automatically when clicked
                dateTimeInput.addEventListener('click', function() {
                    this.focus();
                });
                
                // Add manual focus trigger for better compatibility
                dateTimeInput.addEventListener('focus', function() {
                    // Let the browser handle the native datetime picker
                });
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            setupEventListeners();
            setMinDateTime(); // Allow all dates for historical entries
            initializeSunriseCalendar(); // Initialize sunrise calendar
            
            // Ensure contract modal is hidden on page load
            const contractModal = document.getElementById('contractModal');
            if (contractModal) {
                contractModal.style.display = 'none';
            }
        });

        function setupEventListeners() {
            document.getElementById('sessionForm').addEventListener('submit', addSession);
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Add form reset button functionality
            const resetBtn = document.querySelector('button[type="reset"]');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        setMinDateTime(); // Keep dates unrestricted for historical entries
                        editingSessionId = null;
                        const submitBtn = document.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Add Session';
                    }, 10);
                });
            }
        }

        async function addSession(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on',
                sendReminder: formData.get('sendReminder') === 'on',
                notifyGalleryReady: formData.get('notifyGalleryReady') === 'on',
                photos: []
            };

            try {
                if (editingSessionId) {
                    // Update existing session
                    const response = await fetch(`/api/sessions/${editingSessionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const updatedSession = await response.json();
                        const sessionIndex = sessions.findIndex(s => s.id === editingSessionId);
                        if (sessionIndex !== -1) {
                            sessions[sessionIndex] = updatedSession;
                        }
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session updated successfully!', 'success');
                    } else {
                        showMessage('Failed to update session', 'error');
                    }
                } else {
                    // Create new session
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const newSession = await response.json();
                        sessions.unshift(newSession);
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session added successfully!', 'success');
                        
                        // Trigger milestone celebration for new session
                        celebrateMilestone('session_created', newSession.clientName);
                    } else {
                        showMessage('Failed to add session', 'error');
                    }
                }
            } catch (error) {
                console.error('Error processing session:', error);
                showMessage('Error processing session', 'error');
            }
        }

        function resetForm(form) {
            form.reset();
            editingSessionId = null;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Session';
            
            // Keep date unrestricted to allow historical entries
            setMinDateTime();
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                } else if (response.status === 403) {
                    const data = await response.json();
                    if (data.requiresSubscription) {
                        showSubscriptionModal(data.message);
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Add your first photography session above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session-list-item" data-session-id="${session.id}" onclick="toggleSessionDetails('${session.id}')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">${session.clientName}</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar ${formatDateTime(session.dateTime)}</span>
                                <span class="session-location">ðŸ“ ${session.location}</span>
                                <span class="session-price">Money $${session.price}</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-${session.id}">â–¼</div>
                    </div>
                    
                    <div class="session-details" id="details-${session.id}" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:${session.email}" style="color: #d4af37;">${session.email}</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">${session.phoneNumber}</span>
                                    <button onclick="callClient('${session.phoneNumber}'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('${session.phoneNumber}', '${session.clientName}', '${session.id}'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> ${session.sessionType}
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> ${session.duration} hours
                                </div>
                                ${session.notes ? `
                                    <div class="detail-item">
                                        <strong>Notes:</strong> ${session.notes}
                                    </div>
                                ` : ''}
                                ${session.hasPaymentPlan ? `
                                    <div class="detail-item">
                                        <strong>Payment Plan:</strong> $${session.monthlyPayment}/month (${session.paymentsRemaining || 0} remaining)
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>ðŸ“‹ Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_${session.id}" ${session.contractSigned ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_${session.id}">Document Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_${session.id}" ${session.paid ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_${session.id}">Money Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_${session.id}" ${session.edited ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_${session.id}">âœï¸ Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_${session.id}" ${session.delivered ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_${session.id}">Package Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_${session.id}" ${session.sendReminder ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_${session.id}">â° Send Reminder</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="notifyGalleryReady_${session.id}" ${session.notifyGalleryReady ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'notifyGalleryReady', this.checked); event.stopPropagation();">
                                    <label for="notifyGalleryReady_${session.id}">Image Notify Gallery Ready</label>
                                </div>
                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="editSession('${session.id}'); event.stopPropagation();" class="action-btn edit-btn">âœï¸ Edit</button>
                                <button onclick="openUploadModal('${session.id}'); event.stopPropagation();" class="action-btn upload-btn">Photo Upload${session.photos && session.photos.length ? ` (${session.photos.length})` : ''}</button>
                                <button onclick="viewSessionGallery('${session.id}'); event.stopPropagation();" class="action-btn gallery-btn">Image Gallery</button>
                                <button onclick="copyGalleryUrl('${session.id}'); event.stopPropagation();" class="action-btn copy-btn">ðŸ”— Copy URL</button>
                                <button onclick="addToCalendar('${session.id}'); event.stopPropagation();" class="action-btn calendar-btn">Calendar Calendar</button>
                                <button onclick="openEmailClient('${session.id}'); event.stopPropagation();" class="action-btn email-btn">Email Email</button>
                                <button onclick="openContractModal('${session.id}'); event.stopPropagation();" class="action-btn contract-btn">Document Contract</button>
                                ${session.hasPaymentPlan ? `
                                    <button onclick="viewPaymentPlan('${session.id}'); event.stopPropagation();" class="action-btn payment-btn">Payment Payment Plan</button>
                                ` : `
                                    <button onclick="sendInvoice('${session.id}'); event.stopPropagation();" class="action-btn invoice-btn">Payment Invoice</button>
                                    <button onclick="sendDepositInvoice('${session.id}'); event.stopPropagation();" class="action-btn deposit-btn">Money Deposit</button>
                                    <button onclick="openPaymentPlanModal('${session.id}'); event.stopPropagation();" class="action-btn plan-btn">Chart Payment Plan</button>
                                `}
                                <button onclick="exportSessionPDF('${session.id}'); event.stopPropagation();" class="export-btn">ðŸ“„ Export PDF</button>
                                <button onclick="toggleArchiveSession('${session.id}'); event.stopPropagation();" class="archive-btn">${session.archived ? 'ðŸ“‚ Unarchive' : 'ðŸ“ Archive'}</button>
                                <button onclick="deleteSession('${session.id}'); event.stopPropagation();" class="action-btn delete-btn">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Document Session Notes & Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" ${session.printsOrdered ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" ${session.specialEdits ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" ${session.clientFeedback ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" ${session.socialMediaApproval ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" ${session.retouchingNeeded ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" ${session.backupCompleted ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." 
                                     onchange="updateSessionNotes('${session.id}', 'sessionNotes', this.value); event.stopPropagation();"
                                     onclick="event.stopPropagation();">${session.sessionNotes || ''}</textarea>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        ${session.delivered ? generateTipPanel(session.id) : ''}
                    </div>
                </div>
            `).filter(sessionHTML => {
                // Extract session ID from the HTML to determine visibility
                const match = sessionHTML.match(/data-session-id="([^"]+)"/);
                if (!match) return false;
                const sessionId = match[1];
                const session = sessions.find(s => s.id === sessionId);
                return session && isSessionVisible(session);
            }).join('');
        }

        function toggleSessionDetails(sessionId) {
            const details = document.getElementById(`details-${sessionId}`);
            const expandIcon = document.getElementById(`expand-${sessionId}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                expandIcon.textContent = 'â–²';
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                expandIcon.textContent = 'â–¼';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        function openUploadModal(sessionId) {
            currentUploadSessionId = sessionId;
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            currentUploadSessionId = null;
            selectedFiles = [];
            
            // Reset all upload interface elements
            const filePreview = document.getElementById('filePreview');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const fileInput = document.getElementById('fileInput');
            
            if (filePreview) filePreview.innerHTML = '';
            if (uploadStatus) uploadStatus.style.display = 'none';
            if (uploadBtn) uploadBtn.style.display = 'none';
            if (uploadProgress) uploadProgress.style.display = 'none';
            if (fileInput) fileInput.value = '';
            
            // Clear any existing progress intervals
            if (window.uploadProgressIntervals) {
                window.uploadProgressIntervals.forEach(interval => clearInterval(interval));
                window.uploadProgressIntervals = [];
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
                document.getElementById('fileInput').files = e.dataTransfer.files;
            }
        }

        let selectedFiles = [];

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
            }
        }

        function showFilePreview(files) {
            const filePreview = document.getElementById('filePreview');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (files.length === 0) {
                filePreview.innerHTML = '';
                uploadBtn.style.display = 'none';
                return;
            }

            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
            
            filePreview.innerHTML = `
                <h4>Selected Photos (${files.length}) - ${totalSizeMB}MB Total</h4>
                <div class="file-preview-grid">
                    ${files.map((file, index) => {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                        return `
                            <div class="file-preview-item">
                                <img src="${URL.createObjectURL(file)}" alt="Preview">
                                <button class="file-preview-remove" onclick="removeFile(${index})">&times;</button>
                                <div style="font-size: 0.7em; color: #666; margin-top: 2px;">${fileSizeMB}MB</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${files.length > 20 ? '<div class="batch-upload-info">Large batch detected - will process in optimized chunks</div>' : ''}
            `;
            
            uploadBtn.style.display = 'inline-block';
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            showFilePreview(selectedFiles);
        }

        // Search ENHANCED CLIENT MANAGEMENT FUNCTIONS

        // Filter and Search Functionality
        function filterSessions() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const contractFilter = document.getElementById('filterContractSigned').checked;
            const paidFilter = document.getElementById('filterPaid').checked;
            const deliveredFilter = document.getElementById('filterDelivered').checked;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            sessions.forEach(session => {
                const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
                if (!sessionCard) return;

                let isVisible = true;

                // Search filter
                if (searchTerm) {
                    const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        isVisible = false;
                    }
                }

                // Status filters
                if (contractFilter && !session.contractSigned) isVisible = false;
                if (paidFilter && !session.paid) isVisible = false;
                if (deliveredFilter && !session.delivered) isVisible = false;

                // Session type filter
                if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) isVisible = false;

                // Date range filter
                if (dateFromFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate < dateFromFilter) isVisible = false;
                }
                if (dateToFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate > dateToFilter) isVisible = false;
                }

                // Archive filter
                const showArchived = document.getElementById('showArchivedToggle').checked;
                if (session.archived && !showArchived) isVisible = false;

                sessionCard.classList.toggle('hidden-by-filter', !isVisible);
            });
        }

        function isSessionVisible(session) {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const contractFilter = document.getElementById('filterContractSigned')?.checked || false;
            const paidFilter = document.getElementById('filterPaid')?.checked || false;
            const deliveredFilter = document.getElementById('filterDelivered')?.checked || false;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter')?.value || '';
            const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
            const dateToFilter = document.getElementById('dateToFilter')?.value || '';
            const showArchived = document.getElementById('showArchivedToggle')?.checked || false;

            // Search filter
            if (searchTerm) {
                const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }

            // Status filters
            if (contractFilter && !session.contractSigned) return false;
            if (paidFilter && !session.paid) return false;
            if (deliveredFilter && !session.delivered) return false;

            // Session type filter
            if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) return false;

            // Date range filter
            if (dateFromFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate < dateFromFilter) return false;
            }
            if (dateToFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate > dateToFilter) return false;
            }

            // Archive filter
            if (session.archived && !showArchived) return false;

            return true;
        }

        // Sort Functionality
        function sortSessions() {
            const sortOption = document.getElementById('sortOptions').value;
            
            sessions.sort((a, b) => {
                switch (sortOption) {
                    case 'date-desc':
                        return new Date(b.dateTime) - new Date(a.dateTime);
                    case 'date-asc':
                        return new Date(a.dateTime) - new Date(b.dateTime);
                    case 'name-asc':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'unpaid-first':
                        if (a.paid === b.paid) return 0;
                        return a.paid ? 1 : -1;
                    default:
                        return 0;
                }
            });
            
            renderSessions();
        }

        // Archive Functionality
        async function toggleArchiveSession(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.archived = !session.archived;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    showMessage(session.archived ? 'Session archived successfully' : 'Session unarchived successfully', 'success');
                    renderSessions();
                } else {
                    session.archived = !session.archived; // Revert
                    showMessage('Error updating archive status', 'error');
                }
            } catch (error) {
                console.error('Error toggling archive:', error);
                showMessage('Error updating archive status', 'error');
            }
        }

        function toggleArchivedSessions() {
            renderSessions();
        }

        // Enhanced Notes Functionality
        async function updateSessionNotes(sessionId, field, value) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session[field] = value;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (!response.ok) {
                    showMessage('Error saving notes', 'error');
                }
            } catch (error) {
                console.error('Error updating session notes:', error);
                showMessage('Error saving notes', 'error');
            }
        }

        // PDF Export Functionality
        async function exportSessionPDF(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            try {
                // Create PDF content
                const pdfContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px;">
                        <h1 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 10px;">
                            Photography Session Summary
                        </h1>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                            <div>
                                <h2 style="color: #333;">Client Information</h2>
                                <p><strong>Name:</strong> ${session.clientName}</p>
                                <p><strong>Email:</strong> ${session.email}</p>
                                <p><strong>Phone:</strong> ${session.phoneNumber}</p>
                                <p><strong>Location:</strong> ${session.location}</p>
                            </div>
                            <div>
                                <h2 style="color: #333;">Session Details</h2>
                                <p><strong>Type:</strong> ${session.sessionType}</p>
                                <p><strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}</p>
                                <p><strong>Duration:</strong> ${session.duration} hours</p>
                                <p><strong>Price:</strong> $${session.price}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Workflow Status</h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <p>Document Contract Signed: ${session.contractSigned ? 'Success Yes' : 'Error No'}</p>
                                <p>Money Paid: ${session.paid ? 'Success Yes' : 'Error No'}</p>
                                <p>âœï¸ Edited: ${session.edited ? 'Success Yes' : 'Error No'}</p>
                                <p>Package Delivered: ${session.delivered ? 'Success Yes' : 'Error No'}</p>
                                <p>â° Send Reminder: ${session.sendReminder ? 'Success Yes' : 'Error No'}</p>
                                <p>Image Gallery Ready: ${session.notifyGalleryReady ? 'Success Yes' : 'Error No'}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Additional Checklist</h2>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <p>ðŸ–¨ï¸ Prints Ordered: ${session.printsOrdered ? 'Success Yes' : 'Error No'}</p>
                                <p>Star Special Edits: ${session.specialEdits ? 'Success Yes' : 'Error No'}</p>
                                <p>Message Client Feedback: ${session.clientFeedback ? 'Success Yes' : 'Error No'}</p>
                                <p>Mobile Social Media OK: ${session.socialMediaApproval ? 'Success Yes' : 'Error No'}</p>
                                <p>ðŸŽ¨ Retouching Needed: ${session.retouchingNeeded ? 'Success Yes' : 'Error No'}</p>
                                <p>ðŸ’¾ Backup Completed: ${session.backupCompleted ? 'Success Yes' : 'Error No'}</p>
                            </div>
                        </div>
                        
                        ${session.sessionNotes ? `
                            <div style="margin: 30px 0;">
                                <h2 style="color: #333;">Session Notes</h2>
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #d4af37;">
                                    ${session.sessionNotes.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 50px; text-align: center; color: #666; font-size: 12px;">
                            <p>Generated on ${new Date().toLocaleDateString()} | Photography Management System</p>
                        </div>
                    </div>
                `;

                // Create new window for PDF generation
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Session Summary - ${session.clientName}</title>
                        <style>
                            body { margin: 0; font-family: Arial, sans-serif; }
                            @media print { 
                                body { margin: 1in; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="no-print" style="text-align: center; padding: 20px;">
                            <button onclick="window.print()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                ðŸ“„ Print/Save as PDF
                            </button>
                        </div>
                        ${pdfContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                showMessage('PDF export opened in new window', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF export', 'error');
            }
        }

        // Export All Sessions
        function exportAllSessions() {
            const visibleSessions = sessions.filter(isSessionVisible);
            
            if (visibleSessions.length === 0) {
                showMessage('No sessions to export', 'error');
                return;
            }

            try {
                const csvContent = generateCSVExport(visibleSessions);
                downloadCSV(csvContent, `sessions-export-${new Date().toISOString().split('T')[0]}.csv`);
                showMessage(`Exported ${visibleSessions.length} sessions to CSV`, 'success');
            } catch (error) {
                console.error('Error exporting sessions:', error);
                showMessage('Error exporting sessions', 'error');
            }
        }

        function generateCSVExport(sessionsToExport) {
            const headers = [
                'Client Name', 'Email', 'Phone', 'Session Type', 'Date & Time', 'Location', 
                'Duration', 'Price', 'Contract Signed', 'Paid', 'Edited', 'Delivered',
                'Prints Ordered', 'Special Edits', 'Client Feedback', 'Social Media OK',
                'Retouching Needed', 'Backup Completed', 'Session Notes', 'Archived'
            ];

            const csvRows = [headers.join(',')];

            sessionsToExport.forEach(session => {
                const row = [
                    `"${session.clientName}"`,
                    `"${session.email}"`,
                    `"${session.phoneNumber}"`,
                    `"${session.sessionType}"`,
                    `"${formatDateTime(session.dateTime)}"`,
                    `"${session.location}"`,
                    session.duration,
                    session.price,
                    session.contractSigned ? 'Yes' : 'No',
                    session.paid ? 'Yes' : 'No',
                    session.edited ? 'Yes' : 'No',
                    session.delivered ? 'Yes' : 'No',
                    session.printsOrdered ? 'Yes' : 'No',
                    session.specialEdits ? 'Yes' : 'No',
                    session.clientFeedback ? 'Yes' : 'No',
                    session.socialMediaApproval ? 'Yes' : 'No',
                    session.retouchingNeeded ? 'Yes' : 'No',
                    session.backupCompleted ? 'Yes' : 'No',
                    `"${(session.sessionNotes || '').replace(/"/g, '""')}"`,
                    session.archived ? 'Yes' : 'No'
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('filterContractSigned').checked = false;
            document.getElementById('filterPaid').checked = false;
            document.getElementById('filterDelivered').checked = false;
            document.getElementById('sessionTypeFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('sortOptions').value = 'date-desc';
            
            filterSessions();
            sortSessions();
        }

        // ðŸ’› TIP FUNCTIONALITY FOR DELIVERED SESSIONS
        function generateTipPanel(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || !session.delivered) return '';

            return `
                <div class="tip-panel" style="background: linear-gradient(135deg, #fff9e6, #f4e4bc); padding: 20px; margin-top: 30px; border-radius: 12px; border: 2px solid #d4af37; text-align: center;">
                    <h3 style="color: #8b7355; margin-bottom: 15px; font-size: 1.2em;">ðŸ’› Love your photos?</h3>
                    <p style="color: #8b7355; margin-bottom: 20px; font-size: 0.95em;">
                        If you're thrilled with your photos, you can leave a tip to show your appreciation<br>
                        <em>(totally optional and not expected!)</em>
                    </p>
                    <div class="tip-buttons" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="processTip('${sessionId}', 10)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$10</button>
                        <button onclick="processTip('${sessionId}', 25)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$25</button>
                        <button onclick="processTip('${sessionId}', 50)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$50</button>
                        <button onclick="customTipAmount('${sessionId}')" class="tip-btn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">Custom</button>
                    </div>
                    ${session.tipReceived ? `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; color: #28a745;">
                            <span style="font-size: 1.1em;">Celebration Thank you for your generous tip of $${session.tipAmount}!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function processTip(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                // For demo purposes, simulate Stripe checkout success
                // In production, this would integrate with actual Stripe checkout
                const confirmTip = confirm(`Process tip of $${amount}?\n\nThis will open Stripe checkout to process the payment.`);
                
                if (confirmTip) {
                    // Simulate successful tip processing
                    await updateTipStatus(sessionId, amount);
                    showMessage(`Thank you for your generous $${amount} tip! Celebration`, 'success');
                    celebrateMilestone('tip_received', `$${amount} tip from ${session.clientName}`);
                    
                    // In production, this would be:
                    // window.location.href = await createStripeCheckoutSession(sessionId, amount);
                }
            } catch (error) {
                console.error('Error processing tip:', error);
                showMessage('Error processing tip', 'error');
            }
        }

        async function customTipAmount(sessionId) {
            const amount = prompt('Enter custom tip amount (numbers only):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                await processTip(sessionId, parseFloat(amount));
            } else if (amount !== null) {
                showMessage('Please enter a valid amount', 'error');
            }
        }

        async function updateTipStatus(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.tipReceived = true;
                session.tipAmount = amount;
                session.tipDate = new Date().toISOString();
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    renderSessions();
                } else {
                    showMessage('Error updating tip status', 'error');
                }
            } catch (error) {
                console.error('Error updating tip status:', error);
                showMessage('Error updating tip status', 'error');
            }
        }

        function startUpload() {
            if (selectedFiles.length === 0) {
                showMessage('No files selected for upload', 'error');
                return;
            }
            uploadFiles(selectedFiles);
        }

        function showUploadProgress(show = true) {
            const progressContainer = document.getElementById('uploadProgressContainer');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (show) {
                progressContainer.style.display = 'block';
                uploadBtn.style.display = 'none';
            } else {
                progressContainer.style.display = 'none';
                uploadBtn.style.display = 'block';
            }
        }

        function updateProgress(percent, text, details = '') {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressDetails = document.getElementById('progressDetails');
            const progressSubDetails = document.getElementById('progressSubDetails');
            
            const roundedPercent = Math.round(percent);
            
            // Update progress bar width and text
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${roundedPercent}%`;
            
            // Enhanced color coding based on progress
            if (percent < 25) {
                progressBar.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%)'; // Red for starting
            } else if (percent < 50) {
                progressBar.style.background = 'linear-gradient(135deg, #ffa726 0%, #ffcc02 100%)'; // Orange for quarter
            } else if (percent < 75) {
                progressBar.style.background = 'linear-gradient(135deg, #ffcc02 0%, #d4af37 100%)'; // Yellow for half
            } else if (percent < 100) {
                progressBar.style.background = 'linear-gradient(135deg, #d4af37 0%, #4caf50 100%)'; // Gold to green for almost done
            } else {
                progressBar.style.background = 'linear-gradient(135deg, #4caf50 0%, #81c784 100%)'; // Green for complete
            }
            
            // Update text content
            progressText.textContent = text;
            progressDetails.textContent = details;
            
            // Add sub-details for extra information
            if (progressSubDetails) {
                if (percent === 100) {
                    progressSubDetails.textContent = 'Celebration Upload completed successfully!';
                    progressSubDetails.style.color = '#4caf50';
                } else if (percent > 0) {
                    progressSubDetails.textContent = `${roundedPercent}% complete - Upload in progress...`;
                    progressSubDetails.style.color = '#d4af37';
                } else {
                    progressSubDetails.textContent = 'Initializing upload process...';
                    progressSubDetails.style.color = '#999';
                }
            }
            
            // Update browser tab title with progress percentage
            if (percent < 100) {
                document.title = `(${roundedPercent}%) Upload Progress - Photography Scheduler`;
            } else {
                document.title = 'Success Upload Complete - Photography Scheduler';
                setTimeout(() => {
                    document.title = 'Photography Scheduler';
                }, 3000);
            }
        }

        async function uploadFiles(files) {
            if (!currentUploadSessionId) {
                showMessage('No session selected for upload', 'error');
                return;
            }

            console.log(`Rocket ENHANCED DEBUG: Starting upload of ${files.length} files to session ${currentUploadSessionId}`);

            // Check if we need to batch upload (more than 50 files or total size > 500MB)
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = totalSize / (1024 * 1024);
            
            console.log(`Chart Upload analysis: ${files.length} files, ${totalSizeMB.toFixed(2)}MB total`);
            
            // Filter out overly large files for mobile to improve connectivity
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const maxFileSizeMB = isMobile ? 50 : 100; // Smaller limit for mobile
            
            const filteredFiles = [];
            const oversizedFiles = [];
            
            files.forEach(file => {
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > maxFileSizeMB) {
                    oversizedFiles.push({ name: file.name, size: fileSizeMB.toFixed(2) });
                } else {
                    filteredFiles.push(file);
                }
            });
            
            if (oversizedFiles.length > 0) {
                const oversizedList = oversizedFiles.map(f => `${f.name} (${f.size}MB)`).join(', ');
                showMessage(`Skipping ${oversizedFiles.length} oversized files: ${oversizedList}. Max size: ${maxFileSizeMB}MB per file.`, 'warning');
            }
            
            if (filteredFiles.length === 0) {
                showMessage('No files small enough to upload. Please reduce file sizes and try again.', 'error');
                return;
            }
            
            // Process all files sequentially one at a time for maximum reliability
            console.log(`Package Sequential single-file processing - ${filteredFiles.length} files`);
            return sequentialSingleFileUpload(filteredFiles);

            // Show progress and start upload
            showUploadProgress(true);
            updateProgress(0, 'Preparing upload...', `${files.length} files (${totalSizeMB.toFixed(1)}MB)`);

            return new Promise((resolve, reject) => {
                try {
                    const formData = new FormData();
                    files.forEach((file, index) => {
                        console.log(`ðŸ“ Adding file ${index + 1}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                        formData.append('photos', file);
                    });

                    console.log(`ðŸ“¤ FormData ready - creating XMLHttpRequest with progress tracking`);
                    updateProgress(5, 'Starting upload...', 'Connecting to server...');

                    const xhr = new XMLHttpRequest();
                    
                    // Enhanced progress tracking with detailed logging
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
                            const totalMB = (e.total / 1024 / 1024).toFixed(2);
                            
                            console.log(`Chart Upload Progress: ${percentComplete.toFixed(1)}% (${loadedMB}MB / ${totalMB}MB)`);
                            updateProgress(
                                Math.min(percentComplete * 0.7, 70), // 70% max for upload phase
                                `Uploading: ${percentComplete.toFixed(1)}%`,
                                `${loadedMB}MB / ${totalMB}MB transferred`
                            );
                        }
                    });

                    xhr.upload.addEventListener('loadstart', () => {
                        console.log(`Rocket Upload transfer started`);
                        updateProgress(10, 'Upload in progress...', 'Transferring files to server');
                    });

                    xhr.addEventListener('load', () => {
                        console.log(`Chart XHR load event - status: ${xhr.status}, readyState: ${xhr.readyState}`);
                        updateProgress(75, 'Processing upload...', 'Server is processing your photos');
                        
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                console.log(`Success Upload successful:`, result);
                                
                                updateProgress(100, 'Upload complete!', `Successfully uploaded ${result.uploaded} photos`);
                                setTimeout(() => {
                                    showMessage(`Successfully uploaded ${result.uploaded} photos!`, 'success');
                                    closeUploadModal();
                                    // Force page reload on mobile to ensure photos show up
                                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                                        console.log('Mobile device detected - reloading page to show uploaded photos');
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    } else {
                                        loadSessions(); // Desktop refresh
                                    }
                                    celebrateMilestone('photos_uploaded');
                                    resolve(result);
                                }, 1000);
                                
                            } catch (parseError) {
                                console.error(`Error Error parsing response:`, parseError);
                                console.error(`Error Raw response:`, xhr.responseText);
                                updateProgress(0, 'Upload failed', 'Invalid server response');
                                showMessage('Upload failed: Invalid server response', 'error');
                                reject(parseError);
                            }
                        } else if (xhr.status === 401) {
                            console.error(`Error Authentication error (401)`);
                            updateProgress(0, 'Authentication required', 'Please log in to upload photos');
                            showMessage('Please log in to upload photos', 'error');
                            setTimeout(() => {
                                window.location.href = '/api/login';
                            }, 2000);
                            reject(new Error('Authentication required'));
                        } else {
                            console.error(`Error Upload failed with status ${xhr.status}: ${xhr.responseText}`);
                            updateProgress(0, 'Upload failed', xhr.responseText);
                            showMessage(`Upload failed: ${xhr.responseText}`, 'error');
                            reject(new Error(`Upload failed: ${xhr.responseText}`));
                        }
                    });

                    xhr.addEventListener('error', (e) => {
                        console.error(`Error XHR error event:`, e);
                        console.error(`Error XHR details:`, {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            readyState: xhr.readyState
                        });
                        updateProgress(0, 'Upload failed', 'Network or server error');
                        showMessage('Upload failed: Network or server error', 'error');
                        reject(new Error('Network or server error'));
                    });

                    xhr.addEventListener('timeout', () => {
                        console.error(`Error Upload timeout`);
                        updateProgress(0, 'Upload timeout', 'Upload took too long');
                        showMessage('Upload timeout - try smaller batches', 'error');
                        reject(new Error('Upload timeout'));
                    });

                    // Set reasonable timeout for mobile uploads
                    xhr.timeout = 10 * 60 * 1000; // 10 minutes
                    
                    console.log(`ðŸ“¤ Opening connection to /api/sessions/${currentUploadSessionId}/upload-photos`);
                    xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`, true);
                    xhr.withCredentials = true;
                    
                    console.log(`ðŸ“¤ Sending FormData...`);
                    xhr.send(formData);

                } catch (error) {
                    console.error('Error Error setting up upload:', error);
                    updateProgress(0, 'Upload failed', error.message);
                    showMessage(`Upload failed: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        // Upload with retry logic for better connectivity
        async function uploadWithRetry(formData, batchNumber, totalBatches, retryCount = 0) {
            const maxRetries = 3;
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                // Add upload progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const filePercent = Math.round((e.loaded / e.total) * 100);
                        const batchProgress = ((batchNumber - 1) / totalBatches) * 100;
                        const currentBatchProgress = (filePercent / totalBatches);
                        const overallPercent = Math.round(batchProgress + currentBatchProgress);
                        
                        const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                        const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                        
                        updateProgress(
                            overallPercent, 
                            `Uploading batch ${batchNumber}/${totalBatches} (${filePercent}%)`,
                            `${loadedMB}MB / ${totalMB}MB transferred`
                        );
                        
                        console.log(`Chart Upload Progress: Batch ${batchNumber}/${totalBatches} - ${filePercent}% (${loadedMB}MB / ${totalMB}MB) - Overall: ${overallPercent}%`);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            console.log(`Success Batch ${batchNumber} uploaded successfully (attempt ${retryCount + 1})`);
                            resolve(result);
                        } catch (parseError) {
                            if (retryCount < maxRetries) {
                                console.log(`Warning Parse error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                                updateProgress(
                                    ((batchNumber - 1) / totalBatches) * 100,
                                    `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                                    'Parse error - retrying upload'
                                );
                                setTimeout(() => {
                                    uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                        .then(resolve).catch(reject);
                                }, 1000 * (retryCount + 1)); // Exponential backoff
                            } else {
                                reject(new Error('Invalid server response'));
                            }
                        }
                    } else if (xhr.status === 401) {
                        reject(new Error('Authentication required'));
                    } else {
                        if (retryCount < maxRetries) {
                            console.log(`Warning HTTP ${xhr.status} error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                            updateProgress(
                                ((batchNumber - 1) / totalBatches) * 100,
                                `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                                `HTTP ${xhr.status} error - retrying upload`
                            );
                            setTimeout(() => {
                                uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                    .then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error(xhr.responseText || `Upload failed with status ${xhr.status}`));
                        }
                    }
                });
                
                xhr.addEventListener('error', () => {
                    if (retryCount < maxRetries) {
                        console.log(`Warning Network error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                        updateProgress(
                            ((batchNumber - 1) / totalBatches) * 100,
                            `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                            'Network error - retrying upload'
                        );
                        setTimeout(() => {
                            uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                .then(resolve).catch(reject);
                        }, 1000 * (retryCount + 1));
                    } else {
                        reject(new Error('Network error - all retries failed'));
                    }
                });
                
                xhr.addEventListener('timeout', () => {
                    if (retryCount < maxRetries) {
                        console.log(`Warning Timeout, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                        updateProgress(
                            ((batchNumber - 1) / totalBatches) * 100,
                            `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                            'Upload timeout - retrying'
                        );
                        setTimeout(() => {
                            uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                .then(resolve).catch(reject);
                        }, 1000 * (retryCount + 1));
                    } else {
                        reject(new Error('Upload timeout - all retries failed'));
                    }
                });
                
                xhr.timeout = 2 * 60 * 1000; // 2 minute timeout
                xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`, true);
                xhr.withCredentials = true;
                xhr.send(formData);
            });
        }

        // Upload files in reliable batches with retry logic
        async function sequentialSingleFileUpload(files) {
            showUploadProgress(true);
            updateProgress(0, 'Starting sequential upload...', `${files.length} files to process`);
            
            let uploadedCount = 0;
            const totalFiles = files.length;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    
                    console.log(`Rocket Processing file ${i + 1}/${totalFiles}: ${file.name} (${fileSizeMB}MB)`);
                    
                    // Create FormData for single file
                    const formData = new FormData();
                    formData.append('photos', file);
                    
                    // Upload single file with progress tracking
                    try {
                        const result = await uploadSingleFileWithProgress(formData, i + 1, totalFiles, file.name, fileSizeMB);
                        uploadedCount += result.uploaded;
                        
                        // Update overall progress
                        const overallPercent = Math.round(((i + 1) / totalFiles) * 100);
                        updateProgress(overallPercent, `File ${i + 1}/${totalFiles} complete`, `${uploadedCount} photos uploaded successfully`);
                        
                        console.log(`Success File ${i + 1} uploaded successfully: ${file.name}`);
                        
                    } catch (error) {
                        console.error(`Error File ${i + 1} upload failed: ${file.name}`, error);
                        showMessage(`Failed to upload ${file.name}: ${error.message}`, 'error');
                        // Continue with next file instead of stopping entire batch
                    }
                }
                
                updateProgress(100, 'All uploads complete!', `Successfully uploaded ${uploadedCount}/${totalFiles} photos`);
                setTimeout(() => {
                    showMessage(`Upload complete! ${uploadedCount}/${totalFiles} photos uploaded successfully.`, 'success');
                    closeUploadModal();
                    
                    // Force page reload on mobile to ensure photos show up
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        console.log('Mobile device detected - reloading page to show uploaded photos');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        loadSessions(); // Refresh session data to show new photos
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error Sequential upload failed:', error);
                showMessage('Upload failed: ' + error.message, 'error');
                showUploadProgress(false);
            }
        }

        async function uploadSingleFileWithProgress(formData, fileNumber, totalFiles, fileName, fileSizeMB) {
            const maxRetries = 3;
            
            const uploadWithRetry = (retryCount = 0) => {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 2 minute timeout
                    
                    // Progress tracking for individual file
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const filePercent = Math.round((e.loaded / e.total) * 100);
                            const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                            const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                            
                            // Calculate overall progress across all files
                            const completedFiles = fileNumber - 1;
                            const currentFileProgress = filePercent / 100;
                            const overallPercent = Math.round(((completedFiles + currentFileProgress) / totalFiles) * 100);
                            
                            updateProgress(
                                overallPercent,
                                `Uploading file ${fileNumber}/${totalFiles}: ${fileName} (${filePercent}%)`,
                                `${loadedMB}MB / ${totalMB}MB transferred`
                            );
                            
                            console.log(`Chart File ${fileNumber} Progress: ${filePercent}% (${loadedMB}MB / ${totalMB}MB) - Overall: ${overallPercent}%`);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                resolve(result);
                            } catch (parseError) {
                                if (retryCount < maxRetries) {
                                    console.log(`Warning Parse error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                                    setTimeout(() => {
                                        uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                                    }, 1000 * (retryCount + 1));
                                } else {
                                    reject(new Error('Invalid server response'));
                                }
                            }
                        } else if (xhr.status === 401) {
                            reject(new Error('Authentication required'));
                        } else {
                            if (retryCount < maxRetries) {
                                console.log(`Warning HTTP ${xhr.status} error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                                setTimeout(() => {
                                    uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                                }, 1000 * (retryCount + 1));
                            } else {
                                reject(new Error(`Upload failed with status ${xhr.status}`));
                            }
                        }
                    });

                    xhr.addEventListener('error', () => {
                        if (retryCount < maxRetries) {
                            console.log(`Warning Network error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                            setTimeout(() => {
                                uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error('Network error - all retries failed'));
                        }
                    });

                    xhr.addEventListener('timeout', () => {
                        if (retryCount < maxRetries) {
                            console.log(`Warning Timeout, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                            setTimeout(() => {
                                uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error('Upload timeout - all retries failed'));
                        }
                    });

                    xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`);
                    xhr.send(formData);
                });
            };
            
            return uploadWithRetry();
        }

        async function uploadFilesInBatches(files) {
            // Use small batches for mobile reliability  
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const batchSize = isMobile ? 1 : 5; // 1 file for mobile, 5 for desktop
            const totalBatches = Math.ceil(files.length / batchSize);
            let uploadedCount = 0;
            
            console.log(`Rocket Reliable upload mode: ${batchSize} files per batch (${isMobile ? 'mobile' : 'desktop'} mode)`);
            
            showMessage(`Uploading ${files.length} files in ${totalBatches} reliable batches...`, 'info');
            showUploadProgress(true);
            
            // Process batches sequentially for reliability
            try {
                for (let i = 0; i < totalBatches; i++) {
                    const start = i * batchSize;
                    const end = Math.min(start + batchSize, files.length);
                    const batch = files.slice(start, end);
                    
                    console.log(`Rocket Uploading batch ${i + 1}/${totalBatches}: files ${start + 1}-${end}`);
                    updateProgress((i / totalBatches) * 80, `Uploading batch ${i + 1}/${totalBatches}`, `${uploadedCount}/${files.length} photos uploaded`);
                    
                    try {
                        const formData = new FormData();
                        batch.forEach(file => {
                            formData.append('photos', file);
                        });

                        // Use XMLHttpRequest with retry logic for better reliability
                        const result = await uploadWithRetry(formData, i + 1, totalBatches);



                        uploadedCount += result.uploaded;
                        console.log(`Success Batch ${i + 1} complete: ${result.uploaded} photos uploaded`);
                        const batchCompletePercent = Math.round(((i + 1) / totalBatches) * 100);
                        updateProgress(batchCompletePercent, `Batch ${i + 1}/${totalBatches} complete`, `${uploadedCount}/${files.length} photos uploaded successfully`);
                    } catch (error) {
                        console.error(`Error Batch ${i + 1} upload error:`, error);
                        if (error.message === 'Authentication required') {
                            showMessage('Authentication required. Please log in to upload photos.', 'error');
                            setTimeout(() => {
                                window.location.href = '/api/login';
                            }, 2000);
                            return;
                        }
                        showMessage(`Batch ${i + 1} failed: ${error.message}`, 'error');
                        showUploadProgress(false);
                        return;
                    }
                }
                
                updateProgress(100, 'Upload complete!', `All ${uploadedCount} photos uploaded successfully`);
                
            } catch (error) {
                console.error('Error Batch upload failed:', error);
                showMessage('Upload failed: ' + error.message, 'error');
                showUploadProgress(false);
                return;
            }
            
            showMessage(`All ${uploadedCount} photos uploaded successfully!`, 'success');
            closeUploadModal();
            // Force page reload on mobile to ensure photos show up  
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                console.log('Mobile device detected - reloading page to show uploaded photos');
                celebrateMilestone('photos_uploaded');
                setTimeout(() => {
                    window.location.reload();
                }, 2000); // Longer delay for celebration
            } else {
                loadSessions(); // Desktop refresh
                celebrateMilestone('photos_uploaded');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;

            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    sessions = sessions.filter(s => s.id !== sessionId);
                    renderSessions();
                    showMessage('Session deleted successfully!', 'success');
                } else {
                    showMessage('Failed to delete session', 'error');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showMessage('Error deleting session', 'error');
            }
        }

        function viewPhoto(url) {
            window.open(url, '_blank');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Admin-only button functions
        let editingSessionId = null;

        function editSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            editingSessionId = sessionId;
            
            // Populate the form with existing data for editing
            document.getElementById('clientName').value = session.clientName;
            document.getElementById('sessionType').value = session.sessionType;
            // Format the datetime for the input field (datetime-local expects YYYY-MM-DDTHH:MM format)
            const dateForEdit = new Date(session.dateTime);
            const formattedDate = dateForEdit.toISOString().slice(0, 16);
            document.getElementById('dateTime').value = formattedDate;
            document.getElementById('location').value = session.location;
            document.getElementById('phoneNumber').value = session.phoneNumber;
            document.getElementById('email').value = session.email;
            document.getElementById('price').value = session.price;
            document.getElementById('duration').value = session.duration;
            
            // Set checkbox states
            document.getElementById('contractSigned').checked = session.contractSigned || false;
            document.getElementById('paid').checked = session.paid || false;
            document.getElementById('edited').checked = session.edited || false;
            document.getElementById('delivered').checked = session.delivered || false;
            document.getElementById('sendReminder').checked = session.sendReminder || false;
            document.getElementById('notifyGalleryReady').checked = session.notifyGalleryReady || false;
            
            // Update form UI for editing
            const form = document.getElementById('sessionForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Session';
            
            // Allow all dates for editing historical sessions (past dates enabled)
            document.getElementById('dateTime').removeAttribute('min');
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
            
            showMessage('Form populated for editing. Update and save changes.', 'success');
        }





        // Open email client with session details  
        function openEmailClient(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const subject = `Photography Session - ${session.sessionType} with ${session.clientName}`;
            const body = `Hi ${session.clientName},

I hope this email finds you well! I'm writing regarding your upcoming ${session.sessionType} photography session.

Session Details:
Date: ${new Date(session.dateTime).toLocaleDateString()}
Time: ${new Date(session.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
Location: ${session.location}
Investment: $${session.price}
Contact: ${session.phoneNumber}

I'm excited to capture these special moments for you! If you have any questions or need to make any changes, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }

        // Copy gallery URL to clipboard
        async function copyGalleryUrl(sessionId) {
            try {
                showMessage('Generating gallery URL...', 'info');
                
                // Generate gallery access if not exists
                const response = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate gallery access');
                }
                
                const data = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                console.log('Generated gallery URL:', data.galleryUrl);
                
                // Try multiple methods to copy URL with enhanced mobile support
                let copySuccess = false;
                let method = '';
                
                // Method 1: Modern clipboard API (works on HTTPS and secure contexts)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(data.galleryUrl);
                        copySuccess = true;
                        method = 'clipboard API';
                        console.log('Clipboard API copy successful');
                        
                        // Trigger milestone celebration for gallery sharing
                        celebrateMilestone('gallery_shared');
                    } catch (clipboardError) {
                        console.log('Clipboard API failed:', clipboardError.message);
                    }
                }
                
                // Method 2: Enhanced textarea fallback with mobile optimization
                if (!copySuccess) {
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = data.galleryUrl;
                        
                        // Enhanced styles for mobile compatibility
                        textarea.style.position = 'fixed';
                        textarea.style.top = '0';
                        textarea.style.left = '0';
                        textarea.style.width = '2em';
                        textarea.style.height = '2em';
                        textarea.style.padding = '0';
                        textarea.style.border = 'none';
                        textarea.style.outline = 'none';
                        textarea.style.boxShadow = 'none';
                        textarea.style.background = 'transparent';
                        textarea.style.opacity = '0';
                        textarea.style.zIndex = '-1';
                        
                        document.body.appendChild(textarea);
                        
                        // Enhanced selection for mobile devices
                        textarea.focus();
                        textarea.setSelectionRange(0, 99999);
                        textarea.select();
                        
                        // Try execCommand
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        if (successful) {
                            copySuccess = true;
                            method = 'execCommand';
                            console.log('execCommand copy successful');
                        }
                    } catch (fallbackError) {
                        console.log('Fallback copy failed:', fallbackError.message);
                    }
                }
                
                // Method 3: Share API for mobile devices (if available)
                if (!copySuccess && navigator.share) {
                    try {
                        await navigator.share({
                            title: `Gallery for ${session.clientName}`,
                            text: `View your ${session.sessionType} photos:`,
                            url: data.galleryUrl
                        });
                        method = 'share API';
                        showMessage('Gallery shared successfully!', 'success');
                        return; // Exit early since sharing was successful
                    } catch (shareError) {
                        console.log('Share API failed:', shareError.message);
                    }
                }
                
                // Always show the URL in a prompt dialog for copying
                if (copySuccess) {
                    showMessage(`Gallery URL copied successfully! (${method})`, 'success');
                    // Show confirmation with the URL
                    alert(`Gallery URL copied for ${session.clientName}!\n\nURL: ${data.galleryUrl}\n\nYou can now paste this into your email or text message.`);
                } else {
                    showMessage('Copy the URL from the dialog below', 'info');
                    // Show URL in a prompt for manual copying
                    const userAction = prompt(`Copy this gallery URL for ${session.clientName}:`, data.galleryUrl);
                    if (userAction !== null) {
                        showMessage('Gallery URL provided for copying', 'success');
                    }
                }
                
            } catch (error) {
                console.error('Error copying gallery URL:', error);
                showMessage('Failed to generate gallery URL: ' + error.message, 'error');
            }
        }

        function addToCalendar(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // For iPhone, use the server endpoint
            if (/iPhone|iPad/.test(navigator.userAgent)) {
                window.location.href = `/api/sessions/${sessionId}/calendar.ics`;
                showMessage('Opening iPhone Calendar...', 'success');
                return;
            }
            
            const startDate = new Date(session.dateTime);
            const endDate = new Date(startDate.getTime() + (session.duration * 60000));
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Photography Scheduler//EN
BEGIN:VEVENT
UID:${session.id}@photographyschedule.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Photography Session - ${session.clientName}
DESCRIPTION:Session Type: ${session.sessionType}\\nLocation: ${session.location}\\nClient: ${session.clientName}\\nPhone: ${session.phoneNumber}\\nEmail: ${session.email}\\nPrice: $${session.price}
LOCATION:${session.location}
END:VEVENT
END:VCALENDAR`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${session.clientName.replace(/\s+/g, '_')}_photography_session.ics`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Calendar event downloaded!', 'success');
        }

        async function sendGalleryReady(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                // First, generate gallery access token
                const generateResponse = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!generateResponse.ok) {
                    throw new Error('Failed to generate gallery access');
                }
                
                const galleryData = await generateResponse.json();
                
                // Then send notification
                const notifyResponse = await fetch(`/api/sessions/${sessionId}/send-gallery-notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!notifyResponse.ok) {
                    throw new Error('Failed to send gallery notification');
                }
                
                const notifyData = await notifyResponse.json();
                
                // Show success message with gallery URL
                showMessage(`Gallery ready! Secure link sent to ${session.clientName}`, 'success');
                
                // Optional: Show the gallery URL in a popup for copying
                const showUrlConfirm = confirm(`Gallery notification sent to ${session.clientName}!\n\nGallery URL (for your reference):\n${galleryData.galleryUrl}\n\nClick OK to copy link to clipboard.`);
                
                if (showUrlConfirm) {
                    navigator.clipboard.writeText(galleryData.galleryUrl).then(() => {
                        showMessage('Gallery URL copied to clipboard!', 'success');
                    }).catch(() => {
                        // Fallback for browsers that don't support clipboard API
                        prompt('Copy this gallery URL:', galleryData.galleryUrl);
                    });
                }
                
            } catch (error) {
                console.error('Error sending gallery ready notification:', error);
                showMessage('Failed to send gallery notification: ' + error.message, 'error');
            }
        }

        async function sendInvoice(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to send invoice');
                }
                
                const result = await response.json();
                
                if (result.fallbackMode) {
                    // Handle simulation mode
                    showMessage(`Invoice simulation completed for ${session.clientName}`, 'info');
                    alert(`Invoice Simulation Mode\n\nClient: ${result.clientName}\nAmount: $${result.amount}\nSession: ${result.sessionType}\n\n${result.details}`);
                } else {
                    // Handle real Stripe invoice
                    showMessage(`Invoice sent to ${session.clientName} for $${session.price}!`, 'success');
                    
                    // Trigger milestone celebration for invoice sent
                    celebrateMilestone('invoice_sent');
                    
                    // Show invoice URL
                    const showUrlConfirm = confirm(`Invoice sent successfully to ${session.clientName}!\n\nInvoice Amount: $${session.price}\nStatus: ${result.invoice ? result.invoice.status : 'sent'}\n\nClick OK to view the invoice.`);
                    
                    if (showUrlConfirm && result.invoice && result.invoice.hostedInvoiceUrl) {
                        window.open(result.invoice.hostedInvoiceUrl, '_blank');
                    }
                }
                
            } catch (error) {
                console.error('Error sending invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }

        function callClient(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function textClient(phoneNumber, clientName, sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session && session.galleryAccessToken) {
                const galleryUrl = `${window.location.origin}/gallery/${sessionId}?access=${session.galleryAccessToken}`;
                const message = `${clientName}, your ${session.sessionType} photos are ready! View gallery: ${galleryUrl}`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            } else {
                const message = `Hi ${clientName}, your photos will be ready soon! We'll send you the gallery link when they're available.`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            }
        }

        async function viewGallery(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Check if gallery access exists
            if (session.galleryAccessToken) {
                // Open existing gallery
                window.open(`/gallery/${sessionId}?access=${session.galleryAccessToken}`, '_blank');
            } else {
                // Generate gallery access first
                try {
                    const response = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate gallery access');
                    }
                    
                    const galleryData = await response.json();
                    
                    // Update local session data
                    session.galleryAccessToken = galleryData.accessToken;
                    
                    // Open gallery
                    window.open(galleryData.galleryUrl, '_blank');
                    
                } catch (error) {
                    console.error('Error generating gallery access:', error);
                    showMessage('Failed to generate gallery access: ' + error.message, 'error');
                }
            }
        }
    </script>

    <!-- Confetti Container for Milestone Celebrations -->
    <div id="confettiContainer" class="confetti-container"></div>

    <script>
        // Confetti Animation System for Milestone Celebrations
        function createConfetti(x, y, count = 50) {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                
                // Random positioning and styling
                const startX = x || Math.random() * window.innerWidth;
                const startY = y || -20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 8 + 6;
                const duration = Math.random() * 2 + 2;
                
                confetti.style.left = startX + 'px';
                confetti.style.top = startY + 'px';
                confetti.style.backgroundColor = color;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                confetti.style.animationDuration = duration + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                
                container.appendChild(confetti);
                
                // Clean up after animation
                setTimeout(() => {
                    if (confetti && confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, (duration + 0.5) * 1000);
            }
        }
        
        function showMilestoneToast(message, emoji = 'Celebration') {
            const toast = document.createElement('div');
            toast.className = 'milestone-toast';
            toast.innerHTML = `${emoji} ${message}`;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }
        
        function celebrateMilestone(type, sessionName = '') {
            const celebrations = {
                'session_created': {
                    message: `New Session Created: ${sessionName}`,
                    emoji: '',
                    confetti: 30
                },
                'contract_signed': {
                    message: 'Contract Signed!',
                    emoji: '',
                    confetti: 25
                },
                'payment_received': {
                    message: 'Payment Received!',
                    emoji: '',
                    confetti: 40
                },
                'photos_uploaded': {
                    message: 'Photos Uploaded Successfully!',
                    emoji: '',
                    confetti: 35
                },
                'session_delivered': {
                    message: 'Session Delivered!',
                    emoji: '',
                    confetti: 45
                },
                'gallery_shared': {
                    message: 'Gallery Shared with Client!',
                    emoji: '',
                    confetti: 30
                },
                'invoice_sent': {
                    message: 'Invoice Sent Successfully!',
                    emoji: '',
                    confetti: 25
                },
                'payment_plan_created': {
                    message: 'Payment Plan Created!',
                    emoji: '',
                    confetti: 30
                }
            };
            
            const celebration = celebrations[type];
            if (!celebration) return;
            
            // Show toast message
            showMilestoneToast(celebration.message, celebration.emoji);
            
            // Trigger confetti from multiple points
            setTimeout(() => {
                createConfetti(window.innerWidth * 0.25, -20, celebration.confetti / 2);
                createConfetti(window.innerWidth * 0.75, -20, celebration.confetti / 2);
            }, 200);
        }
        
        // Global function to trigger celebrations
        window.celebrateMilestone = celebrateMilestone;

        // Gallery Functions
        let currentGallerySessionId = null;

        function viewSessionGallery(sessionId) {
            currentGallerySessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Update gallery title
            document.getElementById('galleryTitle').textContent = `ðŸ“· ${session.clientName} - Session Gallery`;
            
            // Show gallery modal
            document.getElementById('galleryModal').classList.add('active');
            
            // Load and display photos
            loadGalleryPhotos(session);
            
            // Add tip panel for delivered sessions
            const tipPanel = document.getElementById('galleryTipPanel');
            if (session.delivered) {
                tipPanel.innerHTML = generateTipPanel(sessionId);
                tipPanel.style.display = 'block';
            } else {
                tipPanel.style.display = 'none';
            }
        }

        function loadGalleryPhotos(session) {
            const galleryGrid = document.getElementById('galleryGrid');
            const galleryEmpty = document.getElementById('galleryEmpty');
            
            if (!session.photos || session.photos.length === 0) {
                galleryGrid.style.display = 'none';
                galleryEmpty.style.display = 'block';
                return;
            }
            
            galleryEmpty.style.display = 'none';
            galleryGrid.style.display = 'grid';
            
            galleryGrid.innerHTML = session.photos.map(photo => `
                <div>
                    <img src="/uploads/${photo.filename}" alt="${photo.originalName}" loading="lazy" onclick="openPhotoLightbox('${photo.filename}')">
                    <button class="photo-delete-btn" onclick="deletePhoto('${session.id}', '${photo.filename}')" title="Delete photo">Ã—</button>
                    <div class="photo-filename">${photo.originalName}</div>
                </div>
            `).join('');
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').classList.remove('active');
            currentGallerySessionId = null;
        }

        async function deletePhoto(sessionId, filename) {
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/sessions/${sessionId}/photos/${filename}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Photo deleted successfully!', 'success');
                    
                    // Refresh session data
                    await loadSessions();
                    
                    // Refresh gallery if still open
                    if (currentGallerySessionId === sessionId) {
                        const session = sessions.find(s => s.id === sessionId);
                        if (session) {
                            loadGalleryPhotos(session);
                        }
                    }
                } else {
                    const errorData = await response.json();
                    showMessage('Failed to delete photo: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                showMessage('Error deleting photo', 'error');
            }
        }

        function openPhotoLightbox(filename) {
            // Create lightbox overlay
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = `/uploads/${filename}`;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            `;
            
            lightbox.appendChild(img);
            document.body.appendChild(lightbox);
            
            // Close on click
            lightbox.addEventListener('click', () => {
                document.body.removeChild(lightbox);
            });
            
            // Close on escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(lightbox);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Payment Plan Functions
        function openPaymentPlanModal(sessionId) {
            currentPaymentPlanSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Pre-fill with session price
            document.getElementById('planTotalAmount').value = session.price;
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planStartDate').value = today;
            
            // Set default end date to 6 months from now
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
            document.getElementById('planEndDate').value = sixMonthsLater.toISOString().split('T')[0];
            
            document.getElementById('paymentPlanModal').classList.add('active');
        }
        
        function closePaymentPlanModal() {
            document.getElementById('paymentPlanModal').classList.remove('active');
            document.getElementById('paymentPlanSummary').style.display = 'none';
            currentPaymentPlanSessionId = null;
        }
        
        function calculatePaymentPreview() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = new Date(document.getElementById('planEndDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate months between dates
            const monthsDiff = Math.max(1, (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()));
            const monthlyPayment = (totalAmount / monthsDiff).toFixed(2);
            
            // Show summary
            const summaryElement = document.getElementById('paymentPlanSummary');
            const detailsElement = document.getElementById('paymentSummaryDetails');
            const scheduleElement = document.getElementById('paymentSchedulePreview');
            
            detailsElement.innerHTML = `
                <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                <p><strong>Number of Payments:</strong> ${monthsDiff}</p>
                <p><strong>Monthly Payment:</strong> $${monthlyPayment}</p>
                <p><strong>Period:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
            `;
            
            // Generate payment schedule preview
            let scheduleHTML = '<h5>Payment Schedule:</h5>';
            for (let i = 0; i < Math.min(monthsDiff, 6); i++) { // Show first 6 payments
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);
                
                scheduleHTML += `
                    <div class="payment-item">
                        <div>
                            <strong>Payment ${i + 1}</strong><br>
                            <small>${paymentDate.toLocaleDateString()}</small>
                        </div>
                        <div>$${monthlyPayment}</div>
                        <div class="payment-status pending">Pending</div>
                    </div>
                `;
            }
            
            if (monthsDiff > 6) {
                scheduleHTML += `<p><small>... and ${monthsDiff - 6} more payments</small></p>`;
            }
            
            scheduleElement.innerHTML = scheduleHTML;
            summaryElement.style.display = 'block';
        }
        
        async function createPaymentPlan() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;
            const reminderDays = parseInt(document.getElementById('planReminderDays').value);
            
            if (!totalAmount || !startDate || !endDate || !currentPaymentPlanSessionId) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${currentPaymentPlanSessionId}/payment-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        totalAmount,
                        startDate,
                        endDate,
                        reminderDays
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create payment plan');
                }
                
                const result = await response.json();
                
                closePaymentPlanModal();
                showMessage(`Payment plan created! ${result.payments.length} monthly payments of $${result.plan.monthlyPayment}`, 'success');
                
                // Refresh sessions to show updated data
                loadSessions();
                
                // Celebrate milestone
                celebrateMilestone('payment_plan_created', sessions.find(s => s.id === currentPaymentPlanSessionId)?.clientName || 'Client');
                
            } catch (error) {
                console.error('Error creating payment plan:', error);
                showMessage('Failed to create payment plan: ' + error.message, 'error');
            }
        }
        
        async function viewPaymentPlan(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/payment-plan`);
                
                if (!response.ok) {
                    throw new Error('Payment plan not found');
                }
                
                const paymentPlan = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                // Update modal title
                document.getElementById('paymentPlanViewTitle').textContent = `Payment Plan - ${session?.clientName || 'Client'}`;
                
                // Generate payment plan view
                let contentHTML = `
                    <div class="payment-plan-summary">
                        <h4>ðŸ“‹ Plan Overview</h4>
                        <p><strong>Total Amount:</strong> $${parseFloat(paymentPlan.totalAmount).toFixed(2)}</p>
                        <p><strong>Monthly Payment:</strong> $${parseFloat(paymentPlan.monthlyPayment).toFixed(2)}</p>
                        <p><strong>Payments Completed:</strong> ${paymentPlan.paymentsCompleted} of ${paymentPlan.totalPayments}</p>
                        <p><strong>Amount Paid:</strong> $${parseFloat(paymentPlan.amountPaid).toFixed(2)}</p>
                        <p><strong>Remaining Balance:</strong> $${parseFloat(paymentPlan.remainingBalance).toFixed(2)}</p>
                        <p><strong>Status:</strong> <span class="payment-status ${paymentPlan.status}">${paymentPlan.status.toUpperCase()}</span></p>
                    </div>
                    
                    <div class="payment-schedule">
                        <h4>Payment Schedule</h4>
                `;
                
                for (const payment of paymentPlan.payments) {
                    const dueDate = new Date(payment.dueDate);
                    const isOverdue = dueDate < new Date() && payment.status === 'pending';
                    const statusClass = isOverdue ? 'overdue' : payment.status;
                    
                    contentHTML += `
                        <div class="payment-item">
                            <div>
                                <strong>Payment ${payment.paymentNumber}</strong><br>
                                <small>Due: ${dueDate.toLocaleDateString()}</small>
                                ${payment.paidDate ? `<br><small>Paid: ${new Date(payment.paidDate).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div>$${parseFloat(payment.amount).toFixed(2)}</div>
                            <div>
                                <div class="payment-status ${statusClass}">${payment.status.toUpperCase()}</div>
                                ${payment.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markPaymentPaid('${payment.id}')" style="margin-top: 5px;">Mark Paid</button>
                                    <button class="btn btn-sm" onclick="sendPaymentInvoice('${payment.id}')" style="margin-top: 5px;">Send Invoice</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += '</div>';
                
                document.getElementById('paymentPlanViewContent').innerHTML = contentHTML;
                document.getElementById('paymentPlanViewModal').classList.add('active');
                
            } catch (error) {
                console.error('Error viewing payment plan:', error);
                showMessage('Failed to load payment plan: ' + error.message, 'error');
            }
        }
        
        function closePaymentPlanViewModal() {
            document.getElementById('paymentPlanViewModal').classList.remove('active');
        }
        
        async function markPaymentPaid(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentMethod: 'manual',
                        notes: 'Marked as paid by admin'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to mark payment as paid');
                }
                
                showMessage('Payment marked as paid!', 'success');
                loadSessions(); // Refresh session data
                // Re-open the payment plan view to show updated status
                setTimeout(() => {
                    if (currentPaymentPlanSessionId) {
                        viewPaymentPlan(currentPaymentPlanSessionId);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error marking payment paid:', error);
                showMessage('Failed to mark payment as paid: ' + error.message, 'error');
            }
        }
        
        async function sendPaymentInvoice(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send invoice');
                }
                
                showMessage('Payment invoice sent successfully!', 'success');
                celebrateMilestone('invoice_sent');
                
            } catch (error) {
                console.error('Error sending payment invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }
        
        async function processAutomatedPayments() {
            try {
                const response = await fetch('/api/payments/process-automated', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process payments');
                }
                
                const result = await response.json();
                
                showMessage(`Processing complete! ${result.results.invoicesSent} invoices sent, ${result.results.remindersSent} reminders sent`, 'success');
                
                // Refresh data
                loadSessions();
                
            } catch (error) {
                console.error('Error processing automated payments:', error);
                showMessage('Failed to process payments: ' + error.message, 'error');
            }
        }

        // Contract Management Functions
        let currentContractSessionId = null;

        async function openContractModal(sessionId) {
            currentContractSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Load existing contracts for this session
            await loadExistingContracts(sessionId);
            
            const modal = document.getElementById('contractModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            currentContractSessionId = null;
        }

        async function loadExistingContracts(sessionId) {
            // Validate sessionId before making API call
            if (!sessionId) {
                console.warn('loadExistingContracts called without valid sessionId');
                return;
            }
            
            try {
                const authToken = await getAuthToken();
                const headers = {};
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, { headers });
                if (!response.ok) {
                    throw new Error('Failed to load contracts');
                }

                const contracts = await response.json();
                const existingContractsDiv = document.getElementById('existingContractsList');
                
                if (!existingContractsDiv) {
                    console.warn('existingContractsList element not found in DOM');
                    return;
                }
                
                if (contracts.length === 0) {
                    existingContractsDiv.innerHTML = '';
                    return;
                }

                existingContractsDiv.innerHTML = `
                    <h4>Existing Contracts:</h4>
                    <div class="existing-contracts-list">
                        ${contracts.map(contract => `
                            <div class="contract-item ${contract.status}">
                                <div class="contract-item-info">
                                    <h5>${contract.contract_title}</h5>
                                    <p>Status: ${contract.status.charAt(0).toUpperCase() + contract.status.slice(1)}</p>
                                    <p>Created: ${new Date(contract.created_at).toLocaleDateString()}</p>
                                    ${contract.signed_date ? `<p>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="contract-item-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editContract('${contract.id}')">
                                        âœï¸ Edit
                                    </button>
                                    ${contract.status === 'pending' ? `
                                        <button class="btn btn-primary btn-sm" onclick="sendContract('${contract.id}')">
                                            Send Contract
                                        </button>
                                    ` : contract.status === 'sent' ? `
                                        <span class="contract-status-badge sent">Sent</span>
                                    ` : contract.status === 'signed' ? `
                                        <span class="contract-status-badge signed">Signed</span>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading contracts:', error);
                showMessage('Failed to load existing contracts', 'error');
            }
        }

        async function createContract(sessionId, contractType) {
            try {
                showMessage('Creating contract...', 'info');
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractType: contractType
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create contract');
                }

                const result = await response.json();
                
                showMessage('Contract created successfully!', 'success');
                
                // Reload the existing contracts to show the new one
                await loadExistingContracts(sessionId);
                
                // Trigger milestone celebration
                celebrateMilestone('contract_signed');
                
            } catch (error) {
                console.error('Error creating contract:', error);
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        async function sendContract(contractId) {
            try {
                showMessage('Preparing contract email...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to prepare contract email');
                }

                const result = await response.json();
                
                // Get email data from server response
                const emailData = result.emailData;
                if (!emailData) {
                    throw new Error('Email template not available');
                }
                
                // Create mailto link with pre-filled email
                const mailtoLink = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                showMessage('Email client opened! Review and send the contract email.', 'success');
                
                // Show the signing URL for reference
                alert(`Email client opened with contract details!\n\nSigning URL: ${result.signingUrl}\n\nPlease review the email and send it to your client.`);
                
                // Reload existing contracts to update status (only if we have a valid session ID)
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error preparing contract email:', error);
                showMessage('Failed to prepare contract email: ' + error.message, 'error');
            }
        }

        // Contract Edit Functions
        let currentEditContractId = null;

        async function editContract(contractId) {
            try {
                currentEditContractId = contractId;
                
                // Fetch contract details
                const response = await fetch(`/api/contracts/${contractId}`, {
                    headers: {
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load contract details');
                }

                const contract = await response.json();
                
                // Populate edit form
                document.getElementById('contractTitle').value = contract.contract_title;
                document.getElementById('contractContent').value = contract.contract_content;
                
                // Show edit modal
                const editModal = document.getElementById('contractEditModal');
                editModal.style.display = 'flex';
                editModal.style.alignItems = 'center';
                editModal.style.justifyContent = 'center';
                
            } catch (error) {
                console.error('Error loading contract for edit:', error);
                showMessage('Failed to load contract: ' + error.message, 'error');
            }
        }

        function closeContractEditModal() {
            document.getElementById('contractEditModal').style.display = 'none';
            currentEditContractId = null;
        }

        async function saveContractChanges(event) {
            event.preventDefault();
            
            if (!currentEditContractId) {
                showMessage('No contract selected for editing', 'error');
                return;
            }

            try {
                showMessage('Saving contract changes...', 'info');
                
                const title = document.getElementById('contractTitle').value.trim();
                const content = document.getElementById('contractContent').value.trim();
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }

                const response = await fetch(`/api/contracts/${currentEditContractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save contract changes');
                }

                showMessage('Contract updated successfully!', 'success');
                closeContractEditModal();
                
                // Reload existing contracts to show the updated version
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save changes: ' + error.message, 'error');
            }
        }

        // Send deposit invoice with custom amount
        async function sendDepositInvoice(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    showMessage('Session not found', 'error');
                    return;
                }

                // Prompt user for deposit amount
                const depositAmountInput = prompt(
                    `Enter deposit/retainer amount for ${session.clientName}:\n\nSession Total: $${session.price}\nSuggested 50%: $${(session.price * 0.5).toFixed(2)}`,
                    (session.price * 0.5).toFixed(2)
                );
                
                if (!depositAmountInput) {
                    return; // User cancelled
                }
                
                const depositAmount = parseFloat(depositAmountInput);
                
                if (isNaN(depositAmount) || depositAmount <= 0) {
                    showMessage('Please enter a valid amount greater than $0', 'error');
                    return;
                }
                
                if (depositAmount > session.price) {
                    const confirmOverage = confirm(
                        `Deposit amount ($${depositAmount}) is more than the session total ($${session.price}).\n\nDo you want to continue?`
                    );
                    if (!confirmOverage) {
                        return;
                    }
                }
                
                console.log('Creating deposit invoice for session:', session);
                showMessage('Creating deposit invoice...', 'info');
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/api/create-invoice', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        sessionId: session.id,
                        clientName: session.clientName,
                        email: session.email,
                        amount: depositAmount,
                        description: `Retainer for ${session.sessionType} Photography Session (Total: $${session.price})`,
                        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), // 14 days for deposit
                        isDeposit: true,
                        depositAmount: depositAmount,
                        totalAmount: session.price
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to create deposit invoice: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Deposit invoice creation result:', result);
                
                if (result.success && result.invoice_url) {
                    showMessage('Deposit invoice created successfully!', 'success');
                    
                    // Trigger celebration confetti
                    celebrateMilestone('invoice_sent', session.clientName);
                    
                    // Open the invoice URL in a new tab
                    window.open(result.invoice_url, '_blank');
                    
                    // Show a dialog with invoice details
                    const remainingBalance = session.price - depositAmount;
                    const message = `Deposit invoice created successfully!\n\nRetainer: $${depositAmount}\nRemaining Balance: $${remainingBalance.toFixed(2)}\n\nInvoice URL: ${result.invoice_url}\n\nThe invoice has been sent to ${session.email}`;
                    alert(message);
                } else {
                    throw new Error(result.error || 'Unknown error creating deposit invoice');
                }
                
            } catch (error) {
                console.error('Error creating deposit invoice:', error);
                showMessage('Error creating deposit invoice: ' + error.message, 'error');
            }
        }

        // Get authentication token helper function
        async function getAuthToken() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    return 'authenticated'; // Simplified token for authenticated requests
                }
                return null;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Set active nav tab
            event.target.classList.add('active');
            
            // Initialize website builder if switching to websites tab
            if (tabName === 'marketing') {
                showMessage('Marketing Suite loaded successfully!', 'success');
            }
            
            // Initialize poses section if selected
            if (tabName === 'poses') {
                initializePosesSection();
            }
        }

        // Photography Website Builder Functionality
        let currentTemplate = null;
        window.websiteSettings = window.websiteSettings || {
            businessName: 'The Legacy Photography',
            tagline: 'Capturing Timeless Moments',
            aboutText: 'Professional photographer specializing in weddings, portraits, and special moments. Creating beautiful memories that last a lifetime.',
            contactPhone: '843-485-1315',
            contactEmail: 'lance@thelegacyphotography.com',
            primaryColor: '#D4AF37',
            backgroundColor: '#1a1a1a',
            textColor: '#ffffff',
            fontStyle: 'serif',
            galleryLayout: 'grid',
            websiteUrl: '',
            seoTitle: 'The Legacy Photography - Professional Wedding & Portrait Photographer',
            seoDescription: 'Professional photography services specializing in weddings, portraits, and special moments. Book your session today.',
            portfolioPhotos: []
        };

        function initializeWebsiteBuilder() {
            console.log('Initializing photography website builder...');
            // Show template selection by default
            showTemplateSelection();
        }

        function showTemplateSelection() {
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('websiteCustomization').style.display = 'none';
        }

        function selectTemplate(templateType) {
            currentTemplate = templateType;
            
            // Update UI
            document.getElementById('templateSelection').style.display = 'none';
            document.getElementById('websiteCustomization').style.display = 'block';
            document.getElementById('selectedTemplateName').textContent = `Customizing: ${getTemplateDisplayName(templateType)}`;
            
            // Load template-specific default settings
            loadTemplateDefaults(templateType);
            
            // Generate initial preview
            updateWebsitePreview();
            
            showMessage(`${getTemplateDisplayName(templateType)} template selected!`, 'success');
            celebrateMilestone('session_created', `${getTemplateDisplayName(templateType)} Website`);
        }

        function getTemplateDisplayName(templateType) {
            const names = {
                legacy: 'Legacy Style',
                modern: 'Modern Portfolio',
                romantic: 'Romantic Style',
                bold: 'Bold & Dramatic'
            };
            return names[templateType] || templateType;
        }

        function loadTemplateDefaults(templateType) {
            const templateDefaults = {
                legacy: {
                    primaryColor: '#D4AF37',
                    backgroundColor: '#1a1a1a',
                    textColor: '#ffffff',
                    fontStyle: 'serif'
                },
                modern: {
                    primaryColor: '#667eea',
                    backgroundColor: '#ffffff',
                    textColor: '#2d3748',
                    fontStyle: 'sans-serif'
                },
                romantic: {
                    primaryColor: '#d4a574',
                    backgroundColor: '#fdf7f0',
                    textColor: '#8b5a3c',
                    fontStyle: 'serif'
                },
                bold: {
                    primaryColor: '#ffffff',
                    backgroundColor: '#000000',
                    textColor: '#ffffff',
                    fontStyle: 'sans-serif'
                }
            };

            const defaults = templateDefaults[templateType];
            if (defaults) {
                Object.assign(websiteSettings, defaults);
                updateFormFields();
            }
        }

        function backToTemplates() {
            // Reset current template
            currentTemplate = null;
            
            // Show template selection
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('websiteCustomization').style.display = 'none';
            
            showMessage('Back to template selection', 'info');
        }

        function showCustomizationSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.customization-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Customization').classList.add('active');
            
            // Update tab states
            document.querySelectorAll('.customization-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function updateFormFields() {
            // Update form fields with current settings
            document.getElementById('businessName').value = websiteSettings.businessName;
            document.getElementById('tagline').value = websiteSettings.tagline;
            document.getElementById('aboutText').value = websiteSettings.aboutText;
            document.getElementById('contactPhone').value = websiteSettings.contactPhone;
            document.getElementById('contactEmail').value = websiteSettings.contactEmail;
            document.getElementById('primaryColor').value = websiteSettings.primaryColor;
            document.getElementById('backgroundColor').value = websiteSettings.backgroundColor;
            document.getElementById('textColor').value = websiteSettings.textColor;
            document.getElementById('fontStyle').value = websiteSettings.fontStyle;
            document.getElementById('galleryLayout').value = websiteSettings.galleryLayout;
            document.getElementById('websiteUrl').value = websiteSettings.websiteUrl;
            document.getElementById('seoTitle').value = websiteSettings.seoTitle;
            document.getElementById('seoDescription').value = websiteSettings.seoDescription;
        }

        function updateWebsiteContent() {
            // Update settings from form fields
            websiteSettings.businessName = document.getElementById('businessName').value;
            websiteSettings.tagline = document.getElementById('tagline').value;
            websiteSettings.aboutText = document.getElementById('aboutText').value;
            websiteSettings.contactPhone = document.getElementById('contactPhone').value;
            websiteSettings.contactEmail = document.getElementById('contactEmail').value;
            
            // Update preview
            updateWebsitePreview();
        }

        function updateWebsiteDesign() {
            // Update design settings from form fields
            websiteSettings.primaryColor = document.getElementById('primaryColor').value;
            websiteSettings.backgroundColor = document.getElementById('backgroundColor').value;
            websiteSettings.textColor = document.getElementById('textColor').value;
            websiteSettings.fontStyle = document.getElementById('fontStyle').value;
            
            // Update preview
            updateWebsitePreview();
        }

        function updateGallerySettings() {
            websiteSettings.galleryLayout = document.getElementById('galleryLayout').value;
            updateWebsitePreview();
        }

        function updateWebsiteSettings() {
            websiteSettings.websiteUrl = document.getElementById('websiteUrl').value;
            websiteSettings.seoTitle = document.getElementById('seoTitle').value;
            websiteSettings.seoDescription = document.getElementById('seoDescription').value;
        }

        function handlePhotoUpload() {
            const files = document.getElementById('portfolioPhotos').files;
            const photoPreview = document.getElementById('photoPreview');
            
            photoPreview.innerHTML = '';
            websiteSettings.portfolioPhotos = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    websiteSettings.portfolioPhotos.push({
                        url: e.target.result,
                        name: file.name
                    });
                    
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-preview-item';
                    photoItem.innerHTML = `<img src="${e.target.result}" alt="${file.name}">`;
                    photoPreview.appendChild(photoItem);
                    
                    updateWebsitePreview();
                };
                
                reader.readAsDataURL(file);
            }
        }

        function setPreviewDevice(device) {
            const previewFrame = document.getElementById('websitePreview');
            const controls = document.querySelectorAll('.preview-control');
            
            // Remove active class from all controls
            controls.forEach(control => control.classList.remove('active'));
            
            // Add active class to selected control
            event.target.classList.add('active');
            
            // Update preview frame class
            previewFrame.className = `website-preview-frame ${device}`;
        }

        function updateWebsitePreview() {
            if (!currentTemplate) return;
            
            const previewFrame = document.getElementById('websitePreview');
            const websiteHTML = generateWebsiteHTML();
            
            previewFrame.innerHTML = websiteHTML;
        }

        function generateWebsiteHTML() {
            const templates = {
                legacy: generateLegacyTemplate(),
                modern: generateModernTemplate(),
                romantic: generateRomanticTemplate(),
                bold: generateBoldTemplate()
            };
            
            return templates[currentTemplate] || templates.legacy;
        }

        function generateLegacyTemplate() {
            const galleryPhotos = websiteSettings.portfolioPhotos.length > 0 
                ? websiteSettings.portfolioPhotos.slice(0, 6)
                : [
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPortfolio%3C/text%3E%3C/svg%3E', name: 'sample1' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPhoto 1%3C/text%3E%3C/svg%3E', name: 'sample2' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPhoto 2%3C/text%3E%3C/svg%3E', name: 'sample3' }
                ];

            return `
                <div style="font-family: ${websiteSettings.fontStyle === 'serif' ? 'Georgia, serif' : websiteSettings.fontStyle === 'script' ? 'Dancing Script, cursive' : 'Arial, sans-serif'}; background: ${websiteSettings.backgroundColor}; color: ${websiteSettings.textColor}; min-height: 100vh;">
                    <!-- Header -->
                    <header style="background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #2d2d2d 100%); padding: 20px; text-align: center; border-bottom: 2px solid ${websiteSettings.primaryColor};">
                        <h1 style="color: ${websiteSettings.primaryColor}; font-size: 2.5rem; margin: 0;">${websiteSettings.businessName}</h1>
                        <nav style="margin-top: 15px;">
                            <a href="#home" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Home</a>
                            <a href="#portfolio" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Portfolio</a>
                            <a href="#about" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">About</a>
                            <a href="#contact" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Contact</a>
                        </nav>
                    </header>

                    <!-- Hero Section -->
                    <section style="padding: 100px 20px; text-align: center; background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #2d2d2d 100%);">
                        <h2 style="font-size: 3.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 20px;">${websiteSettings.tagline}</h2>
                        <p style="font-size: 1.3rem; color: ${websiteSettings.textColor}; opacity: 0.9; max-width: 600px; margin: 0 auto 40px auto;">${websiteSettings.aboutText}</p>
                        <button style="background: ${websiteSettings.primaryColor}; color: ${websiteSettings.backgroundColor}; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">Book Your Session</button>
                    </section>

                    <!-- Portfolio Gallery -->
                    <section style="padding: 80px 20px; background: ${websiteSettings.backgroundColor};">
                        <h3 style="text-align: center; font-size: 2.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 50px;">Portfolio</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                            ${galleryPhotos.map(photo => `
                                <div style="aspect-ratio: 4/3; overflow: hidden; border-radius: 8px; border: 2px solid ${websiteSettings.primaryColor};">
                                    <img src="${photo.url}" alt="${photo.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Contact Section -->
                    <section style="padding: 80px 20px; background: linear-gradient(135deg, #2d2d2d 0%, ${websiteSettings.backgroundColor} 100%); text-align: center;">
                        <h3 style="font-size: 2.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 30px;">Contact</h3>
                        <p style="font-size: 1.2rem; color: ${websiteSettings.textColor}; margin-bottom: 20px;">Ready to capture your special moments?</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.3rem; margin-bottom: 10px;">${websiteSettings.contactPhone}</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.1rem;">${websiteSettings.contactEmail}</p>
                    </section>

                    <!-- Footer -->
                    <footer style="background: ${websiteSettings.backgroundColor}; padding: 40px 20px; text-align: center; border-top: 1px solid ${websiteSettings.primaryColor};">
                        <p style="color: ${websiteSettings.textColor}; opacity: 0.7;">Â© 2025 ${websiteSettings.businessName}. All rights reserved.</p>
                    </footer>
                </div>
            `;
        }

        function previewWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            showMessage('Generating full website preview...', 'info');
            
            const websiteHTML = generateWebsiteHTML();
            const previewHTML = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${websiteSettings.seoTitle}</title>
                    <meta name="description" content="${websiteSettings.seoDescription}">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { line-height: 1.6; }
                        @media (max-width: 768px) {
                            [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
                            [style*="font-size: 3.5rem"] { font-size: 2.5rem !important; }
                            [style*="font-size: 2.5rem"] { font-size: 1.8rem !important; }
                            [style*="padding: 100px"] { padding: 50px 20px !important; }
                            [style*="padding: 80px"] { padding: 40px 20px !important; }
                        }
                    </style>
                </head>
                <body>
                    ${websiteHTML}
                </body>
                </html>
            `;
            
            const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
            
            showMessage('Website preview opened in new tab!', 'success');
            celebrateMilestone('gallery_shared', 'Website Preview');
        }

        function generateModernTemplate() {
            const galleryPhotos = websiteSettings.portfolioPhotos.length > 0 
                ? websiteSettings.portfolioPhotos.slice(0, 6)
                : [
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EModern%3C/text%3E%3C/svg%3E', name: 'sample1' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EPhoto 1%3C/text%3E%3C/svg%3E', name: 'sample2' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EPhoto 2%3C/text%3E%3C/svg%3E', name: 'sample3' }
                ];

            return `
                <div style="font-family: ${websiteSettings.fontStyle === 'serif' ? 'Georgia, serif' : websiteSettings.fontStyle === 'script' ? 'Dancing Script, cursive' : 'Arial, sans-serif'}; background: ${websiteSettings.backgroundColor}; color: ${websiteSettings.textColor}; min-height: 100vh;">
                    <!-- Header -->
                    <header style="background: ${websiteSettings.backgroundColor}; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="color: ${websiteSettings.primaryColor}; font-size: 2.5rem; margin: 0; font-weight: 300;">${websiteSettings.businessName}</h1>
                        <nav style="margin-top: 15px;">
                            <a href="#home" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Home</a>
                            <a href="#portfolio" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Portfolio</a>
                            <a href="#about" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">About</a>
                            <a href="#contact" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Contact</a>
                        </nav>
                    </header>

                    <!-- Hero Section -->
                    <section style="padding: 120px 20px; text-align: center; background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #f8fafc 100%);">
                        <h2 style="font-size: 4rem; color: ${websiteSettings.primaryColor}; margin-bottom: 20px; font-weight: 100;">${websiteSettings.tagline}</h2>
                        <p style="font-size: 1.2rem; color: ${websiteSettings.textColor}; opacity: 0.8; max-width: 600px; margin: 0 auto 40px auto;">${websiteSettings.aboutText}</p>
                        <button style="background: ${websiteSettings.primaryColor}; color: white; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1rem; cursor: pointer; font-weight: 500;">Get Started</button>
                    </section>

                    <!-- Portfolio Gallery -->
                    <section style="padding: 100px 20px; background: ${websiteSettings.backgroundColor};">
                        <h3 style="text-align: center; font-size: 3rem; color: ${websiteSettings.textColor}; margin-bottom: 60px; font-weight: 200;">Portfolio</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
                            ${galleryPhotos.map(photo => `
                                <div style="aspect-ratio: 4/3; overflow: hidden; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                    <img src="${photo.url}" alt="${photo.name}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;">
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Contact Section -->
                    <section style="padding: 100px 20px; background: linear-gradient(135deg, #f8fafc 0%, ${websiteSettings.backgroundColor} 100%); text-align: center;">
                        <h3 style="font-size: 3rem; color: ${websiteSettings.textColor}; margin-bottom: 30px; font-weight: 200;">Let's Connect</h3>
                        <p style="font-size: 1.1rem; color: ${websiteSettings.textColor}; margin-bottom: 30px; opacity: 0.8;">Ready to create something beautiful together?</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.4rem; margin-bottom: 10px; font-weight: 500;">${websiteSettings.contactPhone}</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.1rem;">${websiteSettings.contactEmail}</p>
                    </section>

                    <!-- Footer -->
                    <footer style="background: ${websiteSettings.textColor}; padding: 40px 20px; text-align: center;">
                        <p style="color: ${websiteSettings.backgroundColor}; opacity: 0.7;">Â© 2025 ${websiteSettings.businessName}. Crafted with care.</p>
                    </footer>
                </div>
            `;
        }

        function generateRomanticTemplate() {
            return generateLegacyTemplate(); // Use legacy template structure with romantic colors
        }

        function generateBoldTemplate() {
            return generateModernTemplate(); // Use modern template structure with bold colors
        }

        function publishWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            showMessage('Publishing website...', 'info');
            
            setTimeout(() => {
                const websiteUrl = websiteSettings.websiteUrl || websiteSettings.businessName.toLowerCase().replace(/\s+/g, '-');
                const publishedUrl = `https://${websiteUrl}.replit.app`;
                showMessage('Website published successfully!', 'success');
                celebrateMilestone('session_delivered', websiteSettings.businessName);
                
                alert(`Website Published!\n\nLive URL: ${publishedUrl}\n\nYour photography website is now live and ready for clients. Share this link to showcase your work!`);
            }, 2000);
        }

        // Website builder utility functions
        function resetWebsiteBuilder() {
            currentTemplate = null;
            websiteSettings = {
                businessName: 'The Legacy Photography',
                tagline: 'Capturing Timeless Moments',
                aboutText: 'Professional photographer specializing in weddings, portraits, and special moments. Creating beautiful memories that last a lifetime.',
                contactPhone: '843-485-1315',
                contactEmail: 'lance@thelegacyphotography.com',
                primaryColor: '#D4AF37',
                backgroundColor: '#1a1a1a',
                textColor: '#ffffff',
                fontStyle: 'serif',
                galleryLayout: 'grid',
                websiteUrl: '',
                seoTitle: 'The Legacy Photography - Professional Wedding & Portrait Photographer',
                seoDescription: 'Professional photography services specializing in weddings, portraits, and special moments. Book your session today.',
                portfolioPhotos: []
            };
            showTemplateSelection();
        }

        // Template Loading Functions
        function showTemplateLoading(templateType) {
            showMessage(`Loading ${getTemplateDisplayName(templateType)} template...`, 'info');
            
            // Show loading animation
            setTimeout(() => {
                selectTemplate(templateType);
            }, 800);
        }

        // Website Save/Load Functions
        function saveWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            const websiteData = {
                template: currentTemplate,
                settings: websiteSettings,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('photography_website', JSON.stringify(websiteData));
            showMessage('Website saved successfully!', 'success');
        }

        function loadSavedWebsite() {
            const savedData = localStorage.getItem('photography_website');
            if (savedData) {
                const websiteData = JSON.parse(savedData);
                currentTemplate = websiteData.template;
                websiteSettings = websiteData.settings;
                
                selectTemplate(currentTemplate);
                showMessage('Saved website loaded!', 'success');
            } else {
                showMessage('No saved website found', 'error');
            }
        }

        // End of Photography Website Builder
        // ========================================
        // REVOLUTIONARY WEBSITE BUILDER FUNCTIONS
        // ========================================

        // Website Builder State
        let builderMode = 'template';
        let brandSettings = {
            logo: 'attached_assets/logo_1753330290399.png',
            businessName: 'The Legacy Photography',
            primaryFont: 'system',
            colors: {
                primary: '#d4af37',
                secondary: '#f4e4bc',
                accent: '#8b7355',
                text: '#ffffff'
            }
        };
        let selectedElement = null;
        
        // REVOLUTIONARY LIGHTBOX GALLERY SYSTEM
        function openLightbox(imageUrl, description) {
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.95); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
                backdrop-filter: blur(15px); animation: lightboxFadeIn 0.4s ease;
            `;
            
            lightbox.innerHTML = `
                <div onclick="event.stopPropagation()" style="max-width: 90%; max-height: 90%; text-align: center; animation: lightboxZoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                    <img src="${imageUrl}" style="max-width: 100%; max-height: 80vh; border-radius: 15px; box-shadow: 0 25px 80px rgba(0,0,0,0.8), 0 0 40px rgba(212,175,55,0.3);">
                    <p style="color: #f4e4bc; margin-top: 25px; font-size: 1.3em; font-style: italic; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">${description}</p>
                    <button onclick="document.body.removeChild(this.closest('.revolutionary-lightbox'))" style="margin-top: 25px; background: linear-gradient(135deg, #d4af37, #f4e4bc); color: #1a1a1a; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 8px 25px rgba(212,175,55,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Star Close Gallery</button>
                </div>
                <style>
                    @keyframes lightboxFadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes lightboxZoomIn { from { transform: scale(0.7) rotate(-5deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes pulse-invite { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
                    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-8px); } 60% { transform: translateY(-4px); } }
                    @keyframes galleryBounce { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
                </style>
            `;
            
            lightbox.className = 'revolutionary-lightbox';
            lightbox.onclick = () => document.body.removeChild(lightbox);
            document.body.appendChild(lightbox);
        }
        
        // SMOOTH SCROLL TO GALLERY WITH BOUNCE EFFECT
        function scrollToGallery() {
            const gallery = document.getElementById('photoGallery') || document.querySelector('[style*="Featured Work"]').parentElement;
            if (gallery) {
                gallery.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a subtle bounce animation to the gallery
                setTimeout(() => {
                    gallery.style.animation = 'galleryBounce 0.6s ease-out';
                    setTimeout(() => { gallery.style.animation = ''; }, 600);
                }, 800);
            }
        }

        // CONTACT FORM FUNCTIONALITY
        function sendContactEmail() {
            const name = document.getElementById('contactName')?.value || '';
            const email = document.getElementById('contactEmail')?.value || '';
            const phone = document.getElementById('contactPhone')?.value || '';
            const message = document.getElementById('contactMessage')?.value || '';

            if (!name || !email || !message) {
                alert('Please fill in your name, email, and message before sending.');
                return;
            }

            const subject = `Photography Inquiry from ${name}`;
            const body = `Hi Lance,

${message}

Contact Details:
- Name: ${name}
- Email: ${email}
${phone ? `- Phone: ${phone}` : ''}

Looking forward to hearing from you!

Best regards,
${name}`;

            const mailtoLink = `mailto:lance@thelegacyphotography.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_self');
        }

        function sendQuickText() {
            const name = document.getElementById('contactName')?.value || 'Someone';
            const message = `Hi Lance! ${name} here. I found your website and absolutely love your photography style! I'm interested in booking a session. When are you available to chat about my vision?`;
            const smsLink = `sms:8434851315?&body=${encodeURIComponent(message)}`;
            window.open(smsLink, '_self');
        }

        // Builder Mode Switching
        function switchBuilderMode(mode) {
            builderMode = mode;
            
            // Update button states
            document.getElementById('templateModeBtn').classList.toggle('active', mode === 'template');
            document.getElementById('customModeBtn').classList.toggle('active', mode === 'custom');
            
            // Show/hide appropriate interface
            document.getElementById('templateGalleryMode').classList.toggle('active', mode === 'template');
            document.getElementById('customBuilderMode').classList.toggle('active', mode === 'custom');
            
            console.log(`ðŸ”„ Switched to ${mode} mode`);
        }

        // Template System
        function useTemplate(templateType) {
            console.log(`ðŸ“‹ Loading ${templateType} template...`);
            
            // Switch to custom mode to show the built template
            switchBuilderMode('custom');
            
            // Clear existing content
            const websiteContent = document.getElementById('websiteContent');
            websiteContent.innerHTML = '';
            
            // Generate template based on type
            generateTemplate(templateType);
            
            // Show success message (confetti function may not be available in builder context)
            console.log('Template loaded successfully! Ready for customization.');
        }

        function generateTemplate(templateType) {
            const templates = {
                legacy: () => {
                    // Update brand colors for legacy theme
                    brandSettings.colors.primary = '#1a1a1a';
                    brandSettings.colors.secondary = '#8b7355';
                    brandSettings.colors.accent = '#d4af37';
                    
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #1a1a1a 0%, #8b7355 100%);' },
                        { type: 'about', style: 'background: #f8f6f0;' },
                        { type: 'gallery', style: 'background: white;' },
                        { type: 'services', style: 'background: #1a1a1a; color: #8b7355;' },
                        { type: 'contact', style: 'background: #8b7355;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 300, comp.style);
                        }, index * 300);
                    });
                },
                
                modern: () => {
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' },
                        { type: 'gallery', style: 'background: #f8f9fa;' },
                        { type: 'about', style: 'background: white;' },
                        { type: 'services', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' },
                        { type: 'contact', style: 'background: #2d3748; color: white;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 350, comp.style);
                        }, index * 300);
                    });
                },
                
                elegant: () => {
                    brandSettings.colors.primary = '#8B4513';
                    brandSettings.colors.secondary = '#D2B48C';
                    brandSettings.colors.accent = '#CD853F';
                    brandSettings.primaryFont = 'serif';
                    
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);' },
                        { type: 'gallery', style: 'background: #FDF5E6;' },
                        { type: 'about', style: 'background: white;' },
                        { type: 'services', style: 'background: #8B4513; color: #D2B48C;' },
                        { type: 'contact', style: 'background: #D2B48C; color: #8B4513;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 300, comp.style);
                        }, index * 300);
                    });
                },
                
                'legacy-elite': () => {
                    // Your custom colors based on actual website
                    brandSettings.colors.primary = '#d4af37';
                    brandSettings.colors.secondary = '#8b7355';
                    brandSettings.colors.accent = '#f4e4bc';
                    brandSettings.colors.text = '#ffffff';
                    brandSettings.primaryFont = 'playfair';
                    brandSettings.businessName = 'The Legacy Photography';
                    
                    const components = [
                        { 
                            type: 'legacy-hero', 
                            style: 'background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2c1810 100%); position: relative;' 
                        },
                        { 
                            type: 'legacy-philosophy', 
                            style: 'background: linear-gradient(135deg, #2c1810 0%, #1a1a1a 100%); color: #d4af37;' 
                        },
                        { 
                            type: 'legacy-gallery', 
                            style: 'background: #0f0f0f; color: #d4af37;' 
                        },
                        { 
                            type: 'legacy-testimonials', 
                            style: 'background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%); color: #1a1a1a;' 
                        },
                        { 
                            type: 'legacy-about', 
                            style: 'background: linear-gradient(135deg, #1a1a1a 0%, #2c1810 100%); color: #f4e4bc;' 
                        },
                        { 
                            type: 'legacy-services', 
                            style: 'background: linear-gradient(135deg, #0f0f0f 0%, #2c1810 100%); color: #f4e4bc;' 
                        },
                        { 
                            type: 'legacy-contact', 
                            style: 'background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%); color: #1a1a1a;' 
                        }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 400, comp.style);
                        }, index * 400);
                    });
                    
                    // Show special success message for your custom template
                    setTimeout(() => {
                        console.log('Fire Legacy Elite template loaded! Your brand is perfectly captured!');
                    }, 2000);
                }
            };
            
            if (templates[templateType]) {
                templates[templateType]();
            }
        }

        function createTemplateComponent(type, yPosition, customStyle) {
            const element = document.createElement('div');
            element.className = 'website-component draggable-element element-enter';
            element.style.position = 'relative';
            element.style.width = '100%';
            element.style.minHeight = '300px';
            element.style.fontFamily = getFontFamily();
            element.dataset.componentType = type;
            
            const components = {
                hero: `<div style="${customStyle} padding: 80px 20px; text-align: center; color: white;">
                    <div class="logo-placeholder" style="margin-bottom: 20px; display: flex; justify-content: center;">
                        ${brandSettings.logo ? `<img src="${brandSettings.logo}" style="height: 60px; width: auto;">` : 'ðŸ¢ Logo Here'}
                    </div>
                    <h1 class="business-name" style="font-size: 3em; margin-bottom: 20px;">${brandSettings.businessName}</h1>
                    <p style="font-size: 1.4em; margin-bottom: 30px;">Capturing life's precious moments with artistic vision</p>
                    <button style="background: white; color: ${brandSettings.colors.primary}; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 18px;">View Portfolio</button>
                </div>`,
                
                gallery: `<div style="${customStyle} padding: 60px 20px;">
                    <h2 style="text-align: center; margin-bottom: 40px; color: ${brandSettings.colors.primary}; font-size: 2.5em;">Featured Work</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                    </div>
                </div>`,
                
                about: `<div style="${customStyle} padding: 80px 20px;">
                    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                        <h2 style="color: ${brandSettings.colors.primary}; font-size: 2.5em; margin-bottom: 30px;">About <span class="business-name">${brandSettings.businessName}</span></h2>
                        <p style="font-size: 1.3em; line-height: 1.8; color: ${brandSettings.colors.text};">We specialize in capturing the authentic emotions and beautiful moments that make your story unique. With over 10 years of experience, we bring artistic vision and technical expertise to every session, creating timeless memories that you'll treasure forever.</p>
                    </div>
                </div>`,
                
                services: `<div style="${customStyle} padding: 80px 20px;">
                    <h2 style="text-align: center; margin-bottom: 50px; font-size: 2.5em;">Our Services</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; max-width: 1000px; margin: 0 auto;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Wedding Photography</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Capturing your special day with elegance and emotion</p>
                        </div>
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Portrait Sessions</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Professional headshots and family portraits</p>
                        </div>
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Event Photography</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Corporate events and special celebrations</p>
                        </div>
                    </div>
                </div>`,
                
                contact: `<div style="${customStyle} padding: 80px 20px;">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h2 style="text-align: center; margin-bottom: 40px; font-size: 2.5em;">Contact <span class="business-name">${brandSettings.businessName}</span></h2>
                        <div style="display: grid; gap: 20px;">
                            <input type="text" placeholder="Your Name" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px;">
                            <input type="email" placeholder="Your Email" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px;">
                            <textarea placeholder="Tell us about your photography needs..." rows="6" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                            <button style="background: ${brandSettings.colors.accent}; color: white; border: none; padding: 18px 30px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer;">Send Message</button>
                        </div>
                    </div>
                </div>`,

                // Custom Legacy Elite Components
                'legacy-hero': `<div style="${customStyle} padding: 120px 20px; text-align: center; position: relative; overflow: hidden; background-image: linear-gradient(rgba(15, 15, 15, 0.8), rgba(26, 26, 26, 0.9)), url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: center; background-attachment: fixed;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 70%); pointer-events: none;"></div>
                    <div style="position: relative; z-index: 1;">
                        <div class="logo-placeholder" style="margin-bottom: 40px; display: flex; justify-content: center;">
                            <img src="attached_assets/logo_1753330290399.png" style="height: 200px; width: auto; filter: drop-shadow(0 12px 24px rgba(0,0,0,0.9)) drop-shadow(0 0 30px rgba(212,175,55,0.4)) drop-shadow(0 0 60px rgba(212,175,55,0.2));">
                        </div>
                        <h2 style="font-size: 2.2em; margin-bottom: 20px; color: #f4e4bc; font-weight: 300; font-style: italic; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">Lance Casselman</h2>
                        <p style="font-size: 1.4em; margin-bottom: 40px; color: rgba(244, 228, 188, 0.95); max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">"Your Life, Your Legacy, Perfectly Captured!"</p>
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="scrollToGallery()" style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 18px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3); transform: perspective(1000px) rotateX(0deg); animation: float 3s ease-in-out infinite;">View Portfolio</button>
                            <a href="sms:8434851315?&body=Hi Lance! I found your website and I'm blown away by your photography. I'd love to discuss booking a session!" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 16px 33px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); text-decoration: none; display: inline-block; animation: pulse-glow 2s ease-in-out infinite alternate;">Mobile Text: 843-485-1315</a>
                        </div>
                        
                        <!-- FLOATING PARTICLES ANIMATION -->
                        <div class="floating-particles" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;">
                            <div style="position: absolute; width: 4px; height: 4px; background: #d4af37; border-radius: 50%; opacity: 0.6; animation: float-particle 8s linear infinite; top: 20%; left: 10%;"></div>
                            <div style="position: absolute; width: 6px; height: 6px; background: #f4e4bc; border-radius: 50%; opacity: 0.4; animation: float-particle 12s linear infinite; top: 60%; left: 80%; animation-delay: -2s;"></div>
                            <div style="position: absolute; width: 3px; height: 3px; background: #d4af37; border-radius: 50%; opacity: 0.7; animation: float-particle 10s linear infinite; top: 40%; left: 30%; animation-delay: -5s;"></div>
                            <div style="position: absolute; width: 5px; height: 5px; background: #f4e4bc; border-radius: 50%; opacity: 0.5; animation: float-particle 15s linear infinite; top: 80%; left: 60%; animation-delay: -8s;"></div>
                        </div>
                    </div>
                </div>`,

                'legacy-philosophy': `<div style="${customStyle} padding: 100px 20px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://images-pw.pixieset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg'); background-size: cover; background-position: center; opacity: 0.15; background-attachment: fixed;"></div>
                    <div style="position: relative; z-index: 1; max-width: 1000px; margin: 0 auto; text-align: center;">
                        <h2 style="color: #d4af37; font-size: 3em; margin-bottom: 40px; font-family: 'Playfair Display', serif; font-weight: 400; font-style: italic; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Capturing Unforgettable South Carolina Moments</h2>
                        <div style="font-size: 1.4em; line-height: 1.8; color: #f4e4bc; margin-bottom: 40px;">
                            <p style="margin-bottom: 25px; font-style: italic; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">"Time doesn't wait... We blink and the kids are grown... We laugh and the moment slips away..."</p>
                            <p style="margin-bottom: 25px; color: #d4af37; font-weight: 500; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 1.2em;">"But through photography, we get to hold on."</p>
                            <p style="margin-bottom: 25px; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">I created this brand to honor that ideaâ€”to give families, couples, and individuals a way to capture life exactly as it isâ€¦ and to make sure it lives on.</p>
                            <p style="color: #d4af37; font-weight: 500; font-size: 1.2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px; backdrop-filter: blur(10px);">"You bring your story, your people, your loveâ€”I bring the lens, the light, and the vision to preserve it forever. Together, we create something timeless."</p>
                        </div>
                    </div>
                </div>`,

                'legacy-gallery': `<div style="${customStyle} padding: 100px 20px;">
                    <h2 style="text-align: center; margin-bottom: 60px; color: #d4af37; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400;">Featured Work</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto;">
                        <div onclick="openLightbox('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg', 'Dramatic portrait with stunning architectural elements and cinematic lighting - captured during a Charleston session')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #d4af37, #f4e4bc); color: #1a1a1a; padding: 8px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">Star Featured</div>
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Dramatic Portraits</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg', 'Breathtaking beach silhouette at golden hour with dramatic sky - the magic of Myrtle Beach sunsets')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)';" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Beach Silhouettes</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg', 'Beautiful Myrtle Beach photography session with natural lighting and genuine emotion captured')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Myrtle Beach Sessions</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg', 'Heartwarming family portrait capturing genuine emotions, connections, and the love that binds us together')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Family Moments</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg', 'Stunning Charleston architecture providing the perfect historic backdrop for timeless portraits')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: top; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Charleston Architecture</div>
                        </div>
                        <div style="aspect-ratio: 4/5; background: linear-gradient(135deg, #8b7355 0%, #d4af37 50%, #f4e4bc 100%); border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #1a1a1a; font-size: 1.2em; text-align: center; font-family: 'Playfair Display', serif; cursor: pointer; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);" onclick="window.open('sms:8434851315?&body=Hi Lance! I absolutely love your photography style and would like to book a session. When are you available?', '_self')" onmouseover="this.style.transform='scale(1.1) rotate(3deg)'; this.style.boxShadow='0 20px 40px rgba(212,175,55,0.4)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='none'">
                            <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 12px; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.1); animation: pulse-invite 3s ease-in-out infinite;">
                                <div style="font-size: 2.5em; margin-bottom: 15px; animation: bounce 2s ease-in-out infinite; color: #d4af37;">â—</div>
                                <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">Book Your Session</div>
                                <div style="font-size: 0.9em; opacity: 0.8; color: #8b7355;">Tap to Get Started</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 50px;">
                        <button style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 18px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer;">View Complete Portfolio</button>
                    </div>
                </div>`,

                'legacy-about': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center;">
                            <div>
                                <h2 style="color: #d4af37; font-size: 3em; margin-bottom: 30px; font-family: 'Playfair Display', serif; font-weight: 400;">My Goal For You</h2>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #f4e4bc; margin-bottom: 25px;">My goal for you is more than just taking pictures â€” it's to create something that moves you every single time you look back.</p>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #f4e4bc; margin-bottom: 25px;">I want you to feel proud, radiant, and seen. I want your photos to transport you back to those moments â€” the laughter, the love, the light in your eyes â€” with all the depth and emotion still intact.</p>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #d4af37; font-weight: 500;">Because your story matters. And it deserves to be captured in a way that feels just as unforgettable as the moments themselves.</p>
                            </div>
                            <div style="background-image: url('https://images-pw.pixieset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg'); background-size: cover; background-position: center; aspect-ratio: 4/5; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; text-align: center;">
                                    <p style="color: #d4af37; font-weight: bold; font-size: 1.1em; margin: 0;">South Carolina Coast</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`,

                'legacy-contact': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: 20px; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400;">Ready to Capture Your Legacy?</h2>
                        <p style="font-size: 1.4em; margin-bottom: 50px; line-height: 1.6;">Call or Text 843-485-1315 or Submit a Message Below</p>
                        <div style="display: grid; gap: 20px; margin-bottom: 40px;">
                            <input id="contactName" type="text" placeholder="Your Name" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <input id="contactEmail" type="email" placeholder="Your Email" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <input id="contactPhone" type="tel" placeholder="Your Phone Number (optional)" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <textarea id="contactMessage" placeholder="Tell me about your photography vision..." rows="6" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; resize: vertical; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'"></textarea>
                            <button onclick="sendContactEmail()" style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 20px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212,175,55,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(212,175,55,0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(212,175,55,0.3)'">Send Email</button>
                        </div>
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                            <a href="sms:8434851315?&body=Hi Lance! I'm interested in booking a photo session with The Legacy Photography. I found your website and love your style! When are you available?" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Text Message</a>
                            <a href="tel:8434851315" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Call Direct</a>
                            <button onclick="sendQuickText()" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Quick Booking</button>
                        </div>
                    </div>
                </div>`,

                // NEW MIND-BLOWING COMPONENTS
                'legacy-testimonials': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                        <h2 style="color: #1a1a1a; font-size: 3em; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-weight: 400; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">What Clients Say</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px;">
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">StarStarStarStarStar</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"Lance captured our family perfectly! The photos are absolutely stunning and we treasure them every day. His artistic vision is incredible."</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Sarah & Mike Johnson</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Family Portrait Session</div>
                            </div>
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">StarStarStarStarStar</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"Our wedding photos are pure magic! Lance has an incredible eye for capturing those perfect, emotional moments that tell our love story."</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Jennifer & David Chen</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Wedding Photography</div>
                            </div>
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">StarStarStarStarStar</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"The beach session was amazing! Lance made us feel so comfortable and the sunset photos are absolutely breathtaking. Pure artistry!"</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Amanda Rodriguez</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Senior Portrait Session</div>
                            </div>
                        </div>
                    </div>
                </div>`,

                'legacy-services': `<div style="${customStyle} padding: 100px 20px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://images-pw.pixieset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg'); background-size: cover; background-position: center; opacity: 0.1; background-attachment: fixed;"></div>
                    <div style="position: relative; z-index: 1; max-width: 1200px; margin: 0 auto;">
                        <h2 style="text-align: center; margin-bottom: 60px; color: #d4af37; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Photography Services</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px;">
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ðŸ’’</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Wedding Photography</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Capture your special day with elegance and emotion. From intimate ceremonies to grand celebrations.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $2,500</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Family Portraits</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Beautiful family moments that become treasured memories. Beach, park, or studio sessions available.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $450</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ðŸ–ï¸</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Beach Sessions</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Stunning Myrtle Beach and Charleston coast photography with golden hour lighting and ocean backdrops.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $350</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ðŸŽ“</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Senior Portraits</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Celebrate this milestone with professional senior portraits that showcase personality and achievement.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $400</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 60px;">
                            <a href="sms:8434851315?&body=Hi! I'd like to discuss photography services and get a custom quote." style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; text-decoration: none; padding: 20px 40px; border-radius: 12px; font-weight: bold; font-size: 1.2em; display: inline-block; box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4); transition: all 0.3s ease;">Mobile Get Custom Quote</a>
                        </div>
                    </div>
                </div>`
            };
            
            element.innerHTML = components[type] || '';
            
            // Add click handler for selection
            element.addEventListener('click', (e) => {
                e.stopPropagation();
                selectElement(element);
            });
            
            // Add to canvas
            const websiteContent = document.getElementById('websiteContent');
            websiteContent.appendChild(element);
        }

        // Branding Functions
        function uploadLogo(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    brandSettings.logo = e.target.result;
                    
                    // Show logo preview
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 60px; border-radius: 4px;">`;
                    
                    // Update all logo instances on the website
                    updateLogosOnWebsite();
                    
                    console.log('Logo uploaded and applied to website');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateBusinessName() {
            const name = document.getElementById('businessName').value;
            brandSettings.businessName = name;
            
            // Update all business name instances
            const elements = document.querySelectorAll('.business-name');
            elements.forEach(el => {
                el.textContent = name;
            });
            
            console.log(`Business name updated to: ${name}`);
        }

        function changePrimaryFont(fontFamily) {
            brandSettings.primaryFont = fontFamily;
            
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                'serif': 'Georgia, "Times New Roman", serif',
                'playfair': '"Playfair Display", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'modern': '"Helvetica Neue", Helvetica, Arial, sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'roboto': '"Roboto", sans-serif'
            };
            
            // Load Google Fonts if needed
            if (['playfair', 'lora', 'crimson', 'montserrat', 'opensans', 'roboto'].includes(fontFamily)) {
                loadGoogleFont(fontFamily);
            }
            
            // Apply font to website
            const websiteContent = document.getElementById('websiteContent');
            if (websiteContent) {
                websiteContent.style.fontFamily = fontMap[fontFamily];
            }
            
            console.log(`ðŸ”¤ Font changed to: ${fontFamily}`);
        }

        // Initialize website builder when tab is opened
        function initializeWebsiteBuilder() {
            console.log('Initializing photography website builder...');
            
            // Load Playfair Display font for your template
            loadGoogleFont('playfair');
            
            // Set default business name to yours
            const businessNameInput = document.getElementById('businessName');
            if (businessNameInput) {
                businessNameInput.value = 'The Legacy Photography';
            }
            
            // Add revolutionary CSS animations to the page
            if (!document.getElementById('revolutionaryStyles')) {
                const revolutionaryCSS = document.createElement('style');
                revolutionaryCSS.id = 'revolutionaryStyles';
                revolutionaryCSS.innerHTML = `
                    /* MIND-BLOWING ANIMATIONS */
                    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-12px); } }
                    @keyframes pulse-glow { 
                        0% { box-shadow: 0 0 5px rgba(212,175,55,0.3), 0 0 10px rgba(212,175,55,0.1); } 
                        100% { box-shadow: 0 0 25px rgba(212,175,55,0.8), 0 0 35px rgba(212,175,55,0.4), 0 0 45px rgba(212,175,55,0.2); } 
                    }
                    @keyframes float-particle { 
                        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 
                        10% { opacity: 1; }
                        90% { opacity: 1; }
                        100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } 
                    }
                    @keyframes bounce { 
                        0%, 100% { transform: translateY(0); } 
                        50% { transform: translateY(-10px); } 
                    }
                    @keyframes pulse-invite { 
                        0%, 100% { transform: scale(1) rotate(0deg); } 
                        50% { transform: scale(1.08) rotate(1deg); } 
                    }
                    @keyframes galleryBounce {
                        0% { transform: scale(1); }
                        30% { transform: scale(1.02); }
                        60% { transform: scale(0.98); }
                        100% { transform: scale(1); }
                    }
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                    @keyframes fadeInUp {
                        from { opacity: 0; transform: translateY(30px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(revolutionaryCSS);
            }
        }

        function loadGoogleFont(font) {
            const fontUrls = {
                'playfair': 'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap',
                'lora': 'https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap',
                'crimson': 'https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&display=swap',
                'montserrat': 'https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap',
                'opensans': 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap',
                'roboto': 'https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap'
            };
            
            if (!document.querySelector(`link[href="${fontUrls[font]}"]`)) {
                const link = document.createElement('link');
                link.href = fontUrls[font];
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }

        function updateBrandColor(colorType, colorValue) {
            brandSettings.colors[colorType] = colorValue;
            
            // Apply color changes to website elements would go here
            console.log(`ðŸŽ¨ ${colorType} color updated to: ${colorValue}`);
        }

        function updateLogosOnWebsite() {
            if (!brandSettings.logo) return;
            
            // Find and update all logo placeholders
            const logoElements = document.querySelectorAll('.logo-placeholder');
            logoElements.forEach(el => {
                el.innerHTML = `<img src="${brandSettings.logo}" style="height: 60px; width: auto;">`;
            });
        }

        function getFontFamily() {
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                'serif': 'Georgia, "Times New Roman", serif',
                'playfair': '"Playfair Display", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'modern': '"Helvetica Neue", Helvetica, Arial, sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'roboto': '"Roboto", sans-serif'
            };
            return fontMap[brandSettings.primaryFont];
        }

        // AI Functions
        function generateAILayout() {
            console.log('ðŸ¤– AI generating optimal layout...');
            alert('AI suggests: Add testimonials section to build trust! This would increase conversions by 35%.');
        }

        function optimizeForMobile() {
            console.log('Mobile AI optimizing for mobile devices...');
            alert('Mobile optimization complete! Your site now loads 40% faster on mobile devices.');
        }

        function suggestColors() {
            console.log('ðŸŽ¨ AI analyzing your photos for color palette...');
            const palettes = [
                'Deep Blues: #2C3E50, #3498DB, #ECF0F1',
                'Warm Earth: #8B4513, #D2691E, #F4A460', 
                'Modern Minimal: #2D3748, #4A5568, #E2E8F0'
            ];
            const palette = palettes[Math.floor(Math.random() * palettes.length)];
            alert(`AI suggests color palette: ${palette}`);
        }

        function generateContent() {
            console.log('âœï¸ AI writing professional photography content...');
            alert('AI generated professional content for your sections! Check your About section for enhanced copy.');
        }

        // Device Preview Functions
        function setDevicePreview(device) {
            const canvas = document.getElementById('websiteCanvas');
            const buttons = document.querySelectorAll('.device-btn');
            
            // Update button states
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update canvas size
            canvas.className = 'website-canvas';
            if (device === 'mobile') {
                canvas.style.maxWidth = '375px';
                canvas.style.margin = '20px auto';
            } else if (device === 'tablet') {
                canvas.style.maxWidth = '768px';
                canvas.style.margin = '20px auto';
            } else {
                canvas.style.maxWidth = 'none';
                canvas.style.margin = '20px';
            }
            
            console.log(`Mobile Switched to ${device} preview mode`);
        }

        // Drag and Drop Functions
        function allowDrop(e) {
            e.preventDefault();
        }

        function dropComponent(e) {
            e.preventDefault();
            const componentType = e.dataTransfer.getData('text/plain');
            if (componentType) {
                createTemplateComponent(componentType, 0, '');
                console.log(`${componentType} component added successfully!`);
            }
        }

        // Element Selection
        function selectElement(element) {
            // Remove previous selection
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            
            // Select new element
            selectedElement = element;
            element.classList.add('selected');
            
            // Show properties panel
            showPropertiesPanel(element);
        }

        function showPropertiesPanel(element) {
            const panel = document.getElementById('propertyPanel');
            panel.innerHTML = `
                <div>
                    <h4>Element Properties</h4>
                    <div style="margin: 15px 0;">
                        <label>Background Color:</label>
                        <input type="color" value="#667eea" onchange="updateElementStyle(this, 'backgroundColor')" style="width: 100%; height: 35px; border: none; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>Text Color:</label>
                        <input type="color" value="#333333" onchange="updateElementStyle(this, 'color')" style="width: 100%; height: 35px; border: none; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>Padding:</label>
                        <input type="range" min="0" max="100" value="20" onchange="updateElementStyle(this, 'padding', this.value + 'px')" style="width: 100%; margin-top: 5px;">
                    </div>
                    <button onclick="deleteElement()" style="background: rgba(0, 0, 0, 0.7); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.4); padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 15px;">
                        Delete Element
                    </button>
                </div>
            `;
        }

        function updateElementStyle(input, property, value) {
            if (selectedElement) {
                const actualValue = value || input.value;
                selectedElement.style[property] = actualValue;
            }
        }

        function deleteElement() {
            if (selectedElement) {
                selectedElement.remove();
                selectedElement = null;
                document.getElementById('propertyPanel').innerHTML = '<div class="no-selection"><p>Select an element to edit properties</p></div>';
                console.log('Element deleted successfully!');
            }
        }

        // Website Actions
        function previewWebsite() {
            console.log('ðŸ‘ï¸ Opening website preview...');
            
            // Get the website content
            const websiteContent = document.getElementById('websiteContent');
            if (!websiteContent || websiteContent.children.length === 0) {
                alert('Please select a template or add components first!');
                return;
            }
            
            // Create preview window
            const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            // Get all the custom styles
            const builderStyles = `
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }
                    .website-component { margin: 0; }
                    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&display=swap');
                </style>
            `;
            
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Website Preview - ${brandSettings.businessName}</title>
                    ${builderStyles}
                </head>
                <body>
                    ${websiteContent.innerHTML}
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            console.log('Website preview opened in new window');
        }

        function publishWebsite() {
            console.log('Publishing website...');
            
            const websiteContent = document.getElementById('websiteContent');
            if (!websiteContent || websiteContent.children.length === 0) {
                alert('Please create a website first by selecting a template or adding components!');
                return;
            }
            
            // In a real implementation, this would save to a server
            alert('Website published successfully! Your site would now be live at your custom domain.');
            console.log('Website published successfully');
        }

        // Setup drag and drop for components
        document.addEventListener('DOMContentLoaded', function() {
            const components = document.querySelectorAll('.component-item');
            components.forEach(component => {
                component.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.component);
                });
            });
        });

        // Add website component selection styles
        const websiteBuilderStyles = `
            .website-component.selected {
                outline: 2px solid #667eea !important;
                outline-offset: 2px;
            }
            
            .website-component {
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .website-component:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .element-enter {
                animation: elementEnter 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            
            @keyframes elementEnter {
                0% {
                    opacity: 0;
                    transform: scale(0.8) translateY(-20px);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
        `;
        
        // Inject styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = websiteBuilderStyles;
        document.head.appendChild(styleSheet);

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked nav tab
            const clickedTab = event.target;
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Initialize sunrise calendar if switching to that tab
            if (tabName === 'sunrise') {
                initializeSunriseCalendar();
            }
        }

        // Sunrise/Sunset Calendar Functions
        function initializeSunriseCalendar() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sunriseDate').value = today;
            
            // Clear any previous results
            document.getElementById('sunriseResults').style.display = 'none';
            document.getElementById('sunriseError').style.display = 'none';
        }

        async function getSunriseSunsetData() {
            const dateInput = document.getElementById('sunriseDate').value;
            const locationInput = document.getElementById('locationInput').value.trim();
            
            if (!dateInput || !locationInput) {
                showSunriseError('Please enter both date and location');
                return;
            }
            
            try {
                let lat, lng;
                
                // Use selected location from search results if available
                if (selectedLocation) {
                    lat = selectedLocation.lat;
                    lng = selectedLocation.lng;
                } else {
                    // Try coordinate parsing as fallback
                    const coordMatch = locationInput.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                    if (coordMatch) {
                        lat = parseFloat(coordMatch[1]);
                        lng = parseFloat(coordMatch[2]);
                    } else {
                        throw new Error('Please select a location from the search results or use coordinates like "32.7765, -79.9311"');
                    }
                }
                
                // Validate coordinates
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    throw new Error('Invalid coordinates. Latitude: -90 to 90, Longitude: -180 to 180');
                }
                
                // Fetch sunrise/sunset data
                const apiUrl = `https://api.sunrisesunset.io/json?lat=${lat}&lng=${lng}&date=${dateInput}`;
                console.log('API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch sunrise data');
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.status !== 'OK') {
                    throw new Error('Invalid response from sunrise API');
                }
                
                displaySunriseData(data.results, selectedLocation ? selectedLocation.displayName : locationInput, dateInput);
                celebrateMilestone('sunrise_data', 'Sunrise Data Loaded');
                
            } catch (error) {
                console.error('Sunrise Error:', error);
                showSunriseError(error.message);
            }
        }

        function displaySunriseData(results, location, date) {
            try {
                // Update location and date
                const locationEl = document.getElementById('sunriseLocation');
                const dateEl = document.getElementById('sunriseSelectedDate');
                
                if (locationEl) locationEl.textContent = `ðŸ“ ${location}`;
                if (dateEl) dateEl.textContent = `Calendar ${new Date(date).toLocaleDateString()}`;
                
                // Update time values based on actual API response structure
                const timeElements = {
                    'sunriseTime': results.sunrise,
                    'sunsetTime': results.sunset,
                    'solarNoon': results.solar_noon,
                    'goldenHourStart': results.golden_hour,
                    'goldenHourEnd': results.dusk,
                    'blueHourEnd': results.last_light
                };
                
                Object.entries(timeElements).forEach(([elementId, value]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = value || '--:--';
                    }
                });
                
                // Show results and hide error
                const resultsEl = document.getElementById('sunriseResults');
                const errorEl = document.getElementById('sunriseError');
                
                if (resultsEl) resultsEl.style.display = 'block';
                if (errorEl) errorEl.style.display = 'none';
                
                // Add celebration animation using the correct function name
                if (typeof celebrateMilestone === 'function') {
                    celebrateMilestone('sunrise_success', 'Sunrise/Sunset Data Loaded Successfully');
                }
                
                // Show success message - check if function exists
                if (typeof showMessage === 'function') {
                    showMessage('Sunrise/sunset data loaded successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Display error:', error);
                showSunriseError('Error displaying sunrise data: ' + error.message);
            }
        }

        function getCityCoordinates(location) {
            const cities = {
                // US Major Cities
                'new york, ny': { lat: 40.7128, lng: -74.0060 },
                'new york': { lat: 40.7128, lng: -74.0060 },
                'los angeles, ca': { lat: 34.0522, lng: -118.2437 },
                'los angeles': { lat: 34.0522, lng: -118.2437 },
                'chicago, il': { lat: 41.8781, lng: -87.6298 },
                'chicago': { lat: 41.8781, lng: -87.6298 },
                'miami, fl': { lat: 25.7617, lng: -80.1918 },
                'miami': { lat: 25.7617, lng: -80.1918 },
                'charleston, sc': { lat: 32.7765, lng: -79.9311 },
                'charleston': { lat: 32.7765, lng: -79.9311 },
                'myrtle beach, sc': { lat: 33.6891, lng: -78.8867 },
                'myrtle beach': { lat: 33.6891, lng: -78.8867 },
                'columbia, sc': { lat: 34.0007, lng: -81.0348 },
                'columbia': { lat: 34.0007, lng: -81.0348 },
                'greenville, sc': { lat: 34.8526, lng: -82.3940 },
                'greenville': { lat: 34.8526, lng: -82.3940 },
                'hilton head, sc': { lat: 32.2163, lng: -80.7526 },
                'hilton head': { lat: 32.2163, lng: -80.7526 },
                'denver, co': { lat: 39.7392, lng: -104.9903 },
                'denver': { lat: 39.7392, lng: -104.9903 },
                'seattle, wa': { lat: 47.6062, lng: -122.3321 },
                'seattle': { lat: 47.6062, lng: -122.3321 },
                'san francisco, ca': { lat: 37.7749, lng: -122.4194 },
                'san francisco': { lat: 37.7749, lng: -122.4194 },
                'austin, tx': { lat: 30.2672, lng: -97.7431 },
                'austin': { lat: 30.2672, lng: -97.7431 },
                'atlanta, ga': { lat: 33.7490, lng: -84.3880 },
                'atlanta': { lat: 33.7490, lng: -84.3880 },
                
                // International Cities
                'london, uk': { lat: 51.5074, lng: -0.1278 },
                'london': { lat: 51.5074, lng: -0.1278 },
                'paris, france': { lat: 48.8566, lng: 2.3522 },
                'paris': { lat: 48.8566, lng: 2.3522 },
                'tokyo, japan': { lat: 35.6762, lng: 139.6503 },
                'tokyo': { lat: 35.6762, lng: 139.6503 },
                'sydney, australia': { lat: -33.8688, lng: 151.2093 },
                'sydney': { lat: -33.8688, lng: 151.2093 },
                'toronto, canada': { lat: 43.6532, lng: -79.3832 },
                'toronto': { lat: 43.6532, lng: -79.3832 }
            };
            
            const normalizedLocation = location.toLowerCase().trim();
            return cities[normalizedLocation] || null;
        }

        function showSunriseError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('sunriseError').style.display = 'block';
            document.getElementById('sunriseResults').style.display = 'none';
        }

        // Workflow Status Management
        async function toggleWorkflowStatus(sessionId, field, checked) {
            try {
                // Find the session in our local array
                const sessionIndex = sessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    showMessage('Session not found', 'error');
                    return;
                }

                // Update the local session object
                sessions[sessionIndex][field] = checked;

                // Send update to server
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...sessions[sessionIndex],
                        [field]: checked
                    })
                });

                if (response.ok) {
                    const updatedSession = await response.json();
                    sessions[sessionIndex] = updatedSession;
                    
                    // Show success message with celebration
                    const fieldLabels = {
                        contractSigned: 'Contract Signed',
                        paid: 'Payment Received', 
                        edited: 'Photos Edited',
                        delivered: 'Session Delivered',
                        sendReminder: 'Reminder Set',
                        notifyGalleryReady: 'Gallery Notification'
                    };
                    
                    const actionText = checked ? 'marked as complete' : 'unmarked';
                    showMessage(`${fieldLabels[field]} ${actionText} for ${sessions[sessionIndex].clientName}`, 'success');
                    
                    // Trigger celebration for major milestones
                    if (checked) {
                        if (field === 'contractSigned') {
                            celebrateMilestone('contract_signed', sessions[sessionIndex].clientName);
                        } else if (field === 'paid') {
                            celebrateMilestone('payment_received', sessions[sessionIndex].clientName);
                        } else if (field === 'delivered') {
                            celebrateMilestone('session_delivered', sessions[sessionIndex].clientName);
                        }
                    }
                } else {
                    // Revert the checkbox if server update failed
                    const checkbox = document.getElementById(`${field}_${sessionId}`);
                    if (checkbox) {
                        checkbox.checked = !checked;
                    }
                    sessions[sessionIndex][field] = !checked;
                    showMessage('Failed to update workflow status', 'error');
                }
            } catch (error) {
                console.error('Error updating workflow status:', error);
                showMessage('Error updating workflow status', 'error');
                
                // Revert the checkbox on error
                const checkbox = document.getElementById(`${field}_${sessionId}`);
                if (checkbox) {
                    checkbox.checked = !checked;
                }
                if (sessionIndex !== -1) {
                    sessions[sessionIndex][field] = !checked;
                }
            }
        }

        // Dropdown Menu Functions
        function toggleDropdown(sessionId) {
            const dropdown = document.getElementById(`dropdown-${sessionId}`);
            const toggle = dropdown.previousElementSibling;
            const isVisible = dropdown.classList.contains('show');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
                menu.style.display = 'none';
                
                // Move back to original container if it was moved to body
                if (menu.parentNode === document.body) {
                    const menuSessionId = menu.id.replace('dropdown-', '');
                    const originalContainer = document.querySelector(`[onclick*="${menuSessionId}"]`).closest('.actions-dropdown');
                    if (originalContainer) {
                        originalContainer.appendChild(menu);
                    }
                }
            });
            
            // Toggle current dropdown
            if (!isVisible) {
                dropdown.classList.add('show');
                
                // Force dropdown to use fixed positioning at viewport level
                const rect = toggle.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (rect.bottom + 5) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.style.width = Math.max(rect.width, 200) + 'px';
                dropdown.style.right = 'auto';
                dropdown.style.bottom = 'auto';
                dropdown.style.zIndex = '2147483647';
                dropdown.style.display = 'block';
                dropdown.style.visibility = 'visible';
                dropdown.style.opacity = '1';
                dropdown.style.background = '#2a2a2a';
                dropdown.style.border = '2px solid #d4af37';
                dropdown.style.borderRadius = '8px';
                dropdown.style.minHeight = '100px';
                dropdown.style.maxHeight = '400px';
                dropdown.style.overflowY = 'auto';
                dropdown.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.3)';
                
                // Move dropdown to document body to escape all container constraints
                document.body.appendChild(dropdown);
                
                console.log('Dropdown repositioned to body:', sessionId, dropdown);
                console.log('Button rect:', rect);
                console.log('Dropdown position:', dropdown.style.top, dropdown.style.left);
            }
        }

        function closeDropdown(sessionId) {
            const dropdown = document.getElementById(`dropdown-${sessionId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
                
                // Move dropdown back to its original container
                const originalParent = document.querySelector(`#dropdown-${sessionId}`).closest('.actions-dropdown');
                if (originalParent && dropdown.parentNode !== originalParent) {
                    originalParent.appendChild(dropdown);
                }
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.actions-dropdown') && !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.style.display = 'none';
                    
                    // Move dropdown back to original container if needed
                    const sessionId = menu.id.replace('dropdown-', '');
                    const originalParent = document.querySelector(`[data-session-id="${sessionId}"] .actions-dropdown`);
                    if (originalParent && menu.parentNode !== originalParent) {
                        originalParent.appendChild(menu);
                    }
                });
            }
        });

        // Reset Sunrise Calendar Function
        function resetSunriseCalendar() {
            // Clear input fields
            document.getElementById('locationInput').value = '';
            document.getElementById('sunriseDate').value = '';
            
            // Reset selected location
            selectedLocation = null;
            
            // Hide results and error sections
            document.getElementById('sunriseResults').style.display = 'none';
            document.getElementById('sunriseError').style.display = 'none';
            document.getElementById('locationResults').style.display = 'none';
            
            // Show success message
            showMessage('Sunrise/Sunset calendar reset successfully!', 'success');
            
            // Optional: Trigger confetti for reset action
            celebrateMilestone('reset', 'Calendar Reset');
        }

        // Location Search Variables
        let searchTimeout;
        let selectedLocation = null;

        // Search for locations as user types
        async function searchLocations(query) {
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    // Use a free geocoding API (Nominatim from OpenStreetMap)
                    const apiUrl = `https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    
                    const results = await response.json();
                    displayLocationResults(results);
                    
                } catch (error) {
                    console.error('Location search error:', error);
                    // Show basic fallback options
                    showFallbackLocations(query);
                }
            }, 300); // Debounce for 300ms
        }

        function displayLocationResults(results) {
            const resultsContainer = document.getElementById('locationResults');
            
            if (results.length === 0) {
                hideSearchResults();
                return;
            }
            
            resultsContainer.innerHTML = results.map(location => `
                <div class="location-result-item" onclick="selectLocation('${location.display_name}', ${location.lat}, ${location.lon})">
                    <div class="location-name">${location.display_name.split(',')[0]}</div>
                    <div class="location-details">${location.display_name}</div>
                </div>
            `).join('');
            
            resultsContainer.style.display = 'block';
        }

        function showFallbackLocations(query) {
            const fallbackLocations = [
                { name: 'Charleston, SC', lat: 32.7765, lng: -79.9311, display: 'Charleston, South Carolina, USA' },
                { name: 'Myrtle Beach, SC', lat: 33.6891, lng: -78.8867, display: 'Myrtle Beach, South Carolina, USA' },
                { name: 'New York, NY', lat: 40.7128, lng: -74.0060, display: 'New York, New York, USA' }
            ];
            
            const filtered = fallbackLocations.filter(loc => 
                loc.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length > 0) {
                const resultsContainer = document.getElementById('locationResults');
                resultsContainer.innerHTML = filtered.map(location => `
                    <div class="location-result-item" onclick="selectLocation('${location.display}', ${location.lat}, ${location.lng})">
                        <div class="location-name">${location.name}</div>
                        <div class="location-details">${location.display}</div>
                    </div>
                `).join('');
                
                resultsContainer.style.display = 'block';
            }
        }

        function selectLocation(displayName, lat, lng) {
            selectedLocation = { displayName, lat, lng };
            document.getElementById('locationInput').value = displayName.split(',')[0];
            hideSearchResults();
            
            // Show success message for location selection
            showMessage(`Location selected: ${displayName.split(',')[0]}`, 'success');
        }

        function showSearchResults() {
            const input = document.getElementById('locationInput');
            if (input.value.length >= 2) {
                document.getElementById('locationResults').style.display = 'block';
            }
        }

        function hideSearchResults() {
            document.getElementById('locationResults').style.display = 'none';
        }

        // Close search results when clicking outside (only if not already bound)
        if (!window.sunriseLocationClickHandlerBound) {
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.location-search-container')) {
                    hideSearchResults();
                }
            });
            window.sunriseLocationClickHandlerBound = true;
        }

        // Dropdown Menu Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById("toolsToggle");
            const menu = document.getElementById("toolsMenu");

            if (toggleBtn && menu) {
                toggleBtn.addEventListener("click", () => {
                    menu.classList.toggle("hidden");
                });

                window.addEventListener("click", function (e) {
                    if (!toggleBtn.contains(e.target) && !menu.contains(e.target)) {
                        menu.classList.add("hidden");
                    }
                });
            }
        });

    </script>

        </div> <!-- End Client Management Tab -->

        <!-- Sunrise/Sunset Calendar Tab Content -->
        <div id="sunriseTab" class="tab-content">
            <div class="sunrise-calendar-container">
                <div class="sunrise-header">
                    <h2>Sunrise Photography Sunrise/Sunset Calendar</h2>
                    <p>Perfect lighting times for outdoor photography sessions</p>
                </div>

                <div class="sunrise-controls">
                    <div class="form-group">
                        <label for="sunriseDate">Calendar Select Date</label>
                        <input type="date" id="sunriseDate" name="sunriseDate" style="padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: #2a2a2a; color: #f5f5f5; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="locationInput">ðŸ“ Location</label>
                        <div class="location-search-container" style="position: relative; width: 300px;">
                            <input type="text" id="locationInput" name="locationInput" placeholder="Start typing city name..." 
                                   autocomplete="off"
                                   oninput="searchLocations(this.value)"
                                   onfocus="showSearchResults()"
                                   style="padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: #2a2a2a; color: #f5f5f5; font-size: 16px; width: 100%;">
                            <div id="locationResults" class="location-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #2a2a2a; border: 2px solid #d4af37; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10000;">
                            </div>
                        </div>
                        <p style="font-size: 0.85em; color: #999; margin-top: 5px;">
                            Type any city or address and select from suggestions
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="getSunriseSunsetData()" class="btn btn-primary" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; font-weight: bold; padding: 12px 24px;">
                            Sunrise Get Sunrise/Sunset Times
                        </button>
                        <button onclick="resetSunriseCalendar()" class="btn btn-secondary" style="background: linear-gradient(135deg, #666, #888); color: #f5f5f5; font-weight: bold; padding: 12px 24px;">
                            ðŸ”„ Reset
                        </button>
                    </div>
                </div>

                <div id="sunriseResults" class="sunrise-results" style="display: none;">
                    <div class="sunrise-card">
                        <h3 id="sunriseLocation">ðŸ“ Location</h3>
                        <p id="sunriseSelectedDate">Calendar Date</p>
                        
                        <div class="sunrise-times-grid">
                            <div class="time-card sunrise">
                                <div class="time-icon">Sunrise</div>
                                <div class="time-label">Sunrise</div>
                                <div class="time-value" id="sunriseTime">--:--</div>
                            </div>
                            
                            <div class="time-card golden-hour-morning">
                                <div class="time-icon">ðŸŒ‡</div>
                                <div class="time-label">Golden Hour Start</div>
                                <div class="time-value" id="goldenHourStart">--:--</div>
                            </div>
                            
                            <div class="time-card solar-noon">
                                <div class="time-icon">â˜€ï¸</div>
                                <div class="time-label">Solar Noon</div>
                                <div class="time-value" id="solarNoon">--:--</div>
                            </div>
                            
                            <div class="time-card golden-hour-evening">
                                <div class="time-icon">ðŸŒ†</div>
                                <div class="time-label">Golden Hour End</div>
                                <div class="time-value" id="goldenHourEnd">--:--</div>
                            </div>
                            
                            <div class="time-card sunset">
                                <div class="time-icon">ðŸŒ‡</div>
                                <div class="time-label">Sunset</div>
                                <div class="time-value" id="sunsetTime">--:--</div>
                            </div>
                            
                            <div class="time-card blue-hour">
                                <div class="time-icon">ðŸŒŒ</div>
                                <div class="time-label">Blue Hour End</div>
                                <div class="time-value" id="blueHourEnd">--:--</div>
                            </div>
                        </div>
                        
                        <div class="photography-tips">
                            <h4>Photo Photography Tips</h4>
                            <div id="photographyTips">
                                <p><strong>Golden Hour:</strong> Soft, warm light perfect for portraits and landscapes</p>
                                <p><strong>Blue Hour:</strong> Even lighting ideal for cityscapes and architecture</p>
                                <p><strong>Solar Noon:</strong> Harsh shadows - avoid outdoor portraits</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sunriseError" class="error-message" style="display: none; background: rgba(255, 0, 0, 0.1); border: 2px solid #ff0000; color: #ff6b6b; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    Error <span id="errorText">Error loading sunrise/sunset data</span>
                </div>
            </div>
        </div>

        <!-- Marketing Suite Tab Content -->
        <div id="marketingTab" class="tab-content">
            <div class="marketing-suite-container">
                <div class="marketing-header">
                    <h2>Mobile Marketing Suite</h2>
                    <p>Create compelling content and grow your photography business</p>
                </div>
                
                <div class="marketing-tools-grid">
                    <div class="marketing-tool-card" onclick="openBlogPostCreator()">
                        <div class="tool-icon">Document</div>
                        <h3>Blog Post Creator</h3>
                        <p>Write engaging blog posts with rich text editor and AI assistance</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openSocialMediaCreator()">
                        <div class="tool-icon">Mobile</div>
                        <h3>Social Media Posts</h3>
                        <p>Create captions, hashtags, and social content with various tones</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openMarketingCalendar()">
                        <div class="tool-icon">Calendar</div>
                        <h3>Marketing Calendar</h3>
                        <p>Plan and schedule your content across all platforms</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openAICaptionGenerator()">
                        <div class="tool-icon">ðŸ¤–</div>
                        <h3>AI Caption Generator</h3>
                        <p>Generate multiple caption options and SEO-optimized titles</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openShootToStoryConverter()">
                        <div class="tool-icon">Photo</div>
                        <h3>Shoot-to-Story Converter</h3>
                        <p>Turn client sessions into blog posts and social content</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openEmailBlastCreator()">
                        <div class="tool-icon">Email</div>
                        <h3>Email Blast Creator</h3>
                        <p>Create newsletters and promotional emails</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openTestimonialGenerator()">
                        <div class="tool-icon">Star</div>
                        <h3>Testimonial Generator</h3>
                        <p>Create polished testimonials and quote cards</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openContentIdeaVault()">
                        <div class="tool-icon">Idea</div>
                        <h3>Content Idea Vault</h3>
                        <p>Store and organize your content ideas by season and niche</p>
                    </div>
                    
                    <div class="marketing-tool-card" onclick="openContentRepurposer()">
                        <div class="tool-icon">ðŸ”„</div>
                        <h3>Content Repurposer</h3>
                        <p>Transform existing content into multiple formats and tones</p>
                    </div>
                </div>
            </div>
        </div> <!-- End Marketing Suite Tab -->

        <!-- Poses Tab Content -->
        <div id="posesTab" class="tab-content">
            <div class="poses-container">
                <div class="poses-header">
                    <h2>Photo Poses Gallery</h2>
                    <p>Discover, share, and save pose inspiration from the photography community</p>
                </div>

                <div class="poses-navigation">
                    <button onclick="showPosesSection('shared')" class="poses-nav-btn active" id="sharedNavBtn">
                        World Shared Gallery
                    </button>
                    <button onclick="showPosesSection('favorites')" class="poses-nav-btn" id="favoritesNavBtn">
                        Heart My Favorites
                    </button>
                    <button onclick="showPosesSection('submit')" class="poses-nav-btn" id="submitNavBtn">
                        ðŸ“¤ Submit Photo
                    </button>
                </div>

                <!-- Shared Gallery Section -->
                <div id="sharedGallerySection" class="poses-section active">
                    <div class="gallery-filters">
                        <div class="filter-group">
                            <label>Category:</label>
                            <select id="categoryFilter" onchange="filterPoses()">
                                <option value="">All Categories</option>
                                <option value="wedding">Wedding</option>
                                <option value="portrait">Portrait</option>
                                <option value="family">Family</option>
                                <option value="senior">Senior</option>
                                <option value="engagement">Engagement</option>
                                <option value="maternity">Maternity</option>
                                <option value="newborn">Newborn</option>
                                <option value="couple">Couple</option>
                                <option value="group">Group</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search Tags:</label>
                            <input type="text" id="tagSearch" placeholder="Search tags..." onkeyup="filterPoses()">
                        </div>
                        <div class="filter-group">
                            <label>Sort by:</label>
                            <select id="sortBy" onchange="sortPoses()">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="mostFavorited">Most Favorited</option>
                            </select>
                        </div>
                    </div>

                    <div id="sharedGalleryGrid" class="poses-grid">
                        <div class="loading-placeholder">
                            <p>Loading pose gallery...</p>
                        </div>
                    </div>
                </div>

                <!-- Favorites Section -->
                <div id="favoritesSection" class="poses-section">
                    <div class="favorites-header">
                        <h3>Heart Your Favorite Poses</h3>
                        <p>Poses you've saved for inspiration</p>
                    </div>
                    <div id="favoritesGrid" class="poses-grid">
                        <div class="loading-placeholder">
                            <p>Loading your favorites...</p>
                        </div>
                    </div>
                </div>

                <!-- Submit Photo Section -->
                <div id="submitSection" class="poses-section">
                    <div class="submit-header">
                        <h3>ðŸ“¤ Submit a Pose Photo</h3>
                        <p>Share your best pose ideas with the photography community</p>
                    </div>

                    <form id="poseSubmitForm" class="pose-submit-form">
                        <div class="form-group">
                            <label for="poseImage">Photo Upload *</label>
                            <input type="file" id="poseImage" accept="image/*" required class="form-control">
                            <small>Supported formats: JPG, PNG. Max size: 5MB</small>
                        </div>

                        <div class="form-group">
                            <label for="poseCategory">Category</label>
                            <select id="poseCategory" class="form-control">
                                <option value="wedding">Wedding</option>
                                <option value="portrait">Portrait</option>
                                <option value="family">Family</option>
                                <option value="senior">Senior</option>
                                <option value="engagement">Engagement</option>
                                <option value="maternity">Maternity</option>
                                <option value="newborn">Newborn</option>
                                <option value="couple">Couple</option>
                                <option value="group">Group</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="poseTags">Tags (comma separated)</label>
                            <input type="text" id="poseTags" placeholder="e.g., romantic, outdoor, golden hour, sitting" class="form-control">
                            <small>Help others find your pose with descriptive tags</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">ðŸ“¤ Submit for Review</button>
                            <button type="button" onclick="resetPoseForm()" class="btn btn-secondary">ðŸ”„ Reset</button>
                        </div>
                    </form>

                    <div id="submitResult" class="submit-result"></div>
                </div>
            </div>
        </div> <!-- End Poses Tab -->

    </div> <!-- End container -->

    <!-- Contract Modal moved to end -->

    <script>
        // Advanced Website Builder is now integrated via React components
        // The old JavaScript website builder code has been replaced with React SiteBuilder
    </script>

    <!-- Contract Modal -->
    <div id="contractModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">Document Contract Management</h3>
                <button class="contract-close-btn" onclick="closeContractModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <div class="contract-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
                    <button class="contract-tab active" onclick="switchContractTab('create')" style="flex: 1; padding: 10px; background: #d4af37; color: white; border: none; border-radius: 5px 0 0 0; cursor: pointer;">Create New</button>
                    <button class="contract-tab" onclick="switchContractTab('existing')" style="flex: 1; padding: 10px; background: #f8f9fa; color: #333; border: none; border-radius: 0 5px 0 0; cursor: pointer;">View Existing</button>
                </div>
                
                <div id="createContractTab" class="contract-tab-content">
                    <h4 style="color: #000000;">Create New Contract</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractTitleInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitleInput" placeholder="Photography Services Agreement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #000000;" />
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractContentInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContentInput" rows="15" placeholder="Enter your contract terms and conditions here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <button onclick="createContract()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Create Contract</button>
                </div>
                
                <div id="existingContractTab" class="contract-tab-content" style="display: none;">
                    <h4 style="color: #000000;">Existing Contracts</h4>
                    <div id="existingContractsList" class="existing-contracts-list" style="color: #000000;">
                        <!-- Contracts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Edit Modal -->
    <div id="contractEditModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractEditModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">âœï¸ Edit Contract</h3>
                <button class="contract-close-btn" onclick="closeContractEditModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <form id="contractEditForm" onsubmit="saveContractChanges(event)">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color: #000000;" />
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContent" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeContractEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Marketing Suite Functions
        function openBlogPostCreator() {
            showMessage('Opening Blog Post Creator...', 'info');
            // Create modal for blog post creator
            const modal = createMarketingModal('Blog Post Creator', `
                <div class="blog-creator">
                    <div class="form-group">
                        <label>Blog Title</label>
                        <input type="text" id="blogTitle" placeholder="Enter your blog post title..." class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Featured Image</label>
                        <input type="file" id="blogImage" accept="image/*" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="blogTags" placeholder="wedding, portrait, photography..." class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="blogContent" rows="10" placeholder="Write your blog post content..." class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button onclick="generateAIBlogPost()" class="btn btn-secondary">Star AI Generate</button>
                        <button onclick="saveBlogPost()" class="btn btn-primary">ðŸ’¾ Save Draft</button>
                    </div>
                </div>
            `);
        }

        function openSocialMediaCreator() {
            showMessage('Opening Social Media Creator...', 'info');
            const modal = createMarketingModal('Social Media Post Creator', `
                <div class="social-creator">
                    <div class="form-group">
                        <label>Upload Photo(s)</label>
                        <input type="file" id="socialImages" accept="image/*" multiple class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Caption</label>
                        <textarea id="socialCaption" rows="4" placeholder="Write your social media caption..." class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tone</label>
                        <select id="socialTone" class="form-control">
                            <option value="fun">Fun & Playful</option>
                            <option value="bold">Bold & Dramatic</option>
                            <option value="romantic">Romantic & Elegant</option>
                            <option value="professional">Professional</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="generateHashtags()" class="btn btn-secondary">ðŸ”— Generate Hashtags</button>
                        <button onclick="generateCaptionVariations()" class="btn btn-secondary">ðŸŽ­ Generate Variations</button>
                        <button onclick="saveSocialPost()" class="btn btn-primary">ðŸ’¾ Save Post</button>
                    </div>
                </div>
            `);
        }

        function openMarketingCalendar() {
            showMessage('Opening Marketing Calendar...', 'info');
            const modal = createMarketingModal('Marketing Calendar', `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button onclick="previousMonth()" class="btn btn-secondary">â† Previous</button>
                        <h3 id="currentMonth">January 2025</h3>
                        <button onclick="nextMonth()" class="btn btn-secondary">Next Arrow</button>
                    </div>
                    <div id="marketingCalendar" class="marketing-calendar">
                        <div class="calendar-placeholder">Calendar will load here...</div>
                    </div>
                    <div class="calendar-actions">
                        <button onclick="suggestContent()" class="btn btn-secondary">Idea Content Suggestions</button>
                        <button onclick="schedulePost()" class="btn btn-primary">Calendar Schedule Post</button>
                    </div>
                </div>
            `);
        }

        function openAICaptionGenerator() {
            showMessage('Opening AI Caption Generator...', 'info');
            const modal = createMarketingModal('AI Caption Generator', `
                <div class="ai-generator">
                    <div class="form-group">
                        <label>Upload Photo(s)</label>
                        <input type="file" id="aiImages" accept="image/*" multiple class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Session Details (Optional)</label>
                        <textarea id="sessionDetails" rows="3" placeholder="Describe the shoot, location, or story..." class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Content Type</label>
                        <select id="contentType" class="form-control">
                            <option value="instagram">Instagram Caption</option>
                            <option value="facebook">Facebook Post</option>
                            <option value="blog">Blog Title</option>
                            <option value="email">Email Subject</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="generateAICaptions()" class="btn btn-primary">ðŸ¤– Generate Captions</button>
                    </div>
                    <div id="aiResults" class="ai-results"></div>
                </div>
            `);
        }

        async function openShootToStoryConverter() {
            showMessage('Loading your sessions...', 'info');
            
            try {
                // Fetch user sessions from the backend API
                const response = await fetch('/api/sessions', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || 'dev-token'}`
                    }
                });
                
                let userSessions = [];
                if (response.ok) {
                    userSessions = await response.json();
                } else {
                    console.log('Using fallback sessions data');
                    userSessions = sessions || [];
                }
                
                // Sort sessions by date (most recent first) and limit to 10
                const recentSessions = userSessions
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 10);
                
                const modal = createMarketingModal('Shoot-to-Story Converter', `
                    <div class="shoot-converter">
                        <div class="form-group">
                            <label>Select Recent Session</label>
                            <select id="sessionSelect" class="form-control" onchange="loadSessionData(this.value)">
                                <option value="">Choose a past session...</option>
                                ${recentSessions.map(session => `
                                    <option value="${session.id}" data-session='${JSON.stringify(session).replace(/'/g, '&apos;')}'>${session.clientName || 'Unknown Client'} - ${session.sessionType || 'Session'} (${formatDateTime(session.dateTime)})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Filter by Type</label>
                            <select id="sessionTypeFilter" class="form-control" onchange="filterSessionsByType()">
                                <option value="">All Sessions</option>
                                <option value="wedding">Wedding</option>
                                <option value="portrait">Portrait</option>
                                <option value="family">Family</option>
                                <option value="engagement">Engagement</option>
                                <option value="senior">Senior</option>
                                <option value="event">Event</option>
                            </select>
                        </div>
                        
                        <div id="sessionPreview" class="session-preview" style="display: none;">
                            <h4>Session Preview</h4>
                            <div id="sessionDetails" class="session-details"></div>
                            <div id="sessionPhotos" class="session-photos"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Generate Content</label>
                            <div class="content-options">
                                <label><input type="checkbox" id="generateBlog" checked> Blog Post Draft</label>
                                <label><input type="checkbox" id="generateInstagram" checked> 3 Instagram Captions</label>
                                <label><input type="checkbox" id="generateReel" checked> Reel/Video Idea</label>
                                <label><input type="checkbox" id="generateEmail"> Email Newsletter Content</label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button onclick="convertShootToStory()" class="btn btn-primary" disabled id="generateBtn">Star Generate Content</button>
                            <button onclick="exportToOtherTools()" class="btn btn-secondary" style="display: none;" id="exportBtn">ðŸ“¤ Export to Tools</button>
                        </div>
                        
                        <div id="storyResults" class="story-results"></div>
                    </div>
                `);
                
                showMessage('Sessions loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading sessions:', error);
                showMessage('Error loading sessions. Using offline mode.', 'warning');
                
                // Fallback modal with placeholder
                const modal = createMarketingModal('Shoot-to-Story Converter', `
                    <div class="shoot-converter">
                        <div class="error-message">
                            <p>Warning Unable to load sessions from database. Please check your connection.</p>
                            <p>Create some photography sessions first to use this tool.</p>
                        </div>
                        <div class="form-group">
                            <label>Manual Session Input</label>
                            <input type="text" id="manualClient" placeholder="Client Name" class="form-control">
                            <input type="text" id="manualLocation" placeholder="Location" class="form-control" style="margin-top: 10px;">
                            <select id="manualType" class="form-control" style="margin-top: 10px;">
                                <option value="wedding">Wedding</option>
                                <option value="portrait">Portrait</option>
                                <option value="family">Family</option>
                                <option value="engagement">Engagement</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button onclick="convertManualToStory()" class="btn btn-primary">Star Generate Content</button>
                        </div>
                        <div id="storyResults" class="story-results"></div>
                    </div>
                `);
            }
        }

        function openEmailBlastCreator() {
            showMessage('Opening Email Creator...', 'info');
            const modal = createMarketingModal('Email Blast Creator', `
                <div class="email-creator">
                    <div class="form-group">
                        <label>Email Template</label>
                        <select id="emailTemplate" class="form-control">
                            <option value="announcement">Announcement</option>
                            <option value="promotion">Promotion/Sale</option>
                            <option value="gallery">Gallery Notification</option>
                            <option value="referral">Referral Campaign</option>
                            <option value="newsletter">Newsletter</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject Line</label>
                        <input type="text" id="emailSubject" placeholder="Enter email subject..." class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="emailContent" rows="8" placeholder="Write your email content..." class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button onclick="previewEmail()" class="btn btn-secondary">ðŸ‘ï¸ Preview</button>
                        <button onclick="exportToMailchimp()" class="btn btn-secondary">ðŸ“¤ Export HTML</button>
                        <button onclick="saveEmailDraft()" class="btn btn-primary">ðŸ’¾ Save Draft</button>
                    </div>
                </div>
            `);
        }

        function openTestimonialGenerator() {
            showMessage('Opening Testimonial Generator...', 'info');
            const modal = createMarketingModal('Testimonial Generator', `
                <div class="testimonial-generator">
                    <div class="form-group">
                        <label>Client Name</label>
                        <input type="text" id="testimonialClient" placeholder="Client name..." class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Session Notes/Feedback</label>
                        <textarea id="testimonialNotes" rows="4" placeholder="Any notes about the session or client feedback..." class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Testimonial Style</label>
                        <select id="testimonialStyle" class="form-control">
                            <option value="professional">Professional & Polished</option>
                            <option value="emotional">Emotional & Heartfelt</option>
                            <option value="detailed">Detailed Experience</option>
                            <option value="concise">Short & Sweet</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="generateTestimonial()" class="btn btn-primary">Star Generate Testimonial</button>
                        <button onclick="createQuoteCard()" class="btn btn-secondary">ðŸŽ¨ Create Quote Card</button>
                    </div>
                    <div id="testimonialResults" class="testimonial-results"></div>
                </div>
            `);
        }

        function openContentIdeaVault() {
            showMessage('Opening Content Idea Vault...', 'info');
            const modal = createMarketingModal('Content Idea Vault', `
                <div class="idea-vault">
                    <div class="vault-header">
                        <div class="form-group">
                            <input type="text" id="newIdea" placeholder="Add a new content idea..." class="form-control">
                            <select id="ideaCategory" class="form-control">
                                <option value="general">General</option>
                                <option value="wedding">Wedding</option>
                                <option value="portrait">Portrait</option>
                                <option value="seasonal">Seasonal</option>
                                <option value="tips">Photography Tips</option>
                                <option value="behind-scenes">Behind the Scenes</option>
                            </select>
                            <button onclick="addContentIdea()" class="btn btn-primary">âž• Add Idea</button>
                        </div>
                    </div>
                    <div class="vault-filters">
                        <button onclick="filterIdeas('all')" class="btn btn-secondary active">All</button>
                        <button onclick="filterIdeas('wedding')" class="btn btn-secondary">Wedding</button>
                        <button onclick="filterIdeas('portrait')" class="btn btn-secondary">Portrait</button>
                        <button onclick="filterIdeas('seasonal')" class="btn btn-secondary">Seasonal</button>
                        <button onclick="filterIdeas('tips')" class="btn btn-secondary">Tips</button>
                    </div>
                    <div id="ideasList" class="ideas-list">
                        <div class="idea-placeholder">Your content ideas will appear here...</div>
                    </div>
                </div>
            `);
        }

        function openContentRepurposer() {
            showMessage('Opening Content Repurposer...', 'info');
            const modal = createMarketingModal('Content Repurposer', `
                <div class="content-repurposer">
                    <div class="form-group">
                        <label>Original Content</label>
                        <textarea id="originalContent" rows="6" placeholder="Paste your existing blog post or social media content..." class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Repurpose Options</label>
                        <div class="repurpose-options">
                            <label><input type="checkbox" checked> Simplify for Social Media</label>
                            <label><input type="checkbox" checked> Turn into List Format</label>
                            <label><input type="checkbox" checked> Create Summary</label>
                            <label><input type="checkbox" checked> Change Tone</label>
                            <label><input type="checkbox" checked> Email Newsletter Version</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Target Tone</label>
                        <select id="repurposeTone" class="form-control">
                            <option value="casual">Casual & Friendly</option>
                            <option value="professional">Professional</option>
                            <option value="playful">Playful & Fun</option>
                            <option value="inspirational">Inspirational</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button onclick="repurposeContent()" class="btn btn-primary">ðŸ”„ Repurpose Content</button>
                    </div>
                    <div id="repurposeResults" class="repurpose-results"></div>
                </div>
            `);
        }

        // Marketing Modal Helper Function
        function createMarketingModal(title, content) {
            const modalHtml = `
                <div class="marketing-modal-overlay" onclick="closeMarketingModal()">
                    <div class="marketing-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button onclick="closeMarketingModal()" class="close-btn">Ã—</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            
            const modalElement = document.createElement('div');
            modalElement.innerHTML = modalHtml;
            modalElement.id = 'marketingModal';
            document.body.appendChild(modalElement);
            
            // Add modal styles
            if (!document.getElementById('marketingModalStyles')) {
                const styles = document.createElement('style');
                styles.id = 'marketingModalStyles';
                styles.innerHTML = `
                    .marketing-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .marketing-modal {
                        background: white;
                        border-radius: 12px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    }
                    .modal-header {
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .modal-header h3 {
                        margin: 0;
                        color: #2d3748;
                    }
                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                    }
                    .modal-body {
                        padding: 20px;
                    }
                    .form-group {
                        margin-bottom: 20px;
                    }
                    .form-group label {
                        display: block;
                        margin-bottom: 8px;
                        font-weight: 600;
                        color: #2d3748;
                    }
                    .form-control {
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                        box-sizing: border-box;
                    }
                    .form-actions {
                        display: flex;
                        gap: 10px;
                        margin-top: 20px;
                        flex-wrap: wrap;
                    }
                    .btn {
                        padding: 10px 16px;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    }
                    .btn-primary {
                        background: linear-gradient(135deg, #d4af37, #ffd700);
                        color: #1a1a1a;
                    }
                    .btn-secondary {
                        background: #6c757d;
                        color: white;
                    }
                    .btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    }
                    .content-options {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 10px;
                        margin-top: 10px;
                    }
                    .content-options label {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-weight: normal;
                    }
                    .session-preview {
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 15px;
                        margin: 15px 0;
                    }
                    .session-details {
                        margin-bottom: 15px;
                    }
                    .session-info p {
                        margin: 5px 0;
                        font-size: 14px;
                    }
                    .photo-samples h5 {
                        margin-bottom: 10px;
                        color: #2d3748;
                    }
                    .photo-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 8px;
                        margin-bottom: 10px;
                    }
                    .sample-photo {
                        width: 100%;
                        height: 60px;
                        object-fit: cover;
                        border-radius: 4px;
                        border: 1px solid #ddd;
                    }
                    .photo-count {
                        font-size: 12px;
                        color: #666;
                        text-align: center;
                        margin: 0;
                    }
                    .no-photos {
                        color: #666;
                        font-style: italic;
                        text-align: center;
                        margin: 0;
                    }
                    .error-message {
                        background: #fff3cd;
                        border: 1px solid #ffeaa7;
                        border-radius: 6px;
                        padding: 15px;
                        margin-bottom: 20px;
                        text-align: center;
                    }
                    .error-message p {
                        margin: 5px 0;
                        color: #856404;
                    }
                    .generated-content {
                        margin-top: 20px;
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                    }
                    .content-section {
                        margin-bottom: 25px;
                        padding: 15px;
                        background: white;
                        border-radius: 6px;
                        border: 1px solid #dee2e6;
                    }
                    .content-section h5 {
                        margin-bottom: 15px;
                        color: #2d3748;
                        border-bottom: 1px solid #eee;
                        padding-bottom: 8px;
                    }
                    .content-item {
                        margin-bottom: 15px;
                    }
                    .content-item strong {
                        display: block;
                        margin-bottom: 5px;
                        color: #4a5568;
                    }
                    .export-options {
                        margin-top: 20px;
                        padding: 15px;
                        background: #e8f5e8;
                        border-radius: 8px;
                        border: 1px solid #c3e6c3;
                    }
                    .export-buttons {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 10px;
                        margin: 15px 0;
                    }
                    .export-note {
                        font-size: 12px;
                        color: #666;
                        text-align: center;
                        margin: 10px 0 0 0;
                    }
                    @media (max-width: 768px) {
                        .photo-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                        .content-options {
                            grid-template-columns: 1fr;
                        }
                        .export-buttons {
                            grid-template-columns: 1fr;
                        }
                    }
                    
                    /* Poses Section Styles */
                    .poses-container {
                        padding: 30px;
                        max-width: 1200px;
                        margin: 0 auto;
                    }
                    .poses-header {
                        text-align: center;
                        margin-bottom: 30px;
                    }
                    .poses-header h2 {
                        color: #2d3748;
                        margin-bottom: 10px;
                    }
                    .poses-navigation {
                        display: flex;
                        justify-content: center;
                        gap: 15px;
                        margin-bottom: 30px;
                        border-bottom: 1px solid #e2e8f0;
                        padding-bottom: 15px;
                    }
                    .poses-nav-btn {
                        padding: 12px 20px;
                        border: none;
                        background: #f7fafc;
                        color: #4a5568;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.3s ease;
                    }
                    .poses-nav-btn:hover {
                        background: #edf2f7;
                        transform: translateY(-2px);
                    }
                    .poses-nav-btn.active {
                        background: #D4AF37;
                        color: white;
                    }
                    .poses-section {
                        display: none;
                    }
                    .poses-section.active {
                        display: block;
                    }
                    .gallery-filters {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 30px;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                    }
                    .filter-group {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }
                    .filter-group label {
                        font-weight: 600;
                        color: #495057;
                        font-size: 14px;
                    }
                    .poses-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }
                    .pose-card {
                        background: white;
                        border-radius: 12px;
                        overflow: hidden;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                        border: 1px solid #e2e8f0;
                    }
                    .pose-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                    }
                    .pose-image {
                        width: 100%;
                        height: 250px;
                        object-fit: cover;
                        cursor: pointer;
                    }
                    .pose-content {
                        padding: 15px;
                    }
                    .pose-photographer {
                        font-weight: 600;
                        color: #2d3748;
                        margin-bottom: 8px;
                        font-size: 14px;
                    }
                    .pose-category {
                        display: inline-block;
                        background: #D4AF37;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 500;
                        margin-bottom: 8px;
                    }
                    .pose-tags {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 5px;
                        margin-bottom: 12px;
                    }
                    .pose-tag {
                        background: #e2e8f0;
                        color: #4a5568;
                        padding: 2px 6px;
                        border-radius: 8px;
                        font-size: 11px;
                    }
                    .pose-actions {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .favorite-btn {
                        background: none;
                        border: none;
                        font-size: 18px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        padding: 5px;
                        border-radius: 50%;
                    }
                    .favorite-btn:hover {
                        background: #f1f5f9;
                        transform: scale(1.1);
                    }
                    .favorite-btn.favorited {
                        color: #e53e3e;
                    }
                    .favorite-count {
                        font-size: 12px;
                        color: #718096;
                    }
                    .pose-submit-form {
                        max-width: 600px;
                        margin: 0 auto;
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    }
                    .submit-result {
                        margin-top: 20px;
                        padding: 15px;
                        border-radius: 8px;
                        display: none;
                    }
                    .submit-result.success {
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        color: #155724;
                    }
                    .submit-result.error {
                        background: #f8d7da;
                        border: 1px solid #f5c6cb;
                        color: #721c24;
                    }
                    .loading-placeholder {
                        text-align: center;
                        padding: 40px;
                        color: #718096;
                    }
                    .empty-state {
                        text-align: center;
                        padding: 60px 20px;
                        color: #718096;
                    }
                    .empty-state h3 {
                        margin-bottom: 10px;
                        color: #4a5568;
                    }
                    .pose-lightbox {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        z-index: 1000;
                        display: none;
                        justify-content: center;
                        align-items: center;
                    }
                    .lightbox-content {
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    }
                    .lightbox-close {
                        position: absolute;
                        top: 20px;
                        right: 30px;
                        color: white;
                        font-size: 40px;
                        cursor: pointer;
                        font-weight: bold;
                    }
                    @media (max-width: 768px) {
                        .poses-navigation {
                            flex-direction: column;
                            gap: 10px;
                        }
                        .poses-nav-btn {
                            width: 100%;
                        }
                        .gallery-filters {
                            grid-template-columns: 1fr;
                        }
                        .poses-grid {
                            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                            gap: 15px;
                        }
                        .pose-submit-form {
                            padding: 20px;
                        }
                        .lightbox-close {
                            top: 10px;
                            right: 15px;
                            font-size: 30px;
                        }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            return modalElement;
        }

        function closeMarketingModal() {
            const modal = document.getElementById('marketingModal');
            if (modal) {
                modal.remove();
            }
        }

        // Placeholder functions for marketing features
        function generateAIBlogPost() {
            showMessage('AI generating blog post content...', 'info');
            setTimeout(() => {
                showMessage('AI blog post generated! Check the content area.', 'success');
            }, 2000);
        }

        function saveBlogPost() {
            showMessage('Blog post saved to drafts!', 'success');
            celebrateMilestone('session_created', 'Blog Post');
        }

        function generateHashtags() {
            showMessage('Generating relevant hashtags...', 'info');
            setTimeout(() => {
                showMessage('Hashtags generated! Check the caption area.', 'success');
            }, 1500);
        }

        function generateCaptionVariations() {
            showMessage('Creating caption variations...', 'info');
            setTimeout(() => {
                showMessage('Caption variations created!', 'success');
            }, 1500);
        }

        function saveSocialPost() {
            showMessage('Social media post saved!', 'success');
            celebrateMilestone('gallery_shared', 'Social Post');
        }

        // Shoot-to-Story Converter Functions
        function loadSessionData(sessionId) {
            if (!sessionId) {
                document.getElementById('sessionPreview').style.display = 'none';
                document.getElementById('generateBtn').disabled = true;
                return;
            }
            
            const sessionSelect = document.getElementById('sessionSelect');
            const selectedOption = sessionSelect.querySelector(`option[value="${sessionId}"]`);
            
            if (selectedOption) {
                try {
                    const sessionData = JSON.parse(selectedOption.getAttribute('data-session'));
                    displaySessionPreview(sessionData);
                    document.getElementById('generateBtn').disabled = false;
                } catch (error) {
                    console.error('Error parsing session data:', error);
                    showMessage('Error loading session details', 'error');
                }
            }
        }
        
        function displaySessionPreview(session) {
            const previewDiv = document.getElementById('sessionPreview');
            const detailsDiv = document.getElementById('sessionDetails');
            const photosDiv = document.getElementById('sessionPhotos');
            
            // Display session details
            detailsDiv.innerHTML = `
                <div class="session-info">
                    <p><strong>Client:</strong> ${session.clientName || 'Unknown'}</p>
                    <p><strong>Type:</strong> ${session.sessionType || 'Session'}</p>
                    <p><strong>Date:</strong> ${formatDateTime(session.dateTime)}</p>
                    <p><strong>Location:</strong> ${session.location || 'Location not specified'}</p>
                    <p><strong>Notes:</strong> ${session.notes || 'No notes available'}</p>
                </div>
            `;
            
            // Display sample photos if available
            if (session.photos && session.photos.length > 0) {
                const samplePhotos = session.photos.slice(0, 3);
                photosDiv.innerHTML = `
                    <div class="photo-samples">
                        <h5>Sample Photos (${session.photos.length} total)</h5>
                        <div class="photo-grid">
                            ${samplePhotos.map(photo => `
                                <img src="${photo.url || photo.path}" alt="Session photo" class="sample-photo">
                            `).join('')}
                        </div>
                        ${session.photos.length > 3 ? `<p class="photo-count">+${session.photos.length - 3} more photos</p>` : ''}
                    </div>
                `;
            } else {
                photosDiv.innerHTML = '<p class="no-photos">No photos available for this session</p>';
            }
            
            previewDiv.style.display = 'block';
        }
        
        function filterSessionsByType() {
            const filter = document.getElementById('sessionTypeFilter').value;
            const sessionSelect = document.getElementById('sessionSelect');
            const options = sessionSelect.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === '') return; // Keep placeholder option
                
                try {
                    const sessionData = JSON.parse(option.getAttribute('data-session') || '{}');
                    if (!filter || sessionData.sessionType === filter) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error filtering session:', error);
                }
            });
            
            // Reset selection if current selection is now hidden
            const currentValue = sessionSelect.value;
            if (currentValue) {
                const currentOption = sessionSelect.querySelector(`option[value="${currentValue}"]`);
                if (currentOption && currentOption.style.display === 'none') {
                    sessionSelect.value = '';
                    loadSessionData('');
                }
            }
        }
        
        async function convertShootToStory() {
            const sessionSelect = document.getElementById('sessionSelect');
            const selectedSessionId = sessionSelect.value;
            
            if (!selectedSessionId) {
                showMessage('Please select a session first', 'warning');
                return;
            }
            
            const selectedOption = sessionSelect.querySelector(`option[value="${selectedSessionId}"]`);
            const sessionData = JSON.parse(selectedOption.getAttribute('data-session'));
            
            const generateBlog = document.getElementById('generateBlog')?.checked;
            const generateInstagram = document.getElementById('generateInstagram')?.checked;
            const generateReel = document.getElementById('generateReel')?.checked;
            const generateEmail = document.getElementById('generateEmail')?.checked;
            
            showMessage('Generating content from your session...', 'info');
            
            // Simulate content generation based on session data
            setTimeout(() => {
                const results = generateContentFromSession(sessionData, {
                    blog: generateBlog,
                    instagram: generateInstagram,
                    reel: generateReel,
                    email: generateEmail
                });
                
                displayGeneratedContent(results);
                document.getElementById('exportBtn').style.display = 'inline-block';
                showMessage('Content generated successfully!', 'success');
                celebrateMilestone('session_created', 'Story Content');
            }, 2000);
        }
        
        function generateContentFromSession(session, options) {
            const results = {};
            const clientName = session.clientName || 'the client';
            const location = session.location || 'a beautiful location';
            const sessionType = session.sessionType || 'photography session';
            const date = new Date(session.dateTime);
            const month = date.toLocaleString('default', { month: 'long' });
            
            if (options.blog) {
                results.blog = {
                    title: `${clientName}'s ${sessionType} at ${location}`,
                    content: `What an incredible ${sessionType} with ${clientName}! We had the most amazing time capturing beautiful moments at ${location} this past ${month}. 

The session was filled with genuine laughter, sweet moments, and stunning backdrops that perfectly complemented ${clientName}'s personality. From the golden hour lighting to the natural interactions, every shot tells a story of this special time in their life.

${session.notes ? `What made this session extra special: ${session.notes}` : ''}

I'm so grateful to work with clients like ${clientName} who trust me to capture their most precious moments. These photos will be treasured for years to come!`,
                    tags: ['photography', sessionType.toLowerCase(), location.toLowerCase().replace(/\s+/g, ''), 'photoshoot']
                };
            }
            
            if (options.instagram) {
                results.instagram = [
                    `Star ${clientName}'s ${sessionType} at ${location} was absolutely magical! Every single shot tells a beautiful story. Swipe to see some of my favorites! PhotoStar\n\n#${sessionType.toLowerCase()}photography #${location.toLowerCase().replace(/\s+/g, '')} #photography #photoshoot #love`,
                    
                    `Can we talk about how stunning ${clientName} looked during their ${sessionType}?! ðŸ˜ The natural light at ${location} was absolutely perfect. So grateful for clients who trust my vision! ðŸ’•\n\n#photographer #${sessionType.toLowerCase()} #naturallightphotography #beautiful`,
                    
                    `Behind the scenes: ${clientName} and I exploring ${location} for the perfect shots! This is why I love what I do - capturing genuine moments and creating lasting memories ðŸ“·ðŸ’«\n\n#behindthescenes #${sessionType.toLowerCase()}session #photographylife #blessed`
                ];
            }
            
            if (options.reel) {
                results.reel = {
                    idea: `"Getting Ready for ${clientName}'s ${sessionType}"`,
                    content: `Show behind-the-scenes of setting up at ${location}, quick shots of different poses/angles, and the final reveal of favorite images. Use trending audio about "that golden hour magic" or "when everything comes together perfectly."`,
                    hooks: [
                        `POV: Your photographer finds the perfect spot at ${location}`,
                        `${sessionType} session magic at ${location}`,
                        `When the lighting hits just right...`
                    ]
                };
            }
            
            if (options.email) {
                results.email = {
                    subject: `${clientName}'s Beautiful ${sessionType} - Sneak Peeks Inside!`,
                    content: `Hi everyone!\n\nI just had to share some highlights from ${clientName}'s recent ${sessionType} at ${location}! The session was absolutely incredible, and I'm so excited to show you a few of my favorite shots.\n\nFrom the perfect lighting to ${clientName}'s natural beauty, everything came together beautifully. These are the moments that remind me why I love photography so much!\n\nWhat's your favorite type of photography session? I'd love to hear from you!\n\nXOXO,\nLance`
                };
            }
            
            return results;
        }
        
        function displayGeneratedContent(results) {
            const resultsDiv = document.getElementById('storyResults');
            let html = '<div class="generated-content"><h4>Generated Content</h4>';
            
            if (results.blog) {
                html += `
                    <div class="content-section">
                        <h5>Document Blog Post Draft</h5>
                        <div class="content-item">
                            <strong>Title:</strong> ${results.blog.title}<br>
                            <strong>Content:</strong><br>
                            <textarea class="form-control" rows="8" id="blogContent">${results.blog.content}</textarea>
                            <strong>Tags:</strong> ${results.blog.tags.join(', ')}
                        </div>
                    </div>
                `;
            }
            
            if (results.instagram) {
                html += `
                    <div class="content-section">
                        <h5>Mobile Instagram Captions</h5>
                        ${results.instagram.map((caption, index) => `
                            <div class="content-item">
                                <strong>Caption ${index + 1}:</strong><br>
                                <textarea class="form-control" rows="4" id="instagramCaption${index + 1}">${caption}</textarea>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (results.reel) {
                html += `
                    <div class="content-section">
                        <h5>ðŸŽ¬ Reel/Video Idea</h5>
                        <div class="content-item">
                            <strong>Title:</strong> ${results.reel.idea}<br>
                            <strong>Content:</strong><br>
                            <textarea class="form-control" rows="3" id="reelContent">${results.reel.content}</textarea>
                            <strong>Hook Ideas:</strong><br>
                            <ul>
                                ${results.reel.hooks.map(hook => `<li>${hook}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            if (results.email) {
                html += `
                    <div class="content-section">
                        <h5>Email Email Newsletter Content</h5>
                        <div class="content-item">
                            <strong>Subject:</strong> <input type="text" class="form-control" id="emailSubject" value="${results.email.subject}"><br>
                            <strong>Content:</strong><br>
                            <textarea class="form-control" rows="6" id="emailContent">${results.email.content}</textarea>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function exportToOtherTools() {
            showMessage('Exporting content to other marketing tools...', 'info');
            
            setTimeout(() => {
                const exportOptions = `
                    <div class="export-options">
                        <h4>Export Options</h4>
                        <div class="export-buttons">
                            <button onclick="exportToBlogCreator()" class="btn btn-secondary">Document Export to Blog Creator</button>
                            <button onclick="exportToSocialMedia()" class="btn btn-secondary">Mobile Export to Social Media</button>
                            <button onclick="exportToEmailBlast()" class="btn btn-secondary">Email Export to Email Creator</button>
                        </div>
                        <p class="export-note">Choose where to send your generated content for further editing and publishing.</p>
                    </div>
                `;
                
                const resultsDiv = document.getElementById('storyResults');
                resultsDiv.innerHTML += exportOptions;
                
                showMessage('Export options ready!', 'success');
            }, 1000);
        }
        
        function convertManualToStory() {
            const clientName = document.getElementById('manualClient')?.value || 'Client';
            const location = document.getElementById('manualLocation')?.value || 'Location';
            const sessionType = document.getElementById('manualType')?.value || 'session';
            
            if (!clientName || !location) {
                showMessage('Please fill in client name and location', 'warning');
                return;
            }
            
            const manualSession = {
                clientName,
                location,
                sessionType,
                dateTime: new Date().toISOString(),
                notes: ''
            };
            
            showMessage('Generating content...', 'info');
            
            setTimeout(() => {
                const results = generateContentFromSession(manualSession, {
                    blog: true,
                    instagram: true,
                    reel: true,
                    email: false
                });
                
                displayGeneratedContent(results);
                showMessage('Content generated successfully!', 'success');
                celebrateMilestone('session_created', 'Manual Story Content');
            }, 2000);
        }
        
        function exportToBlogCreator() {
            closeMarketingModal();
            showMessage('Opening Blog Creator with generated content...', 'info');
            setTimeout(() => {
                openBlogPostCreator();
                // Pre-fill blog creator with generated content if available
                setTimeout(() => {
                    const blogTitle = document.querySelector('#blogTitle');
                    const blogContent = document.querySelector('#blogContent');
                    const generatedBlogContent = document.querySelector('#storyResults #blogContent');
                    
                    if (blogTitle && generatedBlogContent) {
                        blogTitle.value = generatedBlogContent.value.split('\n')[0];
                    }
                    if (blogContent && generatedBlogContent) {
                        blogContent.value = generatedBlogContent.value;
                    }
                }, 500);
            }, 1000);
        }
        
        function exportToSocialMedia() {
            closeMarketingModal();
            showMessage('Opening Social Media Creator with generated captions...', 'info');
            setTimeout(() => {
                openSocialMediaCreator();
                // Pre-fill social media creator with generated content if available
                setTimeout(() => {
                    const socialCaption = document.querySelector('#socialCaption');
                    const generatedCaption = document.querySelector('#storyResults #instagramCaption1');
                    
                    if (socialCaption && generatedCaption) {
                        socialCaption.value = generatedCaption.value;
                    }
                }, 500);
            }, 1000);
        }
        
        function exportToEmailBlast() {
            closeMarketingModal();
            showMessage('Opening Email Creator with generated content...', 'info');
            setTimeout(() => {
                openEmailBlastCreator();
                // Pre-fill email creator with generated content if available
                setTimeout(() => {
                    const emailSubject = document.querySelector('#emailSubject');
                    const emailContent = document.querySelector('#emailContent');
                    const generatedEmailSubject = document.querySelector('#storyResults #emailSubject');
                    const generatedEmailContent = document.querySelector('#storyResults #emailContent');
                    
                    if (emailSubject && generatedEmailSubject) {
                        emailSubject.value = generatedEmailSubject.value;
                    }
                    if (emailContent && generatedEmailContent) {
                        emailContent.value = generatedEmailContent.value;
                    }
                }, 500);
            }, 1000);
        }

        // Poses Section JavaScript Functions
        let currentPoses = [];
        let userFavorites = [];
        let currentUserId = null;

        async function initializePosesSection() {
            showMessage('Loading Poses Gallery...', 'info');
            
            try {
                // Get current user ID for favorites
                currentUserId = 'dev-user-123';
                
                // Load poses data (starts with demo data)
                loadDemoPoses();
                
                // Load user favorites
                if (currentUserId) {
                    await loadUserFavorites();
                }
                
                showMessage('Poses gallery loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error initializing poses:', error);
                showMessage('Using demo poses data', 'warning');
                loadDemoPoses();
            }
        }

        function showPosesSection(sectionName) {
            // Update navigation buttons
            document.querySelectorAll('.poses-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(sectionName + 'NavBtn').classList.add('active');
            
            // Show selected section
            document.querySelectorAll('.poses-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Load section-specific data
            if (sectionName === 'shared') {
                displaySharedPoses();
            } else if (sectionName === 'favorites') {
                displayFavorites();
            }
        }

        function loadDemoPoses() {
            // Demo poses data with realistic photographer information
            currentPoses = [
                {
                    id: 'pose_1',
                    imageUrl: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=400',
                    category: ['wedding'],
                    tags: ['romantic', 'outdoor', 'golden hour', 'couple'],
                    photographerId: 'photographer_1',
                    photographerName: 'Sarah Mitchell Photography',
                    submittedAt: new Date('2024-01-15').toISOString(),
                    approved: true,
                    favoritedBy: ['user1', 'user2', 'user3']
                },
                {
                    id: 'pose_2',
                    imageUrl: 'https://images.unsplash.com/photo-1511285560929-80b456fea0bc?w=400',
                    category: ['family'],
                    tags: ['family', 'children', 'outdoor', 'natural'],
                    photographerId: 'photographer_2',
                    photographerName: 'Mike Johnson Studios',
                    submittedAt: new Date('2024-01-10').toISOString(),
                    approved: true,
                    favoritedBy: ['user1', 'user4']
                },
                {
                    id: 'pose_3',
                    imageUrl: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400',
                    category: ['portrait'],
                    tags: ['portrait', 'studio', 'professional', 'headshot'],
                    photographerId: 'photographer_3',
                    photographerName: 'Elena Rodriguez Photography',
                    submittedAt: new Date('2024-01-20').toISOString(),
                    approved: true,
                    favoritedBy: ['user2', 'user3', 'user5']
                },
                {
                    id: 'pose_4',
                    imageUrl: 'https://images.unsplash.com/photo-1522673607200-164d1b6ce486?w=400',
                    category: ['engagement'],
                    tags: ['engagement', 'couple', 'romantic', 'sunset'],
                    photographerId: 'photographer_4',
                    photographerName: 'David Chen Photography',
                    submittedAt: new Date('2024-01-25').toISOString(),
                    approved: true,
                    favoritedBy: ['user1', 'user3']
                },
                {
                    id: 'pose_5',
                    imageUrl: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400',
                    category: ['senior'],
                    tags: ['senior', 'graduation', 'outdoor', 'bright'],
                    photographerId: 'photographer_5',
                    photographerName: 'Jessica Thompson Photo',
                    submittedAt: new Date('2024-01-30').toISOString(),
                    approved: true,
                    favoritedBy: ['user4', 'user5']
                },
                {
                    id: 'pose_6',
                    imageUrl: 'https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?w=400',
                    category: ['maternity'],
                    tags: ['maternity', 'expecting', 'studio', 'elegant'],
                    photographerId: 'photographer_6',
                    photographerName: 'Amanda Foster Photography',
                    submittedAt: new Date('2024-02-01').toISOString(),
                    approved: true,
                    favoritedBy: ['user2', 'user4']
                }
            ];
        }

        async function loadUserFavorites() {
            try {
                userFavorites = ['pose_1', 'pose_3']; // Demo favorites for current user
                // In production: fetch from /users/{userId}/favoritePoses/
            } catch (error) {
                console.error('Error loading user favorites:', error);
                userFavorites = [];
            }
        }

        function displaySharedPoses() {
            const grid = document.getElementById('sharedGalleryGrid');
            
            if (currentPoses.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No poses available</h3>
                        <p>Be the first to submit a pose to the community gallery!</p>
                    </div>
                `;
                return;
            }
            
            const posesHtml = currentPoses.map(pose => createPoseCard(pose)).join('');
            grid.innerHTML = posesHtml;
        }

        function createPoseCard(pose) {
            const isFavorited = userFavorites.includes(pose.id);
            const favoriteCount = pose.favoritedBy ? pose.favoritedBy.length : 0;
            
            return `
                <div class="pose-card" data-pose-id="${pose.id}">
                    <img src="${pose.imageUrl}" alt="Pose by ${pose.photographerName}" class="pose-image" onclick="openPoseLightbox('${pose.imageUrl}', '${pose.photographerName}')">
                    <div class="pose-content">
                        <div class="pose-photographer">Photo ${pose.photographerName}</div>
                        <div class="pose-category">${pose.category[0] || 'General'}</div>
                        <div class="pose-tags">
                            ${pose.tags.map(tag => `<span class="pose-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="pose-actions">
                            <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${pose.id}')" title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorited ? 'Heart' : 'ðŸ¤'}
                            </button>
                            <span class="favorite-count">${favoriteCount} ${favoriteCount === 1 ? 'favorite' : 'favorites'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterPoses() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const tagSearch = document.getElementById('tagSearch').value.toLowerCase();
            
            let filteredPoses = currentPoses;
            
            // Filter by category
            if (categoryFilter) {
                filteredPoses = filteredPoses.filter(pose => 
                    pose.category.includes(categoryFilter)
                );
            }
            
            // Filter by tags
            if (tagSearch) {
                filteredPoses = filteredPoses.filter(pose => 
                    pose.tags.some(tag => tag.toLowerCase().includes(tagSearch))
                );
            }
            
            displayFilteredPoses(filteredPoses);
        }

        function sortPoses() {
            const sortBy = document.getElementById('sortBy').value;
            let sortedPoses = [...currentPoses];
            
            switch (sortBy) {
                case 'newest':
                    sortedPoses.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                    break;
                case 'oldest':
                    sortedPoses.sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));
                    break;
                case 'mostFavorited':
                    sortedPoses.sort((a, b) => (b.favoritedBy?.length || 0) - (a.favoritedBy?.length || 0));
                    break;
            }
            
            displayFilteredPoses(sortedPoses);
        }

        function displayFilteredPoses(poses) {
            const grid = document.getElementById('sharedGalleryGrid');
            
            if (poses.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No poses found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }
            
            const posesHtml = poses.map(pose => createPoseCard(pose)).join('');
            grid.innerHTML = posesHtml;
        }

        async function toggleFavorite(poseId) {
            try {
                const isFavorited = userFavorites.includes(poseId);
                
                if (isFavorited) {
                    // Remove from favorites
                    userFavorites = userFavorites.filter(id => id !== poseId);
                    showMessage('Removed from favorites', 'info');
                } else {
                    // Add to favorites
                    userFavorites.push(poseId);
                    showMessage('Added to favorites!', 'success');
                    celebrateMilestone('gallery_shared', 'Pose Favorited');
                }
                
                // Update the UI
                displaySharedPoses();
                
            } catch (error) {
                console.error('Error toggling favorite:', error);
                showMessage('Error updating favorites', 'error');
            }
        }

        function displayFavorites() {
            const grid = document.getElementById('favoritesGrid');
            
            const favoritePoses = currentPoses.filter(pose => userFavorites.includes(pose.id));
            
            if (favoritePoses.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No favorite poses yet</h3>
                        <p>Browse the shared gallery and save poses you love!</p>
                        <button onclick="showPosesSection('shared')" class="btn btn-primary" style="margin-top: 15px;">
                            World Browse Shared Gallery
                        </button>
                    </div>
                `;
                return;
            }
            
            const posesHtml = favoritePoses.map(pose => createFavoritePoseCard(pose)).join('');
            grid.innerHTML = posesHtml;
        }

        function createFavoritePoseCard(pose) {
            return `
                <div class="pose-card" data-pose-id="${pose.id}">
                    <img src="${pose.imageUrl}" alt="Pose by ${pose.photographerName}" class="pose-image" onclick="openPoseLightbox('${pose.imageUrl}', '${pose.photographerName}')">
                    <div class="pose-content">
                        <div class="pose-photographer">Photo ${pose.photographerName}</div>
                        <div class="pose-category">${pose.category[0] || 'General'}</div>
                        <div class="pose-tags">
                            ${pose.tags.map(tag => `<span class="pose-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="pose-actions">
                            <button class="favorite-btn favorited" onclick="removeFavorite('${pose.id}')" title="Remove from favorites">
                                Heart
                            </button>
                            <span class="favorite-count">Saved to favorites</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function removeFavorite(poseId) {
            try {
                userFavorites = userFavorites.filter(id => id !== poseId);
                showMessage('Removed from favorites', 'info');
                displayFavorites();
                
                // Also update shared gallery view if visible
                if (document.getElementById('sharedGallerySection').classList.contains('active')) {
                    displaySharedPoses();
                }
            } catch (error) {
                console.error('Error removing favorite:', error);
                showMessage('Error removing favorite', 'error');
            }
        }

        function openPoseLightbox(imageUrl, photographerName) {
            const lightbox = document.createElement('div');
            lightbox.className = 'pose-lightbox';
            lightbox.style.display = 'flex';
            lightbox.innerHTML = `
                <span class="lightbox-close" onclick="closePoseLightbox()">&times;</span>
                <img src="${imageUrl}" alt="Pose by ${photographerName}" class="lightbox-content">
            `;
            
            document.body.appendChild(lightbox);
            
            // Close on click outside image
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closePoseLightbox();
                }
            });
            
            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePoseLightbox();
                }
            });
        }

        function closePoseLightbox() {
            const lightbox = document.querySelector('.pose-lightbox');
            if (lightbox) {
                lightbox.remove();
            }
        }

        // Pose submission form handling
        async function handlePoseSubmission(event) {
            event.preventDefault();
            
            const imageFile = document.getElementById('poseImage').files[0];
            const category = document.getElementById('poseCategory').value;
            const tagsInput = document.getElementById('poseTags').value;
            
            if (!imageFile) {
                showMessage('Please select an image to upload', 'error');
                return;
            }
            
            // Validate file size (5MB limit)
            if (imageFile.size > 5 * 1024 * 1024) {
                showMessage('Image size must be less than 5MB', 'error');
                return;
            }
            
            try {
                showMessage('Uploading pose for review...', 'info');
                
                // Parse tags
                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                
                // Simulate upload delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Show success message
                const resultDiv = document.getElementById('submitResult');
                resultDiv.className = 'submit-result success';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>Success Submission Successful!</h4>
                    <p>Your pose has been submitted for review. It will appear in the shared gallery once approved by our moderators.</p>
                    <p><strong>Category:</strong> ${category}</p>
                    <p><strong>Tags:</strong> ${tags.join(', ')}</p>
                `;
                
                // Clear form
                resetPoseForm();
                
                // Celebrate
                celebrateMilestone('photos_uploaded', 'Pose Submitted');
                showMessage('Pose submitted successfully! Pending approval.', 'success');
                
            } catch (error) {
                console.error('Error submitting pose:', error);
                
                const resultDiv = document.getElementById('submitResult');
                resultDiv.className = 'submit-result error';
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>Error Submission Failed</h4>
                    <p>There was an error submitting your pose. Please try again.</p>
                    <p><small>Error: ${error.message}</small></p>
                `;
                
                showMessage('Error submitting pose. Please try again.', 'error');
            }
        }

        function resetPoseForm() {
            document.getElementById('poseSubmitForm').reset();
            const resultDiv = document.getElementById('submitResult');
            resultDiv.style.display = 'none';
        }

        // Initialize pose form submission when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const submitForm = document.getElementById('poseSubmitForm');
            if (submitForm) {
                submitForm.addEventListener('submit', handlePoseSubmission);
            }
        });

        // Photography Management System Navigation System
        function setActiveNavLink(targetTab) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current link
            const activeLink = document.querySelector(`.nav-link[onclick*="${targetTab}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Override switchTab function to work with new navigation
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            setActiveNavLink(tab);
            if (originalSwitchTab) {
                originalSwitchTab(tab);
            }
        };

        // Hamburger Menu Toggle Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                if (mobileMenu.classList.contains('show')) {
                    closeMobileMenu();
                } else {
                    openMobileMenu();
                }
            }
        }

        function openMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.add('show');
                hamburgerBtn.classList.add('active');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && mobileMenu.classList.contains('show')) {
                if (!mobileMenu.contains(event.target) && !hamburgerBtn.contains(event.target)) {
                    closeMobileMenu();
                }
            }
        });

        // Initialize hamburger menu on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure menu is hidden on load
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.remove('show');
            }
        });

        // Storefront Builder Function
        function openStorefront() {
            showMessage('Opening Storefront Builder...', 'info');
            window.open('/storefront.html', '_blank');
        }

        // Subscription Modal Functions
        function showSubscriptionModal(message) {
            const modal = document.createElement('div');
            modal.className = 'subscription-modal';
            modal.innerHTML = `
                <div class="subscription-backdrop" onclick="closeSubscriptionModal()"></div>
                <div class="subscription-content">
                    <button class="close-btn" onclick="closeSubscriptionModal()">Ã—</button>
                    <h2>ðŸ“¸ Subscription Required</h2>
                    <p style="margin: 1rem 0; color: #666;">${message}</p>
                    
                    <h3 style="margin: 2rem 0 1rem 0; color: #d4af37;">Choose Your Plan</h3>
                    
                    <div class="pricing-grid">
                        <div class="pricing-card" onclick="selectPlan('monthly')">
                            <h4>Monthly</h4>
                            <div class="price">$25<span>/month</span></div>
                            <ul>
                                <li>âœ“ Full platform access</li>
                                <li>âœ“ Unlimited sessions</li>
                                <li>âœ“ Client galleries</li>
                                <li>âœ“ Website builder</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card featured" onclick="selectPlan('sixmonth')">
                            <div class="badge">BEST VALUE</div>
                            <h4>6 Months</h4>
                            <div class="price">$125<span>/6 months</span></div>
                            <div class="savings">Save $25 (1 month free!)</div>
                            <ul>
                                <li>âœ“ Everything in Monthly</li>
                                <li>âœ“ Priority support</li>
                                <li>âœ“ Advanced features</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card" onclick="selectPlan('yearly')">
                            <h4>Annual</h4>
                            <div class="price">$200<span>/year</span></div>
                            <div class="savings">Save $100 (2 months free!)</div>
                            <ul>
                                <li>âœ“ Everything in 6 Months</li>
                                <li>âœ“ Custom branding</li>
                                <li>âœ“ Premium templates</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="paymentForm" style="display: none; margin-top: 2rem;">
                        <div id="card-element"></div>
                        <button id="submitPayment" class="submit-btn">Complete Subscription</button>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .subscription-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 10000;
                }
                
                .subscription-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                }
                
                .subscription-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .close-btn {
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: none;
                    border: none;
                    font-size: 2rem;
                    cursor: pointer;
                    color: #666;
                }
                
                .pricing-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1.5rem;
                    margin: 2rem 0;
                }
                
                .pricing-card {
                    border: 2px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 2rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                }
                
                .pricing-card:hover {
                    border-color: #d4af37;
                    transform: translateY(-5px);
                    box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
                }
                
                .pricing-card.featured {
                    border-color: #d4af37;
                    background: linear-gradient(to bottom, #fafaf8, #f5f5f0);
                }
                
                .badge {
                    position: absolute;
                    top: -12px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #d4af37;
                    color: white;
                    padding: 4px 16px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }
                
                .price {
                    font-size: 2.5rem;
                    color: #d4af37;
                    margin: 1rem 0;
                    font-weight: 700;
                }
                
                .price span {
                    font-size: 1rem;
                    color: #666;
                    font-weight: 400;
                }
                
                .savings {
                    color: #34a853;
                    font-size: 0.9rem;
                    margin-bottom: 1rem;
                }
                
                .pricing-card ul {
                    list-style: none;
                    padding: 0;
                    margin: 1rem 0 0 0;
                    text-align: left;
                }
                
                .pricing-card li {
                    padding: 0.5rem 0;
                    color: #666;
                }
                
                .submit-btn {
                    background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
                    color: #000;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 1rem;
                }
                
                #card-element {
                    border: 1px solid #ddd;
                    padding: 1rem;
                    border-radius: 8px;
                    background: #f9f9f9;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        function closeSubscriptionModal() {
            const modal = document.querySelector('.subscription-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function selectPlan(plan) {
            const paymentForm = document.getElementById('paymentForm');
            paymentForm.style.display = 'block';
            
            // Load Stripe
            if (!window.stripe) {
                const stripeScript = document.createElement('script');
                stripeScript.src = 'https://js.stripe.com/v3/';
                await new Promise((resolve) => {
                    stripeScript.onload = resolve;
                    document.head.appendChild(stripeScript);
                });
            }
            
            // Get Stripe public key
            const keyResponse = await fetch('/api/stripe-public-key');
            const { publicKey } = await keyResponse.json();
            
            if (!publicKey) {
                showMessage('Stripe is not configured. Please contact support.', 'error');
                return;
            }
            
            // Initialize Stripe payment
            const stripe = Stripe(publicKey);
            const elements = stripe.elements();
            const cardElement = elements.create('card');
            cardElement.mount('#card-element');
            
            document.getElementById('submitPayment').onclick = async () => {
                try {
                    showMessage('Processing subscription...', 'info');
                    
                    // Create subscription checkout session
                    const response = await fetch('/api/create-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ plan })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to create subscription');
                    }
                    
                    const { checkoutUrl } = await response.json();
                    
                    // Redirect to Stripe Checkout
                    window.location.href = checkoutUrl;
                } catch (err) {
                    showMessage('Subscription failed: ' + err.message, 'error');
                }
            };
        }
        
        // Check subscription status on load
        async function checkSubscriptionStatus() {
            try {
                const response = await fetch('/api/subscription-status');
                const data = await response.json();
                
                if (!data.hasSubscription) {
                    // User needs subscription
                    console.log('No active subscription found');
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
        }

        // Initialize subscription check
        document.addEventListener('DOMContentLoaded', function() {
            checkSubscriptionStatus();
        });

    </script>

        </div> <!-- Close main-content -->
    </div> <!-- Close container -->
</body>
</html>
