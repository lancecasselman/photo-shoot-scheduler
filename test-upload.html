<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #log {
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Upload System Test</h1>
        
        <div class="test-section">
            <h2>Test Configuration</h2>
            <p><strong>Session ID:</strong> <span id="sessionId">a7e93f59-9a96-497b-8af5-763858e84bd8</span></p>
            <p><strong>Folder Type:</strong> gallery</p>
            <p><strong>Test Image:</strong> Auto-generated JPEG</p>
        </div>

        <div class="test-section">
            <h2>Test Steps</h2>
            <button onclick="runFullTest()">Run Complete Upload Test</button>
            <div id="testStatus" style="margin-top: 20px;"></div>
        </div>

        <div class="test-section">
            <h2>Test Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Initialize Firebase (using the config from firebase-config.js)
        const firebaseConfig = {
            apiKey: "AIzaSyBxQYzJRsvh-RxXaMUakiTZ2L49DpDr8GU",
            authDomain: "photoshcheduleapp.firebaseapp.com",
            projectId: "photoshcheduleapp",
            storageBucket: "photoshcheduleapp.appspot.com",
            messagingSenderId: "832464003330",
            appId: "1:832464003330:web:d6bb17e0b87f82bb0e6d09"
        };
        firebase.initializeApp(firebaseConfig);

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('testStatus');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        async function createTestImage() {
            addLog('Creating test image...', 'info');
            
            // Create a canvas to generate a test image
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#4a90e2');
            gradient.addColorStop(1, '#7b68ee');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);
            
            // Add text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Upload Test Image', 400, 300);
            
            // Add timestamp
            ctx.font = '24px Arial';
            ctx.fillText(new Date().toISOString(), 400, 350);
            
            // Convert to blob
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    const file = new File([blob], `test-${Date.now()}.jpg`, { type: 'image/jpeg' });
                    addLog(`Created test image: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'success');
                    resolve(file);
                }, 'image/jpeg', 0.9);
            });
        }

        async function authenticate() {
            addLog('Authenticating with Firebase...', 'info');
            try {
                // Sign in anonymously for testing
                const result = await firebase.auth().signInAnonymously();
                const token = await result.user.getIdToken();
                
                // Verify with backend
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        token: token,
                        email: 'lancecasselman@icloud.com' // Override for testing
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    addLog(' Authentication successful', 'success');
                    return true;
                } else {
                    addLog('‚ùå Backend verification failed', 'error');
                    return false;
                }
            } catch (error) {
                addLog(`‚ùå Authentication error: ${error.message}`, 'error');
                return false;
            }
        }

        async function uploadFile(file) {
            const sessionId = document.getElementById('sessionId').textContent;
            addLog(`Uploading ${file.name} to session ${sessionId}...`, 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/files/gallery/upload-direct`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addLog(` Upload successful!`, 'success');
                    addLog(`   Filename: ${result.fileName}`, 'success');
                    addLog(`   R2 Key: ${result.r2Key}`, 'success');
                    addLog(`   Size: ${result.size} MB`, 'success');
                    return result;
                } else {
                    addLog(`‚ùå Upload failed: ${result.error || 'Unknown error'}`, 'error');
                    return null;
                }
            } catch (error) {
                addLog(`‚ùå Upload error: ${error.message}`, 'error');
                return null;
            }
        }

        async function verifyUpload(sessionId) {
            addLog('Verifying uploaded files...', 'info');
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/files/gallery`, {
                    credentials: 'include'
                });
                
                const files = await response.json();
                
                if (response.ok && files.length > 0) {
                    addLog(` Found ${files.length} file(s) in gallery`, 'success');
                    files.forEach(file => {
                        addLog(`   - ${file.originalName || file.fileName} (${file.size})`, 'info');
                    });
                    return true;
                } else {
                    addLog(' No files found in gallery', 'warning');
                    return false;
                }
            } catch (error) {
                addLog(`‚ùå Verification error: ${error.message}`, 'error');
                return false;
            }
        }

        async function runFullTest() {
            updateStatus('Starting test...', 'info');
            addLog('=== Starting Upload System Test ===', 'info');
            
            // Step 1: Create test image
            const testFile = await createTestImage();
            
            // Step 2: Authenticate
            const authSuccess = await authenticate();
            if (!authSuccess) {
                updateStatus('‚ùå Test failed: Authentication error', 'error');
                return;
            }
            
            // Step 3: Upload file
            const uploadResult = await uploadFile(testFile);
            if (!uploadResult) {
                updateStatus('‚ùå Test failed: Upload error', 'error');
                return;
            }
            
            // Step 4: Verify upload
            const sessionId = document.getElementById('sessionId').textContent;
            setTimeout(async () => {
                const verified = await verifyUpload(sessionId);
                
                if (verified) {
                    updateStatus(' Test completed successfully! File uploaded and verified.', 'success');
                    addLog('=== Test Completed Successfully ===', 'success');
                } else {
                    updateStatus(' Test completed with warnings: File uploaded but not found in listing', 'warning');
                    addLog('=== Test Completed with Warnings ===', 'warning');
                }
            }, 2000); // Wait 2 seconds for database to update
        }

        // Auto-run test on load
        window.addEventListener('load', () => {
            addLog('Test page loaded. Click "Run Complete Upload Test" to begin.', 'info');
        });
    </script>
</body>
</html>