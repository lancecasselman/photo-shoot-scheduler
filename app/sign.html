<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Contract</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 0 20px;
            color: #6c757d;
        }
        
        .status-item.active {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-item i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .contract-content {
            padding: 40px;
            max-height: 500px;
            overflow-y: auto;
            background: white;
        }
        
        .contract-content h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .contract-content h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .contract-content p {
            line-height: 1.8;
            color: #666;
            margin-bottom: 15px;
        }
        
        .contract-content ul, .contract-content ol {
            margin-left: 30px;
            margin-bottom: 15px;
            color: #666;
        }
        
        .contract-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .contract-meta {
            background: #f8f9fa;
            padding: 20px 40px;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .meta-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        .signature-section {
            padding: 40px;
            background: #fafbfc;
            border-top: 1px solid #e9ecef;
        }
        
        .signature-section h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .signature-pad {
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            height: 200px;
            position: relative;
            cursor: crosshair;
            margin-bottom: 20px;
        }
        
        .signature-pad canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #adb5bd;
            font-size: 18px;
            pointer-events: none;
        }
        
        .signature-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-clear {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .btn-clear:hover {
            background: #e9ecef;
        }
        
        .btn-type {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }
        
        .btn-type:hover {
            background: #d1e7ff;
        }
        
        .typed-signature {
            display: none;
            margin-bottom: 20px;
        }
        
        .typed-signature input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 24px;
            font-family: 'Brush Script MT', cursive;
            text-align: center;
            background: white;
        }
        
        .typed-signature input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .agreement-checkbox {
            display: flex;
            align-items: flex-start;
            margin-bottom: 30px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
        }
        
        .agreement-checkbox input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .agreement-checkbox label {
            flex: 1;
            color: #333;
            line-height: 1.6;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px 40px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 16px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: white;
            color: #6c757d;
            border: 2px solid #dee2e6;
            padding: 15px 40px;
            font-size: 16px;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
        }
        
        .signed-notice {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 40px;
            text-align: center;
            display: none;
        }
        
        .signed-notice h3 {
            margin-bottom: 10px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .contract-content {
                padding: 20px;
            }
            
            .signature-section {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="loading" id="loadingState">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px;">Loading contract...</p>
        </div>
        
        <div id="contractView" style="display: none;">
            <div class="header">
                <h1 id="contractTitle">Contract Agreement</h1>
                <p id="contractSubtitle">Please review and sign below</p>
            </div>
            
            <div class="status-bar">
                <div class="status-item" id="statusSent">
                    <i>üì§</i> Sent
                </div>
                <div class="status-item" id="statusViewed">
                    <i>üëÅÔ∏è</i> Viewed
                </div>
                <div class="status-item" id="statusSigned">
                    <i>‚úÖ</i> Signed
                </div>
            </div>
            
            <div class="contract-meta">
                <div class="meta-grid">
                    <div class="meta-item">
                        <span class="meta-label">Client</span>
                        <span class="meta-value" id="clientName">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Photographer</span>
                        <span class="meta-value" id="photographerName">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Date Created</span>
                        <span class="meta-value" id="createdDate">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Contract Type</span>
                        <span class="meta-value" id="contractType">-</span>
                    </div>
                </div>
            </div>
            
            <div class="contract-content" id="contractContent">
                <!-- Contract content will be loaded here -->
            </div>
            
            <div class="signed-notice" id="signedNotice">
                <h3>‚úÖ Contract Signed Successfully</h3>
                <p>This contract was signed on <span id="signedDate"></span></p>
                <p>A PDF copy has been generated and stored.</p>
            </div>
            
            <div class="signature-section" id="signatureSection">
                <h3>Electronic Signature</h3>
                
                <div class="signature-actions">
                    <button class="btn btn-clear" onclick="clearSignature()">Clear Signature</button>
                    <button class="btn btn-type" onclick="toggleTypedSignature()">Type Instead</button>
                </div>
                
                <div class="signature-pad" id="signaturePad">
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-placeholder" id="placeholder">Sign here with mouse or touch</div>
                </div>
                
                <div class="typed-signature" id="typedSignature">
                    <input type="text" id="typedName" placeholder="Type your full name">
                </div>
                
                <div class="agreement-checkbox">
                    <input type="checkbox" id="agreementCheck">
                    <label for="agreementCheck">
                        I have read and agree to the terms of this contract. By providing my electronic signature above, 
                        I acknowledge that this constitutes a legally binding agreement.
                    </label>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="downloadPDF()">Download PDF</button>
                <button class="btn btn-primary" id="signButton" onclick="submitSignature()" disabled>Sign Contract</button>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage">
            <h3>Error Loading Contract</h3>
            <p id="errorText">The contract could not be loaded. Please check the link and try again.</p>
        </div>
    </div>

    <script>
        let contract = null;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let hasSignature = false;
        let useTypedSignature = false;

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!token) {
                showError('No contract token provided');
                return;
            }
            
            loadContract();
            setupSignaturePad();
            setupAgreementCheckbox();
        });

        // Load contract
        async function loadContract() {
            try {
                const response = await fetch(`/api/contracts/view/${token}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Contract not found or access denied');
                    }
                    throw new Error('Failed to load contract');
                }
                
                contract = await response.json();
                displayContract();
                
                // Mark as viewed
                await fetch(`/api/contracts/${contract.id}/viewed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ access_token: token })
                });
                
            } catch (error) {
                console.error('Error loading contract:', error);
                showError(error.message);
            }
        }

        // Display contract
        function displayContract() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contractView').style.display = 'block';
            
            // Set contract details
            document.getElementById('contractTitle').textContent = contract.contract_title;
            document.getElementById('clientName').textContent = contract.client_name;
            document.getElementById('photographerName').textContent = contract.photographer_name || 'Photographer';
            document.getElementById('createdDate').textContent = new Date(contract.created_at).toLocaleDateString();
            document.getElementById('contractType').textContent = formatContractType(contract.contract_type);
            
            // Set contract content
            document.getElementById('contractContent').innerHTML = formatContractContent(contract.contract_content);
            
            // Update status indicators
            updateStatus();
            
            // If already signed, show signed state
            if (contract.status === 'signed') {
                showSignedState();
            }
        }

        // Format contract type
        function formatContractType(type) {
            const types = {
                'portrait': 'Portrait Session',
                'wedding': 'Wedding Photography',
                'event': 'Event Coverage',
                'commercial': 'Commercial Photography',
                'model': 'Model Release'
            };
            return types[type] || type;
        }

        // Format contract content
        function formatContractContent(content) {
            // Process merge fields
            if (contract.merge_fields) {
                Object.keys(contract.merge_fields).forEach(key => {
                    const placeholder = `{{${key}}}`;
                    const value = contract.merge_fields[key];
                    content = content.replace(new RegExp(placeholder, 'g'), value);
                });
            }
            
            // Convert markdown-style formatting to HTML
            content = content
                .replace(/^# (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^## (.*?)$/gm, '<h3>$1</h3>')
                .replace(/^### (.*?)$/gm, '<h4>$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*?)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*?)$/gm, '<li>$2</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^/g, '<p>')
                .replace(/$/g, '</p>');
            
            // Wrap list items in ul/ol tags
            content = content.replace(/(<li>.*?<\/li>\s*)+/g, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            return content;
        }

        // Update status indicators
        function updateStatus() {
            const status = contract.status;
            
            if (status === 'sent' || status === 'viewed' || status === 'signed') {
                document.getElementById('statusSent').classList.add('active');
            }
            if (status === 'viewed' || status === 'signed') {
                document.getElementById('statusViewed').classList.add('active');
            }
            if (status === 'signed') {
                document.getElementById('statusSigned').classList.add('active');
            }
        }

        // Setup signature pad
        function setupSignaturePad() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Typed signature
            document.getElementById('typedName').addEventListener('input', function() {
                hasSignature = this.value.trim().length > 0;
                updateSignButton();
            });
        }

        // Resize canvas
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Set drawing style
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // Start drawing
        function startDrawing(e) {
            if (useTypedSignature) return;
            
            isDrawing = true;
            hasSignature = true;
            document.getElementById('placeholder').style.display = 'none';
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        // Draw
        function draw(e) {
            if (!isDrawing || useTypedSignature) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            
            updateSignButton();
        }

        // Stop drawing
        function stopDrawing() {
            isDrawing = false;
        }

        // Handle touch events
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                             e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        // Clear signature
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('typedName').value = '';
            hasSignature = false;
            updateSignButton();
        }

        // Toggle typed signature
        function toggleTypedSignature() {
            useTypedSignature = !useTypedSignature;
            
            if (useTypedSignature) {
                document.getElementById('signaturePad').style.display = 'none';
                document.getElementById('typedSignature').style.display = 'block';
                event.target.textContent = 'Draw Instead';
            } else {
                document.getElementById('signaturePad').style.display = 'block';
                document.getElementById('typedSignature').style.display = 'none';
                event.target.textContent = 'Type Instead';
            }
            
            clearSignature();
        }

        // Setup agreement checkbox
        function setupAgreementCheckbox() {
            document.getElementById('agreementCheck').addEventListener('change', updateSignButton);
        }

        // Update sign button state
        function updateSignButton() {
            const agreed = document.getElementById('agreementCheck').checked;
            const signButton = document.getElementById('signButton');
            
            signButton.disabled = !agreed || !hasSignature || contract.status === 'signed';
        }

        // Submit signature
        async function submitSignature() {
            if (contract.status === 'signed') {
                alert('This contract has already been signed');
                return;
            }
            
            let signatureData;
            
            if (useTypedSignature) {
                signatureData = {
                    type: 'typed',
                    data: document.getElementById('typedName').value
                };
            } else {
                signatureData = {
                    type: 'drawn',
                    data: canvas.toDataURL()
                };
            }
            
            try {
                const response = await fetch(`/api/contracts/${contract.id}/sign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        signature: signatureData,
                        access_token: token
                    })
                });
                
                if (!response.ok) throw new Error('Failed to sign contract');
                
                const result = await response.json();
                contract = result.contract;
                
                showSignedState();
                alert('Contract signed successfully! A PDF copy has been generated.');
                
            } catch (error) {
                console.error('Error signing contract:', error);
                alert('Failed to sign contract. Please try again.');
            }
        }

        // Show signed state
        function showSignedState() {
            document.getElementById('signatureSection').style.display = 'none';
            document.getElementById('signedNotice').style.display = 'block';
            document.getElementById('signedDate').textContent = new Date(contract.signed_at).toLocaleString();
            document.getElementById('statusSigned').classList.add('active');
            updateSignButton();
        }

        // Download PDF
        async function downloadPDF() {
            try {
                const response = await fetch(`/api/contracts/${contract.id}/download?token=${token}`);
                if (!response.ok) throw new Error('Failed to download PDF');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${contract.contract_title.replace(/[^a-z0-9]/gi, '_')}_signed.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Failed to download PDF. Please try again.');
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contractView').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }
    </script>
</body>
</html>