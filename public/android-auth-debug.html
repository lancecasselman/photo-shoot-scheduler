<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Auth Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .section { margin: 20px 0; border: 1px solid #333; padding: 15px; }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .warn { color: #ff0; }
        button { padding: 10px; margin: 5px; background: #333; color: #0f0; border: 1px solid #555; }
        pre { background: #111; padding: 10px; overflow: auto; }
        #logs { height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>ü§ñ ANDROID AUTH DIAGNOSTIC</h1>
    
    <div class="section">
        <h2>üì± ENVIRONMENT CHECK</h2>
        <div id="env-check"></div>
    </div>
    
    <div class="section">
        <h2>üîê AUTHENTICATION FLOW</h2>
        <button onclick="testFullAuthFlow()">üöÄ TEST FULL AUTH FLOW</button>
        <button onclick="testSessionAccess()">üìã TEST SESSION ACCESS</button>
        <button onclick="testApiAccess()">üåê TEST API ACCESS</button>
        <button onclick="clearLogs()">üóëÔ∏è CLEAR LOGS</button>
    </div>
    
    <div class="section">
        <h2>üìä LIVE DEBUG LOGS</h2>
        <pre id="logs"></pre>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDbtboh1bW6xu9Tz9FILkx_0lzGwXQHjyM",
            authDomain: "photoshcheduleapp.firebaseapp.com",
            projectId: "photoshcheduleapp",
            storageBucket: "photoshcheduleapp.appspot.com",
            messagingSenderId: "1080892259604",
            appId: "1:1080892259604:web:8198de9d7da81c684c1601",
            measurementId: "G-MB2KDEFRHL"
        };

        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        
        let currentUser = null;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'fail' : type === 'success' ? 'pass' : 'warn';
            logsDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Environment Detection
        function checkEnvironment() {
            const envDiv = document.getElementById('env-check');
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isCapacitor = window.Capacitor !== undefined;
            const cookiesEnabled = navigator.cookieEnabled;
            const hostname = window.location.hostname;
            
            envDiv.innerHTML = `
                <div class="${isAndroid ? 'pass' : 'fail'}">Android Device: ${isAndroid}</div>
                <div class="${isCapacitor ? 'pass' : 'fail'}">Capacitor App: ${isCapacitor}</div>
                <div class="${cookiesEnabled ? 'pass' : 'fail'}">Cookies Enabled: ${cookiesEnabled}</div>
                <div>Hostname: ${hostname}</div>
                <div>User Agent: ${navigator.userAgent}</div>
                <div>Origin: ${window.location.origin}</div>
            `;
            
            log(`ENVIRONMENT: Android=${isAndroid}, Capacitor=${isCapacitor}, Cookies=${cookiesEnabled}`);
        }

        // Firebase Auth State Monitor
        onAuthStateChanged(window.auth, (user) => {
            currentUser = user;
            if (user) {
                log(`‚úÖ FIREBASE AUTH: Signed in as ${user.email}`, 'success');
            } else {
                log(`‚ùå FIREBASE AUTH: Not signed in`, 'error');
            }
        });

        // Full Authentication Flow Test
        window.testFullAuthFlow = async function() {
            try {
                log('üîÑ STARTING FULL AUTH FLOW...');
                
                // Step 1: Firebase Login
                log('STEP 1: Firebase Authentication...');
                const userCredential = await signInWithEmailAndPassword(window.auth, 'lancecasselman@icloud.com', 'password123');
                log(`‚úÖ STEP 1 SUCCESS: Firebase user ${userCredential.user.email}`, 'success');
                
                // Step 2: Get Firebase Token
                log('STEP 2: Getting Firebase ID Token...');
                const idToken = await userCredential.user.getIdToken();
                log(`‚úÖ STEP 2 SUCCESS: Token length ${idToken.length}`, 'success');
                
                // Step 3: Server Authentication
                log('STEP 3: Server Authentication...');
                const authResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Android-App': 'true',
                        'X-Capacitor-App': 'true'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ idToken })
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    log(`‚úÖ STEP 3 SUCCESS: Server auth complete`, 'success');
                    log(`Session ID: ${authData.sessionId || 'N/A'}`);
                } else {
                    const errorText = await authResponse.text();
                    log(`‚ùå STEP 3 FAILED: ${authResponse.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå AUTH FLOW ERROR: ${error.message}`, 'error');
            }
        };

        // Session Access Test
        window.testSessionAccess = async function() {
            try {
                log('üîÑ TESTING SESSION ACCESS...');
                
                const response = await fetch('/api/debug/session', {
                    method: 'GET',
                    headers: {
                        'X-Android-App': 'true',
                        'X-Capacitor-App': 'true'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const sessionData = await response.json();
                    log(`‚úÖ SESSION ACCESS: ${JSON.stringify(sessionData, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå SESSION ACCESS FAILED: ${response.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå SESSION TEST ERROR: ${error.message}`, 'error');
            }
        };

        // API Access Test
        window.testApiAccess = async function() {
            try {
                log('üîÑ TESTING API ACCESS...');
                
                const response = await fetch('/api/dashboard', {
                    method: 'GET',
                    headers: {
                        'X-Android-App': 'true',
                        'X-Capacitor-App': 'true'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    log(`‚úÖ API ACCESS: Dashboard loaded successfully`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå API ACCESS FAILED: ${response.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå API TEST ERROR: ${error.message}`, 'error');
            }
        };

        // Initialize on load
        window.onload = function() {
            checkEnvironment();
            log('ü§ñ ANDROID AUTH DEBUGGER READY');
        };
        
        window.clearLogs = clearLogs;
    </script>
</body>
</html>