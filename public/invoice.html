<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photography Invoice - The Legacy Photography</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .invoice-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 40px;
            margin: 20px 0;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #007bff;
            margin: 0;
            font-size: 2.2em;
        }
        
        .header p {
            color: #666;
            margin: 5px 0;
        }
        
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .detail-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            font-weight: 600;
        }
        
        .payment-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            margin: 30px 0;
            background-color: #f8f9fa;
        }
        
        .payment-items {
            margin-bottom: 20px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .payment-item:last-child {
            border-bottom: none;
        }
        
        .payment-item.total {
            border-top: 2px solid #007bff;
            margin-top: 15px;
            padding-top: 15px;
            font-weight: bold;
            font-size: 1.2em;
            color: #007bff;
        }
        
        .tip-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .tip-section h3 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .tip-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .tip-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .tip-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .tip-button.selected {
            background: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .custom-tip {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
        }
        
        .custom-tip input {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            width: 100px;
            text-align: center;
        }
        
        .custom-tip input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .invoice-container {
                padding: 25px;
            }
            
            .invoice-details {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .tip-options {
                flex-direction: column;
                align-items: center;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <h1>The Legacy Photography</h1>
            <p>Professional Photography Services</p>
            <p>Email: lance@thelegacyphotography.com</p>
        </div>
        
        <div id="loading" class="message">Loading invoice details...</div>
        <div id="error-message" class="message error" style="display: none;"></div>
        <div id="success-message" class="message success" style="display: none;"></div>
        
        <div id="invoice-content" style="display: none;">
            <div class="invoice-details">
                <div class="detail-section">
                    <h3>Invoice Information</h3>
                    <div class="detail-item">
                        <span class="detail-label">Invoice #:</span>
                        <span class="detail-value" id="payment-number"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Due Date:</span>
                        <span class="detail-value" id="due-date"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="status"></span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Session Information</h3>
                    <div class="detail-item">
                        <span class="detail-label">Client:</span>
                        <span class="detail-value" id="client-name"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Session Type:</span>
                        <span class="detail-value" id="session-type"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date:</span>
                        <span class="detail-value" id="session-date"></span>
                    </div>
                </div>
            </div>
            
            <div class="payment-section">
                <h3>Payment Details</h3>
                <div class="payment-items">
                    <div class="payment-item">
                        <span>Session Payment</span>
                        <span id="session-amount"></span>
                    </div>
                    <div class="payment-item" id="tip-line" style="display: none;">
                        <span>Optional Tip</span>
                        <span id="tip-amount">$0.00</span>
                    </div>
                    <div class="payment-item total">
                        <span>Total Amount</span>
                        <span id="total-amount"></span>
                    </div>
                </div>
            </div>
            
            <div class="tip-section">
                <h3>Add an Optional Tip</h3>
                <p>Show your appreciation for exceptional service</p>
                
                <div class="tip-options">
                    <button class="tip-button" onclick="selectTip(15)">15%</button>
                    <button class="tip-button" onclick="selectTip(20)">20%</button>
                    <button class="tip-button" onclick="selectTip(25)">25%</button>
                </div>
                
                <div class="custom-tip">
                    <label for="custom-tip-input">Custom amount: $</label>
                    <input type="number" id="custom-tip-input" placeholder="0.00" step="0.01" min="0" onchange="selectCustomTip()">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="updateInvoice()">Update Invoice</button>
                    <button class="btn btn-success" onclick="proceedToPayment()" id="payment-btn" style="display: none;">Proceed to Payment</button>
                </div>
                
                <!-- Send Invoice Section -->
                <div class="send-section" id="send-section" style="display: block; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-top: 3px solid #28a745;">
                    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ðŸ“¤ Send Invoice</h4>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">Share this invoice with your client via SMS or email</p>
                    
                    <div style="display: grid; gap: 12px;">
                        <button onclick="sendInvoiceViaSMS()" 
                                style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            ðŸ“± Send via SMS
                        </button>
                        
                        <button onclick="sendInvoiceViaEmail()" 
                                style="padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            ðŸ“§ Send via Email
                        </button>
                        
                        <button onclick="copyInvoiceURL()" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            ðŸ“‹ Copy Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let invoiceData = null;
        let selectedTipAmount = 0;
        
        // Get payment ID from URL parameters
        function getPaymentId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('payment') || urlParams.get('paymentId');
        }
        
        // Load invoice data on page load
        window.onload = function() {
            const paymentId = getPaymentId();
            if (!paymentId) {
                showError('Invalid invoice link. Missing payment ID.');
                return;
            }
            loadInvoiceData(paymentId);
        };
        
        // Load invoice data from localStorage (simplified approach)
        function loadInvoiceData(paymentId) {
            console.log('ðŸ”¥ Loading invoice data for payment ID:', paymentId);
            
            try {
                // Always try URL parameters first for public invoice access
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                const amount = urlParams.get('amount');
                
                console.log('ðŸ”¥ URL Parameters:', { sessionId, amount, paymentId });
                
                if (amount) {
                    invoiceData = {
                        paymentNumber: paymentId ? paymentId.replace('payment-', '').slice(-8).toUpperCase() : 'INV' + Date.now().toString().slice(-6),
                        amount: parseFloat(amount),
                        tipAmount: 0,
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        status: 'pending',
                        session: {
                            clientName: 'Photography Client',
                            sessionType: 'Photography Session',
                            dateTime: new Date().toISOString()
                        }
                    };
                    
                    console.log('âœ… Invoice data created from URL:', invoiceData);
                    
                    // Always fetch complete session data from server to get email and proper client info
                    if (sessionId) {
                        fetchCompleteSessionData(sessionId);
                    } else {
                        displayInvoiceData();
                    }
                    return;
                }
                
                // Fallback: try localStorage
                const storedData = localStorage.getItem(`payment-${paymentId}`);
                if (storedData) {
                    const paymentData = JSON.parse(storedData);
                    
                    invoiceData = {
                        paymentNumber: paymentId.replace('payment-', '').slice(-8).toUpperCase(),
                        amount: parseFloat(paymentData.amount),
                        tipAmount: 0,
                        dueDate: paymentData.dueDate,
                        status: 'pending',
                        session: {
                            clientName: paymentData.clientName,
                            clientEmail: paymentData.clientEmail,
                            sessionType: 'Photography Session',
                            dateTime: new Date().toISOString()
                        }
                    };
                    
                    console.log('âœ… Invoice data loaded from localStorage:', invoiceData);
                    console.log('ðŸ“§ Client email from invoice data:', invoiceData.session.clientEmail);
                    
                    // If we don't have the client email, try to fetch it from the server
                    if (!invoiceData.session.clientEmail && sessionId) {
                        fetchSessionEmail(sessionId);
                    }
                    
                    displayInvoiceData();
                    return;
                }
                
                throw new Error('Invoice data not found - missing amount parameter');
                
            } catch (error) {
                console.error('âŒ Error loading invoice data:', error);
                showError('Failed to load invoice: ' + error.message);
            }
        }
        
        // Display invoice data on page
        function displayInvoiceData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoice-content').style.display = 'block';
            
            // Fill in invoice details
            document.getElementById('payment-number').textContent = invoiceData.paymentNumber;
            document.getElementById('due-date').textContent = new Date(invoiceData.dueDate).toLocaleDateString();
            document.getElementById('status').textContent = invoiceData.status.charAt(0).toUpperCase() + invoiceData.status.slice(1);
            
            // Fill in session details (with fallbacks)
            document.getElementById('client-name').textContent = invoiceData.session.clientName || 'Photography Client';
            document.getElementById('session-type').textContent = invoiceData.session.sessionType || 'Photography Session';
            document.getElementById('session-date').textContent = new Date(invoiceData.session.dateTime).toLocaleDateString();
            
            // Fill in payment details
            document.getElementById('session-amount').textContent = '$' + invoiceData.amount.toFixed(2);
            
            // Set current tip amount
            selectedTipAmount = invoiceData.tipAmount;
            updateTipDisplay();
            updateTotal();
            
            // Log final invoice data for debugging
            console.log('ðŸ“„ Final invoice data displayed:', invoiceData);
        }
        
        // Select percentage tip
        function selectTip(percentage) {
            selectedTipAmount = (invoiceData.amount * percentage / 100);
            document.getElementById('custom-tip-input').value = '';
            
            // Update button states
            document.querySelectorAll('.tip-button').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            updateTipDisplay();
            updateTotal();
        }
        
        // Select custom tip amount
        function selectCustomTip() {
            const customAmount = parseFloat(document.getElementById('custom-tip-input').value) || 0;
            selectedTipAmount = customAmount;
            
            // Clear button selections
            document.querySelectorAll('.tip-button').forEach(btn => btn.classList.remove('selected'));
            
            updateTipDisplay();
            updateTotal();
        }
        
        // Update tip display
        function updateTipDisplay() {
            const tipLine = document.getElementById('tip-line');
            const tipAmountSpan = document.getElementById('tip-amount');
            
            if (selectedTipAmount > 0) {
                tipLine.style.display = 'flex';
                tipAmountSpan.textContent = '$' + selectedTipAmount.toFixed(2);
            } else {
                tipLine.style.display = 'none';
            }
        }
        
        // Update total amount
        function updateTotal() {
            const total = invoiceData.amount + selectedTipAmount;
            document.getElementById('total-amount').textContent = '$' + total.toFixed(2);
        }
        
        // Update invoice with tip (simplified - just update display)
        function updateInvoice() {
            try {
                showLoading(true);
                
                // Update the invoice data with tip
                invoiceData.tipAmount = selectedTipAmount;
                updateTipDisplay();
                updateTotal();
                
                showSuccess('Invoice updated with tip! Ready for payment.');
                document.getElementById('payment-btn').style.display = 'inline-block';
                
                // Store updated invoice data
                const paymentId = getPaymentId();
                if (paymentId.startsWith('payment-')) {
                    const storedData = localStorage.getItem(`payment-${paymentId}`);
                    if (storedData) {
                        const paymentData = JSON.parse(storedData);
                        paymentData.tipAmount = selectedTipAmount;
                        localStorage.setItem(`payment-${paymentId}`, JSON.stringify(paymentData));
                    }
                }
                
                showLoading(false);
                
            } catch (error) {
                showError('Failed to update invoice: ' + error.message);
                showLoading(false);
            }
        }
        
        // Proceed to payment (simplified demo)
        function proceedToPayment() {
            const totalAmount = invoiceData.amount + selectedTipAmount;
            const message = `ðŸŽ‰ Payment Processing Demo\n\nSession Amount: $${invoiceData.amount.toFixed(2)}\nTip Amount: $${selectedTipAmount.toFixed(2)}\nTotal: $${totalAmount.toFixed(2)}\n\nIn a real implementation, this would redirect to Stripe Checkout for secure payment processing.\n\nThank you for using the tip system!`;
            
            alert(message);
            showSuccess('Payment system demo completed! Tip functionality is working correctly.');
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }

        // Show/hide loading state
        function showLoading(show) {
            if (show) {
                document.body.classList.add('loading');
            } else {
                document.body.classList.remove('loading');
            }
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }
        
        // Fetch complete session data from server
        async function fetchCompleteSessionData(sessionId) {
            try {
                console.log('ðŸ” Fetching complete session data from server for session:', sessionId);
                const response = await fetch(`/api/sessions/${sessionId}`);
                if (response.ok) {
                    const sessionData = await response.json();
                    console.log('ðŸ“‹ Complete session data received:', sessionData);
                    
                    // Update invoice data with complete session information
                    if (sessionData) {
                        invoiceData.session.clientName = sessionData.clientName || sessionData.client_name || 'Photography Client';
                        invoiceData.session.clientEmail = sessionData.email;
                        invoiceData.session.sessionType = sessionData.sessionType || sessionData.session_type || 'Photography Session';
                        invoiceData.session.dateTime = sessionData.dateTime || sessionData.date_time || new Date().toISOString();
                        invoiceData.session.phoneNumber = sessionData.phoneNumber || sessionData.phone_number;
                        
                        console.log('âœ… Invoice data updated with session details:', invoiceData.session);
                        
                        // Refresh the display with updated session data
                        displayInvoiceData();
                    }
                } else {
                    console.warn('Failed to fetch session data:', response.status);
                }
            } catch (error) {
                console.error('Error fetching complete session data:', error);
            }
        }
        
        // Fetch session email from server as fallback
        async function fetchSessionEmail(sessionId) {
            try {
                console.log('ðŸ“§ Fetching session email from server for session:', sessionId);
                const response = await fetch(`/api/sessions/${sessionId}`);
                if (response.ok) {
                    const sessionData = await response.json();
                    if (sessionData.email) {
                        invoiceData.session.clientEmail = sessionData.email;
                        console.log('ðŸ“§ Session email fetched from server:', sessionData.email);
                    }
                }
            } catch (error) {
                console.error('Error fetching session email:', error);
            }
        }
        
        // Send invoice via SMS using device default SMS app
        function sendInvoiceViaSMS() {
            const currentURL = window.location.href;
            const totalAmount = invoiceData.amount + selectedTipAmount;
            
            // Create a friendly message for SMS
            const message = `Hi! Your photography invoice for $${invoiceData.amount.toFixed(2)}${selectedTipAmount > 0 ? ` (with $${selectedTipAmount.toFixed(2)} tip)` : ''} is ready for payment. Total: $${totalAmount.toFixed(2)}. Pay securely here: ${currentURL}`;
            
            // Create SMS URL that opens default SMS app
            const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
            
            // Open SMS app
            window.location.href = smsUrl;
            
            showSuccess('SMS app opened with invoice message!');
        }

        // Send invoice via email using device default email app
        function sendInvoiceViaEmail() {
            const currentURL = window.location.href;
            const totalAmount = invoiceData.amount + selectedTipAmount;
            const clientEmail = invoiceData.session.clientEmail || '';
            
            const subject = `Photography Invoice - $${totalAmount.toFixed(2)}`;
            const body = `Hi ${invoiceData.session.clientName || ''},

Your photography session invoice is ready for payment!

Invoice Details:
â€¢ Base Amount: $${invoiceData.amount.toFixed(2)}
${selectedTipAmount > 0 ? `â€¢ Optional Tip: $${selectedTipAmount.toFixed(2)}` : ''}
â€¢ Total Amount: $${totalAmount.toFixed(2)}

You can pay securely using the link below:
${currentURL}

Thank you for choosing our photography services!

Best regards,
The Legacy Photography`;
            
            // Create mailto URL that opens default email app with client's email pre-filled
            const mailtoUrl = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email app
            window.location.href = mailtoUrl;
            
            showSuccess(`Email app opened with invoice message${clientEmail ? ` for ${clientEmail}` : ''}!`);
        }

        // Copy invoice URL to clipboard
        function copyInvoiceURL() {
            const currentURL = window.location.href;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(currentURL).then(() => {
                    showSuccess('Invoice URL copied to clipboard!');
                }).catch(err => {
                    console.error('Clipboard copy failed:', err);
                    fallbackCopyToClipboard(currentURL);
                });
            } else {
                fallbackCopyToClipboard(currentURL);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showSuccess('Invoice URL copied to clipboard!');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showError('Could not copy URL. Please copy manually from address bar.');
            }
            
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>