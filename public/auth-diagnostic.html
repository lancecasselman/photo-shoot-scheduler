<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Diagnostic</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4f8d4;
            color: #2e7d2e;
        }
        
        .status.error {
            background: #ffd4d4;
            color: #7d2e2e;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .icon {
            margin-right: 10px;
            font-size: 20px;
        }
        
        button {
            background: #d4af37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #b8941f;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üîê Authentication System Diagnostic</h1>
    
    <div class="section">
        <h2>1. Environment Detection</h2>
        <div id="environment"></div>
    </div>
    
    <div class="section">
        <h2>2. Firebase Status</h2>
        <div id="firebase-status"></div>
    </div>
    
    <div class="section">
        <h2>3. Session Status</h2>
        <div id="session-status"></div>
        <button onclick="checkSession()">Check Session</button>
        <button onclick="createTestSession()">Create Test Session</button>
    </div>
    
    <div class="section">
        <h2>4. API Access Test</h2>
        <div id="api-status"></div>
        <button onclick="testAPIAccess()">Test API Access</button>
    </div>
    
    <div class="section">
        <h2>5. Authentication Flow</h2>
        <div id="auth-flow"></div>
        <button onclick="testFullAuthFlow()">Test Full Auth Flow</button>
    </div>
    
    <div class="section">
        <h2>6. Diagnostic Log</h2>
        <pre id="log"></pre>
    </div>
    
    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            console.log(`[${type}] ${message}`);
        };
        
        const addStatus = (containerId, message, type = 'info') => {
            const container = document.getElementById(containerId);
            const status = document.createElement('div');
            status.className = `status ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            status.innerHTML = `
                <span class="icon">${icons[type]}</span>
                <span>${message}</span>
            `;
            container.appendChild(status);
        };
        
        // 1. Environment Detection
        function detectEnvironment() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
            const isAndroid = /Android/i.test(userAgent);
            const isMobile = isIOS || isAndroid;
            const isCapacitor = window.Capacitor !== undefined;
            const isReplit = window.location.hostname.includes('replit');
            
            addStatus('environment', `Platform: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`, 'info');
            addStatus('environment', `Mobile: ${isMobile ? 'Yes' : 'No'}`, 'info');
            addStatus('environment', `Capacitor: ${isCapacitor ? 'Yes' : 'No'}`, 'info');
            addStatus('environment', `Replit Environment: ${isReplit ? 'Yes' : 'No'}`, isReplit ? 'warning' : 'info');
            addStatus('environment', `Hostname: ${window.location.hostname}`, 'info');
            
            log(`Environment detected: ${JSON.stringify({isIOS, isMobile, isCapacitor, isReplit})}`);
        }
        
        // 2. Firebase Status
        function checkFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDUrKzJb_0wt4KRhR1vBLCB1Jyb5gEWSJ4",
                    authDomain: "photoshcheduleapp.firebaseapp.com",
                    projectId: "photoshcheduleapp",
                    storageBucket: "photoshcheduleapp.appspot.com",
                    messagingSenderId: "1080892259604",
                    appId: "1:1080892259604:web:8198de9d7da81c684c1601"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                addStatus('firebase-status', 'Firebase SDK loaded', 'success');
                addStatus('firebase-status', `Project: ${firebaseConfig.projectId}`, 'info');
                
                const auth = firebase.auth();
                const currentUser = auth.currentUser;
                
                if (currentUser) {
                    addStatus('firebase-status', `Current User: ${currentUser.email}`, 'success');
                    addStatus('firebase-status', `UID: ${currentUser.uid}`, 'info');
                } else {
                    addStatus('firebase-status', 'No Firebase user signed in', 'warning');
                }
                
                log('Firebase initialized successfully');
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        log(`Auth state changed: User signed in - ${user.email}`, 'success');
                    } else {
                        log('Auth state changed: User signed out', 'warning');
                    }
                });
                
            } catch (error) {
                addStatus('firebase-status', `Firebase Error: ${error.message}`, 'error');
                log(`Firebase error: ${error.message}`, 'error');
            }
        }
        
        // 3. Check Session
        async function checkSession() {
            try {
                log('Checking backend session...');
                
                const response = await fetch('/api/auth/user', {
                    credentials: 'include',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const sessionDiv = document.getElementById('session-status');
                sessionDiv.innerHTML = '';
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        addStatus('session-status', `Session Active: ${data.user.email}`, 'success');
                        addStatus('session-status', `User ID: ${data.user.uid}`, 'info');
                        addStatus('session-status', `Display Name: ${data.user.displayName || 'Not set'}`, 'info');
                        log(`Session active for ${data.user.email}`, 'success');
                    } else {
                        addStatus('session-status', 'No active session', 'warning');
                        log('No active session found', 'warning');
                    }
                } else {
                    addStatus('session-status', `Session check failed: HTTP ${response.status}`, 'error');
                    log(`Session check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                addStatus('session-status', `Session Error: ${error.message}`, 'error');
                log(`Session check error: ${error.message}`, 'error');
            }
        }
        
        // 4. Test API Access
        async function testAPIAccess() {
            const apiDiv = document.getElementById('api-status');
            apiDiv.innerHTML = '';
            
            const endpoints = [
                { url: '/api/status', name: 'Server Status' },
                { url: '/api/auth/user', name: 'Auth User' },
                { url: '/api/sessions', name: 'Sessions (Protected)' },
                { url: '/api/stripe-public-key', name: 'Stripe Key' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`Testing ${endpoint.name}...`);
                    const response = await fetch(endpoint.url, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addStatus('api-status', `${endpoint.name}: ‚úì (${response.status})`, 'success');
                        log(`${endpoint.name} returned ${JSON.stringify(data).substring(0, 100)}...`);
                    } else {
                        addStatus('api-status', `${endpoint.name}: ${response.status}`, response.status === 401 ? 'warning' : 'error');
                        log(`${endpoint.name} failed with status ${response.status}`, 'error');
                    }
                } catch (error) {
                    addStatus('api-status', `${endpoint.name}: ${error.message}`, 'error');
                    log(`${endpoint.name} error: ${error.message}`, 'error');
                }
            }
        }
        
        // 5. Create Test Session
        async function createTestSession() {
            try {
                log('Creating test session...');
                
                // Mock Firebase login
                const testUser = {
                    uid: 'test-' + Date.now(),
                    email: 'test@example.com',
                    displayName: 'Test User'
                };
                
                const response = await fetch('/api/auth/firebase-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testUser),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addStatus('session-status', 'Test session created', 'success');
                    log('Test session created successfully', 'success');
                    checkSession();
                } else {
                    const error = await response.text();
                    addStatus('session-status', `Failed to create test session: ${error}`, 'error');
                    log(`Test session creation failed: ${error}`, 'error');
                }
            } catch (error) {
                addStatus('session-status', `Session creation error: ${error.message}`, 'error');
                log(`Session creation error: ${error.message}`, 'error');
            }
        }
        
        // 6. Test Full Auth Flow
        async function testFullAuthFlow() {
            const flowDiv = document.getElementById('auth-flow');
            flowDiv.innerHTML = '';
            
            log('Starting full authentication flow test...');
            
            // Step 1: Check initial state
            addStatus('auth-flow', '1. Checking initial state...', 'info');
            const user = firebase.auth().currentUser;
            if (user) {
                addStatus('auth-flow', `Firebase user exists: ${user.email}`, 'success');
            } else {
                addStatus('auth-flow', 'No Firebase user', 'warning');
            }
            
            // Step 2: Check backend session
            addStatus('auth-flow', '2. Checking backend session...', 'info');
            const sessionResponse = await fetch('/api/auth/user', { credentials: 'include' });
            if (sessionResponse.ok) {
                const sessionData = await sessionResponse.json();
                if (sessionData.user) {
                    addStatus('auth-flow', `Backend session exists: ${sessionData.user.email}`, 'success');
                } else {
                    addStatus('auth-flow', 'No backend session', 'warning');
                }
            }
            
            // Step 3: Test protected route
            addStatus('auth-flow', '3. Testing protected route access...', 'info');
            const protectedResponse = await fetch('/api/sessions', { credentials: 'include' });
            if (protectedResponse.ok) {
                addStatus('auth-flow', 'Can access protected routes', 'success');
                const sessions = await protectedResponse.json();
                addStatus('auth-flow', `Found ${sessions.length} sessions`, 'info');
            } else {
                addStatus('auth-flow', `Cannot access protected routes: ${protectedResponse.status}`, 'error');
            }
            
            // Step 4: Cookie check
            addStatus('auth-flow', '4. Checking cookies...', 'info');
            const cookies = document.cookie;
            if (cookies.includes('connect.sid')) {
                addStatus('auth-flow', 'Session cookie present', 'success');
            } else {
                addStatus('auth-flow', 'No session cookie found', 'warning');
            }
            
            log('Authentication flow test complete');
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            detectEnvironment();
            checkFirebase();
            checkSession();
        });
    </script>
</body>
</html>