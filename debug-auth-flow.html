<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Debug Tool</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #2a2a2a;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #d4af37;
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #f4e4bc; }
        textarea {
            width: 100%;
            height: 300px;
            background: #333;
            color: #f0f0f0;
            border: 1px solid #555;
            padding: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Current Environment</h3>
        <div id="envInfo"></div>
    </div>
    
    <div class="debug-section">
        <h3>Firebase Status</h3>
        <div id="firebaseStatus"></div>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
    </div>
    
    <div class="debug-section">
        <h3>Domain Authorization</h3>
        <div id="domainStatus"></div>
        <button onclick="testDomainAuth()">Test Domain Authorization</button>
    </div>
    
    <div class="debug-section">
        <h3>Mobile Authentication</h3>
        <div id="mobileStatus"></div>
        <button onclick="testMobileAuth()">Test Mobile Auth Handler</button>
    </div>
    
    <div class="debug-section">
        <h3>Quick Authentication Test</h3>
        <button onclick="testGoogleAuth()">Test Google Auth</button>
        <button onclick="testBackendAuth()">Test Backend Auth</button>
        <div id="authResults"></div>
    </div>
    
    <div class="debug-section">
        <h3>Console Output</h3>
        <textarea id="consoleOutput" readonly></textarea>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/mobile-auth.js"></script>

    <script>
        const consoleOutput = document.getElementById('consoleOutput');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleOutput.value += line;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(message);
        }
        
        function clearConsole() {
            consoleOutput.value = '';
        }
        
        function displayEnvironmentInfo() {
            const envInfo = {
                'Current URL': window.location.href,
                'User Agent': navigator.userAgent,
                'Is Mobile': /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                'Is Capacitor': window.Capacitor !== undefined,
                'Firebase Available': typeof firebase !== 'undefined',
                'Mobile Auth Available': typeof window.mobileAuth !== 'undefined'
            };
            
            let html = '';
            for (const [key, value] of Object.entries(envInfo)) {
                const className = value === true ? 'success' : value === false ? 'error' : 'info';
                html += `<div class="${className}">${key}: ${value}</div>`;
            }
            document.getElementById('envInfo').innerHTML = html;
            log('Environment info loaded');
        }
        
        function testFirebaseConnection() {
            log('Testing Firebase connection...');
            
            if (typeof firebase === 'undefined') {
                log('Firebase SDK not loaded!', 'error');
                document.getElementById('firebaseStatus').innerHTML = '<div class="error">Firebase SDK not loaded</div>';
                return;
            }
            
            if (!window.firebaseInitialized) {
                log('Firebase not initialized!', 'error');
                document.getElementById('firebaseStatus').innerHTML = '<div class="error">Firebase not initialized</div>';
                return;
            }
            
            const auth = firebase.auth();
            if (auth) {
                log('Firebase Auth service available', 'success');
                document.getElementById('firebaseStatus').innerHTML = `
                    <div class="success">Firebase Auth available</div>
                    <div class="info">Current user: ${auth.currentUser ? auth.currentUser.email : 'None'}</div>
                `;
            } else {
                log('Firebase Auth service not available', 'error');
                document.getElementById('firebaseStatus').innerHTML = '<div class="error">Firebase Auth not available</div>';
            }
        }
        
        function testDomainAuth() {
            log('Testing domain authorization...');
            const currentDomain = window.location.hostname;
            
            // List of domains that should be authorized
            const authorizedDomains = [
                'localhost',
                'photoshcheduleapp.firebaseapp.com',
                currentDomain
            ];
            
            let status = `<div class="info">Current domain: ${currentDomain}</div>`;
            status += `<div class="info">Required authorized domains:</div>`;
            authorizedDomains.forEach(domain => {
                status += `<div class="info">‚Ä¢ ${domain}</div>`;
            });
            
            if (currentDomain.includes('replit.dev')) {
                status += `<div class="error">‚ö†Ô∏è Replit domain detected! This domain needs to be added to Firebase Console:</div>`;
                status += `<div class="error">1. Go to Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains</div>`;
                status += `<div class="error">2. Add: ${currentDomain}</div>`;
            } else {
                status += `<div class="success">Domain appears to be authorized</div>`;
            }
            
            document.getElementById('domainStatus').innerHTML = status;
            log(`Domain check complete for: ${currentDomain}`);
        }
        
        function testMobileAuth() {
            log('Testing mobile authentication handler...');
            
            if (!window.mobileAuth) {
                log('Mobile auth handler not available', 'error');
                document.getElementById('mobileStatus').innerHTML = '<div class="error">Mobile auth handler not loaded</div>';
                return;
            }
            
            const isMobile = window.mobileAuth.isMobile;
            const isCapacitor = window.mobileAuth.isCapacitor;
            
            let status = `<div class="info">Mobile detected: ${isMobile}</div>`;
            status += `<div class="info">Capacitor detected: ${isCapacitor}</div>`;
            status += `<div class="info">Auth method: ${isMobile ? 'redirect' : 'popup'}</div>`;
            
            document.getElementById('mobileStatus').innerHTML = status;
            log(`Mobile auth test complete - Mobile: ${isMobile}, Capacitor: ${isCapacitor}`);
        }
        
        async function testGoogleAuth() {
            log('Testing Google authentication...');
            
            try {
                if (window.mobileAuth) {
                    log('Using mobile auth handler for Google sign-in');
                    const result = await window.mobileAuth.signInWithGoogle();
                    log(`Google auth result: ${JSON.stringify(result)}`, 'success');
                    document.getElementById('authResults').innerHTML = `<div class="success">Google auth test completed: ${result.method}</div>`;
                } else {
                    log('Using standard Firebase auth for Google sign-in');
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await firebase.auth().signInWithPopup(provider);
                    log(`Google auth successful: ${result.user.email}`, 'success');
                    document.getElementById('authResults').innerHTML = `<div class="success">Google auth successful: ${result.user.email}</div>`;
                }
            } catch (error) {
                log(`Google auth error: ${error.code} - ${error.message}`, 'error');
                document.getElementById('authResults').innerHTML = `<div class="error">Google auth error: ${error.message}</div>`;
            }
        }
        
        async function testBackendAuth() {
            log('Testing backend authentication...');
            
            try {
                const response = await fetch('/api/auth/user');
                const data = await response.json();
                
                if (response.ok) {
                    log(`Backend auth successful: ${JSON.stringify(data)}`, 'success');
                    document.getElementById('authResults').innerHTML = `<div class="success">Backend auth successful: ${data.email || 'User authenticated'}</div>`;
                } else {
                    log(`Backend auth failed: ${response.status} - ${JSON.stringify(data)}`, 'error');
                    document.getElementById('authResults').innerHTML = `<div class="error">Backend auth failed: ${response.status}</div>`;
                }
            } catch (error) {
                log(`Backend auth error: ${error.message}`, 'error');
                document.getElementById('authResults').innerHTML = `<div class="error">Backend auth error: ${error.message}</div>`;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('Authentication debug tool loaded');
            displayEnvironmentInfo();
            
            // Wait for Firebase to initialize
            setTimeout(() => {
                testFirebaseConnection();
                testDomainAuth();
                testMobileAuth();
            }, 1000);
        });
        
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            log(args.join(' '), 'info');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            log(args.join(' '), 'error');
            originalError.apply(console, args);
        };
    </script>
</body>
</html>