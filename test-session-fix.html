<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Fix Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #2a2a2a;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .info { color: #74c0fc; }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #d4af37;
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üîß Session Persistence Fix Test</h1>
    
    <div class="test-section">
        <h3>Multi-Email Session Test</h3>
        <div id="sessionResults"></div>
        <button onclick="testMultipleRequests()">Test Session Consistency</button>
    </div>
    
    <div class="test-section">
        <h3>Authentication Flow</h3>
        <div id="authResults"></div>
        <button onclick="testAuthFlow()">Test Authentication</button>
    </div>

    <script>
        async function testMultipleRequests() {
            const results = document.getElementById('sessionResults');
            results.innerHTML = '<div class="info">Testing multiple requests...</div>';
            
            const tests = [];
            for (let i = 0; i < 5; i++) {
                tests.push(
                    fetch('/api/auth/user', {
                        method: 'GET',
                        credentials: 'include'
                    }).then(r => r.json()).then(data => ({ request: i+1, ...data }))
                );
            }
            
            try {
                const allResults = await Promise.all(tests);
                let html = '<h4>Session Consistency Results:</h4>';
                
                const successCount = allResults.filter(r => r.email).length;
                
                allResults.forEach(result => {
                    const status = result.email ? 'success' : 'error';
                    html += `<div class="${status}">Request ${result.request}: ${result.email || 'Failed'}</div>`;
                });
                
                html += `<div class="info">Success Rate: ${successCount}/5 (${(successCount/5*100).toFixed(1)}%)</div>`;
                
                if (successCount === 5) {
                    html += '<div class="success">‚úÖ Session persistence working correctly!</div>';
                } else {
                    html += '<div class="error">‚ùå Session persistence issues detected</div>';
                }
                
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function testAuthFlow() {
            const results = document.getElementById('authResults');
            results.innerHTML = '<div class="info">Testing authentication flow...</div>';
            
            try {
                // Test 1: Check current auth status
                const authStatus = await fetch('/api/auth/user', {
                    credentials: 'include'
                }).then(r => r.json());
                
                let html = '<h4>Authentication Test Results:</h4>';
                html += `<div class="${authStatus.email ? 'success' : 'error'}">Current Status: ${authStatus.email || 'Not authenticated'}</div>`;
                
                // Test 2: Check Firebase status
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const firebaseUser = firebase.auth().currentUser;
                    html += `<div class="${firebaseUser ? 'success' : 'error'}">Firebase User: ${firebaseUser ? firebaseUser.email : 'None'}</div>`;
                    
                    // Test 3: Re-verify if Firebase user exists but backend doesn't
                    if (firebaseUser && !authStatus.email) {
                        html += '<div class="info">Re-verifying with backend...</div>';
                        
                        const verifyResponse = await fetch('/api/auth/firebase-verify', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: firebaseUser.uid,
                                email: firebaseUser.email,
                                displayName: firebaseUser.displayName
                            })
                        });
                        
                        if (verifyResponse.ok) {
                            html += '<div class="success">‚úÖ Re-verification successful</div>';
                            
                            // Test again
                            const retestAuth = await fetch('/api/auth/user', {
                                credentials: 'include'
                            }).then(r => r.json());
                            
                            html += `<div class="${retestAuth.email ? 'success' : 'error'}">After re-verify: ${retestAuth.email || 'Still failed'}</div>`;
                        } else {
                            html += '<div class="error">‚ùå Re-verification failed</div>';
                        }
                    }
                } else {
                    html += '<div class="error">Firebase not available</div>';
                }
                
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testAuthFlow();
                setTimeout(() => testMultipleRequests(), 1000);
            }, 500);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="/firebase-config.js"></script>
</body>
</html>