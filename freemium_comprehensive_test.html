<!DOCTYPE html>
<html>
<head>
    <title>üß™ Comprehensive Freemium Model Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            font-size: 2.5rem;
        }
        .test-section { 
            background: #f8f9fa; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 12px; 
            border-left: 5px solid #007acc; 
        }
        .test-section h3 {
            margin-top: 0;
            color: #007acc;
            font-size: 1.3rem;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #007acc; font-weight: bold; }
        .result { 
            margin: 8px 0; 
            padding: 12px; 
            background: white; 
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }
        .result.success { border-left-color: #28a745; }
        .result.error { border-left-color: #dc3545; }
        .result.warning { border-left-color: #ffc107; }
        .result.info { border-left-color: #007acc; }
        button { 
            margin: 8px 5px; 
            padding: 12px 20px; 
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #007acc 0%, #0056a3 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 122, 204, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        .test-constants {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-badge.running { background: #d4edda; color: #155724; }
        .status-badge.failed { background: #f8d7da; color: #721c24; }
        .status-badge.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Comprehensive Freemium Model Test</h1>
            <p>Testing John Casselman session: <code>d0892278-1882-4466-955f-fba2425e53ef</code></p>
            <p>Gallery token: <code>dda7ad42-1613-4bac-9fe0-7b38d10dba80</code></p>
        </div>
        
        <div class="test-constants">
            <strong>üéØ Test Constants:</strong><br>
            Session ID: d0892278-1882-4466-955f-fba2425e53ef<br>
            Gallery Token: dda7ad42-1613-4bac-9fe0-7b38d10dba80<br>
            Test Photo ID: 20250926005943-DSC_2057.jpg<br>
            Test Photo ID 2: 20250912035820-DSC_3428.NEF<br>
            <span id="clientKey">Client Key: [Generated dynamically]</span>
        </div>
        
        <div class="grid">
            <div class="test-section">
                <h3>üîß 1. Configuration Verification</h3>
                <div id="config-results"></div>
                <button class="btn-primary" onclick="testConfiguration()">üîç Test Config</button>
                <button class="btn-success" onclick="openGallery()">üöÄ Open Gallery</button>
            </div>
            
            <div class="test-section">
                <h3>üìä 2. Quota Enforcement</h3>
                <div id="quota-results"></div>
                <button class="btn-primary" onclick="testQuotaEnforcement()">üìà Test Quota</button>
                <button class="btn-warning" onclick="resetQuotaTest()">üîÑ Reset Test</button>
            </div>
            
            <div class="test-section">
                <h3>üí≥ 3. Payment Integration</h3>
                <div id="payment-results"></div>
                <button class="btn-primary" onclick="testPaymentFlow()">üí∞ Test Payment</button>
                <button class="btn-success" onclick="testCartFunctionality()">üõí Test Cart</button>
            </div>
            
            <div class="test-section">
                <h3>üé® 4. Client Experience</h3>
                <div id="ui-results"></div>
                <button class="btn-primary" onclick="testUIExperience()">üñ•Ô∏è Test UI</button>
                <button class="btn-success" onclick="testErrorMessages()">‚ö†Ô∏è Test Errors</button>
            </div>
            
            <div class="test-section">
                <h3>üß© 5. Edge Cases</h3>
                <div id="edge-results"></div>
                <button class="btn-primary" onclick="testEdgeCases()">üîÄ Test Edge Cases</button>
                <button class="btn-warning" onclick="testMultipleClients()">üë• Multiple Clients</button>
            </div>
            
            <div class="test-section">
                <h3>üìã 6. Comprehensive Report</h3>
                <div id="final-results"></div>
                <button class="btn-success" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="btn-warning" onclick="exportResults()">üíæ Export Results</button>
            </div>
        </div>
    </div>

    <script>
        const sessionId = 'd0892278-1882-4466-955f-fba2425e53ef';
        const galleryToken = 'dda7ad42-1613-4bac-9fe0-7b38d10dba80';
        const testPhotoId = '20250926005943-DSC_2057.jpg';
        const testPhotoId2 = '20250912035820-DSC_3428.NEF';
        
        // Generate client key using same logic as server
        const clientKey = `gallery-${CryptoJS.SHA256(`${galleryToken}-${sessionId}`).toString().substring(0, 16)}`;
        document.getElementById('clientKey').innerHTML = `Client Key: <code>${clientKey}</code>`;
        
        let testResults = {
            configuration: {},
            quota: {},
            payment: {},
            ui: {},
            edges: {},
            summary: {}
        };
        
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<span class="${type}">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function openGallery() {
            window.open(`/g/${galleryToken}`, '_blank');
            addResult('config-results', 'üöÄ Gallery opened in new tab for manual verification', 'info');
        }
        
        async function testConfiguration() {
            addResult('config-results', 'üîç Testing freemium configuration...', 'info');
            
            try {
                // Test 1: Get session policy
                const policyResponse = await fetch(`/api/downloads/policies/${sessionId}`);
                if (policyResponse.ok) {
                    const policy = await policyResponse.json();
                    testResults.configuration.policy = policy;
                    
                    addResult('config-results', `‚úÖ Policy Mode: ${policy.policy?.mode || 'N/A'}`, 'success');
                    addResult('config-results', `üí∞ Price per Photo: $${policy.policy?.pricePerPhoto || 'N/A'}`, 'success');
                    addResult('config-results', `üÜì Free Count: ${policy.policy?.freeCount || 'N/A'}`, 'success');
                    
                    // Check for pricing discrepancies
                    if (policy.policy?.pricePerPhoto) {
                        const price = parseFloat(policy.policy.pricePerPhoto);
                        if (price !== 4.50 && price !== 4.75 && price !== 4.66) {
                            addResult('config-results', `‚ö†Ô∏è UNEXPECTED PRICE: $${price} (expected $4.50, $4.75, or $4.66)`, 'warning');
                        }
                    }
                } else {
                    addResult('config-results', `‚ùå Policy API failed: ${policyResponse.status}`, 'error');
                }
                
                // Test 2: Check gallery access
                const galleryResponse = await fetch(`/g/${galleryToken}`);
                if (galleryResponse.ok) {
                    addResult('config-results', '‚úÖ Gallery accessible', 'success');
                } else {
                    addResult('config-results', `‚ùå Gallery access failed: ${galleryResponse.status}`, 'error');
                }
                
                // Test 3: Get entitlements
                const entitlementsResponse = await fetch(`/api/downloads/entitlements?sessionId=${sessionId}&clientKey=${clientKey}`);
                if (entitlementsResponse.ok) {
                    const entitlements = await entitlementsResponse.json();
                    testResults.configuration.entitlements = entitlements;
                    addResult('config-results', `üìä Current entitlements: ${entitlements.entitlements?.length || 0}`, 'info');
                } else {
                    addResult('config-results', `‚ùå Entitlements API failed: ${entitlementsResponse.status}`, 'error');
                }
                
            } catch (error) {
                addResult('config-results', `‚ùå Configuration test error: ${error.message}`, 'error');
            }
        }
        
        async function testQuotaEnforcement() {
            addResult('quota-results', 'üìà Testing quota enforcement...', 'info');
            
            try {
                // Test free download attempt
                const freeResponse = await fetch('/api/downloads/free-entitlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        photoId: testPhotoId,
                        photoUrl: `test-url-${Date.now()}`,
                        filename: 'test-photo.jpg',
                        galleryToken: galleryToken
                    })
                });
                
                const freeResult = await freeResponse.json();
                testResults.quota.freeAttempt = { status: freeResponse.status, data: freeResult };
                
                if (freeResponse.ok) {
                    addResult('quota-results', `‚úÖ Free download successful. Quota remaining: ${freeResult.quotaInfo?.remaining || 'N/A'}`, 'success');
                } else {
                    addResult('quota-results', `‚ö†Ô∏è Free download failed: ${freeResult.error}`, freeResult.error?.includes('exceeded') ? 'warning' : 'error');
                }
                
                // Test second free download attempt (should be blocked or allowed based on policy)
                const secondResponse = await fetch('/api/downloads/free-entitlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        photoId: testPhotoId2,
                        photoUrl: `test-url-2-${Date.now()}`,
                        filename: 'test-photo-2.jpg',
                        galleryToken: galleryToken
                    })
                });
                
                const secondResult = await secondResponse.json();
                testResults.quota.secondAttempt = { status: secondResponse.status, data: secondResult };
                
                if (secondResponse.ok) {
                    addResult('quota-results', `‚úÖ Second free download successful. Quota remaining: ${secondResult.quotaInfo?.remaining || 'N/A'}`, 'success');
                } else {
                    addResult('quota-results', `üö´ Second free download blocked: ${secondResult.error}`, 'warning');
                }
                
            } catch (error) {
                addResult('quota-results', `‚ùå Quota test error: ${error.message}`, 'error');
            }
        }
        
        async function testPaymentFlow() {
            addResult('payment-results', 'üí∞ Testing payment integration...', 'info');
            
            try {
                // Test checkout session creation
                const checkoutResponse = await fetch('/api/downloads/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        clientKey: clientKey,
                        clientName: 'Test Client',
                        items: [
                            {
                                photoId: testPhotoId,
                                photoUrl: 'test-url',
                                filename: 'test-photo.jpg',
                                price: 4.50
                            }
                        ]
                    })
                });
                
                const checkoutResult = await checkoutResponse.json();
                testResults.payment.checkout = { status: checkoutResponse.status, data: checkoutResult };
                
                if (checkoutResponse.ok) {
                    addResult('payment-results', `‚úÖ Checkout session created successfully`, 'success');
                    addResult('payment-results', `üîó Checkout URL: ${checkoutResult.checkoutUrl ? 'Generated' : 'Missing'}`, checkoutResult.checkoutUrl ? 'success' : 'error');
                } else {
                    addResult('payment-results', `‚ùå Checkout creation failed: ${checkoutResult.error}`, 'error');
                }
                
            } catch (error) {
                addResult('payment-results', `‚ùå Payment test error: ${error.message}`, 'error');
            }
        }
        
        async function testCartFunctionality() {
            addResult('payment-results', 'üõí Testing cart functionality...', 'info');
            
            // Simulate adding multiple items to cart
            const cartItems = [
                { photoId: testPhotoId, price: 4.50, filename: 'photo1.jpg' },
                { photoId: testPhotoId2, price: 4.50, filename: 'photo2.jpg' },
                { photoId: 'test-photo-3', price: 4.50, filename: 'photo3.jpg' }
            ];
            
            try {
                const cartResponse = await fetch('/api/downloads/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        clientKey: clientKey,
                        clientName: 'Cart Test Client',
                        items: cartItems.map(item => ({
                            photoId: item.photoId,
                            photoUrl: `test-url-${item.photoId}`,
                            filename: item.filename,
                            price: item.price
                        }))
                    })
                });
                
                const cartResult = await cartResponse.json();
                testResults.payment.cart = { status: cartResponse.status, data: cartResult };
                
                if (cartResponse.ok) {
                    addResult('payment-results', `‚úÖ Multi-item cart checkout created (${cartItems.length} items)`, 'success');
                    const totalExpected = cartItems.length * 4.50;
                    addResult('payment-results', `üí∞ Expected total: $${totalExpected.toFixed(2)}`, 'info');
                } else {
                    addResult('payment-results', `‚ùå Cart checkout failed: ${cartResult.error}`, 'error');
                }
                
            } catch (error) {
                addResult('payment-results', `‚ùå Cart test error: ${error.message}`, 'error');
            }
        }
        
        async function testUIExperience() {
            addResult('ui-results', 'üñ•Ô∏è Testing UI experience...', 'info');
            
            try {
                // Test gallery page content
                const galleryResponse = await fetch(`/g/${galleryToken}`);
                if (galleryResponse.ok) {
                    const galleryHTML = await galleryResponse.text();
                    
                    // Check for key UI elements
                    const checks = [
                        { test: galleryHTML.includes('pricing-banner'), desc: 'Pricing banner element' },
                        { test: galleryHTML.includes('freemium'), desc: 'Freemium logic' },
                        { test: galleryHTML.includes('FREE'), desc: 'FREE button text' },
                        { test: galleryHTML.includes('$'), desc: 'Price display' },
                        { test: galleryHTML.includes('download-btn'), desc: 'Download button styles' },
                        { test: galleryHTML.includes('cart'), desc: 'Cart functionality' }
                    ];
                    
                    checks.forEach(check => {
                        addResult('ui-results', `${check.test ? '‚úÖ' : '‚ùå'} ${check.desc}`, check.test ? 'success' : 'error');
                    });
                    
                    testResults.ui.galleryChecks = checks;
                } else {
                    addResult('ui-results', `‚ùå Gallery UI test failed: ${galleryResponse.status}`, 'error');
                }
                
            } catch (error) {
                addResult('ui-results', `‚ùå UI test error: ${error.message}`, 'error');
            }
        }
        
        async function testErrorMessages() {
            addResult('ui-results', '‚ö†Ô∏è Testing error message handling...', 'info');
            
            try {
                // Test with invalid session
                const invalidResponse = await fetch('/api/downloads/free-entitlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: 'invalid-session-id',
                        photoId: testPhotoId,
                        photoUrl: 'test-url',
                        filename: 'test.jpg',
                        galleryToken: galleryToken
                    })
                });
                
                const invalidResult = await invalidResponse.json();
                testResults.ui.errorHandling = { status: invalidResponse.status, data: invalidResult };
                
                if (!invalidResponse.ok && invalidResult.error) {
                    addResult('ui-results', `‚úÖ Error handling working: ${invalidResult.error}`, 'success');
                } else {
                    addResult('ui-results', `‚ùå Error handling not working properly`, 'error');
                }
                
            } catch (error) {
                addResult('ui-results', `‚ùå Error message test failed: ${error.message}`, 'error');
            }
        }
        
        async function testEdgeCases() {
            addResult('edge-results', 'üß© Testing edge cases...', 'info');
            
            // Test 1: Multiple rapid requests
            addResult('edge-results', '‚ö° Testing rapid consecutive requests...', 'info');
            
            const rapidRequests = [];
            for (let i = 0; i < 3; i++) {
                rapidRequests.push(
                    fetch('/api/downloads/free-entitlement', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            photoId: `rapid-test-${i}-${Date.now()}`,
                            photoUrl: `test-url-${i}`,
                            filename: `rapid-test-${i}.jpg`,
                            galleryToken: galleryToken
                        })
                    })
                );
            }
            
            try {
                const rapidResults = await Promise.all(rapidRequests);
                const statuses = rapidResults.map(r => r.status);
                addResult('edge-results', `‚ö° Rapid request statuses: ${statuses.join(', ')}`, 'info');
                
                testResults.edges.rapidRequests = statuses;
                
            } catch (error) {
                addResult('edge-results', `‚ùå Rapid request test error: ${error.message}`, 'error');
            }
        }
        
        async function testMultipleClients() {
            addResult('edge-results', 'üë• Testing multiple client isolation...', 'info');
            
            // Generate different client keys
            const client1 = `test-client-1-${Date.now()}`;
            const client2 = `test-client-2-${Date.now()}`;
            
            try {
                // Test client 1
                const client1Response = await fetch('/api/downloads/entitlements', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        clientKey: client1
                    })
                });
                
                // Test client 2
                const client2Response = await fetch('/api/downloads/entitlements', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        clientKey: client2
                    })
                });
                
                addResult('edge-results', `üë§ Client 1 status: ${client1Response.status}`, 'info');
                addResult('edge-results', `üë§ Client 2 status: ${client2Response.status}`, 'info');
                
                testResults.edges.multipleClients = {
                    client1: client1Response.status,
                    client2: client2Response.status
                };
                
            } catch (error) {
                addResult('edge-results', `‚ùå Multiple client test error: ${error.message}`, 'error');
            }
        }
        
        async function resetQuotaTest() {
            addResult('quota-results', 'üîÑ Note: Quota reset requires database cleanup (admin only)', 'warning');
        }
        
        function generateReport() {
            addResult('final-results', 'üìÑ Generating comprehensive test report...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                testSession: {
                    sessionId: sessionId,
                    galleryToken: galleryToken,
                    clientKey: clientKey
                },
                results: testResults,
                summary: {
                    configurationPassed: testResults.configuration.policy ? true : false,
                    quotaEnforcementTested: testResults.quota.freeAttempt ? true : false,
                    paymentIntegrationTested: testResults.payment.checkout ? true : false,
                    uiElementsVerified: testResults.ui.galleryChecks ? true : false,
                    edgeCasesTested: testResults.edges.rapidRequests ? true : false
                }
            };
            
            addResult('final-results', '‚úÖ Test report generated', 'success');
            addResult('final-results', `üìä Configuration: ${report.summary.configurationPassed ? 'PASS' : 'FAIL'}`, report.summary.configurationPassed ? 'success' : 'error');
            addResult('final-results', `üìä Quota Enforcement: ${report.summary.quotaEnforcementTested ? 'TESTED' : 'NOT TESTED'}`, report.summary.quotaEnforcementTested ? 'success' : 'warning');
            addResult('final-results', `üìä Payment Integration: ${report.summary.paymentIntegrationTested ? 'TESTED' : 'NOT TESTED'}`, report.summary.paymentIntegrationTested ? 'success' : 'warning');
            
            testResults.finalReport = report;
        }
        
        function exportResults() {
            const dataStr = JSON.stringify(testResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `freemium-test-results-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            link.click();
            
            addResult('final-results', 'üíæ Test results exported to JSON file', 'success');
        }
        
        // Auto-run configuration test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testConfiguration, 1000);
        });
    </script>
    
    <!-- Include crypto-js for client key generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</body>
</html>