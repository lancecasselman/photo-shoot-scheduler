<!DOCTYPE html>
<html>
<head><title>Freemium Button Test</title></head>
<body>
<h2>Freemium Button Logic Test</h2>
<div id="results"></div>
<div id="test-gallery"></div>

<script>
// Simulate the exact data from the backend
const sessionData = {
    pricingModel: 'freemium',
    freeDownloads: 2,
    pricePerDownload: '4.66'
};

const entitlements = []; // No entitlements (as confirmed by server logs)
const photos = [
    { id: '1', filename: 'photo1.jpg', url: '/test1.jpg' },
    { id: '2', filename: 'photo2.jpg', url: '/test2.jpg' },
    { id: '3', filename: 'photo3.jpg', url: '/test3.jpg' },
    { id: '4', filename: 'photo4.jpg', url: '/test4.jpg' }
];

// Build policy (same as frontend)
let mode = 'free';
const pricingModel = sessionData.pricingModel || sessionData.pricing_model;
switch (pricingModel) {
    case 'freemium':
        mode = 'freemium';
        break;
    case 'paid':
    case 'fixed':
        mode = 'fixed';
        break;
    default:
        mode = 'free';
}

const policy = {
    mode: mode,
    pricePerPhoto: sessionData.pricePerDownload || sessionData.price_per_download || 0,
    freeCount: sessionData.freeDownloads || sessionData.free_downloads || 0,
};

// Calculate prices for each photo (same as frontend)
function calculatePhotoPrice(photoIndex) {
    if (!policy) return null;
    
    switch (policy.mode) {
        case 'freemium':
            const freeCount = parseInt(policy.freeCount || 0);
            const usedFreeDownloads = entitlements.filter(e => e.type === 'free' || e.price === 0).length;
            const remainingFreeDownloads = Math.max(0, freeCount - usedFreeDownloads);
            
            let freeCartItemsBeforeThis = 0;
            const totalFreeUsedIncludingCart = usedFreeDownloads + freeCartItemsBeforeThis;
            return totalFreeUsedIncludingCart + photoIndex < freeCount ? 0 : parseFloat(policy.pricePerPhoto || 0);
            
        default:
            return 0;
    }
}

// Test the button logic
const resultsDiv = document.getElementById('results');
const galleryDiv = document.getElementById('test-gallery');

resultsDiv.innerHTML = `
<h3>Test Results:</h3>
<p><strong>Session Data:</strong> ${JSON.stringify(sessionData)}</p>
<p><strong>Policy:</strong> ${JSON.stringify(policy)}</p>
<p><strong>Entitlements:</strong> ${JSON.stringify(entitlements)}</p>
<br>
`;

// Test each photo
photos.forEach((photo, index) => {
    const photoIdToCheck = photo.id || index.toString();
    const isEntitled = entitlements.some(e => 
        e.photoId === photo.id ||
        e.photoId === index.toString() ||
        e.photoId === photoIdToCheck ||
        e.photoUrl === photo.url ||
        e.photoId === photo.filename
    );
    
    const price = calculatePhotoPrice(index);
    const isFreemium = policy && policy.mode === 'freemium';
    const willShowFreemiumButton = !isEntitled && policy && policy.mode === 'freemium';
    
    // Create button HTML (same as frontend logic)
    let buttonHTML = '';
    if (isEntitled) {
        buttonHTML = `<button class="download-btn">ðŸ“¥ Download</button>`;
    } else {
        if (policy && policy.mode === 'freemium') {
            buttonHTML = `<button class="freemium-btn ${price === 0 ? 'free' : 'paid'}">ðŸ“¥ ${price === 0 ? 'FREE' : `$${price.toFixed(2)}`}</button>`;
        } else {
            buttonHTML = `<button class="cart-btn">ðŸ›’ Add to Cart</button>`;
        }
    }
    
    const photoDiv = document.createElement('div');
    photoDiv.innerHTML = `
        <h4>Photo ${index + 1} (${photo.filename})</h4>
        <p>Is Entitled: ${isEntitled}</p>
        <p>Price: ${price}</p>
        <p>Policy Mode: ${policy?.mode}</p>
        <p>Is Freemium: ${isFreemium}</p>
        <p>Will Show Freemium Button: ${willShowFreemiumButton}</p>
        <p>Button: ${buttonHTML}</p>
        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            ${buttonHTML}
        </div>
        <hr>
    `;
    
    galleryDiv.appendChild(photoDiv);
    
    console.log(`Photo ${index + 1} Debug:`, {
        isEntitled,
        price,
        policyMode: policy?.mode,
        isFreemium,
        willShowFreemiumButton,
        buttonHTML
    });
});
</script>
</body>
</html>
