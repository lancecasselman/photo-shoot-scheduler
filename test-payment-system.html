<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment System Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { border-left: 4px solid #28a745; background: #f8fff9; }
        .error { border-left: 4px solid #dc3545; background: #fff8f8; }
        .info { border-left: 4px solid #007bff; background: #f8f9ff; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-results { margin-top: 20px; }
        .log { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Payment System Test Suite</h1>
        <p>Testing the integrated Stripe payment processing system for photography sessions.</p>
        
        <div class="test-section info">
            <h3>Test Configuration</h3>
            <p><strong>Test Invoice URL:</strong> <a href="/invoice.html?payment=test-payment&sessionId=test-session&amount=150&type=invoice&sessionId=test-session" target="_blank">Open Test Invoice</a></p>
            <p><strong>Test Deposit URL:</strong> <a href="/invoice.html?payment=test-deposit&sessionId=test-session&amount=75&type=deposit" target="_blank">Open Test Deposit</a></p>
        </div>

        <div class="test-section">
            <h3>1. Stripe Configuration Test</h3>
            <button onclick="testStripeConfig()">Test Stripe Config</button>
            <div id="stripe-config-result" class="test-results"></div>
        </div>

        <div class="test-section">
            <h3>2. Payment Intent Creation Test</h3>
            <button onclick="testPaymentIntent()">Test Payment Intent (Will Fail - No Session)</button>
            <div id="payment-intent-result" class="test-results"></div>
        </div>

        <div class="test-section">
            <h3>3. Invoice Page Loading Test</h3>
            <button onclick="testInvoicePage()">Test Invoice Page</button>
            <div id="invoice-page-result" class="test-results"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Results Summary</h3>
            <div id="test-summary" class="test-results">
                <p>Click the test buttons above to verify payment system functionality.</p>
            </div>
        </div>
    </div>

    <script>
        let testResults = [];

        function logResult(test, success, message, details = '') {
            const result = { test, success, message, details, timestamp: new Date().toISOString() };
            testResults.push(result);
            updateTestSummary();
            return result;
        }

        function updateTestSummary() {
            const summary = document.getElementById('test-summary');
            const passed = testResults.filter(r => r.success).length;
            const total = testResults.length;
            
            summary.innerHTML = `
                <p><strong>Tests Run:</strong> ${total} | <strong>Passed:</strong> ${passed} | <strong>Failed:</strong> ${total - passed}</p>
                ${testResults.map(r => `
                    <div class="log ${r.success ? 'success' : 'error'}">
                        <strong>${r.test}:</strong> ${r.message}
                        ${r.details ? `<br><small>${r.details}</small>` : ''}
                    </div>
                `).join('')}
            `;
        }

        async function testStripeConfig() {
            try {
                const response = await fetch('/api/stripe-config');
                const config = await response.json();
                
                const resultDiv = document.getElementById('stripe-config-result');
                
                if (response.ok && config.publicKey) {
                    resultDiv.innerHTML = `
                        <div class="log success">
                            ‚úÖ Stripe configuration successful<br>
                            Public Key: ${config.publicKey.substring(0, 20)}... (${config.publicKey.length} chars)
                        </div>
                    `;
                    logResult('Stripe Config', true, 'Configuration loaded successfully');
                } else {
                    resultDiv.innerHTML = `<div class="log error">‚ùå Stripe configuration failed</div>`;
                    logResult('Stripe Config', false, 'Configuration failed');
                }
            } catch (error) {
                document.getElementById('stripe-config-result').innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                logResult('Stripe Config', false, `Error: ${error.message}`);
            }
        }

        async function testPaymentIntent() {
            try {
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 150,
                        sessionId: 'test-session-nonexistent',
                        paymentType: 'invoice',
                        clientEmail: 'test@example.com'
                    })
                });

                const result = await response.json();
                const resultDiv = document.getElementById('payment-intent-result');
                
                if (response.status === 404 && result.error === 'Session not found') {
                    resultDiv.innerHTML = `
                        <div class="log success">
                            ‚úÖ Payment intent validation working correctly<br>
                            Expected error for non-existent session: "${result.error}"
                        </div>
                    `;
                    logResult('Payment Intent', true, 'Validation working - correctly rejected invalid session');
                } else if (response.ok && result.clientSecret) {
                    resultDiv.innerHTML = `
                        <div class="log success">
                            ‚úÖ Payment intent created successfully<br>
                            Client Secret: ${result.clientSecret.substring(0, 20)}...
                        </div>
                    `;
                    logResult('Payment Intent', true, 'Payment intent created successfully');
                } else {
                    resultDiv.innerHTML = `<div class="log error">‚ùå Unexpected response: ${JSON.stringify(result)}</div>`;
                    logResult('Payment Intent', false, `Unexpected response: ${result.error || 'Unknown'}`);
                }
            } catch (error) {
                document.getElementById('payment-intent-result').innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                logResult('Payment Intent', false, `Error: ${error.message}`);
            }
        }

        async function testInvoicePage() {
            try {
                const response = await fetch('/invoice.html?payment=test&sessionId=test&amount=150&type=invoice');
                const resultDiv = document.getElementById('invoice-page-result');
                
                if (response.ok) {
                    const html = await response.text();
                    const hasStripe = html.includes('stripe.com/v3');
                    const hasPayment = html.includes('proceedToPayment');
                    const hasConfig = html.includes('stripe-config');
                    
                    resultDiv.innerHTML = `
                        <div class="log success">
                            ‚úÖ Invoice page loads successfully<br>
                            Stripe SDK: ${hasStripe ? '‚úÖ' : '‚ùå'}<br>
                            Payment Function: ${hasPayment ? '‚úÖ' : '‚ùå'}<br>
                            Config Endpoint: ${hasConfig ? '‚úÖ' : '‚ùå'}
                        </div>
                    `;
                    
                    const allFeatures = hasStripe && hasPayment && hasConfig;
                    logResult('Invoice Page', allFeatures, allFeatures ? 'All payment features present' : 'Some payment features missing');
                } else {
                    resultDiv.innerHTML = `<div class="log error">‚ùå Invoice page failed to load (${response.status})</div>`;
                    logResult('Invoice Page', false, `Failed to load (${response.status})`);
                }
            } catch (error) {
                document.getElementById('invoice-page-result').innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                logResult('Invoice Page', false, `Error: ${error.message}`);
            }
        }

        // Auto-run all tests on page load
        window.onload = function() {
            console.log('üß™ Payment System Test Suite Loaded');
            setTimeout(() => {
                testStripeConfig();
                setTimeout(() => testPaymentIntent(), 1000);
                setTimeout(() => testInvoicePage(), 2000);
            }, 500);
        };
    </script>
</body>
</html>