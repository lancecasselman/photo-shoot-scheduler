<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2 Upload Security Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        .upload-area.dragover {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .upload-btn:hover {
            background: #45a049;
        }
        .test-btn {
            background: #ff9800;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #f57c00;
        }
        .file-list {
            margin: 20px 0;
        }
        .file-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        .security-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .security-violation {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success-info {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log-area {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí R2 Upload Security Test</h1>
        
        <div class="security-info">
            <strong>‚ö†Ô∏è Security Features Active:</strong>
            <ul>
                <li>‚úÖ Server-side file size verification via HEAD requests</li>
                <li>‚úÖ Auto-deletion of files exceeding limits</li>
                <li>‚úÖ Mandatory upload confirmation</li>
                <li>‚úÖ Storage quota enforcement</li>
                <li>‚úÖ Size mismatch detection</li>
                <li>‚úÖ R2 key-based upload tracking (no filename collisions)</li>
            </ul>
        </div>

        <div class="upload-area" id="dropZone">
            <p>üìÅ Drag & drop files here or click to browse</p>
            <input type="file" id="fileInput" class="file-input" multiple>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            <button class="upload-btn" onclick="startUpload()">üöÄ Start Upload</button>
        </div>

        <div>
            <h3>üß™ Security Test Scenarios</h3>
            <button class="test-btn" onclick="testOversizedFile()">Test Oversized File</button>
            <button class="test-btn" onclick="testQuotaExceed()">Test Quota Exceed</button>
            <button class="test-btn" onclick="testMultipleSameName()">Test Same Name Files</button>
            <button class="test-btn" onclick="testSizeMismatch()">Test Size Mismatch</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Total Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uploadedFiles">0</div>
                <div class="stat-label">Uploaded</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="confirmedFiles">0</div>
                <div class="stat-label">Confirmed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="deletedFiles">0</div>
                <div class="stat-label">Deleted (Security)</div>
            </div>
        </div>

        <div id="fileList" class="file-list"></div>
        
        <div class="progress-bar">
            <div class="progress" id="overallProgress"></div>
        </div>

        <div id="results"></div>

        <div class="log-area" id="logArea">
            === R2 Upload Security Test Log ===
            Waiting for uploads...
        </div>
    </div>

    <script src="/public/r2-direct-upload.js"></script>
    <script>
        let selectedFiles = [];
        let uploader = null;
        let sessionId = null;

        // Initialize
        async function init() {
            // Generate a test session ID
            sessionId = 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            log(`Session ID: ${sessionId}`);
            
            // Setup drag & drop
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // File input change
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileList();
            updateStats();
            log(`Selected ${selectedFiles.length} files for upload`);
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<h3>üìã Selected Files:</h3>';
            
            selectedFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>${file.name}</span>
                    <span>${(file.size / (1024*1024)).toFixed(2)} MB</span>
                `;
                fileList.appendChild(item);
            });
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = selectedFiles.length;
        }

        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toISOString().substr(11, 8);
            const prefix = type === 'error' ? '‚ùå' : 
                          type === 'warning' ? '‚ö†Ô∏è' : 
                          type === 'success' ? '‚úÖ' : 
                          type === 'security' ? 'üîí' : 'üìù';
            logArea.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function startUpload() {
            if (selectedFiles.length === 0) {
                alert('Please select files first');
                return;
            }

            log(`Starting upload of ${selectedFiles.length} files...`);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Create uploader with security callbacks
            uploader = new R2DirectUploader({
                sessionId: sessionId,
                maxConcurrent: 4,
                onProgress: (filename, progress) => {
                    document.getElementById('overallProgress').style.width = progress + '%';
                    log(`Upload progress: ${filename} - ${Math.round(progress)}%`);
                },
                onFileComplete: (filename, key, success, error) => {
                    if (success) {
                        log(`File uploaded: ${filename} -> ${key}`, 'success');
                        document.getElementById('uploadedFiles').textContent = 
                            parseInt(document.getElementById('uploadedFiles').textContent) + 1;
                    } else {
                        log(`File failed: ${filename} - ${error}`, 'error');
                    }
                },
                onError: (filename, error) => {
                    log(`ERROR: ${filename} - ${error}`, 'error');
                    if (filename === 'SECURITY') {
                        showSecurityViolation(error);
                    }
                },
                onAllComplete: (result) => {
                    log(`Upload batch complete: ${result.completed.length} succeeded, ${result.failed.length} failed`);
                    
                    // Check confirmation results
                    if (result.confirmationResult) {
                        handleConfirmationResult(result.confirmationResult);
                    }
                }
            });

            try {
                const result = await uploader.uploadFiles(selectedFiles, sessionId);
                
                if (result.success) {
                    showSuccess(`All ${result.completed.length} files uploaded and confirmed successfully!`);
                } else {
                    showError(`Upload completed with ${result.failed.length} failures`);
                }
            } catch (error) {
                log(`Upload error: ${error.message}`, 'error');
                showError(error.message);
            }
        }

        function handleConfirmationResult(result) {
            log(`Confirmation result: ${result.confirmed} confirmed, ${result.failed} failed, ${result.deleted} deleted`, 'security');
            
            document.getElementById('confirmedFiles').textContent = result.confirmed || 0;
            document.getElementById('deletedFiles').textContent = result.deleted || 0;
            
            if (result.deleted > 0) {
                showSecurityViolation(`${result.deleted} files were auto-deleted due to security violations`);
                
                if (result.deletedFiles) {
                    result.deletedFiles.forEach(file => {
                        log(`DELETED: ${file.filename} - ${file.reason}`, 'security');
                    });
                }
            }
            
            if (result.sizeMismatch) {
                log(`SIZE MISMATCH DETECTED: Declared ${result.totalDeclaredSize} bytes, Actual ${result.totalActualSize} bytes`, 'warning');
            }
        }

        function showSecurityViolation(message) {
            const resultsDiv = document.getElementById('results');
            const violation = document.createElement('div');
            violation.className = 'security-violation';
            violation.innerHTML = `<strong>üö® Security Violation:</strong> ${message}`;
            resultsDiv.appendChild(violation);
        }

        function showSuccess(message) {
            const resultsDiv = document.getElementById('results');
            const success = document.createElement('div');
            success.className = 'success-info';
            success.innerHTML = `<strong>‚úÖ Success:</strong> ${message}`;
            resultsDiv.appendChild(success);
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            const error = document.createElement('div');
            error.className = 'security-violation';
            error.innerHTML = `<strong>‚ùå Error:</strong> ${message}`;
            resultsDiv.appendChild(error);
        }

        // Test functions
        function testOversizedFile() {
            log('Creating oversized file test...', 'warning');
            // Create a fake large file (this is just for testing the validation)
            const largeFile = new File(['x'.repeat(600 * 1024 * 1024)], 'oversized-test.jpg', { type: 'image/jpeg' });
            selectedFiles = [largeFile];
            updateFileList();
            updateStats();
            log('Added 600MB file (exceeds 500MB limit for images)', 'warning');
        }

        function testQuotaExceed() {
            log('Creating quota exceed test...', 'warning');
            alert('This test requires uploading files that exceed your storage quota');
        }

        function testMultipleSameName() {
            log('Creating multiple same-name files test...', 'warning');
            const file1 = new File(['content1'], 'duplicate.jpg', { type: 'image/jpeg' });
            const file2 = new File(['content2'], 'duplicate.jpg', { type: 'image/jpeg' });
            const file3 = new File(['content3'], 'duplicate.jpg', { type: 'image/jpeg' });
            selectedFiles = [file1, file2, file3];
            updateFileList();
            updateStats();
            log('Added 3 files with identical names', 'warning');
        }

        function testSizeMismatch() {
            log('Size mismatch test requires manual manipulation', 'warning');
            alert('To test size mismatch detection, the client would need to declare one size but upload different content');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>