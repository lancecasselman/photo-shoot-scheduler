<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photographers Website - Portfolio Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Montserrat:wght@100;300;400;600;700;900&family=Raleway:wght@100;300;400;600;700;900&family=Cormorant+Garamond:wght@300;400;600;700&family=Josefin+Sans:wght@100;300;400;600;700&family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            overflow: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }

        .builder-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Bottom Tools Bar */
        .builder-tools {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .tools-header {
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0;
            border-bottom: 1px solid #f1f5f9;
            background: rgba(248, 250, 252, 0.8);
        }

        .tools-tabs {
            display: flex;
            align-items: center;
            height: 100%;
            padding: 0 20px;
        }

        .tool-tab {
            padding: 0 20px;
            height: 100%;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .tool-tab:hover {
            color: #2d3748;
            background: rgba(255, 255, 255, 0.5);
        }

        .tool-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-panel {
            display: none;
            height: 100%;
        }

        .tab-panel.active {
            display: block;
        }

        .tools-content {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0;
        }

        .tools-scroll {
            display: flex;
            gap: 15px;
            padding: 0 20px;
            min-width: fit-content;
        }

        .tool-section {
            flex-shrink: 0;
            min-width: 200px;
        }

        .tool-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Templates */
        .template-list {
            display: flex;
            gap: 8px;
        }

        .template-card {
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 80px;
            background: white;
        }

        .template-card:hover {
            border-color: #667eea;
            background: #f7faff;
        }

        .template-card.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .template-name {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Components */
        .component-list {
            display: flex;
            gap: 8px;
        }

        .component-item {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: fit-content;
            white-space: nowrap;
        }

        .component-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .component-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }

        .component-icon {
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 8px;
        }

        .component-text {
            font-size: 11px;
            font-weight: 500;
        }

        /* Canvas - Full Screen Preview */
        .builder-canvas {
            flex: 1;
            background: white;
            overflow-y: auto;
            margin-bottom: 120px;
        }

        .canvas-container {
            width: 100%;
            min-height: calc(100vh - 170px);
            background: white;
            position: relative;
            z-index: 0;
        }

        .canvas-viewport {
            padding: 0;
            position: relative;
            z-index: 0;
            width: 100%;
            min-height: 100%;
        }

        /* Properties in Tools */
        .properties-section {
            min-width: 250px;
        }

        .property-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .property-input {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
            background: white;
        }

        .property-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .property-label {
            font-size: 10px;
            color: #4a5568;
            margin-bottom: 4px;
            display: block;
        }

        /* Canvas Elements */
        .element {
            margin: 0;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .element:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: inset 0 0 0 1px rgba(102, 126, 234, 0.2);
            z-index: 2;
        }

        .element.selected {
            border-color: #667eea;
            box-shadow: inset 0 0 0 1px #667eea, 0 0 0 3px rgba(102, 126, 234, 0.1);
            z-index: 3;
        }

        .element h1, .element h2, .element h3 {
            margin-bottom: 10px;
            pointer-events: auto;
        }

        .element p {
            line-height: 1.6;
            color: #4a5568;
            pointer-events: auto;
        }

        /* Make camera buttons always visible, not just on hover */
        .image-edit-overlay {
            opacity: 1 !important;
            z-index: 9999 !important;
            pointer-events: auto;
        }

        .image-edit-overlay button {
            z-index: 10000 !important;
            pointer-events: auto;
            position: relative;
        }

        .element img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            pointer-events: auto;
        }

        .element * {
            pointer-events: auto;
        }

        /* Touch-to-edit styles */
        .editable {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .editable:hover {
            outline: 1px dashed #667eea;
            outline-offset: 4px;
        }

        .editable.editing {
            outline: 2px solid #667eea;
            outline-offset: 4px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .edit-toolbar {
            position: absolute;
            top: -40px;
            left: 0;
            background: #2d3748;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .editing .edit-toolbar {
            display: block;
        }

        /* Drop Zone */
        .drop-zone {
            min-height: 200px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        /* Element Selection and Delete Button */
        .element-selected {
            outline: 2px solid #667eea !important;
            outline-offset: 2px;
            position: relative;
        }

        .delete-button {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .delete-button:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        .delete-button:active {
            transform: scale(0.95);
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #f7faff;
            z-index: 2;
        }

        .drop-message {
            text-align: center;
            color: #718096;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .builder-sidebar {
                width: 250px;
            }
            
            .builder-properties {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .builder-container {
                flex-direction: column;
            }
            
            .builder-sidebar,
            .builder-properties {
                width: 100%;
                height: 200px;
                margin-top: 0;
            }
            
            .builder-canvas {
                margin-top: 0;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <!-- Full Screen Canvas -->
        <div class="builder-canvas">
            <div class="canvas-container">
                <div class="canvas-viewport" id="canvas">
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-message">
                            <h3>Start Building Your Photography Website</h3>
                            <p>Drag components from the bottom toolbar or choose a template to get started</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Tools Bar -->
        <div class="builder-tools">
            <div class="tools-header">
                <div class="tools-tabs">
                    <button class="tool-tab active" data-tab="add">Add</button>
                    <button class="tool-tab" data-tab="style">Style</button>
                    <button class="tool-tab" data-tab="layout">Layout</button>
                    <button class="tool-tab" data-tab="properties">Properties</button>
                    <button class="tool-tab" data-tab="pages">Pages</button>
                </div>
            </div>
            <div class="tools-content">
                <!-- Add Tab Content -->
                <div class="tab-panel active" data-panel="add">
                    <div class="tools-scroll">

                    <div class="tool-section">
                        <div class="tool-title">Page Management</div>
                        <div class="component-list">
                            <div class="component-item" onclick="addNewPage()" style="cursor: pointer; border: 2px dashed #667eea; background: #f7faff;">
                                <div class="component-icon">➕</div>
                                <span class="component-text">Add Page</span>
                            </div>
                            <div class="component-item" onclick="addSubPage()" style="cursor: pointer; border: 2px dashed #805ad5; background: #faf5ff;">
                                <div class="component-icon">📁</div>
                                <span class="component-text">Add SubPage</span>
                            </div>
                        </div>
                    </div>

                    <div class="tool-section">
                        <div class="tool-title">Components</div>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="nav" onclick="addComponent('nav')" style="cursor: pointer;">
                                <div class="component-icon">☰</div>
                                <span class="component-text">Nav Menu</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="hero-carousel" onclick="addComponent('hero-carousel')" style="cursor: pointer;">
                                <div class="component-icon">🎞️</div>
                                <span class="component-text">Image Carousel</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="hero-text" onclick="addComponent('hero-text')" style="cursor: pointer;">
                                <div class="component-icon">✨</div>
                                <span class="component-text">Hero Text</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="featured-gallery" onclick="addComponent('featured-gallery')" style="cursor: pointer;">
                                <div class="component-icon">⭐</div>
                                <span class="component-text">Featured</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="gallery-grid" onclick="addComponent('gallery-grid')" style="cursor: pointer;">
                                <div class="component-icon">⚏</div>
                                <span class="component-text">Gallery Grid</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="gallery-categories" onclick="addComponent('gallery-categories')" style="cursor: pointer;">
                                <div class="component-icon">📁</div>
                                <span class="component-text">Categories</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="masonry" onclick="addComponent('masonry')" style="cursor: pointer;">
                                <div class="component-icon">🧱</div>
                                <span class="component-text">Masonry</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="masonry-simple" onclick="addComponent('masonry-simple')" style="cursor: pointer;">
                                <div class="component-icon">⬜</div>
                                <span class="component-text">Simple Grid</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="featured-single" onclick="addComponent('featured-single')" style="cursor: pointer;">
                                <div class="component-icon">🖼️</div>
                                <span class="component-text">Single Photo</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="gallery" onclick="addComponent('gallery')" style="cursor: pointer;">
                                <div class="component-icon">📷</div>
                                <span class="component-text">Basic Gallery</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="about" onclick="addComponent('about')" style="cursor: pointer;">
                                <div class="component-icon">👤</div>
                                <span class="component-text">About</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="services" onclick="addComponent('services')" style="cursor: pointer;">
                                <div class="component-icon">⚡</div>
                                <span class="component-text">Services</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="workshops" onclick="addComponent('workshops')" style="cursor: pointer;">
                                <div class="component-icon">🎓</div>
                                <span class="component-text">Workshops</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="testimonials" onclick="addComponent('testimonials')" style="cursor: pointer;">
                                <div class="component-icon">💬</div>
                                <span class="component-text">Reviews</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="button" onclick="addComponent('button')" style="cursor: pointer;">
                                <div class="component-icon">🔘</div>
                                <span class="component-text">Button</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="contact" onclick="addComponent('contact')" style="cursor: pointer;">
                                <div class="component-icon">📧</div>
                                <span class="component-text">Contact</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="footer" onclick="addComponent('footer')" style="cursor: pointer;">
                                <div class="component-icon">⬇️</div>
                                <span class="component-text">Footer</span>
                            </div>
                        </div>
                    </div>

                    <!-- Media Section -->
                    <div class="tool-section">
                        <div class="tool-title">Media</div>
                        <div class="property-controls">
                            <button class="btn btn-secondary" onclick="document.getElementById('image-upload').click();" style="padding: 8px 16px; font-size: 12px;">
                                Upload Images
                            </button>
                            <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('video-upload').click();" style="padding: 8px 16px; font-size: 12px;">
                                Upload Videos
                            </button>
                            <input type="file" id="video-upload" accept="video/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Style Tab Content -->
            <div class="tab-panel" data-panel="style">
                <div class="tools-scroll">
                    <!-- Selection Status -->
                    <div class="tool-section">
                        <div class="tool-title">Selected Component</div>
                        <div id="selected-component-status" style="padding: 10px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; color: #4a5568; text-align: center;">
                            No component selected. Click on a component to style it.
                        </div>
                    </div>
                    
                    <!-- Theme Colors Section -->
                    <div class="tool-section">
                        <div class="tool-title">Theme Colors</div>
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Background</label>
                                <input type="color" id="bg-color" class="property-input" value="#ffffff" style="width: 60px; height: 30px; padding: 2px;" onchange="applyThemeColor('background', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Text</label>
                                <input type="color" id="text-color" class="property-input" value="#2d3748" style="width: 60px; height: 30px; padding: 2px;" onchange="applyThemeColor('text', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Accent</label>
                                <input type="color" id="accent-color" class="property-input" value="#667eea" style="width: 60px; height: 30px; padding: 2px;" onchange="applyThemeColor('accent', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Effects Section -->
                    <div class="tool-section">
                        <div class="tool-title">Effects</div>
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Overlay</label>
                                <input type="range" id="overlay-effect" class="property-input" min="0" max="100" value="40" style="width: 80px;" oninput="applyEffect('overlay', this.value)">
                                <span id="overlay-value" style="font-size: 10px; color: #666;">40%</span>
                            </div>
                            <div>
                                <label class="property-label">Blur</label>
                                <input type="range" id="blur-effect" class="property-input" min="0" max="20" value="0" style="width: 80px;" oninput="applyEffect('blur', this.value)">
                                <span id="blur-value" style="font-size: 10px; color: #666;">0px</span>
                            </div>
                            <div>
                                <label class="property-label">Shadow</label>
                                <input type="range" id="shadow-effect" class="property-input" min="0" max="50" value="10" style="width: 80px;" oninput="applyEffect('shadow', this.value)">
                                <span id="shadow-value" style="font-size: 10px; color: #666;">10px</span>
                            </div>
                            <div>
                                <label class="property-label">Animation</label>
                                <select id="animation-effect" class="property-input" style="width: 80px;" onchange="applyEffect('animation', this.value)">
                                    <option value="none">None</option>
                                    <option value="fade">Fade In</option>
                                    <option value="slide">Slide</option>
                                    <option value="zoom">Zoom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Layout Tab Content -->
            <div class="tab-panel" data-panel="layout">
                <div class="tools-scroll">
                    <!-- Layout Section -->
                    <div class="tool-section">
                        <div class="tool-title">Spacing</div>
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Padding</label>
                                <input type="range" id="padding-control" class="property-input" min="0" max="100" value="20" style="width: 80px;" oninput="applyLayoutProperty('padding', this.value)">
                                <span id="padding-value" style="font-size: 10px; color: #666;">20px</span>
                            </div>
                            <div>
                                <label class="property-label">Margin</label>
                                <input type="range" id="margin-control" class="property-input" min="0" max="100" value="0" style="width: 80px;" oninput="applyLayoutProperty('margin', this.value)">
                                <span id="margin-value" style="font-size: 10px; color: #666;">0px</span>
                            </div>
                            <div>
                                <label class="property-label">Gap</label>
                                <input type="range" id="gap-control" class="property-input" min="0" max="50" value="20" style="width: 80px;" oninput="applyLayoutProperty('gap', this.value)">
                                <span id="gap-value" style="font-size: 10px; color: #666;">20px</span>
                            </div>
                        </div>
                    </div>

                    <!-- Alignment Section -->
                    <div class="tool-section">
                        <div class="tool-title">Alignment</div>
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Horizontal</label>
                                <select id="horizontal-align" class="property-input" style="width: 80px;" onchange="applyLayoutProperty('horizontal', this.value)">
                                    <option value="left">Left</option>
                                    <option value="center">Center</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                            <div>
                                <label class="property-label">Vertical</label>
                                <select id="vertical-align" class="property-input" style="width: 80px;" onchange="applyLayoutProperty('vertical', this.value)">
                                    <option value="top">Top</option>
                                    <option value="middle">Middle</option>
                                    <option value="bottom">Bottom</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Size Section -->
                    <div class="tool-section">
                        <div class="tool-title">Size</div>
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Width</label>
                                <input type="range" id="width-control" class="property-input" min="10" max="100" value="100" style="width: 80px;" oninput="applyLayoutProperty('width', this.value)">
                                <span id="width-value" style="font-size: 10px; color: #666;">100%</span>
                            </div>
                            <div>
                                <label class="property-label">Height</label>
                                <input type="range" id="height-control" class="property-input" min="50" max="1000" value="200" style="width: 80px;" oninput="applyLayoutProperty('height', this.value)">
                                <span id="height-value" style="font-size: 10px; color: #666;">200px</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Tab Content -->
            <div class="tab-panel" data-panel="properties">
                <div class="tools-scroll">
                    <div id="properties-content">
                        <div class="tool-section">
                            <div class="tool-title">Element Properties</div>
                            <p style="color: #718096; font-size: 14px; text-align: center; padding: 20px;">Select an element to edit its properties</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pages Tab Content -->
            <div class="tab-panel" data-panel="pages">
                <div class="tools-scroll">
                    <!-- Pages Management Section -->
                    <div class="tool-section">
                        <div class="tool-title">Navigation Style</div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="radio" name="navStyle" value="horizontal" checked onchange="setNavStyle('horizontal')">
                                <span>Horizontal Menu</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="navStyle" value="dropdown" onchange="setNavStyle('dropdown')">
                                <span>Dropdown Menu</span>
                            </label>
                        </div>
                    </div>

                    <div class="tool-section">
                        <div class="tool-title">Page Management</div>
                        <div id="pages-list" style="margin-bottom: 15px;">
                            <!-- Sortable pages list -->
                            <div class="page-item active" data-page="home" draggable="true" onclick="switchToPageNew('home')" style="display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 4px; cursor: grab;">
                                <span style="color: #718096; margin-right: 8px;">☰</span>
                                <span class="page-name" style="flex: 1;">Home</span>
                                <button onclick="event.stopPropagation(); renamePageNew('home')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                            </div>
                            <div class="page-item" data-page="portfolio" draggable="true" onclick="switchToPageNew('portfolio')" style="display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 4px; cursor: grab;">
                                <span style="color: #718096; margin-right: 8px;">☰</span>
                                <span class="page-name" style="flex: 1;">Portfolio</span>
                                <button onclick="event.stopPropagation(); renamePageNew('portfolio')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                            </div>
                            <div class="page-item" data-page="about" draggable="true" onclick="switchToPageNew('about')" style="display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 4px; cursor: grab;">
                                <span style="color: #718096; margin-right: 8px;">☰</span>
                                <span class="page-name" style="flex: 1;">About</span>
                                <button onclick="event.stopPropagation(); renamePageNew('about')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                            </div>
                            <div class="page-item" data-page="contact" draggable="true" onclick="switchToPageNew('contact')" style="display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 4px; cursor: grab;">
                                <span style="color: #718096; margin-right: 8px;">☰</span>
                                <span class="page-name" style="flex: 1;">Contact</span>
                                <button onclick="event.stopPropagation(); renamePageNew('contact')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                            </div>
                        </div>
                        <button onclick="addNewPageFromPages()" style="width: 100%; padding: 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 5px;">+ Add New Page</button>
                        <button onclick="addSubPage()" style="width: 100%; padding: 8px; background: #805ad5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Add SubPage</button>
                    </div>
                    
                    <!-- Templates Section -->
                    <div class="tool-section">
                        <div class="tool-title">Templates</div>
                        <div class="template-list">
                            <div class="template-card active" onclick="selectTemplate('modern')">
                                <div class="template-name">Modern</div>
                            </div>
                            <div class="template-card" onclick="selectTemplate('classic')">
                                <div class="template-name">Classic</div>
                            </div>
                            <div class="template-card" onclick="selectTemplate('minimal')">
                                <div class="template-name">Minimal</div>
                            </div>
                            <div class="template-card" onclick="selectTemplate('bold')">
                                <div class="template-name">Bold</div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div class="tool-section">
                        <div class="tool-title">Settings</div>
                        <div class="property-controls">
                            <button class="btn btn-primary" onclick="saveWebsite()" style="padding: 8px 16px; font-size: 12px;">Save</button>
                            <button class="btn btn-secondary" onclick="previewWebsite()" style="padding: 8px 16px; font-size: 12px;">Preview</button>
                            <button class="btn btn-primary" onclick="publishWebsite()" style="padding: 8px 16px; font-size: 12px;">Publish</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Text Toolbar -->
    <div id="text-toolbar" style="display: none; position: fixed; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 8px; z-index: 10000; border: 1px solid #e2e8f0;">
        <div style="display: flex; gap: 8px; align-items: center;">
            <!-- Text Format Buttons -->
            <div style="display: flex; gap: 4px; border-right: 1px solid #e2e8f0; padding-right: 8px;">
                <button class="toolbar-btn" data-action="bold" title="Bold" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px; font-weight: bold;">B</button>
                <button class="toolbar-btn" data-action="italic" title="Italic" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px; font-style: italic;">I</button>
                <button class="toolbar-btn" data-action="underline" title="Underline" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px; text-decoration: underline;">U</button>
            </div>
            
            <!-- Text Alignment -->
            <div style="display: flex; gap: 4px; border-right: 1px solid #e2e8f0; padding-right: 8px;">
                <button class="toolbar-btn" data-action="align-left" title="Align Left" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px;">☰</button>
                <button class="toolbar-btn" data-action="align-center" title="Center" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px;">≡</button>
                <button class="toolbar-btn" data-action="align-right" title="Align Right" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px;">≣</button>
            </div>
            
            <!-- Font Family -->
            <select id="toolbar-font-family" style="height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 0 8px; background: white; cursor: pointer;">
                <option value="'Playfair Display', serif">Playfair</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Raleway', sans-serif">Raleway</option>
                <option value="'Cormorant Garamond', serif">Cormorant</option>
                <option value="'Josefin Sans', sans-serif">Josefin</option>
                <option value="'Lato', sans-serif">Lato</option>
            </select>
            
            <!-- Font Size -->
            <div style="display: flex; align-items: center; gap: 4px; border-left: 1px solid #e2e8f0; padding-left: 8px;">
                <button class="toolbar-btn" data-action="size-decrease" style="width: 24px; height: 24px; border: none; background: white; cursor: pointer; border-radius: 4px;">-</button>
                <input type="number" id="toolbar-font-size" value="16" min="8" max="120" style="width: 40px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; text-align: center;">
                <button class="toolbar-btn" data-action="size-increase" style="width: 24px; height: 24px; border: none; background: white; cursor: pointer; border-radius: 4px;">+</button>
            </div>
            
            <!-- Text Color -->
            <div style="display: flex; align-items: center; gap: 4px; border-left: 1px solid #e2e8f0; padding-left: 8px;">
                <label style="font-size: 12px;">Color:</label>
                <input type="color" id="toolbar-text-color" value="#000000" style="width: 32px; height: 32px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer;">
            </div>
            
            <!-- Letter Spacing -->
            <div style="display: flex; align-items: center; gap: 4px; border-left: 1px solid #e2e8f0; padding-left: 8px;">
                <label style="font-size: 12px;">Spacing:</label>
                <input type="range" id="toolbar-letter-spacing" min="-2" max="10" value="0" style="width: 60px;">
            </div>
            
            <!-- Convert to Button Link -->
            <div style="display: flex; align-items: center; gap: 4px; border-left: 1px solid #e2e8f0; padding-left: 8px;">
                <button class="toolbar-btn" data-action="convert-to-link" title="Convert to Page Link" style="width: 32px; height: 32px; border: none; background: white; cursor: pointer; border-radius: 4px; font-size: 16px;">🔗</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let selectedElement = null;
        let selectedComponent = null; // Currently selected component block
        let currentTemplate = 'modern';
        let currentPage = 'home';
        let navStyle = 'horizontal'; // 'horizontal' or 'dropdown'
        let navOrder = ['home', 'portfolio', 'about', 'contact']; // Navigation order
        let subPages = {}; // Store subpages: { parentId: [subpage1, subpage2, ...] }
        let pages = {
            home: { name: 'Home', template: 'modern', elements: [] },
            portfolio: { name: 'Portfolio', template: 'modern', elements: [
                {
                    type: 'header',
                    content: {
                        title: 'Portfolio',
                        subtitle: 'Explore my latest photography work'
                    }
                },
                {
                    type: 'featured-gallery',
                    content: {
                        title: 'Featured Work',
                        image: 'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=1200'
                    }
                },
                {
                    type: 'gallery-grid',
                    content: {
                        title: 'Recent Projects',
                        galleries: [
                            {name: 'Wedding Collection', category: 'Wedding Photography', image: 'https://images.unsplash.com/photo-1519741497674-611481863552?w=600'},
                            {name: 'Portrait Sessions', category: 'Portrait Photography', image: 'https://images.unsplash.com/photo-1494790108755-2616c43f40cc?w=600'},
                            {name: 'Nature & Landscape', category: 'Landscape Photography', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600'},
                            {name: 'Event Photography', category: 'Event Photography', image: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=600'},
                            {name: 'Family Sessions', category: 'Family Photography', image: 'https://images.unsplash.com/photo-1581833971358-2c8b550f87b3?w=600'},
                            {name: 'Corporate Headshots', category: 'Business Photography', image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=600'}
                        ]
                    }
                },
                {
                    type: 'masonry',
                    content: {
                        images: [
                            'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=400',
                            'https://images.unsplash.com/photo-1518098268026-4e89f1a2cd8e?w=400&h=600',
                            'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=400',
                            'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=500',
                            'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400',
                            'https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?w=400&h=600',
                            'https://images.unsplash.com/photo-1519741497674-611481863552?w=400',
                            'https://images.unsplash.com/photo-1494790108755-2616c43f40cc?w=400&h=500'
                        ]
                    }
                }
            ] },
            about: { name: 'About', template: 'modern', elements: [
                {
                    type: 'header',
                    content: {
                        title: 'About Me',
                        subtitle: 'Passionate photographer capturing life\'s precious moments'
                    }
                },
                {
                    type: 'about',
                    content: {
                        name: 'Professional Photographer',
                        bio: 'With over 10 years of experience in photography, I specialize in capturing authentic moments that tell your unique story. From intimate weddings to corporate events, I bring creativity and technical expertise to every shoot.',
                        image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400',
                        services: ['Wedding Photography', 'Portrait Sessions', 'Event Photography', 'Corporate Headshots']
                    }
                },
                {
                    type: 'services',
                    content: {
                        title: 'Photography Services',
                        services: [
                            {
                                icon: '💒',
                                name: 'Wedding Photography',
                                price: 'Starting at $2,500',
                                description: 'Comprehensive wedding coverage from getting ready to reception, capturing every precious moment of your special day.'
                            },
                            {
                                icon: '👨‍👩‍👧‍👦',
                                name: 'Family Portraits',
                                price: 'Starting at $350',
                                description: 'Beautiful family portraits that capture the love and connection between family members in natural settings.'
                            },
                            {
                                icon: '💼',
                                name: 'Corporate Headshots',
                                price: 'Starting at $200',
                                description: 'Professional headshots that help you make a great first impression in your business endeavors.'
                            }
                        ]
                    }
                }
            ] },
            contact: { name: 'Contact', template: 'modern', elements: [
                {
                    type: 'header',
                    content: {
                        title: 'Get In Touch',
                        subtitle: 'Ready to capture your special moments? Let\'s discuss your photography needs'
                    }
                },
                {
                    type: 'contact',
                    content: {
                        title: 'Contact Information',
                        email: 'hello@photographer.com',
                        phone: '(555) 123-4567',
                        address: '123 Photography Lane, Creative City, CC 12345'
                    }
                }
            ] }
        };
        let websiteData = {
            template: 'modern',
            elements: []
        };

        // Tab switching functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tool-tab');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update active states for buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update active states for panels
                    tabPanels.forEach(panel => {
                        if (panel.dataset.panel === targetTab) {
                            panel.classList.add('active');
                        } else {
                            panel.classList.remove('active');
                        }
                    });
                });
            });
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const components = document.querySelectorAll('.component-item');
            const dropZone = document.querySelector('.drop-zone');
            
            components.forEach(comp => {
                comp.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('component', comp.dataset.component);
                });
            });
            
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const componentType = e.dataTransfer.getData('component');
                    addComponent(componentType);
                });
            }
        }

        // Save website function
        function saveWebsite() {
            console.log('Saving website...', websiteData);
            alert('Website saved successfully!');
        }

        // Touch-to-edit functionality
        function initializeTouchToEdit() {
            // Make all text elements editable with comprehensive toolbar support
            initializeTextEditingWithToolbar();
            // Make images clickable for replacement
            makeImagesEditable();
            // Make blocks draggable
            makeBlocksDraggable();
            // Make components selectable
            makeComponentsSelectable();
        }

        function makeTextEditable() {
            // Select all headings, paragraphs, and buttons
            const textElements = document.querySelectorAll('#canvas h1, #canvas h2, #canvas h3, #canvas p, #canvas button');
            
            textElements.forEach(element => {
                // Skip if already made editable
                if (element.classList.contains('editable')) return;
                
                // Add editable class
                element.classList.add('editable');
                element.setAttribute('contenteditable', 'false');
                
                // Click to edit
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Handle buttons differently
                    if (element.tagName === 'BUTTON') {
                        startEditingButton(this);
                    } else {
                        startEditingText(this);
                    }
                });
            });
        }

        function startEditingText(element) {
            // Remove any other editing elements
            document.querySelectorAll('.editing').forEach(el => {
                el.classList.remove('editing');
                el.setAttribute('contenteditable', 'false');
            });
            
            // Make this element editable
            element.classList.add('editing');
            element.setAttribute('contenteditable', 'true');
            element.focus();
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Add toolbar
            addEditToolbar(element);
            
            // Save on blur
            element.addEventListener('blur', function saveEdit() {
                element.classList.remove('editing');
                element.setAttribute('contenteditable', 'false');
                removeEditToolbar(element);
                element.removeEventListener('blur', saveEdit);
                console.log('Text saved:', element.textContent);
            });
            
            // Save on Enter key
            element.addEventListener('keydown', function handleEnter(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    element.blur();
                    element.removeEventListener('keydown', handleEnter);
                }
            });
        }
        
        function startEditingButton(button) {
            // Create a mini editor for buttons
            const originalText = button.textContent;
            const currentLink = button.getAttribute('data-page-link') || button.getAttribute('onclick') || '';
            const buttonRect = button.getBoundingClientRect();
            
            // Create overlay editor
            const editor = document.createElement('div');
            editor.style.cssText = `
                position: fixed;
                top: ${buttonRect.top - 80}px;
                left: ${buttonRect.left}px;
                background: white;
                border: 2px solid #667eea;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                min-width: 250px;
            `;
            
            // Get current page link if set
            let selectedPage = '';
            if (currentLink.includes('switchToPageNew')) {
                const match = currentLink.match(/switchToPageNew\('([^']+)'\)/);
                if (match) selectedPage = match[1];
            }
            
            editor.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Button Text</label>
                    <input type="text" id="button-text-input" value="${originalText}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Link to Page</label>
                    <select id="button-page-select" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">No Link</option>
                        <option value="home" ${selectedPage === 'home' ? 'selected' : ''}>Home</option>
                        <option value="portfolio" ${selectedPage === 'portfolio' ? 'selected' : ''}>Portfolio</option>
                        <option value="about" ${selectedPage === 'about' ? 'selected' : ''}>About</option>
                        <option value="contact" ${selectedPage === 'contact' ? 'selected' : ''}>Contact</option>
                    </select>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Custom URL (optional)</label>
                    <input type="text" id="button-url-input" placeholder="https://example.com" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button id="save-button" style="background: #667eea; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button id="cancel-button" style="background: #e2e8f0; color: #4a5568; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            document.body.appendChild(editor);
            
            // Focus the input
            const input = editor.querySelector('#button-text-input');
            const pageSelect = editor.querySelector('#button-page-select');
            const urlInput = editor.querySelector('#button-url-input');
            
            input.focus();
            input.select();
            
            // Handle page select change
            pageSelect.addEventListener('change', () => {
                if (pageSelect.value) {
                    urlInput.value = '';
                    urlInput.disabled = true;
                } else {
                    urlInput.disabled = false;
                }
            });
            
            // Save button
            editor.querySelector('#save-button').addEventListener('click', () => {
                saveButtonChanges();
            });
            
            // Cancel button
            editor.querySelector('#cancel-button').addEventListener('click', () => {
                document.body.removeChild(editor);
            });
            
            // Save on Enter
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveButtonChanges();
                } else if (e.key === 'Escape') {
                    document.body.removeChild(editor);
                }
            });
            
            function saveButtonChanges() {
                // Update button text
                button.textContent = input.value;
                
                // Remove any existing click handlers
                button.removeAttribute('onclick');
                button.removeAttribute('data-page-link');
                
                // Set up the link
                if (pageSelect.value) {
                    // Link to page
                    button.setAttribute('data-page-link', pageSelect.value);
                    button.onclick = () => {
                        console.log(`Button clicked - navigating to page: ${pageSelect.value}`);
                        switchToPageNew(pageSelect.value);
                    };
                    button.style.cursor = 'pointer';
                    console.log(`Button linked to page: ${pageSelect.value}`);
                } else if (urlInput.value.trim()) {
                    // Link to external URL
                    button.onclick = () => {
                        console.log(`Button clicked - opening URL: ${urlInput.value}`);
                        window.open(urlInput.value, '_blank');
                    };
                    button.style.cursor = 'pointer';
                    console.log(`Button linked to URL: ${urlInput.value}`);
                } else {
                    // No link
                    button.onclick = null;
                    button.style.cursor = 'default';
                    console.log('Button link removed');
                }
                
                console.log('Button updated:', input.value);
                try {
                    if (editor.parentNode) {
                        document.body.removeChild(editor);
                    }
                } catch (error) {
                    console.log('Editor already removed');
                }
            }
            
            // Click outside to close
            setTimeout(() => {
                document.addEventListener('click', function closeEditor(e) {
                    if (!editor.contains(e.target) && e.target !== button) {
                        try {
                            if (editor.parentNode) {
                                document.body.removeChild(editor);
                            }
                        } catch (error) {
                            console.log('Editor already removed');
                        }
                        document.removeEventListener('click', closeEditor);
                    }
                });
            }, 100);
        }

        function addEditToolbar(element) {
            const toolbar = document.createElement('div');
            toolbar.className = 'edit-toolbar';
            toolbar.textContent = 'Click outside to save';
            element.appendChild(toolbar);
        }

        function removeEditToolbar(element) {
            const toolbar = element.querySelector('.edit-toolbar');
            if (toolbar) {
                toolbar.remove();
            }
        }

        function makeImagesEditable() {
            // Select all images in the canvas
            const images = document.querySelectorAll('#canvas img');
            
            images.forEach(img => {
                // Skip if already made editable
                if (img.classList.contains('editable')) return;
                
                // Add editable class
                img.classList.add('editable');
                img.style.cursor = 'grab'; // Images are for repositioning, not uploading
                
                // Image click disabled - only camera buttons trigger uploads
                // Images are for repositioning via drag only
            });
            
            // Also handle background images (like in hero sections)
            const elementsWithBackgrounds = document.querySelectorAll('#canvas .element[data-type="hero"] > div, #canvas .element[data-type="hero-minimal"] > div > div');
            
            elementsWithBackgrounds.forEach(element => {
                // Skip if already made editable
                if (element.hasAttribute('data-bg-editable')) return;
                
                const bgStyle = window.getComputedStyle(element).backgroundImage;
                if (bgStyle && bgStyle !== 'none') {
                    element.setAttribute('data-bg-editable', 'true');
                    // Add overlay indicator on hover
                    element.style.position = 'relative';
                    element.style.cursor = 'pointer';
                    
                    // Create overlay for hover effect
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.3);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        z-index: 1;
                        pointer-events: none;
                    `;
                    overlay.innerHTML = '<span style="background: white; color: black; padding: 10px 20px; border-radius: 4px;">Click to change background image</span>';
                    element.appendChild(overlay);
                    
                    // Show overlay on hover
                    element.addEventListener('mouseenter', () => {
                        overlay.style.display = 'flex';
                    });
                    
                    element.addEventListener('mouseleave', () => {
                        overlay.style.display = 'none';
                    });
                    
                    // Background click disabled - only camera buttons trigger uploads
                }
            });
        }

        function startEditingImage(img) {
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        img.src = event.target.result;
                        console.log('Image replaced:', file.name);
                        
                        // Flash effect to show image was updated
                        img.style.transition = 'opacity 0.3s';
                        img.style.opacity = '0.5';
                        setTimeout(() => {
                            img.style.opacity = '1';
                        }, 300);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Trigger file selection
            fileInput.click();
        }
        
        function startEditingBackgroundImage(element) {
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // Parse existing background to keep gradient overlay if present
                        const currentBg = window.getComputedStyle(element).backgroundImage;
                        const hasGradient = currentBg.includes('linear-gradient');
                        
                        if (hasGradient) {
                            // Keep the gradient overlay, just replace the image URL
                            element.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${event.target.result}')`;
                        } else {
                            element.style.backgroundImage = `url('${event.target.result}')`;
                        }
                        
                        console.log('Background image replaced:', file.name);
                        
                        // Flash effect to show image was updated
                        element.style.transition = 'opacity 0.3s';
                        element.style.opacity = '0.7';
                        setTimeout(() => {
                            element.style.opacity = '1';
                        }, 300);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Trigger file selection
            fileInput.click();
        }

        function makeBlocksDraggable() {
            const elements = document.querySelectorAll('#canvas .element');
            
            elements.forEach(element => {
                // Skip if already has drag handle
                if (element.querySelector('.drag-handle')) return;
                
                // Add drag handle
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle';
                dragHandle.innerHTML = '⋮⋮';
                dragHandle.style.cssText = `
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    background: #2d3748;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    cursor: move;
                    font-size: 14px;
                    opacity: 0;
                    transition: opacity 0.2s;
                    z-index: 10;
                `;
                
                element.style.position = 'relative';
                element.appendChild(dragHandle);
                
                // Show handle on hover
                element.addEventListener('mouseenter', () => {
                    dragHandle.style.opacity = '0.8';
                });
                
                element.addEventListener('mouseleave', () => {
                    dragHandle.style.opacity = '0';
                });
                
                // Make draggable
                let isDragging = false;
                let currentY;
                let initialY;
                let yOffset = 0;
                
                dragHandle.addEventListener('mousedown', dragStart);
                
                function dragStart(e) {
                    initialY = e.clientY - yOffset;
                    isDragging = true;
                    
                    element.style.cursor = 'grabbing';
                    element.style.opacity = '0.8';
                    element.style.transition = 'none';
                    element.style.zIndex = '1000';
                    
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('mouseup', dragEnd);
                }
                
                function drag(e) {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    currentY = e.clientY - initialY;
                    yOffset = currentY;
                    
                    element.style.transform = `translateY(${currentY}px)`;
                    
                    // Check for swap positions
                    checkSwapPosition(element, e.clientY);
                }
                
                function dragEnd(e) {
                    isDragging = false;
                    
                    element.style.cursor = '';
                    element.style.opacity = '';
                    element.style.transition = '';
                    element.style.zIndex = '';
                    element.style.transform = '';
                    
                    yOffset = 0;
                    
                    document.removeEventListener('mousemove', drag);
                    document.removeEventListener('mouseup', dragEnd);
                }
            });
        }
        
        function checkSwapPosition(draggedElement, mouseY) {
            const elements = Array.from(document.querySelectorAll('#canvas .element'));
            const draggedIndex = elements.indexOf(draggedElement);
            
            for (let i = 0; i < elements.length; i++) {
                if (i === draggedIndex) continue;
                
                const element = elements[i];
                const rect = element.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                
                if (mouseY > rect.top && mouseY < midpoint) {
                    // Insert before
                    element.parentNode.insertBefore(draggedElement, element);
                    break;
                } else if (mouseY > midpoint && mouseY < rect.bottom) {
                    // Insert after
                    element.parentNode.insertBefore(draggedElement, element.nextSibling);
                    break;
                }
            }
        }

        // Component Selection System
        function makeComponentsSelectable() {
            const elements = document.querySelectorAll('#canvas .element');
            
            elements.forEach(element => {
                // Skip if already has selection handler
                if (element.dataset.selectable === 'true') return;
                
                element.dataset.selectable = 'true';
                
                // Add click handler for selection
                element.addEventListener('click', function(e) {
                    // Don't interfere with text editing or button editing
                    if (e.target.classList.contains('editable') || e.target.tagName === 'BUTTON') {
                        return;
                    }
                    
                    e.stopPropagation();
                    selectComponent(this);
                });
            });
        }

        function selectComponent(component) {
            // Deselect previously selected component
            if (selectedComponent) {
                selectedComponent.classList.remove('selected');
                removeDeleteButton(selectedComponent);
            }
            
            // Select new component
            selectedComponent = component;
            component.classList.add('selected');
            addDeleteButton(component);
            
            // Update status indicator
            updateSelectionStatus(component);
            
            console.log('Component selected:', component.dataset.type || 'unknown');
        }

        function deselectComponent() {
            if (selectedComponent) {
                selectedComponent.classList.remove('selected');
                removeDeleteButton(selectedComponent);
                selectedComponent = null;
                
                // Update status indicator
                updateSelectionStatus(null);
                
                console.log('Component deselected');
            }
        }

        function addDeleteButton(component) {
            // Remove any existing delete button
            removeDeleteButton(component);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-button';
            deleteBtn.innerHTML = '×';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                deleteComponent(component);
            };
            
            component.appendChild(deleteBtn);
        }

        function removeDeleteButton(component) {
            const deleteBtn = component.querySelector('.delete-button');
            if (deleteBtn) {
                deleteBtn.remove();
            }
        }

        function deleteComponent(component) {
            if (confirm('Delete this component?')) {
                component.remove();
                selectedComponent = null;
                console.log('Component deleted');
            }
        }

        // Click outside to deselect
        function setupGlobalClickHandler() {
            document.addEventListener('click', function(e) {
                // Check if click is outside canvas or on canvas background
                const canvas = document.getElementById('canvas');
                const clickedInsideElement = e.target.closest('.element');
                
                if (!clickedInsideElement && canvas.contains(e.target)) {
                    deselectComponent();
                }
            });
        }

        // Style Application Functions for Selected Component
        function applyThemeColor(type, value) {
            if (!selectedComponent) {
                alert('Please select a component first');
                return;
            }
            
            switch(type) {
                case 'background':
                    selectedComponent.style.backgroundColor = value;
                    break;
                case 'text':
                    // Apply to all text elements within the SELECTED component only
                    const textElements = selectedComponent.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div:not(.builder-tools):not(.floating-toolbar):not(.edit-toolbar)');
                    textElements.forEach(el => {
                        // Skip if element is part of toolbars or outside the selected component
                        if (!selectedComponent.contains(el) || 
                            el.closest('.builder-tools') || 
                            el.closest('.floating-toolbar') ||
                            el.closest('.edit-toolbar') ||
                            el.closest('nav')) {
                            return;
                        }
                        el.style.color = value;
                    });
                    break;
                case 'accent':
                    // Apply to buttons and links within the SELECTED component only
                    const accentElements = selectedComponent.querySelectorAll('button, a, .accent-element');
                    accentElements.forEach(el => {
                        // Skip if element is part of toolbars or navigation
                        if (!selectedComponent.contains(el) || 
                            el.closest('.builder-tools') || 
                            el.closest('.floating-toolbar') ||
                            el.closest('.edit-toolbar') ||
                            el.closest('nav')) {
                            return;
                        }
                        el.style.backgroundColor = value;
                        el.style.borderColor = value;
                    });
                    break;
            }
            
            console.log(`Applied ${type} color ${value} to selected component only`);
        }

        function applyEffect(type, value) {
            if (!selectedComponent) {
                alert('Please select a component first');
                return;
            }
            
            switch(type) {
                case 'overlay':
                    // Create or update overlay
                    let overlay = selectedComponent.querySelector('.style-overlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'style-overlay';
                        overlay.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            pointer-events: none;
                            z-index: 1;
                        `;
                        selectedComponent.style.position = 'relative';
                        selectedComponent.appendChild(overlay);
                    }
                    overlay.style.backgroundColor = `rgba(0, 0, 0, ${value / 100})`;
                    document.getElementById('overlay-value').textContent = value + '%';
                    break;
                    
                case 'blur':
                    selectedComponent.style.filter = `blur(${value}px)`;
                    document.getElementById('blur-value').textContent = value + 'px';
                    break;
                    
                case 'shadow':
                    selectedComponent.style.boxShadow = `0 ${value}px ${value * 2}px rgba(0, 0, 0, 0.2)`;
                    document.getElementById('shadow-value').textContent = value + 'px';
                    break;
                    
                case 'animation':
                    selectedComponent.style.animation = value === 'none' ? '' : `${value} 0.6s ease-in-out`;
                    if (value !== 'none') {
                        addAnimationKeyframes(value);
                    }
                    break;
            }
            
            console.log(`Applied ${type} effect ${value} to selected component`);
        }

        function applyLayoutProperty(type, value) {
            if (!selectedComponent) {
                alert('Please select a component first');
                return;
            }
            
            switch(type) {
                case 'padding':
                    selectedComponent.style.padding = value + 'px';
                    document.getElementById('padding-value').textContent = value + 'px';
                    break;
                    
                case 'margin':
                    selectedComponent.style.margin = value + 'px';
                    document.getElementById('margin-value').textContent = value + 'px';
                    break;
                    
                case 'gap':
                    selectedComponent.style.gap = value + 'px';
                    document.getElementById('gap-value').textContent = value + 'px';
                    break;
                    
                case 'horizontal':
                    selectedComponent.style.textAlign = value;
                    if (value === 'center') {
                        selectedComponent.style.display = 'flex';
                        selectedComponent.style.justifyContent = 'center';
                    } else if (value === 'right') {
                        selectedComponent.style.display = 'flex';
                        selectedComponent.style.justifyContent = 'flex-end';
                    } else {
                        selectedComponent.style.display = 'flex';
                        selectedComponent.style.justifyContent = 'flex-start';
                    }
                    break;
                    
                case 'vertical':
                    selectedComponent.style.display = 'flex';
                    selectedComponent.style.flexDirection = 'column';
                    if (value === 'middle') {
                        selectedComponent.style.justifyContent = 'center';
                    } else if (value === 'bottom') {
                        selectedComponent.style.justifyContent = 'flex-end';
                    } else {
                        selectedComponent.style.justifyContent = 'flex-start';
                    }
                    break;
            }
            
            console.log(`Applied ${type} layout ${value} to selected component`);
        }

        function addAnimationKeyframes(animationType) {
            // Add CSS keyframes if they don't exist
            const styleId = 'animation-keyframes';
            let styleElement = document.getElementById(styleId);
            
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            
            const keyframes = {
                fade: `
                    @keyframes fade {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                `,
                slide: `
                    @keyframes slide {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `,
                zoom: `
                    @keyframes zoom {
                        from { transform: scale(0.8); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                `
            };
            
            if (keyframes[animationType] && !styleElement.textContent.includes(`@keyframes ${animationType}`)) {
                styleElement.textContent += keyframes[animationType];
            }
        }

        function updateSelectionStatus(component) {
            const statusElement = document.getElementById('selected-component-status');
            if (!statusElement) return;
            
            if (component) {
                const componentType = component.dataset.type || 
                                     component.className.split(' ').find(c => c.includes('-section'))?.replace('-section', '') || 
                                     'component';
                statusElement.innerHTML = `
                    <div style="color: #38a169; font-weight: 500;">
                        ✓ Selected: ${componentType.charAt(0).toUpperCase() + componentType.slice(1)}
                    </div>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">
                        Use the controls below to style this component
                    </div>
                `;
                statusElement.style.background = '#f0fff4';
                statusElement.style.borderColor = '#38a169';
            } else {
                statusElement.innerHTML = 'No component selected. Click on a component to style it.';
                statusElement.style.background = '#f7fafc';
                statusElement.style.borderColor = '#e2e8f0';
            }
        }

        // Templates
        const templates = {
            modern: {
                name: 'Modern Photography',
                elements: [
                    {
                        type: 'header',
                        content: {
                            title: 'Your Photography Studio',
                            navigation: ['Home', 'Portfolio', 'About', 'Contact']
                        }
                    },
                    {
                        type: 'hero',
                        content: {
                            title: 'Capturing Life\'s Beautiful Moments',
                            subtitle: 'Professional photography services for weddings, portraits, and special events',
                            backgroundImage: 'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=1200'
                        }
                    },
                    {
                        type: 'about',
                        content: {
                            title: 'About Me',
                            text: 'I\'m a passionate photographer dedicated to capturing the essence of every moment. With over 10 years of experience, I specialize in creating timeless images that tell your unique story.',
                            image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400'
                        }
                    },
                    {
                        type: 'gallery',
                        content: {
                            title: 'Portfolio',
                            images: [
                                'https://images.unsplash.com/photo-1519741497674-611481863552?w=400',
                                'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=400',
                                'https://images.unsplash.com/photo-1511285560929-80b456fea0bc?w=400',
                                'https://images.unsplash.com/photo-1520854221256-17451cc331bf?w=400'
                            ]
                        }
                    },
                    {
                        type: 'contact',
                        content: {
                            title: 'Get In Touch',
                            email: 'hello@photographer.com',
                            phone: '(555) 123-4567',
                            address: '123 Photography Lane, Studio City, CA 90210'
                        }
                    }
                ]
            }
        };

        // Component templates
        const componentTemplates = {
            nav: (data = {}) => `
                <div class="element" data-type="nav">
                    <nav style="display: flex; justify-content: center; align-items: center; padding: 20px 0; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; gap: 30px;">
                            ${navOrder.map(pageId => {
                                const hasSubPages = subPages[pageId] && subPages[pageId].length > 0;
                                const isActive = pageId === currentPage || (subPages[pageId] && subPages[pageId].includes(currentPage));
                                
                                if (hasSubPages) {
                                    return `
                                        <div style="position: relative;">
                                            <a href="javascript:void(0)" onclick="switchToPageNew('${pageId}')" 
                                               onmouseover="showSubMenu('${pageId}')" onmouseout="hideSubMenu('${pageId}')"
                                               style="text-decoration: none; color: ${isActive ? '#667eea' : '#2d3748'}; font-weight: ${isActive ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                                ${pages[pageId]?.name || pageId}
                                                <span style="font-size: 12px; color: #718096;">▼</span>
                                            </a>
                                            <div id="submenu-${pageId}" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; z-index: 1000; display: none;" 
                                                 onmouseover="keepSubMenuOpen('${pageId}')" onmouseout="hideSubMenu('${pageId}')">
                                                ${subPages[pageId].map(subPageId => 
                                                    `<a href="javascript:void(0)" onclick="switchToPageNew('${subPageId}')" 
                                                       style="display: block; padding: 10px 15px; text-decoration: none; color: ${subPageId === currentPage ? '#667eea' : '#2d3748'}; font-weight: ${subPageId === currentPage ? '600' : '400'}; transition: all 0.2s; border-bottom: 1px solid #f7fafc;"
                                                       onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                                                        ${pages[subPageId]?.name || subPageId}
                                                    </a>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `<a href="javascript:void(0)" onclick="switchToPageNew('${pageId}')" style="text-decoration: none; color: ${isActive ? '#667eea' : '#2d3748'}; font-weight: ${isActive ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">${pages[pageId]?.name || pageId}</a>`;
                                }
                            }).join('')}
                        </div>
                    </nav>
                </div>
            `,
            'hero-carousel': (data = {}) => {
                const images = data.images || [
                    'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80',
                    'https://images.unsplash.com/photo-1519741497674-611481863552?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80',
                    'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80'
                ];
                const carouselId = 'carousel-' + Date.now();
                return `
                <div class="element" data-type="hero-carousel" data-carousel-id="${carouselId}">
                    <div style="position: relative; height: 500px; overflow: hidden; border-radius: 8px; margin: 20px 0;" class="carousel-wrapper">
                        <div class="carousel-container" id="${carouselId}-container" style="display: flex; transition: transform 0.5s ease; width: ${images.length * 100}%;">
                            ${images.map((img, index) => `
                                <div class="carousel-slide" data-slide="${index}" style="min-width: ${100/images.length}%; height: 500px; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('${img}'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: white; position: relative;">
                                    <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="editCarouselImage('${carouselId}', ${index})" style="background: rgba(255,255,255,0.95); border: none; color: #333; padding: 10px 12px; border-radius: 6px; cursor: pointer; margin-right: 8px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255,255,255,0.95)'; this.style.transform='translateY(0)'">✏️ Edit</button>
                                        <button onclick="removeCarouselImage('${carouselId}', ${index})" style="background: rgba(220, 38, 38, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.2s;" onmouseover="this.style.background='rgba(220, 38, 38, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(220, 38, 38, 0.95)'; this.style.transform='translateY(0)'">🗑️</button>
                                    </div>
                                    <div style="text-align: center; z-index: 2;">
                                        <h1 style="font-size: 3rem; margin-bottom: 20px; color: white; font-family: 'Playfair Display', serif;">${data.titles?.[index] || 'Beautiful Photography'}</h1>
                                        <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9);">${data.subtitles?.[index] || 'Capturing life\'s precious moments'}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="carousel-prev" onclick="prevSlide('${carouselId}')" style="position: absolute; top: 50%; left: 30px; transform: translateY(-50%); background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.8); color: white; font-size: 28px; padding: 15px 18px; border-radius: 50%; cursor: pointer; z-index: 1000; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.4); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#333'; this.style.transform='translateY(-50%) scale(1.1)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'; this.style.color='white'; this.style.transform='translateY(-50%) scale(1)'">‹</button>
                        <button class="carousel-next" onclick="nextSlide('${carouselId}')" style="position: absolute; top: 50%; right: 30px; transform: translateY(-50%); background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.8); color: white; font-size: 28px; padding: 15px 18px; border-radius: 50%; cursor: pointer; z-index: 1000; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.4); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#333'; this.style.transform='translateY(-50%) scale(1.1)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'; this.style.color='white'; this.style.transform='translateY(-50%) scale(1)'">›</button>
                        <button class="carousel-add" onclick="addCarouselImage('${carouselId}')" style="position: absolute; bottom: 20px; right: 20px; background: rgba(102, 126, 234, 0.9); border: none; color: white; padding: 12px 18px; border-radius: 8px; cursor: pointer; z-index: 1000; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onmouseover="this.style.background='rgba(102, 126, 234, 1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.9)'; this.style.transform='translateY(0)'">+ Add Image</button>
                        
                        <!-- Dot indicators -->
                        <div class="carousel-dots" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 1000; background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(10px);">
                            ${images.map((_, index) => `
                                <button onclick="goToSlide('${carouselId}', ${index})" class="carousel-dot" data-slide="${index}" style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; background: ${index === 0 ? 'white' : 'rgba(255,255,255,0.4)'}; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.4);" onmouseover="this.style.transform='scale(1.3)'; this.style.background='white'" onmouseout="this.style.transform='scale(1)'; this.style.background='${index === 0 ? 'white' : 'rgba(255,255,255,0.4)'}'"></button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            'hero-text': (data = {}) => `
                <div class="element" data-type="hero-text">
                    <div style="text-align: center; padding: 80px 20px; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${data.backgroundImage || 'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=1200'}'); background-size: cover; background-position: center; color: white; border-radius: 8px; position: relative;">
                        <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                            <button onclick="changeHeroBackground(this)" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Background">📷</button>
                        </div>
                        <h1 style="font-size: 3rem; margin-bottom: 20px; color: white; font-family: 'Playfair Display', serif;">${data.title || 'Capturing Beautiful Moments'}</h1>
                        <p style="font-size: 1.2rem; margin-bottom: 30px; color: rgba(255,255,255,0.9); max-width: 600px; margin-left: auto; margin-right: auto;">${data.subtitle || 'Professional photography services that tell your unique story'}</p>
                        <button style="background: #667eea; color: white; padding: 15px 30px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: 600;" data-page-link="portfolio" onclick="switchToPageNew('portfolio')">View Portfolio</button>
                    </div>
                </div>
            `,
            hero: (data = {}) => `
                <div class="element" data-type="hero">
                    <div style="text-align: center; padding: 80px 20px; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${data.backgroundImage || 'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=1200'}'); background-size: cover; background-position: center; color: white; border-radius: 8px; position: relative;">
                        <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                            <button onclick="changeHeroBackground(this)" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Background">📷</button>
                        </div>
                        <h1 style="font-size: 3rem; margin-bottom: 20px; color: white;">${data.title || 'Capturing Beautiful Moments'}</h1>
                        <p style="font-size: 1.2rem; margin-bottom: 30px; color: rgba(255,255,255,0.9);">${data.subtitle || 'Professional photography services'}</p>
                        <button style="background: #667eea; color: white; padding: 15px 30px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;" data-page-link="portfolio" onclick="switchToPageNew('portfolio')">View Portfolio</button>
                    </div>
                </div>
            `,
            'featured-gallery': (data = {}) => {
                const galleryId = 'featured-gallery-' + Date.now();
                return `
                <div class="element" data-type="featured-gallery" data-gallery-id="${galleryId}">
                    <div style="padding: 60px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 50px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Featured Work'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 1000px; margin: 0 auto;">
                            ${(data.images || [
                                'https://images.unsplash.com/photo-1519741497674-611481863552?w=600',
                                'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=600',
                                'https://images.unsplash.com/photo-1511285560929-80b456fea0bc?w=600',
                                'https://images.unsplash.com/photo-1520854221256-17451cc331bf?w=600',
                                'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=600',
                                'https://images.unsplash.com/photo-1583939003579-730e3918a45a?w=600'
                            ]).map((img, index) => `
                                <div style="position: relative; overflow: hidden; border-radius: 8px;">
                                    <img src="${img}" style="width: 100%; height: 250px; object-fit: cover; transition: transform 0.3s ease; cursor: grab;" alt="Featured" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" ondragstart="return false;">
                                    <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            'gallery-grid': (data = {}) => {
                const galleryId = 'gallery-grid-' + Date.now();
                return `
                <div class="element" data-type="gallery-grid" data-gallery-id="${galleryId}">
                    <div style="padding: 60px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 50px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Gallery'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            ${(data.images || [
                                'https://images.unsplash.com/photo-1519741497674-611481863552?w=400',
                                'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=400',
                                'https://images.unsplash.com/photo-1511285560929-80b456fea0bc?w=400',
                                'https://images.unsplash.com/photo-1520854221256-17451cc331bf?w=400',
                                'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=400',
                                'https://images.unsplash.com/photo-1583939003579-730e3918a45a?w=400'
                            ]).map((img, index) => `
                                <div style="position: relative; overflow: hidden; border-radius: 8px;">
                                    <img src="${img}" style="width: 100%; height: 300px; object-fit: cover;" alt="Gallery">
                                    <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            masonry: (data = {}) => {
                const galleryId = 'masonry-gallery-' + Date.now();
                return `
                <div class="element" data-type="masonry" data-gallery-id="${galleryId}">
                    <div style="padding: 60px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 50px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Portfolio'}</h2>
                        <div style="columns: 3; column-gap: 20px; max-width: 1200px; margin: 0 auto;">
                            ${(data.images || [
                                'https://images.unsplash.com/photo-1519741497674-611481863552?w=400',
                                'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=400',
                                'https://images.unsplash.com/photo-1511285560929-80b456fea0bc?w=400',
                                'https://images.unsplash.com/photo-1520854221256-17451cc331bf?w=400',
                                'https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=400',
                                'https://images.unsplash.com/photo-1583939003579-730e3918a45a?w=400',
                                'https://images.unsplash.com/photo-1542038784456-1ea8e935640e?w=400',
                                'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400'
                            ]).map((img, index) => `
                                <div style="position: relative; margin-bottom: 20px; border-radius: 8px; overflow: hidden; break-inside: avoid;">
                                    <img src="${img}" style="width: 100%; border-radius: 8px; display: block; height: ${200 + (index % 3) * 100}px; object-fit: cover;" alt="Portfolio" ondragstart="return false;" style="cursor: grab;">
                                    <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            about: (data = {}) => `
                <div class="element" data-type="about">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center; padding: 80px 0;">
                        <div>
                            <h2 style="color: #2d3748; margin-bottom: 30px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'About Me'}</h2>
                            <p style="line-height: 1.8; color: #4a5568; font-size: 1.1rem; margin-bottom: 20px;">${data.text || 'I\'m a passionate photographer dedicated to capturing the essence of every moment. With over 10 years of experience, I specialize in creating timeless images that tell your unique story.'}</p>
                            <p style="line-height: 1.8; color: #4a5568; font-size: 1.1rem;">${data.additionalText || 'From intimate portraits to grand celebrations, I believe every photograph should evoke emotion and preserve memories for generations to come.'}</p>
                        </div>
                        <div style="position: relative;">
                            <img src="${data.image || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=500'}" style="width: 100%; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);" alt="About">
                            <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                                <button onclick="changeAboutImage(this)" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            gallery: (data = {}) => {
                const galleryId = 'basic-gallery-' + Date.now();
                return `
                <div class="element" data-type="gallery" data-gallery-id="${galleryId}">
                    <div style="padding: 40px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 40px;">${data.title || 'Portfolio'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            ${(data.images || ['https://images.unsplash.com/photo-1519741497674-611481863552?w=400']).map((img, index) => `
                                <div style="position: relative; overflow: hidden; border-radius: 8px;">
                                    <img src="${img}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" alt="Gallery">
                                    <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            services: (data = {}) => `
                <div class="element" data-type="services">
                    <div style="padding: 80px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Services'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; max-width: 1200px; margin: 0 auto;">
                            ${(data.services || [
                                {name: 'Wedding Photography', price: '$2,500', description: 'Complete wedding day coverage with engagement session included', icon: '💍'},
                                {name: 'Portrait Sessions', price: '$350', description: 'Individual, family, and couple portraits in studio or on location', icon: '📸'},
                                {name: 'Event Photography', price: '$150/hr', description: 'Corporate events, parties, and special celebrations', icon: '🎉'}
                            ]).map(service => `
                                <div style="text-align: center; padding: 40px 30px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <div style="font-size: 3rem; margin-bottom: 20px;">${service.icon}</div>
                                    <h3 style="color: #2d3748; margin-bottom: 15px; font-size: 1.5rem; font-weight: 600;">${service.name}</h3>
                                    <p style="color: #667eea; font-size: 1.4rem; font-weight: 700; margin-bottom: 20px;">${service.price}</p>
                                    <p style="color: #4a5568; line-height: 1.6;">${service.description}</p>
                                    <button style="margin-top: 25px; background: #667eea; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" data-page-link="contact" onclick="switchToPageNew('contact')">Learn More</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `,
            workshops: (data = {}) => `
                <div class="element" data-type="workshops">
                    <div style="padding: 80px 0; background: #f8fafc;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Photography Workshops'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
                            ${(data.workshops || [
                                {title: 'Portrait Mastery', date: 'March 15, 2024', description: 'Learn professional portrait techniques, lighting, and posing', price: '$299', duration: '8 hours'},
                                {title: 'Wedding Photography Intensive', date: 'April 20, 2024', description: 'Complete guide to capturing unforgettable wedding moments', price: '$499', duration: '2 days'},
                                {title: 'Natural Light Workshop', date: 'May 10, 2024', description: 'Master the art of natural light photography in any condition', price: '$199', duration: '6 hours'}
                            ]).map(workshop => `
                                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                    <div style="height: 200px; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center;">
                                        <h3 style="color: white; font-size: 1.5rem; text-align: center; font-weight: 600;">${workshop.title}</h3>
                                    </div>
                                    <div style="padding: 30px;">
                                        <p style="color: #667eea; font-weight: 600; margin-bottom: 10px;">${workshop.date} • ${workshop.duration}</p>
                                        <p style="color: #4a5568; line-height: 1.6; margin-bottom: 20px;">${workshop.description}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #2d3748; font-size: 1.3rem; font-weight: 700;">${workshop.price}</span>
                                            <button style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Register</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `,
            testimonials: (data = {}) => `
                <div class="element" data-type="testimonials">
                    <div style="padding: 80px 0; background: #f8fafc;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'What Clients Say'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; max-width: 1200px; margin: 0 auto;">
                            ${(data.testimonials || [
                                {name: 'Sarah & Michael Johnson', text: 'Absolutely amazing work! The photos turned out better than we could have imagined. Every moment was captured perfectly, and we\'ll treasure these memories forever.', type: 'Wedding'},
                                {name: 'Emily Davis', text: 'Professional, creative, and so easy to work with. The family portraits are stunning and really capture our personalities. Highly recommended!', type: 'Family Portrait'},
                                {name: 'Corporate Events LLC', text: 'Outstanding event photography. Great attention to detail and delivered beautiful images that perfectly represented our brand and event.', type: 'Corporate Event'}
                            ]).map(testimonial => `
                                <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative;">
                                    <div style="font-size: 3rem; color: #667eea; margin-bottom: 20px;">❝</div>
                                    <p style="font-style: italic; color: #4a5568; margin-bottom: 25px; line-height: 1.8; font-size: 1.1rem;">"${testimonial.text}"</p>
                                    <div style="border-top: 1px solid #e2e8f0; padding-top: 20px;">
                                        <p style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">${testimonial.name}</p>
                                        <p style="color: #667eea; font-size: 0.9rem;">${testimonial.type}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `,
            contact: (data = {}) => `
                <div class="element" data-type="contact">
                    <div style="padding: 80px 0;">
                        <h2 style="text-align: center; color: #2d3748; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-size: 2.5rem;">${data.title || 'Get In Touch'}</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: start; max-width: 1200px; margin: 0 auto;">
                            <div>
                                <h3 style="color: #2d3748; margin-bottom: 30px; font-size: 1.5rem;">Let's Create Something Beautiful</h3>
                                <p style="color: #4a5568; line-height: 1.8; margin-bottom: 40px;">Ready to capture your special moments? I'd love to hear about your vision and discuss how we can bring it to life through photography.</p>
                                
                                <div style="margin-bottom: 25px; display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">📧</div>
                                    <div>
                                        <h4 style="color: #2d3748; margin-bottom: 5px;">Email</h4>
                                        <p style="color: #4a5568;">${data.email || 'hello@photographer.com'}</p>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 25px; display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">📞</div>
                                    <div>
                                        <h4 style="color: #2d3748; margin-bottom: 5px;">Phone</h4>
                                        <p style="color: #4a5568;">${data.phone || '(555) 123-4567'}</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">📍</div>
                                    <div>
                                        <h4 style="color: #2d3748; margin-bottom: 5px;">Studio Location</h4>
                                        <p style="color: #4a5568;">${data.address || '123 Photography Lane, Studio City, CA 90210'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <form style="display: flex; flex-direction: column; gap: 25px;">
                                    <div>
                                        <label style="display: block; color: #2d3748; font-weight: 600; margin-bottom: 8px;">Your Name</label>
                                        <input type="text" placeholder="Enter your full name" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                                    </div>
                                    <div>
                                        <label style="display: block; color: #2d3748; font-weight: 600; margin-bottom: 8px;">Email Address</label>
                                        <input type="email" placeholder="your@email.com" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                                    </div>
                                    <div>
                                        <label style="display: block; color: #2d3748; font-weight: 600; margin-bottom: 8px;">Project Type</label>
                                        <select style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                                            <option>Wedding Photography</option>
                                            <option>Portrait Session</option>
                                            <option>Event Photography</option>
                                            <option>Corporate Headshots</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; color: #2d3748; font-weight: 600; margin-bottom: 8px;">Tell me about your vision</label>
                                        <textarea placeholder="Describe your project, preferred dates, location, and any special requirements..." rows="6" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; font-size: 16px; transition: border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                                    </div>
                                    <button type="submit" style="background: #667eea; color: white; padding: 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a67d8'" onmouseout="this.style.backgroundColor='#667eea'">Send Message</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            footer: (data = {}) => `
                <div class="element" data-type="footer">
                    <div style="background: #2d3748; color: white; padding: 60px 0 40px; margin-top: 80px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 50px; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
                            <div>
                                <h3 style="margin-bottom: 25px; font-family: 'Playfair Display', serif; font-size: 1.8rem;">${data.title || 'Photography Studio'}</h3>
                                <p style="color: #a0aec0; line-height: 1.8; margin-bottom: 25px; font-size: 1.1rem;">${data.description || 'Creating beautiful memories through the art of photography. Every moment tells a story, and I\'m here to help you preserve yours.'}</p>
                                <div style="display: flex; gap: 20px;">
                                    <a href="#" style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.1)'">📷</a>
                                    <a href="#" style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.1)'">📘</a>
                                    <a href="#" style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.1)'">🐦</a>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 25px; font-size: 1.2rem;">Quick Links</h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${(data.links || ['Home', 'Portfolio', 'About', 'Services', 'Contact']).map(link => `<a href="#" style="color: #a0aec0; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#a0aec0'">${link}</a>`).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 25px; font-size: 1.2rem;">Services</h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${(data.services || ['Wedding Photography', 'Portrait Sessions', 'Event Photography', 'Corporate Headshots']).map(service => `<a href="#" style="color: #a0aec0; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#a0aec0'">${service}</a>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 50px; padding-top: 40px; border-top: 1px solid #4a5568;">
                            <p style="color: #a0aec0;">© 2024 ${data.title || 'Photography Studio'}. All rights reserved. | Crafted with ❤️ for photographers</p>
                        </div>
                    </div>
                </div>
            `,
            nav: (data = {}) => `
                <div class="element" data-type="nav">
                    <nav style="position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 100; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; letter-spacing: 2px;">${data.title || 'STUDIO NAME'}</div>
                        <div style="display: flex; gap: 30px;">
                            ${(data.navigation || ['Portfolio', 'About', 'Services', 'Contact']).map(item => `<a href="#" style="color: #2d3748; text-decoration: none; font-size: 13px; letter-spacing: 1px; text-transform: uppercase;">${item}</a>`).join('')}
                        </div>
                    </nav>
                </div>
            `,
            // Removed duplicate - using the full-featured hero-carousel above
            'hero-text': (data = {}) => `
                <div class="element" data-type="hero-text">
                    <div style="position: relative; height: 100vh; display: flex; align-items: center; justify-content: center; background: ${data.background || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};">
                        <div style="text-align: center; color: white; z-index: 10;">
                            <h1 style="font-family: 'Playfair Display', serif; font-size: ${data.fontSize || '80px'}; font-weight: 300; letter-spacing: 8px; margin-bottom: 20px;">${data.title || 'PHOTOGRAPHER'}</h1>
                            <div style="width: 100px; height: 1px; background: white; margin: 30px auto;"></div>
                            <p style="font-family: 'Montserrat', sans-serif; font-size: 14px; letter-spacing: 3px; text-transform: uppercase;">${data.subtitle || 'Natural Light Photography'}</p>
                        </div>
                    </div>
                </div>
            `,
            'featured-single': (data = {}) => `
                <div class="element" data-type="featured-single">
                    <div style="padding: 80px 40px; background: #fafafa;">
                        <div style="max-width: 1200px; margin: 0 auto;">
                            <div style="text-align: center; margin-bottom: 50px;">
                                <h3 style="font-family: 'Montserrat', sans-serif; font-size: 12px; letter-spacing: 3px; text-transform: uppercase; color: #718096; margin-bottom: 15px;">Featured Gallery</h3>
                                <h2 style="font-family: 'Playfair Display', serif; font-size: 48px; color: #2d3748;">${data.title || 'Cuba Collection'}</h2>
                            </div>
                            <div style="position: relative; overflow: hidden; border-radius: 2px;">
                                <img src="${data.image || 'https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=1200'}" style="width: 100%; height: 600px; object-fit: cover;">
                                <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                                    <button onclick="changeAboutImage(this)" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                </div>
                                <div style="position: absolute; bottom: 30px; left: 30px;">
                                    <button style="background: white; color: #2d3748; padding: 15px 40px; border: none; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer;">View Gallery</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            'gallery-categories': (data = {}) => {
                const galleryId = 'gallery-categories-' + Date.now();
                return `
                <div class="element" data-type="gallery-categories" data-gallery-id="${galleryId}">
                    <div style="padding: 80px 40px;">
                        <h2 style="font-family: 'Playfair Display', serif; font-size: 48px; text-align: center; margin-bottom: 60px; color: #2d3748;">${data.title || 'Galleries'}</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; max-width: 1200px; margin: 0 auto;">
                            ${(data.galleries || [
                                {name: 'Burma', category: 'Travel Photography', image: 'https://images.unsplash.com/photo-1503249023995-51b0f3778ccf?w=600'},
                                {name: 'India', category: 'Cultural Photography', image: 'https://images.unsplash.com/photo-1524721696987-b9527df9e512?w=600'},
                                {name: 'Cityscapes', category: 'Urban Photography', image: 'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=600'}
                            ]).map((gallery, index) => `
                                <div style="cursor: pointer;">
                                    <div style="overflow: hidden; margin-bottom: 20px; position: relative;">
                                        <img src="${gallery.image}" style="width: 100%; height: 400px; object-fit: cover; transition: transform 0.3s;">
                                        <div class="image-edit-overlay" style="position: absolute; top: 15px; right: 15px; opacity: 1; transition: none; z-index: 9999;">
                                            <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                        </div>
                                    </div>
                                    <h3 style="font-family: 'Montserrat', sans-serif; font-size: 14px; letter-spacing: 2px; text-transform: uppercase;">${gallery.name}</h3>
                                    <p style="color: #718096; font-size: 14px; margin-top: 5px;">${gallery.category}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            'masonry-simple': (data = {}) => {
                const galleryId = 'masonry-simple-' + Date.now();
                return `
                <div class="element" data-type="masonry-simple" data-gallery-id="${galleryId}">
                    <div style="padding: 80px 40px; background: white;">
                        <div style="columns: 3; column-gap: 20px; max-width: 1200px; margin: 0 auto;">
                            ${(data.images || [
                                'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=400',
                                'https://images.unsplash.com/photo-1518098268026-4e89f1a2cd8e?w=400&h=600',
                                'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=400',
                                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=500',
                                'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400',
                                'https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?w=400&h=600'
                            ]).map((img, index) => `
                                <div style="position: relative; margin-bottom: 20px; border-radius: 8px; overflow: hidden; break-inside: avoid;">
                                    <img src="${img}" style="width: 100%; display: block;">
                                    <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none; z-index: 9999;">
                                        <button onclick="changeGalleryImage('${galleryId}', ${index})" style="background: rgba(59, 130, 246, 0.95); border: none; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.95)'; this.style.transform='translateY(0)'" title="Change Photo">📷</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            },
            workshops: (data = {}) => `
                <div class="element" data-type="workshops">
                    <div style="padding: 80px 40px; background: #1a202c; color: white;">
                        <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                            <h2 style="font-family: 'Playfair Display', serif; font-size: 48px; margin-bottom: 30px;">${data.title || 'Upcoming Workshops'}</h2>
                            <p style="font-size: 18px; line-height: 1.8; margin-bottom: 40px; opacity: 0.9;">${data.description || 'In-person, virtual, or travel workshops: learn everything from essentials to master level concepts.'}</p>
                            <button style="background: white; color: #1a202c; padding: 15px 40px; border: none; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer;">View All Workshops</button>
                        </div>
                    </div>
                </div>
            `,
            button: (data = {}) => `
                <div class="element" data-type="button">
                    <div style="text-align: center; padding: 20px;">
                        <button style="background: #667eea; color: white; padding: 15px 30px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: 600; transition: background-color 0.3s;" data-page-link="" onmouseover="this.style.backgroundColor='#5a67d8'" onmouseout="this.style.backgroundColor='#667eea'">${data.text || 'Click Me'}</button>
                    </div>
                </div>
            `,
            header: (data = {}) => `
                <div class="element" data-type="header">
                    <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h1 style="font-size: 3rem; margin-bottom: 20px; color: white; font-family: 'Playfair Display', serif;">${data.title || 'Welcome'}</h1>
                        <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9); max-width: 600px; margin: 0 auto;">${data.subtitle || 'Professional photography services'}</p>
                    </div>
                </div>
            `
        };

        // Template functions
        function selectTemplate(templateName) {
            // Update active template card
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.template-card').classList.add('active');
            
            currentTemplate = templateName;
            loadTemplate(templateName);
        }

        function loadTemplate(templateName) {
            const template = templates[templateName];
            if (!template) return;

            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            template.elements.forEach(element => {
                if (componentTemplates[element.type]) {
                    const html = componentTemplates[element.type](element.content);
                    canvas.insertAdjacentHTML('beforeend', html);
                } else {
                    console.error(`Component template for type "${element.type}" not found. Available: ${Object.keys(componentTemplates).join(', ')}`);
                    const errorHtml = `<div class="element" data-type="${element.type}" style="padding: 20px; background: #fed7d7; border: 1px solid #e53e3e; color: #742a2a; border-radius: 4px; margin: 10px 0;">⚠️ Component "${element.type}" not found</div>`;
                    canvas.insertAdjacentHTML('beforeend', errorHtml);
                }
            });

            websiteData = { template: templateName, elements: template.elements };
            setupElementSelection();
            
            // Ensure navigation stays at top and content has proper spacing
            updateNavigationPreview();
            
            // Small delay to ensure DOM is updated before initializing touch-to-edit and making elements deletable
            setTimeout(() => {
                makeAllElementsDeletable(); // Make all template elements deletable
                makeAllElementsPhotoEditable(); // Make all template photos have camera buttons
                initializeTouchToEdit();
            }, 100);
        }

        function loadPageContent(pageId) {
            const page = pages[pageId];
            if (!page || !page.elements) return;

            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            page.elements.forEach(element => {
                if (componentTemplates[element.type]) {
                    const html = componentTemplates[element.type](element.content);
                    canvas.insertAdjacentHTML('beforeend', html);
                } else {
                    console.error(`Component template for type "${element.type}" not found. Available: ${Object.keys(componentTemplates).join(', ')}`);
                    const errorHtml = `<div class="element" data-type="${element.type}" style="padding: 20px; background: #fed7d7; border: 1px solid #e53e3e; color: #742a2a; border-radius: 4px; margin: 10px 0;">⚠️ Component "${element.type}" not found</div>`;
                    canvas.insertAdjacentHTML('beforeend', errorHtml);
                }
            });

            // Update website data with page content
            websiteData = { template: page.template || 'modern', elements: page.elements };
            setupElementSelection();
            
            // Ensure navigation stays at top and content has proper spacing
            updateNavigationPreview();
            
            // Small delay to ensure DOM is updated before initializing touch-to-edit and making elements deletable
            setTimeout(() => {
                makeAllElementsDeletable(); // Make all page elements deletable
                makeAllElementsPhotoEditable(); // Make all page photos have camera buttons
                initializeTouchToEdit();
            }, 100);
            
            console.log(`Loaded prebuilt content for page: ${pageId}`);
        }

        // Drag and drop
        function setupDragAndDrop() {
            const components = document.querySelectorAll('.component-item');
            const canvas = document.getElementById('canvas');

            components.forEach(component => {
                component.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.component);
                });
            });

            canvas.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            canvas.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });

            canvas.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                const componentType = e.dataTransfer.getData('text/plain');
                addComponent(componentType);
            });
        }

        function addComponent(type) {
            const canvas = document.getElementById('canvas');
            
            // Remove drop zone if it exists
            const dropZone = document.getElementById('drop-zone');
            if (dropZone) {
                dropZone.remove();
            }

            if (componentTemplates[type]) {
                const html = componentTemplates[type]();
                canvas.insertAdjacentHTML('beforeend', html);
                
                // Get the newly added element and assign ID + hover delete
                const newElements = canvas.querySelectorAll('.element:not([id])');
                if (newElements.length > 0) {
                    const newElement = newElements[newElements.length - 1];
                    if (!newElement.id) {
                        newElement.id = 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    }
                    // Add hover delete functionality to new element
                    addHoverDeleteToElement(newElement);
                    // Add hover photo change functionality to new element
                    addHoverPhotoChangeToElement(newElement);
                }
                
                console.log(`Adding component: ${type}`);
                console.log(`Component ${type} added successfully`);
            } else {
                console.error(`Component template for type "${type}" not found. Available: ${Object.keys(componentTemplates).join(', ')}`);
                const errorHtml = `<div class="element" data-type="${type}" style="padding: 20px; background: #fed7d7; border: 1px solid #e53e3e; color: #742a2a; border-radius: 4px; margin: 10px 0;">⚠️ Component "${type}" not found</div>`;
                canvas.insertAdjacentHTML('beforeend', errorHtml);
            }
            
            // Ensure all editable aspects are applied to the new component
            setupElementSelection();
            initializeTouchToEdit();
            // Make sure text elements are editable with full formatting options
            makeTextEditable();
            // Make sure images are editable
            makeImagesEditable();
            // Make sure blocks are draggable
            makeBlocksDraggable();
            // Make sure components are selectable
            makeComponentsSelectable();
        }

        // Element selection
        function setupElementSelection() {
            const elements = document.querySelectorAll('.element');
            
            elements.forEach(element => {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectElement(this);
                });
            });

            // Deselect when clicking canvas
            document.getElementById('canvas').addEventListener('click', function() {
                deselectElement();
            });
        }

        function selectElement(element) {
            // Remove previous selection
            document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
            
            // Select new element
            element.classList.add('selected');
            selectedElement = element;
            
            // Show properties
            showProperties(element);
        }

        function deselectElement() {
            document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
            selectedElement = null;
            
            // Clear properties panel if it exists
            const propertiesPanel = document.getElementById('properties-panel-tools');
            if (propertiesPanel) {
                propertiesPanel.innerHTML = `
                    <div style="color: #718096; font-size: 11px; padding: 10px 0;">
                        Select an element to edit properties
                    </div>
                `;
            }
        }

        function showProperties(element) {
            const type = element.dataset.type;
            const propertiesPanel = document.getElementById('properties-panel-tools');
            
            if (!propertiesPanel) {
                console.log('Properties panel not found');
                return;
            }
            
            let propertiesHTML = '';
            
            switch(type) {
                case 'header':
                    propertiesHTML = `
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Title</label>
                                <input type="text" class="property-input" value="Your Photography Studio" onchange="updateElementProperty('header', 'title', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Background Type</label>
                                <select class="property-input" onchange="updateHeaderBackground('type', this.value)">
                                    <option value="gradient">Gradient</option>
                                    <option value="solid">Solid Color</option>
                                    <option value="image">Background Image</option>
                                </select>
                            </div>
                            <div id="header-gradient-controls">
                                <label class="property-label">Start Color</label>
                                <input type="color" class="property-input" value="#667eea" onchange="updateHeaderBackground('startColor', this.value)">
                                <label class="property-label">End Color</label>
                                <input type="color" class="property-input" value="#764ba2" onchange="updateHeaderBackground('endColor', this.value)">
                                <label class="property-label">Direction</label>
                                <select class="property-input" onchange="updateHeaderBackground('direction', this.value)">
                                    <option value="135deg">Diagonal</option>
                                    <option value="0deg">Horizontal</option>
                                    <option value="90deg">Vertical</option>
                                    <option value="45deg">Light Diagonal</option>
                                </select>
                            </div>
                            <div id="header-solid-controls" style="display: none;">
                                <label class="property-label">Background Color</label>
                                <input type="color" class="property-input" value="#667eea" onchange="updateHeaderBackground('solidColor', this.value)">
                            </div>
                            <div id="header-image-controls" style="display: none;">
                                <label class="property-label">Image URL</label>
                                <input type="text" class="property-input" placeholder="https://example.com/image.jpg" onchange="updateHeaderBackground('imageUrl', this.value)">
                                <label class="property-label">Overlay Opacity</label>
                                <input type="range" class="property-input" min="0" max="100" value="40" onchange="updateHeaderBackground('overlayOpacity', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Transparency</label>
                                <input type="range" class="property-input" min="0" max="100" value="100" onchange="updateHeaderBackground('opacity', this.value)">
                                <span style="font-size: 12px; color: #666;">100%</span>
                            </div>
                            <div style="border-top: 1px solid #e2e8f0; padding-top: 15px; margin-top: 15px;">
                                <label class="property-label">Navigation Logo</label>
                                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                                    <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                    <button onclick="document.getElementById('logo-upload').click()" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">Upload Logo</button>
                                    <button onclick="removeLogo()" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">Remove</button>
                                </div>
                                <div>
                                    <label class="property-label">Logo Size</label>
                                    <input type="range" class="property-input" min="20" max="80" value="40" onchange="updateLogoSize(this.value)">
                                    <span id="logo-size-display" style="font-size: 12px; color: #666;">40px</span>
                                </div>
                                <div>
                                    <label class="property-label">Logo Position</label>
                                    <select class="property-input" onchange="updateLogoPosition(this.value)">
                                        <option value="left">Left</option>
                                        <option value="center">Center</option>
                                        <option value="right">Right</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'hero':
                    propertiesHTML = `
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Title</label>
                                <input type="text" class="property-input" value="Capturing Beautiful Moments" onchange="updateElementProperty('hero', 'title', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Subtitle</label>
                                <input type="text" class="property-input" value="Professional photography services" onchange="updateElementProperty('hero', 'subtitle', this.value)">
                            </div>
                        </div>
                    `;
                    break;
                case 'about':
                    propertiesHTML = `
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Title</label>
                                <input type="text" class="property-input" value="About Me" onchange="updateElementProperty('about', 'title', this.value)">
                            </div>
                        </div>
                    `;
                    break;
                case 'contact':
                    propertiesHTML = `
                        <div class="property-controls">
                            <div>
                                <label class="property-label">Email</label>
                                <input type="email" class="property-input" value="hello@photographer.com" onchange="updateElementProperty('contact', 'email', this.value)">
                            </div>
                            <div>
                                <label class="property-label">Phone</label>
                                <input type="tel" class="property-input" value="(555) 123-4567" onchange="updateElementProperty('contact', 'phone', this.value)">
                            </div>
                        </div>
                    `;
                    break;
                default:
                    propertiesHTML = `
                        <div style="color: #718096; font-size: 11px;">
                            Element: ${type}
                        </div>
                    `;
            }
            
            propertiesPanel.innerHTML = propertiesHTML;
        }

        function updateElementProperty(elementType, property, value) {
            if (!selectedElement) return;
            
            // This is a simplified update - in a real app you'd want to rebuild the element
            console.log(`Updating ${elementType} ${property} to ${value}`);
            
            // For demo purposes, show that the property is being updated
            const elements = selectedElement.querySelectorAll('h1, h2, h3, p, img');
            elements.forEach(el => {
                if (property === 'title' && (el.tagName === 'H1' || el.tagName === 'H2')) {
                    el.textContent = value;
                }
                if (property === 'subtitle' && el.tagName === 'P') {
                    el.textContent = value;
                }
                if (property === 'backgroundImage' && el.style.backgroundImage) {
                    el.style.backgroundImage = `url('${value}')`;
                }
                if (property === 'image' && el.tagName === 'IMG') {
                    el.src = value;
                }
            });
        }

        // Header background configuration
        let headerBackgroundConfig = {
            type: 'gradient',
            startColor: '#667eea',
            endColor: '#764ba2',
            direction: '135deg',
            solidColor: '#667eea',
            imageUrl: '',
            overlayOpacity: 40,
            opacity: 100
        };

        // Navigation logo configuration
        let logoConfig = {
            url: '',
            size: 40,
            position: 'left'
        };

        function updateHeaderBackground(property, value) {
            headerBackgroundConfig[property] = value;
            
            // Update UI controls visibility
            if (property === 'type') {
                document.getElementById('header-gradient-controls').style.display = value === 'gradient' ? 'block' : 'none';
                document.getElementById('header-solid-controls').style.display = value === 'solid' ? 'block' : 'none';
                document.getElementById('header-image-controls').style.display = value === 'image' ? 'block' : 'none';
            }
            
            // Update transparency display
            if (property === 'opacity') {
                const span = document.querySelector('.property-controls span');
                if (span) span.textContent = `${value}%`;
            }
            
            // Apply changes to all header elements on the page
            applyHeaderBackgroundChanges();
            
            console.log('Header background updated:', property, value);
        }

        function applyHeaderBackgroundChanges() {
            const headerElements = document.querySelectorAll('[data-type="header"] > div');
            
            headerElements.forEach(headerDiv => {
                let backgroundStyle = '';
                let opacity = headerBackgroundConfig.opacity / 100;
                
                switch(headerBackgroundConfig.type) {
                    case 'gradient':
                        backgroundStyle = `linear-gradient(${headerBackgroundConfig.direction}, ${headerBackgroundConfig.startColor} 0%, ${headerBackgroundConfig.endColor} 100%)`;
                        break;
                    case 'solid':
                        backgroundStyle = headerBackgroundConfig.solidColor;
                        break;
                    case 'image':
                        if (headerBackgroundConfig.imageUrl) {
                            const overlayOpacity = headerBackgroundConfig.overlayOpacity / 100;
                            backgroundStyle = `linear-gradient(rgba(0,0,0,${overlayOpacity}), rgba(0,0,0,${overlayOpacity})), url('${headerBackgroundConfig.imageUrl}')`;
                            headerDiv.style.backgroundSize = 'cover';
                            headerDiv.style.backgroundPosition = 'center';
                        } else {
                            backgroundStyle = headerBackgroundConfig.solidColor;
                        }
                        break;
                }
                
                headerDiv.style.background = backgroundStyle;
                headerDiv.style.opacity = opacity;
            });
        }

        // Image positioning configuration
        let imagePositioning = {};
        let isDraggingImage = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let initialX = 0;
        let initialY = 0;
        
        // Add image drag functionality
        function enableImageDragging() {
            document.addEventListener('mousedown', function(e) {
                const img = e.target.closest('img');
                if (!img || e.target.closest('.image-edit-overlay')) return;
                
                isDraggingImage = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                const container = img.parentElement;
                const rect = container.getBoundingClientRect();
                
                // Get current background-position or object-position
                const computedStyle = window.getComputedStyle(img);
                const currentPosition = computedStyle.objectPosition || '50% 50%';
                const [x, y] = currentPosition.split(' ').map(v => parseFloat(v));
                
                initialX = x;
                initialY = y;
                
                img.style.cursor = 'grabbing';
                e.preventDefault();
                
                document.addEventListener('mousemove', handleImageDrag);
                document.addEventListener('mouseup', handleImageDragEnd);
            });
        }
        
        function handleImageDrag(e) {
            if (!isDraggingImage) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            const img = document.querySelector('img[style*="grabbing"]');
            if (!img) return;
            
            const container = img.parentElement;
            const rect = container.getBoundingClientRect();
            
            // Calculate new position as percentage
            const newX = initialX + (deltaX / rect.width) * 100;
            const newY = initialY + (deltaY / rect.height) * 100;
            
            // Constrain to reasonable bounds
            const clampedX = Math.max(-50, Math.min(150, newX));
            const clampedY = Math.max(-50, Math.min(150, newY));
            
            img.style.objectPosition = `${clampedX}% ${clampedY}%`;
        }
        
        function handleImageDragEnd() {
            isDraggingImage = false;
            const img = document.querySelector('img[style*="grabbing"]');
            if (img) {
                img.style.cursor = 'grab';
            }
            
            document.removeEventListener('mousemove', handleImageDrag);
            document.removeEventListener('mouseup', handleImageDragEnd);
        }

        // Image positioning functions
        function showImageProperties(imgElement) {
            const propertiesContent = document.getElementById('properties-content');
            const imgSrc = imgElement.src;
            const imgId = imgElement.id || 'img-' + Date.now();
            
            if (!imgElement.id) {
                imgElement.id = imgId;
            }
            
            // Initialize positioning if not exists
            if (!imagePositioning[imgId]) {
                imagePositioning[imgId] = {
                    x: 50, // percentage
                    y: 50, // percentage
                    scale: 100,
                    fit: 'cover'
                };
            }
            
            const config = imagePositioning[imgId];
            
            propertiesContent.innerHTML = `
                <div class="tool-section">
                    <div class="tool-title">Image Properties</div>
                    
                    <!-- Image Upload -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Change Image</label>
                        <button onclick="changeImage('${imgId}')" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Upload New Image
                        </button>
                    </div>
                    
                    <!-- Position Controls -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Position</label>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 12px; color: #4a5568; margin-bottom: 5px;">Horizontal Position: <span id="pos-x-display">${config.x}%</span></label>
                                <input type="range" id="position-x" min="0" max="100" value="${config.x}" style="width: 100%;" oninput="updateImagePosition('${imgId}', 'x', this.value)">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 12px; color: #4a5568; margin-bottom: 5px;">Vertical Position: <span id="pos-y-display">${config.y}%</span></label>
                                <input type="range" id="position-y" min="0" max="100" value="${config.y}" style="width: 100%;" oninput="updateImagePosition('${imgId}', 'y', this.value)">
                            </div>
                        </div>
                        
                        <!-- Quick Position Presets -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px;">
                            <button onclick="setImagePosition('${imgId}', 0, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Left</button>
                            <button onclick="setImagePosition('${imgId}', 50, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Center</button>
                            <button onclick="setImagePosition('${imgId}', 100, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Right</button>
                            <button onclick="setImagePosition('${imgId}', 0, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center Left</button>
                            <button onclick="setImagePosition('${imgId}', 50, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center</button>
                            <button onclick="setImagePosition('${imgId}', 100, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center Right</button>
                            <button onclick="setImagePosition('${imgId}', 0, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Left</button>
                            <button onclick="setImagePosition('${imgId}', 50, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Center</button>
                            <button onclick="setImagePosition('${imgId}', 100, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Right</button>
                        </div>
                    </div>
                    
                    <!-- Scale Control -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Scale: <span id="scale-display">${config.scale}%</span></label>
                        <input type="range" id="image-scale" min="50" max="200" value="${config.scale}" style="width: 100%;" oninput="updateImageScale('${imgId}', this.value)">
                    </div>
                    
                    <!-- Fit Control -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Image Fit</label>
                        <select id="image-fit" onchange="updateImageFit('${imgId}', this.value)" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <option value="cover" ${config.fit === 'cover' ? 'selected' : ''}>Cover (Fill Container)</option>
                            <option value="contain" ${config.fit === 'contain' ? 'selected' : ''}>Contain (Fit Inside)</option>
                            <option value="fill" ${config.fit === 'fill' ? 'selected' : ''}>Fill (Stretch)</option>
                        </select>
                    </div>
                    
                    <!-- Reset Button -->
                    <button onclick="resetImagePosition('${imgId}')" style="width: 100%; padding: 10px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 6px; cursor: pointer;">
                        Reset to Default
                    </button>
                </div>
            `;
            
            // Switch to Properties tab
            switchToTab('properties');
            
            console.log('Image properties shown for:', imgId);
        }

        function updateImagePosition(imgId, axis, value) {
            imagePositioning[imgId][axis] = parseInt(value);
            
            // Update display
            document.getElementById(`pos-${axis}-display`).textContent = value + '%';
            
            // Apply positioning
            applyImagePositioning(imgId);
            
            console.log(`Image ${imgId} ${axis} position updated to:`, value);
        }

        function setImagePosition(imgId, x, y) {
            imagePositioning[imgId].x = x;
            imagePositioning[imgId].y = y;
            
            // Update sliders and displays
            document.getElementById('position-x').value = x;
            document.getElementById('position-y').value = y;
            document.getElementById('pos-x-display').textContent = x + '%';
            document.getElementById('pos-y-display').textContent = y + '%';
            
            // Apply positioning
            applyImagePositioning(imgId);
            
            console.log(`Image ${imgId} position set to:`, x, y);
        }

        function updateImageScale(imgId, value) {
            imagePositioning[imgId].scale = parseInt(value);
            document.getElementById('scale-display').textContent = value + '%';
            applyImagePositioning(imgId);
            console.log(`Image ${imgId} scale updated to:`, value);
        }

        function updateImageFit(imgId, fit) {
            imagePositioning[imgId].fit = fit;
            applyImagePositioning(imgId);
            console.log(`Image ${imgId} fit updated to:`, fit);
        }

        function applyImagePositioning(imgId) {
            const imgElement = document.getElementById(imgId);
            if (!imgElement) return;
            
            const config = imagePositioning[imgId];
            const scale = config.scale / 100;
            
            // Apply positioning styles
            imgElement.style.objectFit = config.fit;
            imgElement.style.objectPosition = `${config.x}% ${config.y}%`;
            imgElement.style.transform = `scale(${scale})`;
            imgElement.style.transformOrigin = 'center';
            
            console.log(`Applied positioning to ${imgId}:`, config);
        }

        function resetImagePosition(imgId) {
            imagePositioning[imgId] = {
                x: 50,
                y: 50,
                scale: 100,
                fit: 'cover'
            };
            
            // Update UI if properties panel is open
            const posX = document.getElementById('position-x');
            const posY = document.getElementById('position-y');
            const scale = document.getElementById('image-scale');
            const fit = document.getElementById('image-fit');
            
            if (posX) posX.value = 50;
            if (posY) posY.value = 50;
            if (scale) scale.value = 100;
            if (fit) fit.value = 'cover';
            
            if (document.getElementById('pos-x-display')) document.getElementById('pos-x-display').textContent = '50%';
            if (document.getElementById('pos-y-display')) document.getElementById('pos-y-display').textContent = '50%';
            if (document.getElementById('scale-display')) document.getElementById('scale-display').textContent = '100%';
            
            applyImagePositioning(imgId);
            console.log(`Image ${imgId} reset to default position`);
        }

        function changeImage(imgId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgElement = document.getElementById(imgId);
                        if (imgElement) {
                            imgElement.src = e.target.result;
                            console.log(`Image ${imgId} source updated`);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function switchToTab(tabName) {
            // Remove active class from all tabs and panels
            document.querySelectorAll('.tool-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to selected tab and panel
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelector(`[data-panel="${tabName}"]`).classList.add('active');
        }

        // Logo functions
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoConfig.url = e.target.result;
                    updateNavigationPreview();
                    console.log('Logo uploaded successfully');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            logoConfig.url = '';
            updateNavigationPreview();
            console.log('Logo removed');
        }

        function updateLogoSize(size) {
            logoConfig.size = parseInt(size);
            document.getElementById('logo-size-display').textContent = size + 'px';
            updateNavigationPreview();
            console.log('Logo size updated to:', size + 'px');
        }

        function updateLogoPosition(position) {
            logoConfig.position = position;
            updateNavigationPreview();
            console.log('Logo position updated to:', position);
        }

        // Header functions
        function previewWebsite() {
            alert('Preview functionality would open a new tab with the live website preview');
        }

        function publishWebsite() {
            alert('Publish functionality would deploy the website to your domain');
        }

        function saveAndClose() {
            // Save to parent window if opened from main app
            if (window.opener) {
                window.opener.postMessage({
                    type: 'website-saved',
                    data: websiteData
                }, '*');
            }
            
            window.close();
        }
        
        // Page Management Functions
        function addNewPage() {
            const pageCount = Object.keys(pages).length;
            const pageName = prompt('Enter page name:', `Page ${pageCount + 1}`);
            
            if (pageName && pageName.trim()) {
                const pageId = pageName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                
                // Check if page already exists
                if (pages[pageId]) {
                    alert('A page with this name already exists!');
                    return;
                }
                
                // Save current page before switching
                savePage(currentPage);
                
                // Create new page
                pages[pageId] = {
                    name: pageName,
                    template: 'modern',
                    elements: []
                };
                
                // Add to UI
                const pagesList = document.getElementById('pages-list');
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                pageItem.dataset.page = pageId;
                pageItem.style.cssText = 'display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 8px; cursor: pointer;';
                pageItem.innerHTML = `
                    <span class="page-name" style="flex: 1;">${pageName}</span>
                    <button onclick="renamePage('${pageId}')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                    ${pageId !== 'home' ? `<button onclick="deletePage('${pageId}')" style="background: none; border: none; color: #e53e3e; cursor: pointer; padding: 4px;">🗑️</button>` : ''}
                `;
                
                pageItem.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'BUTTON') {
                        switchToPage(pageId);
                    }
                });
                
                pagesList.appendChild(pageItem);
                
                // Switch to new page
                switchToPage(pageId);
                
                console.log(`New page created: ${pageName}`);
            }
        }
        
        function renamePage(pageId) {
            const page = pages[pageId];
            const newName = prompt('Enter new page name:', page.name);
            
            if (newName && newName.trim()) {
                page.name = newName;
                
                // Update UI
                const pageItem = document.querySelector(`[data-page="${pageId}"]`);
                if (pageItem) {
                    pageItem.querySelector('.page-name').textContent = newName;
                }
                
                console.log(`Page renamed: ${pageId} -> ${newName}`);
            }
        }
        
        function deletePage(pageId) {
            if (pageId === 'home') {
                alert('Cannot delete the home page!');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the page "${pages[pageId].name}"?`)) {
                delete pages[pageId];
                
                // Remove from UI
                const pageItem = document.querySelector(`[data-page="${pageId}"]`);
                if (pageItem) {
                    pageItem.remove();
                }
                
                // If deleting current page, switch to home
                if (currentPage === pageId) {
                    switchToPage('home');
                }
                
                console.log(`Page deleted: ${pageId}`);
            }
        }
        
        function switchToPage(pageId) {
            if (!pages[pageId]) return;
            
            // Save current page
            savePage(currentPage);
            
            // Update active states
            document.querySelectorAll('.page-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });
            
            // Load new page
            currentPage = pageId;
            const page = pages[pageId];
            
            // Clear canvas
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            // Load page template
            if (page.elements && page.elements.length > 0) {
                // Load saved elements
                page.elements.forEach(element => {
                    if (componentTemplates[element.type]) {
                        const html = componentTemplates[element.type](element.content);
                        canvas.insertAdjacentHTML('beforeend', html);
                    } else {
                        console.error(`Component template for type "${element.type}" not found. Available: ${Object.keys(componentTemplates).join(', ')}`);
                        const errorHtml = `<div class="element" data-type="${element.type}" style="padding: 20px; background: #fed7d7; border: 1px solid #e53e3e; color: #742a2a; border-radius: 4px; margin: 10px 0;">⚠️ Component "${element.type}" not found</div>`;
                        canvas.insertAdjacentHTML('beforeend', errorHtml);
                    }
                });
            } else {
                // Load default template
                loadTemplate(page.template || 'modern');
            }
            
            // Reinitialize touch-to-edit with delay and make elements deletable
            setTimeout(() => {
                makeAllElementsDeletable(); // Make all elements on new page deletable
                initializeTouchToEdit();
            }, 100);
            
            console.log(`Switched to page: ${pageId}`);
        }
        
        function savePage(pageId) {
            if (!pages[pageId]) return;
            
            // Save current canvas state to page
            const elements = [];
            document.querySelectorAll('#canvas .element').forEach(element => {
                const type = element.dataset.type;
                const content = extractElementContent(element);
                elements.push({ type, content });
            });
            
            pages[pageId].elements = elements;
            pages[pageId].template = currentTemplate;
            
            console.log(`Page saved: ${pageId}`, pages[pageId]);
        }
        
        function extractElementContent(element) {
            // Extract content from element for saving
            const content = {};
            const type = element.dataset.type;
            
            // Extract text content
            const headings = element.querySelectorAll('h1, h2, h3');
            if (headings.length > 0) {
                content.title = headings[0].textContent;
            }
            
            const paragraphs = element.querySelectorAll('p');
            if (paragraphs.length > 0) {
                content.text = paragraphs[0].textContent;
                if (paragraphs.length > 1) {
                    content.subtitle = paragraphs[0].textContent;
                    content.description = paragraphs[1].textContent;
                }
            }
            
            // Extract images
            const images = element.querySelectorAll('img');
            if (images.length > 0) {
                if (images.length === 1) {
                    content.image = images[0].src;
                } else {
                    content.images = Array.from(images).map(img => img.src);
                }
            }
            
            // Extract background images
            const bgElements = element.querySelectorAll('[style*="background-image"]');
            bgElements.forEach(el => {
                const style = el.style.backgroundImage;
                const match = style.match(/url\(['"]?([^'")]+)['"]?\)/);
                if (match) {
                    content.backgroundImage = match[1];
                }
            });
            
            return content;
        }
        
        function addNewPage() {
            // Prompt for page name
            const pageName = prompt('Enter page name (e.g., "About", "Services", "Contact"):');
            if (!pageName || pageName.trim() === '') return;
            
            // Generate unique page ID
            const pageId = pageName.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            // Check if page already exists
            if (pages[pageId]) {
                alert('A page with this name already exists!');
                return;
            }
            
            // Save current page before switching
            if (currentPage) {
                savePage(currentPage);
            }
            
            // Create new page
            pages[pageId] = {
                name: pageName,
                template: 'modern',
                elements: []
            };
            
            // Add to navigation order
            navOrder.push(pageId);
            
            console.log('Creating new page:', pageName, 'ID:', pageId);
            
            // Add page to pages list in UI
            addPageToUI(pageId, pageName);
            
            // Update navigation in preview
            updateNavigationPreview();
            
            // Switch to new page
            switchToPage(pageId);
            
            // Show success message
            showMessage(`New page "${pageName}" created successfully!`, 'success');
            
            console.log('New page created and loaded:', pageId);
        }
        
        function addNewPageFromPages() {
            addNewPage(); // Same functionality but called from Pages tab
        }

        function addSubPage() {
            // Remove any existing subpage modals first
            const existingModals = document.querySelectorAll('.subpage-modal');
            existingModals.forEach(modal => modal.remove());
            
            // First select which parent page
            const parentOptions = navOrder.map(pageId => `<option value="${pageId}">${pages[pageId].name}</option>`).join('');
            
            const parentSelect = document.createElement('div');
            parentSelect.className = 'subpage-modal';
            parentSelect.innerHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #2d3748;">Create SubPage</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 500;">Parent Page:</label>
                            <select id="parent-page-select" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                ${parentOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 500;">SubPage Name:</label>
                            <input type="text" id="subpage-name-input" placeholder="e.g., Wedding Gallery" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="cancelSubPageCreation()" style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                            <button onclick="createSubPage()" style="padding: 10px 20px; background: #805ad5; color: white; border: none; border-radius: 6px; cursor: pointer;">Create SubPage</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click-outside-to-close functionality
            const overlay = parentSelect.querySelector('.modal-overlay');
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    cancelSubPageCreation();
                }
            });
            
            // Prevent modal content clicks from closing
            const modalContent = parentSelect.querySelector('.modal-content');
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            document.body.appendChild(parentSelect);
            
            // Focus on the name input
            setTimeout(() => {
                const nameInput = document.getElementById('subpage-name-input');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        function cancelSubPageCreation() {
            // Remove subpage modals specifically
            const subpageModals = document.querySelectorAll('.subpage-modal');
            subpageModals.forEach(modal => modal.remove());
            
            // Also remove any lingering modal overlays
            const overlays = document.querySelectorAll('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.5)"]');
            overlays.forEach(overlay => overlay.remove());
            
            // Remove any modal that might be stuck
            const stuckModals = document.querySelectorAll('div[style*="z-index: 10000"]');
            stuckModals.forEach(modal => {
                if (modal.innerHTML.includes('Create SubPage')) {
                    modal.remove();
                }
            });
            
            console.log('SubPage creation cancelled and all modals cleaned up');
        }

        function createSubPage() {
            const parentId = document.getElementById('parent-page-select').value;
            const subPageName = document.getElementById('subpage-name-input').value.trim();
            
            if (!subPageName) {
                alert('Please enter a subpage name');
                return;
            }
            
            const subPageId = `${parentId}-${subPageName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            
            // Check if subpage already exists
            if (pages[subPageId]) {
                alert('A subpage with this name already exists!');
                return;
            }
            
            console.log(`Creating SubPage: ${subPageId} under ${parentId}`);
            
            // Create subpage
            pages[subPageId] = {
                name: subPageName,
                parent: parentId,
                template: 'modern',
                elements: []
            };
            
            // Add to subPages tracking
            if (!subPages[parentId]) {
                subPages[parentId] = [];
            }
            subPages[parentId].push(subPageId);
            
            console.log('SubPage data created, updating UI...');
            
            // Close modal first - use the proper cleanup function
            cancelSubPageCreation();
            
            // Delay UI updates to ensure modal is closed
            setTimeout(() => {
                // Refresh pages list to show new subpage
                refreshPagesList();
                
                // Switch to new subpage
                switchToPageNew(subPageId);
                
                console.log(`SubPage created and loaded: ${subPageId} under ${parentId}`);
                
                // Show success message
                showMessage(`SubPage "${subPageName}" created under "${pages[parentId].name}"!`, 'success');
            }, 100);
        }

        // Submenu helper functions for navigation dropdowns
        function showSubMenu(pageId) {
            // Hide all other submenus first
            document.querySelectorAll('[id^="submenu-"]').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Show this submenu
            const submenu = document.getElementById(`submenu-${pageId}`);
            if (submenu) {
                submenu.style.display = 'block';
            }
        }

        function hideSubMenu(pageId) {
            setTimeout(() => {
                const submenu = document.getElementById(`submenu-${pageId}`);
                if (submenu) {
                    submenu.style.display = 'none';
                }
            }, 200); // Small delay to allow moving to submenu
        }

        function keepSubMenuOpen(pageId) {
            const submenu = document.getElementById(`submenu-${pageId}`);
            if (submenu) {
                submenu.style.display = 'block';
            }
        }

        // Individual photo change functions
        function changeGalleryImage(galleryId, imageIndex) {
            console.log(`Changing image ${imageIndex} in gallery ${galleryId}`);
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const galleryElement = document.querySelector(`[data-gallery-id="${galleryId}"]`);
                        if (galleryElement) {
                            const images = galleryElement.querySelectorAll('img');
                            if (images[imageIndex]) {
                                images[imageIndex].src = e.target.result;
                                console.log(`Updated image ${imageIndex} in gallery ${galleryId}`);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function changeAboutImage(button) {
            console.log('Changing about section image');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = button.closest('div').querySelector('img');
                        if (img) {
                            img.src = e.target.result;
                            console.log('Updated about section image');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function changeHeroBackground(button) {
            console.log('Changing hero background image');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const heroDiv = button.closest('div[style*="background:"]');
                        if (heroDiv) {
                            const currentStyle = heroDiv.style.background;
                            const newStyle = currentStyle.replace(/url\([^)]+\)/, `url('${e.target.result}')`);
                            heroDiv.style.background = newStyle;
                            console.log('Updated hero background image');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function refreshPagesList() {
            const pagesList = document.getElementById('pages-list');
            pagesList.innerHTML = '';
            
            navOrder.forEach(pageId => {
                if (pages[pageId]) {
                    // Add main page
                    const pageItem = createPageListItem(pageId, false);
                    pagesList.appendChild(pageItem);
                    
                    // Add subpages
                    if (subPages[pageId]) {
                        subPages[pageId].forEach(subPageId => {
                            if (pages[subPageId]) {
                                const subPageItem = createPageListItem(subPageId, true);
                                pagesList.appendChild(subPageItem);
                            }
                        });
                    }
                }
            });
        }

        function createPageListItem(pageId, isSubPage = false) {
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item';
            if (currentPage === pageId) pageItem.classList.add('active');
            pageItem.setAttribute('data-page', pageId);
            pageItem.setAttribute('draggable', 'true');
            
            const indentation = isSubPage ? '20px' : '0px';
            const pageIcon = isSubPage ? '└─' : '☰';
            const bgColor = currentPage === pageId ? '#e6fffa' : '#f7fafc';
            
            pageItem.style.cssText = `display: flex; align-items: center; padding: 8px; background: ${bgColor}; border-radius: 4px; margin-bottom: 4px; cursor: grab; margin-left: ${indentation};`;
            
            pageItem.innerHTML = `
                <span style="color: #718096; margin-right: 8px;">${pageIcon}</span>
                <span class="page-name" style="flex: 1; ${isSubPage ? 'font-size: 11px; color: #4a5568;' : ''}">${pages[pageId].name}</span>
                <button onclick="event.stopPropagation(); renamePageNew('${pageId}')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px; font-size: 12px;">✏️</button>
                <button onclick="event.stopPropagation(); deletePageNew('${pageId}')" style="background: none; border: none; color: #e53e3e; cursor: pointer; padding: 4px; font-size: 12px;">🗑️</button>
            `;
            
            // Add click event listener instead of using onclick attribute
            pageItem.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    switchToPageNew(pageId);
                }
            });
            
            return pageItem;
        }

        function showSubMenu(pageId) {
            // Hide all other submenus
            document.querySelectorAll('[id^="submenu-"]').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Show this submenu
            const submenu = document.getElementById(`submenu-${pageId}`);
            if (submenu) {
                submenu.style.display = 'block';
                
                // Hide submenu when mouse leaves
                submenu.onmouseleave = () => {
                    submenu.style.display = 'none';
                };
            }
        }
        
        function addPageToUI(pageId, pageName) {
            const pagesList = document.getElementById('pages-list');
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item';
            pageItem.dataset.page = pageId;
            pageItem.draggable = true;
            pageItem.style.cssText = 'display: flex; align-items: center; padding: 8px; background: #f7fafc; border-radius: 4px; margin-bottom: 4px; cursor: grab;';
            
            pageItem.innerHTML = `
                <span style="color: #718096; margin-right: 8px;">☰</span>
                <span class="page-name" style="flex: 1;">${pageName}</span>
                <button onclick="event.stopPropagation(); renamePageNew('${pageId}')" style="background: none; border: none; color: #667eea; cursor: pointer; padding: 4px; margin-right: 4px;">✏️</button>
                ${pageId !== 'home' && pageId !== 'portfolio' && pageId !== 'about' && pageId !== 'contact' ? 
                  `<button onclick="event.stopPropagation(); deletePageNew('${pageId}')" style="background: none; border: none; color: #e53e3e; cursor: pointer; padding: 4px;">🗑️</button>` : ''}
            `;
            
            pageItem.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    switchToPageNew(pageId);
                }
            });
            
            pagesList.appendChild(pageItem);
            
            // Initialize drag and drop for the new page item
            initializePageDrag(pageItem);
        }
        
        // Navigation style toggle
        function setNavStyle(style) {
            navStyle = style;
            updateNavigationPreview();
            console.log('Navigation style changed to:', style);
        }
        
        // Page switching functionality for new system
        function switchToPageNew(pageId) {
            if (!pages[pageId]) {
                console.error('Page not found:', pageId);
                return;
            }
            
            // Save current page before switching
            if (currentPage) {
                savePage(currentPage);
            }
            
            // Set new current page
            currentPage = pageId;
            
            // Update active state in pages list
            document.querySelectorAll('.page-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                }
            });
            
            // Load page content
            if (pages[pageId].elements && pages[pageId].elements.length > 0) {
                // Page has custom content, load it
                loadPageContent(pageId);
            } else if (pages[pageId].template) {
                // No custom content, load template
                loadTemplate(pages[pageId].template || 'modern');
            }
            
            // Always update navigation after switching pages to ensure consistency
            updateNavigationPreview();
            
            console.log('Switched to page:', pageId);
        }
        
        // Page rename functionality for new system
        function renamePageNew(pageId) {
            const currentName = pages[pageId]?.name || pageId;
            const newName = prompt(`Enter new name for page "${currentName}":`, currentName);
            
            if (!newName || newName.trim() === '' || newName === currentName) {
                return;
            }
            
            // Update page name
            pages[pageId].name = newName;
            
            // Update UI
            const pageItem = document.querySelector(`.page-item[data-page="${pageId}"] .page-name`);
            if (pageItem) {
                pageItem.textContent = newName;
            }
            
            // Update navigation
            updateNavigationPreview();
            
            console.log('Page renamed:', pageId, 'to', newName);
        }
        
        // Page drag and drop initialization
        function initializePageDrag(pageItem) {
            let draggedItem = null;
            
            pageItem.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.outerHTML);
            });
            
            pageItem.addEventListener('dragend', function(e) {
                this.style.opacity = '';
                draggedItem = null;
            });
            
            pageItem.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            pageItem.addEventListener('drop', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    const allItems = [...document.querySelectorAll('.page-item')];
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const dropIndex = allItems.indexOf(this);
                    
                    if (draggedIndex > dropIndex) {
                        this.parentNode.insertBefore(draggedItem, this);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    }
                    
                    // Update navigation order
                    updateNavOrderFromUI();
                    updateNavigationPreview();
                }
            });
        }
        
        // Update navigation order based on UI
        function updateNavOrderFromUI() {
            const pageItems = document.querySelectorAll('.page-item');
            navOrder = [...pageItems].map(item => item.dataset.page);
            console.log('Navigation order updated:', navOrder);
        }
        
        // Initialize all page items with drag functionality
        function initializePagesDragAndDrop() {
            document.querySelectorAll('.page-item').forEach(initializePageDrag);
        }
        
        // Toggle dropdown menu
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown-menu');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Delete page functionality for new system
        function deletePageNew(pageId) {
            // Don't allow deletion of default pages
            if (['home', 'portfolio', 'about', 'contact'].includes(pageId)) {
                alert('Cannot delete default pages');
                return;
            }
            
            const pageName = pages[pageId]?.name || pageId;
            const isSubPage = pages[pageId]?.parent;
            
            if (confirm(`Are you sure you want to delete the ${isSubPage ? 'sub' : ''}page "${pageName}"?`)) {
                // If it's a subpage, remove from parent's subpages list
                if (isSubPage) {
                    const parentId = pages[pageId].parent;
                    if (subPages[parentId]) {
                        const subIndex = subPages[parentId].indexOf(pageId);
                        if (subIndex > -1) {
                            subPages[parentId].splice(subIndex, 1);
                        }
                        // Clean up empty subPages array
                        if (subPages[parentId].length === 0) {
                            delete subPages[parentId];
                        }
                    }
                } else {
                    // If it's a parent page, delete all its subpages first
                    if (subPages[pageId] && subPages[pageId].length > 0) {
                        subPages[pageId].forEach(subPageId => {
                            delete pages[subPageId];
                        });
                        delete subPages[pageId];
                    }
                    
                    // Remove from navigation order
                    navOrder = navOrder.filter(id => id !== pageId);
                }
                
                // Remove from pages object
                delete pages[pageId];
                
                // If deleting current page, switch to home
                if (currentPage === pageId) {
                    switchToPageNew('home');
                }
                
                // Refresh the pages list to update the UI
                refreshPagesList();
                
                // Update navigation preview
                updateNavigationPreview();
                
                console.log(`Page deleted: ${pageId}`);
            }
        }
        
        // Update navigation preview in canvas
        function updateNavigationPreview() {
            const canvas = document.getElementById('canvas');
            let navElement = canvas.querySelector('.navigation-element');
            
            if (!navElement) {
                // Create navigation element if it doesn't exist
                navElement = document.createElement('nav');
                navElement.className = 'navigation-element';
                navElement.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: white; z-index: 1000; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                canvas.insertBefore(navElement, canvas.firstChild);
            }
            
            // Ensure canvas has top margin to avoid content overlap
            canvas.style.marginTop = '70px';
            
            // Generate navigation HTML based on style
            if (navStyle === 'horizontal') {
                // Create logo HTML if logo exists
                const logoHTML = logoConfig.url ? `<img src="${logoConfig.url}" style="height: ${logoConfig.size}px; width: auto; object-fit: contain;" alt="Logo">` : '';
                
                // Determine layout based on logo position
                let navigationLayout = '';
                if (logoConfig.position === 'left' && logoHTML) {
                    navigationLayout = `
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div style="flex: 0 0 auto;">
                                ${logoHTML}
                            </div>
                            <div style="display: flex; align-items: center; gap: 30px;">
                                <a href="javascript:void(0)" onclick="switchToPageNew('home'); return false;" style="text-decoration: none; color: ${currentPage === 'home' ? '#667eea' : '#2d3748'}; font-weight: ${currentPage === 'home' ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">Home</a>`;
                } else if (logoConfig.position === 'center' && logoHTML) {
                    navigationLayout = `
                        <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 15px;">
                            <div>${logoHTML}</div>
                            <div style="display: flex; align-items: center; gap: 30px;">
                                <a href="javascript:void(0)" onclick="switchToPageNew('home'); return false;" style="text-decoration: none; color: ${currentPage === 'home' ? '#667eea' : '#2d3748'}; font-weight: ${currentPage === 'home' ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">Home</a>`;
                } else if (logoConfig.position === 'right' && logoHTML) {
                    navigationLayout = `
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 30px;">
                                <a href="javascript:void(0)" onclick="switchToPageNew('home'); return false;" style="text-decoration: none; color: ${currentPage === 'home' ? '#667eea' : '#2d3748'}; font-weight: ${currentPage === 'home' ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">Home</a>`;
                } else {
                    // No logo or default center layout
                    navigationLayout = `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
                            <a href="javascript:void(0)" onclick="switchToPageNew('home'); return false;" style="text-decoration: none; color: ${currentPage === 'home' ? '#667eea' : '#2d3748'}; font-weight: ${currentPage === 'home' ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">Home</a>`;
                }
                
                // Complete the navigation with remaining pages
                const remainingPages = navOrder.filter(pageId => pageId !== 'home').map(pageId => {
                    const hasSubPages = subPages[pageId] && subPages[pageId].length > 0;
                    
                    if (hasSubPages) {
                        // Create dropdown for pages with subpages
                        return `
                            <div style="position: relative; display: inline-block;">
                                <a href="javascript:void(0)" onclick="switchToPageNew('${pageId}'); return false;" 
                                   onmouseover="showSubMenu('${pageId}')" 
                                   style="text-decoration: none; color: ${pageId === currentPage ? '#667eea' : '#2d3748'}; font-weight: ${pageId === currentPage ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                    ${pages[pageId]?.name || pageId} <span style="font-size: 10px;">▼</span>
                                </a>
                                <div id="submenu-${pageId}" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 180px; z-index: 9999; display: none;">
                                    ${subPages[pageId].map(subPageId => 
                                        `<a href="javascript:void(0)" onclick="switchToPageNew('${subPageId}'); return false;" style="display: block; padding: 8px 16px; text-decoration: none; color: #4a5568; border-bottom: 1px solid #f1f1f1; cursor: pointer; font-size: 14px;">${pages[subPageId]?.name || subPageId}</a>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular page link
                        return `<a href="javascript:void(0)" onclick="switchToPageNew('${pageId}'); return false;" style="text-decoration: none; color: ${pageId === currentPage ? '#667eea' : '#2d3748'}; font-weight: ${pageId === currentPage ? '600' : '400'}; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">${pages[pageId]?.name || pageId}</a>`;
                    }
                }).join('');
                
                // Complete the navigation HTML based on logo position
                if (logoConfig.position === 'left' && logoHTML) {
                    navigationLayout += `${remainingPages}
                            </div>
                        </div>`;
                } else if (logoConfig.position === 'center' && logoHTML) {
                    navigationLayout += `${remainingPages}
                            </div>
                        </div>`;
                } else if (logoConfig.position === 'right' && logoHTML) {
                    navigationLayout += `${remainingPages}
                            </div>
                            <div style="flex: 0 0 auto;">
                                ${logoHTML}
                            </div>
                        </div>`;
                } else {
                    navigationLayout += `${remainingPages}
                        </div>`;
                }
                
                navElement.innerHTML = navigationLayout;
            } else {
                // Dropdown navigation style
                const dropdownItems = [];
                // Always add home first
                dropdownItems.push(`<a href="javascript:void(0)" onclick="switchToPageNew('home'); toggleDropdown(); return false;" style="display: block; padding: 10px 15px; text-decoration: none; color: ${currentPage === 'home' ? '#667eea' : '#2d3748'}; border-bottom: 1px solid #f7fafc; transition: all 0.2s; cursor: pointer;">Home</a>`);
                
                navOrder.filter(pageId => pageId !== 'home').forEach(pageId => {
                    dropdownItems.push(`<a href="javascript:void(0)" onclick="switchToPageNew('${pageId}'); toggleDropdown(); return false;" style="display: block; padding: 10px 15px; text-decoration: none; color: ${pageId === currentPage ? '#667eea' : '#2d3748'}; border-bottom: 1px solid #f7fafc; transition: all 0.2s; cursor: pointer;">${pages[pageId]?.name || pageId}</a>`);
                    
                    // Add subpages
                    if (subPages[pageId] && subPages[pageId].length > 0) {
                        subPages[pageId].forEach(subPageId => {
                            dropdownItems.push(`<a href="javascript:void(0)" onclick="switchToPageNew('${subPageId}'); toggleDropdown(); return false;" style="display: block; padding: 8px 15px 8px 32px; text-decoration: none; color: #4a5568; border-bottom: 1px solid #f7fafc; transition: all 0.2s; cursor: pointer; font-size: 13px;">→ ${pages[subPageId]?.name || subPageId}</a>`);
                        });
                    }
                });
                
                navElement.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <button onclick="toggleDropdown()" style="background: white; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            Menu <span style="font-size: 12px;">▼</span>
                        </button>
                        <div id="dropdown-menu" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 150px; z-index: 9999; display: none;">
                            ${dropdownItems.join('')}
                        </div>
                    </div>
                `;
            }
        }
        
        function deletePage(pageId) {
            if (pageId === 'home') {
                alert('Cannot delete the home page!');
                return;
            }
            
            const pageName = pages[pageId]?.name || pageId;
            if (confirm(`Are you sure you want to delete the page "${pageName}"?`)) {
                delete pages[pageId];
                
                // Remove from navigation
                const pageItem = document.querySelector(`[onclick="switchToPage('${pageId}')"]`)?.closest('.page-item');
                if (pageItem) pageItem.remove();
                
                // Switch to home page if current page was deleted
                if (currentPage === pageId) {
                    switchToPage('home');
                }
                
                showMessage(`Page "${pageName}" deleted successfully!`, 'success');
                console.log('Page deleted:', pageId);
            }
        }
        
        function showMessage(message, type = 'info') {
            // Simple message display - you can enhance this with better styling
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 300px;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Floating Toolbar Functions
        let currentTextElement = null;
        
        function initializeFloatingToolbar() {
            const toolbar = document.getElementById('text-toolbar');
            
            // Hide toolbar when clicking outside (but not on tab buttons)
            document.addEventListener('click', function(e) {
                if (!toolbar.contains(e.target) && 
                    !e.target.closest('.editable-text') && 
                    !e.target.classList.contains('editable-text') &&
                    !e.target.closest('.builder-tools') &&
                    !e.target.classList.contains('tool-tab') &&
                    !e.target.dataset.tab) {
                    console.log('Hiding toolbar - clicked outside');
                    toolbar.style.display = 'none';
                    currentTextElement = null;
                }
            });
            
            // Toolbar button actions
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const action = this.dataset.action;
                    console.log('Toolbar button clicked:', action);
                    applyTextFormatting(action);
                });
            });
            
            // Font family change
            document.getElementById('toolbar-font-family').addEventListener('change', function() {
                if (currentTextElement) {
                    currentTextElement.style.fontFamily = this.value;
                    console.log('Font family changed to:', this.value);
                }
            });
            
            // Font size change
            document.getElementById('toolbar-font-size').addEventListener('input', function() {
                if (currentTextElement) {
                    currentTextElement.style.fontSize = this.value + 'px';
                    console.log('Font size changed to:', this.value + 'px');
                }
            });
            
            // Text color change
            document.getElementById('toolbar-text-color').addEventListener('input', function() {
                if (currentTextElement) {
                    currentTextElement.style.color = this.value;
                    console.log('Text color changed to:', this.value);
                }
            });
            
            // Letter spacing change
            document.getElementById('toolbar-letter-spacing').addEventListener('input', function() {
                if (currentTextElement) {
                    currentTextElement.style.letterSpacing = this.value + 'px';
                    console.log('Letter spacing changed to:', this.value + 'px');
                }
            });
        }
        
        function showTextToolbar(element, event) {
            // Don't show toolbar for toolbar elements, tab buttons, component items, or builder tools
            if (element.closest('#text-toolbar') || 
                element.closest('.toolbar') ||
                element.closest('.builder-tools') ||
                element.closest('.component-item') ||
                element.classList.contains('toolbar-btn') ||
                element.classList.contains('tool-tab') ||
                element.classList.contains('component-item') ||
                element.dataset.action ||
                element.dataset.tab ||
                element.onclick) {
                console.log('Skipping toolbar display for toolbar/tab/component element');
                return;
            }
            
            const toolbar = document.getElementById('text-toolbar');
            currentTextElement = element;
            
            console.log('Showing toolbar for element:', element, 'Tag:', element.tagName);
            
            // Position toolbar above the clicked element
            const rect = element.getBoundingClientRect();
            const toolbarHeight = 50; // Approximate height
            
            toolbar.style.left = Math.max(10, rect.left) + 'px';
            toolbar.style.top = Math.max(10, rect.top - toolbarHeight - 10) + 'px';
            toolbar.style.display = 'block';
            
            // Update toolbar values based on current element
            const computedStyle = window.getComputedStyle(element);
            
            // Update font size
            const fontSize = parseInt(computedStyle.fontSize) || 16;
            document.getElementById('toolbar-font-size').value = fontSize;
            
            // Update text color
            const color = rgbToHex(computedStyle.color);
            document.getElementById('toolbar-text-color').value = color;
            
            // Update font family if matches
            const fontFamily = computedStyle.fontFamily;
            const fontSelect = document.getElementById('toolbar-font-family');
            for (let option of fontSelect.options) {
                if (fontFamily.includes(option.text) || fontFamily.includes(option.value)) {
                    fontSelect.value = option.value;
                    break;
                }
            }
            
            // Update letter spacing
            const letterSpacing = parseFloat(computedStyle.letterSpacing) || 0;
            document.getElementById('toolbar-letter-spacing').value = letterSpacing;
            
            console.log('Toolbar updated with:', {
                fontSize: fontSize,
                color: color,
                fontFamily: fontFamily,
                letterSpacing: letterSpacing
            });
            
            event.stopPropagation();
        }
        
        function applyTextFormatting(action) {
            if (!currentTextElement) {
                console.log('No current text element selected');
                return;
            }
            
            console.log('Applying formatting:', action, 'to element:', currentTextElement);
            
            switch(action) {
                case 'bold':
                    const currentWeight = window.getComputedStyle(currentTextElement).fontWeight;
                    const isBold = currentWeight === '700' || currentWeight === 'bold' || parseInt(currentWeight) >= 700;
                    currentTextElement.style.fontWeight = isBold ? 'normal' : 'bold';
                    console.log('Bold toggled:', !isBold);
                    break;
                case 'italic':
                    const currentStyle = window.getComputedStyle(currentTextElement).fontStyle;
                    currentTextElement.style.fontStyle = currentStyle === 'italic' ? 'normal' : 'italic';
                    console.log('Italic toggled:', currentStyle !== 'italic');
                    break;
                case 'underline':
                    const currentDecoration = window.getComputedStyle(currentTextElement).textDecoration;
                    currentTextElement.style.textDecoration = currentDecoration.includes('underline') ? 'none' : 'underline';
                    console.log('Underline toggled:', !currentDecoration.includes('underline'));
                    break;
                case 'align-left':
                    currentTextElement.style.textAlign = 'left';
                    console.log('Text aligned left');
                    break;
                case 'align-center':
                    currentTextElement.style.textAlign = 'center';
                    console.log('Text aligned center');
                    break;
                case 'align-right':
                    currentTextElement.style.textAlign = 'right';
                    console.log('Text aligned right');
                    break;
                case 'size-increase':
                    const currentSize = parseInt(document.getElementById('toolbar-font-size').value) || 16;
                    const newSize = Math.min(120, currentSize + 2);
                    document.getElementById('toolbar-font-size').value = newSize;
                    currentTextElement.style.fontSize = newSize + 'px';
                    console.log('Font size increased to:', newSize);
                    break;
                case 'size-decrease':
                    const currSize = parseInt(document.getElementById('toolbar-font-size').value) || 16;
                    const smallerSize = Math.max(8, currSize - 2);
                    document.getElementById('toolbar-font-size').value = smallerSize;
                    currentTextElement.style.fontSize = smallerSize + 'px';
                    console.log('Font size decreased to:', smallerSize);
                    break;
                case 'convert-to-link':
                    convertTextToPageLink();
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }
        
        function rgbToHex(rgb) {
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000';
            
            function hex(x) {
                return ("0" + parseInt(x).toString(16)).slice(-2);
            }
            return "#" + hex(match[1]) + hex(match[2]) + hex(match[3]);
        }
        
        function convertTextToPageLink() {
            if (!currentTextElement) return;
            
            // Get all available pages including subpages
            const allPages = [];
            
            // Add main pages
            Object.keys(pages).forEach(pageId => {
                allPages.push({
                    id: pageId,
                    name: pages[pageId].name || pageId,
                    isSubPage: false
                });
            });
            
            // Add subpages
            Object.keys(subPages).forEach(parentId => {
                subPages[parentId].forEach(subPageId => {
                    allPages.push({
                        id: subPageId,
                        name: `${pages[parentId]?.name || parentId} > ${pages[subPageId]?.name || subPageId}`,
                        isSubPage: true
                    });
                });
            });
            
            // Create page selection modal
            const pageOptions = allPages.map(page => 
                `<option value="${page.id}">${page.name}</option>`
            ).join('');
            
            const modal = document.createElement('div');
            modal.className = 'page-link-modal';
            modal.innerHTML = `
                <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #2d3748;">Convert Text to Page Link</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 500;">Link to Page:</label>
                            <select id="page-link-select" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <option value="">Select a page...</option>
                                ${pageOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="open-new-tab">
                                <span style="color: #4a5568;">Open in new tab</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closePageLinkModal()" style="padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                            <button onclick="applyPageLink()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Create Link</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click-outside-to-close functionality
            const overlay = modal.querySelector('.modal-overlay');
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closePageLinkModal();
                }
            });
            
            // Prevent modal content clicks from closing the modal
            const modalContent = modal.querySelector('.modal-content');
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            document.body.appendChild(modal);
        }
        
        function closePageLinkModal() {
            const modal = document.querySelector('.page-link-modal');
            if (modal) {
                modal.remove();
            }
        }

        function applyPageLink() {
            const selectedPage = document.getElementById('page-link-select').value;
            const openNewTab = document.getElementById('open-new-tab').checked;
            
            if (!selectedPage || !currentTextElement) {
                closePageLinkModal();
                return;
            }
            
            // Convert text element to a clickable link
            const originalText = currentTextElement.textContent;
            const originalStyles = window.getComputedStyle(currentTextElement);
            
            // Create a new button element that looks like text but acts like a link
            const linkElement = document.createElement('a');
            linkElement.textContent = originalText;
            linkElement.href = 'javascript:void(0)';
            linkElement.onclick = function() { 
                switchToPageNew(selectedPage); 
                return false; 
            };
            
            // Copy all styles from original element
            linkElement.style.cssText = `
                color: ${originalStyles.color};
                font-family: ${originalStyles.fontFamily};
                font-size: ${originalStyles.fontSize};
                font-weight: ${originalStyles.fontWeight};
                font-style: ${originalStyles.fontStyle};
                text-decoration: underline;
                text-align: ${originalStyles.textAlign};
                letter-spacing: ${originalStyles.letterSpacing};
                cursor: pointer;
                background: none;
                border: none;
                padding: 0;
                margin: 0;
                display: ${originalStyles.display};
            `;
            
            // Replace the original element
            currentTextElement.parentNode.replaceChild(linkElement, currentTextElement);
            
            // Update currentTextElement reference
            currentTextElement = linkElement;
            
            // Hide toolbar and close modal
            document.getElementById('text-toolbar').style.display = 'none';
            closePageLinkModal();
            
            console.log(`Text converted to page link: "${originalText}" -> ${selectedPage}`);
        }
        
        // Initialize text editing with comprehensive toolbar support
        function initializeTextEditingWithToolbar() {
            // Text editing with floating toolbar
            document.querySelectorAll('h1, h2, h3, p, span, button').forEach(element => {
                // Skip if already initialized or is a toolbar element or toolbar button or tab button or component item
                if (element.classList.contains('editable-text') || 
                    element.closest('#text-toolbar') || 
                    element.closest('.toolbar') ||
                    element.closest('.builder-tools') ||
                    element.closest('.component-item') ||
                    element.classList.contains('toolbar-btn') ||
                    element.classList.contains('tool-tab') ||
                    element.classList.contains('component-item') ||
                    element.dataset.action ||
                    element.dataset.tab ||
                    element.onclick) return;
                
                element.classList.add('editable-text');
                element.style.cursor = 'text';
                
                element.addEventListener('click', function(e) {
                    // Don't trigger on toolbar buttons, tab buttons, component items, or their children
                    if (e.target.closest('#text-toolbar') || 
                        e.target.closest('.toolbar') ||
                        e.target.closest('.builder-tools') ||
                        e.target.closest('.component-item') ||
                        e.target.classList.contains('toolbar-btn') ||
                        e.target.classList.contains('tool-tab') ||
                        e.target.classList.contains('component-item') ||
                        e.target.dataset.action ||
                        e.target.dataset.tab ||
                        e.target.closest('[data-action]') ||
                        e.target.closest('[data-tab]') ||
                        e.target.onclick) {
                        console.log('Skipping toolbar/tab/component element click');
                        return;
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                    
                    console.log('Text element clicked:', this.tagName, this.textContent.substring(0, 50));
                    
                    // Show floating toolbar for text elements
                    showTextToolbar(this, e);
                    
                    // Make text editable
                    if (this.contentEditable !== 'true') {
                        this.contentEditable = 'true';
                        this.focus();
                        
                        // Select all text for easy replacement
                        setTimeout(() => {
                            const range = document.createRange();
                            range.selectNodeContents(this);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }, 10);
                    }
                });
                
                element.addEventListener('blur', function() {
                    this.contentEditable = 'false';
                    console.log('Text saved:', this.textContent);
                });
                
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
            
            // Image replacement (existing code)
            document.querySelectorAll('img').forEach(img => {
                if (img.dataset.editableImage === 'true') return;
                img.dataset.editableImage = 'true';
                img.style.cursor = 'grab'; // Images are for repositioning, not uploading
                
                // Image click disabled - only camera buttons trigger uploads
                // Images are for repositioning via drag only
            });
            
            // Background image editing (existing code)
            document.querySelectorAll('[style*="background-image"]').forEach(element => {
                if (element.dataset.editableBg === 'true') return;
                element.dataset.editableBg = 'true';
                
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    z-index: 10;
                `;
                overlay.innerHTML = '<button style="background: white; padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer;">Change Background</button>';
                
                element.style.position = 'relative';
                element.appendChild(overlay);
                
                element.addEventListener('mouseenter', () => {
                    overlay.style.display = 'flex';
                });
                
                element.addEventListener('mouseleave', () => {
                    overlay.style.display = 'none';
                });
                
                overlay.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = function(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                element.style.backgroundImage = `url('${e.target.result}')`;
                                console.log('Background image changed');
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                });
            });
            
            // Initialize block dragging (placeholder for existing functionality)
            // initializeBlockDragging(); // Commented out until properly implemented
        }

        // Style tab functions
        function applyThemeColor(type, color) {
            const canvas = document.getElementById('canvas');
            console.log(`Applying ${type} color: ${color}`);
            
            switch(type) {
                case 'background':
                    canvas.style.backgroundColor = color;
                    // Apply to all elements with background
                    document.querySelectorAll('.element').forEach(el => {
                        if (el.style.backgroundColor || el.dataset.type === 'hero' || el.dataset.type === 'hero-text') {
                            el.style.backgroundColor = color;
                        }
                    });
                    break;
                case 'text':
                    // Apply to all text elements
                    document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a').forEach(el => {
                        if (!el.closest('.toolbar') && !el.closest('.builder-tools')) {
                            el.style.color = color;
                        }
                    });
                    break;
                case 'accent':
                    // Apply to buttons and accent elements
                    document.querySelectorAll('button, .accent, [style*="background: #667eea"], [style*="color: #667eea"]').forEach(el => {
                        if (!el.closest('.toolbar') && !el.closest('.builder-tools')) {
                            if (el.tagName === 'BUTTON' || el.classList.contains('accent')) {
                                el.style.backgroundColor = color;
                            } else {
                                el.style.color = color;
                            }
                        }
                    });
                    break;
            }
        }

        function applyEffect(type, value) {
            const selectedElement = document.querySelector('.element.selected') || document.getElementById('canvas');
            console.log(`Applying ${type} effect: ${value}`);
            
            switch(type) {
                case 'overlay':
                    document.getElementById('overlay-value').textContent = `${value}%`;
                    // Apply overlay to background images
                    document.querySelectorAll('[style*="background-image"]').forEach(el => {
                        if (!el.closest('.toolbar') && !el.closest('.builder-tools')) {
                            const opacity = value / 100;
                            const existingBg = el.style.backgroundImage;
                            if (existingBg.includes('linear-gradient')) {
                                // Replace existing gradient
                                const imageUrl = existingBg.split('), url(')[1];
                                if (imageUrl) {
                                    el.style.backgroundImage = `linear-gradient(rgba(0,0,0,${opacity}), rgba(0,0,0,${opacity})), url(${imageUrl}`;
                                }
                            } else if (existingBg.includes('url(')) {
                                // Add gradient overlay
                                el.style.backgroundImage = `linear-gradient(rgba(0,0,0,${opacity}), rgba(0,0,0,${opacity})), ${existingBg}`;
                            }
                        }
                    });
                    break;
                case 'blur':
                    document.getElementById('blur-value').textContent = `${value}px`;
                    if (selectedElement) {
                        selectedElement.style.filter = `blur(${value}px)`;
                    }
                    break;
                case 'shadow':
                    document.getElementById('shadow-value').textContent = `${value}px`;
                    if (selectedElement) {
                        selectedElement.style.boxShadow = `0 ${value}px ${value * 2}px rgba(0,0,0,0.1)`;
                    }
                    break;
                case 'animation':
                    if (selectedElement) {
                        selectedElement.classList.remove('fade-in', 'slide-in', 'zoom-in');
                        if (value !== 'none') {
                            selectedElement.classList.add(`${value}-in`);
                        }
                    }
                    break;
            }
        }

        function applyLayoutProperty(type, value) {
            const selectedElement = document.querySelector('.element.selected');
            if (!selectedElement) {
                console.log('No element selected for layout changes');
                return;
            }
            
            console.log(`Applying ${type} layout: ${value}`);
            
            switch(type) {
                case 'padding':
                    document.getElementById('padding-value').textContent = `${value}px`;
                    selectedElement.style.padding = `${value}px`;
                    break;
                case 'margin':
                    document.getElementById('margin-value').textContent = `${value}px`;
                    selectedElement.style.margin = `${value}px`;
                    break;
                case 'gap':
                    document.getElementById('gap-value').textContent = `${value}px`;
                    selectedElement.style.gap = `${value}px`;
                    break;
                case 'horizontal':
                    selectedElement.style.textAlign = value;
                    if (selectedElement.style.display === 'flex' || selectedElement.style.display === 'grid') {
                        selectedElement.style.justifyContent = value === 'center' ? 'center' : `flex-${value === 'left' ? 'start' : 'end'}`;
                    }
                    break;
                case 'vertical':
                    if (selectedElement.style.display === 'flex' || selectedElement.style.display === 'grid') {
                        selectedElement.style.alignItems = value === 'middle' ? 'center' : `flex-${value === 'top' ? 'start' : 'end'}`;
                    }
                    break;
                case 'width':
                    document.getElementById('width-value').textContent = `${value}%`;
                    selectedElement.style.width = `${value}%`;
                    break;
                case 'height':
                    document.getElementById('height-value').textContent = `${value}px`;
                    selectedElement.style.height = `${value}px`;
                    break;
            }
        }

        // Add component function for click functionality
        function addComponent(componentType) {
            const canvas = document.getElementById('canvas');
            if (!canvas) {
                console.error('Canvas not found');
                return;
            }
            
            console.log(`Adding component: ${componentType}`);
            
            // Check if componentTemplates has the component
            if (typeof componentTemplates[componentType] === 'function') {
                const componentHTML = componentTemplates[componentType]();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = componentHTML;
                const element = tempDiv.firstElementChild;
                
                if (element) {
                    // Assign unique ID if not present
                    if (!element.id) {
                        element.id = 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    canvas.appendChild(element);
                    console.log(`Component ${componentType} added successfully with ID: ${element.id}`);
                    
                    // Add hover delete functionality to new component
                    addHoverDeleteToElement(element);
                    // Add hover photo change functionality to new component  
                    addHoverPhotoChangeToElement(element);
                    
                    // Initialize any special functionality for the new component
                    if (componentType === 'hero-carousel') {
                        // Get the carousel ID from the newly added element
                        const carouselElement = element.querySelector('[data-carousel-id]');
                        if (carouselElement) {
                            const carouselId = carouselElement.dataset.carouselId;
                            // Initialize carousel state
                            carouselStates[carouselId] = { currentSlide: 0 };
                            console.log(`Carousel ${carouselId} initialized with state`, carouselStates[carouselId]);
                            
                            // Test if the navigation buttons are working
                            setTimeout(() => {
                                const container = document.getElementById(carouselId + '-container');
                                const slides = container?.querySelectorAll('.carousel-slide');
                                console.log(`Carousel ${carouselId} has ${slides?.length || 0} slides`);
                                console.log(`Container found:`, !!container);
                            }, 100);
                        }
                        // Initialize carousel hover effects for new carousels
                        initializeCarouselHover();
                    }
                    
                    // Ensure all editable aspects are applied to the new component
                    setupElementSelection();
                    initializeTouchToEdit();
                    // Make sure text elements are editable with full formatting options
                    makeTextEditable();
                    // Make sure images are editable
                    makeImagesEditable();
                    // Make sure blocks are draggable
                    makeBlocksDraggable();
                    // Make sure components are selectable
                    makeComponentsSelectable();
                } else {
                    console.error(`Failed to create element for component: ${componentType}`);
                }
            } else {
                console.error(`Component template not found: ${componentType}`);
            }
        }

        // Carousel functionality
        let carouselStates = {};

        function nextSlide(carouselId) {
            console.log(`Next slide clicked for carousel: ${carouselId}`);
            const container = document.getElementById(carouselId + '-container');
            if (!container) {
                console.error(`Container not found: ${carouselId}-container`);
                return;
            }
            
            const slides = container.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            console.log(`Total slides: ${totalSlides}`);
            
            if (!carouselStates[carouselId]) {
                carouselStates[carouselId] = { currentSlide: 0 };
                console.log(`Initialized carousel state for: ${carouselId}`);
            }
            
            const oldSlide = carouselStates[carouselId].currentSlide;
            carouselStates[carouselId].currentSlide = (carouselStates[carouselId].currentSlide + 1) % totalSlides;
            console.log(`Moving from slide ${oldSlide} to ${carouselStates[carouselId].currentSlide}`);
            
            updateCarousel(carouselId);
        }

        function prevSlide(carouselId) {
            console.log(`Previous slide clicked for carousel: ${carouselId}`);
            const container = document.getElementById(carouselId + '-container');
            if (!container) {
                console.error(`Container not found: ${carouselId}-container`);
                return;
            }
            
            const slides = container.querySelectorAll('.carousel-slide');
            const totalSlides = slides.length;
            console.log(`Total slides: ${totalSlides}`);
            
            if (!carouselStates[carouselId]) {
                carouselStates[carouselId] = { currentSlide: 0 };
                console.log(`Initialized carousel state for: ${carouselId}`);
            }
            
            const oldSlide = carouselStates[carouselId].currentSlide;
            carouselStates[carouselId].currentSlide = (carouselStates[carouselId].currentSlide - 1 + totalSlides) % totalSlides;
            console.log(`Moving from slide ${oldSlide} to ${carouselStates[carouselId].currentSlide}`);
            
            updateCarousel(carouselId);
        }

        function goToSlide(carouselId, slideIndex) {
            if (!carouselStates[carouselId]) {
                carouselStates[carouselId] = { currentSlide: 0 };
            }
            
            carouselStates[carouselId].currentSlide = slideIndex;
            updateCarousel(carouselId);
        }

        function updateCarousel(carouselId) {
            const container = document.getElementById(carouselId + '-container');
            if (!container) {
                console.error(`Carousel container not found: ${carouselId}`);
                return;
            }
            
            const slides = container.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll(`[data-carousel-id="${carouselId}"] .carousel-dot`);
            const currentSlide = carouselStates[carouselId].currentSlide;
            
            console.log(`Updating carousel ${carouselId} to slide ${currentSlide} of ${slides.length}`);
            
            // Move slides - each slide takes up the full container width divided by number of slides
            const slideWidth = 100 / slides.length;
            const translateX = -currentSlide * slideWidth;
            container.style.transform = `translateX(${translateX}%)`;
            
            // Update dots
            dots.forEach((dot, index) => {
                if (index === currentSlide) {
                    dot.style.background = 'white';
                    dot.style.opacity = '1';
                } else {
                    dot.style.background = 'transparent';
                    dot.style.opacity = '0.7';
                }
            });
        }

        function editCarouselImage(carouselId, slideIndex) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const slide = document.querySelector(`[data-carousel-id="${carouselId}"] .carousel-slide[data-slide="${slideIndex}"]`);
                        if (slide) {
                            const currentBg = slide.style.backgroundImage;
                            const newBg = currentBg.replace(/url\([^)]+\)/, `url('${e.target.result}')`);
                            slide.style.backgroundImage = newBg;
                            console.log(`Carousel image ${slideIndex} updated`);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function addCarouselImage(carouselId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const carouselElement = document.querySelector(`[data-carousel-id="${carouselId}"]`);
                        const container = document.getElementById(carouselId + '-container');
                        const slides = container.querySelectorAll('.carousel-slide');
                        const newIndex = slides.length;
                        
                        // Create new slide
                        const newSlide = document.createElement('div');
                        newSlide.className = 'carousel-slide';
                        newSlide.setAttribute('data-slide', newIndex);
                        newSlide.style.cssText = `min-width: ${100/(newIndex + 1)}%; height: 500px; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('${e.target.result}'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: white; position: relative;`;
                        
                        newSlide.innerHTML = `
                            <div class="image-edit-overlay" style="position: absolute; top: 10px; right: 10px; opacity: 1; transition: none;">
                                <button onclick="editCarouselImage('${carouselId}', ${newIndex})" style="background: rgba(255,255,255,0.9); border: none; color: #333; padding: 8px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">✏️ Edit</button>
                                <button onclick="removeCarouselImage('${carouselId}', ${newIndex})" style="background: rgba(255,0,0,0.9); border: none; color: white; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                            </div>
                            <div style="text-align: center; z-index: 2;">
                                <h1 style="font-size: 3rem; margin-bottom: 20px; color: white; font-family: 'Playfair Display', serif;">New Image</h1>
                                <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9);">Click to edit this text</p>
                            </div>
                        `;
                        
                        container.appendChild(newSlide);
                        
                        // Update container width
                        container.style.width = `${(newIndex + 1) * 100}%`;
                        
                        // Update all slide widths
                        container.querySelectorAll('.carousel-slide').forEach(slide => {
                            slide.style.minWidth = `${100/(newIndex + 1)}%`;
                        });
                        
                        // Add new dot
                        const dotsContainer = carouselElement.querySelector('.carousel-dots');
                        const newDot = document.createElement('button');
                        newDot.className = 'carousel-dot';
                        newDot.setAttribute('data-slide', newIndex);
                        newDot.style.cssText = 'width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; background: transparent; cursor: pointer; transition: all 0.3s;';
                        newDot.onclick = () => goToSlide(carouselId, newIndex);
                        dotsContainer.appendChild(newDot);
                        
                        // Go to new slide
                        goToSlide(carouselId, newIndex);
                        
                        console.log(`New image added to carousel ${carouselId}`);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function removeCarouselImage(carouselId, slideIndex) {
            const container = document.getElementById(carouselId + '-container');
            const slides = container.querySelectorAll('.carousel-slide');
            
            if (slides.length <= 1) {
                alert('Cannot remove the last image from carousel');
                return;
            }
            
            const slideToRemove = container.querySelector(`[data-slide="${slideIndex}"]`);
            if (slideToRemove) {
                slideToRemove.remove();
                
                // Remove corresponding dot
                const carouselElement = document.querySelector(`[data-carousel-id="${carouselId}"]`);
                const dotToRemove = carouselElement.querySelector(`.carousel-dot[data-slide="${slideIndex}"]`);
                if (dotToRemove) {
                    dotToRemove.remove();
                }
                
                // Re-index remaining slides and dots
                const remainingSlides = container.querySelectorAll('.carousel-slide');
                const remainingDots = carouselElement.querySelectorAll('.carousel-dot');
                
                remainingSlides.forEach((slide, index) => {
                    slide.setAttribute('data-slide', index);
                    slide.style.minWidth = `${100/remainingSlides.length}%`;
                    
                    // Update edit and remove button onclick
                    const editBtn = slide.querySelector('button[onclick*="editCarouselImage"]');
                    const removeBtn = slide.querySelector('button[onclick*="removeCarouselImage"]');
                    if (editBtn) editBtn.setAttribute('onclick', `editCarouselImage('${carouselId}', ${index})`);
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeCarouselImage('${carouselId}', ${index})`);
                });
                
                remainingDots.forEach((dot, index) => {
                    dot.setAttribute('data-slide', index);
                    dot.onclick = () => goToSlide(carouselId, index);
                });
                
                // Update container width
                container.style.width = `${remainingSlides.length * 100}%`;
                
                // Adjust current slide if necessary
                if (carouselStates[carouselId] && carouselStates[carouselId].currentSlide >= remainingSlides.length) {
                    carouselStates[carouselId].currentSlide = remainingSlides.length - 1;
                }
                
                updateCarousel(carouselId);
                console.log(`Image ${slideIndex} removed from carousel ${carouselId}`);
            }
        }

        // Add hover effects for carousel edit buttons
        function initializeCarouselHover() {
            document.addEventListener('mouseover', function(e) {
                if (e.target.closest('.carousel-slide')) {
                    const overlay = e.target.closest('.carousel-slide').querySelector('.image-edit-overlay');
                    if (overlay) overlay.style.opacity = '1';
                }
            });
            
            document.addEventListener('mouseout', function(e) {
                if (e.target.closest('.carousel-slide')) {
                    const overlay = e.target.closest('.carousel-slide').querySelector('.image-edit-overlay');
                    if (overlay) overlay.style.opacity = '0';
                }
            });
        }

        // Add CSS for animations
        const animationStyles = document.createElement('style');
        animationStyles.textContent = `
            .fade-in { animation: fadeIn 0.6s ease-in-out; }
            .slide-in { animation: slideIn 0.6s ease-in-out; }
            .zoom-in { animation: zoomIn 0.6s ease-in-out; }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideIn {
                from { transform: translateY(30px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            @keyframes zoomIn {
                from { transform: scale(0.9); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(animationStyles);
        
        // Test function to verify carousel functions exist
        function testCarouselFunctions() {
            console.log('Testing carousel functions:');
            console.log('nextSlide exists:', typeof nextSlide === 'function');
            console.log('prevSlide exists:', typeof prevSlide === 'function');
            console.log('goToSlide exists:', typeof goToSlide === 'function');
            console.log('editCarouselImage exists:', typeof editCarouselImage === 'function');
            console.log('addCarouselImage exists:', typeof addCarouselImage === 'function');
            console.log('removeCarouselImage exists:', typeof removeCarouselImage === 'function');
        }

        // Style Tab Functions
        function applyThemeColor(type, value) {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            console.log(`Applying theme color: ${type} = ${value}`);
            
            switch(type) {
                case 'background':
                    canvas.style.backgroundColor = value;
                    // Also update all sections with default backgrounds
                    canvas.querySelectorAll('.element').forEach(element => {
                        if (element.style.backgroundColor === '' || element.style.backgroundColor === 'white' || element.style.backgroundColor === '#ffffff') {
                            element.style.backgroundColor = value;
                        }
                    });
                    break;
                case 'text':
                    canvas.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div').forEach(element => {
                        if (!element.style.color || element.style.color === '#2d3748' || element.style.color === 'rgb(45, 55, 72)') {
                            element.style.color = value;
                        }
                    });
                    break;
                case 'accent':
                    canvas.querySelectorAll('button, .btn, a').forEach(element => {
                        if (!element.style.backgroundColor || element.style.backgroundColor === '#667eea' || element.style.backgroundColor === 'rgb(102, 126, 234)') {
                            element.style.backgroundColor = value;
                        }
                    });
                    // Update gradients too
                    canvas.querySelectorAll('[style*="linear-gradient"]').forEach(element => {
                        const currentStyle = element.style.backgroundImage;
                        if (currentStyle.includes('#667eea')) {
                            element.style.backgroundImage = currentStyle.replace(/#667eea/g, value);
                        }
                    });
                    break;
            }
        }

        function applyEffect(type, value) {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            console.log(`Applying effect: ${type} = ${value}`);
            
            // Update the display value
            const displayElement = document.getElementById(`${type}-value`);
            if (displayElement) {
                switch(type) {
                    case 'overlay':
                        displayElement.textContent = `${value}%`;
                        // Apply overlay to hero sections
                        canvas.querySelectorAll('.hero-section, .carousel-slide').forEach(element => {
                            const currentBg = element.style.backgroundImage;
                            if (currentBg && currentBg.includes('url(')) {
                                const opacity = value / 100;
                                if (currentBg.includes('linear-gradient')) {
                                    // Update existing gradient
                                    element.style.backgroundImage = currentBg.replace(/rgba\(0,0,0,[^)]+\)/g, `rgba(0,0,0,${opacity})`);
                                } else {
                                    // Add gradient overlay
                                    const urlMatch = currentBg.match(/url\([^)]+\)/);
                                    if (urlMatch) {
                                        element.style.backgroundImage = `linear-gradient(rgba(0,0,0,${opacity}), rgba(0,0,0,${opacity})), ${urlMatch[0]}`;
                                    }
                                }
                            }
                        });
                        break;
                    case 'blur':
                        displayElement.textContent = `${value}px`;
                        canvas.querySelectorAll('img').forEach(img => {
                            img.style.filter = `blur(${value}px)`;
                        });
                        break;
                    case 'shadow':
                        displayElement.textContent = `${value}px`;
                        canvas.querySelectorAll('.element').forEach(element => {
                            element.style.boxShadow = `0 ${value}px ${value * 2}px rgba(0,0,0,0.1)`;
                        });
                        break;
                    case 'animation':
                        canvas.querySelectorAll('.element').forEach(element => {
                            element.classList.remove('fade-in', 'slide-in', 'zoom-in');
                            if (value !== 'none') {
                                element.classList.add(`${value}-in`);
                            }
                        });
                        break;
                }
            }
        }

        function applyLayoutProperty(type, value) {
            const selectedElement = document.querySelector('.element.selected');
            if (!selectedElement) {
                console.log('No element selected for layout changes');
                return;
            }
            
            console.log(`Applying layout property: ${type} = ${value}`);
            
            // Update the display value
            const displayElement = document.getElementById(`${type}-value`);
            if (displayElement) {
                switch(type) {
                    case 'padding':
                        displayElement.textContent = `${value}px`;
                        selectedElement.style.padding = `${value}px`;
                        break;
                    case 'margin':
                        displayElement.textContent = `${value}px`;
                        selectedElement.style.margin = `${value}px`;
                        break;
                    case 'gap':
                        displayElement.textContent = `${value}px`;
                        if (selectedElement.querySelector('[style*="grid"]') || selectedElement.querySelector('[style*="flex"]')) {
                            selectedElement.style.gap = `${value}px`;
                        }
                        break;
                    case 'width':
                        displayElement.textContent = `${value}%`;
                        selectedElement.style.width = `${value}%`;
                        break;
                    case 'height':
                        displayElement.textContent = `${value}px`;
                        selectedElement.style.height = `${value}px`;
                        break;
                    case 'horizontal':
                        switch(value) {
                            case 'left':
                                selectedElement.style.textAlign = 'left';
                                selectedElement.style.justifyContent = 'flex-start';
                                break;
                            case 'center':
                                selectedElement.style.textAlign = 'center';
                                selectedElement.style.justifyContent = 'center';
                                break;
                            case 'right':
                                selectedElement.style.textAlign = 'right';
                                selectedElement.style.justifyContent = 'flex-end';
                                break;
                        }
                        break;
                    case 'vertical':
                        switch(value) {
                            case 'top':
                                selectedElement.style.alignItems = 'flex-start';
                                break;
                            case 'middle':
                                selectedElement.style.alignItems = 'center';
                                break;
                            case 'bottom':
                                selectedElement.style.alignItems = 'flex-end';
                                break;
                        }
                        break;
                }
            }
        }

        // Element deletion functionality
        function deleteElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // Show confirmation dialog
                if (confirm('Are you sure you want to delete this element?')) {
                    // Remove from imagePositioning if it exists
                    if (imagePositioning[elementId]) {
                        delete imagePositioning[elementId];
                    }
                    
                    // Remove the element from DOM
                    element.remove();
                    
                    // Clear selection if this was selected
                    if (selectedElement && selectedElement.id === elementId) {
                        selectedElement = null;
                        clearElementSelection();
                    }
                    
                    console.log('Element deleted:', elementId);
                    
                    // Clear properties panel
                    const propertiesContent = document.getElementById('properties-content');
                    if (propertiesContent) {
                        propertiesContent.innerHTML = `
                            <div class="tool-section">
                                <div class="tool-title">Element Properties</div>
                                <p style="color: #718096; font-size: 14px; text-align: center; padding: 20px;">Select an element to edit its properties</p>
                            </div>
                        `;
                    }
                }
            }
        }

        function clearElementSelection() {
            // Remove selection class from all elements
            document.querySelectorAll('.element-selected').forEach(el => {
                el.classList.remove('element-selected');
            });
            
            // Remove all delete buttons
            document.querySelectorAll('.delete-button').forEach(btn => {
                btn.remove();
            });
        }

        function selectElement(element) {
            // Clear any existing selections
            clearElementSelection();
            
            // Add selection class
            element.classList.add('element-selected');
            
            // Create and add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-button';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = 'Delete Element';
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                deleteElement(element.id);
            };
            
            // Position delete button
            element.style.position = 'relative';
            element.appendChild(deleteBtn);
            
            // Store selected element
            selectedElement = element;
            
            console.log('Element selected:', element.id);
        }

        // Add hover change photo functionality to images
        function addHoverPhotoChangeToElement(element) {
            // Skip if already has hover photo change or if not an image element
            if (element.dataset.hasHoverPhotoChange) return;
            
            // Check if this element contains images
            const img = element.querySelector('img') || (element.tagName === 'IMG' ? element : null);
            const hasBackgroundImage = element.style.backgroundImage && element.style.backgroundImage !== 'none';
            
            if (!img && !hasBackgroundImage) return;
            
            element.dataset.hasHoverPhotoChange = 'true';
            
            let changePhotoButton = null;
            
            // Show change photo button on hover
            element.addEventListener('mouseenter', function() {
                // Skip if this is a toolbar or button area
                if (element.closest('.builder-tools') || 
                    element.closest('.floating-toolbar') ||
                    element.closest('.edit-toolbar')) {
                    return;
                }
                
                if (!changePhotoButton) {
                    changePhotoButton = document.createElement('button');
                    changePhotoButton.className = 'change-photo-button hover-photo';
                    changePhotoButton.innerHTML = '📷';
                    changePhotoButton.title = 'Change Photo';
                    changePhotoButton.style.cssText = `
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        width: 32px;
                        height: 32px;
                        background: #4299e1;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        line-height: 1;
                    `;
                    
                    changePhotoButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        console.log('Change photo button clicked for element:', element.id);
                        
                        // Create file input
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = function(event) {
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imageUrl = e.target.result;
                                    
                                    // Find and update the image
                                    const targetImg = element.querySelector('img') || (element.tagName === 'IMG' ? element : null);
                                    if (targetImg) {
                                        targetImg.src = imageUrl;
                                        console.log('Updated img src');
                                    } else if (hasBackgroundImage) {
                                        // Update background image
                                        const currentBg = element.style.backgroundImage;
                                        if (currentBg.includes('linear-gradient')) {
                                            // Preserve gradient overlay
                                            const gradientMatch = currentBg.match(/linear-gradient\([^)]+\)/);
                                            if (gradientMatch) {
                                                element.style.backgroundImage = `${gradientMatch[0]}, url('${imageUrl}')`;
                                            } else {
                                                element.style.backgroundImage = `url('${imageUrl}')`;
                                            }
                                        } else {
                                            element.style.backgroundImage = `url('${imageUrl}')`;
                                        }
                                        console.log('Updated background image');
                                    }
                                    
                                    console.log('Photo changed successfully');
                                };
                                reader.readAsDataURL(file);
                            }
                        };
                        input.click();
                    });
                    
                    // Keep button visible when hovering over it
                    changePhotoButton.addEventListener('mouseenter', function() {
                        changePhotoButton.style.opacity = '1';
                    });
                    
                    element.appendChild(changePhotoButton);
                }
                
                // Ensure element is positioned relative
                if (getComputedStyle(element).position === 'static') {
                    element.style.position = 'relative';
                }
                
                // Show change photo button
                if (changePhotoButton) {
                    changePhotoButton.style.opacity = '1';
                }
            });
            
            // Hide change photo button when mouse leaves BOTH element and button
            element.addEventListener('mouseleave', function(e) {
                // Only hide if not moving to the change photo button
                setTimeout(() => {
                    if (changePhotoButton && !changePhotoButton.matches(':hover') && !element.matches(':hover')) {
                        changePhotoButton.style.opacity = '0';
                    }
                }, 100);
            });
        }

        // Add hover delete functionality to an element
        function addHoverDeleteToElement(element) {
            // Skip if already has hover delete
            if (element.dataset.hasHoverDelete) return;
            
            element.dataset.hasHoverDelete = 'true';
            
            let deleteButton = null;
            
            // Show delete button on hover
            element.addEventListener('mouseenter', function() {
                // Skip if this is a toolbar or button area
                if (element.closest('.builder-tools') || 
                    element.closest('.floating-toolbar') ||
                    element.closest('.edit-toolbar')) {
                    return;
                }
                
                if (!deleteButton) {
                    deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-button hover-delete';
                    deleteButton.innerHTML = '×';
                    deleteButton.title = 'Delete Element';
                    deleteButton.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        width: 32px;
                        height: 32px;
                        background: #e53e3e;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        font-weight: bold;
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        line-height: 1;
                    `;
                    
                    deleteButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        console.log('Delete button clicked for element:', element.id);
                        
                        // Confirm deletion
                        if (confirm('Are you sure you want to delete this element?')) {
                            console.log('Deleting element:', element.id);
                            
                            // Remove the element directly
                            element.remove();
                            
                            // Clear any selections
                            if (selectedElement && selectedElement.id === element.id) {
                                selectedElement = null;
                                clearElementSelection();
                            }
                            
                            console.log('Element deleted successfully');
                        } else {
                            console.log('Deletion cancelled');
                        }
                    });
                    
                    // Keep button visible when hovering over it
                    deleteButton.addEventListener('mouseenter', function() {
                        deleteButton.style.opacity = '1';
                    });
                    
                    element.appendChild(deleteButton);
                }
                
                // Ensure element is positioned relative
                if (getComputedStyle(element).position === 'static') {
                    element.style.position = 'relative';
                }
                
                // Show delete button
                if (deleteButton) {
                    deleteButton.style.opacity = '1';
                }
            });
            
            // Hide delete button when mouse leaves BOTH element and button
            element.addEventListener('mouseleave', function(e) {
                // Only hide if not moving to the delete button
                setTimeout(() => {
                    if (deleteButton && !deleteButton.matches(':hover') && !element.matches(':hover')) {
                        deleteButton.style.opacity = '0';
                    }
                }, 100);
            });
        }

        // Make all existing elements deletable
        function makeAllElementsDeletable() {
            // Find all component sections and assign IDs if needed
            const selectableClasses = [
                'hero-section', 'gallery-section', 'about-section', 'contact-section',
                'services-section', 'testimonials-section', 'carousel-section', 
                'cta-section', 'featured-gallery-section', 'gallery-grid-section',
                'masonry-section', 'header-section', 'element'
            ];
            
            // Also check for any div with data-type attribute (template components)
            const allElements = [
                ...document.querySelectorAll('.element'),
                ...document.querySelectorAll('[data-type]'),
                ...document.querySelectorAll('.hero-section, .gallery-section, .about-section, .contact-section, .services-section, .testimonials-section, .carousel-section, .cta-section, .featured-gallery-section, .gallery-grid-section, .masonry-section, .header-section')
            ];
            
            // Remove duplicates
            const uniqueElements = [...new Set(allElements)];
            
            uniqueElements.forEach(element => {
                // Skip navigation elements and toolbars
                if (element.closest('.builder-tools') || 
                    element.closest('.floating-toolbar') ||
                    element.closest('.edit-toolbar') ||
                    element.closest('nav')) {
                    return;
                }
                
                if (!element.id) {
                    element.id = 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    console.log(`Assigned ID ${element.id} to existing element`);
                }
                
                // Add hover delete functionality if not already added
                if (!element.dataset.hasHoverDelete) {
                    addHoverDeleteToElement(element);
                }
                
                // Add hover photo change functionality if element has images
                if (!element.dataset.hasHoverPhotoChange) {
                    addHoverPhotoChangeToElement(element);
                }
            });
            
            console.log('All existing elements made deletable with hover');
        }

        // Make all existing elements photo editable (just calls the existing makeAllElementsDeletable function)
        function makeAllElementsPhotoEditable() {
            // This function ensures all elements have photo editing capability
            // The actual functionality is already included in makeAllElementsDeletable()
            // which calls addHoverPhotoChangeToElement() for each element
            console.log('Ensuring all elements have photo editing capability');
        }

        // Enhanced element selection setup
        function setupElementSelection() {
            document.addEventListener('click', function(e) {
                // Skip if clicking on a delete button
                if (e.target.classList.contains('delete-button')) {
                    return;
                }
                
                // Skip if clicking toolbar elements
                if (e.target.closest('.builder-tools') || 
                    e.target.closest('.floating-toolbar') ||
                    e.target.closest('.edit-toolbar')) {
                    return;
                }
                
                let targetElement = e.target;
                
                // Find the closest selectable element
                while (targetElement && targetElement !== document.body) {
                    // Check if this is a component element
                    if (targetElement.classList.contains('hero-section') ||
                        targetElement.classList.contains('gallery-section') ||
                        targetElement.classList.contains('about-section') ||
                        targetElement.classList.contains('contact-section') ||
                        targetElement.classList.contains('services-section') ||
                        targetElement.classList.contains('testimonials-section') ||
                        targetElement.classList.contains('carousel-section') ||
                        targetElement.classList.contains('cta-section') ||
                        targetElement.classList.contains('featured-gallery-section') ||
                        targetElement.classList.contains('gallery-grid-section') ||
                        targetElement.classList.contains('masonry-section') ||
                        targetElement.classList.contains('header-section')) {
                        
                        // Assign ID if not present
                        if (!targetElement.id) {
                            targetElement.id = 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        }
                        
                        selectElement(targetElement);
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    
                    targetElement = targetElement.parentElement;
                }
                
                // If no selectable element found, clear selection
                if (!targetElement || targetElement === document.body) {
                    clearElementSelection();
                    selectedElement = null;
                }
            });
        }

        // Initialize image click handling
        function initializeImageHandling() {
            // Add click handlers to all existing images
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'IMG' && !e.target.closest('.image-edit-overlay')) {
                    e.preventDefault();
                    e.stopPropagation();
                    showImageProperties(e.target);
                    console.log('Image clicked:', e.target.src);
                }
            });
            
            // Add click handlers to background images
            document.addEventListener('click', function(e) {
                const element = e.target;
                if (element.style.backgroundImage && element.style.backgroundImage.includes('url(')) {
                    // Check if this is a background image element that should be editable
                    if (element.classList.contains('carousel-slide') || 
                        element.hasAttribute('data-bg-editable')) {
                        e.preventDefault();
                        e.stopPropagation();
                        showBackgroundImageProperties(element);
                        console.log('Background image clicked:', element.style.backgroundImage);
                    }
                }
            });
            
            console.log('Image click handling initialized');
        }
        
        // Function to handle background images (like in carousels)
        function showBackgroundImageProperties(element) {
            const propertiesContent = document.getElementById('properties-content');
            const elemId = element.id || 'bg-' + Date.now();
            
            if (!element.id) {
                element.id = elemId;
            }
            
            // Initialize positioning if not exists
            if (!imagePositioning[elemId]) {
                imagePositioning[elemId] = {
                    x: 50,
                    y: 50,
                    scale: 100,
                    fit: 'cover'
                };
            }
            
            const config = imagePositioning[elemId];
            
            propertiesContent.innerHTML = `
                <div class="tool-section">
                    <div class="tool-title">Background Image Properties</div>
                    
                    <!-- Image Upload -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Change Background Image</label>
                        <button onclick="changeBackgroundImage('${elemId}')" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Upload New Image
                        </button>
                    </div>
                    
                    <!-- Position Controls -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Background Position</label>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 12px; color: #4a5568; margin-bottom: 5px;">Horizontal Position: <span id="bg-pos-x-display">${config.x}%</span></label>
                                <input type="range" id="bg-position-x" min="0" max="100" value="${config.x}" style="width: 100%;" oninput="updateBackgroundPosition('${elemId}', 'x', this.value)">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 12px; color: #4a5568; margin-bottom: 5px;">Vertical Position: <span id="bg-pos-y-display">${config.y}%</span></label>
                                <input type="range" id="bg-position-y" min="0" max="100" value="${config.y}" style="width: 100%;" oninput="updateBackgroundPosition('${elemId}', 'y', this.value)">
                            </div>
                        </div>
                        
                        <!-- Quick Position Presets -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px;">
                            <button onclick="setBackgroundPosition('${elemId}', 0, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Left</button>
                            <button onclick="setBackgroundPosition('${elemId}', 50, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Center</button>
                            <button onclick="setBackgroundPosition('${elemId}', 100, 0)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Top Right</button>
                            <button onclick="setBackgroundPosition('${elemId}', 0, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center Left</button>
                            <button onclick="setBackgroundPosition('${elemId}', 50, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center</button>
                            <button onclick="setBackgroundPosition('${elemId}', 100, 50)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Center Right</button>
                            <button onclick="setBackgroundPosition('${elemId}', 0, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Left</button>
                            <button onclick="setBackgroundPosition('${elemId}', 50, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Center</button>
                            <button onclick="setBackgroundPosition('${elemId}', 100, 100)" style="padding: 8px; font-size: 11px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer;">Bottom Right</button>
                        </div>
                    </div>
                    
                    <!-- Background Size Control -->
                    <div style="margin-bottom: 20px;">
                        <label class="property-label">Background Size</label>
                        <select id="bg-size" onchange="updateBackgroundSize('${elemId}', this.value)" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <option value="cover" ${config.fit === 'cover' ? 'selected' : ''}>Cover (Fill Container)</option>
                            <option value="contain" ${config.fit === 'contain' ? 'selected' : ''}>Contain (Fit Inside)</option>
                            <option value="auto" ${config.fit === 'auto' ? 'selected' : ''}>Original Size</option>
                        </select>
                    </div>
                    
                    <!-- Reset Button -->
                    <button onclick="resetBackgroundPosition('${elemId}')" style="width: 100%; padding: 10px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 6px; cursor: pointer;">
                        Reset to Default
                    </button>
                </div>
            `;
            
            // Switch to Properties tab
            switchToTab('properties');
            
            console.log('Background image properties shown for:', elemId);
        }

        // Background image handling functions
        function updateBackgroundPosition(elemId, axis, value) {
            imagePositioning[elemId][axis] = parseInt(value);
            document.getElementById(`bg-pos-${axis}-display`).textContent = value + '%';
            applyBackgroundPositioning(elemId);
        }

        function setBackgroundPosition(elemId, x, y) {
            imagePositioning[elemId].x = x;
            imagePositioning[elemId].y = y;
            
            document.getElementById('bg-position-x').value = x;
            document.getElementById('bg-position-y').value = y;
            document.getElementById('bg-pos-x-display').textContent = x + '%';
            document.getElementById('bg-pos-y-display').textContent = y + '%';
            
            applyBackgroundPositioning(elemId);
        }

        function updateBackgroundSize(elemId, size) {
            imagePositioning[elemId].fit = size;
            applyBackgroundPositioning(elemId);
        }

        function applyBackgroundPositioning(elemId) {
            const element = document.getElementById(elemId);
            if (!element) return;
            
            const config = imagePositioning[elemId];
            element.style.backgroundPosition = `${config.x}% ${config.y}%`;
            element.style.backgroundSize = config.fit;
        }

        function resetBackgroundPosition(elemId) {
            imagePositioning[elemId] = { x: 50, y: 50, fit: 'cover' };
            
            const bgPosX = document.getElementById('bg-position-x');
            const bgPosY = document.getElementById('bg-position-y');
            const bgSize = document.getElementById('bg-size');
            
            if (bgPosX) bgPosX.value = 50;
            if (bgPosY) bgPosY.value = 50;
            if (bgSize) bgSize.value = 'cover';
            
            if (document.getElementById('bg-pos-x-display')) document.getElementById('bg-pos-x-display').textContent = '50%';
            if (document.getElementById('bg-pos-y-display')) document.getElementById('bg-pos-y-display').textContent = '50%';
            
            applyBackgroundPositioning(elemId);
        }

        function changeBackgroundImage(elemId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const element = document.getElementById(elemId);
                        if (element) {
                            const currentBg = element.style.backgroundImage;
                            const newBg = currentBg.replace(/url\([^)]+\)/, `url('${e.target.result}')`);
                            element.style.backgroundImage = newBg;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Keyboard shortcuts for deletion
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Delete key or Backspace to delete selected element
                if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElement) {
                    // Don't delete if user is typing in an input/textarea
                    if (e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'TEXTAREA' || 
                        e.target.isContentEditable) {
                        return;
                    }
                    
                    e.preventDefault();
                    deleteElement(selectedElement.id);
                }
                
                // Escape key to clear selection
                if (e.key === 'Escape') {
                    clearElementSelection();
                    selectedElement = null;
                }
            });
            
            console.log('Keyboard shortcuts initialized - Delete/Backspace to delete, Escape to deselect');
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeDragAndDrop();
            initializeFloatingToolbar(); // Initialize toolbar first
            initializePagesDragAndDrop(); // Initialize page drag and drop
            loadTemplate('modern');
            
            // Wait for template to load, then make all elements deletable
            setTimeout(() => {
                makeAllElementsDeletable(); // Make all existing elements deletable
                setupElementSelection(); // Enhanced element selection with delete functionality
                
                // Force check for any elements that still don't have hover delete or photo change
                document.querySelectorAll('.element, .hero-section, .gallery-section, .about-section, .contact-section, .services-section, .testimonials-section, .carousel-section, .cta-section, .featured-gallery-section, .gallery-grid-section, .masonry-section, .header-section').forEach(element => {
                    if (!element.id) {
                        element.id = 'element-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    if (!element.dataset.hasHoverDelete) {
                        addHoverDeleteToElement(element);
                        console.log('Added hover delete to preloaded element:', element.id);
                    }
                    
                    if (!element.dataset.hasHoverPhotoChange) {
                        addHoverPhotoChangeToElement(element);
                        console.log('Added hover photo change to preloaded element:', element.id);
                    }
                });
            }, 300);
            
            initializeTouchToEdit(); // This will call initializeTextEditingWithToolbar for comprehensive text editing
            initializeCarouselHover(); // Initialize carousel hover effects
            initializeImageHandling(); // Initialize image click handling
            enableImageDragging(); // Initialize image drag repositioning
            initializeKeyboardShortcuts(); // Initialize keyboard shortcuts
            setupGlobalClickHandler(); // Initialize component selection system
            updateNavigationPreview(); // Initialize navigation
            testCarouselFunctions(); // Test if carousel functions are available
        });
    </script>
</body>
</html>