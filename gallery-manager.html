<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --warm-white: #FEFDFB;
            --beige: #F5F1EB;
            --sage: #9CAF88;
            --muted-gold: #C4962D;
            --soft-brown: #8B7355;
            --deep-charcoal: #2C2C2C;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Quicksand', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--warm-white) 0%, var(--beige) 100%);
            color: var(--deep-charcoal);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-family: var(--font-serif);
            font-size: 2.2em;
            font-weight: 600;
            color: var(--deep-charcoal);
        }

        .folder-type {
            background: linear-gradient(135deg, var(--muted-gold), #f4e4bc);
            color: var(--deep-charcoal);
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toolbar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, var(--muted-gold), #f4e4bc);
            color: var(--deep-charcoal);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(196, 150, 45, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--sage), #b8c7a3);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e85566);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #52c267);
            color: white;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            transition: all 0.3s ease;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(44, 44, 44, 0.15);
        }

        .file-preview {
            width: 100%;
            height: 200px;
            background: var(--beige);
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border-radius: 8px;
            background: var(--beige);
            transition: transform 0.3s ease;
        }

        .file-preview img:hover {
            transform: scale(1.05);
        }

        .file-icon {
            font-size: 3em;
            color: var(--soft-brown);
        }

        .file-info {
            margin-bottom: 15px;
        }

        .file-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-meta {
            color: var(--soft-brown);
            font-size: 0.9em;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-actions .btn {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .upload-zone {
            background: white;
            border: 3px dashed var(--sage);
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--muted-gold);
            background: var(--beige);
        }

        .upload-zone.dragover {
            border-color: var(--muted-gold);
            background: var(--beige);
            transform: scale(1.02);
        }

        .upload-zone h3 {
            font-family: var(--font-serif);
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--deep-charcoal);
        }

        .upload-zone p {
            color: var(--soft-brown);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .stats {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: var(--font-serif);
            font-size: 2em;
            font-weight: 600;
            color: var(--muted-gold);
        }

        .stat-label {
            color: var(--soft-brown);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
        }

        .empty-state h3 {
            font-family: var(--font-serif);
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--deep-charcoal);
        }

        .empty-state p {
            color: var(--soft-brown);
            margin-bottom: 30px;
        }

        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
        }

        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            max-height: 95%;
        }

        .lightbox-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 40px;
            color: var(--muted-gold);
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .lightbox-close:hover {
            color: #f4e4bc;
            transform: scale(1.1);
        }

        .progress-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--beige);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--muted-gold), #f4e4bc);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: var(--deep-charcoal);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .toolbar {
                justify-content: center;
            }

            .file-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="folderTitle">üì∏ Gallery Manager</h1>
        <div class="folder-type" id="folderType">Gallery</div>
    </div>



    <div class="toolbar">
        <button class="btn btn-secondary" onclick="downloadAllFiles()">
            üì¶ Download All ZIP
        </button>
        <button class="btn btn-danger" onclick="deleteAllFiles()">
            üóëÔ∏è Delete All
        </button>
        <button class="btn btn-success" onclick="sendToClient()" id="sendClientBtn" style="display: none;">
            üìß Send to Client
        </button>
        <button class="btn btn-secondary" onclick="refreshFiles()">
            üîÑ Refresh
        </button>
    </div>

    <div id="file-stats" style="
        background: white; 
        padding: 15px; 
        border-radius: 10px; 
        margin: 15px 0; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        font-weight: 600;
    "></div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Uploading...</div>
    </div>

    <div class="upload-zone" id="uploadZone" onclick="triggerFileUpload()">
        <h3>üì§ Upload Files</h3>
        <p>Drag and drop files or click anywhere in this area to browse</p>
        <p><strong>Processes 2 files at a time ‚Ä¢ No size limits ‚Ä¢ All file types supported</strong></p>
    </div>

    <input type="file" id="fileInput" class="file-input" multiple accept="*/*">

    <div id="fileContainer">
        <div class="empty-state" id="emptyState">
            <h3>üìÅ No Files Yet</h3>
            <p>Use the upload zone above to add your first files</p>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="">
        </div>
    </div>

    <script>
        let sessionId = '';
        let folderType = '';
        let clientName = '';
        let clientEmail = '';
        let clientPhoneNumber = '';
        let files = [];
        let uploadQueue = [];
        let isUploading = false;

        // Load session data to get client contact info
        async function loadSessionData() {
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const sessionData = await response.json();
                    console.log('Session data loaded:', sessionData);
                    
                    // Update client info from session data
                    clientName = sessionData.clientName || sessionData.client_name || clientName;
                    clientEmail = sessionData.email || '';
                    clientPhoneNumber = sessionData.phoneNumber || sessionData.phone_number || '';
                    
                    console.log(`Client: ${clientName}, Email: ${clientEmail}, Phone: ${clientPhoneNumber}`);
                } else {
                    console.warn('Failed to load session data, using URL parameters only');
                }
            } catch (error) {
                console.error('Error loading session data:', error);
            }
        }

        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('sessionId');
            folderType = urlParams.get('folderType');
            clientName = urlParams.get('clientName') || 'Client';
            
            // Update UI
            document.getElementById('folderTitle').textContent = 
                folderType === 'gallery' ? 'üì∏ Gallery Manager' : 'üìÅ Raw Storage Manager';
            document.getElementById('folderType').textContent = 
                folderType === 'gallery' ? 'Gallery' : 'Raw Storage';
            
            // Show send to client button only for gallery
            if (folderType === 'gallery') {
                document.getElementById('sendClientBtn').style.display = 'flex';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            getUrlParams();
            
            // Load complete session data to get client contact info
            await loadSessionData();
            
            loadFiles();
            setupDragAndDrop();
            setupFileInput();
        });

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });
        }

        // Setup file input
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
                e.target.value = ''; // Reset input
            });
        }

        // Trigger file upload
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        // Handle file selection
        function handleFileSelection(selectedFiles) {
            if (selectedFiles.length === 0) return;
            
            uploadQueue = [...selectedFiles];
            processUploadQueue();
        }

        // Process upload queue (2 files at a time)
        async function processUploadQueue() {
            if (isUploading || uploadQueue.length === 0) return;
            
            isUploading = true;
            document.getElementById('progressContainer').style.display = 'block';
            
            const batchSize = 2;
            
            while (uploadQueue.length > 0) {
                const batch = uploadQueue.splice(0, batchSize);
                const uploadPromises = batch.map(file => uploadFile(file));
                
                try {
                    await Promise.all(uploadPromises);
                } catch (error) {
                    console.error('Batch upload error:', error);
                }
            }
            
            isUploading = false;
            document.getElementById('progressContainer').style.display = 'none';
            loadFiles(); // Refresh file list
        }

        // Upload single file
        async function uploadFile(file) {
            try {
                console.log(`Starting upload for ${file.name}, size: ${file.size}`);
                console.log(`Session ID: ${sessionId}, Folder Type: ${folderType}`);
                
                // Check storage quota before upload
                const canUpload = await checkStorageQuota(file.size);
                if (!canUpload) {
                    return; // Stop upload if quota exceeded
                }
                
                // Use FormData for server-proxied upload to R2 (avoids CORS issues)
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload directly through server to R2
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}/upload-direct`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                console.log(`Upload response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload response error:', errorText);
                    
                    if (response.status === 401) {
                        alert('Authentication error. Please refresh the page and try again.');
                        throw new Error(`Authentication failed: ${response.status}`);
                    }
                    
                    if (response.status === 413) {
                        try {
                            const errorData = JSON.parse(errorText);
                            alert(errorData.message || 'Storage quota exceeded. Please upgrade your storage plan.');
                            throw new Error(errorData.message || 'Storage quota exceeded');
                        } catch {
                            alert('Storage quota exceeded. Please upgrade your storage plan.');
                            throw new Error('Storage quota exceeded');
                        }
                    }
                    
                    alert(`Upload failed: ${errorText}. Please try again.`);
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`Successfully uploaded ${file.name} to R2:`, result);
                updateProgress(`Uploaded ${file.name}`);
                
                // Wait a moment for upload to propagate, then reload files
                setTimeout(() => {
                    loadFiles();
                }, 1000);
                
            } catch (error) {
                console.error('Upload error for', file.name, ':', error);
                alert(`Failed to upload ${file.name}: ${error.message}`);
            }
        }

        // Update progress
        function updateProgress(text) {
            document.getElementById('progressText').textContent = text;
        }
        
        // Storage quota checking function
        async function checkStorageQuota(fileSizeBytes) {
            try {
                const response = await fetch('/api/storage/quota', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('Failed to check storage quota, allowing upload');
                    return true; // Allow upload if we can't check quota
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    console.warn('Storage quota check failed:', result.error);
                    return true; // Allow upload if quota check failed
                }
                
                const quotaData = result.data;
                const fileSizeGB = fileSizeBytes / (1024 * 1024 * 1024);
                const wouldExceedQuota = (quotaData.usedStorageGB + fileSizeGB) > quotaData.totalQuotaGB;
                
                if (wouldExceedQuota) {
                    const upgradeMessage = `
                        ‚ùå Upload blocked - Storage quota exceeded!
                        
                        Current usage: ${quotaData.usedStorageGB.toFixed(2)} GB / ${quotaData.totalQuotaGB.toFixed(0)} GB
                        File size: ${fileSizeGB.toFixed(2)} GB
                        
                        You need more storage to upload this file.
                        Would you like to upgrade your storage plan?
                    `;
                    
                    if (confirm(upgradeMessage)) {
                        // Open storage dashboard for upgrade
                        window.open('/storage-dashboard.html', '_blank');
                    }
                    
                    return false;
                }
                
                // Show warning if approaching limit (90%+)
                if (quotaData.usagePercentage >= 90) {
                    const warningMessage = `
                        ‚ö†Ô∏è Storage nearly full!
                        
                        You're using ${quotaData.usagePercentage.toFixed(1)}% of your storage quota.
                        Consider upgrading soon to avoid future upload issues.
                        
                        Continue with this upload?
                    `;
                    
                    return confirm(warningMessage);
                }
                
                return true;
                
            } catch (error) {
                console.error('Error checking storage quota:', error);
                return true; // Allow upload if quota check failed
            }
        }

        // Update stats display - removed old function causing syntax errors
        
        // Load and display storage statistics for both folders
        async function loadStorageStats() {
            try {
                const response = await fetch('/api/sessions/' + sessionId + '/storage', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('Failed to load storage stats');
                    return;
                }
                
                const stats = await response.json();
                console.log('Storage stats received:', stats);
                
                // Add or update storage stats display
                let storageDiv = document.getElementById('storage-stats');
                if (!storageDiv) {
                    storageDiv = document.createElement('div');
                    storageDiv.id = 'storage-stats';
                    storageDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    storageDiv.style.color = 'white';
                    storageDiv.style.padding = '15px';
                    storageDiv.style.borderRadius = '12px';
                    storageDiv.style.margin = '15px 0';
                    storageDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                    document.body.insertBefore(storageDiv, document.getElementById('fileContainer'));
                }
                
                // Build HTML content using string concatenation
                var galleryMeasured = '';
                if (stats.gallery.validFiles !== stats.gallery.fileCount) {
                    galleryMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.gallery.validFiles + ' measured)</div>';
                }
                
                var rawMeasured = '';
                if (stats.raw.validFiles !== stats.raw.fileCount) {
                    rawMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.raw.validFiles + ' measured)</div>';
                }
                
                var combinedMeasured = '';
                if (stats.combined.validFiles !== stats.combined.fileCount) {
                    combinedMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.combined.validFiles + ' measured)</div>';
                }
                
                storageDiv.innerHTML = 
                    '<h3 style="margin: 0 0 10px 0; font-size: 18px;">üìä Session Storage Overview</h3>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">' +
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.gallery.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Gallery Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.gallery.totalSizeFormatted + '</div>' +
                            galleryMeasured +
                        '</div>' +
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.raw.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Raw Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.raw.totalSizeFormatted + '</div>' +
                            rawMeasured +
                        '</div>' +
                        '<div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.combined.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Total Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.combined.totalSizeFormatted + '</div>' +
                            combinedMeasured +
                        '</div>' +
                    '</div>';
                
                console.log('Storage stats loaded successfully');
            } catch (error) {
                console.error('Error loading storage stats:', error);
            }
        }

        // Load files
        async function loadFiles() {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}`, {
                    credentials: 'include' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Load files response error:', errorText);
                    throw new Error(`Failed to load files: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                files = data.files || [];
                
                console.log(`Loaded ${files.length} files for ${folderType} folder`);
                renderFiles();
                loadStorageStats();
                
            } catch (error) {
                console.error('Load files error:', error);
                document.getElementById('fileContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error Loading Files</h3>
                        <p>${error.message}</p>
                        <button class="btn" onclick="loadFiles()">Try Again</button>
                    </div>
                `;
            }
        }

        // Render files
        function renderFiles() {
            const container = document.getElementById('fileContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (!container) {
                console.error('File container not found');
                return;
            }
            
            // File count and size now handled by storage overview section
            
            if (files.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    container.innerHTML = '';
                    container.appendChild(emptyState);
                } else {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 40px;">
                            <h3>üìÅ No Files</h3>
                            <p>No files found in this ${folderType} folder</p>
                        </div>
                    `;
                }
                return;
            }
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const fileGrid = document.createElement('div');
            fileGrid.className = 'file-grid';
            
            files.forEach(file => {
                const fileCard = createFileCard(file);
                fileGrid.appendChild(fileCard);
            });
            
            container.innerHTML = '';
            container.appendChild(fileGrid);
        }

        // Create file card
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'file-card';
            
            const isImage = file.contentType && file.contentType.startsWith('image/');
            
            // Build HTML with string concatenation to avoid template literal issues
            let html = '<div class="file-preview">';
            
            if (isImage) {
                // Use proper thumbnail API with R2 integration
                var thumbnailFileName = file.fileName || file.name;
                var thumbnailUrl = '/api/r2/thumbnail/' + sessionId + '/' + encodeURIComponent(thumbnailFileName) + '?size=medium';
                html += '<img src="' + thumbnailUrl + '" ';
                html += 'alt="' + file.name + '" ';
                html += 'onclick="openLightbox(\'' + file.downloadUrl + '\')" ';
                html += 'onerror="this.style.display=\'none\'; this.parentNode.innerHTML=\'<div class=\\\"file-icon\\\">üñºÔ∏è</div>\';" ';
                html += 'loading="lazy">';
            } else {
                html += '<div class="file-icon">' + getFileIcon(file.contentType) + '</div>';
            }
            
            html += '</div>';
            html += '<div class="file-info">';
            html += '<div class="file-name">' + file.name + '</div>';
            html += '<div class="file-meta">' + formatFileSize(file.size) + ' ‚Ä¢ ' + formatDate(file.timeCreated) + '</div>';
            html += '</div>';
            html += '<div class="file-actions">';
            html += '<button class="btn" onclick="downloadFile(\'' + file.downloadUrl + '\', \'' + file.name + '\')">üì• Download</button>';
            var deleteFileName = file.fileName || file.name;
            html += '<button class="btn btn-danger" onclick="deleteFile(\'' + deleteFileName + '\')">üóëÔ∏è Delete</button>';
            html += '</div>';
            
            card.innerHTML = html;
            return card;
        }

        // Get file icon based on content type
        function getFileIcon(contentType) {
            if (!contentType) return 'üìÑ';
            
            if (contentType.startsWith('image/')) return 'üñºÔ∏è';
            if (contentType.startsWith('video/')) return 'üé•';
            if (contentType.startsWith('audio/')) return 'üéµ';
            if (contentType.includes('pdf')) return 'üìï';
            if (contentType.includes('document') || contentType.includes('word')) return 'üìù';
            if (contentType.includes('spreadsheet') || contentType.includes('excel')) return 'üìä';
            if (contentType.includes('zip') || contentType.includes('archive')) return 'üì¶';
            
            return 'üìÑ';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Stats display now handled by loadStorageStats() function

        // Download file
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Download all files as ZIP
        async function downloadAllFiles() {
            console.log('üî• Download All button clicked!');
            
            if (!files || files.length === 0) {
                console.error('‚ùå No files available for download');
                alert('No files to download');
                return;
            }
            
            console.log(`üì¶ Attempting to download ${files.length} files as ZIP`);
            console.log('üìç Request details:', {
                sessionId,
                folderType,
                clientName,
                endpoint: `/api/sessions/${sessionId}/files/${folderType}/download-zip`
            });
            
            try {
                // Show loading indicator
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '‚è≥ Creating ZIP...';
                downloadBtn.disabled = true;
                
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}/download-zip`, {
                    method: 'GET',
                    credentials: 'include', // Include cookies for authentication
                    headers: {
                        'Accept': 'application/zip',
                    }
                });
                
                console.log('üì• Server response:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type'),
                    contentLength: response.headers.get('content-length')
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Download ZIP response error:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                // Get the blob data
                const blob = await response.blob();
                console.log('üì¶ ZIP blob received:', {
                    size: blob.size,
                    type: blob.type
                });
                
                if (blob.size === 0) {
                    throw new Error('Received empty ZIP file from server');
                }
                
                // Create filename
                const filename = `${clientName.replace(/[^a-zA-Z0-9\s-]/g, '_')}_${folderType}_photos.zip`;
                console.log('üìÅ Creating download with filename:', filename);
                
                // Try multiple download methods to ensure compatibility
                try {
                    // Method 1: Direct blob download (preferred)
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    console.log('üöÄ Method 1: Triggering blob download for:', filename);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        try {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } catch (cleanupError) {
                            console.warn('Cleanup warning:', cleanupError);
                        }
                    }, 1000);
                    
                } catch (blobError) {
                    console.warn('Blob method failed, trying alternative:', blobError);
                    
                    // Method 2: Force browser navigation (fallback)
                    const form = document.createElement('form');
                    form.method = 'GET';
                    form.action = `/api/sessions/${sessionId}/files/${folderType}/download-zip`;
                    form.target = '_blank';
                    form.style.display = 'none';
                    
                    document.body.appendChild(form);
                    console.log('üöÄ Method 2: Triggering form download');
                    form.submit();
                    
                    setTimeout(() => {
                        document.body.removeChild(form);
                    }, 1000);
                }
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 1000);
                
                console.log(`‚úÖ Successfully triggered ZIP download for ${folderType} folder`);
                
                // Give user feedback about the download
                setTimeout(() => {
                    alert(`ZIP download initiated! Check your browser's download folder for: ${filename}`);
                }, 500);
                
                // Restore button
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Download ZIP error:', error);
                alert('Failed to download ZIP: ' + error.message);
                
                // Restore button on error
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                downloadBtn.innerHTML = 'üì¶ Download All ZIP';
                downloadBtn.disabled = false;
            }
        }

        // OLD DELETE FUNCTION REMOVED - Now using unified deletion system (loaded at bottom of page)

        // Delete all files using unified deletion system
        async function deleteAllFiles() {
            if (files.length === 0) {
                alert('No files to delete');
                return;
            }

            // Extract filenames for deletion
            const filenames = files.map(file => file.fileName || file.name);
            
            try {
                // Use unified deletion system's batch delete method
                await photoDeletion.batchDeletePhotos(sessionId, folderType, filenames);
                
                // Refresh file list after deletion
                loadFiles();
                loadStorageStats();
                
            } catch (error) {
                console.error('Delete all error:', error);
                alert('Failed to delete files: ' + error.message);
            }
        }

        // Send to client with choice modal
        function sendToClient() {
            // Show modal with email/SMS options
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">Send Gallery Link to Client</h3>
                    <p style="margin: 0 0 20px 0; color: #666;">How would you like to send the gallery link to ${clientName}?</p>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <button onclick="sendViaEmail()" style="flex: 1; padding: 15px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üìß Email
                        </button>
                        <button onclick="sendViaSMS()" style="flex: 1; padding: 15px; background: #0d9488; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üì± SMS
                        </button>
                    </div>
                    
                    <button onclick="closeModal()" style="width: 100%; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add global functions for the modal
            window.sendViaEmail = function() {
                if (!clientEmail) {
                    alert('Client email not available. Please add email to session details first.');
                    closeModal();
                    return;
                }
                
                const clientGalleryUrl = `${window.location.origin}/client-gallery.html?session=${sessionId}`;
                const subject = `Your Photography Gallery - ${clientName}`;
                const body = `Hi ${clientName},

Your photography gallery is ready for viewing and download!

üì∏ View Your Gallery: ${clientGalleryUrl}

You can:
‚Ä¢ View all your photos in high resolution
‚Ä¢ Download individual photos  
‚Ä¢ Download selected photos as a ZIP file
‚Ä¢ Download your entire gallery

The gallery will remain available for download. If you have any questions or need assistance, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography`;

                const mailtoUrl = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoUrl, '_blank');
                closeModal();
            };
            
            window.sendViaSMS = function() {
                if (!clientPhoneNumber) {
                    alert('Client phone number not available. Please add phone number to session details first.');
                    closeModal();
                    return;
                }
                
                const clientGalleryUrl = `${window.location.origin}/client-gallery.html?session=${sessionId}`;
                const message = `Hi ${clientName}! Your photo gallery is ready: ${clientGalleryUrl} - Lance Photography`;
                
                const smsUrl = `sms:${clientPhoneNumber}?body=${encodeURIComponent(message)}`;
                window.open(smsUrl, '_blank');
                closeModal();
            };
            
            window.closeModal = function() {
                document.body.removeChild(modal);
                delete window.sendViaEmail;
                delete window.sendViaSMS;
                delete window.closeModal;
            };
        }

        // Refresh files
        function refreshFiles() {
            loadFiles();
        }

        // Lightbox functions
        function openLightbox(imageSrc) {
            document.getElementById('lightboxImage').src = imageSrc;
            document.getElementById('lightbox').style.display = 'block';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // Close lightbox with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });
    </script>
    
    <!-- Import unified deletion system -->
    <script src="/static/js/photo-deletion.js"></script>
    <script>
        // Add showMessage function for compatibility with deletion system
        function showMessage(message, type) {
            console.log(`${type.toUpperCase()}: ${message}`);
            if (type === 'error') {
                alert(`Error: ${message}`);
            } else if (type === 'success') {
                console.log(`‚úÖ Success: ${message}`);
            } else if (type === 'warning') {
                console.log(`‚ö†Ô∏è Warning: ${message}`);
            } else {
                console.log(`‚ÑπÔ∏è Info: ${message}`);
            }
        }

        // Initialize unified deletion system (check if not already initialized)
        let photoDeletion;
        if (typeof PhotoDeletion !== 'undefined') {
            photoDeletion = new PhotoDeletion();
        }
        
        // Define deleteFile function to use unified deletion
        async function deleteFile(fileName) {
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }
            
            try {
                // Use unified deletion system
                await photoDeletion.deletePhoto(sessionId, folderType, fileName);
                
                // Refresh file list after successful deletion
                loadFiles();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete file: ' + error.message);
            }
        }
    </script>
</body>
</html>