<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --background: #ffffff;
            --surface: #f8f9fa;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--surface);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .folder-type {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 500;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .toolbar {
            background: var(--background);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 30px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e85566);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #52c267);
            color: white;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 0 5px;
        }

        .file-card {
            background: var(--background);
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .file-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(44, 44, 44, 0.15);
        }

        .file-preview {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, var(--beige) 0%, #f8f6f0 100%);
            border-radius: 20px 20px 0 0;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .file-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(196, 150, 45, 0.05) 50%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border-radius: 0;
            background: var(--beige);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 0;
        }

        .file-preview img:hover {
            transform: scale(1.08);
        }

        .file-card-content {
            padding: 20px;
            background: white;
            position: relative;
        }

        .file-card-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--muted-gold), var(--sage), var(--muted-gold));
        }

        .file-icon {
            font-size: 3em;
            color: var(--soft-brown);
        }

        .file-info {
            margin-bottom: 20px;
            position: relative;
        }

        .file-name {
            font-weight: 700;
            font-size: 1.15em;
            margin-bottom: 8px;
            word-break: break-word;
            color: var(--deep-charcoal);
            line-height: 1.3;
            font-family: var(--font-serif);
        }

        .file-meta {
            color: var(--soft-brown);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--beige);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .file-size {
            font-weight: 600;
            color: var(--muted-gold);
        }

        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .file-actions .btn {
            padding: 10px 16px;
            font-size: 0.8em;
            border-radius: 15px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .upload-zone {
            background: white;
            border: 3px dashed var(--sage);
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--muted-gold);
            background: var(--beige);
        }

        .upload-zone.dragover {
            border-color: var(--muted-gold);
            background: var(--beige);
            transform: scale(1.02);
        }

        .upload-zone h3 {
            font-family: var(--font-serif);
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--deep-charcoal);
        }

        .upload-zone p {
            color: var(--soft-brown);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .stats {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: var(--font-serif);
            font-size: 2em;
            font-weight: 600;
            color: var(--muted-gold);
        }

        .stat-label {
            color: var(--soft-brown);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
        }

        .empty-state h3 {
            font-family: var(--font-serif);
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--deep-charcoal);
        }

        .empty-state p {
            color: var(--soft-brown);
            margin-bottom: 30px;
        }

        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
        }

        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            max-height: 95%;
        }

        .lightbox-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 40px;
            color: var(--muted-gold);
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .lightbox-close:hover {
            color: #f4e4bc;
            transform: scale(1.1);
        }

        .progress-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(44, 44, 44, 0.1);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--beige);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--muted-gold), #f4e4bc);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: var(--deep-charcoal);
            font-weight: 600;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--soft-brown);
        }

        .upload-queue {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .upload-item {
            background: var(--beige);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .upload-item .status-icon {
            width: 20px;
            text-align: center;
        }

        .upload-item.uploading {
            background: #e8f4fd;
            border-left: 4px solid var(--muted-gold);
        }

        .upload-item.completed {
            background: #e8f6e8;
            border-left: 4px solid var(--sage);
        }

        .upload-item.error {
            background: #fde8e8;
            border-left: 4px solid #dc3545;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .toolbar {
                justify-content: center;
            }

            .file-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .stats {
                flex-direction: column;
                gap: 20px;
            }

            .file-actions {
                flex-direction: column;
            }

            .file-actions .btn {
                min-width: auto;
                flex: none;
            }
        }

        @media (max-width: 480px) {
            .file-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .file-preview {
                height: 180px;
            }
        }

        /* Enhanced hover animations for modern feel */
        .file-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-card:hover .file-preview img {
            filter: brightness(1.1) contrast(1.05);
        }

        /* Masonry-style layout for larger screens */
        @media (min-width: 1024px) {
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 25px;
            }
        }

        @media (min-width: 1440px) {
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="folderTitle"> Gallery Manager</h1>
        <div class="folder-type" id="folderType">Gallery</div>
    </div>



    <div class="toolbar">
        <button class="btn btn-secondary" onclick="downloadAllFiles()">
            Download All ZIP
        </button>
        <button class="btn btn-danger" onclick="deleteAllFiles()">
            Delete All
        </button>
        <button class="btn btn-success" onclick="sendToClient()" id="sendClientBtn" style="display: none;">
            Send to Client
        </button>
        <button class="btn btn-secondary" onclick="refreshFiles()">
            Refresh
        </button>
    </div>

    <div id="file-stats" style="
        background: white; 
        padding: 15px; 
        border-radius: 10px; 
        margin: 15px 0; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        font-weight: 600;
    "></div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Uploading...</div>
        <div class="progress-stats">
            <span id="progressStats">0 / 0 files</span>
            <span id="progressSpeed">0 MB/s</span>
        </div>
        <div class="upload-queue" id="uploadQueue"></div>
    </div>

    <div class="upload-zone" id="uploadZone" onclick="triggerFileUpload()">
        <h3>Upload Files</h3>
        <p>Drag and drop files or click anywhere in this area to browse</p>
        <p><strong>Processes 2 files at a time ‚Ä¢ No size limits ‚Ä¢ All file types supported</strong></p>
    </div>

    <input type="file" id="fileInput" class="file-input" multiple accept="*/*">

    <div id="fileContainer">
        <div class="empty-state" id="emptyState">
            <h3>No Files Yet</h3>
            <p>Use the upload zone above to add your first files</p>
        </div>
    </div>

    <!-- Lightbox with Print Ordering -->
    <div class="lightbox" id="lightbox">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightboxImage" src="" alt="">
            <div class="lightbox-controls">
                <button class="btn btn-success" onclick="orderPrint()">üõí Order Print</button>
                <button class="btn btn-secondary" onclick="downloadImage()">üì• Download</button>
            </div>
        </div>
    </div>
    
    <!-- Print Options Modal -->
    <div class="print-modal" id="printModal">
        <div class="print-modal-content">
            <h2>Select Print Options</h2>
            <img id="printPreview" style="width: 100%; max-height: 200px; object-fit: contain; margin: 20px 0; border-radius: 10px;">
            
            <h3>Size</h3>
            <div class="size-options">
                <div class="print-option" data-size="4x6" data-price="12.00">
                    <span>4x6" - Perfect for albums</span>
                    <strong>$12.00</strong>
                </div>
                <div class="print-option" data-size="5x7" data-price="15.00">
                    <span>5x7" - Great for desk displays</span>
                    <strong>$15.00</strong>
                </div>
                <div class="print-option" data-size="8x10" data-price="25.00">
                    <span>8x10" - Ideal for wall display</span>
                    <strong>$25.00</strong>
                </div>
                <div class="print-option" data-size="11x14" data-price="35.00">
                    <span>11x14" - Statement piece</span>
                    <strong>$35.00</strong>
                </div>
                <div class="print-option" data-size="16x20" data-price="55.00">
                    <span>16x20" - Gallery-worthy</span>
                    <strong>$55.00</strong>
                </div>
                <div class="print-option" data-size="20x30" data-price="95.00">
                    <span>20x30" - Large format</span>
                    <strong>$95.00</strong>
                </div>
            </div>
            
            <h3>Finish</h3>
            <div class="finish-options">
                <label>
                    <input type="radio" name="finish" value="lustre" checked>
                    <strong>Lustre</strong> - Most popular, fingerprint resistant
                </label>
                <label>
                    <input type="radio" name="finish" value="glossy">
                    <strong>Glossy</strong> - Vibrant colors, high shine
                </label>
                <label>
                    <input type="radio" name="finish" value="matte">
                    <strong>Matte</strong> - No glare, artistic look
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closePrintModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                <button onclick="addToCart()" class="btn btn-success" style="flex: 1;">Add to Cart</button>
            </div>
        </div>
    </div>
    
    <!-- Shopping Cart Icon -->
    <div id="cartIcon" class="cart-icon" onclick="showCart()">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 2L6 9H3l3 13h12l3-13h-3l-3-7"/>
            <path d="M9 9h6"/>
        </svg>
        <span class="cart-count">0</span>
    </div>
    
    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <h2>Shopping Cart</h2>
            <div id="cartItems"></div>
            <div id="cartTotal" style="font-size: 20px; font-weight: bold; margin-top: 20px;"></div>
            <button class="btn btn-success" onclick="checkout()" style="width: 100%; margin-top: 20px;">Proceed to Checkout</button>
            <button onclick="closeCart()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">Continue Shopping</button>
        </div>
    </div>

    <script>
        let sessionId = '';
        let folderType = '';
        let clientName = '';
        let clientEmail = '';
        let clientPhoneNumber = '';
        let sessionData = null; // Store the loaded session data
        let files = [];
        let uploadQueue = [];
        let isUploading = false;
        let totalFiles = 0;
        let completedFiles = 0;
        let startTime = 0;
        let totalBytes = 0;
        let uploadedBytes = 0;

        // Load session data to get client contact info
        async function loadSessionData() {
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    sessionData = await response.json(); // Store in global variable
                    console.log('Session data loaded:', sessionData);
                    
                    // Update client info from session data
                    clientName = sessionData.clientName || sessionData.client_name || clientName;
                    clientEmail = sessionData.email || '';
                    clientPhoneNumber = sessionData.phoneNumber || sessionData.phone_number || '';
                    
                    console.log(`Client: ${clientName}, Email: ${clientEmail}, Phone: ${clientPhoneNumber}`);
                } else {
                    console.warn('Failed to load session data, using URL parameters only');
                }
            } catch (error) {
                console.error('Error loading session data:', error);
            }
        }

        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('sessionId');
            folderType = urlParams.get('folderType');
            clientName = urlParams.get('clientName') || 'Client';
            
            console.log('URL Parameters:', { sessionId, folderType, clientName });
            
            // Update UI
            document.getElementById('folderTitle').textContent = 
                folderType === 'gallery' ? 'Gallery Manager' : 'Raw Storage Manager';
            document.getElementById('folderType').textContent = 
                folderType === 'gallery' ? 'Gallery' : 'Raw Storage';
            
            // Show send to client button only for gallery
            if (folderType === 'gallery') {
                document.getElementById('sendClientBtn').style.display = 'flex';
            }
            
            // Validate folder type
            if (!folderType || !['gallery', 'raw'].includes(folderType)) {
                console.error('Invalid or missing folderType:', folderType);
                document.getElementById('fileContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Invalid Folder Type</h3>
                        <p>Folder type must be 'gallery' or 'raw'. Current: ${folderType || 'undefined'}</p>
                        <p>Please check the URL parameters.</p>
                    </div>
                `;
                return false;
            }
            
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            if (getUrlParams()) {
                // Load complete session data to get client contact info
                await loadSessionData();
                
                loadFiles();
                setupDragAndDrop();
                setupFileInput();
            }
        });

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');
            
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });
        }

        // Setup file input
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
                e.target.value = ''; // Reset input
            });
        }

        // Trigger file upload
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        // Handle file selection
        function handleFileSelection(selectedFiles) {
            if (selectedFiles.length === 0) return;
            
            uploadQueue = [...selectedFiles];
            processUploadQueue();
        }

        // Process upload queue (2 files at a time)
        async function processUploadQueue() {
            if (isUploading || uploadQueue.length === 0) return;
            
            isUploading = true;
            totalFiles = uploadQueue.length;
            completedFiles = 0;
            startTime = Date.now();
            totalBytes = uploadQueue.reduce((sum, file) => sum + file.size, 0);
            uploadedBytes = 0;
            
            // Show progress container and initialize queue display
            document.getElementById('progressContainer').style.display = 'block';
            initializeUploadQueue();
            updateProgressDisplay();
            
            const batchSize = 2;
            
            while (uploadQueue.length > 0) {
                const batch = uploadQueue.splice(0, batchSize);
                const uploadPromises = batch.map(file => uploadFile(file));
                
                try {
                    await Promise.all(uploadPromises);
                } catch (error) {
                    console.error('Batch upload error:', error);
                }
            }
            
            isUploading = false;
            
            // Show completion message briefly
            updateProgressText('Upload complete!');
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('uploadQueue').innerHTML = '';
            }, 2000);
            
            loadFiles(); // Refresh file list
        }

        // Initialize upload queue display
        function initializeUploadQueue() {
            const queueContainer = document.getElementById('uploadQueue');
            queueContainer.innerHTML = '';
            
            [...uploadQueue].forEach(file => {
                const item = createUploadItem(file);
                queueContainer.appendChild(item);
            });
        }

        // Create upload item display
        function createUploadItem(file) {
            const div = document.createElement('div');
            div.className = 'upload-item';
            div.id = `upload-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            
            div.innerHTML = `
                <div class="status-icon">‚è≥</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 0.8em; color: var(--soft-brown);">${formatFileSize(file.size)}</div>
                </div>
            `;
            
            return div;
        }

        // Update upload item status
        function updateUploadItem(filename, status, icon) {
            const cleanName = filename.replace(/[^a-zA-Z0-9]/g, '_');
            const item = document.getElementById(`upload-${cleanName}`);
            if (item) {
                item.className = `upload-item ${status}`;
                item.querySelector('.status-icon').textContent = icon;
            }
        }

        // Update progress display
        function updateProgressDisplay() {
            const percentage = totalFiles > 0 ? (completedFiles / totalFiles) * 100 : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressStats').textContent = `${completedFiles} / ${totalFiles} files`;
            
            // Calculate upload speed
            const elapsed = (Date.now() - startTime) / 1000;
            const speed = elapsed > 0 ? (uploadedBytes / elapsed / 1024 / 1024) : 0;
            document.getElementById('progressSpeed').textContent = `${speed.toFixed(1)} MB/s`;
        }

        // Update progress text
        function updateProgressText(text) {
            document.getElementById('progressText').textContent = text;
        }

        // Upload single file
        async function uploadFile(file) {
            try {
                console.log(`Starting upload for ${file.name}, size: ${file.size}`);
                console.log(`Session ID: ${sessionId}, Folder Type: ${folderType}`);
                
                // Mark upload as starting
                markUploadStarting(file.name);
                
                // Check storage quota before upload
                const canUpload = await checkStorageQuota(file.size);
                if (!canUpload) {
                    updateUploadItem(file.name, 'error', 'üö´');
                    return; // Stop upload if quota exceeded
                }
                
                // Use FormData for server-proxied upload to R2 (avoids CORS issues)
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload directly through server to R2
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}/upload-direct`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                console.log(`Upload response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Upload response error:', errorText);
                    
                    if (response.status === 401) {
                        alert('Authentication error. Please refresh the page and try again.');
                        throw new Error(`Authentication failed: ${response.status}`);
                    }
                    
                    if (response.status === 413) {
                        try {
                            const errorData = JSON.parse(errorText);
                            alert(errorData.message || 'Storage quota exceeded. Please upgrade your storage plan.');
                            throw new Error(errorData.message || 'Storage quota exceeded');
                        } catch {
                            alert('Storage quota exceeded. Please upgrade your storage plan.');
                            throw new Error('Storage quota exceeded');
                        }
                    }
                    
                    alert(`Upload failed: ${errorText}. Please try again.`);
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`Successfully uploaded ${file.name} to R2:`, result);
                
                // Update progress tracking
                completedFiles++;
                uploadedBytes += file.size;
                updateProgressDisplay();
                updateProgressText(`Uploaded ${file.name}`);
                updateUploadItem(file.name, 'completed', '');
                
                // Wait a moment for upload to propagate, then reload files
                setTimeout(() => {
                    loadFiles();
                }, 1000);
                
            } catch (error) {
                console.error('Upload error for', file.name, ':', error);
                updateUploadItem(file.name, 'error', '‚ùå');
                alert(`Failed to upload ${file.name}: ${error.message}`);
            }
        }

        // Mark upload as starting
        function markUploadStarting(filename) {
            updateUploadItem(filename, 'uploading', 'üì§');
        }
        
        // Storage quota checking function
        async function checkStorageQuota(fileSizeBytes) {
            try {
                const response = await fetch('/api/storage/quota', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Failed to check storage quota:', response.status, response.statusText);
                    // For security, don't allow upload if we can't verify quota
                    showMessage('Unable to verify storage quota. Please try again later.', 'error');
                    return false;
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    console.warn('Storage quota check failed:', result.error);
                    return true; // Allow upload if quota check failed
                }
                
                const quotaData = result.data;
                const fileSizeGB = fileSizeBytes / (1024 * 1024 * 1024);
                const wouldExceedQuota = (quotaData.usedStorageGB + fileSizeGB) > quotaData.totalQuotaGB;
                
                if (wouldExceedQuota) {
                    const upgradeMessage = `
                        ‚ùå Upload blocked - Storage quota exceeded!
                        
                        Current usage: ${quotaData.usedStorageGB.toFixed(2)} GB / ${quotaData.totalQuotaGB.toFixed(0)} GB
                        File size: ${fileSizeGB.toFixed(2)} GB
                        
                        You need more storage to upload this file.
                        Would you like to upgrade your storage plan?
                    `;
                    
                    if (confirm(upgradeMessage)) {
                        // Open storage dashboard for upgrade
                        window.open('/storage-dashboard.html', '_blank');
                    }
                    
                    return false;
                }
                
                // Show warning if approaching limit (90%+)
                if (quotaData.usagePercentage >= 90) {
                    const warningMessage = `
                         Storage nearly full!
                        
                        You're using ${quotaData.usagePercentage.toFixed(1)}% of your storage quota.
                        Consider upgrading soon to avoid future upload issues.
                        
                        Continue with this upload?
                    `;
                    
                    return confirm(warningMessage);
                }
                
                return true;
                
            } catch (error) {
                console.error('Error checking storage quota:', error);
                return true; // Allow upload if quota check failed
            }
        }

        // Update stats display - removed old function causing syntax errors
        
        // Load and display storage statistics for both folders
        async function loadStorageStats() {
            try {
                const response = await fetch('/api/sessions/' + sessionId + '/storage', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('Failed to load storage stats');
                    return;
                }
                
                const stats = await response.json();
                console.log('Storage stats received:', stats);
                
                // Add or update storage stats display
                let storageDiv = document.getElementById('storage-stats');
                if (!storageDiv) {
                    storageDiv = document.createElement('div');
                    storageDiv.id = 'storage-stats';
                    storageDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    storageDiv.style.color = 'white';
                    storageDiv.style.padding = '15px';
                    storageDiv.style.borderRadius = '12px';
                    storageDiv.style.margin = '15px 0';
                    storageDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                    document.body.insertBefore(storageDiv, document.getElementById('fileContainer'));
                }
                
                // Build HTML content using string concatenation
                var galleryMeasured = '';
                if (stats.gallery.validFiles !== stats.gallery.fileCount) {
                    galleryMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.gallery.validFiles + ' measured)</div>';
                }
                
                var rawMeasured = '';
                if (stats.raw.validFiles !== stats.raw.fileCount) {
                    rawMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.raw.validFiles + ' measured)</div>';
                }
                
                var combinedMeasured = '';
                if (stats.combined.validFiles !== stats.combined.fileCount) {
                    combinedMeasured = '<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">(' + stats.combined.validFiles + ' measured)</div>';
                }
                
                storageDiv.innerHTML = 
                    '<h3 style="margin: 0 0 10px 0; font-size: 18px;"> Session Storage Overview</h3>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">' +
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.gallery.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Gallery Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.gallery.totalSizeFormatted + '</div>' +
                            galleryMeasured +
                        '</div>' +
                        '<div style="text-align: center;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.raw.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Raw Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.raw.totalSizeFormatted + '</div>' +
                            rawMeasured +
                        '</div>' +
                        '<div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px;">' +
                            '<div style="font-size: 20px; font-weight: bold;">' + stats.combined.fileCount + '</div>' +
                            '<div style="font-size: 12px; opacity: 0.9;">Total Files</div>' +
                            '<div style="font-size: 14px; margin-top: 2px;">' + stats.combined.totalSizeFormatted + '</div>' +
                            combinedMeasured +
                        '</div>' +
                    '</div>';
                
                console.log('Storage stats loaded successfully');
            } catch (error) {
                console.error('Error loading storage stats:', error);
            }
        }

        // Load files
        async function loadFiles() {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}`, {
                    credentials: 'include' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Load files response error:', errorText);
                    throw new Error(`Failed to load files: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                files = data.files || [];
                
                console.log(`Loaded ${files.length} files for ${folderType} folder`);
                renderFiles();
                loadStorageStats();
                
            } catch (error) {
                console.error('Load files error:', error);
                document.getElementById('fileContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Files</h3>
                        <p>${error.message}</p>
                        <button class="btn" onclick="loadFiles()">Try Again</button>
                    </div>
                `;
            }
        }

        // Render files
        function renderFiles() {
            const container = document.getElementById('fileContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (!container) {
                console.error('File container not found');
                return;
            }
            
            // File count and size now handled by storage overview section
            
            if (files.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    container.innerHTML = '';
                    container.appendChild(emptyState);
                } else {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 40px;">
                            <h3>No Files</h3>
                            <p>No files found in this ${folderType} folder</p>
                        </div>
                    `;
                }
                return;
            }
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const fileGrid = document.createElement('div');
            fileGrid.className = 'file-grid';
            
            files.forEach(file => {
                const fileCard = createFileCard(file);
                fileGrid.appendChild(fileCard);
            });
            
            container.innerHTML = '';
            container.appendChild(fileGrid);
        }

        // Create file card using DOM methods to avoid string concatenation issues
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'file-card';
            
            // File preview section
            const filePreview = document.createElement('div');
            filePreview.className = 'file-preview';
            
            const isImage = file.contentType && file.contentType.startsWith('image/');
            
            if (isImage) {
                const img = document.createElement('img');
                const thumbnailFileName = file.fileName || file.name;
                const thumbnailUrl = `/api/r2/thumbnail/${sessionId}/${encodeURIComponent(thumbnailFileName)}?size=medium`;
                
                img.src = thumbnailUrl;
                img.alt = file.name;
                img.loading = 'lazy';
                img.onclick = () => openLightbox(file.downloadUrl);
                img.onerror = () => {
                    img.style.display = 'none';
                    filePreview.innerHTML = '<div class="file-icon">IMG</div>';
                };
                
                filePreview.appendChild(img);
            } else {
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';
                fileIcon.textContent = getFileIcon(file.contentType);
                filePreview.appendChild(fileIcon);
            }
            
            card.appendChild(filePreview);
            
            // Create content wrapper for info and actions
            const fileCardContent = document.createElement('div');
            fileCardContent.className = 'file-card-content';
            
            // File info section
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = file.name;
            
            const fileMeta = document.createElement('div');
            fileMeta.className = 'file-meta';
            fileMeta.innerHTML = `
                <span>${formatDate(file.timeCreated)}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
            `;
            
            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileMeta);
            fileCardContent.appendChild(fileInfo);
            
            // File actions section
            const fileActions = document.createElement('div');
            fileActions.className = 'file-actions';
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-secondary';
            downloadBtn.innerHTML = 'Download';
            downloadBtn.onclick = () => downloadFile(file.downloadUrl, file.name);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.innerHTML = 'Delete';
            const deleteFileName = file.fileName || file.name;
            deleteBtn.dataset.deletePhoto = deleteFileName;
            deleteBtn.onclick = () => deleteFile(deleteFileName);
            
            fileActions.appendChild(downloadBtn);
            fileActions.appendChild(deleteBtn);
            fileCardContent.appendChild(fileActions);
            
            card.appendChild(fileCardContent);
            
            return card;
        }

        // Get file icon based on content type
        function getFileIcon(contentType) {
            if (!contentType) return 'üìÑ';
            
            if (contentType.startsWith('image/')) return 'üñºÔ∏è';
            if (contentType.startsWith('video/')) return 'üé•';
            if (contentType.startsWith('audio/')) return 'üéµ';
            if (contentType.includes('pdf')) return 'üìï';
            if (contentType.includes('document') || contentType.includes('word')) return '';
            if (contentType.includes('spreadsheet') || contentType.includes('excel')) return '';
            if (contentType.includes('zip') || contentType.includes('archive')) return '';
            
            return 'üìÑ';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Stats display now handled by loadStorageStats() function

        // Download file
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Download all files as ZIP
        async function downloadAllFiles() {
            console.log(' Download All button clicked!');
            
            if (!files || files.length === 0) {
                console.error('‚ùå No files available for download');
                alert('No files to download');
                return;
            }
            
            console.log(` Attempting to download ${files.length} files as ZIP`);
            console.log('üìç Request details:', {
                sessionId,
                folderType,
                clientName,
                endpoint: `/api/sessions/${sessionId}/files/${folderType}/download-zip`
            });
            
            try {
                // Show loading indicator
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '‚è≥ Creating ZIP...';
                downloadBtn.disabled = true;
                
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}/download-zip`, {
                    method: 'GET',
                    credentials: 'include', // Include cookies for authentication
                    headers: {
                        'Accept': 'application/zip',
                    }
                });
                
                console.log('üì• Server response:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type'),
                    contentLength: response.headers.get('content-length')
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Download ZIP response error:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                // Get the blob data
                const blob = await response.blob();
                console.log(' ZIP blob received:', {
                    size: blob.size,
                    type: blob.type
                });
                
                if (blob.size === 0) {
                    throw new Error('Received empty ZIP file from server');
                }
                
                // Create filename
                const filename = `${clientName.replace(/[^a-zA-Z0-9\s-]/g, '_')}_${folderType}_photos.zip`;
                console.log('üìÅ Creating download with filename:', filename);
                
                // Try multiple download methods to ensure compatibility
                try {
                    // Method 1: Direct blob download (preferred)
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    console.log(' Method 1: Triggering blob download for:', filename);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        try {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        } catch (cleanupError) {
                            console.warn('Cleanup warning:', cleanupError);
                        }
                    }, 1000);
                    
                } catch (blobError) {
                    console.warn('Blob method failed, trying alternative:', blobError);
                    
                    // Method 2: Force browser navigation (fallback)
                    const form = document.createElement('form');
                    form.method = 'GET';
                    form.action = `/api/sessions/${sessionId}/files/${folderType}/download-zip`;
                    form.target = '_blank';
                    form.style.display = 'none';
                    
                    document.body.appendChild(form);
                    console.log(' Method 2: Triggering form download');
                    form.submit();
                    
                    setTimeout(() => {
                        document.body.removeChild(form);
                    }, 1000);
                }
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 1000);
                
                console.log(` Successfully triggered ZIP download for ${folderType} folder`);
                
                // Give user feedback about the download
                setTimeout(() => {
                    alert(`ZIP download initiated! Check your browser's download folder for: ${filename}`);
                }, 500);
                
                // Restore button
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Download ZIP error:', error);
                alert('Failed to download ZIP: ' + error.message);
                
                // Restore button on error
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                downloadBtn.innerHTML = ' Download All ZIP';
                downloadBtn.disabled = false;
            }
        }

        // OLD DELETE FUNCTION REMOVED - Now using unified deletion system (loaded at bottom of page)

        // Delete all files - direct API call to server
        async function deleteAllFiles() {
            if (files.length === 0) {
                alert('No files to delete');
                return;
            }

            const confirmation = confirm(`Are you sure you want to delete ALL ${files.length} files from the ${folderType} folder? This action cannot be undone and will delete files from both the database and cloud storage.`);
            if (!confirmation) {
                return;
            }
            
            const deleteBtn = document.querySelector('button[onclick="deleteAllFiles()"]');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = 'üóëÔ∏è Deleting...';
            deleteBtn.disabled = true;
            
            try {
                console.log(`üóëÔ∏è Starting delete all for ${files.length} files in ${folderType} folder`);
                
                // Extract all filenames for batch deletion
                const filenames = files.map(file => file.fileName || file.name);
                
                // Call server endpoint to delete all files in the folder
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filenames })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log(' Delete all result:', result);
                
                // Show success message
                alert(`Successfully deleted ${result.successCount || result.deletedCount || files.length} files from ${folderType} folder. Reclaimed ${result.totalReclaimedMB || 0}MB of storage.`);
                
                // Refresh file list and storage stats
                loadFiles();
                loadStorageStats();
                
            } catch (error) {
                console.error('‚ùå Delete all error:', error);
                alert('Failed to delete files: ' + error.message);
            } finally {
                // Restore button
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        // Send to client with choice modal
        function sendToClient() {
            // Show modal with email/SMS options
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">Send Gallery Link to Client</h3>
                    <p style="margin: 0 0 20px 0; color: #666;">How would you like to send the gallery link to ${clientName}?</p>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <button onclick="sendViaEmail()" style="flex: 1; padding: 15px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                             Email
                        </button>
                        <button onclick="sendViaSMS()" style="flex: 1; padding: 15px; background: #0d9488; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üì± SMS
                        </button>
                    </div>
                    
                    <button onclick="closeModal()" style="width: 100%; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add global functions for the modal
            window.sendViaEmail = async function() {
                if (!clientEmail) {
                    alert('Client email not available. Please add email to session details first.');
                    closeModal();
                    return;
                }
                
                // Get the gallery access token from the session data
                let galleryToken = sessionData?.gallery_access_token || sessionData?.galleryAccessToken;
                
                // If no gallery token exists, create one first
                if (!galleryToken) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}/create-gallery`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            galleryToken = data.accessToken;
                            // Update the local session data
                            if (sessionData) {
                                sessionData.gallery_access_token = galleryToken;
                                sessionData.galleryAccessToken = galleryToken;
                            }
                        } else {
                            alert('Failed to create gallery. Please try again.');
                            closeModal();
                            return;
                        }
                    } catch (error) {
                        console.error('Error creating gallery:', error);
                        alert('Failed to create gallery. Please try again.');
                        closeModal();
                        return;
                    }
                }
                
                // Use the stable public URL for client access
                const clientGalleryUrl = `https://workspace.lancecasselman.repl.co/gallery/${galleryToken}`;
                const subject = `Your Photography Gallery - ${clientName}`;
                const body = `Hi ${clientName},

Your photography gallery is ready for viewing and download!

 View Your Gallery: ${clientGalleryUrl}

You can:
‚Ä¢ View all your photos in high resolution
‚Ä¢ Download individual photos  
‚Ä¢ Download selected photos as a ZIP file
‚Ä¢ Download your entire gallery

The gallery will remain available for download. If you have any questions or need assistance, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography`;

                const mailtoUrl = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoUrl, '_blank');
                closeModal();
            };
            
            window.sendViaSMS = async function() {
                if (!clientPhoneNumber) {
                    alert('Client phone number not available. Please add phone number to session details first.');
                    closeModal();
                    return;
                }
                
                // Get the gallery access token from the session data
                let galleryToken = sessionData?.gallery_access_token || sessionData?.galleryAccessToken;
                
                // If no gallery token exists, create one first
                if (!galleryToken) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}/create-gallery`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            galleryToken = data.accessToken;
                            // Update the local session data
                            if (sessionData) {
                                sessionData.gallery_access_token = galleryToken;
                                sessionData.galleryAccessToken = galleryToken;
                            }
                        } else {
                            alert('Failed to create gallery. Please try again.');
                            closeModal();
                            return;
                        }
                    } catch (error) {
                        console.error('Error creating gallery:', error);
                        alert('Failed to create gallery. Please try again.');
                        closeModal();
                        return;
                    }
                }
                
                // Use the stable public URL for client access
                const clientGalleryUrl = `https://workspace.lancecasselman.repl.co/gallery/${galleryToken}`;
                const message = `Hi ${clientName}! Your photo gallery is ready: ${clientGalleryUrl} - Lance Photography`;
                
                const smsUrl = `sms:${clientPhoneNumber}?body=${encodeURIComponent(message)}`;
                window.open(smsUrl, '_blank');
                closeModal();
            };
            
            window.closeModal = function() {
                document.body.removeChild(modal);
                delete window.sendViaEmail;
                delete window.sendViaSMS;
                delete window.closeModal;
            };
        }

        // Refresh files
        function refreshFiles() {
            loadFiles();
        }

        // Lightbox functions
        let currentImage = null;
        
        function openLightbox(imageSrc) {
            currentImage = imageSrc;
            document.getElementById('lightboxImage').src = imageSrc;
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'flex';
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
            lightbox.classList.remove('active');
        }
        
        // Print ordering functions
        let cart = [];
        
        function orderPrint() {
            if (!currentImage) return;
            document.getElementById('printPreview').src = currentImage;
            document.getElementById('printModal').classList.add('active');
        }
        
        function closePrintModal() {
            document.getElementById('printModal').classList.remove('active');
        }
        
        function addToCart() {
            const selectedSize = document.querySelector('.print-option.selected');
            if (!selectedSize) {
                alert('Please select a print size');
                return;
            }
            
            const selectedFinish = document.querySelector('input[name="finish"]:checked');
            
            const item = {
                photo: currentImage,
                size: selectedSize.dataset.size,
                price: parseFloat(selectedSize.dataset.price),
                finish: selectedFinish.value,
                quantity: 1
            };
            
            cart.push(item);
            localStorage.setItem('printCart', JSON.stringify(cart));
            
            updateCartDisplay();
            closePrintModal();
            alert('Added to cart!');
        }
        
        function updateCartDisplay() {
            const cartIcon = document.getElementById('cartIcon');
            const cartCount = cartIcon.querySelector('.cart-count');
            
            if (cart.length > 0) {
                cartIcon.classList.add('visible');
                cartCount.textContent = cart.length;
            } else {
                cartIcon.classList.remove('visible');
            }
        }
        
        function showCart() {
            const modal = document.getElementById('cartModal');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>Your cart is empty</p>';
                cartTotal.textContent = '';
            } else {
                cartItems.innerHTML = cart.map((item, index) => `
                    <div class="cart-item">
                        <img src="${item.photo}" alt="Print">
                        <div style="flex: 1;">
                            <h4>${item.size}" ${item.finish} Print</h4>
                            <p>$${item.price.toFixed(2)}</p>
                        </div>
                        <button onclick="removeFromCart(${index})" class="btn btn-danger" style="padding: 5px 10px;">Remove</button>
                    </div>
                `).join('');
                
                const total = cart.reduce((sum, item) => sum + item.price, 0);
                cartTotal.textContent = `Total: $${total.toFixed(2)}`;
            }
            
            modal.classList.add('active');
        }
        
        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            localStorage.setItem('printCart', JSON.stringify(cart));
            updateCartDisplay();
            showCart();
        }
        
        async function checkout() {
            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }
            
            try {
                const response = await fetch('/api/print/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        items: cart
                    })
                });
                
                const data = await response.json();
                
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    alert('Checkout processing...');
                    cart = [];
                    localStorage.removeItem('printCart');
                    updateCartDisplay();
                    closeCart();
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Error processing checkout');
            }
        }
        
        function downloadImage() {
            if (!currentImage) return;
            const link = document.createElement('a');
            link.href = currentImage;
            link.download = 'photo.jpg';
            link.click();
        }
        
        // Add click handlers for print options
        document.addEventListener('click', function(e) {
            if (e.target.closest('.print-option')) {
                document.querySelectorAll('.print-option').forEach(opt => opt.classList.remove('selected'));
                e.target.closest('.print-option').classList.add('selected');
            }
        });
        
        // Load cart from localStorage on page load
        const savedCart = localStorage.getItem('printCart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
            updateCartDisplay();
        }

        // Close lightbox with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });
    </script>
    
    <!-- Import unified deletion system -->
    <script src="/static/js/photo-deletion.js"></script>
    <script>
        // Add showMessage function for compatibility with deletion system
        function showMessage(message, type) {
            console.log(`${type.toUpperCase()}: ${message}`);
            if (type === 'error') {
                alert(`Error: ${message}`);
            } else if (type === 'success') {
                console.log(` Success: ${message}`);
            } else if (type === 'warning') {
                console.log(` Warning: ${message}`);
            } else {
                console.log(`‚ÑπÔ∏è Info: ${message}`);
            }
        }

        // Initialize unified deletion system - ensure no conflicts
        if (typeof window.photoDeletion === 'undefined') {
            window.photoDeletion = null;
            
            // Wait for PhotoDeletion class to be available
            window.initializePhotoDeletion = function() {
                if (typeof PhotoDeletion !== 'undefined' && !window.photoDeletion) {
                    window.photoDeletion = new PhotoDeletion();
                    console.log('PhotoDeletion system initialized');
                    return true;
                } else {
                    console.warn('PhotoDeletion class not yet available');
                    return false;
                }
            };
            
            // Try to initialize immediately
            if (!window.initializePhotoDeletion()) {
                // If not available immediately, try again after a short delay
                setTimeout(() => {
                    if (!window.initializePhotoDeletion()) {
                        console.error('PhotoDeletion class failed to load');
                    }
                }, 100);
            }
        }
        
        // Add loadStorageStats function to refresh storage statistics (global scope)
        window.loadStorageStats = async function loadStorageStats() {
            try {
                const response = await fetch('/api/global-storage-stats', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('Storage stats updated:', stats);
                    
                    // Update any storage display elements
                    const storageElement = document.querySelector('.storage-info');
                    if (storageElement) {
                        storageElement.textContent = `Total: ${stats.combined.totalSizeFormatted}`;
                    }
                }
            } catch (error) {
                console.warn('Failed to load storage stats:', error);
            }
        };
        
        // Define deleteFile function to use unified deletion (global scope)
        window.deleteFile = async function deleteFile(fileName) {
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }
            
            try {
                console.log(`Attempting to delete ${fileName} from session ${sessionId}, folder ${folderType}`);
                
                // Ensure PhotoDeletion is available
                if (!window.photoDeletion) {
                    console.log('Initializing PhotoDeletion system...');
                    if (!window.initializePhotoDeletion()) {
                        throw new Error('PhotoDeletion system is not available');
                    }
                }
                
                // Use unified deletion system
                const result = await window.photoDeletion.deletePhoto(sessionId, folderType, fileName);
                console.log('Delete result:', result);
                
                // Refresh file list and storage stats after successful deletion
                console.log('Refreshing files after deletion...');
                loadFiles();
                loadStorageStats();
                
            } catch (error) {
                console.error('Delete error:', error);
                
                // Fallback: Try direct API call if PhotoDeletion fails
                console.log('Attempting direct API deletion...');
                try {
                    const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}/${encodeURIComponent(fileName)}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Server responded with ${response.status}: ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('Direct API deletion success:', result);
                    
                    if (result.success) {
                        alert(`File deleted successfully: ${fileName}`);
                        loadFiles();
                        loadStorageStats();
                    } else {
                        alert(`Deletion failed: ${result.error}`);
                    }
                } catch (apiError) {
                    console.error('Direct API deletion also failed:', apiError);
                    alert('Failed to delete file: ' + apiError.message);
                }
            }
        };
    </script>
</body>
</html>