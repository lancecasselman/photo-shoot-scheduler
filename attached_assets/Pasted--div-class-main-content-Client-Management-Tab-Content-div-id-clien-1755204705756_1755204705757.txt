<div class="main-content">

        <!-- Client Management Tab Content -->
        <div id="clientsTab" class="tab-content">
            <div class="content-header">
                <h1>Session Management</h1>
                <p>Manage your photography sessions and client bookings</p>
            </div>
        
        <!-- ENHANCED CLIENT DASHBOARD CONTROLS -->
        <div class="client-dashboard-controls">
            <div class="search-and-filters">
                <!-- Real-time Search Bar -->
                <div class="search-section">
                    <input type="text" id="clientSearch" placeholder="Search clients by name, location, or email..." oninput="filterSessions()" style="width: 100%; padding: 12px; border-radius: var(--border-radius); border: 2px solid var(--gold-muted); background: var(--bg-primary); color: var(--text-primary); font-size: 16px; font-family: var(--font-body);">
                </div>
                
                <!-- Compact Filter Controls with Dropdowns -->
                <div class="filter-controls-compact">
                    <!-- Filter Toggle Buttons -->
                    <div class="filter-toggle-row" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="filter-toggle-btn" onclick="toggleFilterSection('status')" style="background: #d4af37; color: #1a1a1a; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìã Status Filters <span id="status-indicator" style="opacity: 0.7;">‚ñº</span>
                        </button>
                        <button type="button" class="filter-toggle-btn" onclick="toggleFilterSection('date')" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìÖ Date Range <span id="date-indicator" style="opacity: 0.7;">‚ñº</span>
                        </button>
                        <button type="button" class="filter-toggle-btn" onclick="toggleFilterSection('type')" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üéØ Session Type <span id="type-indicator" style="opacity: 0.7;">‚ñº</span>
                        </button>
                        <button type="button" class="filter-toggle-btn" onclick="toggleFilterSection('sort')" style="background: #9C27B0; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üîÑ Sort Options <span id="sort-indicator" style="opacity: 0.7;">‚ñº</span>
                        </button>
                    </div>

                    <!-- Collapsible Filter Sections -->
                    <div id="status-filters" class="filter-dropdown" style="display: none; background: rgba(212,175,55,0.1); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #d4af37;">
                        <div class="checkbox-filters" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; color: #333; font-weight: 500;"><input type="checkbox" id="filterContractSigned" onchange="filterSessions()" style="margin: 0;"> ‚úÖ Contract Signed</label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #333; font-weight: 500;"><input type="checkbox" id="filterPaid" onchange="filterSessions()" style="margin: 0;"> üí∞ Paid</label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #333; font-weight: 500;"><input type="checkbox" id="filterDelivered" onchange="filterSessions()" style="margin: 0;"> üì¶ Delivered</label>
                        </div>
                    </div>

                    <div id="date-filters" class="filter-dropdown" style="display: none; background: rgba(76,175,80,0.1); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #4CAF50;">
                        <div class="date-range-controls" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #333; font-weight: 600;">From:</label>
                                <input type="date" id="dateFromFilter" onchange="filterSessions()" style="padding: 8px; border: 2px solid #4CAF50; border-radius: 4px; background: white;">
                            </div>
                            <span style="color: #333; font-weight: 600;">to</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #333; font-weight: 600;">To:</label>
                                <input type="date" id="dateToFilter" onchange="filterSessions()" style="padding: 8px; border: 2px solid #4CAF50; border-radius: 4px; background: white;">
                            </div>
                        </div>
                    </div>

                    <div id="type-filters" class="filter-dropdown" style="display: none; background: rgba(33,150,243,0.1); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #2196F3;">
                        <select id="sessionTypeFilter" onchange="filterSessions()" style="width: 100%; max-width: 300px; padding: 10px; border: 2px solid #2196F3; border-radius: 6px; background: white; font-size: 14px;">
                            <option value="">üìã All Types</option>
                            <option value="Wedding">üíí Wedding</option>
                            <option value="Family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                            <option value="Senior">üéì Senior</option>
                            <option value="Portrait">üë§ Portrait</option>
                            <option value="Event">üéâ Event</option>
                        </select>
                    </div>

                    <div id="sort-filters" class="filter-dropdown" style="display: none; background: rgba(156,39,176,0.1); border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #9C27B0;">
                        <select id="sortOptions" onchange="sortSessions()" style="width: 100%; max-width: 350px; padding: 10px; border: 2px solid #9C27B0; border-radius: 6px; background: white; font-size: 14px;">
                            <option value="calendar-upcoming">üìÖ Calendar (Upcoming First)</option>
                            <option value="date-desc">üìÖ Date (Newest First)</option>
                            <option value="date-asc" selected="">üìÖ Date (Oldest First)</option>
                            <option value="calendar-past">üìÖ Calendar (Most Recent Past)</option>
                            <option value="name-asc">üë§ Client Name (A-Z)</option>
                            <option value="name-desc">üë§ Client Name (Z-A)</option>
                            <option value="unpaid-first">üí∞ Unpaid First</option>
                        </select>
                    </div>
                </div>
                
                <!-- Archive Toggle & Actions -->
                <div class="archive-and-actions">
                    <label class="archive-toggle">
                        <input type="checkbox" id="showArchivedToggle" onchange="toggleArchivedSessions()">
                        Show Archived Sessions
                    </label>
                    <button onclick="clearAllFilters()" class="btn-secondary">Clear Filters</button>
                    <button onclick="exportAllSessions()" class="btn-primary"> Export All Sessions</button>
                </div>
            </div>
        </div>
        
        <!-- Session Form -->
        <div class="session-form">
            <h2>Add New Session</h2>
            <form id="sessionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required="" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <input type="text" id="sessionType" name="sessionType" required="" placeholder="Wedding, Portrait, etc.">
                    </div>
                    <div class="form-group">
                        <label for="dateTime">Date &amp; Time</label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required="" style="cursor: pointer;">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required="" placeholder="Session location">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required="" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required="" placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" step="0.01" required="" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" required="" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" placeholder="Session notes..."></textarea>
                    </div>
                </div>
                
                <!-- Admin Workflow Checkboxes -->
                <div class="admin-checkboxes">
                    <h3>Admin Workflow Status</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contractSigned" name="contractSigned">
                            <label for="contractSigned">Contract Signed</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="paid" name="paid">
                            <label for="paid">Paid</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edited" name="edited">
                            <label for="edited">Edited</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="delivered" name="delivered">
                            <label for="delivered">Delivered</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="reminderEnabled" name="reminderEnabled">
                            <label for="reminderEnabled">Send Reminder</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sendReminder" name="sendReminder">
                            <label for="sendReminder">Send session reminder 24 hours before</label>
                        </div>
                        <div class="checkbox-group">

                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Session</button>

            </form>
        </div>

        <!-- Global Storage Overview -->
        <div id="globalStorageOverview" class="global-storage-section">
            <div class="storage-header">
                <h2>üìä Platform Storage Overview</h2>
                <button class="btn btn-secondary" onclick="refreshGlobalStorage()">üîÑ Refresh</button>
            </div>
            <div class="storage-stats-grid">
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalSessions">-</div>
                    <div class="storage-stat-label">Total Sessions</div>
                </div>
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalGalleryStorage">-</div>
                    <div class="storage-stat-label">Gallery Storage</div>
                </div>
                <div class="storage-stat-card">
                    <div class="storage-stat-number" id="totalRawStorage">-</div>
                    <div class="storage-stat-label">Raw Storage</div>
                </div>
                <div class="storage-stat-card highlight">
                    <div class="storage-stat-number" id="totalCombinedStorage">-</div>
                    <div class="storage-stat-label">Total Storage Used</div>
                </div>
            </div>
        </div>

        <!-- Sessions Display -->
        <div id="sessionsContainer" class="sessions-grid">
                <div class="session-list-item" data-session-id="8f1677ba-5a81-4de1-b9b8-8ced20385a88" onclick="toggleSessionDetails('8f1677ba-5a81-4de1-b9b8-8ced20385a88')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">Amanda casselman</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar Thu, Aug 14, 2025, 04:27 PM</span>
                                <span class="session-location"> home</span>
                                <span class="session-duration">‚è±Ô∏è 30 minutes</span>
                                <span class="session-price">Money $15</span>
                                <span class="session-deposit" style="color: #28a745; font-weight: 600;">Deposit: $7.50</span>
                                <span class="session-remaining" style="color: #d4af37; font-weight: 600;">Remaining: $7.50</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-8f1677ba-5a81-4de1-b9b8-8ced20385a88">‚ñº</div>
                    </div>
                    
                    <div class="session-details" id="details-8f1677ba-5a81-4de1-b9b8-8ced20385a88" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:amandacasselman55@yahoo.com" style="color: #d4af37;">amandacasselman55@yahoo.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">18434617260</span>
                                    <button onclick="callClient('18434617260'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('18434617260', 'Amanda casselman', '8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Thu, Aug 14, 2025, 04:27 PM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> family
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 30 minutes
                                </div>
                                <div class="detail-item">

                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_8f1677ba-5a81-4de1-b9b8-8ced20385a88" onchange="toggleWorkflowStatus('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_8f1677ba-5a81-4de1-b9b8-8ced20385a88">Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_8f1677ba-5a81-4de1-b9b8-8ced20385a88" onchange="toggleWorkflowStatus('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_8f1677ba-5a81-4de1-b9b8-8ced20385a88">Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_8f1677ba-5a81-4de1-b9b8-8ced20385a88" onchange="toggleWorkflowStatus('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_8f1677ba-5a81-4de1-b9b8-8ced20385a88">Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_8f1677ba-5a81-4de1-b9b8-8ced20385a88" onchange="toggleWorkflowStatus('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_8f1677ba-5a81-4de1-b9b8-8ced20385a88">Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_8f1677ba-5a81-4de1-b9b8-8ced20385a88" onchange="toggleWorkflowStatus('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_8f1677ba-5a81-4de1-b9b8-8ced20385a88">Send Reminder</label>
                                </div>

                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="openUpdateSessionModal('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">Update Session</button>
                                <button onclick="addToCalendar('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">Calendar</button>
                                <button onclick="openEmailClient('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">Email</button>
                                <button onclick="openBookingAgreementModal('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary" data-session-id="8f1677ba-5a81-4de1-b9b8-8ced20385a88">
                                    üìÑ <span class="agreement-status">Booking Agreement</span>
                                </button>

                                
                                    <button onclick="createInvoiceWithTipping('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">üí∞ Send Invoice</button>
                                    <button onclick="sendDepositInvoice('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-warning" style="background-color: #fd7e14; color: white;">üí≥ Send Deposit</button>
                                    <button onclick="openPaymentPlanModal('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-secondary">Export PDF</button>

                                <button onclick="deleteSession('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-danger">Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('8f1677ba-5a81-4de1-b9b8-8ced20385a88', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Simplified Gallery and Storage Actions -->
                        <div class="session-file-actions">
                            <h4>Files &amp; Storage</h4>
                            <div class="file-action-buttons">
                                <button onclick="openGalleryWindow('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-primary">üì∏ Open Gallery</button>
                                <button onclick="openRawStorageWindow('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-primary">üìÅ Open Raw Storage</button>
                                <button onclick="sendGalleryToClient('8f1677ba-5a81-4de1-b9b8-8ced20385a88'); event.stopPropagation();" class="btn btn-success">‚úâÔ∏è Send to Client</button>
                            </div>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
                
                <div class="session-list-item" data-session-id="5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onclick="toggleSessionDetails('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">lance</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar Fri, Aug 15, 2025, 05:13 PM</span>
                                <span class="session-location"> test</span>
                                <span class="session-duration">‚è±Ô∏è 30 minutes</span>
                                <span class="session-price">Money $20</span>
                                <span class="session-deposit" style="color: #28a745; font-weight: 600;">Deposit: $13.00</span>
                                <span class="session-remaining" style="color: #d4af37; font-weight: 600;">Remaining: $7.00</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">‚ñº</div>
                    </div>
                    
                    <div class="session-details" id="details-5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:lancecasselman@icloud.com" style="color: #d4af37;">lancecasselman@icloud.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">18434851315</span>
                                    <button onclick="callClient('18434851315'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('18434851315', 'lance', '5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Fri, Aug 15, 2025, 05:13 PM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> family
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 30 minutes
                                </div>
                                <div class="detail-item">

                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onchange="toggleWorkflowStatus('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onchange="toggleWorkflowStatus('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onchange="toggleWorkflowStatus('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onchange="toggleWorkflowStatus('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6" onchange="toggleWorkflowStatus('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">Send Reminder</label>
                                </div>

                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="openUpdateSessionModal('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">Update Session</button>
                                <button onclick="addToCalendar('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">Calendar</button>
                                <button onclick="openEmailClient('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">Email</button>
                                <button onclick="openBookingAgreementModal('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary" data-session-id="5bad52e9-1bbb-4c4a-b7fc-d826788c69e6">
                                    üìÑ <span class="agreement-status">Booking Agreement</span>
                                </button>

                                
                                    <button onclick="createInvoiceWithTipping('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">üí∞ Send Invoice</button>
                                    <button onclick="sendDepositInvoice('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-warning" style="background-color: #fd7e14; color: white;">üí≥ Send Deposit</button>
                                    <button onclick="openPaymentPlanModal('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-secondary">Export PDF</button>

                                <button onclick="deleteSession('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-danger">Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Simplified Gallery and Storage Actions -->
                        <div class="session-file-actions">
                            <h4>Files &amp; Storage</h4>
                            <div class="file-action-buttons">
                                <button onclick="openGalleryWindow('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-primary">üì∏ Open Gallery</button>
                                <button onclick="openRawStorageWindow('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-primary">üìÅ Open Raw Storage</button>
                                <button onclick="sendGalleryToClient('5bad52e9-1bbb-4c4a-b7fc-d826788c69e6'); event.stopPropagation();" class="btn btn-success">‚úâÔ∏è Send to Client</button>
                            </div>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
                
                <div class="session-list-item" data-session-id="b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onclick="toggleSessionDetails('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">korbe</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar Fri, Aug 29, 2025, 04:54 AM</span>
                                <span class="session-location"> The Lake House at Bulow</span>
                                <span class="session-duration">‚è±Ô∏è 5 hours</span>
                                <span class="session-price">Money $450</span>
                                
                                
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">‚ñº</div>
                    </div>
                    
                    <div class="session-details" id="details-b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:korbew@me.com" style="color: #d4af37;">korbew@me.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">8436937762</span>
                                    <button onclick="callClient('8436937762'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('8436937762', 'korbe', 'b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Fri, Aug 29, 2025, 04:54 AM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> wedding
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 5 hours
                                </div>
                                <div class="detail-item">

                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onchange="toggleWorkflowStatus('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onchange="toggleWorkflowStatus('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onchange="toggleWorkflowStatus('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onchange="toggleWorkflowStatus('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7" onchange="toggleWorkflowStatus('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">Send Reminder</label>
                                </div>

                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="openUpdateSessionModal('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">Update Session</button>
                                <button onclick="addToCalendar('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">Calendar</button>
                                <button onclick="openEmailClient('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">Email</button>
                                <button onclick="openBookingAgreementModal('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary" data-session-id="b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7">
                                    üìÑ <span class="agreement-status">Booking Agreement</span>
                                </button>

                                
                                    <button onclick="createInvoiceWithTipping('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">üí∞ Send Invoice</button>
                                    <button onclick="sendDepositInvoice('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-warning" style="background-color: #fd7e14; color: white;">üí≥ Send Deposit</button>
                                    <button onclick="openPaymentPlanModal('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-secondary">Export PDF</button>

                                <button onclick="deleteSession('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-danger">Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Simplified Gallery and Storage Actions -->
                        <div class="session-file-actions">
                            <h4>Files &amp; Storage</h4>
                            <div class="file-action-buttons">
                                <button onclick="openGalleryWindow('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-primary">üì∏ Open Gallery</button>
                                <button onclick="openRawStorageWindow('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-primary">üìÅ Open Raw Storage</button>
                                <button onclick="sendGalleryToClient('b88ec26b-a8b8-48b9-9dba-271fe6ecfaf7'); event.stopPropagation();" class="btn btn-success">‚úâÔ∏è Send to Client</button>
                            </div>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
                </div>
    </div>





    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3>Create Payment Plan</h3>
            
            <div class="payment-plan-form">
                <div class="payment-plan-grid">
                    <div class="form-group">
                        <label for="planTotalAmount">Total Amount ($)</label>
                        <input type="number" id="planTotalAmount" step="0.01" placeholder="0.00" required="">
                    </div>
                    <div class="form-group">
                        <label for="planStartDate">Start Date</label>
                        <input type="date" id="planStartDate" required="">
                    </div>
                    <div class="form-group">
                        <label for="planEndDate">End Date</label>
                        <input type="date" id="planEndDate" required="">
                    </div>
                    <div class="form-group">
                        <label for="planReminderDays">Reminder Days Before</label>
                        <select id="planReminderDays">
                            <option value="1">1 day</option>
                            <option value="3" selected="">3 days</option>
                            <option value="7">1 week</option>
                        </select>
                    </div>
                </div>
                
                <div class="payment-plan-summary" id="paymentPlanSummary" style="display: none;">
                    <h4>üìã Payment Plan Summary</h4>
                    <div id="paymentSummaryDetails"></div>
                    <div class="payment-schedule" id="paymentSchedulePreview"></div>
                </div>
                
                <div class="payment-plan-info">
                    <h4>‚ÑπÔ∏è How Payment Plans Work</h4>
                    <ul>
                        <li>Automatically calculates equal monthly payments</li>
                        <li>Sends Stripe invoices each month via email</li>
                        <li>Tracks payments and sends reminders</li>
                        <li>Updates session status when fully paid</li>
                    </ul>
                </div>
                
                <div class="payment-actions">
                    <button class="btn btn-primary" id="createPaymentPlanBtn" onclick="createPaymentPlan()">Create Payment Plan</button>
                    <button class="btn btn-secondary" onclick="calculatePaymentPreview()">Preview Payments</button>
                    <button class="btn btn-secondary" onclick="closePaymentPlanModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Plan View Modal -->
    <div id="paymentPlanViewModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3 id="paymentPlanViewTitle">Payment Plan Details</h3>
            
            <div id="paymentPlanViewContent">
                <!-- Payment plan details will be loaded here -->
            </div>
            
            <div class="payment-actions">
                <button class="btn btn-primary" onclick="processAutomatedPayments()">Process All Due Payments</button>
                <button class="btn btn-secondary" onclick="closePaymentPlanViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Define contract functions early to prevent reference errors
        window.sendContractToClient = async function(contractId) {
            try {
                console.log('sendContractToClient called with contractId:', contractId);
                
                showMessage('Preparing contract for sending...', 'info');

                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to prepare contract for sending');
                }

                // Fix the result structure to match what modal expects
                const contractData = {
                    contract: result.contract || result,
                    signingUrl: result.signingUrl || result.url || '',
                    emailData: result.emailData || {}
                };

                showContractSendingModal(contractId, contractData);

            } catch (error) {
                console.error('Error preparing contract:', error);
                showMessage(`Error: ${error.message || 'Unknown error occurred'}`, 'error');
            }
        }

        function showContractSendingModal(contractId, contractData) {
            const isResend = contractData.contract?.status === 'sent' || contractData.contract?.status === 'signed';
            const modalTitle = isResend ? 'Resend Contract' : 'Send Contract';
            
            const modalHTML = `
                <div id="contractSendModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">${modalTitle}</h2>
                            <button onclick="closeContractSendModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        ${isResend ? `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <p style="margin: 0; color: #856404;"><strong>Note:</strong> This contract has already been sent. Use the options below to resend it with any updates.</p>
                            </div>
                        ` : ''}
                        
                        <div class="contract-send-info" style="margin-bottom: 25px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #8b7355; margin: 0 0 15px 0;">Contract Details</h4>
                                <p><strong>Title:</strong> ${contractData.contract?.contract_title || 'Contract'}</p>
                                <p><strong>Client:</strong> ${contractData.contract?.client_name || 'Client'}</p>
                                <p><strong>Email:</strong> ${contractData.contract?.client_email || 'No email'}</p>
                                <p><strong>Phone:</strong> ${contractData.contract?.client_phone || 'No phone'}</p>
                            </div>
                            
                            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                                <h5 style="color: #28a745; margin: 0 0 10px 0;">Contract Signing URL</h5>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="signingUrlCopy" value="${contractData.signingUrl || ''}" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <button onclick="copySigningUrl()" class="btn btn-secondary">Copy URL</button>
                                </div>
                            </div>
                        </div>

                        <div class="send-options">
                            <button onclick="sendViaEmail('${contractId}', '${contractData.contract?.client_email}', '${contractData.signingUrl}', event)" 
                                    class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;">
                                üìß Open Email Client
                            </button>
                            
                            <button onclick="sendViaText('${contractId}', '${contractData.signingUrl}', '${contractData.contract?.client_name}', '${contractData.contract?.client_phone}', event)" 
                                    class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;">
                                üí¨ Send via Text Message
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeContractSendModal() {
            const modal = document.getElementById('contractSendModal');
            if (modal) modal.remove();
        }

        function copySigningUrl() {
            const urlInput = document.getElementById('signingUrlCopy');
            if (urlInput) {
                urlInput.select();
                document.execCommand('copy');
                showMessage('Contract URL copied to clipboard!', 'success');
            }
        }

        async function sendViaEmail(contractId, clientEmail, signingUrl, event) {
            // Declare button variables at function scope
            const emailBtn = event ? event.target : document.querySelector('button[onclick*="sendViaEmail"]');
            const originalText = emailBtn ? emailBtn.innerHTML : 'üìß Send via Email';
            
            try {
                // Show loading state
                if (emailBtn) {
                    emailBtn.innerHTML = 'üìß Opening Email...';
                    emailBtn.disabled = true;
                }
                
                // Get client name from contract data
                const clientName = document.querySelector('.contract-send-info p:nth-of-type(2)')?.textContent?.replace('Client: ', '') || 'Client';
                
                // Create email subject and body
                const subject = encodeURIComponent(`Photography Contract - Ready for Signing`);
                const body = encodeURIComponent(`Hi ${clientName},

Your photography contract is ready for review and signing. Please click the link below to access your contract:

${signingUrl}

If you have any questions, please don't hesitate to reach out.

Best regards,
Lance
The Legacy Photography`);
                
                // Create mailto link
                const mailtoLink = `mailto:${clientEmail}?subject=${subject}&body=${body}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                // Show success message and close modal
                showMessage(`Email client opened with contract details for ${clientEmail}`, 'success');
                closeContractSendModal();
                
            } catch (error) {
                console.error('Error opening email client:', error);
                showMessage(`Failed to open email client: ${error.message}`, 'error');
                
                // Restore button state
                if (emailBtn) {
                    emailBtn.innerHTML = originalText;
                    emailBtn.disabled = false;
                }
            }
        }

        // View signed copy of contract
        window.viewSignedCopy = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch signed contract');
                }
                
                const contract = await response.json();
                showSignedContractModal(contract);
                
            } catch (error) {
                console.error('Error fetching signed contract:', error);
                showMessage('Failed to load signed contract: ' + error.message, 'error');
            }
        }

        // Show signed contract modal
        function showSignedContractModal(contract) {
            const signedDate = contract.signed_date ? new Date(contract.signed_date).toLocaleDateString() : 'Not available';
            
            // Create signature display
            let signatureDisplay = '';
            if (contract.client_signature) {
                // Check if it's a base64 data URL
                if (contract.client_signature.startsWith('data:image/')) {
                    signatureDisplay = `<img src="${contract.client_signature}" style="max-width: 200px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px; background: white;" alt="Client Signature">`;
                } else {
                    signatureDisplay = `<div style="padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-style: italic;">Signature: ${contract.client_signature}</div>`;
                }
            } else {
                signatureDisplay = '<div style="padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-style: italic;">Digital signature on file</div>';
            }
            
            const modalHTML = `
                <div id="signedContractModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 900px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">üìÑ Signed Contract - ${contract.contract_title}</h2>
                            <button onclick="closeModal('signedContractModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="signature-info" style="background: #e8f5e8; border: 1px solid #c3e6c3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #28a745; margin: 0 0 15px 0;">‚úÖ Contract Signed</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div><strong>Client:</strong> ${contract.client_name}</div>
                                <div><strong>Email:</strong> ${contract.client_email}</div>
                                <div><strong>Signed Date:</strong> ${signedDate}</div>
                                <div><strong>Contract Type:</strong> ${contract.contract_title}</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>Client Signature:</strong>
                                <div style="margin-top: 8px;">
                                    ${signatureDisplay}
                                </div>
                            </div>
                        </div>
                        
                        <div class="contract-content" style="background: white; border: 2px solid #d4af37; border-radius: 6px; padding: 30px; margin-bottom: 20px; font-family: 'Times New Roman', serif; line-height: 1.6; white-space: pre-wrap; max-height: 500px; overflow-y: auto;">
${contract.contract_content}
                        </div>
                        
                        <div style="text-align: center; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <p style="margin: 0 0 15px 0; color: #666; font-style: italic;">This is a digitally signed copy stored for your records</p>
                            <button onclick="downloadSignedContractPDF('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                üìÑ Download PDF Copy
                            </button>
                            <button onclick="printSignedContract('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                üñ®Ô∏è Print Contract
                            </button>
                            <button onclick="closeModal('signedContractModal')" class="btn btn-secondary">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Print signed contract
        window.printSignedContract = function(contractId) {
            const contractContent = document.querySelector('#signedContractModal .contract-content');
            const signatureInfo = document.querySelector('#signedContractModal .signature-info');
            
            if (contractContent) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Signed Contract</title>
                            <style>
                                body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 40px; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                                .signature-section { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: #f9f9f9; }
                                .content { white-space: pre-wrap; margin-bottom: 30px; }
                                img { max-width: 200px; max-height: 80px; }
                                @media print { .no-print { display: none; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>SIGNED CONTRACT</h1>
                                <p>Document printed on: ${new Date().toLocaleDateString()}</p>
                            </div>
                            <div class="content">${contractContent.innerHTML}</div>
                            <div class="signature-section">
                                <h3>Digital Signature Information</h3>
                                ${signatureInfo ? signatureInfo.innerHTML : 'Signature information not available'}
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        async function sendViaText(contractId, signingUrl, clientName, clientPhone, event) {
            // Declare button variables at function scope
            const smsBtn = event ? event.target : document.querySelector('button[onclick*="sendViaText"]');
            const originalText = smsBtn ? smsBtn.innerHTML : 'üí¨ Send via Text Message';
            
            try {
                // Show loading state
                if (smsBtn) {
                    smsBtn.innerHTML = 'üí¨ Sending SMS...';
                    smsBtn.disabled = true;
                }
                
                const response = await fetch('/api/contracts/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        contractId,
                        clientPhone,
                        clientName,
                        signingUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`Contract SMS sent successfully to ${result.sentTo}!`, 'success');
                    closeContractSendModal();
                } else {
                    throw new Error(result.error || 'Failed to send SMS');
                }
                
            } catch (error) {
                console.error('Error sending SMS:', error);
                
                // Check if it's an SMS configuration error
                if (error.message.includes('SMS service not configured')) {
                    showMessage('SMS service not configured. Opening default messaging app instead...', 'warning');
                    
                    // Fallback to opening default messaging app
                    const cleanPhone = clientPhone ? clientPhone.replace(/[^\d]/g, '') : '';
                    const message = encodeURIComponent(`Hi ${clientName}! Your photography contract is ready for signing: ${signingUrl} - Lance, The Legacy Photography`);
                    const smsLink = cleanPhone ? `sms:+1${cleanPhone}?body=${message}` : `sms:?body=${message}`;
                    window.location.href = smsLink;
                    closeContractSendModal();
                } else {
                    showMessage(`Failed to send SMS: ${error.message}`, 'error');
                }
                
                // Restore button state
                if (smsBtn) {
                    smsBtn.innerHTML = originalText;
                    smsBtn.disabled = false;
                }
            }
        }

        let sessions = [];

        let currentPaymentPlanSessionId = null;
        
        // Primary payment plan function - consolidated implementation
        window.openPaymentPlanModal = function(sessionIdOrSession) {
            console.log('Opening payment plan modal for session:', sessionIdOrSession);
            
            // Handle both sessionId string and session object
            let session;
            if (typeof sessionIdOrSession === 'string') {
                session = sessions.find(s => s.id === sessionIdOrSession);
                if (!session) {
                    console.error('Session not found:', sessionIdOrSession);
                    showMessage('Session not found', 'error');
                    return;
                }
            } else {
                session = sessionIdOrSession;
            }
            
            // Set current session
            currentPaymentPlanSessionId = session.id;
            
            // Remove test modal code since it works
            
            // Check if showMessage function exists
            if (typeof showMessage !== 'function') {
                console.log('showMessage function not found, defining it');
                window.showMessage = function(message, type) {
                    console.log(`${type}: ${message}`);
                    alert(message);
                };
            }
            
            // Create a working payment plan modal using the same approach as test modal
            const modalDiv = document.createElement('div');
            modalDiv.id = 'paymentPlanModal';
            modalDiv.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:2147483647;';
            
            modalDiv.innerHTML = `
                <div style="background:#1a1a1a;border:2px solid #d4af37;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;color:#f5f5f5;">
                    <div style="background:linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);color:#1a1a1a;padding:20px;border-radius:14px 14px 0 0;display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:1.5rem;">üí≥ Payment Plan Setup</h3>
                        <button onclick="document.getElementById('paymentPlanModal').remove()" style="background:none;border:none;font-size:2rem;color:#1a1a1a;cursor:pointer;">&times;</button>
                    </div>
                    <div style="padding:30px;">
                        <div style="background:rgba(212,175,55,0.1);border:1px solid #d4af37;border-radius:12px;padding:20px;margin-bottom:25px;text-align:center;">
                            <h4 style="color:#d4af37;margin:0 0 10px 0;">${session.clientName}</h4>
                            <p style="margin:0;opacity:0.8;">${session.sessionType} - ${new Date(session.dateTime).toLocaleDateString()}</p>
                            <p style="margin:0;opacity:0.8;">üìß ${session.email} | üìû ${session.phoneNumber}</p>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Total Amount</label>
                            <input type="number" value="${session.price}" readonly style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Payment Frequency</label>
                            <select id="paymentFrequency" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">Start Date</label>
                            <input type="date" id="startDate" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;color:#d4af37;font-weight:600;margin-bottom:8px;">End Date</label>
                            <input type="date" id="endDate" style="width:100%;padding:12px;background:rgba(26,26,26,0.8);border:2px solid rgba(212,175,55,0.3);border-radius:8px;color:#f5f5f5;box-sizing:border-box;">
                        </div>
                        
                        <div style="text-align:center;margin:20px 0;">
                            <button onclick="calculatePayments()" style="background:#4CAF50;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;">üìä Calculate Payments</button>
                        </div>
                        
                        <div id="paymentCalculation" style="background:rgba(212,175,55,0.1);border:1px solid #d4af37;border-radius:12px;padding:20px;margin:20px 0;text-align:center;display:none;">
                            <h5 style="color:#d4af37;margin:0 0 15px 0;">üí∞ Payment Breakdown</h5>
                            <div id="calculationResults"></div>
                        </div>
                        
                        <div style="margin:20px 0;text-align:center;">
                            <button onclick="createPaymentPlan('${session.id}')" style="background:#d4af37;color:#1a1a1a;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;">üí≥ Create Payment Plan</button>
                            <button onclick="document.getElementById('paymentPlanModal').remove()" style="background:#666;color:white;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;">Cancel</button>
                        </div>
                        
                        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:30px;">
                            <button onclick="document.getElementById('paymentPlanModal').remove()" style="padding:12px 24px;background:rgba(102,126,234,0.8);color:white;border:2px solid #667eea;border-radius:8px;cursor:pointer;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Use direct DOM manipulation instead of insertAdjacentHTML
            
            // Remove existing modal if present
            const existingModal = document.getElementById('paymentPlanModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal directly to body
            document.body.appendChild(modalDiv);
            console.log('Payment plan modal added to document using DOM appendChild');
            
            // Modal should now be visible since we used the same approach as the working test modal
            console.log('Payment plan modal should now be visible');
            
            // Check if session already has payment plan and show appropriate modal
            if (session.hasPaymentPlan && session.paymentPlanId) {
                console.log('Session has existing payment plan, opening view modal');
                setTimeout(() => document.getElementById('paymentPlanModal').remove(), 100);
                viewPaymentPlan(session.id);
                return;
            }
            
            // Set default dates after modal is added
            setTimeout(() => {
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() + 7); // Default to next week
                const startDateInput = document.getElementById('startDate');
                if (startDateInput) {
                    startDateInput.value = startDate.toISOString().split('T')[0];
                }
                
                const endDate = new Date(today);
                endDate.setMonth(today.getMonth() + 6); // Default to 6 months
                const endDateInput = document.getElementById('endDate');
                if (endDateInput) {
                    endDateInput.value = endDate.toISOString().split('T')[0];
                }
                
                // Don't auto-calculate initially - let user click Calculate button
                
                console.log('Payment plan modal setup complete');
            }, 100);
        };

        // Payment calculation function
        window.calculatePayments = function() {
            // Get session price from the readonly input field
            const totalAmountInput = document.querySelector('#paymentPlanModal input[readonly]');
            const totalAmount = parseFloat(totalAmountInput ? totalAmountInput.value : 250);
            const depositAmount = 0; // No deposit handling for now
            const remainingAmount = totalAmount - depositAmount;
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const frequencySelect = document.getElementById('paymentFrequency');
            const calculationDiv = document.getElementById('paymentCalculation');
            const resultsDiv = document.getElementById('calculationResults');
            
            if (!startDateInput || !endDateInput || !frequencySelect || !calculationDiv || !resultsDiv) {
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const frequency = frequencySelect.value;
            
            if (!startDateInput.value || !endDateInput.value) {
                calculationDiv.style.display = 'none';
                return;
            }
            
            if (endDate <= startDate) {
                resultsDiv.innerHTML = '<p style="color:#ff4444;margin:0;">‚ö†Ô∏è End date must be after start date</p>';
                calculationDiv.style.display = 'block';
                return;
            }
            
            // Calculate number of payments based on frequency with proper date intervals
            let numberOfPayments = 0;
            let paymentDates = [];
            let currentDate = new Date(startDate);
            
            switch(frequency) {
                case 'weekly':
                    while (currentDate <= endDate) {
                        paymentDates.push(new Date(currentDate));
                        numberOfPayments++;
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                    break;
                case 'biweekly':
                    while (currentDate <= endDate) {
                        paymentDates.push(new Date(currentDate));
                        numberOfPayments++;
                        currentDate.setDate(currentDate.getDate() + 14);
                    }
                    break;
                case 'monthly':
                    while (currentDate <= endDate) {
                        paymentDates.push(new Date(currentDate));
                        numberOfPayments++;
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    break;
                default:
                    numberOfPayments = 1;
                    paymentDates = [new Date(startDate)];
            }
            
            // Ensure at least one payment
            if (numberOfPayments === 0) {
                numberOfPayments = 1;
                paymentDates = [new Date(startDate)];
            }
            
            const paymentAmount = (totalAmount / numberOfPayments).toFixed(2);
            
            // Create payment schedule preview
            let scheduleHTML = '';
            for (let i = 0; i < Math.min(numberOfPayments, 5); i++) {
                const paymentDate = paymentDates[i] || new Date(startDate);
                scheduleHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 10px; background: rgba(212,175,55,0.15); border-radius: 6px; border-left: 3px solid #d4af37;">
                        <span style="font-weight: 600;">Payment ${i + 1}</span>
                        <span style="color: #d4af37;">${paymentDate.toLocaleDateString()}</span>
                        <span style="font-weight: 600; color: #f5f5f5;">$${paymentAmount}</span>
                    </div>
                `;
            }
            
            if (numberOfPayments > 5) {
                scheduleHTML += `<div style="text-align: center; margin: 12px 0; opacity: 0.7; font-style: italic; color: #d4af37;">... and ${numberOfPayments - 5} more ${frequency} payments of $${paymentAmount} each</div>`;
            }
            
            resultsDiv.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;text-align:left;">
                    <div><strong>üí∞ Total Amount:</strong> $${totalAmount.toFixed(2)}</div>
                    <div><strong>üìÖ Payment Frequency:</strong> ${frequency.charAt(0).toUpperCase() + frequency.slice(1)}</div>
                    <div><strong>üî¢ Number of Payments:</strong> ${numberOfPayments}</div>
                    <div><strong>üí≥ Each Payment:</strong> $${paymentAmount}</div>
                </div>
                <div style="background:rgba(26,26,26,0.8);padding:20px;border-radius:12px;border:2px solid #d4af37;margin-top:20px;">
                    <h6 style="color:#d4af37;margin:0 0 15px 0;font-size:1.1rem;">üìã Payment Schedule:</h6>
                    ${scheduleHTML}
                    <div style="text-align:center;margin-top:15px;padding-top:15px;border-top:1px solid rgba(212,175,55,0.3);color:#d4af37;font-weight:600;">
                        Total: ${numberOfPayments} √ó $${paymentAmount} = $${totalAmount.toFixed(2)}
                    </div>
                </div>
            `;
            
            calculationDiv.style.display = 'block';
        };
        
        // Payment plan helper functions
        window.closePaymentPlanModal = function() {
            const modal = document.getElementById('paymentPlanModal');
            if (modal) {
                modal.remove();
            }
        };
        
        // Create payment plan function with Stripe integration
        window.createPaymentPlan = async function(sessionId) {
            try {
                const frequency = document.getElementById('paymentFrequency').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showMessage('Please select start and end dates', 'error');
                    return;
                }
                
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    throw new Error('Session not found');
                }
                
                showMessage('Creating payment plan...', 'info');
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/api/payment-plans', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        sessionId: sessionId,
                        totalAmount: parseFloat(session.price),
                        frequency: frequency,
                        startDate: startDate,
                        endDate: endDate,
                        reminderDays: 3
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`Payment plan created! ${result.plan.totalPayments} payments of $${parseFloat(result.plan.monthlyPayment).toFixed(2)} each.`, 'success');
                    
                    // Close modal and refresh sessions
                    document.getElementById('paymentPlanModal').remove();
                    loadSessions();
                } else {
                    throw new Error(result.error || 'Failed to create payment plan');
                }
                
            } catch (error) {
                console.error('Error creating payment plan:', error);
                showMessage('Error creating payment plan: ' + error.message, 'error');
            }
        };
        
        window.calculatePaymentPreview = function() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const frequency = document.getElementById('paymentFrequency').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (endDate <= startDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate payment schedule
            const paymentDates = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                paymentDates.push(new Date(currentDate));
                
                switch (frequency) {
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'bi-weekly':
                        currentDate.setDate(currentDate.getDate() + 14);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                }
            }
            
            const totalPayments = paymentDates.length;
            const paymentAmount = (totalAmount / totalPayments).toFixed(2);
            
            // Display preview
            let previewHtml = `
                <div class="payment-summary">
                    <strong>${totalPayments} payments of $${paymentAmount} each</strong>
                </div>
                <div class="payment-list">
            `;
            
            paymentDates.forEach((date, index) => {
                previewHtml += `
                    <div class="payment-item">
                        <span>Payment ${index + 1}</span>
                        <span>${date.toLocaleDateString()} - $${paymentAmount}</span>
                    </div>
                `;
            });
            
            previewHtml += `</div>`;
            
            document.getElementById('previewContent').innerHTML = previewHtml;
            document.getElementById('paymentPreview').style.display = 'block';
        };
        
        window.createPaymentPlan = async function() {
            const sessionId = document.getElementById('sessionId').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const frequency = document.getElementById('paymentFrequency').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reminderDays = parseInt(document.getElementById('reminderDays').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                showMessage('Creating payment plan...', 'info');
                
                const response = await fetch('/api/payment-plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId,
                        totalAmount,
                        frequency,
                        startDate,
                        endDate,
                        reminderDays
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage(`Payment plan created successfully! ${result.plan.totalPayments} ${frequency} payments of $${result.plan.monthlyPayment} each.`, 'success');
                    closePaymentPlanModal();
                    loadSessions(); // Refresh sessions
                } else {
                    throw new Error(result.error || 'Failed to create payment plan');
                }
                
            } catch (error) {
                console.error('Error creating payment plan:', error);
                showMessage('Error creating payment plan: ' + error.message, 'error');
            }
        };

        // Allow both past and future dates for historical session entries
        window.setMinDateTime = function() {
            // Remove any date restrictions to allow past dates for historical entries
            const dateTimeInput = document.getElementById('dateTime');
            if (dateTimeInput) {
                dateTimeInput.removeAttribute('min');
                dateTimeInput.removeAttribute('max');
                
                // Ensure the datetime picker is clickable and functional
                dateTimeInput.style.cursor = 'pointer';
                
                // Remove showPicker() calls due to cross-origin security restrictions
                // The native datetime-local input will show picker automatically when clicked
                dateTimeInput.addEventListener('click', function() {
                    this.focus();
                });
                
                // Add manual focus trigger for better compatibility
                dateTimeInput.addEventListener('focus', function() {
                    // Let the browser handle the native datetime picker
                });
            }
        }

        // UNIFIED APP INITIALIZATION - Only initialize UI, auth handled by script.js
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, preparing UI elements...');
            
            // Dev mode banner
            if (DEV_MODE) {
                const banner = document.createElement("div");
                banner.textContent = "Warning DEV MODE ENABLED - NO AUTH CHECK";
                banner.style = "position:fixed;top:0;width:100%;background:#ffc;padding:5px;text-align:center;z-index:10000;font-weight:bold;color:#333;";
                document.body.appendChild(banner);
                document.body.style.marginTop = "30px";
                
                // Only load app immediately in dev mode
                initializeAppContent();
            }
            
            // Initialize hamburger menu
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.remove('show');
            }
            
            // Hide contract modal
            const contractModal = document.getElementById('contractModal');
            if (contractModal) {
                contractModal.style.display = 'none';
            }
            
            // Set up event listeners immediately (doesn't require auth)
            setupEventListeners();
            setMinDateTime();
            
            console.log('üè† INDEX PAGE: UI elements prepared, waiting for authentication...');
            console.log('üè† INDEX PAGE: Document loaded successfully');
        });
        
        // Initialize app content after authentication
        window.initializeAppContent = function() {
            console.log('Loading authenticated app content...');
            
            // Main app initialization - loading sessions
            loadSessions();
            
            console.log('Photography management system loaded');
            showMessage('Welcome to your photography management platform!', 'success');
            
            // Initialize dashboard after brief delay to ensure sessions are loaded
            setTimeout(() => {
                if (typeof window.initializeDashboard === 'function') {
                    window.initializeDashboard();
                } else {
                    console.log('Dashboard initialization deferred - function not yet available');
                }
            }, 500);
        };

        window.setupEventListeners = function() {
            document.getElementById('sessionForm').addEventListener('submit', addSession);
            
            // Add form reset button functionality
            const resetBtn = document.querySelector('button[type="reset"]');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        setMinDateTime(); // Keep dates unrestricted for historical entries

                        const submitBtn = document.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Add Session';
                    }, 10);
                });
            }
        }

        window.addSession = async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on',
                sendReminder: formData.get('sendReminder') === 'on',

                photos: []
            };

            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    const newSession = await response.json();
                    sessions.unshift(newSession);
                    window.renderSessions();
                    resetForm(e.target);
                    showMessage('Session added successfully!', 'success');
                } else {
                    showMessage('Failed to add session', 'error');
                }
            } catch (error) {
                console.error('Error processing session:', error);
                showMessage('Error processing session', 'error');
            }
        }

        function resetForm(form) {
            form.reset();
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Session';
            
            // Keep date unrestricted to allow historical entries
            setMinDateTime();
        }

        window.loadSessions = async function() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const rawData = await response.json();
                    console.log('Data type:', typeof rawData, 'Array:', Array.isArray(rawData));
                    console.log('Raw API response:', rawData);
                    
                    // Debug deposit amount for Testing dammit session
                    const testingSession = rawData.find(s => s.clientName === 'Testing dammit');
                    console.log('Testing session deposit_amount from API:', testingSession?.depositAmount || 'NOT FOUND');
                    
                    // Transform and ensure deposit amounts are properly included
                    sessions = rawData.map(session => ({
                        ...session,
                        depositAmount: session.depositAmount || session.deposit_amount || 0,
                        reminderEnabled: session.sendReminder || false,
                        reminderSent: session.reminderSent || false
                    }));
                    
                    console.log('Transformed sessions:', sessions);
                    console.log(`Successfully loaded ${sessions.length} sessions`);
                    

                    

                    
                    // Store sessions globally and render
                    window.sessions = sessions;
                    console.log('About to render sorted sessions...');
                    if (typeof window.renderSessions === 'function') {
                        window.renderSessions();
                        console.log('‚úÖ Sorted sessions rendered successfully');
                    }
                    
                    // Remove any existing storage display elements from session cards
                    setTimeout(() => {
                        document.querySelectorAll('.session-total-storage').forEach(element => {
                            element.remove();
                        });
                    }, 150);
                    
                    // Load global storage statistics after sessions are loaded
                    console.log('Loading global storage statistics...');
                    setTimeout(() => {
                        loadGlobalStorageStats();
                    }, 200);
                } else if (response.status === 403) {
                    const data = await response.json();
                    if (data.requiresSubscription) {
                        showSubscriptionModal(data.message);
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        window.renderSessions = function renderSessions() {
            // SORT SESSIONS BY APPOINTMENT DATE BEFORE RENDERING
            if (window.sessions && Array.isArray(window.sessions) && window.sessions.length > 0) {
                console.log('üî• SORTING sessions by appointment date in renderSessions...');
                window.sessions.sort((a, b) => {
                    const dateA = new Date(a.dateTime);
                    const dateB = new Date(b.dateTime);
                    return dateA.getTime() - dateB.getTime(); // Oldest appointment first
                });
                console.log('‚úÖ Sessions sorted - Test Client should be first:', window.sessions[0]?.clientName, new Date(window.sessions[0]?.dateTime).toLocaleDateString());
                // Use sorted sessions for rendering
                sessions = window.sessions;
            }
            
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Add your first photography session above!</p>
                    </div>
                `;
                return;
            }

            // Filter visible sessions first, then render
            const visibleSessions = sessions.filter(session => isSessionVisible(session));
            
            const sessionElements = [];
            
            for (const session of visibleSessions) {
                const sessionId = session.id;
                const sessionHTML = `
                <div class="session-list-item" data-session-id="${sessionId}" onclick="toggleSessionDetails('${sessionId}')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">${session.clientName}</h3>
                            <div class="session-meta">
                                <span class="session-date">Calendar ${formatDateTime(session.dateTime)}</span>
                                <span class="session-location"> ${session.location}</span>
                                <span class="session-duration">‚è±Ô∏è ${formatDuration(session.duration)}</span>
                                <span class="session-price">Money $${session.price}</span>
                                ${(session.depositAmount && session.depositAmount > 0) ? 
                                    `<span class="session-deposit" style="color: #28a745; font-weight: 600;">Deposit: $${session.depositAmount.toFixed(2)}</span>` : 
                                    ''}
                                ${(session.depositAmount && session.depositAmount > 0) ? 
                                    `<span class="session-remaining" style="color: #d4af37; font-weight: 600;">Remaining: $${(session.price - session.depositAmount).toFixed(2)}</span>` : 
                                    ''
                                }
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-${sessionId}">‚ñº</div>
                    </div>
                    
                    <div class="session-details" id="details-${sessionId}" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>Phone Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:${session.email}" style="color: #d4af37;">${session.email}</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">${session.phoneNumber}</span>
                                    <button onclick="callClient('${session.phoneNumber}'); event.stopPropagation();" class="quick-action-btn call-btn">Phone</button>
                                    <button onclick="textClient('${session.phoneNumber}', '${session.clientName}', '${sessionId}'); event.stopPropagation();" class="quick-action-btn text-btn">Message</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>Calendar Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> ${session.sessionType}
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> ${formatDuration(session.duration)}
                                </div>
                                <div class="detail-item">

                                </div>
                                ${session.notes ? `
                                    <div class="detail-item">
                                        <strong>Notes:</strong> ${session.notes}
                                    </div>
                                ` : ''}
                                ${session.hasPaymentPlan ? `
                                    <div class="detail-item">
                                        <strong>Payment Plan:</strong> $${session.monthlyPayment}/month (${session.paymentsRemaining || 0} remaining)
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_${sessionId}" ${session.contractSigned ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_${sessionId}">Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_${sessionId}" ${session.paid ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_${sessionId}">Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_${sessionId}" ${session.edited ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_${sessionId}">Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_${sessionId}" ${session.delivered ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_${sessionId}">Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_${sessionId}" ${session.sendReminder ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${sessionId}', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_${sessionId}">Send Reminder</label>
                                </div>

                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="openUpdateSessionModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Update Session</button>
                                <button onclick="addToCalendar('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Calendar</button>
                                <button onclick="openEmailClient('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Email</button>
                                <button onclick="openBookingAgreementModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary" data-session-id="${sessionId}">
                                    üìÑ <span class="agreement-status">Booking Agreement</span>
                                </button>

                                ${session.hasPaymentPlan ? `
                                    <button onclick="viewPaymentPlan('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                ` : `
                                    <button onclick="createInvoiceWithTipping('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">üí∞ Send Invoice</button>
                                    <button onclick="sendDepositInvoice('${sessionId}'); event.stopPropagation();" class="btn btn-warning" style="background-color: #fd7e14; color: white;">üí≥ Send Deposit</button>
                                    <button onclick="openPaymentPlanModal('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Payment Plan</button>
                                `}
                                <button onclick="exportSessionPDF('${sessionId}'); event.stopPropagation();" class="btn btn-secondary">Export PDF</button>

                                <button onclick="deleteSession('${sessionId}'); event.stopPropagation();" class="btn btn-danger">Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>Session Notes & Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" ${session.printsOrdered ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" ${session.specialEdits ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" ${session.clientFeedback ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" ${session.socialMediaApproval ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" ${session.retouchingNeeded ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" ${session.backupCompleted ? 'checked' : ''} onchange="updateSessionNotes('${sessionId}', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." 
                                     onchange="updateSessionNotes('${sessionId}', 'sessionNotes', this.value); event.stopPropagation();"
                                     onclick="event.stopPropagation();">${session.sessionNotes || ''}</textarea>
                        </div>

                        <!-- Simplified Gallery and Storage Actions -->
                        <div class="session-file-actions">
                            <h4>Files & Storage</h4>
                            <div class="file-action-buttons">
                                <button onclick="openGalleryWindow('${sessionId}'); event.stopPropagation();" class="btn btn-primary">üì∏ Open Gallery</button>
                                <button onclick="openRawStorageWindow('${sessionId}'); event.stopPropagation();" class="btn btn-primary">üìÅ Open Raw Storage</button>
                                <button onclick="sendGalleryToClient('${sessionId}'); event.stopPropagation();" class="btn btn-success">‚úâÔ∏è Send to Client</button>
                            </div>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        ${session.delivered ? `
                            <div class="tip-panel" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h4 style="margin-top: 0; color: #28a745;">üí° Session Delivered</h4>
                                <p style="margin-bottom: 10px;">This session has been marked as delivered. Consider:</p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li>Following up for feedback</li>
                                    <li>Requesting testimonials or reviews</li>
                                    <li>Sharing social media posts (with permission)</li>
                                    <li>Scheduling future sessions</li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
                `;
                sessionElements.push(sessionHTML);
            }
            
            container.innerHTML = sessionElements.join('');
            
            // No longer loading files for all sessions - simplified interface

        }

        window.toggleSessionDetails = function(sessionId) {
            const details = document.getElementById(`details-${sessionId}`);
            const expandIcon = document.getElementById(`expand-${sessionId}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                expandIcon.textContent = '‚ñ≤';
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                expandIcon.textContent = '‚ñº';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // File Management Functions
        window.loadSessionFiles = async function(sessionId, folderType) {
            const container = document.getElementById(`${folderType}-files-${sessionId}`);
            const countElement = document.getElementById(`${folderType}-count-${sessionId}`);
            
            if (!container) return;

            try {
                const authToken = await getAuthToken();
                const response = await fetch(`/api/sessions/${sessionId}/files/${folderType}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                if (!response.ok) {
                    throw new Error('Failed to load files');
                }

                const data = await response.json();
                const files = data.files || [];

                // Update file count
                if (countElement) {
                    countElement.textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
                }

                // Render file list
                if (files.length === 0) {
                    container.innerHTML = '<div class="loading-files">No files uploaded yet</div>';
                } else {
                    // Clear container first
                    container.innerHTML = '';
                    
                    // Create file items using DOM methods to avoid template literal issues
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        
                        const isImage = file.contentType && file.contentType.startsWith('image/');
                        
                        if (isImage) {
                            const thumbnail = document.createElement('div');
                            thumbnail.className = 'file-thumbnail';
                            
                            const img = document.createElement('img');
                            img.src = `/api/r2/thumbnail/${sessionId}/${encodeURIComponent(file.name)}?size=medium&t=${Date.now()}`;
                            img.alt = file.name;
                            img.loading = 'lazy';
                            img.onclick = () => {
                                window.open(file.downloadUrl, '_blank');
                                event.stopPropagation();
                            };
                            img.onerror = () => {
                                img.style.display = 'none';
                                thumbnail.innerHTML = '<div class="file-icon">üñºÔ∏è</div>';
                            };
                            
                            thumbnail.appendChild(img);
                            fileItem.appendChild(thumbnail);
                        }
                        
                        const fileInfo = document.createElement('div');
                        fileInfo.className = 'file-info';
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'file-name';
                        fileName.textContent = file.name;
                        
                        const fileMeta = document.createElement('div');
                        fileMeta.className = 'file-meta';
                        fileMeta.textContent = `${formatFileSize(file.size)} ‚Ä¢ ${formatDate(file.timeCreated)}`;
                        
                        fileInfo.appendChild(fileName);
                        fileInfo.appendChild(fileMeta);
                        fileItem.appendChild(fileInfo);
                        
                        const fileActions = document.createElement('div');
                        fileActions.className = 'file-actions';
                        
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'btn btn-secondary';
                        downloadBtn.textContent = 'üì• Download';
                        downloadBtn.onclick = (e) => {
                            downloadFile(sessionId, folderType, file.name);
                            e.stopPropagation();
                        };
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-danger';
                        deleteBtn.textContent = 'üóëÔ∏è Delete';
                        deleteBtn.onclick = (e) => {
                            deleteFile(sessionId, folderType, file.name);
                            e.stopPropagation();
                        };
                        
                        fileActions.appendChild(downloadBtn);
                        fileActions.appendChild(deleteBtn);
                        fileItem.appendChild(fileActions);
                        
                        container.appendChild(fileItem);
                    });
                }
            } catch (error) {
                console.error('Error loading files:', error);
                container.innerHTML = '<div class="loading-files">Error loading files</div>';
                if (countElement) {
                    countElement.textContent = 'Error';
                }
            }
        }

        // Storage display functionality removed per user request

        window.openFileUploader = function(sessionId, folderType) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'fileUploadModal';
            modal.innerHTML = `
                <div class="payment-plan-modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Upload Files - ${folderType === 'gallery' ? 'üì∏ Gallery' : 'üìÅ Raw Storage'}</h3>
                        <button class="close-btn" onclick="closeFileUploadModal()">&times;</button>
                    </div>
                    <div style="padding: 20px; color: white;">
                        <div class="upload-area" style="border: 2px dashed #d4af37; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px; background: rgba(212, 175, 55, 0.1);">
                            <input type="file" id="fileInput" multiple style="display: none;" accept="*/*">
                            <div style="color: #d4af37; font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                            <p style="margin: 0 0 15px 0; color: #d4af37;">Drop files here or click to select</p>
                            <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">Choose Files</button>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div style="background: #333; border-radius: 8px; overflow: hidden; margin-bottom: 10px;">
                                <div id="progressBar" style="height: 20px; background: linear-gradient(45deg, #d4af37, #f4e4bc); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="uploadStatus" style="text-align: center; color: #d4af37;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="startUpload('${sessionId}', '${folderType}')" class="btn btn-success" style="margin-right: 10px;">Upload Files</button>
                            <button onclick="closeFileUploadModal()" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle drag and drop
            const uploadArea = modal.querySelector('.upload-area');
            const fileInput = modal.querySelector('#fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#f4e4bc';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.2)';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d4af37';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.1)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d4af37';
                uploadArea.style.background = 'rgba(212, 175, 55, 0.1)';
                fileInput.files = e.dataTransfer.files;
                updateFileDisplay();
            });
            
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', updateFileDisplay);
            
            function updateFileDisplay() {
                const files = Array.from(fileInput.files);
                if (files.length > 0) {
                    uploadArea.querySelector('p').textContent = `${files.length} file(s) selected`;
                }
            }
        }

        window.closeFileUploadModal = function() {
            const modal = document.getElementById('fileUploadModal');
            if (modal) {
                modal.remove();
            }
        }

        window.startUpload = async function(sessionId, folderType) {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                showMessage('Please select files to upload', 'error');
                return;
            }

            // QUOTA VALIDATION: Check if user can upload all selected files
            try {
                const quotaValidation = await window.storageQuotaChecker.validateUpload(files);
                
                if (!quotaValidation.canUpload) {
                    // Show quota exceeded modal
                    window.storageQuotaChecker.showQuotaExceededModal(quotaValidation);
                    return;
                }
                
                if (quotaValidation.warning) {
                    // Show storage warning
                    window.storageQuotaChecker.showStorageWarning(quotaValidation);
                    // Continue with upload after warning
                }
            } catch (quotaError) {
                console.error('Quota check failed, proceeding with upload:', quotaError);
                // Continue with upload (fail-safe)
            }
            
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            
            uploadProgress.style.display = 'block';
            
            try {
                let uploadedCount = 0;
                const totalFiles = files.length;
                
                // Process files in batches of 2
                for (let i = 0; i < files.length; i += 2) {
                    const batch = files.slice(i, i + 2);
                    
                    await Promise.all(batch.map(async (file) => {
                        try {
                            // Get upload URL with file size for quota enforcement
                            const authToken = await getAuthToken();
                            const uploadResponse = await fetch(`/api/sessions/${sessionId}/files/upload`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                                },
                                body: JSON.stringify({ 
                                    folderType, 
                                    fileName: file.name,
                                    fileSize: file.size 
                                })
                            });
                            
                            if (!uploadResponse.ok) {
                                if (uploadResponse.status === 413) {
                                    // Handle quota exceeded error
                                    const errorData = await uploadResponse.json();
                                    window.storageQuotaChecker.showQuotaExceededModal(errorData);
                                    throw new Error('Storage quota exceeded');
                                }
                                throw new Error('Failed to get upload URL');
                            }
                            
                            const { uploadURL } = await uploadResponse.json();
                            
                            // Upload file to signed URL
                            const putResponse = await fetch(uploadURL, {
                                method: 'PUT',
                                body: file,
                                headers: {
                                    'Content-Type': file.type || 'application/octet-stream'
                                }
                            });
                            
                            if (!putResponse.ok) {
                                throw new Error('Failed to upload file');
                            }
                            
                            uploadedCount++;
                            const progress = (uploadedCount / totalFiles) * 100;
                            progressBar.style.width = `${progress}%`;
                            uploadStatus.textContent = `Uploaded ${uploadedCount} of ${totalFiles} files`;
                            
                        } catch (error) {
                            console.error('Error uploading file:', file.name, error);
                            showMessage(`Failed to upload ${file.name}`, 'error');
                        }
                    }));
                }
                
                showMessage(`Successfully uploaded ${uploadedCount} files to ${folderType}!`, 'success');
                closeFileUploadModal();
                
                // Reload files for this session
                loadSessionFiles(sessionId, folderType);
                
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Upload failed: ' + error.message, 'error');
            }
        }

        window.downloadFile = function(sessionId, folderType, fileName) {
            const url = `/api/sessions/${sessionId}/files/${folderType}/download/${fileName}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
        }

        window.downloadAllFiles = function(sessionId, folderType) {
            const url = `/api/sessions/${sessionId}/files/${folderType}/download-zip`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sessionId}-${folderType}.zip`;
            a.click();
            showMessage(`Downloading all ${folderType} files...`, 'success');
        }

        window.deleteFile = async function(sessionId, folderType, fileName) {
            // UPDATED: Now uses unified deletion system for consistent storage tracking
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
                return;
            }
            
            try {
                // Import and use PhotoDeletion class if not already available
                if (typeof PhotoDeletion === 'undefined') {
                    console.log('Loading PhotoDeletion class...');
                    await import('/static/js/photo-deletion.js');
                }
                
                const photoDeletion = new PhotoDeletion();
                await photoDeletion.deletePhoto(sessionId, folderType, fileName);
                
                // Refresh the session files view
                loadSessionFiles(sessionId, folderType);
                
            } catch (error) {
                console.error('Error deleting file:', error);
                showMessage('Failed to delete file: ' + error.message, 'error');
            }
        }

        // Open Gallery folder in new window
        window.openGalleryWindow = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const url = `/gallery-manager.html?sessionId=${sessionId}&folderType=gallery&clientName=${encodeURIComponent(session.clientName)}`;
            const windowName = `gallery_${sessionId}`;
            const windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no';
            
            window.open(url, windowName, windowFeatures);
        };

        // Open Raw Storage folder in new window
        window.openRawStorageWindow = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const url = `/gallery-manager.html?sessionId=${sessionId}&folderType=raw&clientName=${encodeURIComponent(session.clientName)}`;
            const windowName = `raw_${sessionId}`;
            const windowFeatures = 'width=1200,height=800,scrollbars=yes,resizable=yes,location=no,menubar=no,toolbar=no';
            
            window.open(url, windowName, windowFeatures);
        };

        window.sendGalleryToClient = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const clientGalleryUrl = `${window.location.origin}/client-gallery.html?session=${sessionId}`;
            const subject = `Your Photography Gallery - ${session.sessionType} Session`;
            const body = `Hi ${session.clientName},

Your photography gallery is ready for viewing and download!

üì∏ View Your Gallery: ${clientGalleryUrl}

You can:
‚Ä¢ View all your photos in high resolution
‚Ä¢ Download individual photos
‚Ä¢ Download selected photos as a ZIP file
‚Ä¢ Download your entire gallery

The gallery will remain available for download. If you have any questions or need assistance, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
            
            showMessage('Email client opened with gallery link!', 'success');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }






















        // Search ENHANCED CLIENT MANAGEMENT FUNCTIONS

        // Filter and Search Functionality
        // Toggle filter section visibility
        function toggleFilterSection(section) {
            const dropdown = document.getElementById(section + '-filters');
            const indicator = document.getElementById(section + '-indicator');
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                indicator.textContent = '‚ñ≤';
            } else {
                dropdown.style.display = 'none';
                indicator.textContent = '‚ñº';
            }
        }

        // Toggle filter section visibility
        function toggleFilterSection(section) {
            const dropdown = document.getElementById(section + '-filters');
            const indicator = document.getElementById(section + '-indicator');
            
            if (dropdown && indicator) {
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                    indicator.textContent = '‚ñ≤';
                } else {
                    dropdown.style.display = 'none';
                    indicator.textContent = '‚ñº';
                }
            }
        }

        function filterSessions() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const contractFilter = document.getElementById('filterContractSigned').checked;
            const paidFilter = document.getElementById('filterPaid').checked;
            const deliveredFilter = document.getElementById('filterDelivered').checked;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            sessions.forEach(session => {
                const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
                if (!sessionCard) return;

                let isVisible = true;

                // Search filter
                if (searchTerm) {
                    const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        isVisible = false;
                    }
                }

                // Status filters
                if (contractFilter && !session.contractSigned) isVisible = false;
                if (paidFilter && !session.paid) isVisible = false;
                if (deliveredFilter && !session.delivered) isVisible = false;

                // Session type filter
                if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) isVisible = false;

                // Date range filter
                if (dateFromFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate < dateFromFilter) isVisible = false;
                }
                if (dateToFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate > dateToFilter) isVisible = false;
                }



                sessionCard.classList.toggle('hidden-by-filter', !isVisible);
            });
        }

        window.isSessionVisible = function(session) {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const contractFilter = document.getElementById('filterContractSigned')?.checked || false;
            const paidFilter = document.getElementById('filterPaid')?.checked || false;
            const deliveredFilter = document.getElementById('filterDelivered')?.checked || false;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter')?.value || '';
            const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
            const dateToFilter = document.getElementById('dateToFilter')?.value || '';


            // Search filter
            if (searchTerm) {
                const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }

            // Status filters
            if (contractFilter && !session.contractSigned) return false;
            if (paidFilter && !session.paid) return false;
            if (deliveredFilter && !session.delivered) return false;

            // Session type filter
            if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) return false;

            // Date range filter
            if (dateFromFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate < dateFromFilter) return false;
            }
            if (dateToFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate > dateToFilter) return false;
            }



            return true;
        }

        // Sort Functionality
        window.sortSessions = function sortSessions() {
            console.log('=== sortSessions FUNCTION CALLED ===');
            const sortElement = document.getElementById('sortOptions');
            const sortOption = sortElement?.value || 'date-asc';
            console.log('sortSessions called - Current sort option:', sortOption);
            console.log('Sort element found:', !!sortElement);
            console.log('Sessions array length:', sessions.length);
            console.log('Sessions global var exists:', typeof sessions, Array.isArray(sessions));
            
            sessions.sort((a, b) => {
                const now = new Date();
                
                // Enhanced date parsing with validation
                let dateA = new Date(a.dateTime);
                let dateB = new Date(b.dateTime);
                
                // Validate dates and provide fallback
                if (isNaN(dateA.getTime())) {
                    console.warn('Invalid date for session A:', a.clientName, a.dateTime);
                    dateA = new Date(0); // Use epoch as fallback
                }
                if (isNaN(dateB.getTime())) {
                    console.warn('Invalid date for session B:', b.clientName, b.dateTime);
                    dateB = new Date(0); // Use epoch as fallback
                }
                
                switch (sortOption) {
                    case 'date-desc':
                        // Parse dates properly to ensure accurate sorting
                        return dateB.getTime() - dateA.getTime(); // Newest first
                    case 'date-asc':
                        console.log('Sorting by date-asc (oldest first)');
                        return dateA.getTime() - dateB.getTime(); // Oldest first
                    case 'calendar-upcoming':
                        // Show upcoming sessions first (with same-day priority), then past sessions
                        const aIsFuture = dateA > now;
                        const bIsFuture = dateB > now;
                        
                        // Check if sessions are on the same day as today
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        const aIsToday = dateA >= today && dateA < tomorrow;
                        const bIsToday = dateB >= today && dateB < tomorrow;
                        
                        // Same-day sessions always come first
                        if (aIsToday && !bIsToday) return -1;
                        if (!aIsToday && bIsToday) return 1;
                        
                        // Both are today - sort by time
                        if (aIsToday && bIsToday) {
                            return dateA.getTime() - dateB.getTime();
                        }
                        
                        // Standard future/past logic for non-today sessions
                        if (aIsFuture && bIsFuture) {
                            return dateA.getTime() - dateB.getTime(); // Earliest upcoming first
                        } else if (aIsFuture && !bIsFuture) {
                            return -1; // Future before past
                        } else if (!aIsFuture && bIsFuture) {
                            return 1; // Past after future
                        } else {
                            return dateB.getTime() - dateA.getTime(); // Most recent past first
                        }
                    case 'calendar-past':
                        // Show most recent past sessions first, then upcoming
                        const aIsPast = dateA <= now;
                        const bIsPast = dateB <= now;
                        
                        if (aIsPast && bIsPast) {
                            return dateB.getTime() - dateA.getTime(); // Most recent past first
                        } else if (aIsPast && !bIsPast) {
                            return -1; // Past before future
                        } else if (!aIsPast && bIsPast) {
                            return 1; // Future after past
                        } else {
                            return dateA.getTime() - dateB.getTime(); // Earliest upcoming first
                        }
                    case 'name-asc':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'unpaid-first':
                        if (a.paid === b.paid) {
                            // If payment status is same, sort by date (newest first)
                            return dateB.getTime() - dateA.getTime();
                        }
                        return a.paid ? 1 : -1;
                    default:
                        return dateB.getTime() - dateA.getTime();
                }
            });
            
            // Enhanced logging with date validation
            const sessionDebug = sessions.map(s => ({
                name: s.clientName,
                date: s.dateTime,
                parsedDate: new Date(s.dateTime),
                isValidDate: !isNaN(new Date(s.dateTime).getTime()),
                isFuture: new Date(s.dateTime) > new Date()
            }));
            console.log(`Sessions sorted by ${sortOption}:`, sessionDebug);
            
            // Show clearer chronological order for calendar-upcoming
            if (sortOption === 'calendar-upcoming') {
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const todayList = sessions.filter(s => {
                    const sessionDate = new Date(s.dateTime);
                    return sessionDate >= today && sessionDate < tomorrow;
                });
                const futureList = sessions.filter(s => new Date(s.dateTime) >= tomorrow);
                const pastList = sessions.filter(s => new Date(s.dateTime) < today);
                
                console.log('=== CHRONOLOGICAL ORDER (calendar-upcoming) ===');
                
                if (todayList.length > 0) {
                    console.log('üéØ TODAY\'S SESSIONS (priority):');
                    todayList.forEach((s, i) => {
                        const sessionDate = new Date(s.dateTime);
                        console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleTimeString()} today`);
                    });
                }
                
                console.log('üìÖ UPCOMING SESSIONS (closest first):');
                futureList.forEach((s, i) => {
                    const sessionDate = new Date(s.dateTime);
                    const daysUntil = Math.ceil((sessionDate - now) / (1000 * 60 * 60 * 24));
                    console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleDateString()} (in ${daysUntil} days)`);
                });
                
                console.log('üìÖ PAST SESSIONS (most recent first):');
                pastList.forEach((s, i) => {
                    const sessionDate = new Date(s.dateTime);
                    const daysAgo = Math.ceil((now - sessionDate) / (1000 * 60 * 60 * 24));
                    console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleDateString()} (${daysAgo} days ago)`);
                });
            }
            
            // Show chronological order for date-asc
            if (sortOption === 'date-asc') {
                console.log('=== CHRONOLOGICAL ORDER (date-asc) ===');
                sessions.forEach((s, i) => {
                    const sessionDate = new Date(s.dateTime);
                    console.log(`${i+1}. ${s.clientName} - ${sessionDate.toLocaleDateString()}`);
                });
            }
            
            console.log('=== CALLING RENDER SESSIONS FROM SORT ===');
            window.renderSessions();
        }



        // Enhanced Notes Functionality
        window.updateSessionNotes = async function(sessionId, field, value) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session[field] = value;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (!response.ok) {
                    showMessage('Error saving notes', 'error');
                }
            } catch (error) {
                console.error('Error updating session notes:', error);
                showMessage('Error saving notes', 'error');
            }
        }

        // PDF Export Functionality
        window.exportSessionPDF = async function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            try {
                // Create PDF content
                const pdfContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px;">
                        <h1 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 10px;">
                            Photography Session Summary
                        </h1>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                            <div>
                                <h2 style="color: #333;">Client Information</h2>
                                <p><strong>Name:</strong> ${session.clientName}</p>
                                <p><strong>Email:</strong> ${session.email}</p>
                                <p><strong>Phone:</strong> ${session.phoneNumber}</p>
                                <p><strong>Location:</strong> ${session.location}</p>
                            </div>
                            <div>
                                <h2 style="color: #333;">Session Details</h2>
                                <p><strong>Type:</strong> ${session.sessionType}</p>
                                <p><strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}</p>
                                <p><strong>Duration:</strong> ${session.duration} hours</p>
                                <p><strong>Price:</strong> $${session.price}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Workflow Status</h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <p>Document Contract Signed: ${session.contractSigned ? 'Success Yes' : 'Error No'}</p>
                                <p>Money Paid: ${session.paid ? 'Success Yes' : 'Error No'}</p>
                                <p> Edited: ${session.edited ? 'Success Yes' : 'Error No'}</p>
                                <p>Package Delivered: ${session.delivered ? 'Success Yes' : 'Error No'}</p>
                                <p> Send Reminder: ${session.sendReminder ? 'Success Yes' : 'Error No'}</p>

                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Additional Checklist</h2>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <p>üñ®Ô∏è Prints Ordered: ${session.printsOrdered ? 'Success Yes' : 'Error No'}</p>
                                <p>Star Special Edits: ${session.specialEdits ? 'Success Yes' : 'Error No'}</p>
                                <p>Message Client Feedback: ${session.clientFeedback ? 'Success Yes' : 'Error No'}</p>
                                <p>Mobile Social Media OK: ${session.socialMediaApproval ? 'Success Yes' : 'Error No'}</p>
                                <p>üé® Retouching Needed: ${session.retouchingNeeded ? 'Success Yes' : 'Error No'}</p>
                                <p>üíæ Backup Completed: ${session.backupCompleted ? 'Success Yes' : 'Error No'}</p>
                            </div>
                        </div>
                        
                        ${session.sessionNotes ? `
                            <div style="margin: 30px 0;">
                                <h2 style="color: #333;">Session Notes</h2>
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #d4af37;">
                                    ${session.sessionNotes.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 50px; text-align: center; color: #666; font-size: 12px;">
                            <p>Generated on ${new Date().toLocaleDateString()} | Photography Management System</p>
                        </div>
                    </div>
                `;

                // Create new window for PDF generation
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Session Summary - ${session.clientName}</title>
                        <style>
                            body { margin: 0; font-family: Arial, sans-serif; }
                            @media print { 
                                body { margin: 1in; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="no-print" style="text-align: center; padding: 20px;">
                            <button onclick="window.print()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                 Print/Save as PDF
                            </button>
                        </div>
                        ${pdfContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                showMessage('PDF export opened in new window', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF export', 'error');
            }
        }

        // Export All Sessions
        function exportAllSessions() {
            const visibleSessions = sessions.filter(isSessionVisible);
            
            if (visibleSessions.length === 0) {
                showMessage('No sessions to export', 'error');
                return;
            }

            try {
                const csvContent = generateCSVExport(visibleSessions);
                downloadCSV(csvContent, `sessions-export-${new Date().toISOString().split('T')[0]}.csv`);
                showMessage(`Exported ${visibleSessions.length} sessions to CSV`, 'success');
            } catch (error) {
                console.error('Error exporting sessions:', error);
                showMessage('Error exporting sessions', 'error');
            }
        }

        function generateCSVExport(sessionsToExport) {
            const headers = [
                'Client Name', 'Email', 'Phone', 'Session Type', 'Date & Time', 'Location', 
                'Duration', 'Price', 'Contract Signed', 'Paid', 'Edited', 'Delivered',
                'Prints Ordered', 'Special Edits', 'Client Feedback', 'Social Media OK',
                'Retouching Needed', 'Backup Completed', 'Session Notes', 'Archived'
            ];

            const csvRows = [headers.join(',')];

            sessionsToExport.forEach(session => {
                const row = [
                    `"${session.clientName}"`,
                    `"${session.email}"`,
                    `"${session.phoneNumber}"`,
                    `"${session.sessionType}"`,
                    `"${formatDateTime(session.dateTime)}"`,
                    `"${session.location}"`,
                    session.duration,
                    session.price,
                    session.contractSigned ? 'Yes' : 'No',
                    session.paid ? 'Yes' : 'No',
                    session.edited ? 'Yes' : 'No',
                    session.delivered ? 'Yes' : 'No',
                    session.printsOrdered ? 'Yes' : 'No',
                    session.specialEdits ? 'Yes' : 'No',
                    session.clientFeedback ? 'Yes' : 'No',
                    session.socialMediaApproval ? 'Yes' : 'No',
                    session.retouchingNeeded ? 'Yes' : 'No',
                    session.backupCompleted ? 'Yes' : 'No',
                    `"${(session.sessionNotes || '').replace(/"/g, '""')}"`,
                    'No'
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('filterContractSigned').checked = false;
            document.getElementById('filterPaid').checked = false;
            document.getElementById('filterDelivered').checked = false;
            document.getElementById('sessionTypeFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('sortOptions').value = 'date-asc';
            
            filterSessions();
            sortSessions();
        }

        // üíõ TIP FUNCTIONALITY FOR DELIVERED SESSIONS
        window.generateTipPanel = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || !session.delivered) return '';

            return `
                <div class="tip-panel" style="background: linear-gradient(135deg, #fff9e6, #f4e4bc); padding: 20px; margin-top: 30px; border-radius: 12px; border: 2px solid #d4af37; text-align: center;">
                    <h3 style="color: #8b7355; margin-bottom: 15px; font-size: 1.2em;">üíõ Love your photos?</h3>
                    <p style="color: #8b7355; margin-bottom: 20px; font-size: 0.95em;">
                        If you're thrilled with your photos, you can leave a tip to show your appreciation<br>
                        <em>(totally optional and not expected!)</em>
                    </p>
                    <div class="tip-buttons" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="processTip('${sessionId}', 10)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$10</button>
                        <button onclick="processTip('${sessionId}', 25)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$25</button>
                        <button onclick="processTip('${sessionId}', 50)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$50</button>
                        <button onclick="customTipAmount('${sessionId}')" class="tip-btn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">Custom</button>
                    </div>
                    ${session.tipReceived ? `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; color: #28a745;">
                            <span style="font-size: 1.1em;">Celebration Thank you for your generous tip of $${session.tipAmount}!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function processTip(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                // For demo purposes, simulate Stripe checkout success
                // In production, this would integrate with actual Stripe checkout
                const confirmTip = confirm(`Process tip of $${amount}?\n\nThis will open Stripe checkout to process the payment.`);
                
                if (confirmTip) {
                    // Simulate successful tip processing
                    await updateTipStatus(sessionId, amount);
                    showMessage(`Thank you for your generous $${amount} tip! Celebration`, 'success');
                    // Tip received successfully
                    
                    // In production, this would be:
                    // window.location.href = await createStripeCheckoutSession(sessionId, amount);
                }
            } catch (error) {
                console.error('Error processing tip:', error);
                showMessage('Error processing tip', 'error');
            }
        }

        async function customTipAmount(sessionId) {
            const amount = prompt('Enter custom tip amount (numbers only):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                await processTip(sessionId, parseFloat(amount));
            } else if (amount !== null) {
                showMessage('Please enter a valid amount', 'error');
            }
        }

        async function updateTipStatus(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.tipReceived = true;
                session.tipAmount = amount;
                session.tipDate = new Date().toISOString();
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    window.renderSessions();
                } else {
                    showMessage('Error updating tip status', 'error');
                }
            } catch (error) {
                console.error('Error updating tip status:', error);
                showMessage('Error updating tip status', 'error');
            }
        }







        function viewPhoto(url) {
            window.open(url, '_blank');
        }
        window.formatDateTime = function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        window.formatDuration = function formatDuration(durationMinutes) {
            if (!durationMinutes || durationMinutes === 0) return 'Not specified';
            
            const minutes = parseInt(durationMinutes);
            
            if (minutes < 60) {
                return `${minutes} minutes`;
            } else if (minutes === 60) {
                return '1 hour';
            } else if (minutes % 60 === 0) {
                const hours = Math.floor(minutes / 60);
                return `${hours} hours`;
            } else {
                // Handle mixed hours and minutes (e.g., 90 minutes = 1h 30m)
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return `${hours}h ${remainingMinutes}m`;
            }
        }

        window.showMessage = function(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Admin-only button functions

        // Enhanced contract handling with error checking
        window.openContractModal = async function(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    showMessage('Session not found', 'error');
                    return;
                }
                
                showMessage('Loading contract templates...', 'info');
                
                // Check for contract templates - include auth token
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/api/contracts/templates', { headers });
                if (!response.ok) {
                    throw new Error('Contract templates not available');
                }
                
                const templates = await response.json();
                if (!templates || templates.length === 0) {
                    throw new Error('No contract templates found');
                }
                
                // Show contract modal with templates
                showMessage('Contract templates loaded', 'success');
                showContractSelectionModal(sessionId, session, templates);
                
            } catch (error) {
                console.error('Error loading contract:', error);
                showMessage('Contract templates not available: ' + error.message, 'error');
            }
        }

        // Contract Selection Modal
        function showContractSelectionModal(sessionId, session, templates) {
            const modalHTML = `
                <div id="contractSelectionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0; font-size: 24px;">üìÑ Select Contract Template</h2>
                            <button onclick="closeModal('contractSelectionModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #d4af37;">
                            <p style="margin: 0; color: #8b7355; font-weight: 600;">Session: ${session.clientName}</p>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${session.sessionType} ‚Ä¢ ${formatDateTime(session.dateTime)}</p>
                        </div>
                        
                        <div class="contract-templates">
                            ${templates.map(template => `
                                <div class="template-option" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease;" onclick="selectContractTemplate('${sessionId}', '${template.type}', '${template.title}')">
                                    <h3 style="margin: 0 0 8px 0; color: #8b7355; font-size: 18px;">${template.title}</h3>
                                    <p style="margin: 0; color: #666; font-size: 14px; line-height: 1.4;">${template.description}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center;">
                            <button onclick="closeModal('contractSelectionModal')" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <style>
                    .template-option:hover {
                        border-color: #d4af37 !important;
                        background: #fdfcf8 !important;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Select and create contract
        window.selectContractTemplate = async function(sessionId, contractType, contractTitle) {
            try {
                showMessage(`Creating ${contractTitle}...`, 'info');
                closeModal('contractSelectionModal');
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ contractType })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Contract creation failed:', response.status, errorData);
                    throw new Error(`Failed to create contract: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                showMessage(`${contractTitle} created successfully!`, 'success');
                
                // Optionally refresh session data or show contract management
                console.log('Contract created:', result);
                
            } catch (error) {
                console.error('Error creating contract:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    sessionId: sessionId,
                    contractType: contractType
                });
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        // Generic modal close function
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // View session contracts
        window.viewSessionContracts = async function(sessionId) {
            try {
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to fetch contracts: ${response.status} - ${errorData}`);
                }
                
                const contracts = await response.json();
                displayContractsModal(sessionId, contracts);
                
            } catch (error) {
                console.error('Error fetching contracts:', error);
                showMessage('Failed to fetch contracts: ' + error.message, 'error');
            }
        }

        // Display contracts modal
        function displayContractsModal(sessionId, contracts) {
            const session = sessions.find(s => s.id === sessionId);
            const clientName = session ? session.clientName : 'Unknown Client';
            
            let contractsHTML = '';
            if (contracts.length === 0) {
                contractsHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No contracts found</h3>
                        <p>Create a new contract to get started.</p>
                    </div>
                `;
            } else {
                contractsHTML = contracts.map((contract, index) => `
                    <div class="contract-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #8b7355;">${contract.contract_title}</h4>
                            <span class="status-badge status-${contract.status}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase;">
                                ${contract.status}
                            </span>
                        </div>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">
                            Created: ${new Date(contract.created_at).toLocaleDateString()}
                        </p>
                        ${contract.signed_date ? `
                            <p style="margin: 5px 0; color: #28a745; font-size: 14px;">
                                <strong>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</strong>
                            </p>
                        ` : ''}
                        <div style="margin-top: 15px;">
                            <button onclick="viewContractDetails('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                View Details
                            </button>
                            <button onclick="editContract('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                Edit
                            </button>
                            ${contract.status === 'pending' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-secondary">
                                    Send to Client
                                </button>
                            ` : ''}
                            ${contract.status === 'sent' || contract.status === 'signed' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-success" style="margin-left: 10px;">
                                    üìß Resend Contract
                                </button>
                            ` : ''}
                            ${contract.status === 'signed' ? `
                                <button onclick="viewSignedCopy('${contract.id}')" class="btn btn-info" style="margin-left: 10px;">
                                    üìÑ View Signed Copy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const modalHTML = `
                <div id="contractsViewModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Contracts for ${clientName}</h2>
                            <button onclick="closeModal('contractsViewModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="contracts-list">
                            ${contractsHTML}
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
                            <button onclick="openContractModal('${sessionId}'); closeModal('contractsViewModal');" class="btn btn-primary">
                                Create New Contract
                            </button>
                            <button onclick="openCustomContractModal('${sessionId}'); closeModal('contractsViewModal');" class="btn btn-secondary" style="margin-left: 10px;">
                                Create Custom Contract
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    .status-pending { background: #ffc107; color: #000; }
                    .status-signed { background: #28a745; color: white; }
                    .status-sent { background: #17a2b8; color: white; }
                    .status-expired { background: #dc3545; color: white; }
                    
                    /* Home Base Setup Styles */
                    .mileage-header-actions {
                        display: flex;
                        gap: 10px;
                        align-items: center;
                    }

                    .setup-btn {
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }

                    .setup-btn:hover {
                        background: #5a6268;
                        transform: translateY(-1px);
                    }

                    .home-base-setup {
                        margin: 20px 0;
                        padding: 0;
                    }

                    .setup-card {
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 20px;
                    }

                    .setup-card h3 {
                        color: #495057;
                        margin-bottom: 10px;
                        font-size: 18px;
                    }

                    .setup-card p {
                        color: #6c757d;
                        margin-bottom: 20px;
                    }

                    /* Round Trip Toggle Styles */
                    .form-group label {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-weight: 500;
                        color: #495057;
                        margin-bottom: 10px;
                    }
                    
                    .form-group input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        accent-color: #d4af37;
                        cursor: pointer;
                    }
                    
                    .calculate-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.2s;
                        margin-left: 10px;
                    }
                    
                    .calculate-btn:hover {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    /* Report Breakdown Styles */
                    .report-breakdown {
                        margin-top: 30px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 20px;
                    }

                    .report-breakdown h4 {
                        color: #495057;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #d4af37;
                        padding-bottom: 10px;
                    }

                    .breakdown-section {
                        margin-bottom: 25px;
                    }

                    .breakdown-section h5 {
                        color: #6c757d;
                        margin-bottom: 15px;
                        font-size: 16px;
                    }

                    .breakdown-item {
                        display: grid;
                        grid-template-columns: 1fr 2fr 1fr;
                        gap: 15px;
                        padding: 10px;
                        background: white;
                        border-radius: 5px;
                        margin-bottom: 8px;
                        border-left: 3px solid #d4af37;
                    }

                    .breakdown-item .amount {
                        text-align: right;
                        font-weight: 600;
                        color: #28a745;
                    }

                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin-bottom: 20px;
                    }

                    .summary-item {
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        border-left: 4px solid #d4af37;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .summary-item label {
                        font-weight: 600;
                        color: #495057;
                        display: block;
                        margin-bottom: 5px;
                    }

                    .summary-item span {
                        font-size: 18px;
                        font-weight: 700;
                        color: #28a745;
                    }

                    /* Dashboard Export Controls */
                    .dashboard-controls {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 15px;
                    }

                    .dashboard-export-buttons {
                        display: flex;
                        gap: 10px;
                    }

                    .export-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.2s;
                    }

                    .export-btn:hover {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    @media (max-width: 768px) {
                        .dashboard-controls {
                            flex-direction: column;
                            align-items: stretch;
                        }
                        
                        .dashboard-export-buttons {
                            justify-content: center;
                        }
                    }

                    .location-setup {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }

                    .location-actions {
                        display: flex;
                        gap: 10px;
                        flex-wrap: wrap;
                    }

                    .location-btn {
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                    }

                    .location-btn:hover {
                        background: #138496;
                        transform: translateY(-1px);
                    }

                    .status-card {
                        background: #d4edda;
                        border: 1px solid #c3e6cb;
                        border-radius: 5px;
                        padding: 15px;
                        margin-top: 15px;
                    }

                    .status-card h4 {
                        color: #155724;
                        margin-bottom: 8px;
                        font-size: 16px;
                    }

                    .status-card p {
                        color: #155724;
                        margin-bottom: 10px;
                        font-weight: 500;
                    }

                    .edit-btn {
                        background: #ffc107;
                        color: #212529;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 500;
                    }

                    .edit-btn:hover {
                        background: #e0a800;
                    }

                    .location-input-group {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    }

                    .location-input-group input {
                        flex: 1;
                    }

                    .home-base-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        white-space: nowrap;
                        transition: all 0.2s;
                    }

                    .home-base-btn:hover:not(:disabled) {
                        background: #218838;
                        transform: translateY(-1px);
                    }

                    .home-base-btn:disabled {
                        background: #6c757d;
                        cursor: not-allowed;
                        opacity: 0.6;
                    }

                    /* Address Autocomplete Styles */
                    .autocomplete-container {
                        position: relative;
                        flex: 1;
                    }

                    .address-suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        border: 1px solid #ddd;
                        border-top: none;
                        border-radius: 0 0 5px 5px;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    }

                    .address-suggestion {
                        padding: 10px 15px;
                        cursor: pointer;
                        border-bottom: 1px solid #eee;
                        transition: background-color 0.2s;
                    }

                    .address-suggestion:hover {
                        background-color: #f8f9fa;
                    }

                    .address-suggestion:last-child {
                        border-bottom: none;
                    }

                    .address-suggestion.selected {
                        background-color: #e3f2fd;
                    }

                    .suggestion-main {
                        font-weight: 500;
                        color: #333;
                    }

                    .suggestion-detail {
                        font-size: 12px;
                        color: #666;
                        margin-top: 2px;
                    }

                    @media (max-width: 768px) {
                        .mileage-header-actions {
                            flex-direction: column;
                            gap: 8px;
                        }

                        .location-actions {
                            flex-direction: column;
                        }

                        .location-input-group {
                            flex-direction: column;
                            align-items: stretch;
                        }

                        .location-input-group input {
                            margin-bottom: 8px;
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // View contract details
        window.viewContractDetails = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch contract details');
                }
                
                const contract = await response.json();
                showContractDetailsModal(contract);
                
            } catch (error) {
                console.error('Error fetching contract details:', error);
                showMessage('Failed to fetch contract details: ' + error.message, 'error');
            }
        }

        // Show contract details modal
        function showContractDetailsModal(contract) {
            const modalHTML = `
                <div id="contractDetailsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 900px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">${contract.contract_title}</h2>
                            <button onclick="closeModal('contractDetailsModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div class="contract-info" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div><strong>Status:</strong> <span class="status-badge status-${contract.status}">${contract.status.toUpperCase()}</span></div>
                                <div><strong>Created:</strong> ${new Date(contract.created_at).toLocaleDateString()}</div>
                                <div><strong>Client:</strong> ${contract.client_name}</div>
                                <div><strong>Email:</strong> ${contract.client_email}</div>
                                ${contract.signed_date ? `<div><strong>Signed:</strong> ${new Date(contract.signed_date).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="contract-content" style="background: white; border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin-bottom: 20px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${contract.contract_content}
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="editContract('${contract.id}'); closeModal('contractDetailsModal');" class="btn btn-primary" style="margin-right: 10px;">
                                Edit Contract
                            </button>
                            <button onclick="downloadContractPDF('${contract.id}')" class="btn btn-secondary" style="margin-right: 10px;">
                                Download PDF
                            </button>
                            ${contract.status === 'pending' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-secondary">
                                    Send to Client
                                </button>
                            ` : ''}
                            ${contract.status === 'sent' || contract.status === 'signed' ? `
                                <button onclick="sendContractToClient('${contract.id}')" class="btn btn-success">
                                    üìß Resend Contract
                                </button>
                            ` : ''}
                            ${contract.status === 'signed' ? `
                                <button onclick="viewSignedCopy('${contract.id}')" class="btn btn-info" style="margin-left: 10px;">
                                    üìÑ View Signed Copy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Edit contract
        window.editContract = async function(contractId) {
            try {
                const authToken = await getAuthToken();
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'GET',
                    headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch contract for editing');
                }
                
                const contract = await response.json();
                showContractEditModal(contract);
                
            } catch (error) {
                console.error('Error fetching contract for editing:', error);
                showMessage('Failed to load contract for editing: ' + error.message, 'error');
            }
        }

        // Show contract edit modal
        function showContractEditModal(contract) {
            const modalHTML = `
                <div id="contractEditModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 1000px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Edit Contract: ${contract.contract_title}</h2>
                            <button onclick="closeModal('contractEditModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="contractEditForm">
                            <div style="margin-bottom: 20px;">
                                <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Title:</label>
                                <input type="text" id="contractTitle" name="title" value="${contract.contract_title}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Content:</label>
                                <textarea id="contractContent" name="content" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace;">${contract.contract_content}</textarea>
                            </div>
                            
                            <div style="text-align: center;">
                                <button type="button" onclick="saveContractChanges('${contract.id}')" class="btn btn-primary" style="margin-right: 10px;">
                                    Save Changes
                                </button>
                                <button type="button" onclick="closeModal('contractEditModal')" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Save contract changes
        window.saveContractChanges = async function(contractId) {
            try {
                const title = document.getElementById('contractTitle').value;
                const content = document.getElementById('contractContent').value;
                
                if (!title.trim() || !content.trim()) {
                    showMessage('Please fill in both title and content', 'error');
                    return;
                }
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to save contract: ${response.status} - ${errorData}`);
                }
                
                showMessage('Contract updated successfully!', 'success');
                closeModal('contractEditModal');
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save contract: ' + error.message, 'error');
            }
        }

        // Open custom contract modal
        window.openCustomContractModal = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showMessage('Session not found', 'error');
                return;
            }
            
            const modalHTML = `
                <div id="customContractModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div class="modal-content" style="background: white; margin: 20px auto; padding: 30px; width: 95%; max-width: 1000px; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Create Custom Contract for ${session.clientName}</h2>
                            <button onclick="closeModal('customContractModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="customContractForm">
                            <div style="margin-bottom: 20px;">
                                <label for="customContractTitle" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Title:</label>
                                <input type="text" id="customContractTitle" name="title" placeholder="e.g., Custom Photography Agreement" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="customContractContent" style="display: block; margin-bottom: 5px; font-weight: bold;">Contract Content:</label>
                                <div style="margin-bottom: 10px; color: #666; font-size: 14px;">
                                    <strong>Available variables:</strong> {{client_name}}, {{client_email}}, {{photographer_name}}, {{photographer_email}}, {{session_type}}, {{session_date}}, {{location}}, {{price}}, {{duration}}
                                </div>
                                <textarea id="customContractContent" name="content" rows="20" placeholder="Enter your custom contract content here..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace;"></textarea>
                            </div>
                            
                            <div style="text-align: center;">
                                <button type="button" onclick="createCustomContract('${sessionId}')" class="btn btn-primary" style="margin-right: 10px;">
                                    Create Contract
                                </button>
                                <button type="button" onclick="closeModal('customContractModal')" class="btn btn-secondary">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Create custom contract
        window.createCustomContract = async function(sessionId) {
            try {
                const title = document.getElementById('customContractTitle').value;
                const content = document.getElementById('customContractContent').value;
                
                if (!title.trim() || !content.trim()) {
                    showMessage('Please fill in both title and content', 'error');
                    return;
                }
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts/custom`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to create custom contract: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                showMessage('Custom contract created successfully!', 'success');
                closeModal('customContractModal');
                
            } catch (error) {
                console.error('Error creating custom contract:', error);
                showMessage('Failed to create custom contract: ' + error.message, 'error');
            }
        }

        // Clean new update session functionality
        window.openUpdateSessionModal = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                showMessage('Session not found', 'error');
                return;
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="updateSessionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div class="modal-content" style="background: white; margin: 50px auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #d4af37; padding-bottom: 15px;">
                            <h2 style="color: #8b7355; margin: 0;">Update Session</h2>
                            <button onclick="closeUpdateSessionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="updateSessionForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label for="updateClientName">Client Name</label>
                                    <input type="text" id="updateClientName" name="clientName" value="${session.clientName || ''}" required>
                                </div>
                                <div>
                                    <label for="updateSessionType">Session Type</label>
                                    <input type="text" id="updateSessionType" name="sessionType" value="${session.sessionType || ''}" required>
                                </div>
                                <div>
                                    <label for="updateDateTime">Date & Time</label>
                                    <input type="datetime-local" id="updateDateTime" name="dateTime" value="${session.dateTime ? new Date(session.dateTime).toISOString().slice(0, 16) : ''}" required>
                                </div>
                                <div>
                                    <label for="updateLocation">Location</label>
                                    <input type="text" id="updateLocation" name="location" value="${session.location || ''}" required>
                                </div>
                                <div>
                                    <label for="updatePhoneNumber">Phone</label>
                                    <input type="tel" id="updatePhoneNumber" name="phoneNumber" value="${session.phoneNumber || ''}" required>
                                </div>
                                <div>
                                    <label for="updateEmail">Email</label>
                                    <input type="email" id="updateEmail" name="email" value="${session.email || ''}" required>
                                </div>
                                <div>
                                    <label for="updatePrice">Price</label>
                                    <input type="number" id="updatePrice" name="price" step="0.01" value="${session.price || ''}" required>
                                </div>
                                <div>
                                    <label for="updateDuration">Duration (minutes)</label>
                                    <input type="number" id="updateDuration" name="duration" value="${session.duration || ''}" required>
                                </div>
                            </div>
                            
                            <div>
                                <label for="updateNotes">Notes</label>
                                <textarea id="updateNotes" name="notes" style="width: 100%; height: 80px; margin-bottom: 15px;">${session.notes || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <label><input type="checkbox" name="contractSigned" ${session.contractSigned ? 'checked' : ''}> Contract Signed</label>
                                <label><input type="checkbox" name="paid" ${session.paid ? 'checked' : ''}> Paid</label>
                                <label><input type="checkbox" name="edited" ${session.edited ? 'checked' : ''}> Edited</label>
                                <label><input type="checkbox" name="delivered" ${session.delivered ? 'checked' : ''}> Delivered</label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeUpdateSessionModal()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Update Session</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add form submit handler
            document.getElementById('updateSessionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateSession(sessionId, this);
            });
        }
        
        window.closeUpdateSessionModal = function() {
            const modal = document.getElementById('updateSessionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        window.updateSession = async function(sessionId, form) {
            const formData = new FormData(form);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                notes: formData.get('notes'),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on'
            };
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    const updatedSession = await response.json();
                    const sessionIndex = sessions.findIndex(s => s.id === sessionId);
                    if (sessionIndex !== -1) {
                        sessions[sessionIndex] = updatedSession;
                    }
                    window.renderSessions();
                    closeUpdateSessionModal();
                    showMessage('Session updated successfully!', 'success');
                } else {
                    showMessage('Failed to update session', 'error');
                }
            } catch (error) {
                console.error('Error updating session:', error);
                showMessage('Error updating session', 'error');
            }
        }





        // Open email client with session details  
        window.openEmailClient = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const subject = `Photography Session - ${session.sessionType} with ${session.clientName}`;
            const body = `Hi ${session.clientName},

I hope this email finds you well! I'm writing regarding your upcoming ${session.sessionType} photography session.

Session Details:
Date: ${new Date(session.dateTime).toLocaleDateString()}
Time: ${new Date(session.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
Location: ${session.location}
Investment: $${session.price}
Contact: ${session.phoneNumber}

I'm excited to capture these special moments for you! If you have any questions or need to make any changes, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }

        window.addToCalendar = function(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // For iPhone, use the server endpoint
            if (/iPhone|iPad/.test(navigator.userAgent)) {
                window.location.href = `/api/sessions/${sessionId}/calendar.ics`;
                showMessage('Opening iPhone Calendar...', 'success');
                return;
            }
            
            const startDate = new Date(session.dateTime);
            const endDate = new Date(startDate.getTime() + (session.duration * 60000));
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Photography Scheduler//EN
BEGIN:VEVENT
UID:${session.id}@photographyschedule.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Photography Session - ${session.clientName}
DESCRIPTION:Session Type: ${session.sessionType}\\nLocation: ${session.location}\\nClient: ${session.clientName}\\nPhone: ${session.phoneNumber}\\nEmail: ${session.email}\\nPrice: $${session.price}
LOCATION:${session.location}
END:VEVENT
END:VCALENDAR`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${session.clientName.replace(/\s+/g, '_')}_photography_session.ics`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Calendar event downloaded!', 'success');
        }

        // Old invoice modal system removed - now using tipping system via createInvoiceWithTipping()

        // Old confirmSendInvoice function removed - using new tipping system via createInvoiceWithTipping()

        function callClient(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function textClient(phoneNumber, clientName, sessionId) {
            const message = `Hi ${clientName}, thanks for booking your photography session! We'll be in touch soon with details.`;
            window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
        }


    </script>

    <!-- Confetti Container for Milestone Celebrations -->
    <div id="confettiContainer" class="confetti-container"></div>

    <script>
        // Confetti Animation System for Milestone Celebrations
        function createConfetti(x, y, count = 50) {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                
                // Random positioning and styling
                const startX = x || Math.random() * window.innerWidth;
                const startY = y || -20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 8 + 6;
                const duration = Math.random() * 2 + 2;
                
                confetti.style.left = startX + 'px';
                confetti.style.top = startY + 'px';
                confetti.style.backgroundColor = color;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                confetti.style.animationDuration = duration + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                
                container.appendChild(confetti);
                
                // Clean up after animation
                setTimeout(() => {
                    if (confetti && confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, (duration + 0.5) * 1000);
            }
        }
        
        function showMilestoneToast(message, emoji = 'Celebration') {
            const toast = document.createElement('div');
            toast.className = 'milestone-toast';
            toast.innerHTML = `${emoji} ${message}`;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }
        
        // Milestone celebration system removed per user request














        
















        window.openPhotoLightbox = function(filename, sessionId = null) {
            // Create lightbox overlay
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                backdrop-filter: blur(15px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                text-align: center;
            `;
            content.onclick = (e) => e.stopPropagation();
            
            const img = document.createElement('img');
            // Use R2 preview if sessionId provided, otherwise legacy uploads
            img.src = sessionId ? `/api/r2/preview/${sessionId}/${filename}` : `/uploads/${filename}`;
            img.style.cssText = `
                max-width: 100%;
                max-height: 85vh;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            `;
            
            const filenameDiv = document.createElement('div');
            filenameDiv.textContent = filename;
            filenameDiv.style.cssText = `
                color: white;
                margin-top: 20px;
                font-size: 16px;
                opacity: 0.9;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 15px;
                background: #d4af37;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            `;
            closeBtn.onclick = () => document.body.removeChild(lightbox);
            
            content.appendChild(img);
            content.appendChild(filenameDiv);
            content.appendChild(closeBtn);
            lightbox.appendChild(content);
            document.body.appendChild(lightbox);
            
            // Close on click outside
            lightbox.addEventListener('click', () => {
                document.body.removeChild(lightbox);
            });
            
            // Close on escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(lightbox);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Payment Plan Functions - Updated to work with session object
        
        function closePaymentPlanModal() {
            const modal = document.getElementById('paymentPlanModal');
            if (modal) {
                modal.remove();
            }
            currentPaymentPlanSessionId = null;
        }
        
        function calculatePaymentPreview() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = new Date(document.getElementById('planEndDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate months between dates
            const monthsDiff = Math.max(1, (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()));
            const monthlyPayment = (totalAmount / monthsDiff).toFixed(2);
            
            // Show summary
            const summaryElement = document.getElementById('paymentPlanSummary');
            const detailsElement = document.getElementById('paymentSummaryDetails');
            const scheduleElement = document.getElementById('paymentSchedulePreview');
            
            detailsElement.innerHTML = `
                <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                <p><strong>Number of Payments:</strong> ${monthsDiff}</p>
                <p><strong>Monthly Payment:</strong> $${monthlyPayment}</p>
                <p><strong>Period:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
            `;
            
            // Generate payment schedule preview
            let scheduleHTML = '<h5>Payment Schedule:</h5>';
            for (let i = 0; i < Math.min(monthsDiff, 6); i++) { // Show first 6 payments
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);
                
                scheduleHTML += `
                    <div class="payment-item">
                        <div>
                            <strong>Payment ${i + 1}</strong><br>
                            <small>${paymentDate.toLocaleDateString()}</small>
                        </div>
                        <div>$${monthlyPayment}</div>
                        <div class="payment-status pending">Pending</div>
                    </div>
                `;
            }
            
            if (monthsDiff > 6) {
                scheduleHTML += `<p><small>... and ${monthsDiff - 6} more payments</small></p>`;
            }
            
            scheduleElement.innerHTML = scheduleHTML;
            summaryElement.style.display = 'block';
        }
        
        // Duplicate function removed - using window.createPaymentPlan definition above
        
        window.viewPaymentPlan = async function(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/payment-plan`);
                
                if (!response.ok) {
                    throw new Error('Payment plan not found');
                }
                
                const paymentPlan = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                // Update modal title
                document.getElementById('paymentPlanViewTitle').textContent = `Payment Plan - ${session?.clientName || 'Client'}`;
                
                // Generate payment plan view
                let contentHTML = `
                    <div class="payment-plan-summary">
                        <h4>üìã Plan Overview</h4>
                        <p><strong>Total Amount:</strong> $${parseFloat(paymentPlan.totalAmount).toFixed(2)}</p>
                        <p><strong>Monthly Payment:</strong> $${parseFloat(paymentPlan.monthlyPayment).toFixed(2)}</p>
                        <p><strong>Payments Completed:</strong> ${paymentPlan.paymentsCompleted} of ${paymentPlan.totalPayments}</p>
                        <p><strong>Amount Paid:</strong> $${parseFloat(paymentPlan.amountPaid).toFixed(2)}</p>
                        <p><strong>Remaining Balance:</strong> $${parseFloat(paymentPlan.remainingBalance).toFixed(2)}</p>
                        <p><strong>Status:</strong> <span class="payment-status ${paymentPlan.status}">${paymentPlan.status.toUpperCase()}</span></p>
                    </div>
                    
                    <div class="payment-schedule">
                        <h4>Payment Schedule</h4>
                `;
                
                for (const payment of paymentPlan.payments) {
                    const dueDate = new Date(payment.dueDate);
                    const isOverdue = dueDate < new Date() && payment.status === 'pending';
                    const statusClass = isOverdue ? 'overdue' : payment.status;
                    
                    contentHTML += `
                        <div class="payment-item">
                            <div>
                                <strong>Payment ${payment.paymentNumber}</strong><br>
                                <small>Due: ${dueDate.toLocaleDateString()}</small>
                                ${payment.paidDate ? `<br><small>Paid: ${new Date(payment.paidDate).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div>$${parseFloat(payment.amount).toFixed(2)}</div>
                            <div>
                                <div class="payment-status ${statusClass}">${payment.status.toUpperCase()}</div>
                                ${payment.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markPaymentPaid('${payment.id}')" style="margin-top: 5px;">Mark Paid</button>
                                    <button class="btn btn-sm" onclick="sendPaymentInvoice('${payment.id}')" style="margin-top: 5px;">Send Invoice</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += '</div>';
                
                document.getElementById('paymentPlanViewContent').innerHTML = contentHTML;
                document.getElementById('paymentPlanViewModal').classList.add('active');
                
            } catch (error) {
                console.error('Error viewing payment plan:', error);
                showMessage('Failed to load payment plan: ' + error.message, 'error');
            }
        }
        
        function closePaymentPlanViewModal() {
            document.getElementById('paymentPlanViewModal').classList.remove('active');
        }
        
        async function markPaymentPaid(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentMethod: 'manual',
                        notes: 'Marked as paid by admin'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to mark payment as paid');
                }
                
                showMessage('Payment marked as paid!', 'success');
                loadSessions(); // Refresh session data
                // Re-open the payment plan view to show updated status
                setTimeout(() => {
                    if (currentPaymentPlanSessionId) {
                        viewPaymentPlan(currentPaymentPlanSessionId);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error marking payment paid:', error);
                showMessage('Failed to mark payment as paid: ' + error.message, 'error');
            }
        }
        
        async function sendPaymentInvoice(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send invoice');
                }
                
                showMessage('Payment invoice sent successfully!', 'success');
                // Invoice sent successfully
                
            } catch (error) {
                console.error('Error sending payment invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }
        
        async function processAutomatedPayments() {
            try {
                const response = await fetch('/api/payments/process-automated', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process payments');
                }
                
                const result = await response.json();
                
                showMessage(`Processing complete! ${result.results.invoicesSent} invoices sent, ${result.results.remindersSent} reminders sent`, 'success');
                
                // Refresh data
                loadSessions();
                
            } catch (error) {
                console.error('Error processing automated payments:', error);
                showMessage('Failed to process payments: ' + error.message, 'error');
            }
        }

        // Contract functions moved to top of script to prevent reference errors

        // Show modal with email/messaging options
        function showContractSendOptions(contractData) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.id = 'contractSendModal';

            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Contract</h5>
                            <button type="button" class="close" onclick="closeContractSendModal()">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="contract-send-info">
                                <p><strong>Contract:</strong> ${contractData.contract.contract_title}</p>
                                <p><strong>Client:</strong> ${contractData.contract.client_name}</p>
                                <p><strong>Email:</strong> ${contractData.contract.client_email}</p>
                                <p><strong>Signing URL:</strong></p>
                                <div class="signing-url-container">
                                    <input type="text" id="signingUrlCopy" value="${contractData.signingUrl}" readonly class="form-control" style="font-size: 12px;">
                                    <button class="btn btn-sm btn-secondary mt-2" onclick="copySigningUrl()">Copy URL</button>
                                </div>
                            </div>

                            <div class="send-options mt-4">
                                <h6>Choose how to send:</h6>
                                
                                <button class="btn btn-primary btn-block mb-3" onclick="openEmailClient('${contractData.contract.client_email}', '${encodeURIComponent(contractData.emailData.subject)}', '${encodeURIComponent(contractData.emailData.body)}')">
                                    üìß Open Email App
                                </button>
                                
                                <button class="btn btn-success btn-block mb-3" onclick="openMessagingApp('${contractData.signingUrl}', '${contractData.contract.client_name}')">
                                    üí¨ Open Messaging App
                                </button>

                                <div class="manual-options mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                    <h6>Or copy and send manually:</h6>
                                    <div class="form-group">
                                        <label>Email Subject:</label>
                                        <input type="text" value="${contractData.emailData.subject}" readonly class="form-control form-control-sm">
                                    </div>
                                    <div class="form-group">
                                        <label>Email Message:</label>
                                        <textarea readonly class="form-control form-control-sm" rows="8">${contractData.emailData.body}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeContractSendModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            showMessage('Contract prepared successfully! Choose your preferred sending method.', 'success');
        }

        // Open default email client
        function openEmailClient(email, subject, body) {
            const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
            closeContractSendModal();
            showMessage('Opening your email app...', 'info');
        }

        // Open messaging app (SMS)
        function openMessagingApp(signingUrl, clientName) {
            const message = `Hi ${clientName}! Your photography contract is ready for signature. Please review and sign here: ${signingUrl}`;
            const smsLink = `sms:?body=${encodeURIComponent(message)}`;
            window.location.href = smsLink;
            closeContractSendModal();
            showMessage('Opening your messaging app...', 'info');
        }

        // Copy signing URL to clipboard
        function copySigningUrl() {
            const urlInput = document.getElementById('signingUrlCopy');
            urlInput.select();
            document.execCommand('copy');
            showMessage('Signing URL copied to clipboard!', 'success');
        }

        // Close contract send modal
        function closeContractSendModal() {
            const modal = document.getElementById('contractSendModal');
            if (modal) {
                modal.remove();
            }
        }

        // Helper function to close modal by ID
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Save contract changes
        window.saveContractChanges = async function(contractId) {
            try {
                const title = document.getElementById('contractTitle').value;
                const content = document.getElementById('contractContent').value;
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }
                
                showMessage('Saving changes...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to update contract');
                }
                
                showMessage('Contract updated successfully!', 'success');
                closeModal('contractEditModal');
                
                // Refresh the contracts view if it's open
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract changes:', error);
                showMessage(`Failed to save changes: ${error.message}`, 'error');
            }
        }

        // Download contract PDF (placeholder for now)
        function downloadContractPDF(contractId) {
            showMessage('PDF download feature coming soon!', 'info');
        }

        // Contract Management Functions
        let currentContractSessionId = null;







        // Helper function to format file sizes (duplicate removed)







        window.openContractModal = async function(sessionId) {
            currentContractSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Load existing contracts for this session
            await loadExistingContracts(sessionId);
            
            const modal = document.getElementById('contractModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            currentContractSessionId = null;
        }

        async function loadExistingContracts(sessionId) {
            // Validate sessionId before making API call
            if (!sessionId) {
                console.warn('loadExistingContracts called without valid sessionId');
                return;
            }
            
            try {
                const authToken = await getAuthToken();
                const headers = {};
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, { headers });
                if (!response.ok) {
                    throw new Error('Failed to load contracts');
                }

                const contracts = await response.json();
                const existingContractsDiv = document.getElementById('existingContractsList');
                
                if (!existingContractsDiv) {
                    console.warn('existingContractsList element not found in DOM');
                    return;
                }
                
                if (contracts.length === 0) {
                    existingContractsDiv.innerHTML = '';
                    return;
                }

                existingContractsDiv.innerHTML = `
                    <h4>Existing Contracts:</h4>
                    <div class="existing-contracts-list">
                        ${contracts.map(contract => `
                            <div class="contract-item ${contract.status}">
                                <div class="contract-item-info">
                                    <h5>${contract.contract_title}</h5>
                                    <p>Status: ${contract.status.charAt(0).toUpperCase() + contract.status.slice(1)}</p>
                                    <p>Created: ${new Date(contract.created_at).toLocaleDateString()}</p>
                                    ${contract.signed_date ? `<p>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="contract-item-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editContract('${contract.id}')">
                                         Edit
                                    </button>
                                    ${contract.status === 'pending' ? `
                                        <button class="btn btn-primary btn-sm" onclick="sendContract('${contract.id}')">
                                            Send Contract
                                        </button>
                                    ` : contract.status === 'sent' ? `
                                        <span class="contract-status-badge sent">Sent</span>
                                    ` : contract.status === 'signed' ? `
                                        <span class="contract-status-badge signed">Signed</span>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading contracts:', error);
                showMessage('Failed to load existing contracts', 'error');
            }
        }

        async function createContract(sessionId, contractType) {
            try {
                showMessage('Creating contract...', 'info');
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractType: contractType
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create contract');
                }

                const result = await response.json();
                
                showMessage('Contract created successfully!', 'success');
                
                // Reload the existing contracts to show the new one
                await loadExistingContracts(sessionId);
                
                // Trigger milestone celebration
                // Contract signed successfully
                
            } catch (error) {
                console.error('Error creating contract:', error);
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        async function sendContract(contractId) {
            try {
                showMessage('Preparing contract email...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to prepare contract email');
                }

                const result = await response.json();
                
                // Get email data from server response
                const emailData = result.emailData;
                if (!emailData) {
                    throw new Error('Email template not available');
                }
                
                // Create mailto link with pre-filled email
                const mailtoLink = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                showMessage('Email client opened! Review and send the contract email.', 'success');
                
                // Show the signing URL for reference
                alert(`Email client opened with contract details!\n\nSigning URL: ${result.signingUrl}\n\nPlease review the email and send it to your client.`);
                
                // Reload existing contracts to update status (only if we have a valid session ID)
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error preparing contract email:', error);
                showMessage('Failed to prepare contract email: ' + error.message, 'error');
            }
        }

        // Contract Edit Functions
        let currentEditContractId = null;

        async function editContract(contractId) {
            try {
                currentEditContractId = contractId;
                
                // Fetch contract details
                const response = await fetch(`/api/contracts/${contractId}`, {
                    headers: {
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load contract details');
                }

                const contract = await response.json();
                
                // Populate edit form
                document.getElementById('contractTitle').value = contract.contract_title;
                document.getElementById('contractContent').value = contract.contract_content;
                
                // Show edit modal
                const editModal = document.getElementById('contractEditModal');
                editModal.style.display = 'flex';
                editModal.style.alignItems = 'center';
                editModal.style.justifyContent = 'center';
                
            } catch (error) {
                console.error('Error loading contract for edit:', error);
                showMessage('Failed to load contract: ' + error.message, 'error');
            }
        }

        function closeContractEditModal() {
            document.getElementById('contractEditModal').style.display = 'none';
            currentEditContractId = null;
        }

        async function saveContractChanges(event) {
            event.preventDefault();
            
            if (!currentEditContractId) {
                showMessage('No contract selected for editing', 'error');
                return;
            }

            try {
                showMessage('Saving contract changes...', 'info');
                
                const title = document.getElementById('contractTitle').value.trim();
                const content = document.getElementById('contractContent').value.trim();
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }

                const response = await fetch(`/api/contracts/${currentEditContractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save contract changes');
                }

                showMessage('Contract updated successfully!', 'success');
                closeContractEditModal();
                
                // Reload existing contracts to show the updated version
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save changes: ' + error.message, 'error');
            }
        }



        // Get authentication token helper function
        async function getAuthToken() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    return 'authenticated'; // Simplified token for authenticated requests
                }
                return null;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }

        // Tab switching functionality
        window.switchTab = function(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Close mobile menu when a tab is selected
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Activated tab:', tabName + 'Tab');
            } else {
                console.error('Tab not found:', tabName + 'Tab');
            }
            
            // Set active nav link
            const activeLink = document.querySelector(`.nav-link[onclick*="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                console.log('Set active nav link for:', tabName);
            }
            
            // Initialize specific tabs when switching
            if (tabName === 'goldenHour') {
                // Set default date to today if not already set
                const dateInput = document.getElementById('dateInput');
                if (dateInput && !dateInput.value) {
                    const today = new Date();
                    dateInput.value = today.toISOString().split('T')[0];
                }
            } else if (tabName === 'businessManagement') {
                // Initialize Business Management when tab is first opened
                initializeBusinessManagement();
            }
        }

        // Business Management Functions
        function initializeBusinessManagement() {
            updateDashboard();
            loadExpensesTable();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('expenseDate')) document.getElementById('expenseDate').value = today;
            if (document.getElementById('tripDate')) document.getElementById('tripDate').value = today;
            if (document.getElementById('reportStartDate')) document.getElementById('reportStartDate').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            if (document.getElementById('reportEndDate')) document.getElementById('reportEndDate').value = today;
            
            // Initialize address autocomplete
            initializeAddressAutocomplete();
        }

        // Business Section Navigation
        function showBusinessSection(sectionName) {
            // Hide all business sections
            const sections = document.querySelectorAll('.business-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active class from all nav buttons
            const navButtons = document.querySelectorAll('.business-nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected section
            const selectedSection = document.getElementById(sectionName + 'Section');
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Initialize section-specific data
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'expenses') {
                // Load expenses table when switching to expense section
                setTimeout(() => {
                    if (typeof loadExpensesTable === 'function') {
                        loadExpensesTable();
                    }
                }, 100);
            } else if (sectionName === 'mileage') {
                loadMileageTrips();
            } else if (sectionName === 'aiAssistant') {
                loadAIHistory();
            }
        }

        // AI Assistant Functions
        function showAITab(tabName) {
            // Hide all AI tab contents
            const aiTabs = document.querySelectorAll('.ai-tab-content');
            aiTabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all AI tab buttons
            const aiButtons = document.querySelectorAll('.ai-tab-btn');
            aiButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected AI tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // AI Content Generation Functions
        async function generateBlogPost() {
            const prompt = document.getElementById('blogPrompt').value.trim();
            if (!prompt) {
                showMessage('Please enter a blog topic or prompt', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-blog', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate blog post');
                }

                document.getElementById('blogOutput').innerHTML = data.content;
                
                // Save to history
                saveAIPrompt('blog', prompt, data.content);
                showMessage('Blog post generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating blog post:', error);
                showMessage('Failed to generate blog post. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function generateSocialPost() {
            const platform = document.getElementById('socialPlatform').value;
            const prompt = document.getElementById('socialPrompt').value.trim();
            const includeHashtags = document.getElementById('includeHashtags').checked;

            if (!prompt) {
                showMessage('Please enter a post topic or prompt', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-social', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ platform, prompt, includeHashtags })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate social post');
                }

                document.getElementById('socialOutput').textContent = data.content;
                
                // Save to history
                saveAIPrompt('social', `${platform}: ${prompt}`, data.content);
                showMessage('Social media post generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating social post:', error);
                showMessage('Failed to generate social post. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function generateQuickIdeas() {
            const prompt = document.getElementById('ideaPrompt').value.trim();
            if (!prompt) {
                showMessage('Please enter what you need ideas for', 'error');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                const response = await fetch('/api/ai/generate-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 429 && data.error === 'OpenAI API quota exceeded') {
                        showMessage(`OpenAI API quota exceeded: ${data.message}`, 'error');
                        return;
                    }
                    throw new Error(data.message || 'Failed to generate ideas');
                }

                const ideasContainer = document.getElementById('ideasOutput');
                ideasContainer.innerHTML = '';
                
                data.ideas.forEach(idea => {
                    const ideaDiv = document.createElement('div');
                    ideaDiv.className = 'idea-item';
                    
                    if (typeof idea === 'object' && idea.title && idea.description) {
                        // Structured format with title and description
                        ideaDiv.innerHTML = `
                            <div class="idea-title">${idea.title}</div>
                            <div class="idea-description">${idea.description}</div>
                        `;
                    } else if (typeof idea === 'object') {
                        // Object but different structure - try to extract meaningful content
                        ideaDiv.textContent = idea.idea || idea.text || idea.content || JSON.stringify(idea);
                    } else {
                        // Simple string format
                        ideaDiv.textContent = idea;
                    }
                    
                    ideasContainer.appendChild(ideaDiv);
                });
                
                // Save to history
                saveAIPrompt('ideas', prompt, data.ideas.join('\n'));
                showMessage('Ideas generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating ideas:', error);
                showMessage('Failed to generate ideas. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function saveAIPrompt(type, prompt, response) {
            const history = JSON.parse(localStorage.getItem('aiHistory') || '[]');
            history.unshift({
                id: Date.now(),
                type,
                prompt,
                response,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 entries
            if (history.length > 50) {
                history.splice(50);
            }
            
            localStorage.setItem('aiHistory', JSON.stringify(history));
            loadAIHistory();
        }

        function loadAIHistory() {
            const history = JSON.parse(localStorage.getItem('aiHistory') || '[]');
            const historyContainer = document.getElementById('aiHistoryList');
            
            if (!historyContainer) return;
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>No AI prompts in history yet.</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(item => `
                <div class="history-item" style="padding: var(--spacing-md); border: 1px solid var(--accent-beige); border-radius: var(--border-radius); margin-bottom: var(--spacing-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <span style="font-weight: 600; color: var(--gold-muted);">${item.type.toUpperCase()}</span>
                        <span style="font-size: 0.85rem; color: var(--text-light);">${new Date(item.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div style="margin-bottom: var(--spacing-xs); font-weight: 500;">Prompt: ${item.prompt}</div>
                    <div style="color: var(--text-secondary); max-height: 100px; overflow-y: auto;">${item.response.substring(0, 200)}${item.response.length > 200 ? '...' : ''}</div>
                </div>
            `).join('');
        }

        // Utility Functions
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const text = element.textContent || element.innerHTML;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('Copied to clipboard!', 'success');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('Copied to clipboard!', 'success');
            }
        }

        function clearOutput(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.innerHTML = '';
        }

        // Dashboard Functions
        async function updateDashboard() {
            const dateRange = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
            const customRange = document.getElementById('customDateRange');
            
            if (customRange) {
                if (dateRange === 'custom') {
                    customRange.style.display = 'block';
                } else {
                    customRange.style.display = 'none';
                }
            }

            try {
                // Calculate date range
                const { startDate, endDate } = getDateRange(dateRange);
                
                // Load financial data
                const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
                
                // For now, we'll use dummy earnings data since we don't have a booking system
                // In a real implementation, this would come from the session booking system
                const earnings = calculateEarnings(startDate, endDate);
                const totalExpenses = calculateExpenses(expenses, startDate, endDate);
                const netProfit = earnings - totalExpenses;
                
                // Update dashboard cards
                if (document.getElementById('totalEarnings')) document.getElementById('totalEarnings').textContent = `$${earnings.toFixed(2)}`;
                if (document.getElementById('totalExpenses')) document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
                if (document.getElementById('netProfit')) document.getElementById('netProfit').textContent = `$${netProfit.toFixed(2)}`;
                
                const periodText = getPeriodText(dateRange);
                if (document.getElementById('earningsPeriod')) document.getElementById('earningsPeriod').textContent = periodText;
                if (document.getElementById('expensesPeriod')) document.getElementById('expensesPeriod').textContent = periodText;
                if (document.getElementById('profitPeriod')) document.getElementById('profitPeriod').textContent = periodText;
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showMessage('Failed to update dashboard', 'error');
            }
        }

        function getDateRange(range) {
            const now = new Date();
            let startDate, endDate;
            
            switch (range) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'thisWeek':
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    startDate = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate());
                    endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'thisYear':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate');
                    const endInput = document.getElementById('endDate');
                    startDate = startInput ? new Date(startInput.value) : new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = endInput ? new Date(endInput.value) : new Date();
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            }
            
            return { startDate, endDate };
        }

        function calculateEarnings(startDate, endDate) {
            // This would integrate with the session booking system
            // For now, returning a placeholder calculation
            const months = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 30));
            return months * 2500; // $2500 average per month
        }

        function calculateExpenses(expenses, startDate, endDate) {
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            }).reduce((total, expense) => total + expense.amount, 0);
        }

        function getPeriodText(range) {
            switch (range) {
                case 'today': return 'Today';
                case 'thisWeek': return 'This Week';
                case 'thisMonth': return 'This Month';
                case 'thisYear': return 'This Year';
                case 'custom': return 'Custom Range';
                default: return 'This Month';
            }
        }

        // Expense Tracker Functions
        function showAddExpenseForm() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }

        function cancelExpenseForm() {
            const form = document.getElementById('addExpenseForm');
            if (form) {
                form.style.display = 'none';
                // Clear form
                if (document.getElementById('expenseDate')) document.getElementById('expenseDate').value = '';
                if (document.getElementById('expenseCategory')) document.getElementById('expenseCategory').value = 'software';
                if (document.getElementById('expenseAmount')) document.getElementById('expenseAmount').value = '';
                if (document.getElementById('expenseDescription')) document.getElementById('expenseDescription').value = '';
                if (document.getElementById('expenseRecurring')) document.getElementById('expenseRecurring').checked = false;
            }
        }

        function saveExpense() {
            const date = document.getElementById('expenseDate')?.value;
            const category = document.getElementById('expenseCategory')?.value;
            const amount = parseFloat(document.getElementById('expenseAmount')?.value || '0');
            const description = document.getElementById('expenseDescription')?.value;
            const recurring = document.getElementById('expenseRecurring')?.checked;

            if (!date || !amount || !description) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            const expense = {
                id: Date.now(),
                date,
                category,
                amount,
                description,
                recurring,
                timestamp: new Date().toISOString()
            };

            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.unshift(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));

            cancelExpenseForm();
            loadExpenses();
            updateDashboard();
            showMessage('Expense added successfully!', 'success');
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const tbody = document.getElementById('expensesTableBody');
            
            if (!tbody) return;
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No expenses recorded yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td>${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}</td>
                    <td>${expense.description}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>${expense.recurring ? 'Yes' : 'No'}</td>
                    <td>
                        <button onclick="deleteExpense(${expense.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteExpense(id) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const filteredExpenses = expenses.filter(expense => expense.id !== id);
            localStorage.setItem('expenses', JSON.stringify(filteredExpenses));
            
            loadExpenses();
            updateDashboard();
            showMessage('Expense deleted successfully!', 'success');
        }

        function exportExpensesToCSV() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            if (expenses.length === 0) {
                showMessage('No expenses to export', 'error');
                return;
            }

            const csvContent = [
                ['Date', 'Category', 'Description', 'Amount', 'Recurring'],
                ...expenses.map(expense => [
                    expense.date,
                    expense.category,
                    expense.description,
                    expense.amount,
                    expense.recurring ? 'Yes' : 'No'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('Expenses exported to CSV!', 'success');
        }

        // Mileage Tracker Functions
        function showAddTripForm() {
            const form = document.getElementById('addTripForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                // Check if home base is set and enable/disable button
                updateHomeBaseButton();
            }
        }

        // Home Base Functions
        function showHomeBaseSetup() {
            const setup = document.getElementById('homeBaseSetup');
            const currentBase = document.getElementById('currentHomeBase');
            const homeBase = localStorage.getItem('homeBaseLocation');
            
            if (setup) {
                setup.style.display = setup.style.display === 'none' ? 'block' : 'none';
                
                if (homeBase) {
                    // Show current home base
                    document.getElementById('homeBaseAddress').textContent = homeBase;
                    currentBase.style.display = 'block';
                    document.getElementById('homeAddress').value = homeBase;
                } else {
                    currentBase.style.display = 'none';
                    document.getElementById('homeAddress').value = '';
                }
                
                // Re-initialize autocomplete when showing the setup
                setTimeout(() => initializeAddressAutocomplete(), 100);
            }
        }

        function cancelHomeBaseSetup() {
            const setup = document.getElementById('homeBaseSetup');
            if (setup) {
                setup.style.display = 'none';
            }
        }

        function editHomeBase() {
            const currentBase = document.getElementById('currentHomeBase');
            if (currentBase) {
                currentBase.style.display = 'none';
            }
        }

        async function useCurrentLocation() {
            if ("geolocation" in navigator) {
                showMessage('Getting your current location...', 'info');
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        });
                    });
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Use reverse geocoding to get address
                    const address = await reverseGeocode(lat, lng);
                    document.getElementById('homeAddress').value = address;
                    showMessage('Current location detected!', 'success');
                    
                } catch (error) {
                    console.error('Error getting location:', error);
                    showMessage('Could not get your location. Please enter address manually.', 'error');
                }
            } else {
                showMessage('Location services not available in your browser', 'error');
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                // Using a free geocoding service (you might want to use a better one)
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                const data = await response.json();
                
                if (data.locality && data.principalSubdivision) {
                    return `${data.locality}, ${data.principalSubdivision}, ${data.countryCode}`;
                } else {
                    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        function saveHomeBase() {
            const address = document.getElementById('homeAddress').value.trim();
            
            if (!address) {
                showMessage('Please enter an address for your home base', 'error');
                return;
            }
            
            localStorage.setItem('homeBaseLocation', address);
            showMessage('Home base location saved!', 'success');
            
            // Update the display
            document.getElementById('homeBaseAddress').textContent = address;
            document.getElementById('currentHomeBase').style.display = 'block';
            
            // Enable the use home base button in trip form
            updateHomeBaseButton();
        }

        function updateHomeBaseButton() {
            const homeBase = localStorage.getItem('homeBaseLocation');
            const button = document.getElementById('useHomeBaseBtn');
            
            if (button) {
                if (homeBase) {
                    button.disabled = false;
                    button.textContent = `üè† Use Home Base`;
                    button.title = `Click to use: ${homeBase}`;
                } else {
                    button.disabled = true;
                    button.textContent = `üè† No Home Base Set`;
                    button.title = 'Set up your home base first';
                }
            }
        }

        function useHomeBaseForTrip() {
            const homeBase = localStorage.getItem('homeBaseLocation');
            const startLocationInput = document.getElementById('startLocation');
            
            if (homeBase && startLocationInput) {
                startLocationInput.value = homeBase;
                showMessage('Home base location added!', 'success');
            } else {
                showMessage('No home base set. Please configure it first.', 'error');
            }
        }

        // Address Autocomplete System
        let debounceTimers = {};
        let currentFocus = -1;

        function initializeAddressAutocomplete() {
            // Initialize autocomplete for all address inputs
            const addressInputs = [
                { input: 'homeAddress', suggestions: 'homeAddressSuggestions' },
                { input: 'startLocation', suggestions: 'startLocationSuggestions' },
                { input: 'endLocation', suggestions: 'endLocationSuggestions' }
            ];

            addressInputs.forEach(config => {
                const input = document.getElementById(config.input);
                const suggestions = document.getElementById(config.suggestions);
                
                if (input && suggestions) {
                    setupAddressInput(input, suggestions);
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideAllSuggestions();
                }
            });
        }

        function setupAddressInput(input, suggestionsContainer) {
            input.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                // Debounce the API calls
                clearTimeout(debounceTimers[input.id]);
                debounceTimers[input.id] = setTimeout(() => {
                    searchAddresses(query, suggestionsContainer, input);
                }, 300);
            });

            input.addEventListener('keydown', function(e) {
                handleKeyboardNavigation(e, suggestionsContainer, input);
            });

            input.addEventListener('blur', function(e) {
                // Delay hiding to allow for click events on suggestions
                setTimeout(() => {
                    if (!e.target.closest('.autocomplete-container').querySelector(':hover')) {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 150);
            });
        }

        async function searchAddresses(query, suggestionsContainer, input) {
            try {
                // Primary search with Google Maps Geocoding API
                let addresses = await searchWithGoogleMaps(query);
                
                // If no results or API unavailable, fallback to OpenStreetMap
                if (addresses.length === 0) {
                    addresses = await searchWithNominatim(query);
                    
                    // If still no results, try broader search
                    if (addresses.length === 0) {
                        addresses = await searchWithBroadQuery(query);
                    }
                }
                
                displayAddressSuggestions(addresses, suggestionsContainer, input);
                
            } catch (error) {
                console.error('Address search error:', error);
                // Fallback: show a message that we couldn't fetch suggestions
                suggestionsContainer.innerHTML = `
                    <div class="address-suggestion">
                        <div class="suggestion-main">Search temporarily unavailable</div>
                        <div class="suggestion-detail">Please type the complete address</div>
                    </div>
                `;
                suggestionsContainer.style.display = 'block';
            }
        }

        async function searchWithGoogleMaps(query) {
            try {
                // Use enhanced backend geocoding with Places Autocomplete + Geocoding fallback
                const response = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: query })
                });
                
                if (!response.ok) {
                    throw new Error('Google Maps API not available');
                }
                
                const data = await response.json();
                
                // Handle enhanced Google geocoding responses
                if (data.status === 'OK' && data.results) {
                    return data.results.map(result => ({
                        display_name: result.display_name || result.formatted_address,
                        address: result.address || {
                            road: result.address?.road || '',
                            city: result.address?.city || '',
                            state: result.address?.state || ''
                        },
                        lat: result.geometry?.location?.lat,
                        lon: result.geometry?.location?.lng,
                        confidence: result.confidence || 1,
                        source: data.source || 'google_maps'
                    }));
                }
                
                return [];
                
            } catch (error) {
                console.log('Google Maps API fallback to OpenStreetMap');
                return [];
            }
        }

        async function searchWithNominatim(query, restrictCountries = true) {
            const countryParams = restrictCountries ? '&countrycodes=us,ca,gb,au,nz' : '';
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}${countryParams}`
            );
            
            if (!response.ok) {
                throw new Error('Nominatim API error');
            }
            
            return await response.json();
        }

        async function searchWithBroadQuery(query) {
            // Try multiple search strategies for rural addresses
            const searches = [
                // Original query with US restriction
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(query)}&countrycodes=us&dedupe=1`,
                
                // Try with explicit rural/county formatting
                `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=10&q=${encodeURIComponent(query + ' South Carolina')}&countrycodes=us`,
                
                // Try searching just the city/state portion if it exists
                ...(() => {
                    const parts = query.split(',').map(p => p.trim());
                    if (parts.length >= 2) {
                        const cityState = parts.slice(-2).join(', ');
                        return [`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(cityState)}&countrycodes=us`];
                    }
                    return [];
                })()
            ];
            
            // Try each search strategy
            for (const searchUrl of searches) {
                try {
                    const response = await fetch(searchUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.length > 0) {
                            // Filter and rank results for better relevance
                            const filtered = data.filter(address => {
                                const displayName = address.display_name.toLowerCase();
                                const queryLower = query.toLowerCase();
                                const queryParts = queryLower.split(/[\s,]+/).filter(part => part.length > 0);
                                
                                // Check if the result contains at least some query terms
                                const matchCount = queryParts.filter(part => displayName.includes(part)).length;
                                return matchCount >= Math.max(1, Math.floor(queryParts.length * 0.4));
                            });
                            
                            if (filtered.length > 0) {
                                return filtered.slice(0, 5);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Search attempt failed:', error);
                    continue;
                }
            }
            
            return [];
        }

        function displayAddressSuggestions(addresses, suggestionsContainer, input) {
            if (addresses.length === 0) {
                // For specific addresses that might not be found, provide helpful suggestions
                const inputValue = input.value.toLowerCase();
                let helpText = "Try a different search term";
                
                if (inputValue.includes("county line") || inputValue.includes("rural") || /^\d+\s+\w+\s+(road|rd|street|st|lane|ln|drive|dr)/i.test(inputValue)) {
                    helpText = "Some rural addresses may not be in databases. Try adding city/state or use the manual option below.";
                } else if (inputValue.length > 10) {
                    helpText = "Address not found in database. You can still use it with the manual option below.";
                }
                
                suggestionsContainer.innerHTML = `
                    <div class="address-suggestion">
                        <div class="suggestion-main">No exact matches found</div>
                        <div class="suggestion-detail">${helpText}</div>
                    </div>
                    <div class="address-suggestion manual-input" data-address="${escapeHtml(input.value)}" style="border-top: 1px solid #e2e8f0; background-color: #f8fafc;">
                        <div class="suggestion-main">‚úì Use address as typed</div>
                        <div class="suggestion-detail">Continue with: "${escapeHtml(input.value)}"</div>
                    </div>
                `;
                suggestionsContainer.style.display = 'block';
                return;
            }

            const suggestionsHTML = addresses.map((address, index) => {
                // Better address formatting for rural/county addresses
                let mainAddress, fullAddress;
                
                if (address.address) {
                    // Use structured address data if available
                    const parts = [];
                    if (address.address.house_number) parts.push(address.address.house_number);
                    if (address.address.road) parts.push(address.address.road);
                    else if (address.address.street) parts.push(address.address.street);
                    
                    mainAddress = parts.join(' ') || address.display_name.split(',')[0];
                    fullAddress = address.display_name;
                } else {
                    // Fallback to display name parsing
                    const addressParts = address.display_name.split(',');
                    mainAddress = addressParts.slice(0, 2).join(',').trim();
                    fullAddress = address.display_name;
                }
                
                return `
                    <div class="address-suggestion" data-address="${escapeHtml(fullAddress)}" data-index="${index}">
                        <div class="suggestion-main">${escapeHtml(mainAddress)}</div>
                        <div class="suggestion-detail">${escapeHtml(fullAddress)}</div>
                    </div>
                `;
            }).join('');

            suggestionsContainer.innerHTML = suggestionsHTML;
            suggestionsContainer.style.display = 'block';
            currentFocus = -1;

            // Add click listeners to suggestions
            suggestionsContainer.querySelectorAll('.address-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const selectedAddress = this.getAttribute('data-address');
                    input.value = selectedAddress;
                    suggestionsContainer.style.display = 'none';
                    
                    // Trigger any change events
                    const changeEvent = new Event('change', { bubbles: true });
                    input.dispatchEvent(changeEvent);
                });
            });
        }

        function handleKeyboardNavigation(e, suggestionsContainer, input) {
            const suggestions = suggestionsContainer.querySelectorAll('.address-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentFocus++;
                if (currentFocus >= suggestions.length) currentFocus = 0;
                updateSuggestionFocus(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentFocus--;
                if (currentFocus < 0) currentFocus = suggestions.length - 1;
                updateSuggestionFocus(suggestions);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1 && suggestions[currentFocus]) {
                    const selectedAddress = suggestions[currentFocus].getAttribute('data-address');
                    input.value = selectedAddress;
                    suggestionsContainer.style.display = 'none';
                    
                    const changeEvent = new Event('change', { bubbles: true });
                    input.dispatchEvent(changeEvent);
                }
            } else if (e.key === 'Escape') {
                suggestionsContainer.style.display = 'none';
                currentFocus = -1;
            }
        }

        function updateSuggestionFocus(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('selected', index === currentFocus);
            });
        }

        function hideAllSuggestions() {
            document.querySelectorAll('.address-suggestions').forEach(container => {
                container.style.display = 'none';
            });
            currentFocus = -1;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function cancelTripForm() {
            const form = document.getElementById('addTripForm');
            if (form) {
                form.style.display = 'none';
                // Clear form
                if (document.getElementById('tripDate')) document.getElementById('tripDate').value = '';
                if (document.getElementById('tripPurpose')) document.getElementById('tripPurpose').value = 'client_work';
                if (document.getElementById('startLocation')) document.getElementById('startLocation').value = '';
                if (document.getElementById('endLocation')) document.getElementById('endLocation').value = '';
                if (document.getElementById('milesDriven')) document.getElementById('milesDriven').value = '';
                if (document.getElementById('roundTrip')) document.getElementById('roundTrip').checked = false;
                
                // Reset calculate button text
                updateCalculateButton();
            }
        }

        async function calculateMiles() {
            const startLocation = document.getElementById('startLocation')?.value.trim();
            const endLocation = document.getElementById('endLocation')?.value.trim();
            const isRoundTrip = document.getElementById('roundTrip')?.checked;

            if (!startLocation || !endLocation) {
                showMessage('Please enter both start and end locations', 'error');
                return;
            }

            const tripType = isRoundTrip ? 'round trip' : 'one way';
            showMessage(`Calculating ${tripType} driving distance...`, 'info');

            try {
                if (isRoundTrip) {
                    // Calculate round trip: Start ‚Üí End ‚Üí Start
                    const outboundResponse = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [startLocation],
                            destinations: [endLocation]
                        })
                    });

                    const returnResponse = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [endLocation],
                            destinations: [startLocation]
                        })
                    });

                    if (!outboundResponse.ok || !returnResponse.ok) {
                        throw new Error('Distance API not available');
                    }

                    const outboundData = await outboundResponse.json();
                    const returnData = await returnResponse.json();

                    if (outboundData.status === 'OK' && returnData.status === 'OK' &&
                        outboundData.rows[0]?.elements[0]?.status === 'OK' &&
                        returnData.rows[0]?.elements[0]?.status === 'OK') {
                        
                        const outboundElement = outboundData.rows[0].elements[0];
                        const returnElement = returnData.rows[0].elements[0];
                        
                        const outboundMeters = outboundElement.distance.value;
                        const returnMeters = returnElement.distance.value;
                        const totalMeters = outboundMeters + returnMeters;
                        
                        const totalMiles = (totalMeters * 0.000621371).toFixed(1);
                        const outboundDuration = outboundElement.duration.text;
                        const returnDuration = returnElement.duration.text;
                        
                        const milesInput = document.getElementById('milesDriven');
                        if (milesInput) {
                            milesInput.value = totalMiles;
                        }
                        
                        showMessage(`Round trip: ${totalMiles} miles (${outboundDuration} + ${returnDuration})`, 'success');
                    } else {
                        await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
                    }
                } else {
                    // Calculate one-way trip
                    const response = await fetch('/api/distance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            origins: [startLocation],
                            destinations: [endLocation]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Distance API not available');
                    }

                    const data = await response.json();

                    if (data.status === 'OK' && data.rows[0]?.elements[0]?.status === 'OK') {
                        const element = data.rows[0].elements[0];
                        const distanceInMeters = element.distance.value;
                        const miles = (distanceInMeters * 0.000621371).toFixed(1);
                        const duration = element.duration.text;
                        
                        const milesInput = document.getElementById('milesDriven');
                        if (milesInput) {
                            milesInput.value = miles;
                        }
                        
                        showMessage(`Driving distance: ${miles} miles (${duration})`, 'success');
                    } else {
                        await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
                    }
                }

            } catch (error) {
                console.error('Error with Google Distance Matrix, using fallback:', error);
                await calculateMilesWithFallback(startLocation, endLocation, isRoundTrip);
            }
        }

        async function calculateMilesWithFallback(startLocation, endLocation, isRoundTrip = false) {
            try {
                showMessage('Using estimated distance calculation...', 'info');
                
                // Use our enhanced geocoding API for coordinates
                const [startResponse, endResponse] = await Promise.all([
                    fetch('/api/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: startLocation })
                    }),
                    fetch('/api/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: endLocation })
                    })
                ]);

                const [startData, endData] = await Promise.all([
                    startResponse.json(),
                    endResponse.json()
                ]);

                if (!startData.results?.[0] || !endData.results?.[0]) {
                    throw new Error('Could not find one or both locations');
                }

                // Extract coordinates from enhanced geocoding response
                const startResult = startData.results[0];
                const endResult = endData.results[0];
                
                let startLat, startLon, endLat, endLon;

                if (startResult.lat && startResult.lon) {
                    startLat = startResult.lat;
                    startLon = startResult.lon;
                } else if (startResult.geometry?.location) {
                    startLat = startResult.geometry.location.lat;
                    startLon = startResult.geometry.location.lng;
                } else {
                    throw new Error('Could not get coordinates for start location');
                }

                if (endResult.lat && endResult.lon) {
                    endLat = endResult.lat;
                    endLon = endResult.lon;
                } else if (endResult.geometry?.location) {
                    endLat = endResult.geometry.location.lat;
                    endLon = endResult.geometry.location.lng;
                } else {
                    throw new Error('Could not get coordinates for end location');
                }

                // Calculate straight-line distance using Haversine formula
                let miles = calculateHaversineDistance(startLat, startLon, endLat, endLon);
                
                // Double the distance for round trips
                if (isRoundTrip) {
                    miles = miles * 2;
                }
                
                const milesInput = document.getElementById('milesDriven');
                if (milesInput) {
                    milesInput.value = miles.toFixed(1);
                }
                
                const tripType = isRoundTrip ? 'round trip' : 'one way';
                showMessage(`Estimated ${tripType}: ${miles.toFixed(1)} miles (straight-line)`, 'success');

            } catch (error) {
                console.error('Fallback distance calculation failed:', error);
                showMessage('Could not calculate distance. Please enter miles manually.', 'error');
            }
        }

        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateCalculateButton() {
            const isRoundTrip = document.getElementById('roundTrip')?.checked;
            const button = document.getElementById('calculateBtn');
            
            if (button) {
                if (isRoundTrip) {
                    button.textContent = 'üîÑ Calculate Round Trip';
                    button.title = 'Calculate total distance: Start ‚Üí End ‚Üí Start';
                } else {
                    button.textContent = 'üó∫Ô∏è Calculate Miles';
                    button.title = 'Calculate one-way distance';
                }
            }
        }

        function saveTrip() {
            const date = document.getElementById('tripDate')?.value;
            const purpose = document.getElementById('tripPurpose')?.value;
            const startLocation = document.getElementById('startLocation')?.value;
            const endLocation = document.getElementById('endLocation')?.value;
            const miles = parseFloat(document.getElementById('milesDriven')?.value || '0');
            const isRoundTrip = document.getElementById('roundTrip')?.checked || false;

            if (!date || !startLocation || !endLocation || !miles) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            const trip = {
                id: Date.now(),
                date,
                purpose,
                startLocation,
                endLocation,
                miles,
                roundTrip: isRoundTrip,
                timestamp: new Date().toISOString()
            };

            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            trips.unshift(trip);
            localStorage.setItem('mileageTrips', JSON.stringify(trips));

            cancelTripForm();
            loadMileageTrips();
            
            const tripType = isRoundTrip ? 'round trip' : 'one-way trip';
            showMessage(`${tripType} added successfully!`, 'success');
        }

        function loadMileageTrips() {
            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            const tbody = document.getElementById('mileageTableBody');
            
            if (!tbody) return;
            
            // Update home base button status
            updateHomeBaseButton();
            
            // Initialize address autocomplete
            initializeAddressAutocomplete();
            
            if (trips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No trips recorded yet.</td></tr>';
                return;
            }
            
            tbody.innerHTML = trips.map(trip => `
                <tr>
                    <td>${new Date(trip.date).toLocaleDateString()}</td>
                    <td>${trip.startLocation}</td>
                    <td>${trip.endLocation}</td>
                    <td>${trip.miles.toFixed(1)}</td>
                    <td>${trip.roundTrip ? 'üîÑ Round Trip' : '‚û°Ô∏è One Way'}</td>
                    <td>${trip.purpose.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td>
                        <button onclick="deleteTrip(${trip.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteTrip(id) {
            if (!confirm('Are you sure you want to delete this trip?')) return;
            
            const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');
            const filteredTrips = trips.filter(trip => trip.id !== id);
            localStorage.setItem('mileageTrips', JSON.stringify(filteredTrips));
            
            loadMileageTrips();
            showMessage('Trip deleted successfully!', 'success');
        }

        // Reports Functions
        async function generateReport() {
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;

            if (!startDate || !endDate) {
                showMessage('Please select start and end dates', 'error');
                return;
            }

            showMessage('Generating report...', 'info');

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Get expenses from database (same as dashboard)
                const expensesResponse = await fetch('/api/business/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    expenses = await expensesResponse.json();
                }

                // Get mileage trips from localStorage (local storage)
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                // Filter data by date range
                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= start && tripDate <= end;
                });

                // Calculate totals using same logic as dashboard
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + trip.miles, 0);
                const mileageDeduction = totalMiles * 0.655; // 2024 IRS standard mileage rate
                const totalEarnings = await calculateEarningsForPeriod(start, end);
                const netProfit = totalEarnings - totalExpenses;

                // Update report display
                if (document.getElementById('reportEarnings')) document.getElementById('reportEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
                if (document.getElementById('reportExpenses')) document.getElementById('reportExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
                if (document.getElementById('reportMiles')) document.getElementById('reportMiles').textContent = totalMiles.toFixed(1);
                if (document.getElementById('reportMileageDeduction')) document.getElementById('reportMileageDeduction').textContent = `$${mileageDeduction.toFixed(2)}`;
                if (document.getElementById('reportNetProfit')) document.getElementById('reportNetProfit').textContent = `$${netProfit.toFixed(2)}`;

                // Show detailed breakdown
                updateReportBreakdown(filteredExpenses, filteredTrips, start, end);

                showMessage('Report generated successfully!', 'success');

            } catch (error) {
                console.error('Error generating report:', error);
                showMessage('Error generating report. Please try again.', 'error');
            }
        }

        async function calculateEarningsForPeriod(startDate, endDate) {
            try {
                // Get sessions from the same source as dashboard
                if (typeof sessions !== 'undefined' && sessions.length > 0) {
                    const filteredSessions = sessions.filter(session => {
                        const sessionDate = new Date(session.dateTime);
                        return sessionDate >= startDate && sessionDate <= endDate;
                    });
                    return filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                } else {
                    // Fallback to API call if sessions not available
                    const response = await fetch('/api/sessions');
                    if (response.ok) {
                        const apiSessions = await response.json();
                        const filteredSessions = apiSessions.filter(session => {
                            const sessionDate = new Date(session.dateTime);
                            return sessionDate >= startDate && sessionDate <= endDate;
                        });
                        return filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                    }
                }
            } catch (error) {
                console.error('Error calculating earnings:', error);
            }
            return 0;
        }

        function updateReportBreakdown(expenses, trips, startDate, endDate) {
            // Create detailed breakdown section
            let breakdownHTML = `
                <div class="report-breakdown">
                    <h4>Report Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</h4>
                    
                    <div class="breakdown-section">
                        <h5>üìä Expenses Breakdown (${expenses.length} items)</h5>
                        ${expenses.length > 0 ? `
                            <div class="expense-details">
                                ${expenses.map(expense => `
                                    <div class="breakdown-item">
                                        <span>${new Date(expense.date).toLocaleDateString()}</span>
                                        <span>${expense.description}</span>
                                        <span class="amount">$${parseFloat(expense.amount).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>No expenses in this period</p>'}
                    </div>
                    
                    <div class="breakdown-section">
                        <h5>üöó Mileage Breakdown (${trips.length} trips)</h5>
                        ${trips.length > 0 ? `
                            <div class="trip-details">
                                ${trips.map(trip => `
                                    <div class="breakdown-item">
                                        <span>${new Date(trip.date).toLocaleDateString()}</span>
                                        <span>${trip.startLocation} ‚Üí ${trip.endLocation} ${trip.roundTrip ? '(Round Trip)' : ''}</span>
                                        <span class="amount">${trip.miles.toFixed(1)} mi</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>No trips in this period</p>'}
                    </div>
                </div>
            `;

            const breakdownElement = document.getElementById('reportBreakdown');
            if (breakdownElement) {
                breakdownElement.innerHTML = breakdownHTML;
            }
        }

        async function exportReportCSV() {
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;

            if (!startDate || !endDate) {
                showMessage('Please generate a report first', 'error');
                return;
            }

            showMessage('Exporting report data...', 'info');

            try {
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Get expenses from database (same as dashboard)
                const expensesResponse = await fetch('/api/business/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    expenses = await expensesResponse.json();
                }

                // Get mileage trips from localStorage
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= start && tripDate <= end;
                });

                // Calculate totals for CSV summary
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + trip.miles, 0);
                const mileageDeduction = totalMiles * 0.655;

                const csvContent = [
                    ['BUSINESS REPORT'],
                    [`Period: ${startDate} to ${endDate}`],
                    [''],
                    ['SUMMARY'],
                    ['Total Expenses', `$${totalExpenses.toFixed(2)}`],
                    ['Total Miles', `${totalMiles.toFixed(1)}`],
                    ['Mileage Deduction (@ $0.655/mi)', `$${mileageDeduction.toFixed(2)}`],
                    [''],
                    ['EXPENSES DETAIL'],
                    ['Date', 'Category', 'Description', 'Amount', 'Tax Deductible'],
                    ...filteredExpenses.map(expense => [
                        new Date(expense.date).toLocaleDateString(),
                        expense.category,
                        expense.description,
                        `$${parseFloat(expense.amount).toFixed(2)}`,
                        expense.tax_deductible ? 'Yes' : 'No'
                    ]),
                    [''],
                    ['MILEAGE DETAIL'],
                    ['Date', 'Start Location', 'End Location', 'Miles', 'Type', 'Purpose', 'Deduction'],
                    ...filteredTrips.map(trip => [
                        new Date(trip.date).toLocaleDateString(),
                        trip.startLocation,
                        trip.endLocation,
                        trip.miles.toFixed(1),
                        trip.roundTrip ? 'Round Trip' : 'One Way',
                        trip.purpose.replace('_', ' '),
                        `$${(trip.miles * 0.655).toFixed(2)}`
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_report_${startDate}_to_${endDate}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('Report exported to CSV successfully!', 'success');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                showMessage('Error exporting CSV. Please try again.', 'error');
            }
        }

        function exportReportPDF() {
            showMessage('PDF export feature coming soon!', 'info');
        }

        // Dashboard Export Functions
        async function exportDashboardCSV() {
            const period = document.getElementById('dashboardDateRange')?.value || 'thisMonth';
            const periodText = document.getElementById('dashboardDateRange')?.selectedOptions[0].text || 'This Month';
            
            showMessage('Exporting dashboard data...', 'info');

            try {
                // Get current dashboard data using existing functions
                const { startDate, endDate } = getDateRange(period);
                
                // Get expenses from database
                const expensesResponse = await fetch('/api/expenses');
                let expenses = [];
                if (expensesResponse.ok) {
                    const data = await expensesResponse.json();
                    expenses = data.success ? data.expenses : [];
                }

                // Get mileage trips from localStorage
                const trips = JSON.parse(localStorage.getItem('mileageTrips') || '[]');

                // Filter data by current dashboard period
                const filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                });

                const filteredTrips = trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate >= startDate && tripDate <= endDate;
                });

                // Get sessions using existing global sessions array
                let filteredSessions = [];
                if (typeof sessions !== 'undefined' && sessions.length > 0) {
                    filteredSessions = sessions.filter(session => {
                        const sessionDate = new Date(session.dateTime);
                        return sessionDate >= startDate && sessionDate <= endDate;
                    });
                }
                
                // Calculate totals
                const totalEarnings = filteredSessions.reduce((sum, session) => sum + (session.price || 0), 0);
                const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
                const totalMiles = filteredTrips.reduce((sum, trip) => sum + (trip.miles || 0), 0);
                const mileageDeduction = totalMiles * 0.655;
                const netProfit = totalEarnings - totalExpenses;

                // Create CSV content
                const csvContent = [
                    ['BUSINESS DASHBOARD EXPORT'],
                    [`Period: ${periodText} (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`],
                    [`Generated: ${new Date().toLocaleDateString()}`],
                    [''],
                    ['FINANCIAL SUMMARY'],
                    ['Metric', 'Amount'],
                    ['Total Earnings', `$${totalEarnings.toFixed(2)}`],
                    ['Total Expenses', `$${totalExpenses.toFixed(2)}`],
                    ['Net Profit', `$${netProfit.toFixed(2)}`],
                    ['Total Miles Driven', `${totalMiles.toFixed(1)}`],
                    ['Mileage Tax Deduction', `$${mileageDeduction.toFixed(2)}`],
                    [''],
                    ['SESSION BREAKDOWN'],
                    ['Date', 'Client', 'Session Type', 'Price', 'Status'],
                    ...filteredSessions.map(session => [
                        new Date(session.dateTime).toLocaleDateString(),
                        `"${(session.clientName || '').replace(/"/g, '""')}"`,
                        `"${(session.sessionType || '').replace(/"/g, '""')}"`,
                        `$${(session.price || 0).toFixed(2)}`,
                        session.paid ? 'Paid' : 'Unpaid'
                    ]),
                    [''],
                    ['EXPENSE BREAKDOWN'],
                    ['Date', 'Category', 'Description', 'Amount', 'Tax Deductible'],
                    ...filteredExpenses.map(expense => [
                        new Date(expense.date).toLocaleDateString(),
                        `"${(expense.category || '').replace(/"/g, '""')}"`,
                        `"${(expense.description || '').replace(/"/g, '""')}"`,
                        `$${parseFloat(expense.amount).toFixed(2)}`,
                        expense.tax_deductible ? 'Yes' : 'No'
                    ]),
                    [''],
                    ['MILEAGE BREAKDOWN'],
                    ['Date', 'Start', 'End', 'Miles', 'Type', 'Purpose'],
                    ...filteredTrips.map(trip => [
                        new Date(trip.date).toLocaleDateString(),
                        `"${(trip.startLocation || '').replace(/"/g, '""')}"`,
                        `"${(trip.endLocation || '').replace(/"/g, '""')}"`,
                        (trip.miles || 0).toFixed(1),
                        trip.roundTrip ? 'Round Trip' : 'One Way',
                        `"${((trip.purpose || '').replace('_', ' ')).replace(/"/g, '""')}"`
                    ])
                ].map(row => row.map(cell => {
                    // Escape CSV fields that contain commas, quotes, or newlines
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return cellStr.startsWith('"') ? cellStr : `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',')).join('\n');

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard_export_${periodText.toLowerCase().replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('Dashboard exported to CSV successfully!', 'success');

            } catch (error) {
                console.error('Error exporting dashboard:', error);
                showMessage('Error exporting dashboard. Please try again.', 'error');
            }
        }

        function exportDashboardPDF() {
            showMessage('PDF export feature coming soon!', 'info');
        }

    </script>

    <!-- Contract Modal -->
    <div id="contractModal" class="contract-modal" style="display: none; position: fixed; top: 0px; left: 0px; width: 100%; height: 100%; z-index: -9999; align-items: center; justify-content: center; visibility: hidden; opacity: 0;">
        <div class="contract-modal-overlay" onclick="closeContractModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">Document Contract Management</h3>
                <button class="contract-close-btn" onclick="closeContractModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <div class="contract-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
                    <button class="contract-tab active" onclick="switchContractTab('create')" style="flex: 1; padding: 10px; background: #d4af37; color: white; border: none; border-radius: 5px 0 0 0; cursor: pointer;">Create New</button>
                    <button class="contract-tab" onclick="switchContractTab('existing')" style="flex: 1; padding: 10px; background: #f8f9fa; color: #333; border: none; border-radius: 0 5px 0 0; cursor: pointer;">View Existing</button>
                </div>
                
                <div id="createContractTab" class="contract-tab-content">
                    <h4 style="color: #000000;">Create New Contract</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractTitleInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitleInput" placeholder="Photography Services Agreement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #000000;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractContentInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContentInput" rows="15" placeholder="Enter your contract terms and conditions here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <button onclick="createContract()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Create Contract</button>
                </div>
                
                <div id="existingContractTab" class="contract-tab-content" style="display: none;">
                    <h4 style="color: #000000;">Existing Contracts</h4>
                    <div id="existingContractsList" class="existing-contracts-list" style="color: #000000;">
                        <!-- Contracts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Edit Modal -->
    <div id="contractEditModal" class="contract-modal" style="display: none; position: fixed; top: 0px; left: 0px; width: 100%; height: 100%; z-index: -9999; align-items: center; justify-content: center; visibility: hidden; opacity: 0;">
        <div class="contract-modal-overlay" onclick="closeContractEditModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;"> Edit Contract</h3>
                <button class="contract-close-btn" onclick="closeContractEditModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <form id="contractEditForm" onsubmit="saveContractChanges(event)">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color: #000000;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContent" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeContractEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

























        // Image optimization function for large files
        async function optimizeImage(file, maxWidth = 1920, maxHeight = 2560, quality = 0.85) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions while maintaining aspect ratio
                    let { width, height } = img;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const optimizedFile = new File([blob], file.name, {
                            type: file.type,
                            lastModified: Date.now(),
                        });
                        resolve(optimizedFile);
                    }, file.type, quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }







        // Photography Management System Navigation System
        function setActiveNavLink(targetTab) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current link
            const activeLink = document.querySelector(`.nav-link[onclick*="${targetTab}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Override switchTab function to work with new navigation
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            // Close mobile menu when switching tabs
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
            setActiveNavLink(tab);
            if (originalSwitchTab) {
                originalSwitchTab(tab);
            }
        };

        // Hamburger Menu Toggle Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                if (mobileMenu.classList.contains('show')) {
                    closeMobileMenu();
                } else {
                    openMobileMenu();
                }
            }
        }

        function openMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.add('show');
                hamburgerBtn.classList.add('active');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && hamburgerBtn) {
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.querySelector('.hamburger-menu');
            
            if (mobileMenu && mobileMenu.classList.contains('show')) {
                if (!mobileMenu.contains(event.target) && !hamburgerBtn.contains(event.target)) {
                    closeMobileMenu();
                }
            }
        });

        // Hamburger menu initialization handled in main DOM ready event



        // Subscription Modal Functions
        function showSubscriptionModal(message) {
            const modal = document.createElement('div');
            modal.className = 'subscription-modal';
            modal.innerHTML = `
                <div class="subscription-backdrop" onclick="closeSubscriptionModal()"></div>
                <div class="subscription-content">
                    <button class="close-btn" onclick="closeSubscriptionModal()">√ó</button>
                    <h2> Subscription Required</h2>
                    <p style="margin: 1rem 0; color: #666;">${message}</p>
                    
                    <h3 style="margin: 2rem 0 1rem 0; color: #d4af37;">Choose Your Plan</h3>
                    
                    <div class="pricing-grid">
                        <div class="pricing-card" onclick="selectPlan('monthly')">
                            <h4>Monthly</h4>
                            <div class="price">$25<span>/month</span></div>
                            <ul>
                                <li>‚úì Full platform access</li>
                                <li>‚úì Unlimited sessions</li>
                                <li>‚úì Client galleries</li>
                                <li>‚úì Professional tools</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card featured" onclick="selectPlan('sixmonth')">
                            <div class="badge">BEST VALUE</div>
                            <h4>6 Months</h4>
                            <div class="price">$125<span>/6 months</span></div>
                            <div class="savings">Save $25 (1 month free!)</div>
                            <ul>
                                <li>‚úì Everything in Monthly</li>
                                <li>‚úì Priority support</li>
                                <li>‚úì Advanced features</li>
                            </ul>
                        </div>
                        
                        <div class="pricing-card" onclick="selectPlan('yearly')">
                            <h4>Annual</h4>
                            <div class="price">$200<span>/year</span></div>
                            <div class="savings">Save $100 (2 months free!)</div>
                            <ul>
                                <li>‚úì Everything in 6 Months</li>
                                <li>‚úì Custom branding</li>
                                <li>‚úì Premium features</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="paymentForm" style="display: none; margin-top: 2rem;">
                        <div id="card-element"></div>
                        <button id="submitPayment" class="submit-btn">Complete Subscription</button>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .subscription-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 10000;
                }
                
                .subscription-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                }
                
                .subscription-content {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                }
                
                .close-btn {
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: none;
                    border: none;
                    font-size: 2rem;
                    cursor: pointer;
                    color: #666;
                }
                
                .pricing-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1.5rem;
                    margin: 2rem 0;
                }
                
                .pricing-card {
                    border: 2px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 2rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                }
                
                .pricing-card:hover {
                    border-color: #d4af37;
                    transform: translateY(-5px);
                    box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
                }
                
                .pricing-card.featured {
                    border-color: #d4af37;
                    background: linear-gradient(to bottom, #fafaf8, #f5f5f0);
                }
                
                .badge {
                    position: absolute;
                    top: -12px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #d4af37;
                    color: white;
                    padding: 4px 16px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }
                
                .price {
                    font-size: 2.5rem;
                    color: #d4af37;
                    margin: 1rem 0;
                    font-weight: 700;
                }
                
                .price span {
                    font-size: 1rem;
                    color: #666;
                    font-weight: 400;
                }
                
                .savings {
                    color: #34a853;
                    font-size: 0.9rem;
                    margin-bottom: 1rem;
                }
                
                .pricing-card ul {
                    list-style: none;
                    padding: 0;
                    margin: 1rem 0 0 0;
                    text-align: left;
                }
                
                .pricing-card li {
                    padding: 0.5rem 0;
                    color: #666;
                }
                
                .submit-btn {
                    background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%);
                    color: #000;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 1rem;
                }
                
                #card-element {
                    border: 1px solid #ddd;
                    padding: 1rem;
                    border-radius: 8px;
                    background: #f9f9f9;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
        }
        
        function closeSubscriptionModal() {
            const modal = document.querySelector('.subscription-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function selectPlan(plan) {
            const paymentForm = document.getElementById('paymentForm');
            paymentForm.style.display = 'block';
            
            // Load Stripe
            if (!window.stripe) {
                const stripeScript = document.createElement('script');
                stripeScript.src = 'https://js.stripe.com/v3/';
                await new Promise((resolve) => {
                    stripeScript.onload = resolve;
                    document.head.appendChild(stripeScript);
                });
            }
            
            // Get Stripe public key
            const keyResponse = await fetch('/api/stripe-public-key');
            const { publicKey } = await keyResponse.json();
            
            if (!publicKey) {
                showMessage('Stripe is not configured. Please contact support.', 'error');
                return;
            }
            
            // Initialize Stripe payment
            const stripe = Stripe(publicKey);
            const elements = stripe.elements();
            const cardElement = elements.create('card');
            cardElement.mount('#card-element');
            
            document.getElementById('submitPayment').onclick = async () => {
                try {
                    showMessage('Processing subscription...', 'info');
                    
                    // Create subscription checkout session
                    const response = await fetch('/api/create-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ plan })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to create subscription');
                    }
                    
                    const { checkoutUrl } = await response.json();
                    
                    // Redirect to Stripe Checkout
                    window.location.href = checkoutUrl;
                } catch (err) {
                    showMessage('Subscription failed: ' + err.message, 'error');
                }
            };
        }
        
        // Check subscription status on load
        async function checkSubscriptionStatus() {
            try {
                const response = await fetch('/api/subscription-status');
                const data = await response.json();
                
                if (!data.hasSubscription) {
                    // User needs subscription
                    console.log('No active subscription found');
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
        }

        // Subscription check handled in main DOM ready event

        // Firebase logout function
        async function firebaseLogout() {
            try {
                console.log('Starting logout process...');
                
                // Set flags to prevent automatic re-authentication
                sessionStorage.setItem('loggingOut', 'true');
                localStorage.setItem('manualLogout', 'true');
                
                // First, clear server session
                try {
                    const logoutResponse = await fetch('/api/auth/logout', { 
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('Server logout response:', logoutResponse.status);
                } catch (err) {
                    console.error('Server logout error:', err);
                }
                
                // Then clear Firebase auth using existing Firebase instance
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        await firebase.auth().signOut();
                        console.log('Firebase logout successful');
                    }
                } catch (err) {
                    console.error('Firebase signout error:', err);
                }
                
                // Clear any local storage and session storage
                localStorage.clear();
                sessionStorage.clear();
                
                // Keep logout flags after clearing
                sessionStorage.setItem('loggingOut', 'true');
                localStorage.setItem('manualLogout', 'true');
                
                // Clear any local user data
                if (typeof currentUser !== 'undefined') {
                    currentUser = null;
                }
                
                // Force redirect to auth page with replace to prevent back button issues
                console.log('Redirecting to auth page...');
                window.location.replace('/auth.html');
                
            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect even on error
                localStorage.clear();
                sessionStorage.clear();
                localStorage.setItem('manualLogout', 'true');
                window.location.replace('/auth.html');
            }
        }



    </script>

        <!-- Golden Hour Times Tab Content -->
        <div id="goldenHourTab" class="tab-content">
            <div class="content-header">
                <h1>üåÖ Golden Hour Times</h1>
                <p>Find perfect lighting times for your photography sessions</p>
            </div>
            
            <div class="golden-hour-container">
                <div class="location-selector">
                    <h3>üìç Location</h3>
                    <div class="input-group">
                        <input type="text" id="locationInput" placeholder="Enter location (e.g., Myrtle Beach, SC)" list="popularLocations" onkeypress="handleLocationEnter(event)" style="width: 60%; padding: 12px; border: 2px solid var(--gold-muted); 
                               border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); 
                               font-family: var(--font-body);">
                        <datalist id="popularLocations">
                            <option value="Myrtle Beach, SC">
                            </option><option value="Charleston, SC">
                            </option><option value="Savannah, GA">
                            </option><option value="Wilmington, NC">
                            </option><option value="Virginia Beach, VA">
                            </option><option value="Ocean City, MD">
                            </option><option value="Outer Banks, NC">
                            </option><option value="Hilton Head, SC">
                            </option><option value="Kiawah Island, SC">
                            </option><option value="Tybee Island, GA">
                        </option></datalist>
                        <button onclick="selectLocation()" style="padding: 12px 16px; background: var(--cream-warm); 
                                color: var(--text-primary); border: 2px solid var(--gold-muted); 
                                border-radius: var(--border-radius); margin-left: 8px; cursor: pointer; 
                                font-weight: 600;">üìç Enter</button>
                        <button id="getCurrentLocation" onclick="getCurrentLocation()" style="padding: 12px 20px; 
                                background: var(--gold-muted); color: var(--bg-primary); border: none; 
                                border-radius: var(--border-radius); margin-left: 8px; cursor: pointer; 
                                font-weight: 600;">üìç Use My Location</button>
                    </div>
                </div>
                
                <div class="date-selector">
                    <h3>üìÖ Date</h3>
                    <input type="date" id="dateInput" style="padding: 12px; border: 2px solid var(--gold-muted); 
                           border-radius: var(--border-radius); background: var(--bg-primary); color: var(--text-primary); 
                           font-family: var(--font-body); font-size: 16px;">
                </div>
                
                <button onclick="calculateGoldenHour()" id="calculateBtn" class="golden-hour-btn">
                    ‚ú® Get Times
                </button>
                
                <div id="goldenHourResults" class="golden-hour-results" style="display: none;">
                    <div class="results-grid">
                        <div class="time-card sunrise-card">
                            <div class="time-icon">üåÖ</div>
                            <h4>Sunrise</h4>
                            <div class="time-display" id="sunriseTime">--:--</div>
                            <div class="golden-hour-period">
                                <span>Golden Hour</span>
                                <div id="morningGoldenHour">--:-- to --:--</div>
                            </div>
                        </div>
                        
                        <div class="time-card sunset-card">
                            <div class="time-icon">üåá</div>
                            <h4>Sunset</h4>
                            <div class="time-display" id="sunsetTime">--:--</div>
                            <div class="golden-hour-period">
                                <span>Golden Hour</span>
                                <div id="eveningGoldenHour">--:-- to --:--</div>
                            </div>
                        </div>
                        
                        <div class="time-card blue-hour-card">
                            <div class="time-icon">üåå</div>
                            <h4>Blue Hour</h4>
                            <div class="time-display">Perfect for dramatic shots</div>
                            <div class="golden-hour-period">
                                <span>Morning</span>
                                <div id="morningBlueHour">--:-- to --:--</div>
                            </div>
                            <div class="golden-hour-period">
                                <span>Evening</span>
                                <div id="eveningBlueHour">--:-- to --:--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-info" id="locationInfo">
                        <h4>üìç Location Details</h4>
                        <div id="locationDetails">--</div>
                    </div>
                    
                    <div class="photography-tips">
                        <h4>üì∏ Photography Tips</h4>
                        <div class="tips-grid">
                            <div class="tip-card">
                                <strong>üåÖ Golden Hour</strong>
                                <p>Soft, warm light perfect for portraits and landscapes. Best for: couple sessions, family photos, romantic portraits.</p>
                            </div>
                            <div class="tip-card">
                                <strong>üåå Blue Hour</strong>
                                <p>Deep blue sky creates dramatic contrast. Best for: architectural photos, cityscapes, creative portraits with artificial lighting.</p>
                            </div>
                            <div class="tip-card">
                                <strong>‚è∞ Planning Tip</strong>
                                <p>Arrive 30 minutes before golden hour starts to set up and catch the light transition.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingSpinner" class="loading-message" style="display: none;">
                    üåÖ Calculating lighting times...
                </div>
                
                <div id="errorMessage" class="error-message" style="display: none;">
                    ‚ùå Could not calculate times. Please check your location and try again.
                </div>
            </div>
        </div>

        <!-- Business Management Tab Content -->
        <div id="businessManagementTab" class="tab-content">
            <div class="content-header">
                <h1>üíº Business Management</h1>
                <p>Comprehensive business analytics, AI assistance, and financial tracking</p>
            </div>
            
            <!-- Business Management Navigation -->
            <div class="business-nav">
                <button class="business-nav-btn active" onclick="showBusinessSection('dashboard')">üìä Dashboard</button>
                <button class="business-nav-btn" onclick="showBusinessSection('aiAssistant')">ü§ñ AI Assistant</button>
                <button class="business-nav-btn" onclick="showBusinessSection('expenses')">üí∞ Expense Tracker</button>
                <button class="business-nav-btn" onclick="showBusinessSection('mileage')">üöó Mileage Tracker</button>
                <button class="business-nav-btn" onclick="showBusinessSection('reports')">üìã Reports</button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="business-section active">
                <div class="dashboard-header">
                    <h2>üìä Business Dashboard</h2>
                    <div class="dashboard-controls">
                        <div class="date-range-selector">
                            <select id="dashboardDateRange" onchange="updateDashboard()">
                                <option value="today">Today</option>
                                <option value="thisWeek">This Week</option>
                                <option value="thisMonth" selected="">This Month</option>
                                <option value="thisYear">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="customDateRange" style="display: none;">
                                <input type="date" id="startDate">
                                <input type="date" id="endDate">
                                <button onclick="applyCustomDateRange()">Apply</button>
                            </div>
                        </div>
                        <div class="dashboard-export-buttons">
                            <button onclick="exportDashboardCSV()" class="export-btn">üìä Export CSV</button>
                            <button onclick="exportDashboardPDF()" class="export-btn">üìÑ Export PDF</button>
                        </div>
                    </div>
                </div>
                
                <div class="financial-overview">
                    <div class="financial-card earnings">
                        <div class="card-icon">üíµ</div>
                        <div class="card-content">
                            <h3>Total Earnings</h3>
                            <div class="amount" id="totalEarnings">$485.00</div>
                            <div class="period" id="earningsPeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card expenses">
                        <div class="card-icon">üí∏</div>
                        <div class="card-content">
                            <h3>Total Expenses</h3>
                            <div class="amount" id="totalExpenses">$800.00</div>
                            <div class="period" id="expensesPeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card mileage">
                        <div class="card-icon">üöó</div>
                        <div class="card-content">
                            <h3>Mileage Deduction</h3>
                            <div class="amount" id="totalMileage">$0.00</div>
                            <div class="period" id="mileagePeriod">This Month</div>
                        </div>
                    </div>
                    
                    <div class="financial-card profit">
                        <div class="card-icon">üìà</div>
                        <div class="card-content">
                            <h3>Net Profit</h3>
                            <div class="amount" id="netProfit" style="color: rgb(220, 53, 69);">$-315.00</div>
                            <div class="period" id="profitPeriod">This Month</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart sections removed as requested -->
            </div>

            <!-- AI Assistant Section -->
            <div id="aiAssistantSection" class="business-section">
                <div class="ai-header">
                    <h2>ü§ñ AI Assistant</h2>
                    <p>Generate content for your photography business</p>
                </div>
                
                <div class="ai-tabs">
                    <button class="ai-tab-btn active" onclick="showAITab('blogWriter')">üìù Blog Writer</button>
                    <button class="ai-tab-btn" onclick="showAITab('socialMedia')">üì± Social Media</button>
                    <button class="ai-tab-btn" onclick="showAITab('quickIdeas')">üí° Quick Ideas</button>
                    <button class="ai-tab-btn" onclick="showAITab('history')">üìö History</button>
                </div>
                
                <!-- Blog Writer Tab -->
                <div id="blogWriterTab" class="ai-tab-content active">
                    <h3>üìù Blog Post Generator</h3>
                    <div class="ai-input-section">
                        <label for="blogPrompt">Blog Topic/Prompt:</label>
                        <textarea id="blogPrompt" placeholder="Enter your blog topic or prompt (e.g., 'Tips for outdoor family photography sessions')" rows="3"></textarea>
                        <button onclick="generateBlogPost()" class="ai-generate-btn">Generate Blog Post</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Content:</label>
                        <div id="blogOutput" class="rich-text-editor" contenteditable="true" placeholder="Generated blog post will appear here..."></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('blogOutput')">üìã Copy</button>
                            <button onclick="clearOutput('blogOutput')">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Social Media Tab -->
                <div id="socialMediaTab" class="ai-tab-content">
                    <h3>üì± Social Media Post Builder</h3>
                    <div class="ai-input-section">
                        <div class="social-platform">
                            <label for="socialPlatform">Platform:</label>
                            <select id="socialPlatform">
                                <option value="instagram">Instagram</option>
                                <option value="facebook">Facebook</option>
                                <option value="twitter">Twitter</option>
                                <option value="tiktok">TikTok</option>
                            </select>
                        </div>
                        <label for="socialPrompt">Topic/Prompt:</label>
                        <textarea id="socialPrompt" placeholder="Enter your post topic (e.g., 'Promoting spring mini sessions')" rows="2"></textarea>
                        <div class="social-options">
                            <label>
                                <input type="checkbox" id="includeHashtags" checked="">
                                Include Hashtags
                            </label>
                        </div>
                        <button onclick="generateSocialPost()" class="ai-generate-btn">Generate Post</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Post:</label>
                        <div id="socialOutput" class="social-output" placeholder="Generated social media post will appear here..."></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('socialOutput')">üìã Copy</button>
                            <button onclick="clearOutput('socialOutput')">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Ideas Tab -->
                <div id="quickIdeasTab" class="ai-tab-content">
                    <h3>üí° Quick Ideas Generator</h3>
                    <div class="ai-input-section">
                        <label for="ideaPrompt">What do you need ideas for?</label>
                        <input type="text" id="ideaPrompt" placeholder="e.g., 'Christmas photo session promotions'">
                        <button onclick="generateQuickIdeas()" class="ai-generate-btn">Generate Ideas</button>
                    </div>
                    <div class="ai-output-section">
                        <label>Generated Ideas:</label>
                        <div id="ideasOutput" class="ideas-list"></div>
                        <div class="output-actions">
                            <button onclick="copyToClipboard('ideasOutput')">üìã Copy All</button>
                            <button onclick="clearOutput('ideasOutput')">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="historyTab" class="ai-tab-content">
                    <h3>üìö AI Prompt History</h3>
                    <div id="aiHistoryList" class="history-list"></div>
                </div>
            </div>

            <!-- Expense Tracker Section -->
            <div id="expensesSection" class="business-section">
                <div class="expenses-header">
                    <h2>üí∞ Expense Tracker</h2>
                    <button onclick="showAddExpenseForm()" class="add-btn">+ New Expense</button>
                </div>
                
                <div id="addExpenseForm" class="expense-form" style="display: none;">
                    <h3>Add New Expense</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">Date:</label>
                            <input type="date" id="expenseDate">
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Category:</label>
                            <select id="expenseCategory">
                                <option value="software">Software</option>
                                <option value="equipment">Equipment</option>
                                <option value="travel">Travel</option>
                                <option value="marketing">Marketing</option>
                                <option value="misc">Miscellaneous</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Amount ($):</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="expenseDescription">Description:</label>
                            <input type="text" id="expenseDescription" placeholder="Brief description of the expense">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="expenseRecurring">
                                Recurring Monthly Expense
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveExpense()" class="save-btn">Save Expense</button>
                        <button onclick="cancelExpenseForm()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
                
                <div class="expenses-table-container">
                    <div class="table-actions">
                        <button onclick="exportExpensesToCSV()" class="export-btn">üìä Export to CSV</button>
                    </div>
                    <table id="expensesTable" class="business-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Recurring</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Expenses will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mileage Tracker Section -->
            <div id="mileageSection" class="business-section">
                <div class="mileage-header">
                    <h2>üöó Mileage Tracker</h2>
                    <div class="mileage-header-actions">
                        <button onclick="showHomeBaseSetup()" class="setup-btn">üè† Setup Home Base</button>
                        <button onclick="showAddTripForm()" class="add-btn">+ Add Trip</button>
                    </div>
                </div>
                
                <!-- Home Base Setup Section -->
                <div id="homeBaseSetup" class="home-base-setup" style="display: none;">
                    <div class="setup-card">
                        <h3>üè† Set Your Home Base Location</h3>
                        <p>Configure your default start location to save time when adding trips.</p>
                        
                        <div class="location-setup">
                            <div class="form-group">
                                <label for="homeAddress">Home/Office Address:</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="homeAddress" placeholder="Enter your business address" value="" autocomplete="off">
                                    <div id="homeAddressSuggestions" class="address-suggestions" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="location-actions">
                                <button onclick="useCurrentLocation()" class="location-btn">üìç Use Current Location</button>
                                <button onclick="saveHomeBase()" class="save-btn">üíæ Save Home Base</button>
                                <button onclick="cancelHomeBaseSetup()" class="cancel-btn">Cancel</button>
                            </div>
                        </div>
                        
                        <div class="current-home-base" id="currentHomeBase" style="display: none;">
                            <div class="status-card">
                                <h4>‚úÖ Current Home Base:</h4>
                                <p id="homeBaseAddress">Not set</p>
                                <button onclick="editHomeBase()" class="edit-btn">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="addTripForm" class="trip-form" style="display: none;">
                    <h3>Add New Trip</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tripDate">Date:</label>
                            <input type="date" id="tripDate">
                        </div>
                        <div class="form-group">
                            <label for="tripPurpose">Purpose:</label>
                            <select id="tripPurpose">
                                <option value="client_work">Client Work</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startLocation">Start Location:</label>
                            <div class="location-input-group">
                                <div class="autocomplete-container">
                                    <input type="text" id="startLocation" placeholder="Starting address" autocomplete="off">
                                    <div id="startLocationSuggestions" class="address-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" onclick="useHomeBaseForTrip()" class="home-base-btn" id="useHomeBaseBtn" disabled="">üè† Use Home Base</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="endLocation">End Location:</label>
                            <div class="autocomplete-container">
                                <input type="text" id="endLocation" placeholder="Destination address" autocomplete="off">
                                <div id="endLocationSuggestions" class="address-suggestions" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="milesDriven">Miles Driven:</label>
                            <input type="number" id="milesDriven" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="roundTrip" onchange="updateCalculateButton()">
                                Round Trip (Start ‚Üí End ‚Üí Start)
                            </label>
                            <button onclick="calculateMiles()" class="calculate-btn" id="calculateBtn">üó∫Ô∏è Calculate Miles</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button onclick="saveTrip()" class="save-btn">Save Trip</button>
                        <button onclick="cancelTripForm()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
                
                <div class="mileage-table-container">
                    <table id="mileageTable" class="business-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Start Location</th>
                                <th>End Location</th>
                                <th>Miles</th>
                                <th>Type</th>
                                <th>Purpose</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mileageTableBody">
                            <!-- Trips will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="business-section">
                <div class="reports-header">
                    <h2>üìã Business Reports</h2>
                    <div class="report-date-range">
                        <label>Report Period:</label>
                        <input type="date" id="reportStartDate">
                        <span>to</span>
                        <input type="date" id="reportEndDate">
                        <button onclick="generateReport()" class="generate-btn">Generate Report</button>
                    </div>
                </div>
                
                <div id="reportContent" class="report-content">
                    <div class="report-summary">
                        <h3>üìä Financial Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <label>Total Earnings:</label>
                                <span id="reportEarnings">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Total Expenses:</label>
                                <span id="reportExpenses">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Total Miles:</label>
                                <span id="reportMiles">0</span>
                            </div>
                            <div class="summary-item">
                                <label>Mileage Deduction:</label>
                                <span id="reportMileageDeduction">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <label>Net Profit:</label>
                                <span id="reportNetProfit">$0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Breakdown Section -->
                    <div id="reportBreakdown" class="report-breakdown">
                        <!-- Breakdown content will be populated by JavaScript -->
                    </div>
                    
                    <div class="report-actions">
                        <button onclick="exportReportCSV()" class="export-btn">üìä Export CSV</button>
                        <button onclick="exportReportPDF()" class="export-btn">üìÑ Export PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Website Builder Tab -->
        <div id="websiteBuilderTab" class="tab-content active">
            <div id="website-builder-container">
                <!-- Website Builder will be dynamically loaded here -->
            </div>
        </div>

        <!-- Payment Settings Tab Content -->
        <div id="paymentSettingsTab" class="tab-content">
            <div class="content-header">
                <h1>üí≥ Payment Settings</h1>
                <p>Connect your Stripe account to receive payments directly from clients</p>
            </div>

            <div class="payment-settings-container">
                <!-- Stripe Connect Status Card -->
                <div class="setting-card" id="stripe-status-card">
                    <div class="card-header">
                        <h3>üîó Stripe Connect</h3>
                        <div class="status-indicator" id="stripe-status-indicator">
                            <span class="status-dot checking"></span>
                            <span class="status-text" id="stripe-status-text">Checking connection...</span>
                        </div>
                    </div>
                    
                    <div class="card-content" id="stripe-card-content">
                        <div class="loading-state" id="stripe-loading">
                            <div class="spinner"></div>
                            <p>Checking your Stripe connection...</p>
                        </div>
                        
                        <!-- Not Connected State -->
                        <div class="connection-state" id="not-connected-state" style="display: none;">
                            <div class="info-section">
                                <h4>üí∞ Why Connect Stripe?</h4>
                                <ul class="benefits-list">
                                    <li>Receive payments directly to your bank account</li>
                                    <li>Process credit cards, debit cards, and digital wallets</li>
                                    <li>Automatic invoice generation and receipts</li>
                                    <li>Real-time payment notifications</li>
                                    <li>Industry-standard security and PCI compliance</li>
                                </ul>
                            </div>
                            
                            <div class="action-section">
                                <button id="connect-stripe-btn" class="btn btn-primary">
                                    üöÄ Connect Stripe Account
                                </button>
                                <p class="note">You'll be redirected to Stripe to set up your account. This is completely free and takes just a few minutes.</p>
                            </div>
                        </div>
                        
                        <!-- Connected State -->
                        <div class="connection-state" id="connected-state" style="display: none;">
                            <div class="success-message">
                                <div class="success-icon">‚úÖ</div>
                                <h4>Account Connected Successfully!</h4>
                                <p>Your Stripe account is connected and ready to receive payments.</p>
                            </div>
                            
                            <div class="account-details" id="account-details">
                                <div class="detail-row">
                                    <span class="label">Account Status:</span>
                                    <span class="value" id="account-status">Active</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">Payments Enabled:</span>
                                    <span class="value" id="payments-enabled">Yes</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">Payouts Enabled:</span>
                                    <span class="value" id="payouts-enabled">Yes</span>
                                </div>
                            </div>
                            
                            <div class="action-section">
                                <button id="refresh-status-btn" class="btn btn-secondary">
                                    üîÑ Refresh Status
                                </button>
                                <button id="manage-account-btn" class="btn btn-outline">
                                    ‚öôÔ∏è Manage Stripe Account
                                </button>
                            </div>
                        </div>
                        
                        <!-- Incomplete State -->
                        <div class="connection-state" id="incomplete-state" style="display: none;">
                            <div class="warning-message">
                                <div class="warning-icon">‚ö†Ô∏è</div>
                                <h4>Setup Incomplete</h4>
                                <p>Your Stripe account needs additional information before you can receive payments.</p>
                            </div>
                            
                            <div class="action-section">
                                <button id="complete-setup-btn" class="btn btn-warning">
                                    üìã Complete Setup
                                </button>
                                <p class="note">Complete your Stripe account setup to start receiving payments.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Processing Info -->
                <div class="setting-card">
                    <div class="card-header">
                        <h3>üí± Payment Processing</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <h4>Processing Fees</h4>
                                <p>Stripe charges 2.9% + 30¬¢ per successful payment</p>
                            </div>
                            <div class="info-item">
                                <h4>Platform Fees</h4>
                                <p>No additional fees - you keep 100% minus Stripe's processing fee</p>
                            </div>
                            <div class="info-item">
                                <h4>Payout Schedule</h4>
                                <p>Daily automatic transfers to your connected bank account</p>
                            </div>
                            <div class="info-item">
                                <h4>Supported Payment Methods</h4>
                                <p>Credit cards, debit cards, Apple Pay, Google Pay, and more</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Payment Section -->
                <div class="setting-card" id="test-payment-card" style="display: none;">
                    <div class="card-header">
                        <h3>üß™ Test Payment</h3>
                    </div>
                    <div class="card-content">
                        <p>Test your payment setup with a small transaction to ensure everything works correctly.</p>
                        <button id="test-payment-btn" class="btn btn-outline">
                            üß™ Create Test Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        </div>