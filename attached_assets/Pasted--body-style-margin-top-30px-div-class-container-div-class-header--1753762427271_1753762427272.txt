<body style="margin-top: 30px;">
    <div class="container">
        <div class="header">
            <div>
                <h1>Photography Management System</h1>
                <p>Complete business management platform for professional photographers</p>
            </div>
            <div id="userInfo" class="user-info" style="display: none;">
                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                <span id="userName"></span>
                <button onclick="firebaseLogout()" class="logout-btn">Sign Out</button>
            </div>
        </div>

        <!-- ğŸ”½ DROPDOWN MENU START -->
        <div class="tools-dropdown">
            <button id="toolsToggle">ğŸ“‚ Tools Menu â–¼</button>
            <div id="toolsMenu" class="hidden">
                <a href="#" onclick="switchTab('clients')">ğŸ‘¥ Client Management</a>
                <a href="#" onclick="switchTab('sunrise')">ğŸŒ… Sunrise/Sunset Calendar</a>
                <a href="#" onclick="switchTab('websites')" class="active">ğŸŒ Website Builder</a>
                <span style="color: #D4AF37; font-weight: bold;">ğŸ‘‘ Advanced Builder - Integrated Below</span>
                <a href="/onboarding" target="_blank">ğŸš€ Business Setup Wizard</a>
            </div>
        </div>
        <!-- ğŸ”½ DROPDOWN MENU END -->

        <!-- Client Management Tab Content -->
        <div id="clientsTab" class="tab-content">
        
        <!-- ğŸ” ENHANCED CLIENT DASHBOARD CONTROLS -->
        <div class="client-dashboard-controls">
            <div class="search-and-filters">
                <!-- Real-time Search Bar -->
                <div class="search-section">
                    <input type="text" id="clientSearch" placeholder="ğŸ” Search clients by name, location, or email..." oninput="filterSessions()" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: #2a2a2a; color: #f5f5f5; font-size: 16px;">
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Status Filters:</label>
                            <div class="checkbox-filters">
                                <label><input type="checkbox" id="filterContractSigned" onchange="filterSessions()"> Contract Signed</label>
                                <label><input type="checkbox" id="filterPaid" onchange="filterSessions()"> Paid</label>
                                <label><input type="checkbox" id="filterDelivered" onchange="filterSessions()"> Delivered</label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label for="sessionTypeFilter">Session Type:</label>
                            <select id="sessionTypeFilter" onchange="filterSessions()">
                                <option value="">All Types</option>
                                <option value="Wedding">Wedding</option>
                                <option value="Family">Family</option>
                                <option value="Senior">Senior</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Event">Event</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <input type="date" id="dateFromFilter" onchange="filterSessions()" placeholder="From">
                            <span>to</span>
                            <input type="date" id="dateToFilter" onchange="filterSessions()" placeholder="To">
                        </div>
                        
                        <div class="filter-group">
                            <label for="sortOptions">Sort By:</label>
                            <select id="sortOptions" onchange="sortSessions()">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="name-asc">Client Name (A-Z)</option>
                                <option value="name-desc">Client Name (Z-A)</option>
                                <option value="unpaid-first">Unpaid First</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Archive Toggle & Actions -->
                <div class="archive-and-actions">
                    <label class="archive-toggle">
                        <input type="checkbox" id="showArchivedToggle" onchange="toggleArchivedSessions()">
                        Show Archived Sessions
                    </label>
                    <button onclick="clearAllFilters()" class="btn-secondary">Clear Filters</button>
                    <button onclick="exportAllSessions()" class="btn-primary">ğŸ“„ Export All Sessions</button>
                </div>
            </div>
        </div>
        
        <!-- Session Form -->
        <div class="session-form">
            <h2>Add New Session</h2>
            <form id="sessionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required="" placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <input type="text" id="sessionType" name="sessionType" required="" placeholder="Wedding, Portrait, etc.">
                    </div>
                    <div class="form-group">
                        <label for="dateTime">Date &amp; Time</label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required="" style="cursor: pointer;">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" required="" placeholder="Session location">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required="" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required="" placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" step="0.01" required="" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (minutes)</label>
                        <input type="number" id="duration" name="duration" required="" placeholder="60">
                    </div>
                </div>
                
                <!-- Admin Workflow Checkboxes -->
                <div class="admin-checkboxes">
                    <h3>Admin Workflow Status</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contractSigned" name="contractSigned">
                            <label for="contractSigned">Contract Signed</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="paid" name="paid">
                            <label for="paid">Paid</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edited" name="edited">
                            <label for="edited">Edited</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="delivered" name="delivered">
                            <label for="delivered">Delivered</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sendReminder" name="sendReminder">
                            <label for="sendReminder">Send session reminder 24 hours before</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyGalleryReady" name="notifyGalleryReady">
                            <label for="notifyGalleryReady">Notify when gallery is ready</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Add Session</button>

            </form>
        </div>

        <!-- Sessions Display -->
        <div id="sessionsContainer" class="sessions-grid">
                <div class="session-list-item" data-session-id="7235f163-baa5-460f-ba2f-8fdc93404e11" onclick="toggleSessionDetails('7235f163-baa5-460f-ba2f-8fdc93404e11')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">amanda Casselman</h3>
                            <div class="session-meta">
                                <span class="session-date">ğŸ“… Wed, Jul 30, 2025, 07:38 AM</span>
                                <span class="session-location">ğŸ“ Springmaid Pier</span>
                                <span class="session-price">ğŸ’° $6</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-7235f163-baa5-460f-ba2f-8fdc93404e11">â–¼</div>
                    </div>
                    
                    <div class="session-details" id="details-7235f163-baa5-460f-ba2f-8fdc93404e11" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>ğŸ“ Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:amandacasselman55@yahoo.com" style="color: #d4af37;">amandacasselman55@yahoo.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">8434851315</span>
                                    <button onclick="callClient('8434851315'); event.stopPropagation();" class="quick-action-btn call-btn">ğŸ“</button>
                                    <button onclick="textClient('8434851315', 'amanda Casselman', '7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="quick-action-btn text-btn">ğŸ’¬</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“… Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Wed, Jul 30, 2025, 07:38 AM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> family
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 30 hours
                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>ğŸ“‹ Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_7235f163-baa5-460f-ba2f-8fdc93404e11" checked="" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_7235f163-baa5-460f-ba2f-8fdc93404e11">ğŸ“ Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_7235f163-baa5-460f-ba2f-8fdc93404e11" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_7235f163-baa5-460f-ba2f-8fdc93404e11">ğŸ’° Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_7235f163-baa5-460f-ba2f-8fdc93404e11" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_7235f163-baa5-460f-ba2f-8fdc93404e11">âœï¸ Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_7235f163-baa5-460f-ba2f-8fdc93404e11" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_7235f163-baa5-460f-ba2f-8fdc93404e11">ğŸ“¦ Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_7235f163-baa5-460f-ba2f-8fdc93404e11" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_7235f163-baa5-460f-ba2f-8fdc93404e11">â° Send Reminder</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="notifyGalleryReady_7235f163-baa5-460f-ba2f-8fdc93404e11" onchange="toggleWorkflowStatus('7235f163-baa5-460f-ba2f-8fdc93404e11', 'notifyGalleryReady', this.checked); event.stopPropagation();">
                                    <label for="notifyGalleryReady_7235f163-baa5-460f-ba2f-8fdc93404e11">ğŸ–¼ï¸ Notify Gallery Ready</label>
                                </div>
                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="editSession('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn edit-btn">âœï¸ Edit</button>
                                <button onclick="openUploadModal('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn upload-btn">ğŸ“¸ Upload</button>
                                <button onclick="viewSessionGallery('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn gallery-btn">ğŸ–¼ï¸ Gallery</button>
                                <button onclick="copyGalleryUrl('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn copy-btn">ğŸ”— Copy URL</button>
                                <button onclick="addToCalendar('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn calendar-btn">ğŸ“… Calendar</button>
                                <button onclick="openEmailClient('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn email-btn">ğŸ“§ Email</button>
                                <button onclick="openContractModal('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn contract-btn">ğŸ“ Contract</button>
                                
                                    <button onclick="sendInvoice('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn invoice-btn">ğŸ’³ Invoice</button>
                                    <button onclick="sendDepositInvoice('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn deposit-btn">ğŸ’° Deposit</button>
                                    <button onclick="openPaymentPlanModal('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn plan-btn">ğŸ“Š Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="export-btn">ğŸ“„ Export PDF</button>
                                <button onclick="toggleArchiveSession('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="archive-btn">ğŸ“ Archive</button>
                                <button onclick="deleteSession('7235f163-baa5-460f-ba2f-8fdc93404e11'); event.stopPropagation();" class="action-btn delete-btn">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>ğŸ“ Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('7235f163-baa5-460f-ba2f-8fdc93404e11', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
            
                <div class="session-list-item" data-session-id="7c45c201-548d-4507-ae88-d3c2e299e0b1" onclick="toggleSessionDetails('7c45c201-548d-4507-ae88-d3c2e299e0b1')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">lance</h3>
                            <div class="session-meta">
                                <span class="session-date">ğŸ“… Thu, Jul 31, 2025, 05:26 PM</span>
                                <span class="session-location">ğŸ“ Springmaid Pier</span>
                                <span class="session-price">ğŸ’° $6</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-7c45c201-548d-4507-ae88-d3c2e299e0b1">â–¼</div>
                    </div>
                    
                    <div class="session-details" id="details-7c45c201-548d-4507-ae88-d3c2e299e0b1" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>ğŸ“ Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:lancecasselman@icloud.com" style="color: #d4af37;">lancecasselman@icloud.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">8434851315</span>
                                    <button onclick="callClient('8434851315'); event.stopPropagation();" class="quick-action-btn call-btn">ğŸ“</button>
                                    <button onclick="textClient('8434851315', 'lance', '7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="quick-action-btn text-btn">ğŸ’¬</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“… Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Thu, Jul 31, 2025, 05:26 PM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> engagement
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 30 hours
                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>ğŸ“‹ Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_7c45c201-548d-4507-ae88-d3c2e299e0b1">ğŸ“ Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_7c45c201-548d-4507-ae88-d3c2e299e0b1">ğŸ’° Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_7c45c201-548d-4507-ae88-d3c2e299e0b1">âœï¸ Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_7c45c201-548d-4507-ae88-d3c2e299e0b1">ğŸ“¦ Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_7c45c201-548d-4507-ae88-d3c2e299e0b1">â° Send Reminder</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="notifyGalleryReady_7c45c201-548d-4507-ae88-d3c2e299e0b1" onchange="toggleWorkflowStatus('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'notifyGalleryReady', this.checked); event.stopPropagation();">
                                    <label for="notifyGalleryReady_7c45c201-548d-4507-ae88-d3c2e299e0b1">ğŸ–¼ï¸ Notify Gallery Ready</label>
                                </div>
                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="editSession('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn edit-btn">âœï¸ Edit</button>
                                <button onclick="openUploadModal('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn upload-btn">ğŸ“¸ Upload (1)</button>
                                <button onclick="viewSessionGallery('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn gallery-btn">ğŸ–¼ï¸ Gallery</button>
                                <button onclick="copyGalleryUrl('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn copy-btn">ğŸ”— Copy URL</button>
                                <button onclick="addToCalendar('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn calendar-btn">ğŸ“… Calendar</button>
                                <button onclick="openEmailClient('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn email-btn">ğŸ“§ Email</button>
                                <button onclick="openContractModal('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn contract-btn">ğŸ“ Contract</button>
                                
                                    <button onclick="sendInvoice('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn invoice-btn">ğŸ’³ Invoice</button>
                                    <button onclick="sendDepositInvoice('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn deposit-btn">ğŸ’° Deposit</button>
                                    <button onclick="openPaymentPlanModal('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn plan-btn">ğŸ“Š Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="export-btn">ğŸ“„ Export PDF</button>
                                <button onclick="toggleArchiveSession('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="archive-btn">ğŸ“ Archive</button>
                                <button onclick="deleteSession('7c45c201-548d-4507-ae88-d3c2e299e0b1'); event.stopPropagation();" class="action-btn delete-btn">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>ğŸ“ Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('7c45c201-548d-4507-ae88-d3c2e299e0b1', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
            
                <div class="session-list-item" data-session-id="9e62ec76-50e8-4022-8e79-f39434568f0e" onclick="toggleSessionDetails('9e62ec76-50e8-4022-8e79-f39434568f0e')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">lance</h3>
                            <div class="session-meta">
                                <span class="session-date">ğŸ“… Thu, Jul 31, 2025, 05:45 PM</span>
                                <span class="session-location">ğŸ“ Springmaid Pier</span>
                                <span class="session-price">ğŸ’° $6</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-9e62ec76-50e8-4022-8e79-f39434568f0e">â–¼</div>
                    </div>
                    
                    <div class="session-details" id="details-9e62ec76-50e8-4022-8e79-f39434568f0e" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>ğŸ“ Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:lancecasselman@icloud.com" style="color: #d4af37;">lancecasselman@icloud.com</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">8434851315</span>
                                    <button onclick="callClient('8434851315'); event.stopPropagation();" class="quick-action-btn call-btn">ğŸ“</button>
                                    <button onclick="textClient('8434851315', 'lance', '9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="quick-action-btn text-btn">ğŸ’¬</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“… Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date &amp; Time:</strong> Thu, Jul 31, 2025, 05:45 PM
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> engagement
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> 30 hours
                                </div>
                                
                                
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>ğŸ“‹ Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_9e62ec76-50e8-4022-8e79-f39434568f0e">ğŸ“ Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_9e62ec76-50e8-4022-8e79-f39434568f0e">ğŸ’° Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_9e62ec76-50e8-4022-8e79-f39434568f0e">âœï¸ Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_9e62ec76-50e8-4022-8e79-f39434568f0e">ğŸ“¦ Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_9e62ec76-50e8-4022-8e79-f39434568f0e">â° Send Reminder</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="notifyGalleryReady_9e62ec76-50e8-4022-8e79-f39434568f0e" onchange="toggleWorkflowStatus('9e62ec76-50e8-4022-8e79-f39434568f0e', 'notifyGalleryReady', this.checked); event.stopPropagation();">
                                    <label for="notifyGalleryReady_9e62ec76-50e8-4022-8e79-f39434568f0e">ğŸ–¼ï¸ Notify Gallery Ready</label>
                                </div>
                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="editSession('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn edit-btn">âœï¸ Edit</button>
                                <button onclick="openUploadModal('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn upload-btn">ğŸ“¸ Upload</button>
                                <button onclick="viewSessionGallery('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn gallery-btn">ğŸ–¼ï¸ Gallery</button>
                                <button onclick="copyGalleryUrl('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn copy-btn">ğŸ”— Copy URL</button>
                                <button onclick="addToCalendar('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn calendar-btn">ğŸ“… Calendar</button>
                                <button onclick="openEmailClient('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn email-btn">ğŸ“§ Email</button>
                                <button onclick="openContractModal('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn contract-btn">ğŸ“ Contract</button>
                                
                                    <button onclick="sendInvoice('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn invoice-btn">ğŸ’³ Invoice</button>
                                    <button onclick="sendDepositInvoice('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn deposit-btn">ğŸ’° Deposit</button>
                                    <button onclick="openPaymentPlanModal('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn plan-btn">ğŸ“Š Payment Plan</button>
                                
                                <button onclick="exportSessionPDF('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="export-btn">ğŸ“„ Export PDF</button>
                                <button onclick="toggleArchiveSession('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="archive-btn">ğŸ“ Archive</button>
                                <button onclick="deleteSession('9e62ec76-50e8-4022-8e79-f39434568f0e'); event.stopPropagation();" class="action-btn delete-btn">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>ğŸ“ Session Notes &amp; Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." onchange="updateSessionNotes('9e62ec76-50e8-4022-8e79-f39434568f0e', 'sessionNotes', this.value); event.stopPropagation();" onclick="event.stopPropagation();"></textarea>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        
                    </div>
                </div>
            </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-content">
            <h3>Upload Photos</h3>
            
            <div class="upload-limits-info">
                <h4>ğŸ“ˆ Enhanced Upload Capacity</h4>
                <ul>
                    <li><strong>Unlimited file size</strong> - Upload RAW photos, high-res images</li>
                    <li><strong>Unlimited quantity</strong> - Upload entire photo shoots at once</li>
                    <li><strong>Batch processing</strong> - Large uploads handled automatically</li>
                    <li><strong>Progress tracking</strong> - Monitor individual file uploads</li>
                </ul>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <p>Click here or drag photos to upload</p>
                <p style="font-size: 0.9em; color: #718096; margin-top: 10px;">Supports unlimited photos of any size - JPG, PNG, RAW files welcome!</p>
            </div>
            <input type="file" id="fileInput" multiple="" accept="image/*" style="display: none;">
            <div id="uploadProgress" style="margin: 20px 0;">
                <div id="filePreview" style="margin-bottom: 15px;"></div>
                
                <!-- Enhanced Upload Progress Bar with Percentage Display -->
                <div id="uploadProgressContainer" style="display: none; margin-top: 20px; padding: 20px; background: rgba(212, 175, 55, 0.1); border-radius: 12px; border: 2px solid #d4af37; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);">
                    <div style="margin-bottom: 15px; color: #d4af37; font-weight: bold; text-align: center; font-size: 16px;" id="progressText">Starting Upload...</div>
                    
                    <!-- Progress Bar with Percentage -->
                    <div style="background: #2d2d2d; border-radius: 12px; padding: 4px; margin-bottom: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);">
                        <div id="progressBar" style="
                            background: linear-gradient(135deg, #d4af37 0%, #ffd700 50%, #d4af37 100%); 
                            height: 32px; 
                            border-radius: 8px; 
                            width: 0%; 
                            transition: width 0.3s ease; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            color: #1a1a1a; 
                            font-weight: bold; 
                            font-size: 16px;
                            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
                            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
                        ">0%</div>
                    </div>
                    
                    <div id="progressDetails" style="color: #d4af37; font-size: 14px; text-align: center; margin-bottom: 5px;">Preparing files...</div>
                    <div style="color: #999; font-size: 12px; text-align: center;" id="progressSubDetails">Please wait while we process your upload</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="uploadBtn" onclick="startUpload()" style="display: none;">Upload Selected Photos</button>
                <button class="btn btn-secondary" onclick="closeUploadModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="upload-modal">
        <div class="upload-content" style="max-width: 1200px;">
            <h3 id="galleryTitle">ğŸ“· Session Gallery</h3>
            
            <div class="gallery-content" style="width: 100%; overflow: hidden; box-sizing: border-box;">
                <div id="galleryGrid" class="photo-gallery-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 100%; box-sizing: border-box;"></div>
                <div id="galleryEmpty" class="empty-gallery" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <h4>No Photos Yet</h4>
                    <p>Upload photos to this session to see them here.</p>
                </div>
            </div>
            
            <!-- Enhanced Gallery Tip Panel -->
            <div id="galleryTipPanel" style="display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeGalleryModal()">Close Gallery</button>
            </div>
        </div>
    </div>

    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3>Create Payment Plan</h3>
            
            <div class="payment-plan-form">
                <div class="payment-plan-grid">
                    <div class="form-group">
                        <label for="planTotalAmount">Total Amount ($)</label>
                        <input type="number" id="planTotalAmount" step="0.01" placeholder="0.00" required="">
                    </div>
                    <div class="form-group">
                        <label for="planStartDate">Start Date</label>
                        <input type="date" id="planStartDate" required="">
                    </div>
                    <div class="form-group">
                        <label for="planEndDate">End Date</label>
                        <input type="date" id="planEndDate" required="">
                    </div>
                    <div class="form-group">
                        <label for="planReminderDays">Reminder Days Before</label>
                        <select id="planReminderDays">
                            <option value="1">1 day</option>
                            <option value="3" selected="">3 days</option>
                            <option value="7">1 week</option>
                        </select>
                    </div>
                </div>
                
                <div class="payment-plan-summary" id="paymentPlanSummary" style="display: none;">
                    <h4>ğŸ“‹ Payment Plan Summary</h4>
                    <div id="paymentSummaryDetails"></div>
                    <div class="payment-schedule" id="paymentSchedulePreview"></div>
                </div>
                
                <div class="payment-plan-info">
                    <h4>â„¹ï¸ How Payment Plans Work</h4>
                    <ul>
                        <li>Automatically calculates equal monthly payments</li>
                        <li>Sends Stripe invoices each month via email</li>
                        <li>Tracks payments and sends reminders</li>
                        <li>Updates session status when fully paid</li>
                    </ul>
                </div>
                
                <div class="payment-actions">
                    <button class="btn btn-primary" id="createPaymentPlanBtn" onclick="createPaymentPlan()">Create Payment Plan</button>
                    <button class="btn btn-secondary" onclick="calculatePaymentPreview()">Preview Payments</button>
                    <button class="btn btn-secondary" onclick="closePaymentPlanModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Plan View Modal -->
    <div id="paymentPlanViewModal" class="payment-plan-modal">
        <div class="payment-plan-content">
            <h3 id="paymentPlanViewTitle">Payment Plan Details</h3>
            
            <div id="paymentPlanViewContent">
                <!-- Payment plan details will be loaded here -->
            </div>
            
            <div class="payment-actions">
                <button class="btn btn-primary" onclick="processAutomatedPayments()">Process All Due Payments</button>
                <button class="btn btn-secondary" onclick="closePaymentPlanViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let sessions = [];
        let currentUploadSessionId = null;
        let currentPaymentPlanSessionId = null;

        // Allow both past and future dates for historical session entries
        function setMinDateTime() {
            // Remove any date restrictions to allow past dates for historical entries
            const dateTimeInput = document.getElementById('dateTime');
            if (dateTimeInput) {
                dateTimeInput.removeAttribute('min');
                dateTimeInput.removeAttribute('max');
                
                // Ensure the datetime picker is clickable and functional
                dateTimeInput.style.cursor = 'pointer';
                
                // Remove showPicker() calls due to cross-origin security restrictions
                // The native datetime-local input will show picker automatically when clicked
                dateTimeInput.addEventListener('click', function() {
                    this.focus();
                });
                
                // Add manual focus trigger for better compatibility
                dateTimeInput.addEventListener('focus', function() {
                    // Let the browser handle the native datetime picker
                });
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            setupEventListeners();
            setMinDateTime(); // Allow all dates for historical entries
            initializeSunriseCalendar(); // Initialize sunrise calendar
            
            // Ensure contract modal is hidden on page load
            const contractModal = document.getElementById('contractModal');
            if (contractModal) {
                contractModal.style.display = 'none';
            }
        });

        function setupEventListeners() {
            document.getElementById('sessionForm').addEventListener('submit', addSession);
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Add form reset button functionality
            const resetBtn = document.querySelector('button[type="reset"]');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        setMinDateTime(); // Keep dates unrestricted for historical entries
                        editingSessionId = null;
                        const submitBtn = document.querySelector('button[type="submit"]');
                        if (submitBtn) submitBtn.textContent = 'Add Session';
                    }, 10);
                });
            }
        }

        async function addSession(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const sessionData = {
                clientName: formData.get('clientName'),
                sessionType: formData.get('sessionType'),
                dateTime: formData.get('dateTime'),
                location: formData.get('location'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                price: parseFloat(formData.get('price')),
                duration: parseInt(formData.get('duration')),
                contractSigned: formData.get('contractSigned') === 'on',
                paid: formData.get('paid') === 'on',
                edited: formData.get('edited') === 'on',
                delivered: formData.get('delivered') === 'on',
                sendReminder: formData.get('sendReminder') === 'on',
                notifyGalleryReady: formData.get('notifyGalleryReady') === 'on',
                photos: []
            };

            try {
                if (editingSessionId) {
                    // Update existing session
                    const response = await fetch(`/api/sessions/${editingSessionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const updatedSession = await response.json();
                        const sessionIndex = sessions.findIndex(s => s.id === editingSessionId);
                        if (sessionIndex !== -1) {
                            sessions[sessionIndex] = updatedSession;
                        }
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session updated successfully!', 'success');
                    } else {
                        showMessage('Failed to update session', 'error');
                    }
                } else {
                    // Create new session
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sessionData)
                    });
                    
                    if (response.ok) {
                        const newSession = await response.json();
                        sessions.unshift(newSession);
                        renderSessions();
                        resetForm(e.target);
                        showMessage('Session added successfully!', 'success');
                        
                        // Trigger milestone celebration for new session
                        celebrateMilestone('session_created', newSession.clientName);
                    } else {
                        showMessage('Failed to add session', 'error');
                    }
                }
            } catch (error) {
                console.error('Error processing session:', error);
                showMessage('Error processing session', 'error');
            }
        }

        function resetForm(form) {
            form.reset();
            editingSessionId = null;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Session';
            
            // Keep date unrestricted to allow historical entries
            setMinDateTime();
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Add your first photography session above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session-list-item" data-session-id="${session.id}" onclick="toggleSessionDetails('${session.id}')">
                    <div class="session-list-header">
                        <div class="session-info">
                            <h3 class="client-name">${session.clientName}</h3>
                            <div class="session-meta">
                                <span class="session-date">ğŸ“… ${formatDateTime(session.dateTime)}</span>
                                <span class="session-location">ğŸ“ ${session.location}</span>
                                <span class="session-price">ğŸ’° $${session.price}</span>
                            </div>
                        </div>
                        <div class="expand-icon" id="expand-${session.id}">â–¼</div>
                    </div>
                    
                    <div class="session-details" id="details-${session.id}" style="display: none;">
                        <div class="detail-grid">
                            <div class="detail-section">
                                <h4>ğŸ“ Contact Info</h4>
                                <div class="detail-item">
                                    <strong>Email:</strong> <a href="mailto:${session.email}" style="color: #d4af37;">${session.email}</a>
                                </div>
                                <div class="detail-item">
                                    <strong>Phone:</strong> <span style="color: #d4af37;">${session.phoneNumber}</span>
                                    <button onclick="callClient('${session.phoneNumber}'); event.stopPropagation();" class="quick-action-btn call-btn">ğŸ“</button>
                                    <button onclick="textClient('${session.phoneNumber}', '${session.clientName}', '${session.id}'); event.stopPropagation();" class="quick-action-btn text-btn">ğŸ’¬</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“… Session Details</h4>
                                <div class="detail-item">
                                    <strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> ${session.sessionType}
                                </div>
                                <div class="detail-item">
                                    <strong>Duration:</strong> ${session.duration} hours
                                </div>
                                ${session.notes ? `
                                    <div class="detail-item">
                                        <strong>Notes:</strong> ${session.notes}
                                    </div>
                                ` : ''}
                                ${session.hasPaymentPlan ? `
                                    <div class="detail-item">
                                        <strong>Payment Plan:</strong> $${session.monthlyPayment}/month (${session.paymentsRemaining || 0} remaining)
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="workflow-status">
                            <h4>ğŸ“‹ Workflow Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <input type="checkbox" id="contractSigned_${session.id}" ${session.contractSigned ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'contractSigned', this.checked); event.stopPropagation();">
                                    <label for="contractSigned_${session.id}">ğŸ“ Contract Signed</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="paid_${session.id}" ${session.paid ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'paid', this.checked); event.stopPropagation();">
                                    <label for="paid_${session.id}">ğŸ’° Paid</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="edited_${session.id}" ${session.edited ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'edited', this.checked); event.stopPropagation();">
                                    <label for="edited_${session.id}">âœï¸ Edited</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="delivered_${session.id}" ${session.delivered ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'delivered', this.checked); event.stopPropagation();">
                                    <label for="delivered_${session.id}">ğŸ“¦ Delivered</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="sendReminder_${session.id}" ${session.sendReminder ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'sendReminder', this.checked); event.stopPropagation();">
                                    <label for="sendReminder_${session.id}">â° Send Reminder</label>
                                </div>
                                <div class="status-item">
                                    <input type="checkbox" id="notifyGalleryReady_${session.id}" ${session.notifyGalleryReady ? 'checked' : ''} 
                                           onchange="toggleWorkflowStatus('${session.id}', 'notifyGalleryReady', this.checked); event.stopPropagation();">
                                    <label for="notifyGalleryReady_${session.id}">ğŸ–¼ï¸ Notify Gallery Ready</label>
                                </div>
                            </div>
                        </div>

                        <div class="session-actions">
                            <div class="action-buttons">
                                <button onclick="editSession('${session.id}'); event.stopPropagation();" class="action-btn edit-btn">âœï¸ Edit</button>
                                <button onclick="openUploadModal('${session.id}'); event.stopPropagation();" class="action-btn upload-btn">ğŸ“¸ Upload${session.photos && session.photos.length ? ` (${session.photos.length})` : ''}</button>
                                <button onclick="viewSessionGallery('${session.id}'); event.stopPropagation();" class="action-btn gallery-btn">ğŸ–¼ï¸ Gallery</button>
                                <button onclick="copyGalleryUrl('${session.id}'); event.stopPropagation();" class="action-btn copy-btn">ğŸ”— Copy URL</button>
                                <button onclick="addToCalendar('${session.id}'); event.stopPropagation();" class="action-btn calendar-btn">ğŸ“… Calendar</button>
                                <button onclick="openEmailClient('${session.id}'); event.stopPropagation();" class="action-btn email-btn">ğŸ“§ Email</button>
                                <button onclick="openContractModal('${session.id}'); event.stopPropagation();" class="action-btn contract-btn">ğŸ“ Contract</button>
                                ${session.hasPaymentPlan ? `
                                    <button onclick="viewPaymentPlan('${session.id}'); event.stopPropagation();" class="action-btn payment-btn">ğŸ’³ Payment Plan</button>
                                ` : `
                                    <button onclick="sendInvoice('${session.id}'); event.stopPropagation();" class="action-btn invoice-btn">ğŸ’³ Invoice</button>
                                    <button onclick="sendDepositInvoice('${session.id}'); event.stopPropagation();" class="action-btn deposit-btn">ğŸ’° Deposit</button>
                                    <button onclick="openPaymentPlanModal('${session.id}'); event.stopPropagation();" class="action-btn plan-btn">ğŸ“Š Payment Plan</button>
                                `}
                                <button onclick="exportSessionPDF('${session.id}'); event.stopPropagation();" class="export-btn">ğŸ“„ Export PDF</button>
                                <button onclick="toggleArchiveSession('${session.id}'); event.stopPropagation();" class="archive-btn">${session.archived ? 'ğŸ“‚ Unarchive' : 'ğŸ“ Archive'}</button>
                                <button onclick="deleteSession('${session.id}'); event.stopPropagation();" class="action-btn delete-btn">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </div>

                        <!-- Enhanced Notes & Checklist Section -->
                        <div class="session-notes">
                            <h4>ğŸ“ Session Notes & Checklist</h4>
                            <div class="notes-checklist">
                                <label><input type="checkbox" ${session.printsOrdered ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'printsOrdered', this.checked); event.stopPropagation();"> Prints Ordered?</label>
                                <label><input type="checkbox" ${session.specialEdits ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'specialEdits', this.checked); event.stopPropagation();"> Special Edits?</label>
                                <label><input type="checkbox" ${session.clientFeedback ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'clientFeedback', this.checked); event.stopPropagation();"> Client Feedback?</label>
                                <label><input type="checkbox" ${session.socialMediaApproval ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'socialMediaApproval', this.checked); event.stopPropagation();"> Social Media OK?</label>
                                <label><input type="checkbox" ${session.retouchingNeeded ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'retouchingNeeded', this.checked); event.stopPropagation();"> Retouching Needed?</label>
                                <label><input type="checkbox" ${session.backupCompleted ? 'checked' : ''} onchange="updateSessionNotes('${session.id}', 'backupCompleted', this.checked); event.stopPropagation();"> Backup Completed?</label>
                            </div>
                            <textarea class="notes-textarea" placeholder="Add session notes..." 
                                     onchange="updateSessionNotes('${session.id}', 'sessionNotes', this.value); event.stopPropagation();"
                                     onclick="event.stopPropagation();">${session.sessionNotes || ''}</textarea>
                        </div>

                        <!-- Enhanced Tip Panel for Delivered Sessions -->
                        ${session.delivered ? generateTipPanel(session.id) : ''}
                    </div>
                </div>
            `).filter(sessionHTML => {
                // Extract session ID from the HTML to determine visibility
                const match = sessionHTML.match(/data-session-id="([^"]+)"/);
                if (!match) return false;
                const sessionId = match[1];
                const session = sessions.find(s => s.id === sessionId);
                return session && isSessionVisible(session);
            }).join('');
        }

        function toggleSessionDetails(sessionId) {
            const details = document.getElementById(`details-${sessionId}`);
            const expandIcon = document.getElementById(`expand-${sessionId}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                expandIcon.textContent = 'â–²';
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                expandIcon.textContent = 'â–¼';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        function openUploadModal(sessionId) {
            currentUploadSessionId = sessionId;
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            currentUploadSessionId = null;
            selectedFiles = [];
            
            // Reset all upload interface elements
            const filePreview = document.getElementById('filePreview');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const fileInput = document.getElementById('fileInput');
            
            if (filePreview) filePreview.innerHTML = '';
            if (uploadStatus) uploadStatus.style.display = 'none';
            if (uploadBtn) uploadBtn.style.display = 'none';
            if (uploadProgress) uploadProgress.style.display = 'none';
            if (fileInput) fileInput.value = '';
            
            // Clear any existing progress intervals
            if (window.uploadProgressIntervals) {
                window.uploadProgressIntervals.forEach(interval => clearInterval(interval));
                window.uploadProgressIntervals = [];
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
                document.getElementById('fileInput').files = e.dataTransfer.files;
            }
        }

        let selectedFiles = [];

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                selectedFiles = files;
                showFilePreview(files);
            }
        }

        function showFilePreview(files) {
            const filePreview = document.getElementById('filePreview');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (files.length === 0) {
                filePreview.innerHTML = '';
                uploadBtn.style.display = 'none';
                return;
            }

            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
            
            filePreview.innerHTML = `
                <h4>Selected Photos (${files.length}) - ${totalSizeMB}MB Total</h4>
                <div class="file-preview-grid">
                    ${files.map((file, index) => {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                        return `
                            <div class="file-preview-item">
                                <img src="${URL.createObjectURL(file)}" alt="Preview">
                                <button class="file-preview-remove" onclick="removeFile(${index})">&times;</button>
                                <div style="font-size: 0.7em; color: #666; margin-top: 2px;">${fileSizeMB}MB</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${files.length > 20 ? '<div class="batch-upload-info">Large batch detected - will process in optimized chunks</div>' : ''}
            `;
            
            uploadBtn.style.display = 'inline-block';
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            showFilePreview(selectedFiles);
        }

        // ğŸ” ENHANCED CLIENT MANAGEMENT FUNCTIONS

        // Filter and Search Functionality
        function filterSessions() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const contractFilter = document.getElementById('filterContractSigned').checked;
            const paidFilter = document.getElementById('filterPaid').checked;
            const deliveredFilter = document.getElementById('filterDelivered').checked;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            sessions.forEach(session => {
                const sessionCard = document.querySelector(`[data-session-id="${session.id}"]`);
                if (!sessionCard) return;

                let isVisible = true;

                // Search filter
                if (searchTerm) {
                    const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        isVisible = false;
                    }
                }

                // Status filters
                if (contractFilter && !session.contractSigned) isVisible = false;
                if (paidFilter && !session.paid) isVisible = false;
                if (deliveredFilter && !session.delivered) isVisible = false;

                // Session type filter
                if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) isVisible = false;

                // Date range filter
                if (dateFromFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate < dateFromFilter) isVisible = false;
                }
                if (dateToFilter) {
                    const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                    if (sessionDate > dateToFilter) isVisible = false;
                }

                // Archive filter
                const showArchived = document.getElementById('showArchivedToggle').checked;
                if (session.archived && !showArchived) isVisible = false;

                sessionCard.classList.toggle('hidden-by-filter', !isVisible);
            });
        }

        function isSessionVisible(session) {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const contractFilter = document.getElementById('filterContractSigned')?.checked || false;
            const paidFilter = document.getElementById('filterPaid')?.checked || false;
            const deliveredFilter = document.getElementById('filterDelivered')?.checked || false;
            const sessionTypeFilter = document.getElementById('sessionTypeFilter')?.value || '';
            const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
            const dateToFilter = document.getElementById('dateToFilter')?.value || '';
            const showArchived = document.getElementById('showArchivedToggle')?.checked || false;

            // Search filter
            if (searchTerm) {
                const searchableText = `${session.clientName} ${session.location} ${session.email}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }

            // Status filters
            if (contractFilter && !session.contractSigned) return false;
            if (paidFilter && !session.paid) return false;
            if (deliveredFilter && !session.delivered) return false;

            // Session type filter
            if (sessionTypeFilter && session.sessionType !== sessionTypeFilter) return false;

            // Date range filter
            if (dateFromFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate < dateFromFilter) return false;
            }
            if (dateToFilter) {
                const sessionDate = new Date(session.dateTime).toISOString().split('T')[0];
                if (sessionDate > dateToFilter) return false;
            }

            // Archive filter
            if (session.archived && !showArchived) return false;

            return true;
        }

        // Sort Functionality
        function sortSessions() {
            const sortOption = document.getElementById('sortOptions').value;
            
            sessions.sort((a, b) => {
                switch (sortOption) {
                    case 'date-desc':
                        return new Date(b.dateTime) - new Date(a.dateTime);
                    case 'date-asc':
                        return new Date(a.dateTime) - new Date(b.dateTime);
                    case 'name-asc':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'unpaid-first':
                        if (a.paid === b.paid) return 0;
                        return a.paid ? 1 : -1;
                    default:
                        return 0;
                }
            });
            
            renderSessions();
        }

        // Archive Functionality
        async function toggleArchiveSession(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.archived = !session.archived;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    showMessage(session.archived ? 'Session archived successfully' : 'Session unarchived successfully', 'success');
                    renderSessions();
                } else {
                    session.archived = !session.archived; // Revert
                    showMessage('Error updating archive status', 'error');
                }
            } catch (error) {
                console.error('Error toggling archive:', error);
                showMessage('Error updating archive status', 'error');
            }
        }

        function toggleArchivedSessions() {
            renderSessions();
        }

        // Enhanced Notes Functionality
        async function updateSessionNotes(sessionId, field, value) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session[field] = value;
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (!response.ok) {
                    showMessage('Error saving notes', 'error');
                }
            } catch (error) {
                console.error('Error updating session notes:', error);
                showMessage('Error saving notes', 'error');
            }
        }

        // PDF Export Functionality
        async function exportSessionPDF(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            try {
                // Create PDF content
                const pdfContent = `
                    <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px;">
                        <h1 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 10px;">
                            Photography Session Summary
                        </h1>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                            <div>
                                <h2 style="color: #333;">Client Information</h2>
                                <p><strong>Name:</strong> ${session.clientName}</p>
                                <p><strong>Email:</strong> ${session.email}</p>
                                <p><strong>Phone:</strong> ${session.phoneNumber}</p>
                                <p><strong>Location:</strong> ${session.location}</p>
                            </div>
                            <div>
                                <h2 style="color: #333;">Session Details</h2>
                                <p><strong>Type:</strong> ${session.sessionType}</p>
                                <p><strong>Date & Time:</strong> ${formatDateTime(session.dateTime)}</p>
                                <p><strong>Duration:</strong> ${session.duration} hours</p>
                                <p><strong>Price:</strong> $${session.price}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Workflow Status</h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <p>ğŸ“ Contract Signed: ${session.contractSigned ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ’° Paid: ${session.paid ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>âœï¸ Edited: ${session.edited ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ“¦ Delivered: ${session.delivered ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>â° Send Reminder: ${session.sendReminder ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ–¼ï¸ Gallery Ready: ${session.notifyGalleryReady ? 'âœ… Yes' : 'âŒ No'}</p>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h2 style="color: #333;">Additional Checklist</h2>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <p>ğŸ–¨ï¸ Prints Ordered: ${session.printsOrdered ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>âœ¨ Special Edits: ${session.specialEdits ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ’¬ Client Feedback: ${session.clientFeedback ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ“± Social Media OK: ${session.socialMediaApproval ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ¨ Retouching Needed: ${session.retouchingNeeded ? 'âœ… Yes' : 'âŒ No'}</p>
                                <p>ğŸ’¾ Backup Completed: ${session.backupCompleted ? 'âœ… Yes' : 'âŒ No'}</p>
                            </div>
                        </div>
                        
                        ${session.sessionNotes ? `
                            <div style="margin: 30px 0;">
                                <h2 style="color: #333;">Session Notes</h2>
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #d4af37;">
                                    ${session.sessionNotes.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 50px; text-align: center; color: #666; font-size: 12px;">
                            <p>Generated on ${new Date().toLocaleDateString()} | Photography Management System</p>
                        </div>
                    </div>
                `;

                // Create new window for PDF generation
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Session Summary - ${session.clientName}</title>
                        <style>
                            body { margin: 0; font-family: Arial, sans-serif; }
                            @media print { 
                                body { margin: 1in; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="no-print" style="text-align: center; padding: 20px;">
                            <button onclick="window.print()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                ğŸ“„ Print/Save as PDF
                            </button>
                        </div>
                        ${pdfContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                showMessage('PDF export opened in new window', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF export', 'error');
            }
        }

        // Export All Sessions
        function exportAllSessions() {
            const visibleSessions = sessions.filter(isSessionVisible);
            
            if (visibleSessions.length === 0) {
                showMessage('No sessions to export', 'error');
                return;
            }

            try {
                const csvContent = generateCSVExport(visibleSessions);
                downloadCSV(csvContent, `sessions-export-${new Date().toISOString().split('T')[0]}.csv`);
                showMessage(`Exported ${visibleSessions.length} sessions to CSV`, 'success');
            } catch (error) {
                console.error('Error exporting sessions:', error);
                showMessage('Error exporting sessions', 'error');
            }
        }

        function generateCSVExport(sessionsToExport) {
            const headers = [
                'Client Name', 'Email', 'Phone', 'Session Type', 'Date & Time', 'Location', 
                'Duration', 'Price', 'Contract Signed', 'Paid', 'Edited', 'Delivered',
                'Prints Ordered', 'Special Edits', 'Client Feedback', 'Social Media OK',
                'Retouching Needed', 'Backup Completed', 'Session Notes', 'Archived'
            ];

            const csvRows = [headers.join(',')];

            sessionsToExport.forEach(session => {
                const row = [
                    `"${session.clientName}"`,
                    `"${session.email}"`,
                    `"${session.phoneNumber}"`,
                    `"${session.sessionType}"`,
                    `"${formatDateTime(session.dateTime)}"`,
                    `"${session.location}"`,
                    session.duration,
                    session.price,
                    session.contractSigned ? 'Yes' : 'No',
                    session.paid ? 'Yes' : 'No',
                    session.edited ? 'Yes' : 'No',
                    session.delivered ? 'Yes' : 'No',
                    session.printsOrdered ? 'Yes' : 'No',
                    session.specialEdits ? 'Yes' : 'No',
                    session.clientFeedback ? 'Yes' : 'No',
                    session.socialMediaApproval ? 'Yes' : 'No',
                    session.retouchingNeeded ? 'Yes' : 'No',
                    session.backupCompleted ? 'Yes' : 'No',
                    `"${(session.sessionNotes || '').replace(/"/g, '""')}"`,
                    session.archived ? 'Yes' : 'No'
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('filterContractSigned').checked = false;
            document.getElementById('filterPaid').checked = false;
            document.getElementById('filterDelivered').checked = false;
            document.getElementById('sessionTypeFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('sortOptions').value = 'date-desc';
            
            filterSessions();
            sortSessions();
        }

        // ğŸ’› TIP FUNCTIONALITY FOR DELIVERED SESSIONS
        function generateTipPanel(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || !session.delivered) return '';

            return `
                <div class="tip-panel" style="background: linear-gradient(135deg, #fff9e6, #f4e4bc); padding: 20px; margin-top: 30px; border-radius: 12px; border: 2px solid #d4af37; text-align: center;">
                    <h3 style="color: #8b7355; margin-bottom: 15px; font-size: 1.2em;">ğŸ’› Love your photos?</h3>
                    <p style="color: #8b7355; margin-bottom: 20px; font-size: 0.95em;">
                        If you're thrilled with your photos, you can leave a tip to show your appreciation<br>
                        <em>(totally optional and not expected!)</em>
                    </p>
                    <div class="tip-buttons" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="processTip('${sessionId}', 10)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$10</button>
                        <button onclick="processTip('${sessionId}', 25)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$25</button>
                        <button onclick="processTip('${sessionId}', 50)" class="tip-btn" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">$50</button>
                        <button onclick="customTipAmount('${sessionId}')" class="tip-btn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; min-width: 80px;">Custom</button>
                    </div>
                    ${session.tipReceived ? `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; color: #28a745;">
                            <span style="font-size: 1.1em;">ğŸ‰ Thank you for your generous tip of $${session.tipAmount}!</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function processTip(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                // For demo purposes, simulate Stripe checkout success
                // In production, this would integrate with actual Stripe checkout
                const confirmTip = confirm(`Process tip of $${amount}?\n\nThis will open Stripe checkout to process the payment.`);
                
                if (confirmTip) {
                    // Simulate successful tip processing
                    await updateTipStatus(sessionId, amount);
                    showMessage(`Thank you for your generous $${amount} tip! ğŸ‰`, 'success');
                    celebrateMilestone('tip_received', `$${amount} tip from ${session.clientName}`);
                    
                    // In production, this would be:
                    // window.location.href = await createStripeCheckoutSession(sessionId, amount);
                }
            } catch (error) {
                console.error('Error processing tip:', error);
                showMessage('Error processing tip', 'error');
            }
        }

        async function customTipAmount(sessionId) {
            const amount = prompt('Enter custom tip amount (numbers only):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                await processTip(sessionId, parseFloat(amount));
            } else if (amount !== null) {
                showMessage('Please enter a valid amount', 'error');
            }
        }

        async function updateTipStatus(sessionId, amount) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                session.tipReceived = true;
                session.tipAmount = amount;
                session.tipDate = new Date().toISOString();
                
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(session)
                });

                if (response.ok) {
                    renderSessions();
                } else {
                    showMessage('Error updating tip status', 'error');
                }
            } catch (error) {
                console.error('Error updating tip status:', error);
                showMessage('Error updating tip status', 'error');
            }
        }

        function startUpload() {
            if (selectedFiles.length === 0) {
                showMessage('No files selected for upload', 'error');
                return;
            }
            uploadFiles(selectedFiles);
        }

        function showUploadProgress(show = true) {
            const progressContainer = document.getElementById('uploadProgressContainer');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (show) {
                progressContainer.style.display = 'block';
                uploadBtn.style.display = 'none';
            } else {
                progressContainer.style.display = 'none';
                uploadBtn.style.display = 'block';
            }
        }

        function updateProgress(percent, text, details = '') {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressDetails = document.getElementById('progressDetails');
            const progressSubDetails = document.getElementById('progressSubDetails');
            
            const roundedPercent = Math.round(percent);
            
            // Update progress bar width and text
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${roundedPercent}%`;
            
            // Enhanced color coding based on progress
            if (percent < 25) {
                progressBar.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%)'; // Red for starting
            } else if (percent < 50) {
                progressBar.style.background = 'linear-gradient(135deg, #ffa726 0%, #ffcc02 100%)'; // Orange for quarter
            } else if (percent < 75) {
                progressBar.style.background = 'linear-gradient(135deg, #ffcc02 0%, #d4af37 100%)'; // Yellow for half
            } else if (percent < 100) {
                progressBar.style.background = 'linear-gradient(135deg, #d4af37 0%, #4caf50 100%)'; // Gold to green for almost done
            } else {
                progressBar.style.background = 'linear-gradient(135deg, #4caf50 0%, #81c784 100%)'; // Green for complete
            }
            
            // Update text content
            progressText.textContent = text;
            progressDetails.textContent = details;
            
            // Add sub-details for extra information
            if (progressSubDetails) {
                if (percent === 100) {
                    progressSubDetails.textContent = 'ğŸ‰ Upload completed successfully!';
                    progressSubDetails.style.color = '#4caf50';
                } else if (percent > 0) {
                    progressSubDetails.textContent = `${roundedPercent}% complete - Upload in progress...`;
                    progressSubDetails.style.color = '#d4af37';
                } else {
                    progressSubDetails.textContent = 'Initializing upload process...';
                    progressSubDetails.style.color = '#999';
                }
            }
            
            // Update browser tab title with progress percentage
            if (percent < 100) {
                document.title = `(${roundedPercent}%) Upload Progress - Photography Scheduler`;
            } else {
                document.title = 'âœ… Upload Complete - Photography Scheduler';
                setTimeout(() => {
                    document.title = 'Photography Scheduler';
                }, 3000);
            }
        }

        async function uploadFiles(files) {
            if (!currentUploadSessionId) {
                showMessage('No session selected for upload', 'error');
                return;
            }

            console.log(`ğŸš€ ENHANCED DEBUG: Starting upload of ${files.length} files to session ${currentUploadSessionId}`);

            // Check if we need to batch upload (more than 50 files or total size > 500MB)
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = totalSize / (1024 * 1024);
            
            console.log(`ğŸ“Š Upload analysis: ${files.length} files, ${totalSizeMB.toFixed(2)}MB total`);
            
            // Filter out overly large files for mobile to improve connectivity
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const maxFileSizeMB = isMobile ? 50 : 100; // Smaller limit for mobile
            
            const filteredFiles = [];
            const oversizedFiles = [];
            
            files.forEach(file => {
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > maxFileSizeMB) {
                    oversizedFiles.push({ name: file.name, size: fileSizeMB.toFixed(2) });
                } else {
                    filteredFiles.push(file);
                }
            });
            
            if (oversizedFiles.length > 0) {
                const oversizedList = oversizedFiles.map(f => `${f.name} (${f.size}MB)`).join(', ');
                showMessage(`Skipping ${oversizedFiles.length} oversized files: ${oversizedList}. Max size: ${maxFileSizeMB}MB per file.`, 'warning');
            }
            
            if (filteredFiles.length === 0) {
                showMessage('No files small enough to upload. Please reduce file sizes and try again.', 'error');
                return;
            }
            
            // Process all files sequentially one at a time for maximum reliability
            console.log(`ğŸ“¦ Sequential single-file processing - ${filteredFiles.length} files`);
            return sequentialSingleFileUpload(filteredFiles);

            // Show progress and start upload
            showUploadProgress(true);
            updateProgress(0, 'Preparing upload...', `${files.length} files (${totalSizeMB.toFixed(1)}MB)`);

            return new Promise((resolve, reject) => {
                try {
                    const formData = new FormData();
                    files.forEach((file, index) => {
                        console.log(`ğŸ“ Adding file ${index + 1}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                        formData.append('photos', file);
                    });

                    console.log(`ğŸ“¤ FormData ready - creating XMLHttpRequest with progress tracking`);
                    updateProgress(5, 'Starting upload...', 'Connecting to server...');

                    const xhr = new XMLHttpRequest();
                    
                    // Enhanced progress tracking with detailed logging
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
                            const totalMB = (e.total / 1024 / 1024).toFixed(2);
                            
                            console.log(`ğŸ“Š Upload Progress: ${percentComplete.toFixed(1)}% (${loadedMB}MB / ${totalMB}MB)`);
                            updateProgress(
                                Math.min(percentComplete * 0.7, 70), // 70% max for upload phase
                                `Uploading: ${percentComplete.toFixed(1)}%`,
                                `${loadedMB}MB / ${totalMB}MB transferred`
                            );
                        }
                    });

                    xhr.upload.addEventListener('loadstart', () => {
                        console.log(`ğŸš€ Upload transfer started`);
                        updateProgress(10, 'Upload in progress...', 'Transferring files to server');
                    });

                    xhr.addEventListener('load', () => {
                        console.log(`ğŸ“Š XHR load event - status: ${xhr.status}, readyState: ${xhr.readyState}`);
                        updateProgress(75, 'Processing upload...', 'Server is processing your photos');
                        
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                console.log(`âœ… Upload successful:`, result);
                                
                                updateProgress(100, 'Upload complete!', `Successfully uploaded ${result.uploaded} photos`);
                                setTimeout(() => {
                                    showMessage(`Successfully uploaded ${result.uploaded} photos!`, 'success');
                                    closeUploadModal();
                                    // Force page reload on mobile to ensure photos show up
                                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                                        console.log('Mobile device detected - reloading page to show uploaded photos');
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    } else {
                                        loadSessions(); // Desktop refresh
                                    }
                                    celebrateMilestone('photos_uploaded');
                                    resolve(result);
                                }, 1000);
                                
                            } catch (parseError) {
                                console.error(`âŒ Error parsing response:`, parseError);
                                console.error(`âŒ Raw response:`, xhr.responseText);
                                updateProgress(0, 'Upload failed', 'Invalid server response');
                                showMessage('Upload failed: Invalid server response', 'error');
                                reject(parseError);
                            }
                        } else if (xhr.status === 401) {
                            console.error(`âŒ Authentication error (401)`);
                            updateProgress(0, 'Authentication required', 'Please log in to upload photos');
                            showMessage('Please log in to upload photos', 'error');
                            setTimeout(() => {
                                window.location.href = '/api/login';
                            }, 2000);
                            reject(new Error('Authentication required'));
                        } else {
                            console.error(`âŒ Upload failed with status ${xhr.status}: ${xhr.responseText}`);
                            updateProgress(0, 'Upload failed', xhr.responseText);
                            showMessage(`Upload failed: ${xhr.responseText}`, 'error');
                            reject(new Error(`Upload failed: ${xhr.responseText}`));
                        }
                    });

                    xhr.addEventListener('error', (e) => {
                        console.error(`âŒ XHR error event:`, e);
                        console.error(`âŒ XHR details:`, {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            readyState: xhr.readyState
                        });
                        updateProgress(0, 'Upload failed', 'Network or server error');
                        showMessage('Upload failed: Network or server error', 'error');
                        reject(new Error('Network or server error'));
                    });

                    xhr.addEventListener('timeout', () => {
                        console.error(`âŒ Upload timeout`);
                        updateProgress(0, 'Upload timeout', 'Upload took too long');
                        showMessage('Upload timeout - try smaller batches', 'error');
                        reject(new Error('Upload timeout'));
                    });

                    // Set reasonable timeout for mobile uploads
                    xhr.timeout = 10 * 60 * 1000; // 10 minutes
                    
                    console.log(`ğŸ“¤ Opening connection to /api/sessions/${currentUploadSessionId}/upload-photos`);
                    xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`, true);
                    xhr.withCredentials = true;
                    
                    console.log(`ğŸ“¤ Sending FormData...`);
                    xhr.send(formData);

                } catch (error) {
                    console.error('âŒ Error setting up upload:', error);
                    updateProgress(0, 'Upload failed', error.message);
                    showMessage(`Upload failed: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }

        // Upload with retry logic for better connectivity
        async function uploadWithRetry(formData, batchNumber, totalBatches, retryCount = 0) {
            const maxRetries = 3;
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                // Add upload progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const filePercent = Math.round((e.loaded / e.total) * 100);
                        const batchProgress = ((batchNumber - 1) / totalBatches) * 100;
                        const currentBatchProgress = (filePercent / totalBatches);
                        const overallPercent = Math.round(batchProgress + currentBatchProgress);
                        
                        const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                        const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                        
                        updateProgress(
                            overallPercent, 
                            `Uploading batch ${batchNumber}/${totalBatches} (${filePercent}%)`,
                            `${loadedMB}MB / ${totalMB}MB transferred`
                        );
                        
                        console.log(`ğŸ“Š Upload Progress: Batch ${batchNumber}/${totalBatches} - ${filePercent}% (${loadedMB}MB / ${totalMB}MB) - Overall: ${overallPercent}%`);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            console.log(`âœ… Batch ${batchNumber} uploaded successfully (attempt ${retryCount + 1})`);
                            resolve(result);
                        } catch (parseError) {
                            if (retryCount < maxRetries) {
                                console.log(`âš ï¸ Parse error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                                updateProgress(
                                    ((batchNumber - 1) / totalBatches) * 100,
                                    `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                                    'Parse error - retrying upload'
                                );
                                setTimeout(() => {
                                    uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                        .then(resolve).catch(reject);
                                }, 1000 * (retryCount + 1)); // Exponential backoff
                            } else {
                                reject(new Error('Invalid server response'));
                            }
                        }
                    } else if (xhr.status === 401) {
                        reject(new Error('Authentication required'));
                    } else {
                        if (retryCount < maxRetries) {
                            console.log(`âš ï¸ HTTP ${xhr.status} error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                            updateProgress(
                                ((batchNumber - 1) / totalBatches) * 100,
                                `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                                `HTTP ${xhr.status} error - retrying upload`
                            );
                            setTimeout(() => {
                                uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                    .then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error(xhr.responseText || `Upload failed with status ${xhr.status}`));
                        }
                    }
                });
                
                xhr.addEventListener('error', () => {
                    if (retryCount < maxRetries) {
                        console.log(`âš ï¸ Network error, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                        updateProgress(
                            ((batchNumber - 1) / totalBatches) * 100,
                            `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                            'Network error - retrying upload'
                        );
                        setTimeout(() => {
                            uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                .then(resolve).catch(reject);
                        }, 1000 * (retryCount + 1));
                    } else {
                        reject(new Error('Network error - all retries failed'));
                    }
                });
                
                xhr.addEventListener('timeout', () => {
                    if (retryCount < maxRetries) {
                        console.log(`âš ï¸ Timeout, retrying batch ${batchNumber} (attempt ${retryCount + 2})`);
                        updateProgress(
                            ((batchNumber - 1) / totalBatches) * 100,
                            `Retrying batch ${batchNumber} (attempt ${retryCount + 2})`,
                            'Upload timeout - retrying'
                        );
                        setTimeout(() => {
                            uploadWithRetry(formData, batchNumber, totalBatches, retryCount + 1)
                                .then(resolve).catch(reject);
                        }, 1000 * (retryCount + 1));
                    } else {
                        reject(new Error('Upload timeout - all retries failed'));
                    }
                });
                
                xhr.timeout = 2 * 60 * 1000; // 2 minute timeout
                xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`, true);
                xhr.withCredentials = true;
                xhr.send(formData);
            });
        }

        // Upload files in reliable batches with retry logic
        async function sequentialSingleFileUpload(files) {
            showUploadProgress(true);
            updateProgress(0, 'Starting sequential upload...', `${files.length} files to process`);
            
            let uploadedCount = 0;
            const totalFiles = files.length;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    
                    console.log(`ğŸš€ Processing file ${i + 1}/${totalFiles}: ${file.name} (${fileSizeMB}MB)`);
                    
                    // Create FormData for single file
                    const formData = new FormData();
                    formData.append('photos', file);
                    
                    // Upload single file with progress tracking
                    try {
                        const result = await uploadSingleFileWithProgress(formData, i + 1, totalFiles, file.name, fileSizeMB);
                        uploadedCount += result.uploaded;
                        
                        // Update overall progress
                        const overallPercent = Math.round(((i + 1) / totalFiles) * 100);
                        updateProgress(overallPercent, `File ${i + 1}/${totalFiles} complete`, `${uploadedCount} photos uploaded successfully`);
                        
                        console.log(`âœ… File ${i + 1} uploaded successfully: ${file.name}`);
                        
                    } catch (error) {
                        console.error(`âŒ File ${i + 1} upload failed: ${file.name}`, error);
                        showMessage(`Failed to upload ${file.name}: ${error.message}`, 'error');
                        // Continue with next file instead of stopping entire batch
                    }
                }
                
                updateProgress(100, 'All uploads complete!', `Successfully uploaded ${uploadedCount}/${totalFiles} photos`);
                setTimeout(() => {
                    showMessage(`Upload complete! ${uploadedCount}/${totalFiles} photos uploaded successfully.`, 'success');
                    closeUploadModal();
                    
                    // Force page reload on mobile to ensure photos show up
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        console.log('Mobile device detected - reloading page to show uploaded photos');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        loadSessions(); // Refresh session data to show new photos
                    }
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Sequential upload failed:', error);
                showMessage('Upload failed: ' + error.message, 'error');
                showUploadProgress(false);
            }
        }

        async function uploadSingleFileWithProgress(formData, fileNumber, totalFiles, fileName, fileSizeMB) {
            const maxRetries = 3;
            
            const uploadWithRetry = (retryCount = 0) => {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 2 minute timeout
                    
                    // Progress tracking for individual file
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const filePercent = Math.round((e.loaded / e.total) * 100);
                            const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                            const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                            
                            // Calculate overall progress across all files
                            const completedFiles = fileNumber - 1;
                            const currentFileProgress = filePercent / 100;
                            const overallPercent = Math.round(((completedFiles + currentFileProgress) / totalFiles) * 100);
                            
                            updateProgress(
                                overallPercent,
                                `Uploading file ${fileNumber}/${totalFiles}: ${fileName} (${filePercent}%)`,
                                `${loadedMB}MB / ${totalMB}MB transferred`
                            );
                            
                            console.log(`ğŸ“Š File ${fileNumber} Progress: ${filePercent}% (${loadedMB}MB / ${totalMB}MB) - Overall: ${overallPercent}%`);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                resolve(result);
                            } catch (parseError) {
                                if (retryCount < maxRetries) {
                                    console.log(`âš ï¸ Parse error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                                    setTimeout(() => {
                                        uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                                    }, 1000 * (retryCount + 1));
                                } else {
                                    reject(new Error('Invalid server response'));
                                }
                            }
                        } else if (xhr.status === 401) {
                            reject(new Error('Authentication required'));
                        } else {
                            if (retryCount < maxRetries) {
                                console.log(`âš ï¸ HTTP ${xhr.status} error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                                setTimeout(() => {
                                    uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                                }, 1000 * (retryCount + 1));
                            } else {
                                reject(new Error(`Upload failed with status ${xhr.status}`));
                            }
                        }
                    });

                    xhr.addEventListener('error', () => {
                        if (retryCount < maxRetries) {
                            console.log(`âš ï¸ Network error, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                            setTimeout(() => {
                                uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error('Network error - all retries failed'));
                        }
                    });

                    xhr.addEventListener('timeout', () => {
                        if (retryCount < maxRetries) {
                            console.log(`âš ï¸ Timeout, retrying file ${fileNumber} (attempt ${retryCount + 2})`);
                            setTimeout(() => {
                                uploadWithRetry(retryCount + 1).then(resolve).catch(reject);
                            }, 1000 * (retryCount + 1));
                        } else {
                            reject(new Error('Upload timeout - all retries failed'));
                        }
                    });

                    xhr.open('POST', `/api/sessions/${currentUploadSessionId}/upload-photos`);
                    xhr.send(formData);
                });
            };
            
            return uploadWithRetry();
        }

        async function uploadFilesInBatches(files) {
            // Use small batches for mobile reliability  
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const batchSize = isMobile ? 1 : 5; // 1 file for mobile, 5 for desktop
            const totalBatches = Math.ceil(files.length / batchSize);
            let uploadedCount = 0;
            
            console.log(`ğŸš€ Reliable upload mode: ${batchSize} files per batch (${isMobile ? 'mobile' : 'desktop'} mode)`);
            
            showMessage(`Uploading ${files.length} files in ${totalBatches} reliable batches...`, 'info');
            showUploadProgress(true);
            
            // Process batches sequentially for reliability
            try {
                for (let i = 0; i < totalBatches; i++) {
                    const start = i * batchSize;
                    const end = Math.min(start + batchSize, files.length);
                    const batch = files.slice(start, end);
                    
                    console.log(`ğŸš€ Uploading batch ${i + 1}/${totalBatches}: files ${start + 1}-${end}`);
                    updateProgress((i / totalBatches) * 80, `Uploading batch ${i + 1}/${totalBatches}`, `${uploadedCount}/${files.length} photos uploaded`);
                    
                    try {
                        const formData = new FormData();
                        batch.forEach(file => {
                            formData.append('photos', file);
                        });

                        // Use XMLHttpRequest with retry logic for better reliability
                        const result = await uploadWithRetry(formData, i + 1, totalBatches);



                        uploadedCount += result.uploaded;
                        console.log(`âœ… Batch ${i + 1} complete: ${result.uploaded} photos uploaded`);
                        const batchCompletePercent = Math.round(((i + 1) / totalBatches) * 100);
                        updateProgress(batchCompletePercent, `Batch ${i + 1}/${totalBatches} complete`, `${uploadedCount}/${files.length} photos uploaded successfully`);
                    } catch (error) {
                        console.error(`âŒ Batch ${i + 1} upload error:`, error);
                        if (error.message === 'Authentication required') {
                            showMessage('Authentication required. Please log in to upload photos.', 'error');
                            setTimeout(() => {
                                window.location.href = '/api/login';
                            }, 2000);
                            return;
                        }
                        showMessage(`Batch ${i + 1} failed: ${error.message}`, 'error');
                        showUploadProgress(false);
                        return;
                    }
                }
                
                updateProgress(100, 'Upload complete!', `All ${uploadedCount} photos uploaded successfully`);
                
            } catch (error) {
                console.error('âŒ Batch upload failed:', error);
                showMessage('Upload failed: ' + error.message, 'error');
                showUploadProgress(false);
                return;
            }
            
            showMessage(`All ${uploadedCount} photos uploaded successfully!`, 'success');
            closeUploadModal();
            // Force page reload on mobile to ensure photos show up  
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                console.log('Mobile device detected - reloading page to show uploaded photos');
                celebrateMilestone('photos_uploaded');
                setTimeout(() => {
                    window.location.reload();
                }, 2000); // Longer delay for celebration
            } else {
                loadSessions(); // Desktop refresh
                celebrateMilestone('photos_uploaded');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;

            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    sessions = sessions.filter(s => s.id !== sessionId);
                    renderSessions();
                    showMessage('Session deleted successfully!', 'success');
                } else {
                    showMessage('Failed to delete session', 'error');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showMessage('Error deleting session', 'error');
            }
        }

        function viewPhoto(url) {
            window.open(url, '_blank');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
            `;
            
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Admin-only button functions
        let editingSessionId = null;

        function editSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            editingSessionId = sessionId;
            
            // Populate the form with existing data for editing
            document.getElementById('clientName').value = session.clientName;
            document.getElementById('sessionType').value = session.sessionType;
            // Format the datetime for the input field (datetime-local expects YYYY-MM-DDTHH:MM format)
            const dateForEdit = new Date(session.dateTime);
            const formattedDate = dateForEdit.toISOString().slice(0, 16);
            document.getElementById('dateTime').value = formattedDate;
            document.getElementById('location').value = session.location;
            document.getElementById('phoneNumber').value = session.phoneNumber;
            document.getElementById('email').value = session.email;
            document.getElementById('price').value = session.price;
            document.getElementById('duration').value = session.duration;
            
            // Set checkbox states
            document.getElementById('contractSigned').checked = session.contractSigned || false;
            document.getElementById('paid').checked = session.paid || false;
            document.getElementById('edited').checked = session.edited || false;
            document.getElementById('delivered').checked = session.delivered || false;
            document.getElementById('sendReminder').checked = session.sendReminder || false;
            document.getElementById('notifyGalleryReady').checked = session.notifyGalleryReady || false;
            
            // Update form UI for editing
            const form = document.getElementById('sessionForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Session';
            
            // Allow all dates for editing historical sessions (past dates enabled)
            document.getElementById('dateTime').removeAttribute('min');
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
            
            showMessage('Form populated for editing. Update and save changes.', 'success');
        }





        // Open email client with session details  
        function openEmailClient(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const subject = `Photography Session - ${session.sessionType} with ${session.clientName}`;
            const body = `Hi ${session.clientName},

I hope this email finds you well! I'm writing regarding your upcoming ${session.sessionType} photography session.

Session Details:
Date: ${new Date(session.dateTime).toLocaleDateString()}
Time: ${new Date(session.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
Location: ${session.location}
Investment: $${session.price}
Contact: ${session.phoneNumber}

I'm excited to capture these special moments for you! If you have any questions or need to make any changes, please don't hesitate to reach out.

Best regards,
Lance - The Legacy Photography
Professional Photography Services
lance@thelegacyphotography.com`;

            const mailtoUrl = `mailto:${session.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }

        // Copy gallery URL to clipboard
        async function copyGalleryUrl(sessionId) {
            try {
                showMessage('Generating gallery URL...', 'info');
                
                // Generate gallery access if not exists
                const response = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate gallery access');
                }
                
                const data = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                console.log('Generated gallery URL:', data.galleryUrl);
                
                // Try multiple methods to copy URL with enhanced mobile support
                let copySuccess = false;
                let method = '';
                
                // Method 1: Modern clipboard API (works on HTTPS and secure contexts)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(data.galleryUrl);
                        copySuccess = true;
                        method = 'clipboard API';
                        console.log('Clipboard API copy successful');
                        
                        // Trigger milestone celebration for gallery sharing
                        celebrateMilestone('gallery_shared');
                    } catch (clipboardError) {
                        console.log('Clipboard API failed:', clipboardError.message);
                    }
                }
                
                // Method 2: Enhanced textarea fallback with mobile optimization
                if (!copySuccess) {
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = data.galleryUrl;
                        
                        // Enhanced styles for mobile compatibility
                        textarea.style.position = 'fixed';
                        textarea.style.top = '0';
                        textarea.style.left = '0';
                        textarea.style.width = '2em';
                        textarea.style.height = '2em';
                        textarea.style.padding = '0';
                        textarea.style.border = 'none';
                        textarea.style.outline = 'none';
                        textarea.style.boxShadow = 'none';
                        textarea.style.background = 'transparent';
                        textarea.style.opacity = '0';
                        textarea.style.zIndex = '-1';
                        
                        document.body.appendChild(textarea);
                        
                        // Enhanced selection for mobile devices
                        textarea.focus();
                        textarea.setSelectionRange(0, 99999);
                        textarea.select();
                        
                        // Try execCommand
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        if (successful) {
                            copySuccess = true;
                            method = 'execCommand';
                            console.log('execCommand copy successful');
                        }
                    } catch (fallbackError) {
                        console.log('Fallback copy failed:', fallbackError.message);
                    }
                }
                
                // Method 3: Share API for mobile devices (if available)
                if (!copySuccess && navigator.share) {
                    try {
                        await navigator.share({
                            title: `Gallery for ${session.clientName}`,
                            text: `View your ${session.sessionType} photos:`,
                            url: data.galleryUrl
                        });
                        method = 'share API';
                        showMessage('Gallery shared successfully!', 'success');
                        return; // Exit early since sharing was successful
                    } catch (shareError) {
                        console.log('Share API failed:', shareError.message);
                    }
                }
                
                // Always show the URL in a prompt dialog for copying
                if (copySuccess) {
                    showMessage(`Gallery URL copied successfully! (${method})`, 'success');
                    // Show confirmation with the URL
                    alert(`Gallery URL copied for ${session.clientName}!\n\nURL: ${data.galleryUrl}\n\nYou can now paste this into your email or text message.`);
                } else {
                    showMessage('Copy the URL from the dialog below', 'info');
                    // Show URL in a prompt for manual copying
                    const userAction = prompt(`Copy this gallery URL for ${session.clientName}:`, data.galleryUrl);
                    if (userAction !== null) {
                        showMessage('Gallery URL provided for copying', 'success');
                    }
                }
                
            } catch (error) {
                console.error('Error copying gallery URL:', error);
                showMessage('Failed to generate gallery URL: ' + error.message, 'error');
            }
        }

        function addToCalendar(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // For iPhone, use the server endpoint
            if (/iPhone|iPad/.test(navigator.userAgent)) {
                window.location.href = `/api/sessions/${sessionId}/calendar.ics`;
                showMessage('Opening iPhone Calendar...', 'success');
                return;
            }
            
            const startDate = new Date(session.dateTime);
            const endDate = new Date(startDate.getTime() + (session.duration * 60000));
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Photography Scheduler//EN
BEGIN:VEVENT
UID:${session.id}@photographyschedule.com
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Photography Session - ${session.clientName}
DESCRIPTION:Session Type: ${session.sessionType}\\nLocation: ${session.location}\\nClient: ${session.clientName}\\nPhone: ${session.phoneNumber}\\nEmail: ${session.email}\\nPrice: $${session.price}
LOCATION:${session.location}
END:VEVENT
END:VCALENDAR`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${session.clientName.replace(/\s+/g, '_')}_photography_session.ics`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Calendar event downloaded!', 'success');
        }

        async function sendGalleryReady(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                // First, generate gallery access token
                const generateResponse = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!generateResponse.ok) {
                    throw new Error('Failed to generate gallery access');
                }
                
                const galleryData = await generateResponse.json();
                
                // Then send notification
                const notifyResponse = await fetch(`/api/sessions/${sessionId}/send-gallery-notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!notifyResponse.ok) {
                    throw new Error('Failed to send gallery notification');
                }
                
                const notifyData = await notifyResponse.json();
                
                // Show success message with gallery URL
                showMessage(`Gallery ready! Secure link sent to ${session.clientName}`, 'success');
                
                // Optional: Show the gallery URL in a popup for copying
                const showUrlConfirm = confirm(`Gallery notification sent to ${session.clientName}!\n\nGallery URL (for your reference):\n${galleryData.galleryUrl}\n\nClick OK to copy link to clipboard.`);
                
                if (showUrlConfirm) {
                    navigator.clipboard.writeText(galleryData.galleryUrl).then(() => {
                        showMessage('Gallery URL copied to clipboard!', 'success');
                    }).catch(() => {
                        // Fallback for browsers that don't support clipboard API
                        prompt('Copy this gallery URL:', galleryData.galleryUrl);
                    });
                }
                
            } catch (error) {
                console.error('Error sending gallery ready notification:', error);
                showMessage('Failed to send gallery notification: ' + error.message, 'error');
            }
        }

        async function sendInvoice(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to send invoice');
                }
                
                const result = await response.json();
                
                if (result.fallbackMode) {
                    // Handle simulation mode
                    showMessage(`Invoice simulation completed for ${session.clientName}`, 'info');
                    alert(`Invoice Simulation Mode\n\nClient: ${result.clientName}\nAmount: $${result.amount}\nSession: ${result.sessionType}\n\n${result.details}`);
                } else {
                    // Handle real Stripe invoice
                    showMessage(`Invoice sent to ${session.clientName} for $${session.price}!`, 'success');
                    
                    // Trigger milestone celebration for invoice sent
                    celebrateMilestone('invoice_sent');
                    
                    // Show invoice URL
                    const showUrlConfirm = confirm(`Invoice sent successfully to ${session.clientName}!\n\nInvoice Amount: $${session.price}\nStatus: ${result.invoice ? result.invoice.status : 'sent'}\n\nClick OK to view the invoice.`);
                    
                    if (showUrlConfirm && result.invoice && result.invoice.hostedInvoiceUrl) {
                        window.open(result.invoice.hostedInvoiceUrl, '_blank');
                    }
                }
                
            } catch (error) {
                console.error('Error sending invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }

        function callClient(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        function textClient(phoneNumber, clientName, sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (session && session.galleryAccessToken) {
                const galleryUrl = `${window.location.origin}/gallery/${sessionId}?access=${session.galleryAccessToken}`;
                const message = `${clientName}, your ${session.sessionType} photos are ready! View gallery: ${galleryUrl}`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            } else {
                const message = `Hi ${clientName}, your photos will be ready soon! We'll send you the gallery link when they're available.`;
                window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
            }
        }

        async function viewGallery(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Check if gallery access exists
            if (session.galleryAccessToken) {
                // Open existing gallery
                window.open(`/gallery/${sessionId}?access=${session.galleryAccessToken}`, '_blank');
            } else {
                // Generate gallery access first
                try {
                    const response = await fetch(`/api/sessions/${sessionId}/generate-gallery-access`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate gallery access');
                    }
                    
                    const galleryData = await response.json();
                    
                    // Update local session data
                    session.galleryAccessToken = galleryData.accessToken;
                    
                    // Open gallery
                    window.open(galleryData.galleryUrl, '_blank');
                    
                } catch (error) {
                    console.error('Error generating gallery access:', error);
                    showMessage('Failed to generate gallery access: ' + error.message, 'error');
                }
            }
        }
    </script>

    <!-- Confetti Container for Milestone Celebrations -->
    <div id="confettiContainer" class="confetti-container"></div>

    <script>
        // Confetti Animation System for Milestone Celebrations
        function createConfetti(x, y, count = 50) {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                
                // Random positioning and styling
                const startX = x || Math.random() * window.innerWidth;
                const startY = y || -20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 8 + 6;
                const duration = Math.random() * 2 + 2;
                
                confetti.style.left = startX + 'px';
                confetti.style.top = startY + 'px';
                confetti.style.backgroundColor = color;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                confetti.style.animationDuration = duration + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                
                container.appendChild(confetti);
                
                // Clean up after animation
                setTimeout(() => {
                    if (confetti && confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, (duration + 0.5) * 1000);
            }
        }
        
        function showMilestoneToast(message, emoji = 'ğŸ‰') {
            const toast = document.createElement('div');
            toast.className = 'milestone-toast';
            toast.innerHTML = `${emoji} ${message}`;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }
        
        function celebrateMilestone(type, sessionName = '') {
            const celebrations = {
                'session_created': {
                    message: `New Session Created: ${sessionName}`,
                    emoji: '',
                    confetti: 30
                },
                'contract_signed': {
                    message: 'Contract Signed!',
                    emoji: '',
                    confetti: 25
                },
                'payment_received': {
                    message: 'Payment Received!',
                    emoji: '',
                    confetti: 40
                },
                'photos_uploaded': {
                    message: 'Photos Uploaded Successfully!',
                    emoji: '',
                    confetti: 35
                },
                'session_delivered': {
                    message: 'Session Delivered!',
                    emoji: '',
                    confetti: 45
                },
                'gallery_shared': {
                    message: 'Gallery Shared with Client!',
                    emoji: '',
                    confetti: 30
                },
                'invoice_sent': {
                    message: 'Invoice Sent Successfully!',
                    emoji: '',
                    confetti: 25
                },
                'payment_plan_created': {
                    message: 'Payment Plan Created!',
                    emoji: '',
                    confetti: 30
                }
            };
            
            const celebration = celebrations[type];
            if (!celebration) return;
            
            // Show toast message
            showMilestoneToast(celebration.message, celebration.emoji);
            
            // Trigger confetti from multiple points
            setTimeout(() => {
                createConfetti(window.innerWidth * 0.25, -20, celebration.confetti / 2);
                createConfetti(window.innerWidth * 0.75, -20, celebration.confetti / 2);
            }, 200);
        }
        
        // Global function to trigger celebrations
        window.celebrateMilestone = celebrateMilestone;

        // Gallery Functions
        let currentGallerySessionId = null;

        function viewSessionGallery(sessionId) {
            currentGallerySessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Update gallery title
            document.getElementById('galleryTitle').textContent = `ğŸ“· ${session.clientName} - Session Gallery`;
            
            // Show gallery modal
            document.getElementById('galleryModal').classList.add('active');
            
            // Load and display photos
            loadGalleryPhotos(session);
            
            // Add tip panel for delivered sessions
            const tipPanel = document.getElementById('galleryTipPanel');
            if (session.delivered) {
                tipPanel.innerHTML = generateTipPanel(sessionId);
                tipPanel.style.display = 'block';
            } else {
                tipPanel.style.display = 'none';
            }
        }

        function loadGalleryPhotos(session) {
            const galleryGrid = document.getElementById('galleryGrid');
            const galleryEmpty = document.getElementById('galleryEmpty');
            
            if (!session.photos || session.photos.length === 0) {
                galleryGrid.style.display = 'none';
                galleryEmpty.style.display = 'block';
                return;
            }
            
            galleryEmpty.style.display = 'none';
            galleryGrid.style.display = 'grid';
            
            galleryGrid.innerHTML = session.photos.map(photo => `
                <div>
                    <img src="/uploads/${photo.filename}" alt="${photo.originalName}" loading="lazy" onclick="openPhotoLightbox('${photo.filename}')">
                    <button class="photo-delete-btn" onclick="deletePhoto('${session.id}', '${photo.filename}')" title="Delete photo">Ã—</button>
                    <div class="photo-filename">${photo.originalName}</div>
                </div>
            `).join('');
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').classList.remove('active');
            currentGallerySessionId = null;
        }

        async function deletePhoto(sessionId, filename) {
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/sessions/${sessionId}/photos/${filename}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Photo deleted successfully!', 'success');
                    
                    // Refresh session data
                    await loadSessions();
                    
                    // Refresh gallery if still open
                    if (currentGallerySessionId === sessionId) {
                        const session = sessions.find(s => s.id === sessionId);
                        if (session) {
                            loadGalleryPhotos(session);
                        }
                    }
                } else {
                    const errorData = await response.json();
                    showMessage('Failed to delete photo: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                showMessage('Error deleting photo', 'error');
            }
        }

        function openPhotoLightbox(filename) {
            // Create lightbox overlay
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = `/uploads/${filename}`;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            `;
            
            lightbox.appendChild(img);
            document.body.appendChild(lightbox);
            
            // Close on click
            lightbox.addEventListener('click', () => {
                document.body.removeChild(lightbox);
            });
            
            // Close on escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(lightbox);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Payment Plan Functions
        function openPaymentPlanModal(sessionId) {
            currentPaymentPlanSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // Pre-fill with session price
            document.getElementById('planTotalAmount').value = session.price;
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planStartDate').value = today;
            
            // Set default end date to 6 months from now
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
            document.getElementById('planEndDate').value = sixMonthsLater.toISOString().split('T')[0];
            
            document.getElementById('paymentPlanModal').classList.add('active');
        }
        
        function closePaymentPlanModal() {
            document.getElementById('paymentPlanModal').classList.remove('active');
            document.getElementById('paymentPlanSummary').style.display = 'none';
            currentPaymentPlanSessionId = null;
        }
        
        function calculatePaymentPreview() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = new Date(document.getElementById('planStartDate').value);
            const endDate = new Date(document.getElementById('planEndDate').value);
            
            if (!totalAmount || !startDate || !endDate) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Calculate months between dates
            const monthsDiff = Math.max(1, (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()));
            const monthlyPayment = (totalAmount / monthsDiff).toFixed(2);
            
            // Show summary
            const summaryElement = document.getElementById('paymentPlanSummary');
            const detailsElement = document.getElementById('paymentSummaryDetails');
            const scheduleElement = document.getElementById('paymentSchedulePreview');
            
            detailsElement.innerHTML = `
                <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                <p><strong>Number of Payments:</strong> ${monthsDiff}</p>
                <p><strong>Monthly Payment:</strong> $${monthlyPayment}</p>
                <p><strong>Period:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>
            `;
            
            // Generate payment schedule preview
            let scheduleHTML = '<h5>Payment Schedule:</h5>';
            for (let i = 0; i < Math.min(monthsDiff, 6); i++) { // Show first 6 payments
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);
                
                scheduleHTML += `
                    <div class="payment-item">
                        <div>
                            <strong>Payment ${i + 1}</strong><br>
                            <small>${paymentDate.toLocaleDateString()}</small>
                        </div>
                        <div>$${monthlyPayment}</div>
                        <div class="payment-status pending">Pending</div>
                    </div>
                `;
            }
            
            if (monthsDiff > 6) {
                scheduleHTML += `<p><small>... and ${monthsDiff - 6} more payments</small></p>`;
            }
            
            scheduleElement.innerHTML = scheduleHTML;
            summaryElement.style.display = 'block';
        }
        
        async function createPaymentPlan() {
            const totalAmount = parseFloat(document.getElementById('planTotalAmount').value);
            const startDate = document.getElementById('planStartDate').value;
            const endDate = document.getElementById('planEndDate').value;
            const reminderDays = parseInt(document.getElementById('planReminderDays').value);
            
            if (!totalAmount || !startDate || !endDate || !currentPaymentPlanSessionId) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${currentPaymentPlanSessionId}/payment-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        totalAmount,
                        startDate,
                        endDate,
                        reminderDays
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create payment plan');
                }
                
                const result = await response.json();
                
                closePaymentPlanModal();
                showMessage(`Payment plan created! ${result.payments.length} monthly payments of $${result.plan.monthlyPayment}`, 'success');
                
                // Refresh sessions to show updated data
                loadSessions();
                
                // Celebrate milestone
                celebrateMilestone('payment_plan_created', sessions.find(s => s.id === currentPaymentPlanSessionId)?.clientName || 'Client');
                
            } catch (error) {
                console.error('Error creating payment plan:', error);
                showMessage('Failed to create payment plan: ' + error.message, 'error');
            }
        }
        
        async function viewPaymentPlan(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/payment-plan`);
                
                if (!response.ok) {
                    throw new Error('Payment plan not found');
                }
                
                const paymentPlan = await response.json();
                const session = sessions.find(s => s.id === sessionId);
                
                // Update modal title
                document.getElementById('paymentPlanViewTitle').textContent = `Payment Plan - ${session?.clientName || 'Client'}`;
                
                // Generate payment plan view
                let contentHTML = `
                    <div class="payment-plan-summary">
                        <h4>ğŸ“‹ Plan Overview</h4>
                        <p><strong>Total Amount:</strong> $${parseFloat(paymentPlan.totalAmount).toFixed(2)}</p>
                        <p><strong>Monthly Payment:</strong> $${parseFloat(paymentPlan.monthlyPayment).toFixed(2)}</p>
                        <p><strong>Payments Completed:</strong> ${paymentPlan.paymentsCompleted} of ${paymentPlan.totalPayments}</p>
                        <p><strong>Amount Paid:</strong> $${parseFloat(paymentPlan.amountPaid).toFixed(2)}</p>
                        <p><strong>Remaining Balance:</strong> $${parseFloat(paymentPlan.remainingBalance).toFixed(2)}</p>
                        <p><strong>Status:</strong> <span class="payment-status ${paymentPlan.status}">${paymentPlan.status.toUpperCase()}</span></p>
                    </div>
                    
                    <div class="payment-schedule">
                        <h4>Payment Schedule</h4>
                `;
                
                for (const payment of paymentPlan.payments) {
                    const dueDate = new Date(payment.dueDate);
                    const isOverdue = dueDate < new Date() && payment.status === 'pending';
                    const statusClass = isOverdue ? 'overdue' : payment.status;
                    
                    contentHTML += `
                        <div class="payment-item">
                            <div>
                                <strong>Payment ${payment.paymentNumber}</strong><br>
                                <small>Due: ${dueDate.toLocaleDateString()}</small>
                                ${payment.paidDate ? `<br><small>Paid: ${new Date(payment.paidDate).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div>$${parseFloat(payment.amount).toFixed(2)}</div>
                            <div>
                                <div class="payment-status ${statusClass}">${payment.status.toUpperCase()}</div>
                                ${payment.status === 'pending' ? `
                                    <button class="btn btn-sm" onclick="markPaymentPaid('${payment.id}')" style="margin-top: 5px;">Mark Paid</button>
                                    <button class="btn btn-sm" onclick="sendPaymentInvoice('${payment.id}')" style="margin-top: 5px;">Send Invoice</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += '</div>';
                
                document.getElementById('paymentPlanViewContent').innerHTML = contentHTML;
                document.getElementById('paymentPlanViewModal').classList.add('active');
                
            } catch (error) {
                console.error('Error viewing payment plan:', error);
                showMessage('Failed to load payment plan: ' + error.message, 'error');
            }
        }
        
        function closePaymentPlanViewModal() {
            document.getElementById('paymentPlanViewModal').classList.remove('active');
        }
        
        async function markPaymentPaid(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentMethod: 'manual',
                        notes: 'Marked as paid by admin'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to mark payment as paid');
                }
                
                showMessage('Payment marked as paid!', 'success');
                loadSessions(); // Refresh session data
                // Re-open the payment plan view to show updated status
                setTimeout(() => {
                    if (currentPaymentPlanSessionId) {
                        viewPaymentPlan(currentPaymentPlanSessionId);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error marking payment paid:', error);
                showMessage('Failed to mark payment as paid: ' + error.message, 'error');
            }
        }
        
        async function sendPaymentInvoice(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}/send-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send invoice');
                }
                
                showMessage('Payment invoice sent successfully!', 'success');
                celebrateMilestone('invoice_sent');
                
            } catch (error) {
                console.error('Error sending payment invoice:', error);
                showMessage('Failed to send invoice: ' + error.message, 'error');
            }
        }
        
        async function processAutomatedPayments() {
            try {
                const response = await fetch('/api/payments/process-automated', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process payments');
                }
                
                const result = await response.json();
                
                showMessage(`Processing complete! ${result.results.invoicesSent} invoices sent, ${result.results.remindersSent} reminders sent`, 'success');
                
                // Refresh data
                loadSessions();
                
            } catch (error) {
                console.error('Error processing automated payments:', error);
                showMessage('Failed to process payments: ' + error.message, 'error');
            }
        }

        // Contract Management Functions
        let currentContractSessionId = null;

        async function openContractModal(sessionId) {
            currentContractSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Load existing contracts for this session
            await loadExistingContracts(sessionId);
            
            const modal = document.getElementById('contractModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            currentContractSessionId = null;
        }

        async function loadExistingContracts(sessionId) {
            // Validate sessionId before making API call
            if (!sessionId) {
                console.warn('loadExistingContracts called without valid sessionId');
                return;
            }
            
            try {
                const authToken = await getAuthToken();
                const headers = {};
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, { headers });
                if (!response.ok) {
                    throw new Error('Failed to load contracts');
                }

                const contracts = await response.json();
                const existingContractsDiv = document.getElementById('existingContractsList');
                
                if (!existingContractsDiv) {
                    console.warn('existingContractsList element not found in DOM');
                    return;
                }
                
                if (contracts.length === 0) {
                    existingContractsDiv.innerHTML = '';
                    return;
                }

                existingContractsDiv.innerHTML = `
                    <h4>Existing Contracts:</h4>
                    <div class="existing-contracts-list">
                        ${contracts.map(contract => `
                            <div class="contract-item ${contract.status}">
                                <div class="contract-item-info">
                                    <h5>${contract.contract_title}</h5>
                                    <p>Status: ${contract.status.charAt(0).toUpperCase() + contract.status.slice(1)}</p>
                                    <p>Created: ${new Date(contract.created_at).toLocaleDateString()}</p>
                                    ${contract.signed_date ? `<p>Signed: ${new Date(contract.signed_date).toLocaleDateString()}</p>` : ''}
                                </div>
                                <div class="contract-item-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editContract('${contract.id}')">
                                        âœï¸ Edit
                                    </button>
                                    ${contract.status === 'pending' ? `
                                        <button class="btn btn-primary btn-sm" onclick="sendContract('${contract.id}')">
                                            Send Contract
                                        </button>
                                    ` : contract.status === 'sent' ? `
                                        <span class="contract-status-badge sent">Sent</span>
                                    ` : contract.status === 'signed' ? `
                                        <span class="contract-status-badge signed">Signed</span>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading contracts:', error);
                showMessage('Failed to load existing contracts', 'error');
            }
        }

        async function createContract(sessionId, contractType) {
            try {
                showMessage('Creating contract...', 'info');
                
                const response = await fetch(`/api/sessions/${sessionId}/contracts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractType: contractType
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create contract');
                }

                const result = await response.json();
                
                showMessage('Contract created successfully!', 'success');
                
                // Reload the existing contracts to show the new one
                await loadExistingContracts(sessionId);
                
                // Trigger milestone celebration
                celebrateMilestone('contract_signed');
                
            } catch (error) {
                console.error('Error creating contract:', error);
                showMessage('Failed to create contract: ' + error.message, 'error');
            }
        }

        async function sendContract(contractId) {
            try {
                showMessage('Preparing contract email...', 'info');
                
                const response = await fetch(`/api/contracts/${contractId}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to prepare contract email');
                }

                const result = await response.json();
                
                // Get email data from server response
                const emailData = result.emailData;
                if (!emailData) {
                    throw new Error('Email template not available');
                }
                
                // Create mailto link with pre-filled email
                const mailtoLink = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
                
                // Open default email client
                window.location.href = mailtoLink;
                
                showMessage('Email client opened! Review and send the contract email.', 'success');
                
                // Show the signing URL for reference
                alert(`Email client opened with contract details!\n\nSigning URL: ${result.signingUrl}\n\nPlease review the email and send it to your client.`);
                
                // Reload existing contracts to update status (only if we have a valid session ID)
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error preparing contract email:', error);
                showMessage('Failed to prepare contract email: ' + error.message, 'error');
            }
        }

        // Contract Edit Functions
        let currentEditContractId = null;

        async function editContract(contractId) {
            try {
                currentEditContractId = contractId;
                
                // Fetch contract details
                const response = await fetch(`/api/contracts/${contractId}`, {
                    headers: {
                        'Authorization': `Bearer ${await getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load contract details');
                }

                const contract = await response.json();
                
                // Populate edit form
                document.getElementById('contractTitle').value = contract.contract_title;
                document.getElementById('contractContent').value = contract.contract_content;
                
                // Show edit modal
                const editModal = document.getElementById('contractEditModal');
                editModal.style.display = 'flex';
                editModal.style.alignItems = 'center';
                editModal.style.justifyContent = 'center';
                
            } catch (error) {
                console.error('Error loading contract for edit:', error);
                showMessage('Failed to load contract: ' + error.message, 'error');
            }
        }

        function closeContractEditModal() {
            document.getElementById('contractEditModal').style.display = 'none';
            currentEditContractId = null;
        }

        async function saveContractChanges(event) {
            event.preventDefault();
            
            if (!currentEditContractId) {
                showMessage('No contract selected for editing', 'error');
                return;
            }

            try {
                showMessage('Saving contract changes...', 'info');
                
                const title = document.getElementById('contractTitle').value.trim();
                const content = document.getElementById('contractContent').value.trim();
                
                if (!title || !content) {
                    showMessage('Title and content are required', 'error');
                    return;
                }

                const response = await fetch(`/api/contracts/${currentEditContractId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getAuthToken()}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save contract changes');
                }

                showMessage('Contract updated successfully!', 'success');
                closeContractEditModal();
                
                // Reload existing contracts to show the updated version
                if (currentContractSessionId) {
                    await loadExistingContracts(currentContractSessionId);
                }
                
            } catch (error) {
                console.error('Error saving contract:', error);
                showMessage('Failed to save changes: ' + error.message, 'error');
            }
        }

        // Send deposit invoice with custom amount
        async function sendDepositInvoice(sessionId) {
            try {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) {
                    showMessage('Session not found', 'error');
                    return;
                }

                // Prompt user for deposit amount
                const depositAmountInput = prompt(
                    `Enter deposit/retainer amount for ${session.clientName}:\n\nSession Total: $${session.price}\nSuggested 50%: $${(session.price * 0.5).toFixed(2)}`,
                    (session.price * 0.5).toFixed(2)
                );
                
                if (!depositAmountInput) {
                    return; // User cancelled
                }
                
                const depositAmount = parseFloat(depositAmountInput);
                
                if (isNaN(depositAmount) || depositAmount <= 0) {
                    showMessage('Please enter a valid amount greater than $0', 'error');
                    return;
                }
                
                if (depositAmount > session.price) {
                    const confirmOverage = confirm(
                        `Deposit amount ($${depositAmount}) is more than the session total ($${session.price}).\n\nDo you want to continue?`
                    );
                    if (!confirmOverage) {
                        return;
                    }
                }
                
                console.log('Creating deposit invoice for session:', session);
                showMessage('Creating deposit invoice...', 'info');
                
                const authToken = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch('/api/create-invoice', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        sessionId: session.id,
                        clientName: session.clientName,
                        email: session.email,
                        amount: depositAmount,
                        description: `Retainer for ${session.sessionType} Photography Session (Total: $${session.price})`,
                        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), // 14 days for deposit
                        isDeposit: true,
                        depositAmount: depositAmount,
                        totalAmount: session.price
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to create deposit invoice: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Deposit invoice creation result:', result);
                
                if (result.success && result.invoice_url) {
                    showMessage('Deposit invoice created successfully!', 'success');
                    
                    // Trigger celebration confetti
                    celebrateMilestone('invoice_sent', session.clientName);
                    
                    // Open the invoice URL in a new tab
                    window.open(result.invoice_url, '_blank');
                    
                    // Show a dialog with invoice details
                    const remainingBalance = session.price - depositAmount;
                    const message = `Deposit invoice created successfully!\n\nRetainer: $${depositAmount}\nRemaining Balance: $${remainingBalance.toFixed(2)}\n\nInvoice URL: ${result.invoice_url}\n\nThe invoice has been sent to ${session.email}`;
                    alert(message);
                } else {
                    throw new Error(result.error || 'Unknown error creating deposit invoice');
                }
                
            } catch (error) {
                console.error('Error creating deposit invoice:', error);
                showMessage('Error creating deposit invoice: ' + error.message, 'error');
            }
        }

        // Get authentication token helper function
        async function getAuthToken() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    return 'authenticated'; // Simplified token for authenticated requests
                }
                return null;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Set active nav tab
            event.target.classList.add('active');
            
            // Initialize website builder if switching to websites tab
            if (tabName === 'websites') {
                initializeWebsiteBuilder();
            }
        }

        // Photography Website Builder Functionality
        let currentTemplate = null;
        window.websiteSettings = window.websiteSettings || {
            businessName: 'The Legacy Photography',
            tagline: 'Capturing Timeless Moments',
            aboutText: 'Professional photographer specializing in weddings, portraits, and special moments. Creating beautiful memories that last a lifetime.',
            contactPhone: '843-485-1315',
            contactEmail: 'lance@thelegacyphotography.com',
            primaryColor: '#D4AF37',
            backgroundColor: '#1a1a1a',
            textColor: '#ffffff',
            fontStyle: 'serif',
            galleryLayout: 'grid',
            websiteUrl: '',
            seoTitle: 'The Legacy Photography - Professional Wedding & Portrait Photographer',
            seoDescription: 'Professional photography services specializing in weddings, portraits, and special moments. Book your session today.',
            portfolioPhotos: []
        };

        function initializeWebsiteBuilder() {
            console.log('Initializing photography website builder...');
            // Show template selection by default
            showTemplateSelection();
        }

        function showTemplateSelection() {
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('websiteCustomization').style.display = 'none';
        }

        function selectTemplate(templateType) {
            currentTemplate = templateType;
            
            // Update UI
            document.getElementById('templateSelection').style.display = 'none';
            document.getElementById('websiteCustomization').style.display = 'block';
            document.getElementById('selectedTemplateName').textContent = `Customizing: ${getTemplateDisplayName(templateType)}`;
            
            // Load template-specific default settings
            loadTemplateDefaults(templateType);
            
            // Generate initial preview
            updateWebsitePreview();
            
            showMessage(`${getTemplateDisplayName(templateType)} template selected!`, 'success');
            celebrateMilestone('session_created', `${getTemplateDisplayName(templateType)} Website`);
        }

        function getTemplateDisplayName(templateType) {
            const names = {
                legacy: 'Legacy Style',
                modern: 'Modern Portfolio',
                romantic: 'Romantic Style',
                bold: 'Bold & Dramatic'
            };
            return names[templateType] || templateType;
        }

        function loadTemplateDefaults(templateType) {
            const templateDefaults = {
                legacy: {
                    primaryColor: '#D4AF37',
                    backgroundColor: '#1a1a1a',
                    textColor: '#ffffff',
                    fontStyle: 'serif'
                },
                modern: {
                    primaryColor: '#667eea',
                    backgroundColor: '#ffffff',
                    textColor: '#2d3748',
                    fontStyle: 'sans-serif'
                },
                romantic: {
                    primaryColor: '#d4a574',
                    backgroundColor: '#fdf7f0',
                    textColor: '#8b5a3c',
                    fontStyle: 'serif'
                },
                bold: {
                    primaryColor: '#ffffff',
                    backgroundColor: '#000000',
                    textColor: '#ffffff',
                    fontStyle: 'sans-serif'
                }
            };

            const defaults = templateDefaults[templateType];
            if (defaults) {
                Object.assign(websiteSettings, defaults);
                updateFormFields();
            }
        }

        function backToTemplates() {
            // Reset current template
            currentTemplate = null;
            
            // Show template selection
            document.getElementById('templateSelection').style.display = 'block';
            document.getElementById('websiteCustomization').style.display = 'none';
            
            showMessage('Back to template selection', 'info');
        }

        function showCustomizationSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.customization-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Customization').classList.add('active');
            
            // Update tab states
            document.querySelectorAll('.customization-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function updateFormFields() {
            // Update form fields with current settings
            document.getElementById('businessName').value = websiteSettings.businessName;
            document.getElementById('tagline').value = websiteSettings.tagline;
            document.getElementById('aboutText').value = websiteSettings.aboutText;
            document.getElementById('contactPhone').value = websiteSettings.contactPhone;
            document.getElementById('contactEmail').value = websiteSettings.contactEmail;
            document.getElementById('primaryColor').value = websiteSettings.primaryColor;
            document.getElementById('backgroundColor').value = websiteSettings.backgroundColor;
            document.getElementById('textColor').value = websiteSettings.textColor;
            document.getElementById('fontStyle').value = websiteSettings.fontStyle;
            document.getElementById('galleryLayout').value = websiteSettings.galleryLayout;
            document.getElementById('websiteUrl').value = websiteSettings.websiteUrl;
            document.getElementById('seoTitle').value = websiteSettings.seoTitle;
            document.getElementById('seoDescription').value = websiteSettings.seoDescription;
        }

        function updateWebsiteContent() {
            // Update settings from form fields
            websiteSettings.businessName = document.getElementById('businessName').value;
            websiteSettings.tagline = document.getElementById('tagline').value;
            websiteSettings.aboutText = document.getElementById('aboutText').value;
            websiteSettings.contactPhone = document.getElementById('contactPhone').value;
            websiteSettings.contactEmail = document.getElementById('contactEmail').value;
            
            // Update preview
            updateWebsitePreview();
        }

        function updateWebsiteDesign() {
            // Update design settings from form fields
            websiteSettings.primaryColor = document.getElementById('primaryColor').value;
            websiteSettings.backgroundColor = document.getElementById('backgroundColor').value;
            websiteSettings.textColor = document.getElementById('textColor').value;
            websiteSettings.fontStyle = document.getElementById('fontStyle').value;
            
            // Update preview
            updateWebsitePreview();
        }

        function updateGallerySettings() {
            websiteSettings.galleryLayout = document.getElementById('galleryLayout').value;
            updateWebsitePreview();
        }

        function updateWebsiteSettings() {
            websiteSettings.websiteUrl = document.getElementById('websiteUrl').value;
            websiteSettings.seoTitle = document.getElementById('seoTitle').value;
            websiteSettings.seoDescription = document.getElementById('seoDescription').value;
        }

        function handlePhotoUpload() {
            const files = document.getElementById('portfolioPhotos').files;
            const photoPreview = document.getElementById('photoPreview');
            
            photoPreview.innerHTML = '';
            websiteSettings.portfolioPhotos = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    websiteSettings.portfolioPhotos.push({
                        url: e.target.result,
                        name: file.name
                    });
                    
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-preview-item';
                    photoItem.innerHTML = `<img src="${e.target.result}" alt="${file.name}">`;
                    photoPreview.appendChild(photoItem);
                    
                    updateWebsitePreview();
                };
                
                reader.readAsDataURL(file);
            }
        }

        function setPreviewDevice(device) {
            const previewFrame = document.getElementById('websitePreview');
            const controls = document.querySelectorAll('.preview-control');
            
            // Remove active class from all controls
            controls.forEach(control => control.classList.remove('active'));
            
            // Add active class to selected control
            event.target.classList.add('active');
            
            // Update preview frame class
            previewFrame.className = `website-preview-frame ${device}`;
        }

        function updateWebsitePreview() {
            if (!currentTemplate) return;
            
            const previewFrame = document.getElementById('websitePreview');
            const websiteHTML = generateWebsiteHTML();
            
            previewFrame.innerHTML = websiteHTML;
        }

        function generateWebsiteHTML() {
            const templates = {
                legacy: generateLegacyTemplate(),
                modern: generateModernTemplate(),
                romantic: generateRomanticTemplate(),
                bold: generateBoldTemplate()
            };
            
            return templates[currentTemplate] || templates.legacy;
        }

        function generateLegacyTemplate() {
            const galleryPhotos = websiteSettings.portfolioPhotos.length > 0 
                ? websiteSettings.portfolioPhotos.slice(0, 6)
                : [
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPortfolio%3C/text%3E%3C/svg%3E', name: 'sample1' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPhoto 1%3C/text%3E%3C/svg%3E', name: 'sample2' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23333" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23D4AF37" font-size="16"%3EPhoto 2%3C/text%3E%3C/svg%3E', name: 'sample3' }
                ];

            return `
                <div style="font-family: ${websiteSettings.fontStyle === 'serif' ? 'Georgia, serif' : websiteSettings.fontStyle === 'script' ? 'Dancing Script, cursive' : 'Arial, sans-serif'}; background: ${websiteSettings.backgroundColor}; color: ${websiteSettings.textColor}; min-height: 100vh;">
                    <!-- Header -->
                    <header style="background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #2d2d2d 100%); padding: 20px; text-align: center; border-bottom: 2px solid ${websiteSettings.primaryColor};">
                        <h1 style="color: ${websiteSettings.primaryColor}; font-size: 2.5rem; margin: 0;">${websiteSettings.businessName}</h1>
                        <nav style="margin-top: 15px;">
                            <a href="#home" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Home</a>
                            <a href="#portfolio" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Portfolio</a>
                            <a href="#about" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">About</a>
                            <a href="#contact" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none; opacity: 0.8;">Contact</a>
                        </nav>
                    </header>

                    <!-- Hero Section -->
                    <section style="padding: 100px 20px; text-align: center; background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #2d2d2d 100%);">
                        <h2 style="font-size: 3.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 20px;">${websiteSettings.tagline}</h2>
                        <p style="font-size: 1.3rem; color: ${websiteSettings.textColor}; opacity: 0.9; max-width: 600px; margin: 0 auto 40px auto;">${websiteSettings.aboutText}</p>
                        <button style="background: ${websiteSettings.primaryColor}; color: ${websiteSettings.backgroundColor}; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;">Book Your Session</button>
                    </section>

                    <!-- Portfolio Gallery -->
                    <section style="padding: 80px 20px; background: ${websiteSettings.backgroundColor};">
                        <h3 style="text-align: center; font-size: 2.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 50px;">Portfolio</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                            ${galleryPhotos.map(photo => `
                                <div style="aspect-ratio: 4/3; overflow: hidden; border-radius: 8px; border: 2px solid ${websiteSettings.primaryColor};">
                                    <img src="${photo.url}" alt="${photo.name}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Contact Section -->
                    <section style="padding: 80px 20px; background: linear-gradient(135deg, #2d2d2d 0%, ${websiteSettings.backgroundColor} 100%); text-align: center;">
                        <h3 style="font-size: 2.5rem; color: ${websiteSettings.primaryColor}; margin-bottom: 30px;">Contact</h3>
                        <p style="font-size: 1.2rem; color: ${websiteSettings.textColor}; margin-bottom: 20px;">Ready to capture your special moments?</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.3rem; margin-bottom: 10px;">${websiteSettings.contactPhone}</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.1rem;">${websiteSettings.contactEmail}</p>
                    </section>

                    <!-- Footer -->
                    <footer style="background: ${websiteSettings.backgroundColor}; padding: 40px 20px; text-align: center; border-top: 1px solid ${websiteSettings.primaryColor};">
                        <p style="color: ${websiteSettings.textColor}; opacity: 0.7;">Â© 2025 ${websiteSettings.businessName}. All rights reserved.</p>
                    </footer>
                </div>
            `;
        }

        function previewWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            showMessage('Generating full website preview...', 'info');
            
            const websiteHTML = generateWebsiteHTML();
            const previewHTML = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${websiteSettings.seoTitle}</title>
                    <meta name="description" content="${websiteSettings.seoDescription}">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { line-height: 1.6; }
                        @media (max-width: 768px) {
                            [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
                            [style*="font-size: 3.5rem"] { font-size: 2.5rem !important; }
                            [style*="font-size: 2.5rem"] { font-size: 1.8rem !important; }
                            [style*="padding: 100px"] { padding: 50px 20px !important; }
                            [style*="padding: 80px"] { padding: 40px 20px !important; }
                        }
                    </style>
                </head>
                <body>
                    ${websiteHTML}
                </body>
                </html>
            `;
            
            const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
            
            showMessage('Website preview opened in new tab!', 'success');
            celebrateMilestone('gallery_shared', 'Website Preview');
        }

        function generateModernTemplate() {
            const galleryPhotos = websiteSettings.portfolioPhotos.length > 0 
                ? websiteSettings.portfolioPhotos.slice(0, 6)
                : [
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EModern%3C/text%3E%3C/svg%3E', name: 'sample1' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EPhoto 1%3C/text%3E%3C/svg%3E', name: 'sample2' },
                    { url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect fill="%23f8fafc" width="300" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23667eea" font-size="16"%3EPhoto 2%3C/text%3E%3C/svg%3E', name: 'sample3' }
                ];

            return `
                <div style="font-family: ${websiteSettings.fontStyle === 'serif' ? 'Georgia, serif' : websiteSettings.fontStyle === 'script' ? 'Dancing Script, cursive' : 'Arial, sans-serif'}; background: ${websiteSettings.backgroundColor}; color: ${websiteSettings.textColor}; min-height: 100vh;">
                    <!-- Header -->
                    <header style="background: ${websiteSettings.backgroundColor}; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h1 style="color: ${websiteSettings.primaryColor}; font-size: 2.5rem; margin: 0; font-weight: 300;">${websiteSettings.businessName}</h1>
                        <nav style="margin-top: 15px;">
                            <a href="#home" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Home</a>
                            <a href="#portfolio" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Portfolio</a>
                            <a href="#about" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">About</a>
                            <a href="#contact" style="color: ${websiteSettings.textColor}; margin: 0 20px; text-decoration: none;">Contact</a>
                        </nav>
                    </header>

                    <!-- Hero Section -->
                    <section style="padding: 120px 20px; text-align: center; background: linear-gradient(135deg, ${websiteSettings.backgroundColor} 0%, #f8fafc 100%);">
                        <h2 style="font-size: 4rem; color: ${websiteSettings.primaryColor}; margin-bottom: 20px; font-weight: 100;">${websiteSettings.tagline}</h2>
                        <p style="font-size: 1.2rem; color: ${websiteSettings.textColor}; opacity: 0.8; max-width: 600px; margin: 0 auto 40px auto;">${websiteSettings.aboutText}</p>
                        <button style="background: ${websiteSettings.primaryColor}; color: white; padding: 15px 40px; border: none; border-radius: 30px; font-size: 1rem; cursor: pointer; font-weight: 500;">Get Started</button>
                    </section>

                    <!-- Portfolio Gallery -->
                    <section style="padding: 100px 20px; background: ${websiteSettings.backgroundColor};">
                        <h3 style="text-align: center; font-size: 3rem; color: ${websiteSettings.textColor}; margin-bottom: 60px; font-weight: 200;">Portfolio</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
                            ${galleryPhotos.map(photo => `
                                <div style="aspect-ratio: 4/3; overflow: hidden; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                    <img src="${photo.url}" alt="${photo.name}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;">
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Contact Section -->
                    <section style="padding: 100px 20px; background: linear-gradient(135deg, #f8fafc 0%, ${websiteSettings.backgroundColor} 100%); text-align: center;">
                        <h3 style="font-size: 3rem; color: ${websiteSettings.textColor}; margin-bottom: 30px; font-weight: 200;">Let's Connect</h3>
                        <p style="font-size: 1.1rem; color: ${websiteSettings.textColor}; margin-bottom: 30px; opacity: 0.8;">Ready to create something beautiful together?</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.4rem; margin-bottom: 10px; font-weight: 500;">${websiteSettings.contactPhone}</p>
                        <p style="color: ${websiteSettings.primaryColor}; font-size: 1.1rem;">${websiteSettings.contactEmail}</p>
                    </section>

                    <!-- Footer -->
                    <footer style="background: ${websiteSettings.textColor}; padding: 40px 20px; text-align: center;">
                        <p style="color: ${websiteSettings.backgroundColor}; opacity: 0.7;">Â© 2025 ${websiteSettings.businessName}. Crafted with care.</p>
                    </footer>
                </div>
            `;
        }

        function generateRomanticTemplate() {
            return generateLegacyTemplate(); // Use legacy template structure with romantic colors
        }

        function generateBoldTemplate() {
            return generateModernTemplate(); // Use modern template structure with bold colors
        }

        function publishWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            showMessage('Publishing website...', 'info');
            
            setTimeout(() => {
                const websiteUrl = websiteSettings.websiteUrl || websiteSettings.businessName.toLowerCase().replace(/\s+/g, '-');
                const publishedUrl = `https://${websiteUrl}.replit.app`;
                showMessage('Website published successfully!', 'success');
                celebrateMilestone('session_delivered', websiteSettings.businessName);
                
                alert(`Website Published!\n\nLive URL: ${publishedUrl}\n\nYour photography website is now live and ready for clients. Share this link to showcase your work!`);
            }, 2000);
        }

        // Website builder utility functions
        function resetWebsiteBuilder() {
            currentTemplate = null;
            websiteSettings = {
                businessName: 'The Legacy Photography',
                tagline: 'Capturing Timeless Moments',
                aboutText: 'Professional photographer specializing in weddings, portraits, and special moments. Creating beautiful memories that last a lifetime.',
                contactPhone: '843-485-1315',
                contactEmail: 'lance@thelegacyphotography.com',
                primaryColor: '#D4AF37',
                backgroundColor: '#1a1a1a',
                textColor: '#ffffff',
                fontStyle: 'serif',
                galleryLayout: 'grid',
                websiteUrl: '',
                seoTitle: 'The Legacy Photography - Professional Wedding & Portrait Photographer',
                seoDescription: 'Professional photography services specializing in weddings, portraits, and special moments. Book your session today.',
                portfolioPhotos: []
            };
            showTemplateSelection();
        }

        // Template Loading Functions
        function showTemplateLoading(templateType) {
            showMessage(`Loading ${getTemplateDisplayName(templateType)} template...`, 'info');
            
            // Show loading animation
            setTimeout(() => {
                selectTemplate(templateType);
            }, 800);
        }

        // Website Save/Load Functions
        function saveWebsite() {
            if (!currentTemplate) {
                showMessage('Please select a template first', 'error');
                return;
            }
            
            const websiteData = {
                template: currentTemplate,
                settings: websiteSettings,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('photography_website', JSON.stringify(websiteData));
            showMessage('Website saved successfully!', 'success');
        }

        function loadSavedWebsite() {
            const savedData = localStorage.getItem('photography_website');
            if (savedData) {
                const websiteData = JSON.parse(savedData);
                currentTemplate = websiteData.template;
                websiteSettings = websiteData.settings;
                
                selectTemplate(currentTemplate);
                showMessage('Saved website loaded!', 'success');
            } else {
                showMessage('No saved website found', 'error');
            }
        }

        // End of Photography Website Builder
        // ========================================
        // REVOLUTIONARY WEBSITE BUILDER FUNCTIONS
        // ========================================

        // Website Builder State
        let builderMode = 'template';
        let brandSettings = {
            logo: 'attached_assets/logo_1753330290399.png',
            businessName: 'The Legacy Photography',
            primaryFont: 'system',
            colors: {
                primary: '#d4af37',
                secondary: '#f4e4bc',
                accent: '#8b7355',
                text: '#ffffff'
            }
        };
        let selectedElement = null;
        
        // REVOLUTIONARY LIGHTBOX GALLERY SYSTEM
        function openLightbox(imageUrl, description) {
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.95); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
                backdrop-filter: blur(15px); animation: lightboxFadeIn 0.4s ease;
            `;
            
            lightbox.innerHTML = `
                <div onclick="event.stopPropagation()" style="max-width: 90%; max-height: 90%; text-align: center; animation: lightboxZoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                    <img src="${imageUrl}" style="max-width: 100%; max-height: 80vh; border-radius: 15px; box-shadow: 0 25px 80px rgba(0,0,0,0.8), 0 0 40px rgba(212,175,55,0.3);">
                    <p style="color: #f4e4bc; margin-top: 25px; font-size: 1.3em; font-style: italic; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">${description}</p>
                    <button onclick="document.body.removeChild(this.closest('.revolutionary-lightbox'))" style="margin-top: 25px; background: linear-gradient(135deg, #d4af37, #f4e4bc); color: #1a1a1a; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 8px 25px rgba(212,175,55,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">âœ¨ Close Gallery</button>
                </div>
                <style>
                    @keyframes lightboxFadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes lightboxZoomIn { from { transform: scale(0.7) rotate(-5deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
                    @keyframes pulse-invite { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
                    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-8px); } 60% { transform: translateY(-4px); } }
                    @keyframes galleryBounce { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
                </style>
            `;
            
            lightbox.className = 'revolutionary-lightbox';
            lightbox.onclick = () => document.body.removeChild(lightbox);
            document.body.appendChild(lightbox);
        }
        
        // SMOOTH SCROLL TO GALLERY WITH BOUNCE EFFECT
        function scrollToGallery() {
            const gallery = document.getElementById('photoGallery') || document.querySelector('[style*="Featured Work"]').parentElement;
            if (gallery) {
                gallery.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a subtle bounce animation to the gallery
                setTimeout(() => {
                    gallery.style.animation = 'galleryBounce 0.6s ease-out';
                    setTimeout(() => { gallery.style.animation = ''; }, 600);
                }, 800);
            }
        }

        // CONTACT FORM FUNCTIONALITY
        function sendContactEmail() {
            const name = document.getElementById('contactName')?.value || '';
            const email = document.getElementById('contactEmail')?.value || '';
            const phone = document.getElementById('contactPhone')?.value || '';
            const message = document.getElementById('contactMessage')?.value || '';

            if (!name || !email || !message) {
                alert('Please fill in your name, email, and message before sending.');
                return;
            }

            const subject = `Photography Inquiry from ${name}`;
            const body = `Hi Lance,

${message}

Contact Details:
- Name: ${name}
- Email: ${email}
${phone ? `- Phone: ${phone}` : ''}

Looking forward to hearing from you!

Best regards,
${name}`;

            const mailtoLink = `mailto:lance@thelegacyphotography.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_self');
        }

        function sendQuickText() {
            const name = document.getElementById('contactName')?.value || 'Someone';
            const message = `Hi Lance! ${name} here. I found your website and absolutely love your photography style! I'm interested in booking a session. When are you available to chat about my vision?`;
            const smsLink = `sms:8434851315?&body=${encodeURIComponent(message)}`;
            window.open(smsLink, '_self');
        }

        // Builder Mode Switching
        function switchBuilderMode(mode) {
            builderMode = mode;
            
            // Update button states
            document.getElementById('templateModeBtn').classList.toggle('active', mode === 'template');
            document.getElementById('customModeBtn').classList.toggle('active', mode === 'custom');
            
            // Show/hide appropriate interface
            document.getElementById('templateGalleryMode').classList.toggle('active', mode === 'template');
            document.getElementById('customBuilderMode').classList.toggle('active', mode === 'custom');
            
            console.log(`ğŸ”„ Switched to ${mode} mode`);
        }

        // Template System
        function useTemplate(templateType) {
            console.log(`ğŸ“‹ Loading ${templateType} template...`);
            
            // Switch to custom mode to show the built template
            switchBuilderMode('custom');
            
            // Clear existing content
            const websiteContent = document.getElementById('websiteContent');
            websiteContent.innerHTML = '';
            
            // Generate template based on type
            generateTemplate(templateType);
            
            // Show success message (confetti function may not be available in builder context)
            console.log('Template loaded successfully! Ready for customization.');
        }

        function generateTemplate(templateType) {
            const templates = {
                legacy: () => {
                    // Update brand colors for legacy theme
                    brandSettings.colors.primary = '#1a1a1a';
                    brandSettings.colors.secondary = '#8b7355';
                    brandSettings.colors.accent = '#d4af37';
                    
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #1a1a1a 0%, #8b7355 100%);' },
                        { type: 'about', style: 'background: #f8f6f0;' },
                        { type: 'gallery', style: 'background: white;' },
                        { type: 'services', style: 'background: #1a1a1a; color: #8b7355;' },
                        { type: 'contact', style: 'background: #8b7355;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 300, comp.style);
                        }, index * 300);
                    });
                },
                
                modern: () => {
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' },
                        { type: 'gallery', style: 'background: #f8f9fa;' },
                        { type: 'about', style: 'background: white;' },
                        { type: 'services', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' },
                        { type: 'contact', style: 'background: #2d3748; color: white;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 350, comp.style);
                        }, index * 300);
                    });
                },
                
                elegant: () => {
                    brandSettings.colors.primary = '#8B4513';
                    brandSettings.colors.secondary = '#D2B48C';
                    brandSettings.colors.accent = '#CD853F';
                    brandSettings.primaryFont = 'serif';
                    
                    const components = [
                        { type: 'hero', style: 'background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%);' },
                        { type: 'gallery', style: 'background: #FDF5E6;' },
                        { type: 'about', style: 'background: white;' },
                        { type: 'services', style: 'background: #8B4513; color: #D2B48C;' },
                        { type: 'contact', style: 'background: #D2B48C; color: #8B4513;' }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 300, comp.style);
                        }, index * 300);
                    });
                },
                
                'legacy-elite': () => {
                    // Your custom colors based on actual website
                    brandSettings.colors.primary = '#d4af37';
                    brandSettings.colors.secondary = '#8b7355';
                    brandSettings.colors.accent = '#f4e4bc';
                    brandSettings.colors.text = '#ffffff';
                    brandSettings.primaryFont = 'playfair';
                    brandSettings.businessName = 'The Legacy Photography';
                    
                    const components = [
                        { 
                            type: 'legacy-hero', 
                            style: 'background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2c1810 100%); position: relative;' 
                        },
                        { 
                            type: 'legacy-philosophy', 
                            style: 'background: linear-gradient(135deg, #2c1810 0%, #1a1a1a 100%); color: #d4af37;' 
                        },
                        { 
                            type: 'legacy-gallery', 
                            style: 'background: #0f0f0f; color: #d4af37;' 
                        },
                        { 
                            type: 'legacy-testimonials', 
                            style: 'background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%); color: #1a1a1a;' 
                        },
                        { 
                            type: 'legacy-about', 
                            style: 'background: linear-gradient(135deg, #1a1a1a 0%, #2c1810 100%); color: #f4e4bc;' 
                        },
                        { 
                            type: 'legacy-services', 
                            style: 'background: linear-gradient(135deg, #0f0f0f 0%, #2c1810 100%); color: #f4e4bc;' 
                        },
                        { 
                            type: 'legacy-contact', 
                            style: 'background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%); color: #1a1a1a;' 
                        }
                    ];
                    
                    components.forEach((comp, index) => {
                        setTimeout(() => {
                            createTemplateComponent(comp.type, index * 400, comp.style);
                        }, index * 400);
                    });
                    
                    // Show special success message for your custom template
                    setTimeout(() => {
                        console.log('ğŸ”¥ Legacy Elite template loaded! Your brand is perfectly captured!');
                    }, 2000);
                }
            };
            
            if (templates[templateType]) {
                templates[templateType]();
            }
        }

        function createTemplateComponent(type, yPosition, customStyle) {
            const element = document.createElement('div');
            element.className = 'website-component draggable-element element-enter';
            element.style.position = 'relative';
            element.style.width = '100%';
            element.style.minHeight = '300px';
            element.style.fontFamily = getFontFamily();
            element.dataset.componentType = type;
            
            const components = {
                hero: `<div style="${customStyle} padding: 80px 20px; text-align: center; color: white;">
                    <div class="logo-placeholder" style="margin-bottom: 20px; display: flex; justify-content: center;">
                        ${brandSettings.logo ? `<img src="${brandSettings.logo}" style="height: 60px; width: auto;">` : 'ğŸ¢ Logo Here'}
                    </div>
                    <h1 class="business-name" style="font-size: 3em; margin-bottom: 20px;">${brandSettings.businessName}</h1>
                    <p style="font-size: 1.4em; margin-bottom: 30px;">Capturing life's precious moments with artistic vision</p>
                    <button style="background: white; color: ${brandSettings.colors.primary}; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 18px;">View Portfolio</button>
                </div>`,
                
                gallery: `<div style="${customStyle} padding: 60px 20px;">
                    <h2 style="text-align: center; margin-bottom: 40px; color: ${brandSettings.colors.primary}; font-size: 2.5em;">Featured Work</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                        <div style="aspect-ratio: 1; background: linear-gradient(45deg, #ddd, #eee); border-radius: 8px; border: 3px solid ${brandSettings.colors.accent};"></div>
                    </div>
                </div>`,
                
                about: `<div style="${customStyle} padding: 80px 20px;">
                    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                        <h2 style="color: ${brandSettings.colors.primary}; font-size: 2.5em; margin-bottom: 30px;">About <span class="business-name">${brandSettings.businessName}</span></h2>
                        <p style="font-size: 1.3em; line-height: 1.8; color: ${brandSettings.colors.text};">We specialize in capturing the authentic emotions and beautiful moments that make your story unique. With over 10 years of experience, we bring artistic vision and technical expertise to every session, creating timeless memories that you'll treasure forever.</p>
                    </div>
                </div>`,
                
                services: `<div style="${customStyle} padding: 80px 20px;">
                    <h2 style="text-align: center; margin-bottom: 50px; font-size: 2.5em;">Our Services</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; max-width: 1000px; margin: 0 auto;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Wedding Photography</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Capturing your special day with elegance and emotion</p>
                        </div>
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Portrait Sessions</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Professional headshots and family portraits</p>
                        </div>
                        <div style="text-align: center; padding: 40px 20px;">
                            <h3 style="font-size: 1.8em; margin-bottom: 15px;">Event Photography</h3>
                            <p style="font-size: 1.1em; line-height: 1.6;">Corporate events and special celebrations</p>
                        </div>
                    </div>
                </div>`,
                
                contact: `<div style="${customStyle} padding: 80px 20px;">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h2 style="text-align: center; margin-bottom: 40px; font-size: 2.5em;">Contact <span class="business-name">${brandSettings.businessName}</span></h2>
                        <div style="display: grid; gap: 20px;">
                            <input type="text" placeholder="Your Name" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px;">
                            <input type="email" placeholder="Your Email" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px;">
                            <textarea placeholder="Tell us about your photography needs..." rows="6" style="padding: 18px; border: none; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                            <button style="background: ${brandSettings.colors.accent}; color: white; border: none; padding: 18px 30px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer;">Send Message</button>
                        </div>
                    </div>
                </div>`,

                // Custom Legacy Elite Components
                'legacy-hero': `<div style="${customStyle} padding: 120px 20px; text-align: center; position: relative; overflow: hidden; background-image: linear-gradient(rgba(15, 15, 15, 0.8), rgba(26, 26, 26, 0.9)), url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: center; background-attachment: fixed;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 70%); pointer-events: none;"></div>
                    <div style="position: relative; z-index: 1;">
                        <div class="logo-placeholder" style="margin-bottom: 40px; display: flex; justify-content: center;">
                            <img src="attached_assets/logo_1753330290399.png" style="height: 200px; width: auto; filter: drop-shadow(0 12px 24px rgba(0,0,0,0.9)) drop-shadow(0 0 30px rgba(212,175,55,0.4)) drop-shadow(0 0 60px rgba(212,175,55,0.2));">
                        </div>
                        <h2 style="font-size: 2.2em; margin-bottom: 20px; color: #f4e4bc; font-weight: 300; font-style: italic; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">Lance Casselman</h2>
                        <p style="font-size: 1.4em; margin-bottom: 40px; color: rgba(244, 228, 188, 0.95); max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">"Your Life, Your Legacy, Perfectly Captured!"</p>
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="scrollToGallery()" style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 18px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3); transform: perspective(1000px) rotateX(0deg); animation: float 3s ease-in-out infinite;">View Portfolio</button>
                            <a href="sms:8434851315?&body=Hi Lance! I found your website and I'm blown away by your photography. I'd love to discuss booking a session!" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 16px 33px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); text-decoration: none; display: inline-block; animation: pulse-glow 2s ease-in-out infinite alternate;">ğŸ“± Text: 843-485-1315</a>
                        </div>
                        
                        <!-- FLOATING PARTICLES ANIMATION -->
                        <div class="floating-particles" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden;">
                            <div style="position: absolute; width: 4px; height: 4px; background: #d4af37; border-radius: 50%; opacity: 0.6; animation: float-particle 8s linear infinite; top: 20%; left: 10%;"></div>
                            <div style="position: absolute; width: 6px; height: 6px; background: #f4e4bc; border-radius: 50%; opacity: 0.4; animation: float-particle 12s linear infinite; top: 60%; left: 80%; animation-delay: -2s;"></div>
                            <div style="position: absolute; width: 3px; height: 3px; background: #d4af37; border-radius: 50%; opacity: 0.7; animation: float-particle 10s linear infinite; top: 40%; left: 30%; animation-delay: -5s;"></div>
                            <div style="position: absolute; width: 5px; height: 5px; background: #f4e4bc; border-radius: 50%; opacity: 0.5; animation: float-particle 15s linear infinite; top: 80%; left: 60%; animation-delay: -8s;"></div>
                        </div>
                    </div>
                </div>`,

                'legacy-philosophy': `<div style="${customStyle} padding: 100px 20px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://images-pw.pixieset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg'); background-size: cover; background-position: center; opacity: 0.15; background-attachment: fixed;"></div>
                    <div style="position: relative; z-index: 1; max-width: 1000px; margin: 0 auto; text-align: center;">
                        <h2 style="color: #d4af37; font-size: 3em; margin-bottom: 40px; font-family: 'Playfair Display', serif; font-weight: 400; font-style: italic; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Capturing Unforgettable South Carolina Moments</h2>
                        <div style="font-size: 1.4em; line-height: 1.8; color: #f4e4bc; margin-bottom: 40px;">
                            <p style="margin-bottom: 25px; font-style: italic; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">"Time doesn't wait... We blink and the kids are grown... We laugh and the moment slips away..."</p>
                            <p style="margin-bottom: 25px; color: #d4af37; font-weight: 500; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 1.2em;">"But through photography, we get to hold on."</p>
                            <p style="margin-bottom: 25px; text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">I created this brand to honor that ideaâ€”to give families, couples, and individuals a way to capture life exactly as it isâ€¦ and to make sure it lives on.</p>
                            <p style="color: #d4af37; font-weight: 500; font-size: 1.2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px; backdrop-filter: blur(10px);">"You bring your story, your people, your loveâ€”I bring the lens, the light, and the vision to preserve it forever. Together, we create something timeless."</p>
                        </div>
                    </div>
                </div>`,

                'legacy-gallery': `<div style="${customStyle} padding: 100px 20px;">
                    <h2 style="text-align: center; margin-bottom: 60px; color: #d4af37; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400;">Featured Work</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto;">
                        <div onclick="openLightbox('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg', 'Dramatic portrait with stunning architectural elements and cinematic lighting - captured during a Charleston session')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #d4af37, #f4e4bc); color: #1a1a1a; padding: 8px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">âœ¨ Featured</div>
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Dramatic Portraits</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg', 'Breathtaking beach silhouette at golden hour with dramatic sky - the magic of Myrtle Beach sunsets')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/GG3m0E3/20240716184620-DSC_6267-111f5677-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)';" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Beach Silhouettes</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg', 'Beautiful Myrtle Beach photography session with natural lighting and genuine emotion captured')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Myrtle Beach Sessions</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixiuset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg', 'Heartwarming family portrait capturing genuine emotions, connections, and the love that binds us together')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixiuset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg'); background-size: cover; background-position: center; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Family Moments</div>
                        </div>
                        <div onclick="openLightbox('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg', 'Stunning Charleston architecture providing the perfect historic backdrop for timeless portraits')" style="aspect-ratio: 4/5; background-image: url('https://images-pw.pixieset.com/elementfield/na3yK1b/DSC_3189-e16d3c7e-1500.jpg'); background-size: cover; background-position: top; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: perspective(1000px) rotateX(0deg);" onmouseover="this.style.transform='perspective(1000px) rotateX(-8deg) rotateY(-5deg) scale(1.08)'; this.style.boxShadow='0 25px 50px rgba(212,175,55,0.6), 0 15px 30px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)'; this.style.boxShadow='none'">
                            <div style="position: absolute; bottom: 15px; left: 15px; color: white; font-weight: bold; background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(212,175,55,0.3);">Charleston Architecture</div>
                        </div>
                        <div style="aspect-ratio: 4/5; background: linear-gradient(135deg, #8b7355 0%, #d4af37 50%, #f4e4bc 100%); border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #1a1a1a; font-size: 1.2em; text-align: center; font-family: 'Playfair Display', serif; cursor: pointer; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);" onclick="window.open('sms:8434851315?&body=Hi Lance! I absolutely love your photography style and would like to book a session. When are you available?', '_self')" onmouseover="this.style.transform='scale(1.1) rotate(3deg)'; this.style.boxShadow='0 20px 40px rgba(212,175,55,0.4)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='none'">
                            <div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 12px; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.1); animation: pulse-invite 3s ease-in-out infinite;">
                                <div style="font-size: 2.5em; margin-bottom: 15px; animation: bounce 2s ease-in-out infinite; color: #d4af37;">â—</div>
                                <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">Book Your Session</div>
                                <div style="font-size: 0.9em; opacity: 0.8; color: #8b7355;">Tap to Get Started</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 50px;">
                        <button style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 18px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer;">View Complete Portfolio</button>
                    </div>
                </div>`,

                'legacy-about': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center;">
                            <div>
                                <h2 style="color: #d4af37; font-size: 3em; margin-bottom: 30px; font-family: 'Playfair Display', serif; font-weight: 400;">My Goal For You</h2>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #f4e4bc; margin-bottom: 25px;">My goal for you is more than just taking pictures â€” it's to create something that moves you every single time you look back.</p>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #f4e4bc; margin-bottom: 25px;">I want you to feel proud, radiant, and seen. I want your photos to transport you back to those moments â€” the laughter, the love, the light in your eyes â€” with all the depth and emotion still intact.</p>
                                <p style="font-size: 1.3em; line-height: 1.8; color: #d4af37; font-weight: 500;">Because your story matters. And it deserves to be captured in a way that feels just as unforgettable as the moments themselves.</p>
                            </div>
                            <div style="background-image: url('https://images-pw.pixieset.com/elementfield/ovnXqmk/DSC_0179-935598a7-1500.jpg'); background-size: cover; background-position: center; aspect-ratio: 4/5; border-radius: 12px; border: 3px solid #d4af37; position: relative; overflow: hidden;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; text-align: center;">
                                    <p style="color: #d4af37; font-weight: bold; font-size: 1.1em; margin: 0;">South Carolina Coast</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`,

                'legacy-contact': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: 20px; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400;">Ready to Capture Your Legacy?</h2>
                        <p style="font-size: 1.4em; margin-bottom: 50px; line-height: 1.6;">Call or Text 843-485-1315 or Submit a Message Below</p>
                        <div style="display: grid; gap: 20px; margin-bottom: 40px;">
                            <input id="contactName" type="text" placeholder="Your Name" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <input id="contactEmail" type="email" placeholder="Your Email" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <input id="contactPhone" type="tel" placeholder="Your Phone Number (optional)" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'">
                            <textarea id="contactMessage" placeholder="Tell me about your photography vision..." rows="6" style="padding: 20px; border: 2px solid #8b7355; border-radius: 8px; font-size: 16px; resize: vertical; background: rgba(255,255,255,0.95); transition: all 0.3s ease;" onfocus="this.style.borderColor='#d4af37'; this.style.boxShadow='0 0 10px rgba(212,175,55,0.3)'" onblur="this.style.borderColor='#8b7355'; this.style.boxShadow='none'"></textarea>
                            <button onclick="sendContactEmail()" style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; border: none; padding: 20px 35px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212,175,55,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(212,175,55,0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(212,175,55,0.3)'">Send Email</button>
                        </div>
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                            <a href="sms:8434851315?&body=Hi Lance! I'm interested in booking a photo session with The Legacy Photography. I found your website and love your style! When are you available?" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Text Message</a>
                            <a href="tel:8434851315" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Call Direct</a>
                            <button onclick="sendQuickText()" style="background: rgba(26, 26, 26, 0.8); color: #d4af37; border: 2px solid #d4af37; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);" onmouseover="this.style.background='#d4af37'; this.style.color='#1a1a1a'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.8)'; this.style.color='#d4af37'; this.style.transform='translateY(0px)'">Quick Booking</button>
                        </div>
                    </div>
                </div>`,

                // NEW MIND-BLOWING COMPONENTS
                'legacy-testimonials': `<div style="${customStyle} padding: 100px 20px;">
                    <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                        <h2 style="color: #1a1a1a; font-size: 3em; margin-bottom: 60px; font-family: 'Playfair Display', serif; font-weight: 400; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">What Clients Say</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px;">
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">â­â­â­â­â­</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"Lance captured our family perfectly! The photos are absolutely stunning and we treasure them every day. His artistic vision is incredible."</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Sarah & Mike Johnson</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Family Portrait Session</div>
                            </div>
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">â­â­â­â­â­</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"Our wedding photos are pure magic! Lance has an incredible eye for capturing those perfect, emotional moments that tell our love story."</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Jennifer & David Chen</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Wedding Photography</div>
                            </div>
                            <div style="background: rgba(26, 26, 26, 0.9); padding: 40px; border-radius: 16px; border: 2px solid rgba(212, 175, 55, 0.3); backdrop-filter: blur(10px); position: relative;">
                                <div style="position: absolute; top: -15px; left: 40px; background: #d4af37; color: #1a1a1a; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">â­â­â­â­â­</div>
                                <p style="color: #f4e4bc; font-size: 1.2em; font-style: italic; line-height: 1.6; margin-bottom: 25px;">"The beach session was amazing! Lance made us feel so comfortable and the sunset photos are absolutely breathtaking. Pure artistry!"</p>
                                <div style="color: #d4af37; font-weight: bold;">â€” Amanda Rodriguez</div>
                                <div style="color: rgba(244, 228, 188, 0.7); font-size: 0.9em;">Senior Portrait Session</div>
                            </div>
                        </div>
                    </div>
                </div>`,

                'legacy-services': `<div style="${customStyle} padding: 100px 20px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://images-pw.pixieset.com/elementfield/M5P7qxd/DSC_2077-37d27fdd-1500.jpg'); background-size: cover; background-position: center; opacity: 0.1; background-attachment: fixed;"></div>
                    <div style="position: relative; z-index: 1; max-width: 1200px; margin: 0 auto;">
                        <h2 style="text-align: center; margin-bottom: 60px; color: #d4af37; font-size: 3em; font-family: 'Playfair Display', serif; font-weight: 400; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Photography Services</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px;">
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ’’</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Wedding Photography</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Capture your special day with elegance and emotion. From intimate ceremonies to grand celebrations.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $2,500</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Family Portraits</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Beautiful family moments that become treasured memories. Beach, park, or studio sessions available.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $450</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ–ï¸</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Beach Sessions</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Stunning Myrtle Beach and Charleston coast photography with golden hour lighting and ocean backdrops.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $350</div>
                            </div>
                            <div style="background: rgba(139, 115, 85, 0.9); padding: 40px; border-radius: 16px; text-align: center; border: 3px solid #d4af37; backdrop-filter: blur(10px); transition: transform 0.3s ease;">
                                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“</div>
                                <h3 style="color: #d4af37; font-size: 1.8em; margin-bottom: 15px; font-family: 'Playfair Display', serif;">Senior Portraits</h3>
                                <p style="color: #f4e4bc; font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">Celebrate this milestone with professional senior portraits that showcase personality and achievement.</p>
                                <div style="color: #d4af37; font-weight: bold; font-size: 1.3em;">Starting at $400</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 60px;">
                            <a href="sms:8434851315?&body=Hi! I'd like to discuss photography services and get a custom quote." style="background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 100%); color: #1a1a1a; text-decoration: none; padding: 20px 40px; border-radius: 12px; font-weight: bold; font-size: 1.2em; display: inline-block; box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4); transition: all 0.3s ease;">ğŸ“± Get Custom Quote</a>
                        </div>
                    </div>
                </div>`
            };
            
            element.innerHTML = components[type] || '';
            
            // Add click handler for selection
            element.addEventListener('click', (e) => {
                e.stopPropagation();
                selectElement(element);
            });
            
            // Add to canvas
            const websiteContent = document.getElementById('websiteContent');
            websiteContent.appendChild(element);
        }

        // Branding Functions
        function uploadLogo(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    brandSettings.logo = e.target.result;
                    
                    // Show logo preview
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 60px; border-radius: 4px;">`;
                    
                    // Update all logo instances on the website
                    updateLogosOnWebsite();
                    
                    console.log('Logo uploaded and applied to website');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateBusinessName() {
            const name = document.getElementById('businessName').value;
            brandSettings.businessName = name;
            
            // Update all business name instances
            const elements = document.querySelectorAll('.business-name');
            elements.forEach(el => {
                el.textContent = name;
            });
            
            console.log(`Business name updated to: ${name}`);
        }

        function changePrimaryFont(fontFamily) {
            brandSettings.primaryFont = fontFamily;
            
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                'serif': 'Georgia, "Times New Roman", serif',
                'playfair': '"Playfair Display", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'modern': '"Helvetica Neue", Helvetica, Arial, sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'roboto': '"Roboto", sans-serif'
            };
            
            // Load Google Fonts if needed
            if (['playfair', 'lora', 'crimson', 'montserrat', 'opensans', 'roboto'].includes(fontFamily)) {
                loadGoogleFont(fontFamily);
            }
            
            // Apply font to website
            const websiteContent = document.getElementById('websiteContent');
            if (websiteContent) {
                websiteContent.style.fontFamily = fontMap[fontFamily];
            }
            
            console.log(`ğŸ”¤ Font changed to: ${fontFamily}`);
        }

        // Initialize website builder when tab is opened
        function initializeWebsiteBuilder() {
            console.log('Initializing photography website builder...');
            
            // Load Playfair Display font for your template
            loadGoogleFont('playfair');
            
            // Set default business name to yours
            const businessNameInput = document.getElementById('businessName');
            if (businessNameInput) {
                businessNameInput.value = 'The Legacy Photography';
            }
            
            // Add revolutionary CSS animations to the page
            if (!document.getElementById('revolutionaryStyles')) {
                const revolutionaryCSS = document.createElement('style');
                revolutionaryCSS.id = 'revolutionaryStyles';
                revolutionaryCSS.innerHTML = `
                    /* MIND-BLOWING ANIMATIONS */
                    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-12px); } }
                    @keyframes pulse-glow { 
                        0% { box-shadow: 0 0 5px rgba(212,175,55,0.3), 0 0 10px rgba(212,175,55,0.1); } 
                        100% { box-shadow: 0 0 25px rgba(212,175,55,0.8), 0 0 35px rgba(212,175,55,0.4), 0 0 45px rgba(212,175,55,0.2); } 
                    }
                    @keyframes float-particle { 
                        0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 
                        10% { opacity: 1; }
                        90% { opacity: 1; }
                        100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } 
                    }
                    @keyframes bounce { 
                        0%, 100% { transform: translateY(0); } 
                        50% { transform: translateY(-10px); } 
                    }
                    @keyframes pulse-invite { 
                        0%, 100% { transform: scale(1) rotate(0deg); } 
                        50% { transform: scale(1.08) rotate(1deg); } 
                    }
                    @keyframes galleryBounce {
                        0% { transform: scale(1); }
                        30% { transform: scale(1.02); }
                        60% { transform: scale(0.98); }
                        100% { transform: scale(1); }
                    }
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                    @keyframes fadeInUp {
                        from { opacity: 0; transform: translateY(30px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(revolutionaryCSS);
            }
        }

        function loadGoogleFont(font) {
            const fontUrls = {
                'playfair': 'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap',
                'lora': 'https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap',
                'crimson': 'https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&display=swap',
                'montserrat': 'https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap',
                'opensans': 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap',
                'roboto': 'https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap'
            };
            
            if (!document.querySelector(`link[href="${fontUrls[font]}"]`)) {
                const link = document.createElement('link');
                link.href = fontUrls[font];
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }

        function updateBrandColor(colorType, colorValue) {
            brandSettings.colors[colorType] = colorValue;
            
            // Apply color changes to website elements would go here
            console.log(`ğŸ¨ ${colorType} color updated to: ${colorValue}`);
        }

        function updateLogosOnWebsite() {
            if (!brandSettings.logo) return;
            
            // Find and update all logo placeholders
            const logoElements = document.querySelectorAll('.logo-placeholder');
            logoElements.forEach(el => {
                el.innerHTML = `<img src="${brandSettings.logo}" style="height: 60px; width: auto;">`;
            });
        }

        function getFontFamily() {
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                'serif': 'Georgia, "Times New Roman", serif',
                'playfair': '"Playfair Display", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'modern': '"Helvetica Neue", Helvetica, Arial, sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'roboto': '"Roboto", sans-serif'
            };
            return fontMap[brandSettings.primaryFont];
        }

        // AI Functions
        function generateAILayout() {
            console.log('ğŸ¤– AI generating optimal layout...');
            alert('AI suggests: Add testimonials section to build trust! This would increase conversions by 35%.');
        }

        function optimizeForMobile() {
            console.log('ğŸ“± AI optimizing for mobile devices...');
            alert('Mobile optimization complete! Your site now loads 40% faster on mobile devices.');
        }

        function suggestColors() {
            console.log('ğŸ¨ AI analyzing your photos for color palette...');
            const palettes = [
                'Deep Blues: #2C3E50, #3498DB, #ECF0F1',
                'Warm Earth: #8B4513, #D2691E, #F4A460', 
                'Modern Minimal: #2D3748, #4A5568, #E2E8F0'
            ];
            const palette = palettes[Math.floor(Math.random() * palettes.length)];
            alert(`AI suggests color palette: ${palette}`);
        }

        function generateContent() {
            console.log('âœï¸ AI writing professional photography content...');
            alert('AI generated professional content for your sections! Check your About section for enhanced copy.');
        }

        // Device Preview Functions
        function setDevicePreview(device) {
            const canvas = document.getElementById('websiteCanvas');
            const buttons = document.querySelectorAll('.device-btn');
            
            // Update button states
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update canvas size
            canvas.className = 'website-canvas';
            if (device === 'mobile') {
                canvas.style.maxWidth = '375px';
                canvas.style.margin = '20px auto';
            } else if (device === 'tablet') {
                canvas.style.maxWidth = '768px';
                canvas.style.margin = '20px auto';
            } else {
                canvas.style.maxWidth = 'none';
                canvas.style.margin = '20px';
            }
            
            console.log(`ğŸ“± Switched to ${device} preview mode`);
        }

        // Drag and Drop Functions
        function allowDrop(e) {
            e.preventDefault();
        }

        function dropComponent(e) {
            e.preventDefault();
            const componentType = e.dataTransfer.getData('text/plain');
            if (componentType) {
                createTemplateComponent(componentType, 0, '');
                console.log(`${componentType} component added successfully!`);
            }
        }

        // Element Selection
        function selectElement(element) {
            // Remove previous selection
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            
            // Select new element
            selectedElement = element;
            element.classList.add('selected');
            
            // Show properties panel
            showPropertiesPanel(element);
        }

        function showPropertiesPanel(element) {
            const panel = document.getElementById('propertyPanel');
            panel.innerHTML = `
                <div>
                    <h4>Element Properties</h4>
                    <div style="margin: 15px 0;">
                        <label>Background Color:</label>
                        <input type="color" value="#667eea" onchange="updateElementStyle(this, 'backgroundColor')" style="width: 100%; height: 35px; border: none; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>Text Color:</label>
                        <input type="color" value="#333333" onchange="updateElementStyle(this, 'color')" style="width: 100%; height: 35px; border: none; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>Padding:</label>
                        <input type="range" min="0" max="100" value="20" onchange="updateElementStyle(this, 'padding', this.value + 'px')" style="width: 100%; margin-top: 5px;">
                    </div>
                    <button onclick="deleteElement()" style="background: rgba(0, 0, 0, 0.7); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.4); padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 15px;">
                        Delete Element
                    </button>
                </div>
            `;
        }

        function updateElementStyle(input, property, value) {
            if (selectedElement) {
                const actualValue = value || input.value;
                selectedElement.style[property] = actualValue;
            }
        }

        function deleteElement() {
            if (selectedElement) {
                selectedElement.remove();
                selectedElement = null;
                document.getElementById('propertyPanel').innerHTML = '<div class="no-selection"><p>Select an element to edit properties</p></div>';
                console.log('Element deleted successfully!');
            }
        }

        // Website Actions
        function previewWebsite() {
            console.log('ğŸ‘ï¸ Opening website preview...');
            
            // Get the website content
            const websiteContent = document.getElementById('websiteContent');
            if (!websiteContent || websiteContent.children.length === 0) {
                alert('Please select a template or add components first!');
                return;
            }
            
            // Create preview window
            const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            // Get all the custom styles
            const builderStyles = `
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }
                    .website-component { margin: 0; }
                    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&display=swap');
                </style>
            `;
            
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Website Preview - ${brandSettings.businessName}</title>
                    ${builderStyles}
                </head>
                <body>
                    ${websiteContent.innerHTML}
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            console.log('Website preview opened in new window');
        }

        function publishWebsite() {
            console.log('Publishing website...');
            
            const websiteContent = document.getElementById('websiteContent');
            if (!websiteContent || websiteContent.children.length === 0) {
                alert('Please create a website first by selecting a template or adding components!');
                return;
            }
            
            // In a real implementation, this would save to a server
            alert('Website published successfully! Your site would now be live at your custom domain.');
            console.log('Website published successfully');
        }

        // Setup drag and drop for components
        document.addEventListener('DOMContentLoaded', function() {
            const components = document.querySelectorAll('.component-item');
            components.forEach(component => {
                component.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.component);
                });
            });
        });

        // Add website component selection styles
        const websiteBuilderStyles = `
            .website-component.selected {
                outline: 2px solid #667eea !important;
                outline-offset: 2px;
            }
            
            .website-component {
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .website-component:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .element-enter {
                animation: elementEnter 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            
            @keyframes elementEnter {
                0% {
                    opacity: 0;
                    transform: scale(0.8) translateY(-20px);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
        `;
        
        // Inject styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = websiteBuilderStyles;
        document.head.appendChild(styleSheet);

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked nav tab
            const clickedTab = event.target;
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Initialize sunrise calendar if switching to that tab
            if (tabName === 'sunrise') {
                initializeSunriseCalendar();
            }
        }

        // Sunrise/Sunset Calendar Functions
        function initializeSunriseCalendar() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sunriseDate').value = today;
            
            // Clear any previous results
            document.getElementById('sunriseResults').style.display = 'none';
            document.getElementById('sunriseError').style.display = 'none';
        }

        async function getSunriseSunsetData() {
            const dateInput = document.getElementById('sunriseDate').value;
            const locationInput = document.getElementById('locationInput').value.trim();
            
            if (!dateInput || !locationInput) {
                showSunriseError('Please enter both date and location');
                return;
            }
            
            try {
                let lat, lng;
                
                // Use selected location from search results if available
                if (selectedLocation) {
                    lat = selectedLocation.lat;
                    lng = selectedLocation.lng;
                } else {
                    // Try coordinate parsing as fallback
                    const coordMatch = locationInput.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                    if (coordMatch) {
                        lat = parseFloat(coordMatch[1]);
                        lng = parseFloat(coordMatch[2]);
                    } else {
                        throw new Error('Please select a location from the search results or use coordinates like "32.7765, -79.9311"');
                    }
                }
                
                // Validate coordinates
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    throw new Error('Invalid coordinates. Latitude: -90 to 90, Longitude: -180 to 180');
                }
                
                // Fetch sunrise/sunset data
                const apiUrl = `https://api.sunrisesunset.io/json?lat=${lat}&lng=${lng}&date=${dateInput}`;
                console.log('API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch sunrise data');
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.status !== 'OK') {
                    throw new Error('Invalid response from sunrise API');
                }
                
                displaySunriseData(data.results, selectedLocation ? selectedLocation.displayName : locationInput, dateInput);
                celebrateMilestone('sunrise_data', 'Sunrise Data Loaded');
                
            } catch (error) {
                console.error('Sunrise Error:', error);
                showSunriseError(error.message);
            }
        }

        function displaySunriseData(results, location, date) {
            try {
                // Update location and date
                const locationEl = document.getElementById('sunriseLocation');
                const dateEl = document.getElementById('sunriseSelectedDate');
                
                if (locationEl) locationEl.textContent = `ğŸ“ ${location}`;
                if (dateEl) dateEl.textContent = `ğŸ“… ${new Date(date).toLocaleDateString()}`;
                
                // Update time values based on actual API response structure
                const timeElements = {
                    'sunriseTime': results.sunrise,
                    'sunsetTime': results.sunset,
                    'solarNoon': results.solar_noon,
                    'goldenHourStart': results.golden_hour,
                    'goldenHourEnd': results.dusk,
                    'blueHourEnd': results.last_light
                };
                
                Object.entries(timeElements).forEach(([elementId, value]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = value || '--:--';
                    }
                });
                
                // Show results and hide error
                const resultsEl = document.getElementById('sunriseResults');
                const errorEl = document.getElementById('sunriseError');
                
                if (resultsEl) resultsEl.style.display = 'block';
                if (errorEl) errorEl.style.display = 'none';
                
                // Add celebration animation using the correct function name
                if (typeof celebrateMilestone === 'function') {
                    celebrateMilestone('sunrise_success', 'Sunrise/Sunset Data Loaded Successfully');
                }
                
                // Show success message - check if function exists
                if (typeof showMessage === 'function') {
                    showMessage('Sunrise/sunset data loaded successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Display error:', error);
                showSunriseError('Error displaying sunrise data: ' + error.message);
            }
        }

        function getCityCoordinates(location) {
            const cities = {
                // US Major Cities
                'new york, ny': { lat: 40.7128, lng: -74.0060 },
                'new york': { lat: 40.7128, lng: -74.0060 },
                'los angeles, ca': { lat: 34.0522, lng: -118.2437 },
                'los angeles': { lat: 34.0522, lng: -118.2437 },
                'chicago, il': { lat: 41.8781, lng: -87.6298 },
                'chicago': { lat: 41.8781, lng: -87.6298 },
                'miami, fl': { lat: 25.7617, lng: -80.1918 },
                'miami': { lat: 25.7617, lng: -80.1918 },
                'charleston, sc': { lat: 32.7765, lng: -79.9311 },
                'charleston': { lat: 32.7765, lng: -79.9311 },
                'myrtle beach, sc': { lat: 33.6891, lng: -78.8867 },
                'myrtle beach': { lat: 33.6891, lng: -78.8867 },
                'columbia, sc': { lat: 34.0007, lng: -81.0348 },
                'columbia': { lat: 34.0007, lng: -81.0348 },
                'greenville, sc': { lat: 34.8526, lng: -82.3940 },
                'greenville': { lat: 34.8526, lng: -82.3940 },
                'hilton head, sc': { lat: 32.2163, lng: -80.7526 },
                'hilton head': { lat: 32.2163, lng: -80.7526 },
                'denver, co': { lat: 39.7392, lng: -104.9903 },
                'denver': { lat: 39.7392, lng: -104.9903 },
                'seattle, wa': { lat: 47.6062, lng: -122.3321 },
                'seattle': { lat: 47.6062, lng: -122.3321 },
                'san francisco, ca': { lat: 37.7749, lng: -122.4194 },
                'san francisco': { lat: 37.7749, lng: -122.4194 },
                'austin, tx': { lat: 30.2672, lng: -97.7431 },
                'austin': { lat: 30.2672, lng: -97.7431 },
                'atlanta, ga': { lat: 33.7490, lng: -84.3880 },
                'atlanta': { lat: 33.7490, lng: -84.3880 },
                
                // International Cities
                'london, uk': { lat: 51.5074, lng: -0.1278 },
                'london': { lat: 51.5074, lng: -0.1278 },
                'paris, france': { lat: 48.8566, lng: 2.3522 },
                'paris': { lat: 48.8566, lng: 2.3522 },
                'tokyo, japan': { lat: 35.6762, lng: 139.6503 },
                'tokyo': { lat: 35.6762, lng: 139.6503 },
                'sydney, australia': { lat: -33.8688, lng: 151.2093 },
                'sydney': { lat: -33.8688, lng: 151.2093 },
                'toronto, canada': { lat: 43.6532, lng: -79.3832 },
                'toronto': { lat: 43.6532, lng: -79.3832 }
            };
            
            const normalizedLocation = location.toLowerCase().trim();
            return cities[normalizedLocation] || null;
        }

        function showSunriseError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('sunriseError').style.display = 'block';
            document.getElementById('sunriseResults').style.display = 'none';
        }

        // Workflow Status Management
        async function toggleWorkflowStatus(sessionId, field, checked) {
            try {
                // Find the session in our local array
                const sessionIndex = sessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    showMessage('Session not found', 'error');
                    return;
                }

                // Update the local session object
                sessions[sessionIndex][field] = checked;

                // Send update to server
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...sessions[sessionIndex],
                        [field]: checked
                    })
                });

                if (response.ok) {
                    const updatedSession = await response.json();
                    sessions[sessionIndex] = updatedSession;
                    
                    // Show success message with celebration
                    const fieldLabels = {
                        contractSigned: 'Contract Signed',
                        paid: 'Payment Received', 
                        edited: 'Photos Edited',
                        delivered: 'Session Delivered',
                        sendReminder: 'Reminder Set',
                        notifyGalleryReady: 'Gallery Notification'
                    };
                    
                    const actionText = checked ? 'marked as complete' : 'unmarked';
                    showMessage(`${fieldLabels[field]} ${actionText} for ${sessions[sessionIndex].clientName}`, 'success');
                    
                    // Trigger celebration for major milestones
                    if (checked) {
                        if (field === 'contractSigned') {
                            celebrateMilestone('contract_signed', sessions[sessionIndex].clientName);
                        } else if (field === 'paid') {
                            celebrateMilestone('payment_received', sessions[sessionIndex].clientName);
                        } else if (field === 'delivered') {
                            celebrateMilestone('session_delivered', sessions[sessionIndex].clientName);
                        }
                    }
                } else {
                    // Revert the checkbox if server update failed
                    const checkbox = document.getElementById(`${field}_${sessionId}`);
                    if (checkbox) {
                        checkbox.checked = !checked;
                    }
                    sessions[sessionIndex][field] = !checked;
                    showMessage('Failed to update workflow status', 'error');
                }
            } catch (error) {
                console.error('Error updating workflow status:', error);
                showMessage('Error updating workflow status', 'error');
                
                // Revert the checkbox on error
                const checkbox = document.getElementById(`${field}_${sessionId}`);
                if (checkbox) {
                    checkbox.checked = !checked;
                }
                if (sessionIndex !== -1) {
                    sessions[sessionIndex][field] = !checked;
                }
            }
        }

        // Dropdown Menu Functions
        function toggleDropdown(sessionId) {
            const dropdown = document.getElementById(`dropdown-${sessionId}`);
            const toggle = dropdown.previousElementSibling;
            const isVisible = dropdown.classList.contains('show');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
                menu.style.display = 'none';
                
                // Move back to original container if it was moved to body
                if (menu.parentNode === document.body) {
                    const menuSessionId = menu.id.replace('dropdown-', '');
                    const originalContainer = document.querySelector(`[onclick*="${menuSessionId}"]`).closest('.actions-dropdown');
                    if (originalContainer) {
                        originalContainer.appendChild(menu);
                    }
                }
            });
            
            // Toggle current dropdown
            if (!isVisible) {
                dropdown.classList.add('show');
                
                // Force dropdown to use fixed positioning at viewport level
                const rect = toggle.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (rect.bottom + 5) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.style.width = Math.max(rect.width, 200) + 'px';
                dropdown.style.right = 'auto';
                dropdown.style.bottom = 'auto';
                dropdown.style.zIndex = '2147483647';
                dropdown.style.display = 'block';
                dropdown.style.visibility = 'visible';
                dropdown.style.opacity = '1';
                dropdown.style.background = '#2a2a2a';
                dropdown.style.border = '2px solid #d4af37';
                dropdown.style.borderRadius = '8px';
                dropdown.style.minHeight = '100px';
                dropdown.style.maxHeight = '400px';
                dropdown.style.overflowY = 'auto';
                dropdown.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.3)';
                
                // Move dropdown to document body to escape all container constraints
                document.body.appendChild(dropdown);
                
                console.log('Dropdown repositioned to body:', sessionId, dropdown);
                console.log('Button rect:', rect);
                console.log('Dropdown position:', dropdown.style.top, dropdown.style.left);
            }
        }

        function closeDropdown(sessionId) {
            const dropdown = document.getElementById(`dropdown-${sessionId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
                
                // Move dropdown back to its original container
                const originalParent = document.querySelector(`#dropdown-${sessionId}`).closest('.actions-dropdown');
                if (originalParent && dropdown.parentNode !== originalParent) {
                    originalParent.appendChild(dropdown);
                }
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.actions-dropdown') && !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.style.display = 'none';
                    
                    // Move dropdown back to original container if needed
                    const sessionId = menu.id.replace('dropdown-', '');
                    const originalParent = document.querySelector(`[data-session-id="${sessionId}"] .actions-dropdown`);
                    if (originalParent && menu.parentNode !== originalParent) {
                        originalParent.appendChild(menu);
                    }
                });
            }
        });

        // Reset Sunrise Calendar Function
        function resetSunriseCalendar() {
            // Clear input fields
            document.getElementById('locationInput').value = '';
            document.getElementById('sunriseDate').value = '';
            
            // Reset selected location
            selectedLocation = null;
            
            // Hide results and error sections
            document.getElementById('sunriseResults').style.display = 'none';
            document.getElementById('sunriseError').style.display = 'none';
            document.getElementById('locationResults').style.display = 'none';
            
            // Show success message
            showMessage('Sunrise/Sunset calendar reset successfully!', 'success');
            
            // Optional: Trigger confetti for reset action
            celebrateMilestone('reset', 'Calendar Reset');
        }

        // Location Search Variables
        let searchTimeout;
        let selectedLocation = null;

        // Search for locations as user types
        async function searchLocations(query) {
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    // Use a free geocoding API (Nominatim from OpenStreetMap)
                    const apiUrl = `https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    
                    const results = await response.json();
                    displayLocationResults(results);
                    
                } catch (error) {
                    console.error('Location search error:', error);
                    // Show basic fallback options
                    showFallbackLocations(query);
                }
            }, 300); // Debounce for 300ms
        }

        function displayLocationResults(results) {
            const resultsContainer = document.getElementById('locationResults');
            
            if (results.length === 0) {
                hideSearchResults();
                return;
            }
            
            resultsContainer.innerHTML = results.map(location => `
                <div class="location-result-item" onclick="selectLocation('${location.display_name}', ${location.lat}, ${location.lon})">
                    <div class="location-name">${location.display_name.split(',')[0]}</div>
                    <div class="location-details">${location.display_name}</div>
                </div>
            `).join('');
            
            resultsContainer.style.display = 'block';
        }

        function showFallbackLocations(query) {
            const fallbackLocations = [
                { name: 'Charleston, SC', lat: 32.7765, lng: -79.9311, display: 'Charleston, South Carolina, USA' },
                { name: 'Myrtle Beach, SC', lat: 33.6891, lng: -78.8867, display: 'Myrtle Beach, South Carolina, USA' },
                { name: 'New York, NY', lat: 40.7128, lng: -74.0060, display: 'New York, New York, USA' }
            ];
            
            const filtered = fallbackLocations.filter(loc => 
                loc.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length > 0) {
                const resultsContainer = document.getElementById('locationResults');
                resultsContainer.innerHTML = filtered.map(location => `
                    <div class="location-result-item" onclick="selectLocation('${location.display}', ${location.lat}, ${location.lng})">
                        <div class="location-name">${location.name}</div>
                        <div class="location-details">${location.display}</div>
                    </div>
                `).join('');
                
                resultsContainer.style.display = 'block';
            }
        }

        function selectLocation(displayName, lat, lng) {
            selectedLocation = { displayName, lat, lng };
            document.getElementById('locationInput').value = displayName.split(',')[0];
            hideSearchResults();
            
            // Show success message for location selection
            showMessage(`Location selected: ${displayName.split(',')[0]}`, 'success');
        }

        function showSearchResults() {
            const input = document.getElementById('locationInput');
            if (input.value.length >= 2) {
                document.getElementById('locationResults').style.display = 'block';
            }
        }

        function hideSearchResults() {
            document.getElementById('locationResults').style.display = 'none';
        }

        // Close search results when clicking outside (only if not already bound)
        if (!window.sunriseLocationClickHandlerBound) {
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.location-search-container')) {
                    hideSearchResults();
                }
            });
            window.sunriseLocationClickHandlerBound = true;
        }

        // Dropdown Menu Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById("toolsToggle");
            const menu = document.getElementById("toolsMenu");

            if (toggleBtn && menu) {
                toggleBtn.addEventListener("click", () => {
                    menu.classList.toggle("hidden");
                });

                window.addEventListener("click", function (e) {
                    if (!toggleBtn.contains(e.target) && !menu.contains(e.target)) {
                        menu.classList.add("hidden");
                    }
                });
            }
        });

    </script>

        </div> <!-- End Client Management Tab -->

        <!-- Sunrise/Sunset Calendar Tab Content -->
        <div id="sunriseTab" class="tab-content">
            <div class="sunrise-calendar-container">
                <div class="sunrise-header">
                    <h2>ğŸŒ… Photography Sunrise/Sunset Calendar</h2>
                    <p>Perfect lighting times for outdoor photography sessions</p>
                </div>

                <div class="sunrise-controls">
                    <div class="form-group">
                        <label for="sunriseDate">ğŸ“… Select Date</label>
                        <input type="date" id="sunriseDate" name="sunriseDate" style="padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: #2a2a2a; color: #f5f5f5; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label for="locationInput">ğŸ“ Location</label>
                        <div class="location-search-container" style="position: relative; width: 300px;">
                            <input type="text" id="locationInput" name="locationInput" placeholder="Start typing city name..." autocomplete="off" oninput="searchLocations(this.value)" onfocus="showSearchResults()" style="padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: #2a2a2a; color: #f5f5f5; font-size: 16px; width: 100%;">
                            <div id="locationResults" class="location-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #2a2a2a; border: 2px solid #d4af37; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10000;">
                            </div>
                        </div>
                        <p style="font-size: 0.85em; color: #999; margin-top: 5px;">
                            Type any city or address and select from suggestions
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="getSunriseSunsetData()" class="btn btn-primary" style="background: linear-gradient(135deg, #d4af37, #ffd700); color: #1a1a1a; font-weight: bold; padding: 12px 24px;">
                            ğŸŒ… Get Sunrise/Sunset Times
                        </button>
                        <button onclick="resetSunriseCalendar()" class="btn btn-secondary" style="background: linear-gradient(135deg, #666, #888); color: #f5f5f5; font-weight: bold; padding: 12px 24px;">
                            ğŸ”„ Reset
                        </button>
                    </div>
                </div>

                <div id="sunriseResults" class="sunrise-results" style="display: none;">
                    <div class="sunrise-card">
                        <h3 id="sunriseLocation">ğŸ“ Location</h3>
                        <p id="sunriseSelectedDate">ğŸ“… Date</p>
                        
                        <div class="sunrise-times-grid">
                            <div class="time-card sunrise">
                                <div class="time-icon">ğŸŒ…</div>
                                <div class="time-label">Sunrise</div>
                                <div class="time-value" id="sunriseTime">--:--</div>
                            </div>
                            
                            <div class="time-card golden-hour-morning">
                                <div class="time-icon">ğŸŒ‡</div>
                                <div class="time-label">Golden Hour Start</div>
                                <div class="time-value" id="goldenHourStart">--:--</div>
                            </div>
                            
                            <div class="time-card solar-noon">
                                <div class="time-icon">â˜€ï¸</div>
                                <div class="time-label">Solar Noon</div>
                                <div class="time-value" id="solarNoon">--:--</div>
                            </div>
                            
                            <div class="time-card golden-hour-evening">
                                <div class="time-icon">ğŸŒ†</div>
                                <div class="time-label">Golden Hour End</div>
                                <div class="time-value" id="goldenHourEnd">--:--</div>
                            </div>
                            
                            <div class="time-card sunset">
                                <div class="time-icon">ğŸŒ‡</div>
                                <div class="time-label">Sunset</div>
                                <div class="time-value" id="sunsetTime">--:--</div>
                            </div>
                            
                            <div class="time-card blue-hour">
                                <div class="time-icon">ğŸŒŒ</div>
                                <div class="time-label">Blue Hour End</div>
                                <div class="time-value" id="blueHourEnd">--:--</div>
                            </div>
                        </div>
                        
                        <div class="photography-tips">
                            <h4>ğŸ“¸ Photography Tips</h4>
                            <div id="photographyTips">
                                <p><strong>Golden Hour:</strong> Soft, warm light perfect for portraits and landscapes</p>
                                <p><strong>Blue Hour:</strong> Even lighting ideal for cityscapes and architecture</p>
                                <p><strong>Solar Noon:</strong> Harsh shadows - avoid outdoor portraits</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sunriseError" class="error-message" style="display: none; background: rgba(255, 0, 0, 0.1); border: 2px solid #ff0000; color: #ff6b6b; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    âŒ <span id="errorText">Error loading sunrise/sunset data</span>
                </div>
            </div>
        </div>

        <!-- Website Builder Tab Content -->
        <div id="websitesTab" class="tab-content active">
            <div class="website-builder-container">
                <!-- Advanced React Website Builder will be mounted here -->
                <div class="loading" style="text-align: center; padding: 40px;">
                    <h2>ğŸ¨ Loading Advanced Website Builder...</h2>
                    <p>Initializing drag-and-drop editor, templates, and live preview...</p>
                </div>
            </div>
        </div> <!-- End Website Builder Tab -->

     <!-- End container -->

    <!-- Contract Modal moved to end -->

    <script>
        // Advanced Website Builder is now integrated via React components
        // The old JavaScript website builder code has been replaced with React SiteBuilder
    </script>

    <!-- Contract Modal -->
    <div id="contractModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">ğŸ“ Contract Management</h3>
                <button class="contract-close-btn" onclick="closeContractModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <div class="contract-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee;">
                    <button class="contract-tab active" onclick="switchContractTab('create')" style="flex: 1; padding: 10px; background: #d4af37; color: white; border: none; border-radius: 5px 0 0 0; cursor: pointer;">Create New</button>
                    <button class="contract-tab" onclick="switchContractTab('existing')" style="flex: 1; padding: 10px; background: #f8f9fa; color: #333; border: none; border-radius: 0 5px 0 0; cursor: pointer;">View Existing</button>
                </div>
                
                <div id="createContractTab" class="contract-tab-content">
                    <h4 style="color: #000000;">Create New Contract</h4>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractTitleInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitleInput" placeholder="Photography Services Agreement" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #000000;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="contractContentInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContentInput" rows="15" placeholder="Enter your contract terms and conditions here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <button onclick="createContract()" style="background: #d4af37; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Create Contract</button>
                </div>
                
                <div id="existingContractTab" class="contract-tab-content" style="display: none;">
                    <h4 style="color: #000000;">Existing Contracts</h4>
                    <div id="existingContractsList" class="existing-contracts-list" style="color: #000000;">
                        <!-- Contracts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Edit Modal -->
    <div id="contractEditModal" class="contract-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; align-items: center; justify-content: center;">
        <div class="contract-modal-overlay" onclick="closeContractEditModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);"></div>
        <div class="contract-modal-content" style="position: relative; background: white; border-radius: 15px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); z-index: 10001; color: #000000;">
            <div class="contract-modal-header" style="color: #000000; padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #000000; margin: 0;">âœï¸ Edit Contract</h3>
                <button class="contract-close-btn" onclick="closeContractEditModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            <div class="contract-modal-body" style="color: #000000; padding: 20px;">
                <form id="contractEditForm" onsubmit="saveContractChanges(event)">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractTitle" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Title:</label>
                        <input type="text" id="contractTitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color: #000000;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="contractContent" style="display: block; margin-bottom: 5px; font-weight: 600; color: #000000;">Contract Content:</label>
                        <textarea id="contractContent" rows="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: monospace; color: #000000; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeContractEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Website Builder Components -->
    <script type="text/babel" src="components/PresetTemplates.jsx"></script>
    <script src="components/firebase-publish.js"></script>
    <script type="text/babel" src="components/BlockEditor.jsx"></script>
    <script type="text/babel" src="components/BlockLibrary.jsx"></script>
    <script type="text/babel" src="components/LivePreview.jsx"></script>
    <script type="text/babel" src="components/PageManager.jsx"></script>
    <script type="text/babel" src="components/TemplateSelector.jsx"></script>
    <script type="text/babel" src="components/SiteBuilder.jsx"></script>
    
    <!-- Initialize React Site Builder -->
    <script type="text/babel">
        // Initialize the React Site Builder component
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for components...');
            
            // Wait for all components to load
            const initSiteBuilder = () => {
                console.log('Detailed component checking:', {
                    React: typeof React !== 'undefined',
                    ReactDOM: typeof ReactDOM !== 'undefined',
                    SiteBuilder: typeof SiteBuilder !== 'undefined',
                    PresetTemplates: {
                        exists: typeof window.PresetTemplates !== 'undefined',
                        keys: window.PresetTemplates ? Object.keys(window.PresetTemplates) : null,
                        count: window.PresetTemplates ? Object.keys(window.PresetTemplates).length : 0,
                        sample: window.PresetTemplates ? window.PresetTemplates.legacyPhotography?.name : null
                    },
                    TemplateCategories: {
                        exists: typeof window.TemplateCategories !== 'undefined',
                        count: window.TemplateCategories ? window.TemplateCategories.length : 0
                    },
                    BlockEditor: typeof window.BlockEditor !== 'undefined',
                    BlockLibrary: typeof window.BlockLibrary !== 'undefined',
                    LivePreview: typeof window.LivePreview !== 'undefined',
                    PageManager: typeof window.PageManager !== 'undefined',
                    TemplateSelector: typeof window.TemplateSelector !== 'undefined'
                });
                
                if (typeof React !== 'undefined' && 
                    typeof ReactDOM !== 'undefined' && 
                    typeof SiteBuilder !== 'undefined' && 
                    window.PresetTemplates && Object.keys(window.PresetTemplates).length > 0 &&
                    typeof window.BlockEditor !== 'undefined' &&
                    typeof window.BlockLibrary !== 'undefined' &&
                    typeof window.LivePreview !== 'undefined' &&
                    typeof window.PageManager !== 'undefined' &&
                    typeof window.TemplateSelector !== 'undefined') {
                    
                    console.log('All components loaded, initializing React SiteBuilder...');
                    const container = document.querySelector('.website-builder-container');
                    console.log('Container found:', container);
                    
                    if (container) {
                        try {
                            // Clear container first
                            container.innerHTML = '';
                            
                            // Create root and render
                            const root = ReactDOM.createRoot ? ReactDOM.createRoot(container) : null;
                            if (root) {
                                root.render(React.createElement(SiteBuilder));
                                console.log('SiteBuilder mounted successfully with createRoot');
                            } else {
                                ReactDOM.render(React.createElement(SiteBuilder), container);
                                console.log('SiteBuilder mounted successfully with legacy render');
                            }
                        } catch (error) {
                            console.error('Error mounting SiteBuilder:', error);
                            console.log('React version:', React.version);
                            console.log('Available React methods:', Object.keys(React));
                            console.log('Available ReactDOM methods:', Object.keys(ReactDOM));
                        }
                    } else {
                        console.error('Website builder container not found');
                    }
                } else {
                    console.log('Still waiting for components...');
                    setTimeout(initSiteBuilder, 200);
                }
            };
            
            // Start initialization
            setTimeout(initSiteBuilder, 1000);
        });
    </script>



<div style="position: fixed; top: 0px; width: 100%; background: rgb(255, 255, 204); padding: 5px; text-align: center; z-index: 10000; font-weight: bold; color: rgb(51, 51, 51);">âš ï¸ DEV MODE ENABLED - NO AUTH CHECK</div></body>